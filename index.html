<!DOCTYPE html>
<html lang="en" xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta charset="utf-8" />
    <meta
      content="width=device-width, initial-scale=1.0, viewport-fit=cover"
      name="viewport"
    />
    <meta name="description" content="Hacker News" />
    <meta name="theme-color" content="#fff" />
    <title>Hacker News</title>
    <link rel="manifest" href="manifest.json" />
    <link
      href="data:image/x-icon;base64,AAABAAEAAQECAAEAAQA4AAAAFgAAACgAAAABAAAAAgAAAAEAAQAAAAAAAAAAAAAAAAAAAAAAAAAAAAABAAEAAQECAAEAAQA4AAAAFgAAACgAAAABAAAAAgAAAAEAAQAAAAAAAAAAAAAAAAAAAAAAAAAA"
      rel="icon"
      type="image/x-icon"
    />
    <link
      href="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAgAAAAIAAQMAAADOtka5AAAAA1BMVEUAAACnej3aAAAANklEQVR42u3BAQEAAACCIP+vbkhAAQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAB8G4IAAAFjdVCkAAAAAElFTkSuQmCC"
      rel="apple-touch-icon"
    />
    <style>
      /*<!--*/
      body {
        color: rgb(25, 25, 25);
        font-family: Verdana, Geneva, sans-serif;
        margin: 0;
      }

      a {
        text-decoration: none;
      }

      a:link,
      a:focus,
      a:hover,
      a:active {
        color: rgb(75, 75, 125);
      }

      a:visited {
        color: rgb(25, 25, 25);
      }

      h1 > a,
      h1 > a:link,
      h1 > a:focus,
      h1 > a:hover,
      h1 > a:active,
      h1 > a:visited,
      h2 > a,
      h2 > a:link,
      h2 > a:focus,
      h2 > a:hover,
      h2 > a:active,
      h2 > a:visited {
        color: rgb(25, 25, 25);
      }

      h1 {
        background-color: rgb(255, 102, 0);
        margin: 0;
        padding: 1rem;
      }

      h2 {
        background-color: rgb(200, 200, 200);
        margin: 1rem 0;
        padding: 0.5rem 0.5rem 0.5rem 1rem;
      }

      #latest > section,
      #archives > section {
        margin: 0 1rem 1rem 1rem;
        padding-bottom: 1rem;
      }

      #latest > section:not(:last-child),
      #archives > section:not(:last-child) {
        border-bottom: 1px dotted rgb(200, 200, 200);
      }

      section > h3 {
        margin: 0 0 0.5rem 0;
      }

      section > h4 {
        font-weight: normal;
        margin: 0 0 0 1rem;
      }

      .descendants-container,
      .points-container {
        align-items: center;
        border-left: 1px solid #333;
        display: inline-flex;
        margin-left: 0.5rem;
        padding-left: 0.5rem;
        text-align: center;
      }

      .points {
        align-items: center;
        display: inline-flex;
        height: 1rem;
        margin-left: 1ch;
        min-width: 3ch;
      }

      .text {
        line-height: 1.5rem;
        margin: 1rem 1rem 0 1rem;
        overflow: auto;
      }

      .text > p:first-child {
        margin-top: 1rem;
      }

      .text > p:last-child {
        margin-bottom: 0;
      }
      /*-->*/
    </style>
  </head>

  <body>
    <main>
      <h1><a href="https://kherrick.github.io/hacker-news/">Hacker News</a></h1>
      <section id="latest">
        <h2>Latest</h2>
        <section id="42729427">
          <h3>
            <a
              class="item"
              href="https://www.fema.gov/disaster/recover/volunteer-donate"
              >FEMA: Never donate clothing (it is never needed)</a
            >
          </h3>
          <section>
            <h4>
              <span>2025-01-16 @ 19:02:41</span
              ><span class="points-container"
                >Points: <span class="points">24</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=42729427"
                  >Comments</a
                ><span class="descendants">: 9</span></span
              >
            </h4>
          </section>
        </section>
        <section id="42728967">
          <h3>
            <a
              class="item"
              href="https://www.theguardian.com/film/2025/jan/16/david-lynch-twin-peaks-and-muholland-drive-director-dies-aged-78"
              >David Lynch, Twin Peaks and Muholland Drive director, dies aged
              78</a
            >
          </h3>
          <section>
            <h4>
              <span>2025-01-16 @ 18:28:26</span
              ><span class="points-container"
                >Points: <span class="points">135</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=42728967"
                  >Comments</a
                ><span class="descendants">: 6</span></span
              >
            </h4>
          </section>
        </section>
        <section id="42728916">
          <h3>
            <a class="item" href="https://ohshitgit.com/">Oh Shit, Git?</a>
          </h3>
          <section>
            <h4>
              <span>2025-01-16 @ 18:24:09</span
              ><span class="points-container"
                >Points: <span class="points">52</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=42728916"
                  >Comments</a
                ><span class="descendants">: 21</span></span
              >
            </h4>
          </section>
        </section>
        <section id="42728862">
          <h3>
            <a
              class="item"
              href="https://www.facebook.com/davidlynchofficial/posts/it-is-with-deep-regret-that-we-his-family-announce-the-passing-of-the-man-and-th/1179118190251944/"
              >David Lynch has passed away</a
            >
          </h3>
          <section>
            <h4>
              <span>2025-01-16 @ 18:20:49</span
              ><span class="points-container"
                >Points: <span class="points">246</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=42728862"
                  >Comments</a
                ><span class="descendants">: 63</span></span
              >
            </h4>
          </section>
        </section>
        <section id="42728717">
          <h3>
            <a
              class="item"
              href="https://www.semafor.com/article/01/15/2025/replit-ceo-on-ai-breakthroughs-we-dont-care-about-professional-coders-anymore"
              >Replit CEO on AI breakthroughs: We don't care about professional
              coders anymore</a
            >
          </h3>
          <section>
            <h4>
              <span>2025-01-16 @ 18:09:36</span
              ><span class="points-container"
                >Points: <span class="points">41</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=42728717"
                  >Comments</a
                ><span class="descendants">: 50</span></span
              >
            </h4>
          </section>
        </section>
        <section id="42728165">
          <h3>
            <a
              class="item"
              href="https://pubpeer.com/publications/323E84675EB2E849C56097D73D55FD#1"
              >Same three bands appear in three different presentations with
              different labels</a
            >
          </h3>
          <section>
            <h4>
              <span>2025-01-16 @ 17:24:39</span
              ><span class="points-container"
                >Points: <span class="points">108</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=42728165"
                  >Comments</a
                ><span class="descendants">: 58</span></span
              >
            </h4>
          </section>
        </section>
        <section id="42728054">
          <h3>
            <a class="item" href="https://dynomight.substack.com/p/mentoring"
              >I am offering mentoring: In which I help you</a
            >
          </h3>
          <section>
            <h4>
              <span>2025-01-16 @ 17:15:43</span
              ><span class="points-container"
                >Points: <span class="points">22</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=42728054"
                  >Comments</a
                ><span class="descendants">: 29</span></span
              >
            </h4>
          </section>
        </section>
        <section id="42728015">
          <h3>
            <a
              class="item"
              href="https://github.blog/changelog/2025-01-16-linux-arm64-hosted-runners-now-available-for-free-in-public-repositories-public-preview/"
              >GitHub Linux ARM64 hosted runners now available for free in
              public repositories</a
            >
          </h3>
          <section>
            <h4>
              <span>2025-01-16 @ 17:13:07</span
              ><span class="points-container"
                >Points: <span class="points">60</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=42728015"
                  >Comments</a
                ><span class="descendants">: 8</span></span
              >
            </h4>
          </section>
        </section>
        <section id="42727970">
          <h3>
            <a class="item" href="https://github.com/dbos-inc/dbos-transact-ts"
              >Show HN: DBOS TypeScript – Lightweight Durable Execution Built on
              Postgres</a
            >
          </h3>
          <section>
            <h4>
              <span>2025-01-16 @ 17:10:35</span
              ><span class="points-container"
                >Points: <span class="points">25</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=42727970"
                  >Comments</a
                ><span class="descendants">: 18</span></span
              >
            </h4>
            <div class="text">
              <p>
                Today we want to share our TypeScript library for lightweight
                durable execution. We’ve been working on it since last year and
                recently released v2.0 with a ton of new features and major API
                overhaul.
              </p>
              <p>
                <a href="https://github.com/dbos-inc/dbos-transact-ts"
                  >https://github.com/dbos-inc/dbos-transact-ts</a
                >
              </p>
              <p>
                Durable execution means persisting the execution state of your
                program while it runs, so if it is ever interrupted or crashes,
                it automatically resumes from where it left off.
              </p>
              <p>Durable execution is useful for a lot of things:</p>
              <p>
                - Orchestrating long-running or business-critical workflows so
                they seamlessly recover from any failure.
              </p>
              <p>- Running reliable background jobs with no timeouts.</p>
              <p>- Processing incoming events (e.g. from Kafka) exactly once</p>
              <p>- Running a fault-tolerant distributed task queue</p>
              <p>- Running a reliable cron scheduler</p>
              <p>
                - Operating an AI agent, or anything that connects to an
                unreliable or non-deterministic API.
              </p>
              <p>
                What’s unique about DBOS’s take on durable execution (compared
                to, say, Temporal) is that it’s implemented in a lightweight
                library that’s totally backed by Postgres. All you have to do to
                use DBOS is “npm install” it and annotate your program with
                decorators. The decorators store your program’s execution state
                in Postgres as it runs and recover it if it crashes. There are
                no other dependencies you have to manage, no separate workflow
                server–just your program and Postgres.
              </p>
              <p>
                One big advantage of this approach is that you can add DBOS to
                ANY TypeScript application–it’s just a library. For example, you
                can use DBOS to add reliable background jobs or cron scheduling
                or queues to your Next.js app with no external dependencies
                except Postgres.
              </p>
              <p>
                Also, because it’s all in Postgres, you get all the tooling
                you’re familiar with: backups, GUIs, CLI tools–it all just
                works.
              </p>
              <p>Want to try DBOS out? Initialize a starter app with:</p>
              <p></p>
              <pre><code>    npx @dbos-inc/create -t dbos-node-starter
</code></pre>
              Then build and start your app with:
              <p></p>
              <pre><code>    npm install
    npm run build
    npm run start
</code></pre>
              Also check out the docs:
              <a href="https://docs.dbos.dev/">https://docs.dbos.dev/</a>
              <p>
                We'd love to hear what you think! We’ll be in the comments for
                the rest of the day to answer any questions you may have.
              </p>
            </div>
          </section>
        </section>
        <section id="42727820">
          <h3>
            <a
              class="item"
              href="https://www.ycombinator.com/companies/artie/jobs/Vz704T1-founding-engineer-distributed-systems"
              >Artie (YC S23) Is Hiring a Founding Engineer (Distributed
              Systems)</a
            >
          </h3>
          <section>
            <h4>
              <span>2025-01-16 @ 17:00:09</span
              ><span class="points-container"
                >Points: <span class="points">1</span></span
              >
            </h4>
          </section>
        </section>
        <section id="42727629">
          <h3>
            <a
              class="item"
              href="https://www.etany.org/penn-station-can-handle-the-load"
              >Penn Station Can Handle the Load: New York Is Ready for
              Through-Running</a
            >
          </h3>
          <section>
            <h4>
              <span>2025-01-16 @ 16:43:07</span
              ><span class="points-container"
                >Points: <span class="points">14</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=42727629"
                  >Comments</a
                ><span class="descendants">: 2</span></span
              >
            </h4>
          </section>
        </section>
        <section id="42726678">
          <h3>
            <a
              class="item"
              href="https://letsencrypt.org/2025/01/16/6-day-and-ip-certs/"
              >Let's Encrypt is offering 6-day and IP address certs</a
            >
          </h3>
          <section>
            <h4>
              <span>2025-01-16 @ 15:36:43</span
              ><span class="points-container"
                >Points: <span class="points">50</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=42726678"
                  >Comments</a
                ><span class="descendants">: 13</span></span
              >
            </h4>
          </section>
        </section>
        <section id="42726584">
          <h3>
            <a class="item" href="https://blog.yfzhou.fyi/posts/tdd-llm/"
              >Test-Driven Development with an LLM for Fun and Profit</a
            >
          </h3>
          <section>
            <h4>
              <span>2025-01-16 @ 15:30:19</span
              ><span class="points-container"
                >Points: <span class="points">56</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=42726584"
                  >Comments</a
                ><span class="descendants">: 12</span></span
              >
            </h4>
          </section>
        </section>
        <section id="42726539">
          <h3>
            <a
              class="item"
              href="https://nautil.us/the-incredible-conundrum-of-lifes-origin-1178890/"
              >The Conundrum of Life's Origin</a
            >
          </h3>
          <section>
            <h4>
              <span>2025-01-16 @ 15:27:13</span
              ><span class="points-container"
                >Points: <span class="points">32</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=42726539"
                  >Comments</a
                ><span class="descendants">: 13</span></span
              >
            </h4>
          </section>
        </section>
        <section id="42725862">
          <h3>
            <a
              class="item"
              href="https://www.nextplatform.com/2025/01/15/red-hat-woos-vmware-shops-with-openshift-virtualization-engine/"
              >Red Hat Woos VMware Shops with OpenShift Virtualization Engine</a
            >
          </h3>
          <section>
            <h4>
              <span>2025-01-16 @ 14:45:25</span
              ><span class="points-container"
                >Points: <span class="points">79</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=42725862"
                  >Comments</a
                ><span class="descendants">: 39</span></span
              >
            </h4>
          </section>
        </section>
        <section id="42725823">
          <h3>
            <a
              class="item"
              href="https://spectrum.ieee.org/ammonia-fuel-2670794408"
              >Device uses wind to create ammonia out of air</a
            >
          </h3>
          <section>
            <h4>
              <span>2025-01-16 @ 14:43:20</span
              ><span class="points-container"
                >Points: <span class="points">70</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=42725823"
                  >Comments</a
                ><span class="descendants">: 61</span></span
              >
            </h4>
          </section>
        </section>
        <section id="42725385">
          <h3>
            <a class="item" href="https://keygen.sh/blog/no-calls/">No Calls</a>
          </h3>
          <section>
            <h4>
              <span>2025-01-16 @ 14:17:31</span
              ><span class="points-container"
                >Points: <span class="points">627</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=42725385"
                  >Comments</a
                ><span class="descendants">: 166</span></span
              >
            </h4>
          </section>
        </section>
        <section id="42725147">
          <h3>
            <a class="item" href="https://zadzmo.org/code/nepenthes/"
              >Nepenthes is a tarpit to catch AI web crawlers</a
            >
          </h3>
          <section>
            <h4>
              <span>2025-01-16 @ 13:57:43</span
              ><span class="points-container"
                >Points: <span class="points">289</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=42725147"
                  >Comments</a
                ><span class="descendants">: 109</span></span
              >
            </h4>
          </section>
        </section>
        <section id="42724761">
          <h3>
            <a
              class="item"
              href="https://nokia-apple-iphone-was-launched-presentation.tiiny.site/"
              >Nokia's internal presentation after iPhone was launched (2007)
              [pdf]</a
            >
          </h3>
          <section>
            <h4>
              <span>2025-01-16 @ 13:23:32</span
              ><span class="points-container"
                >Points: <span class="points">365</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=42724761"
                  >Comments</a
                ><span class="descendants">: 382</span></span
              >
            </h4>
          </section>
        </section>
        <section id="42724757">
          <h3>
            <a class="item" href="https://github.com/KingMenes/awesome-launch"
              >Show HN: I made an open source directory of where to showoff your
              projects</a
            >
          </h3>
          <section>
            <h4>
              <span>2025-01-16 @ 13:23:17</span
              ><span class="points-container"
                >Points: <span class="points">115</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=42724757"
                  >Comments</a
                ><span class="descendants">: 20</span></span
              >
            </h4>
            <div class="text">
              <p>
                Ever wondered how to show off that something you just built?
                Look no further! Awesome Launch is meant to be a list of
                communities and forums you can share your projects to get
                feedback or your first users.
              </p>
              <p>
                Anyone is free to contribute sites and resources. Hope you
                enjoy!
              </p>
            </div>
          </section>
        </section>
        <section id="42724621">
          <h3>
            <a class="item" href="https://www.youtube.com/watch?v=itpcsQQvgAQ"
              >Nintendo announces the Switch 2 [video]</a
            >
          </h3>
          <section>
            <h4>
              <span>2025-01-16 @ 13:08:14</span
              ><span class="points-container"
                >Points: <span class="points">508</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=42724621"
                  >Comments</a
                ><span class="descendants">: 675</span></span
              >
            </h4>
          </section>
        </section>
        <section id="42724284">
          <h3>
            <a
              class="item"
              href="https://joeyehand.com/blog/2025/01/15/i-ditched-the-algorithm-for-rssand-you-should-too/"
              >I Ditched the Algorithm for RSS–and You Should Too</a
            >
          </h3>
          <section>
            <h4>
              <span>2025-01-16 @ 12:18:32</span
              ><span class="points-container"
                >Points: <span class="points">225</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=42724284"
                  >Comments</a
                ><span class="descendants">: 99</span></span
              >
            </h4>
          </section>
        </section>
        <section id="42723406">
          <h3>
            <a
              class="item"
              href="https://www.quantamagazine.org/mathematicians-discover-new-way-for-spheres-to-kiss-20250115/"
              >Mathematicians Discover New Way for Spheres to 'Kiss'</a
            >
          </h3>
          <section>
            <h4>
              <span>2025-01-16 @ 09:57:59</span
              ><span class="points-container"
                >Points: <span class="points">120</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=42723406"
                  >Comments</a
                ><span class="descendants">: 49</span></span
              >
            </h4>
          </section>
        </section>
        <section id="42721442">
          <h3>
            <a
              class="item"
              href="https://p4.org/intels-tofino-p4-software-is-now-open-source/"
              >Intel's Tofino P4 Software Is Now Open Source</a
            >
          </h3>
          <section>
            <h4>
              <span>2025-01-16 @ 05:00:08</span
              ><span class="points-container"
                >Points: <span class="points">182</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=42721442"
                  >Comments</a
                ><span class="descendants">: 61</span></span
              >
            </h4>
          </section>
        </section>
        <section id="42717393">
          <h3>
            <a
              class="item"
              href="https://resobscura.substack.com/p/2000-year-old-wine-and-the-uncanny"
              >2k-year-old wine and the uncanny immediacy of the past</a
            >
          </h3>
          <section>
            <h4>
              <span>2025-01-15 @ 21:35:41</span
              ><span class="points-container"
                >Points: <span class="points">81</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=42717393"
                  >Comments</a
                ><span class="descendants">: 19</span></span
              >
            </h4>
          </section>
        </section>
        <section id="42690114">
          <h3>
            <a
              class="item"
              href="https://shopify.engineering/five-years-of-react-native-at-shopify"
              >Five Years of React Native at Shopify</a
            >
          </h3>
          <section>
            <h4>
              <span>2025-01-13 @ 22:08:51</span
              ><span class="points-container"
                >Points: <span class="points">49</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=42690114"
                  >Comments</a
                ><span class="descendants">: 10</span></span
              >
            </h4>
          </section>
        </section>
        <section id="42683731">
          <h3>
            <a class="item" href="https://pbr-book.org"
              >Physically Based Rendering: From Theory to Implementation</a
            >
          </h3>
          <section>
            <h4>
              <span>2025-01-13 @ 14:28:33</span
              ><span class="points-container"
                >Points: <span class="points">50</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=42683731"
                  >Comments</a
                ><span class="descendants">: 11</span></span
              >
            </h4>
          </section>
        </section>
        <section id="42683616">
          <h3>
            <a
              class="item"
              href="https://educatedguesswork.org/posts/memory-management-1/"
              >Understanding Memory Management, Part 1: C</a
            >
          </h3>
          <section>
            <h4>
              <span>2025-01-13 @ 14:16:15</span
              ><span class="points-container"
                >Points: <span class="points">125</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=42683616"
                  >Comments</a
                ><span class="descendants">: 37</span></span
              >
            </h4>
          </section>
        </section>
        <section id="42681793">
          <h3>
            <a
              class="item"
              href="https://github.com/SonyResearch/micro_diffusion"
              >Stretching Each Dollar: Diffusion Training from Scratch on a
              Micro-Budget</a
            >
          </h3>
          <section>
            <h4>
              <span>2025-01-13 @ 09:55:24</span
              ><span class="points-container"
                >Points: <span class="points">6</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=42681793"
                  >Comments</a
                ><span class="descendants">: 0</span></span
              >
            </h4>
          </section>
        </section>
        <section id="42676545">
          <h3>
            <a
              class="item"
              href="https://dafyddvaughan.uk/blog/2025/why-some-dvla-digital-services-dont-work-at-night/"
              >Why some DVLA digital services don't work at night</a
            >
          </h3>
          <section>
            <h4>
              <span>2025-01-12 @ 20:20:07</span
              ><span class="points-container"
                >Points: <span class="points">45</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=42676545"
                  >Comments</a
                ><span class="descendants">: 44</span></span
              >
            </h4>
          </section>
        </section>
      </section>
      <section id="archives">
        <h2>
          <a
            href="https://github.com/kherrick/hacker-news/blob/main/archives/index.md"
            >Archives</a
          >
        </h2>
        <section>
          <h3>
            <a
              href="https://github.com/kherrick/hacker-news/blob/main/archives/2025/index.md"
              >2025</a
            >
          </h3>
        </section>
        <section>
          <h3>
            <a
              href="https://github.com/kherrick/hacker-news/blob/main/archives/2024/index.md"
              >2024</a
            >
          </h3>
        </section>
        <section>
          <h3>
            <a
              href="https://github.com/kherrick/hacker-news/blob/main/archives/2023/index.md"
              >2023</a
            >
          </h3>
        </section>
        <section>
          <h3>
            <a
              href="https://github.com/kherrick/hacker-news/blob/main/archives/2022/index.md"
              >2022</a
            >
          </h3>
        </section>
      </section>
    </main>
    <script type="module">
      import { buildDescendants } from "./lib/build-html-descendants.js";
      import { buildNextItem } from "./lib/build-html-next-item.js";
      import { getNextDateTime } from "./lib/date-time.js";

      const updateSectionById = (id) =>
        fetch(`https://hacker-news.firebaseio.com/v0/item/${id}.json`).then(
          (result) =>
            result.json().then(({ descendants, id, score, text, type }) => {
              const currentItem = document.getElementById(id);

              if (score) {
                currentItem.querySelector(".points").textContent = score;
              }

              if (descendants && (type === "poll" || type === "story")) {
                const currentDescendants =
                  currentItem.querySelector(".descendants");

                if (currentDescendants) {
                  currentDescendants.textContent = `: ${descendants}`;
                } else {
                  const comments = buildDescendants(
                    document,
                    descendants,
                    `https://news.ycombinator.com/item?id=${id}`
                  );

                  currentItem.querySelector("h4").appendChild(comments);
                }
              }

              if (text) {
                const currentText = currentItem.querySelector(".text");

                if (currentText) {
                  currentText.innerHTML = text.replace(/\0/g, "");
                } else {
                  const content = document.createElement("div");
                  content.innerHTML = text.replace(/\0/g, "");
                  content.setAttribute("class", "text");

                  currentItem.appendChild(content);
                }
              }
            })
        );

      class UpdateQueue {
        constructor() {
          this._ids = [];
          this._isUpdating = false;
        }

        addItemById(id) {
          this._ids.push(id);
        }

        async flush() {
          const id = this._ids.shift();

          if (id) {
            this._isUpdating = true;

            await updateSectionById(id);
            await this.flush();
          } else {
            this._isUpdating = false;

            setTimeout(async () => {
              if (!this._isUpdating && this._ids && this._ids.length) {
                await this.flush();
              }
            }, 0);
          }
        }
      }

      // get latest data
      const latestSection = document.getElementById("latest");

      for (let item of latestSection.querySelectorAll("section[id]")) {
        updateSectionById(item.getAttribute("id"));
      }

      if ("IntersectionObserver" in window) {
        window.hackerNewsState = { index: [], nextTimeIndex: -1 };

        const addNewsItem = async (newsItem, queue) => {
          try {
            const { date, time, itemComments, itemTitle, itemLink } = newsItem;
            const section = await buildNextItem({
              document,
              dateTime: `${date}, ${time}`,
              itemComments,
              itemLink,
              itemTitle: new DOMParser().parseFromString(
                itemTitle.replace(/\\/g, ""),
                "text/html"
              ).documentElement.textContent,
              fetchItemDetails: false,
            });

            // display loading indicator for section
            section.querySelector(".points-container").innerHTML =
              'Points: <span class="points"><img style="height: 100%;" src="lib/images/loading.svg" /></span>';

            const id = section.getAttribute("id");
            if (!document.getElementById(id)) {
              document.getElementById("latest").appendChild(section);

              queue.addItemById(id);
            }
          } catch (error) {}
        };

        const buildArchiveIndex = async (lastDateTime) => {
          const nextDate = lastDateTime.slice(0, 10);
          const nextYear = nextDate.slice(0, 4);

          return (
            await (
              await fetch(
                `https://raw.githubusercontent.com/kherrick/hacker-news/main/archives/${nextYear}/${nextDate}/index.md`
              )
            ).text()
          )
            .split("\n")
            .filter((line) => line.match(new RegExp("^\\* \\[")))
            .map((line) => {
              const segment = line.replace("* ", "").split("](");
              const pubDate = segment[0].slice(1);

              const itemComments = segment[1].split(") - [")[0];
              const itemTitle = segment[1].split(") - [")[1];
              const itemLink = segment[2].slice(0, -1);
              const date = pubDate.slice(0, 10);
              const time = pubDate.slice(-8);

              return {
                date,
                itemComments,
                itemLink,
                itemTitle,
                time,
              };
            });
        };

        const handleIntersectingEntry = async (entry, queue) => {
          if (entry.isIntersecting) {
            const lastDateTime = document
              .getElementById("latest")
              .querySelector(
                "section:last-child > section > h4 > span"
              ).textContent;

            const nextDateTime = getNextDateTime(lastDateTime ?? "", -1);
            const archiveIndex = await buildArchiveIndex(nextDateTime);
            const nextTimeIndex = archiveIndex.findIndex(
              ({ time }) => time === nextDateTime.slice(-8)
            );

            const handleIndexUpdate = (index, existingIndexValues = []) => {
              index.forEach((i) => {
                existingIndexValues.push(i);
              });
              return existingIndexValues;
            };

            window.hackerNewsState = {
              index: handleIndexUpdate(
                archiveIndex,
                window.hackerNewsState.index
              ),
              nextTimeIndex,
            };

            let currentTimeIndex = nextTimeIndex + 1;
            const items = Object.values(window.hackerNewsState.index);
            for (let item of items) {
              if (currentTimeIndex < window.hackerNewsState.index.length) {
                addNewsItem(items[currentTimeIndex], queue);

                currentTimeIndex = currentTimeIndex + 1;
              }
            }

            queue.flush();
          }
        };

        const archives = document.getElementById("archives");
        const archivesObserver = new IntersectionObserver(
          (entries) => {
            const queue = new UpdateQueue();

            entries.forEach((entry) => handleIntersectingEntry(entry, queue));
          },
          {
            root: null,
            rootMargin: "0px",
            threshold: 0,
          }
        );

        archivesObserver.observe(archives);

        let latestSectionsExpanded = true;
        const handleLatestHeaderClick = () => {
          latestSectionsExpanded = !latestSectionsExpanded;

          if (latestSectionsExpanded) {
            archivesObserver.observe(archives);
          } else {
            archivesObserver.disconnect(archives);
          }

          for (let section of document.querySelectorAll("#latest > section")) {
            section.style.display = latestSectionsExpanded ? "block" : "none";
          }
        };

        const latestHeader = document.querySelector("#latest > h2");
        latestHeader.style.cursor = "pointer";
        latestHeader.addEventListener("click", handleLatestHeaderClick);
      }
    </script>
    <script type="module">
      import { Workbox } from "https://storage.googleapis.com/workbox-cdn/releases/6.4.1/workbox-window.prod.mjs";

      if ("serviceWorker" in navigator) {
        const base = document.querySelector("base");
        const serviceWorkerPath = `${
          base ? base.href.replace(/\/$/, "") : ""
        }/service-worker.js`;

        const wb = new Workbox(serviceWorkerPath);

        // setup event listeners
        wb.addEventListener("waiting", (event) => {
          wb.addEventListener("controlling", () => {
            window.location.reload();
          });

          wb.messageSkipWaiting();
        });

        wb.register();
      }
    </script>
  </body>
</html>
