<!DOCTYPE html>
<html lang="en" xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta charset="utf-8" />
    <meta
      content="width=device-width, initial-scale=1.0, viewport-fit=cover"
      name="viewport"
    />
    <meta name="description" content="Hacker News" />
    <meta name="theme-color" content="#fff" />
    <title>Hacker News</title>
    <link rel="manifest" href="manifest.json" />
    <link
      href="data:image/x-icon;base64,AAABAAEAAQECAAEAAQA4AAAAFgAAACgAAAABAAAAAgAAAAEAAQAAAAAAAAAAAAAAAAAAAAAAAAAAAAABAAEAAQECAAEAAQA4AAAAFgAAACgAAAABAAAAAgAAAAEAAQAAAAAAAAAAAAAAAAAAAAAAAAAA"
      rel="icon"
      type="image/x-icon"
    />
    <link
      href="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAgAAAAIAAQMAAADOtka5AAAAA1BMVEUAAACnej3aAAAANklEQVR42u3BAQEAAACCIP+vbkhAAQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAB8G4IAAAFjdVCkAAAAAElFTkSuQmCC"
      rel="apple-touch-icon"
    />
    <style>
      /*<!--*/
      body {
        color: rgb(25, 25, 25);
        font-family: Verdana, Geneva, sans-serif;
        margin: 0;
      }

      a {
        text-decoration: none;
      }

      a:link,
      a:focus,
      a:hover,
      a:active {
        color: rgb(75, 75, 125);
      }

      a:visited {
        color: rgb(25, 25, 25);
      }

      h1 > a,
      h1 > a:link,
      h1 > a:focus,
      h1 > a:hover,
      h1 > a:active,
      h1 > a:visited,
      h2 > a,
      h2 > a:link,
      h2 > a:focus,
      h2 > a:hover,
      h2 > a:active,
      h2 > a:visited {
        color: rgb(25, 25, 25);
      }

      h1 {
        background-color: rgb(255, 102, 0);
        margin: 0;
        padding: 1rem;
      }

      h2 {
        background-color: rgb(200, 200, 200);
        margin: 1rem 0;
        padding: 0.5rem 0.5rem 0.5rem 1rem;
      }

      #latest > section,
      #archives > section {
        margin: 0 1rem 1rem 1rem;
        padding-bottom: 1rem;
      }

      #latest > section:not(:last-child),
      #archives > section:not(:last-child) {
        border-bottom: 1px dotted rgb(200, 200, 200);
      }

      section > h3 {
        margin: 0 0 0.5rem 0;
      }

      section > h4 {
        font-weight: normal;
        margin: 0 0 0 1rem;
      }

      .descendants-container,
      .points-container {
        align-items: center;
        border-left: 1px solid #333;
        display: inline-flex;
        margin-left: 0.5rem;
        padding-left: 0.5rem;
        text-align: center;
      }

      .points {
        align-items: center;
        display: inline-flex;
        height: 1rem;
        margin-left: 1ch;
        min-width: 3ch;
      }

      .text {
        line-height: 1.5rem;
        margin: 1rem 1rem 0 1rem;
        overflow: auto;
      }

      .text > p:first-child {
        margin-top: 1rem;
      }

      .text > p:last-child {
        margin-bottom: 0;
      }
      /*-->*/
    </style>
  </head>

  <body>
    <main>
      <h1><a href="https://kherrick.github.io/hacker-news/">Hacker News</a></h1>
      <section id="latest">
        <h2>Latest</h2>
        <section id="46122518">
          <h3>
            <a
              class="item"
              href="https://arstechnica.com/gaming/2025/12/fallout-2-designer-chris-avellone-recalls-his-first-forays-into-game-development/"
              >Fallout 2's Chris Avellone describes his game design
              philosophy</a
            >
          </h3>
          <section>
            <h4>
              <span>2025-12-02 @ 15:56:39</span
              ><span class="points-container"
                >Points: <span class="points">22</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=46122518"
                  >Comments</a
                ><span class="descendants">: 3</span></span
              >
            </h4>
          </section>
        </section>
        <section id="46121951">
          <h3>
            <a class="item" href="https://github.com/runmat-org/runmat"
              >Show HN: RunMat – runtime with auto CPU/GPU routing for dense
              math</a
            >
          </h3>
          <section>
            <h4>
              <span>2025-12-02 @ 15:07:49</span
              ><span class="points-container"
                >Points: <span class="points">9</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=46121951"
                  >Comments</a
                ><span class="descendants">: 2</span></span
              >
            </h4>
            <div class="text">
              <a href="https://news.ycombinator.com/item?id=44972919"
                >https://news.ycombinator.com/item?id=44972919</a
              >
              <p>
                Since then, I’ve taken it further with RunMat Accelerate: the
                runtime now automatically fuses operations and routes work
                between CPU and GPU. You write MATLAB-style code, and RunMat
                runs your computation across CPUs and GPUs for speed. No CUDA,
                no kernel code.
              </p>
              <p>
                Under the hood, it builds a graph of your array math, fuses long
                chains into a few kernels, keeps data on the GPU when that
                helps, and falls back to CPU JIT / BLAS for small cases.
              </p>
              <p>
                On an Apple M2 Max (32 GB), here are some current benchmarks
                (median of several runs):
              </p>
              <p>
                * 5M-path Monte Carlo * RunMat ≈ 0.61 s * PyTorch ≈ 1.70 s *
                NumPy ≈ 79.9 s → ~2.8× faster than PyTorch and ~130× faster than
                NumPy on this test.
              </p>
              <p>
                * 64 × 4K image preprocessing pipeline (mean/std, normalize,
                gain/bias, gamma, MSE) * RunMat ≈ 0.68 s * PyTorch ≈ 1.20 s *
                NumPy ≈ 7.0 s → ~1.8× faster than PyTorch and ~10× faster than
                NumPy.
              </p>
              <p>
                * 1B-point elementwise chain (sin / exp / cos / tanh mix) *
                RunMat ≈ 0.14 s * PyTorch ≈ 20.8 s * NumPy ≈ 11.9 s → ~140×
                faster than PyTorch and ~80× faster than NumPy.
              </p>
              <p>
                If you want more detail on how the fusion and CPU/GPU routing
                work, I wrote up a longer post here:
                <a href="https://runmat.org/blog/runmat-accel-intro-blog"
                  >https://runmat.org/blog/runmat-accel-intro-blog</a
                >
              </p>
              <p>
                You can run the same benchmarks yourself from the GitHub repo in
                the main HN link. Feedback, bug reports, and “here’s where it
                breaks or is slow” examples are very welcome.
              </p>
            </div>
          </section>
        </section>
        <section id="46121889">
          <h3>
            <a class="item" href="https://mistral.ai/news/mistral-3"
              >Mistral 3 family of models released</a
            >
          </h3>
          <section>
            <h4>
              <span>2025-12-02 @ 15:01:53</span
              ><span class="points-container"
                >Points: <span class="points">273</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=46121889"
                  >Comments</a
                ><span class="descendants">: 81</span></span
              >
            </h4>
          </section>
        </section>
        <section id="46121870">
          <h3>
            <a
              class="item"
              href="https://www.theverge.com/news/836212/openai-code-red-chatgpt"
              >OpenAI declares 'code red' as Google catches up in AI race</a
            >
          </h3>
          <section>
            <h4>
              <span>2025-12-02 @ 15:00:16</span
              ><span class="points-container"
                >Points: <span class="points">47</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=46121870"
                  >Comments</a
                ><span class="descendants">: 54</span></span
              >
            </h4>
          </section>
        </section>
        <section id="46121860">
          <h3>
            <a class="item" href="https://github.com/marmotdata/marmot"
              >Show HN: Marmot – Single-binary data catalog (no Kafka, no
              Elasticsearch)</a
            >
          </h3>
          <section>
            <h4>
              <span>2025-12-02 @ 14:59:40</span
              ><span class="points-container"
                >Points: <span class="points">43</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=46121860"
                  >Comments</a
                ><span class="descendants">: 7</span></span
              >
            </h4>
          </section>
        </section>
        <section id="46121799">
          <h3>
            <a class="item" href="https://github.com/arnarg/nixtml"
              >Nixtml: Static website and blog generator written in Nix</a
            >
          </h3>
          <section>
            <h4>
              <span>2025-12-02 @ 14:54:49</span
              ><span class="points-container"
                >Points: <span class="points">40</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=46121799"
                  >Comments</a
                ><span class="descendants">: 6</span></span
              >
            </h4>
          </section>
        </section>
        <section id="46121539">
          <h3>
            <a
              class="item"
              href="https://lwn.net/SubscriberLink/1046084/4c048ee008e1c70e/"
              >Zig's new plan for asynchronous programs</a
            >
          </h3>
          <section>
            <h4>
              <span>2025-12-02 @ 14:31:16</span
              ><span class="points-container"
                >Points: <span class="points">69</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=46121539"
                  >Comments</a
                ><span class="descendants">: 55</span></span
              >
            </h4>
          </section>
        </section>
        <section id="46121243">
          <h3>
            <a
              class="item"
              href="https://pallais.scholars.harvard.edu/publications/power-proximity-coworkers-training-tomorrow-or-productivity-today"
              >Proximity to coworkers increases long-run development, lowers
              short-term output</a
            >
          </h3>
          <section>
            <h4>
              <span>2025-12-02 @ 14:01:05</span
              ><span class="points-container"
                >Points: <span class="points">108</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=46121243"
                  >Comments</a
                ><span class="descendants">: 76</span></span
              >
            </h4>
          </section>
        </section>
        <section id="46120611">
          <h3>
            <a
              class="item"
              href="https://jakevdp.github.io/PythonDataScienceHandbook/"
              >Python Data Science Handbook</a
            >
          </h3>
          <section>
            <h4>
              <span>2025-12-02 @ 12:38:28</span
              ><span class="points-container"
                >Points: <span class="points">85</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=46120611"
                  >Comments</a
                ><span class="descendants">: 18</span></span
              >
            </h4>
          </section>
        </section>
        <section id="46120603">
          <h3>
            <a
              class="item"
              href="https://elixir-lang.org/blog/2025/12/02/lazier-bdds-for-set-theoretic-types/"
              >Lazier Binary Decision Diagrams for set-theoretic types</a
            >
          </h3>
          <section>
            <h4>
              <span>2025-12-02 @ 12:37:47</span
              ><span class="points-container"
                >Points: <span class="points">21</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=46120603"
                  >Comments</a
                ><span class="descendants">: 2</span></span
              >
            </h4>
          </section>
        </section>
        <section id="46120549">
          <h3>
            <a
              class="item"
              href="https://www.jasonscheirer.com/weblog/vignettes/"
              >A series of vignettes from my childhood and early career</a
            >
          </h3>
          <section>
            <h4>
              <span>2025-12-02 @ 12:28:34</span
              ><span class="points-container"
                >Points: <span class="points">88</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=46120549"
                  >Comments</a
                ><span class="descendants">: 52</span></span
              >
            </h4>
          </section>
        </section>
        <section id="46120181">
          <h3>
            <a class="item" href="https://xania.org/202512/02-adding-integers"
              >Addressing the adding situation</a
            >
          </h3>
          <section>
            <h4>
              <span>2025-12-02 @ 11:30:29</span
              ><span class="points-container"
                >Points: <span class="points">198</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=46120181"
                  >Comments</a
                ><span class="descendants">: 60</span></span
              >
            </h4>
          </section>
        </section>
        <section id="46119699">
          <h3>
            <a
              class="item"
              href="https://www.newscientist.com/article/2506595-man-unexpectedly-cured-of-hiv-after-stem-cell-transplant/"
              >Man unexpectedly cured of HIV after stem cell transplant</a
            >
          </h3>
          <section>
            <h4>
              <span>2025-12-02 @ 10:20:34</span
              ><span class="points-container"
                >Points: <span class="points">130</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=46119699"
                  >Comments</a
                ><span class="descendants">: 25</span></span
              >
            </h4>
          </section>
        </section>
        <section id="46119500">
          <h3>
            <a
              class="item"
              href="https://xania.org/202511/advent-of-compiler-optimisation"
              >Advent of Compiler Optimisations 2025</a
            >
          </h3>
          <section>
            <h4>
              <span>2025-12-02 @ 09:51:42</span
              ><span class="points-container"
                >Points: <span class="points">246</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=46119500"
                  >Comments</a
                ><span class="descendants">: 33</span></span
              >
            </h4>
          </section>
        </section>
        <section id="46119214">
          <h3>
            <a
              class="item"
              href="https://chrisebert.net/comparing-aws-lambda-arm64-vs-x86_64-performance-across-multiple-runtimes-in-late-2025/"
              >Comparing AWS Lambda ARM64 vs. x86_64 Performance Across Runtimes
              in Late 2025</a
            >
          </h3>
          <section>
            <h4>
              <span>2025-12-02 @ 09:11:41</span
              ><span class="points-container"
                >Points: <span class="points">93</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=46119214"
                  >Comments</a
                ><span class="descendants">: 42</span></span
              >
            </h4>
          </section>
        </section>
        <section id="46118722">
          <h3>
            <a
              class="item"
              href="https://reverbmachine.com/blog/deconstructing-brian-eno-music-for-airports/"
              >How Brian Eno Created Ambient 1: Music for Airports (2019)</a
            >
          </h3>
          <section>
            <h4>
              <span>2025-12-02 @ 07:46:47</span
              ><span class="points-container"
                >Points: <span class="points">138</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=46118722"
                  >Comments</a
                ><span class="descendants">: 74</span></span
              >
            </h4>
          </section>
        </section>
        <section id="46118432">
          <h3>
            <a class="item" href="https://bou.ke/blog/rust-ping/"
              >Rootless Pings in Rust</a
            >
          </h3>
          <section>
            <h4>
              <span>2025-12-02 @ 07:01:03</span
              ><span class="points-container"
                >Points: <span class="points">95</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=46118432"
                  >Comments</a
                ><span class="descendants">: 68</span></span
              >
            </h4>
          </section>
        </section>
        <section id="46117802">
          <h3>
            <a class="item" href="https://starflow-v.github.io"
              >Apple Releases Open Weights Video Model</a
            >
          </h3>
          <section>
            <h4>
              <span>2025-12-02 @ 05:10:01</span
              ><span class="points-container"
                >Points: <span class="points">343</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=46117802"
                  >Comments</a
                ><span class="descendants">: 110</span></span
              >
            </h4>
          </section>
        </section>
        <section id="46117112">
          <h3>
            <a
              class="item"
              href="https://publicdomainreview.org/features/entering-the-public-domain/2026/"
              >What will enter the public domain in 2026?</a
            >
          </h3>
          <section>
            <h4>
              <span>2025-12-02 @ 03:23:10</span
              ><span class="points-container"
                >Points: <span class="points">395</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=46117112"
                  >Comments</a
                ><span class="descendants">: 252</span></span
              >
            </h4>
          </section>
        </section>
        <section id="46116724">
          <h3>
            <a
              class="item"
              href="https://www.quantamagazine.org/reverse-mathematics-illuminates-why-hard-problems-are-hard-20251201/"
              >Reverse math shows why hard problems are hard</a
            >
          </h3>
          <section>
            <h4>
              <span>2025-12-02 @ 02:35:47</span
              ><span class="points-container"
                >Points: <span class="points">147</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=46116724"
                  >Comments</a
                ><span class="descendants">: 30</span></span
              >
            </h4>
          </section>
        </section>
        <section id="46116567">
          <h3>
            <a
              class="item"
              href="https://support.microsoft.com/en-us/topic/august-29-2025-kb5064081-os-build-26100-5074-preview-3f9eb9e1-72ca-4b42-af97-39aace788d93"
              >After Windows Update, Password icon invisible, click where it
              used to be</a
            >
          </h3>
          <section>
            <h4>
              <span>2025-12-02 @ 02:12:14</span
              ><span class="points-container"
                >Points: <span class="points">145</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=46116567"
                  >Comments</a
                ><span class="descendants">: 150</span></span
              >
            </h4>
          </section>
        </section>
        <section id="46108780">
          <h3>
            <a
              class="item"
              href="https://huggingface.co/deepseek-ai/DeepSeek-V3.2/resolve/main/assets/paper.pdf"
              >DeepSeek-v3.2: Pushing the frontier of open large language models
              [pdf]</a
            >
          </h3>
          <section>
            <h4>
              <span>2025-12-01 @ 15:48:03</span
              ><span class="points-container"
                >Points: <span class="points">907</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=46108780"
                  >Comments</a
                ><span class="descendants">: 432</span></span
              >
            </h4>
            <div class="text">
              <a href="https://huggingface.co/deepseek-ai/DeepSeek-V3.2"
                >https://huggingface.co/deepseek-ai/DeepSeek-V3.2</a
              >
              <p>
                <a href="https://api-docs.deepseek.com/news/news251201"
                  >https://api-docs.deepseek.com/news/news251201</a
                >
              </p>
            </div>
          </section>
        </section>
        <section id="46104193">
          <h3>
            <a
              class="item"
              href="https://www.reuters.com/sustainability/boards-policy-regulation/india-orders-mobile-phones-preloaded-with-government-app-ensure-cyber-safety-2025-12-01/"
              >India orders smartphone makers to preload state-owned cyber
              safety app</a
            >
          </h3>
          <section>
            <h4>
              <span>2025-12-01 @ 06:30:14</span
              ><span class="points-container"
                >Points: <span class="points">830</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=46104193"
                  >Comments</a
                ><span class="descendants">: 611</span></span
              >
            </h4>
          </section>
        </section>
        <section id="46095662">
          <h3>
            <a class="item" href="https://beej.us/guide/bglcs/"
              >Beej's Guide to Learning Computer Science</a
            >
          </h3>
          <section>
            <h4>
              <span>2025-11-30 @ 11:03:13</span
              ><span class="points-container"
                >Points: <span class="points">269</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=46095662"
                  >Comments</a
                ><span class="descendants">: 97</span></span
              >
            </h4>
          </section>
        </section>
        <section id="46093613">
          <h3>
            <a
              class="item"
              href="https://freebasic.net/forum/viewtopic.php?t=27927"
              >YouTube increases FreeBASIC performance (2019)</a
            >
          </h3>
          <section>
            <h4>
              <span>2025-11-30 @ 04:09:41</span
              ><span class="points-container"
                >Points: <span class="points">121</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=46093613"
                  >Comments</a
                ><span class="descendants">: 23</span></span
              >
            </h4>
          </section>
        </section>
        <section id="46091211">
          <h3>
            <a
              class="item"
              href="https://www.bbc.com/news/articles/c74xe49q7vlo"
              >Tom Stoppard has died</a
            >
          </h3>
          <section>
            <h4>
              <span>2025-11-29 @ 22:03:33</span
              ><span class="points-container"
                >Points: <span class="points">149</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=46091211"
                  >Comments</a
                ><span class="descendants">: 46</span></span
              >
            </h4>
            <div class="text">
              <a
                href="https://www.theguardian.com/stage/2025/nov/29/tom-stoppard-playwright-of-dazzling-wit-and-playful-erudition-dies-aged-88"
                >https://www.theguardian.com/stage/2025/nov/29/tom-stoppard-p...</a
              >
              <p>
                <a
                  href="https://www.nytimes.com/2025/11/29/theater/tom-stoppard-dead.html"
                  >https://www.nytimes.com/2025/11/29/theater/tom-stoppard-dead...</a
                >
                (<a href="https://archive.ph/XDP9p">https://archive.ph/XDP9p</a
                >)
              </p>
            </div>
          </section>
        </section>
        <section id="46066764">
          <h3>
            <a class="item" href="https://susam.net/url-in-c.html"
              >URL in C (2011)</a
            >
          </h3>
          <section>
            <h4>
              <span>2025-11-27 @ 07:42:39</span
              ><span class="points-container"
                >Points: <span class="points">77</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=46066764"
                  >Comments</a
                ><span class="descendants">: 20</span></span
              >
            </h4>
          </section>
        </section>
        <section id="46066640">
          <h3>
            <a
              class="item"
              href="https://github.com/AxisNimble/TheFlightWall_OSS"
              >An LED panel that shows the aviation around you</a
            >
          </h3>
          <section>
            <h4>
              <span>2025-11-27 @ 07:22:31</span
              ><span class="points-container"
                >Points: <span class="points">58</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=46066640"
                  >Comments</a
                ><span class="descendants">: 11</span></span
              >
            </h4>
          </section>
        </section>
        <section id="46052478">
          <h3>
            <a
              class="item"
              href="https://terryds.notion.site/Learning-Music-with-Strudel-2ac98431b24180deb890cc7de667ea92"
              >Learning Music with Strudel</a
            >
          </h3>
          <section>
            <h4>
              <span>2025-11-26 @ 00:09:19</span
              ><span class="points-container"
                >Points: <span class="points">150</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=46052478"
                  >Comments</a
                ><span class="descendants">: 31</span></span
              >
            </h4>
          </section>
        </section>
        <section id="46047170">
          <h3>
            <a
              class="item"
              href="https://infinitedigits.co/docs/software/yesnotice/"
              >YesNotice</a
            >
          </h3>
          <section>
            <h4>
              <span>2025-11-25 @ 16:08:33</span
              ><span class="points-container"
                >Points: <span class="points">47</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=46047170"
                  >Comments</a
                ><span class="descendants">: 24</span></span
              >
            </h4>
          </section>
        </section>
      </section>
      <section id="archives">
        <h2>
          <a
            href="https://github.com/kherrick/hacker-news/blob/main/archives/index.md"
            >Archives</a
          >
        </h2>
        <section>
          <h3>
            <a
              href="https://github.com/kherrick/hacker-news/blob/main/archives/2025/index.md"
              >2025</a
            >
          </h3>
        </section>
        <section>
          <h3>
            <a
              href="https://github.com/kherrick/hacker-news/blob/main/archives/2024/index.md"
              >2024</a
            >
          </h3>
        </section>
        <section>
          <h3>
            <a
              href="https://github.com/kherrick/hacker-news/blob/main/archives/2023/index.md"
              >2023</a
            >
          </h3>
        </section>
        <section>
          <h3>
            <a
              href="https://github.com/kherrick/hacker-news/blob/main/archives/2022/index.md"
              >2022</a
            >
          </h3>
        </section>
      </section>
    </main>
    <script type="module">
      import { buildDescendants } from "./lib/build-html-descendants.js";
      import { buildNextItem } from "./lib/build-html-next-item.js";
      import { getNextDateTime } from "./lib/date-time.js";

      const updateSectionById = (id) =>
        fetch(`https://hacker-news.firebaseio.com/v0/item/${id}.json`).then(
          (result) =>
            result.json().then(({ descendants, id, score, text, type }) => {
              const currentItem = document.getElementById(id);

              if (score) {
                currentItem.querySelector(".points").textContent = score;
              }

              if (descendants && (type === "poll" || type === "story")) {
                const currentDescendants =
                  currentItem.querySelector(".descendants");

                if (currentDescendants) {
                  currentDescendants.textContent = `: ${descendants}`;
                } else {
                  const comments = buildDescendants(
                    document,
                    descendants,
                    `https://news.ycombinator.com/item?id=${id}`
                  );

                  currentItem.querySelector("h4").appendChild(comments);
                }
              }

              if (text) {
                const currentText = currentItem.querySelector(".text");

                if (currentText) {
                  currentText.innerHTML = text.replace(/\0/g, "");
                } else {
                  const content = document.createElement("div");
                  content.innerHTML = text.replace(/\0/g, "");
                  content.setAttribute("class", "text");

                  currentItem.appendChild(content);
                }
              }
            })
        );

      class UpdateQueue {
        constructor() {
          this._ids = [];
          this._isUpdating = false;
        }

        addItemById(id) {
          this._ids.push(id);
        }

        async flush() {
          const id = this._ids.shift();

          if (id) {
            this._isUpdating = true;

            await updateSectionById(id);
            await this.flush();
          } else {
            this._isUpdating = false;

            setTimeout(async () => {
              if (!this._isUpdating && this._ids && this._ids.length) {
                await this.flush();
              }
            }, 0);
          }
        }
      }

      // get latest data
      const latestSection = document.getElementById("latest");

      for (let item of latestSection.querySelectorAll("section[id]")) {
        updateSectionById(item.getAttribute("id"));
      }

      if ("IntersectionObserver" in window) {
        window.hackerNewsState = { index: [], nextTimeIndex: -1 };

        const addNewsItem = async (newsItem, queue) => {
          try {
            const { date, time, itemComments, itemTitle, itemLink } = newsItem;
            const section = await buildNextItem({
              document,
              dateTime: `${date}, ${time}`,
              itemComments,
              itemLink,
              itemTitle: new DOMParser().parseFromString(
                itemTitle.replace(/\\/g, ""),
                "text/html"
              ).documentElement.textContent,
              fetchItemDetails: false,
            });

            // display loading indicator for section
            section.querySelector(".points-container").innerHTML =
              'Points: <span class="points"><img style="height: 100%;" src="lib/images/loading.svg" /></span>';

            const id = section.getAttribute("id");
            if (!document.getElementById(id)) {
              document.getElementById("latest").appendChild(section);

              queue.addItemById(id);
            }
          } catch (error) {}
        };

        const buildArchiveIndex = async (lastDateTime) => {
          const nextDate = lastDateTime.slice(0, 10);
          const nextYear = nextDate.slice(0, 4);

          return (
            await (
              await fetch(
                `https://raw.githubusercontent.com/kherrick/hacker-news/main/archives/${nextYear}/${nextDate}/index.md`
              )
            ).text()
          )
            .split("\n")
            .filter((line) => line.match(new RegExp("^\\* \\[")))
            .map((line) => {
              const segment = line.replace("* ", "").split("](");
              const pubDate = segment[0].slice(1);

              const itemComments = segment[1].split(") - [")[0];
              const itemTitle = segment[1].split(") - [")[1];
              const itemLink = segment[2].slice(0, -1);
              const date = pubDate.slice(0, 10);
              const time = pubDate.slice(-8);

              return {
                date,
                itemComments,
                itemLink,
                itemTitle,
                time,
              };
            });
        };

        const handleIntersectingEntry = async (entry, queue) => {
          if (entry.isIntersecting) {
            const lastDateTime = document
              .getElementById("latest")
              .querySelector(
                "section:last-child > section > h4 > span"
              ).textContent;

            const nextDateTime = getNextDateTime(lastDateTime ?? "", -1);
            const archiveIndex = await buildArchiveIndex(nextDateTime);
            const nextTimeIndex = archiveIndex.findIndex(
              ({ time }) => time === nextDateTime.slice(-8)
            );

            const handleIndexUpdate = (index, existingIndexValues = []) => {
              index.forEach((i) => {
                existingIndexValues.push(i);
              });
              return existingIndexValues;
            };

            window.hackerNewsState = {
              index: handleIndexUpdate(
                archiveIndex,
                window.hackerNewsState.index
              ),
              nextTimeIndex,
            };

            let currentTimeIndex = nextTimeIndex + 1;
            const items = Object.values(window.hackerNewsState.index);
            for (let item of items) {
              if (currentTimeIndex < window.hackerNewsState.index.length) {
                addNewsItem(items[currentTimeIndex], queue);

                currentTimeIndex = currentTimeIndex + 1;
              }
            }

            queue.flush();
          }
        };

        const archives = document.getElementById("archives");
        const archivesObserver = new IntersectionObserver(
          (entries) => {
            const queue = new UpdateQueue();

            entries.forEach((entry) => handleIntersectingEntry(entry, queue));
          },
          {
            root: null,
            rootMargin: "0px",
            threshold: 0,
          }
        );

        archivesObserver.observe(archives);

        let latestSectionsExpanded = true;
        const handleLatestHeaderClick = () => {
          latestSectionsExpanded = !latestSectionsExpanded;

          if (latestSectionsExpanded) {
            archivesObserver.observe(archives);
          } else {
            archivesObserver.disconnect(archives);
          }

          for (let section of document.querySelectorAll("#latest > section")) {
            section.style.display = latestSectionsExpanded ? "block" : "none";
          }
        };

        const latestHeader = document.querySelector("#latest > h2");
        latestHeader.style.cursor = "pointer";
        latestHeader.addEventListener("click", handleLatestHeaderClick);
      }
    </script>
    <script type="module">
      import { Workbox } from "https://storage.googleapis.com/workbox-cdn/releases/6.4.1/workbox-window.prod.mjs";

      if ("serviceWorker" in navigator) {
        const base = document.querySelector("base");
        const serviceWorkerPath = `${
          base ? base.href.replace(/\/$/, "") : ""
        }/service-worker.js`;

        const wb = new Workbox(serviceWorkerPath);

        // setup event listeners
        wb.addEventListener("waiting", (event) => {
          wb.addEventListener("controlling", () => {
            window.location.reload();
          });

          wb.messageSkipWaiting();
        });

        wb.register();
      }
    </script>
  </body>
</html>
