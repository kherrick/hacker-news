<!DOCTYPE html>
<html lang="en" xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta charset="utf-8" />
    <meta
      content="width=device-width, initial-scale=1.0, viewport-fit=cover"
      name="viewport"
    />
    <meta name="description" content="Hacker News" />
    <meta name="theme-color" content="#fff" />
    <title>Hacker News</title>
    <link rel="manifest" href="manifest.json" />
    <link
      href="data:image/x-icon;base64,AAABAAEAAQECAAEAAQA4AAAAFgAAACgAAAABAAAAAgAAAAEAAQAAAAAAAAAAAAAAAAAAAAAAAAAAAAABAAEAAQECAAEAAQA4AAAAFgAAACgAAAABAAAAAgAAAAEAAQAAAAAAAAAAAAAAAAAAAAAAAAAA"
      rel="icon"
      type="image/x-icon"
    />
    <link
      href="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAgAAAAIAAQMAAADOtka5AAAAA1BMVEUAAACnej3aAAAANklEQVR42u3BAQEAAACCIP+vbkhAAQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAB8G4IAAAFjdVCkAAAAAElFTkSuQmCC"
      rel="apple-touch-icon"
    />
    <style>
      /*<!--*/
      body {
        color: rgb(25, 25, 25);
        font-family: Verdana, Geneva, sans-serif;
        margin: 0;
      }

      a {
        text-decoration: none;
      }

      a:link,
      a:focus,
      a:hover,
      a:active {
        color: rgb(75, 75, 125);
      }

      a:visited {
        color: rgb(25, 25, 25);
      }

      h1 > a,
      h1 > a:link,
      h1 > a:focus,
      h1 > a:hover,
      h1 > a:active,
      h1 > a:visited,
      h2 > a,
      h2 > a:link,
      h2 > a:focus,
      h2 > a:hover,
      h2 > a:active,
      h2 > a:visited {
        color: rgb(25, 25, 25);
      }

      h1 {
        background-color: rgb(255, 102, 0);
        margin: 0;
        padding: 1rem;
      }

      h2 {
        background-color: rgb(200, 200, 200);
        margin: 1rem 0;
        padding: 0.5rem 0.5rem 0.5rem 1rem;
      }

      #latest > section,
      #archives > section {
        margin: 0 1rem 1rem 1rem;
        padding-bottom: 1rem;
      }

      #latest > section:not(:last-child),
      #archives > section:not(:last-child) {
        border-bottom: 1px dotted rgb(200, 200, 200);
      }

      section > h3 {
        margin: 0 0 0.5rem 0;
      }

      section > h4 {
        font-weight: normal;
        margin: 0 0 0 1rem;
      }

      .descendants-container,
      .points-container {
        align-items: center;
        border-left: 1px solid #333;
        display: inline-flex;
        margin-left: 0.5rem;
        padding-left: 0.5rem;
        text-align: center;
      }

      .points {
        align-items: center;
        display: inline-flex;
        height: 1rem;
        margin-left: 1ch;
        min-width: 3ch;
      }

      .text {
        line-height: 1.5rem;
        margin: 1rem 1rem 0 1rem;
        overflow: auto;
      }

      .text > p:first-child {
        margin-top: 1rem;
      }

      .text > p:last-child {
        margin-bottom: 0;
      }
      /*-->*/
    </style>
  </head>

  <body>
    <main>
      <h1><a href="https://kherrick.github.io/hacker-news/">Hacker News</a></h1>
      <section id="latest">
        <h2>Latest</h2>
        <section id="37493748">
          <h3>
            <a
              class="item"
              href="https://arstechnica.com/security/2023/09/password-stealing-linux-malware-served-for-3-years-and-no-one-noticed/"
              >Password-stealing Linux malware served for 3 years and no one
              noticed</a
            >
          </h3>
          <section>
            <h4>
              <span>2023-09-13 @ 08:21:10</span
              ><span class="points-container"
                >Points: <span class="points">6</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=37493748"
                  >Comments</a
                ><span class="descendants">: 1</span></span
              >
            </h4>
          </section>
        </section>
        <section id="37493675">
          <h3>
            <a
              class="item"
              href="https://www.telegraph.co.uk/cars/features/why-cars-continue-get-bigger/"
              >Britain's roads can't keep up with our cars</a
            >
          </h3>
          <section>
            <h4>
              <span>2023-09-13 @ 08:12:02</span
              ><span class="points-container"
                >Points: <span class="points">10</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=37493675"
                  >Comments</a
                ><span class="descendants">: 15</span></span
              >
            </h4>
          </section>
        </section>
        <section id="37493566">
          <h3>
            <a
              class="item"
              href="https://www.france24.com/en/europe/20230912-france-orders-apple-to-halt-iphone-12-sales-due-to-high-radiation-levels"
              >French regulators order Apple to halt sales of the iPhone 12</a
            >
          </h3>
          <section>
            <h4>
              <span>2023-09-13 @ 07:56:32</span
              ><span class="points-container"
                >Points: <span class="points">25</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=37493566"
                  >Comments</a
                ><span class="descendants">: 12</span></span
              >
            </h4>
          </section>
        </section>
        <section id="37493028">
          <h3>
            <a
              class="item"
              href="https://www.404media.co/unity-new-fees-prices/"
              >“This Is a Disaster:” Game Developers Scramble to Deal with
              Unity’s New Fees</a
            >
          </h3>
          <section>
            <h4>
              <span>2023-09-13 @ 06:42:27</span
              ><span class="points-container"
                >Points: <span class="points">109</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=37493028"
                  >Comments</a
                ><span class="descendants">: 77</span></span
              >
            </h4>
          </section>
        </section>
        <section id="37492986">
          <h3>
            <a class="item" href="https://github.com/turboderp/exllamav2"
              >70B Llama 2 at 35tokens/second on 4090</a
            >
          </h3>
          <section>
            <h4>
              <span>2023-09-13 @ 06:37:46</span
              ><span class="points-container"
                >Points: <span class="points">50</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=37492986"
                  >Comments</a
                ><span class="descendants">: 20</span></span
              >
            </h4>
          </section>
        </section>
        <section id="37492852">
          <h3>
            <a
              class="item"
              href="http://jpkoning.blogspot.com/2023/09/there-are-now-two-types-of-paypal.html"
              >There are now two types of PayPal dollars, and one is better than
              the other</a
            >
          </h3>
          <section>
            <h4>
              <span>2023-09-13 @ 06:17:35</span
              ><span class="points-container"
                >Points: <span class="points">77</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=37492852"
                  >Comments</a
                ><span class="descendants">: 46</span></span
              >
            </h4>
          </section>
        </section>
        <section id="37492752">
          <h3>
            <a
              class="item"
              href="https://www.anfr.fr/liste-actualites/actualite/temporary-withdrawal-from-the-market-of-the-iphone-12-for-non-compliance-with-eu-regulation"
              >iPhone 12 withdrawn from French market for non-compliance with EU
              regulation</a
            >
          </h3>
          <section>
            <h4>
              <span>2023-09-13 @ 06:01:00</span
              ><span class="points-container"
                >Points: <span class="points">46</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=37492752"
                  >Comments</a
                ><span class="descendants">: 6</span></span
              >
            </h4>
          </section>
        </section>
        <section id="37492730">
          <h3>
            <a
              class="item"
              href="https://www.marca.com/en/lifestyle/world-news/2023/09/13/65011a37ca4741e5678b4580.html"
              >Non-human“ alien corpses displayed at Mexico's Congress, believed
              to be 1k year</a
            >
          </h3>
          <section>
            <h4>
              <span>2023-09-13 @ 05:57:47</span
              ><span class="points-container"
                >Points: <span class="points">32</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=37492730"
                  >Comments</a
                ><span class="descendants">: 12</span></span
              >
            </h4>
          </section>
        </section>
        <section id="37492371">
          <h3>
            <a
              class="item"
              href="https://www.da.vidbuchanan.co.uk/blog/unix-clock.html"
              >S32 Unix Clock</a
            >
          </h3>
          <section>
            <h4>
              <span>2023-09-13 @ 04:57:41</span
              ><span class="points-container"
                >Points: <span class="points">55</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=37492371"
                  >Comments</a
                ><span class="descendants">: 3</span></span
              >
            </h4>
          </section>
        </section>
        <section id="37491862">
          <h3>
            <a
              class="item"
              href="https://devblogs.microsoft.com/oldnewthing/20230911-00/?p=108749"
              >Any sufficiently advanced uninstaller is indistinguishable from
              malware</a
            >
          </h3>
          <section>
            <h4>
              <span>2023-09-13 @ 03:31:07</span
              ><span class="points-container"
                >Points: <span class="points">293</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=37491862"
                  >Comments</a
                ><span class="descendants">: 153</span></span
              >
            </h4>
          </section>
        </section>
        <section id="37490924">
          <h3>
            <a
              class="item"
              href="https://www.ignorance.ai/p/5-lessons-from-139-yc-ai-startups"
              >Lessons from YC AI Startups</a
            >
          </h3>
          <section>
            <h4>
              <span>2023-09-13 @ 01:12:46</span
              ><span class="points-container"
                >Points: <span class="points">73</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=37490924"
                  >Comments</a
                ><span class="descendants">: 33</span></span
              >
            </h4>
          </section>
        </section>
        <section id="37490623">
          <h3>
            <a class="item" href="https://makelinux.github.io/kernel/map/"
              >Interactive Map of Linux Kernel</a
            >
          </h3>
          <section>
            <h4>
              <span>2023-09-13 @ 00:31:56</span
              ><span class="points-container"
                >Points: <span class="points">197</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=37490623"
                  >Comments</a
                ><span class="descendants">: 11</span></span
              >
            </h4>
          </section>
        </section>
        <section id="37490300">
          <h3>
            <a
              class="item"
              href="https://www.lennysnewsletter.com/p/finding-product-market-fit"
              >How long it took different companies to find product-market
              fit</a
            >
          </h3>
          <section>
            <h4>
              <span>2023-09-12 @ 23:51:05</span
              ><span class="points-container"
                >Points: <span class="points">134</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=37490300"
                  >Comments</a
                ><span class="descendants">: 37</span></span
              >
            </h4>
          </section>
        </section>
        <section id="37490244">
          <h3>
            <a
              class="item"
              href="https://racquetmag.com/2023/09/06/game-set-sell/"
              >Game, Set, Sell</a
            >
          </h3>
          <section>
            <h4>
              <span>2023-09-12 @ 23:45:28</span
              ><span class="points-container"
                >Points: <span class="points">15</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=37490244"
                  >Comments</a
                ><span class="descendants">: 1</span></span
              >
            </h4>
          </section>
        </section>
        <section id="37490241">
          <h3>
            <a
              class="item"
              href="https://www.bitsaboutmoney.com/archive/the-waste-stream-of-consumer-finance/"
              >Credit card debt collection</a
            >
          </h3>
          <section>
            <h4>
              <span>2023-09-12 @ 23:45:06</span
              ><span class="points-container"
                >Points: <span class="points">458</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=37490241"
                  >Comments</a
                ><span class="descendants">: 202</span></span
              >
            </h4>
          </section>
        </section>
        <section id="37490234">
          <h3>
            <a
              class="item"
              href="https://betonit.substack.com/p/why-not-punish-families"
              >Why not punish families? A challenge for consequentialists</a
            >
          </h3>
          <section>
            <h4>
              <span>2023-09-12 @ 23:43:55</span
              ><span class="points-container"
                >Points: <span class="points">42</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=37490234"
                  >Comments</a
                ><span class="descendants">: 113</span></span
              >
            </h4>
          </section>
        </section>
        <section id="37488252">
          <h3>
            <a class="item" href="https://www.justpaid.io/careers"
              >JustPaid.io (YC W23) is hiring a senior full stack engineer</a
            >
          </h3>
          <section>
            <h4>
              <span>2023-09-12 @ 21:00:00</span
              ><span class="points-container"
                >Points: <span class="points">1</span></span
              >
            </h4>
          </section>
        </section>
        <section id="37488034">
          <h3>
            <a
              class="item"
              href="https://bricolage.io/some-notes-on-local-first-development/"
              >Some notes on local-first development</a
            >
          </h3>
          <section>
            <h4>
              <span>2023-09-12 @ 20:46:55</span
              ><span class="points-container"
                >Points: <span class="points">125</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=37488034"
                  >Comments</a
                ><span class="descendants">: 48</span></span
              >
            </h4>
          </section>
        </section>
        <section id="37487306">
          <h3>
            <a class="item" href="https://spectrum.ieee.org/cryogenics"
              >Electric cooling could shrink quantum computers</a
            >
          </h3>
          <section>
            <h4>
              <span>2023-09-12 @ 20:03:44</span
              ><span class="points-container"
                >Points: <span class="points">64</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=37487306"
                  >Comments</a
                ><span class="descendants">: 10</span></span
              >
            </h4>
          </section>
        </section>
        <section id="37485290">
          <h3>
            <a
              class="item"
              href="https://www.apple.com/newsroom/2023/09/apple-debuts-iphone-15-and-iphone-15-plus/"
              >iPhone 15 and iPhone 15 Plus</a
            >
          </h3>
          <section>
            <h4>
              <span>2023-09-12 @ 18:23:09</span
              ><span class="points-container"
                >Points: <span class="points">673</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=37485290"
                  >Comments</a
                ><span class="descendants">: 1697</span></span
              >
            </h4>
          </section>
        </section>
        <section id="37484135">
          <h3>
            <a class="item" href="https://news.ycombinator.com/item?id=37484135"
              >Fine-tune your own Llama 2 to replace GPT-3.5/4</a
            >
          </h3>
          <section>
            <h4>
              <span>2023-09-12 @ 16:53:51</span
              ><span class="points-container"
                >Points: <span class="points">762</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=37484135"
                  >Comments</a
                ><span class="descendants">: 153</span></span
              >
            </h4>
            <div class="text">
              <a href="https://news.ycombinator.com/item?id=37090632"
                >https://news.ycombinator.com/item?id=37090632</a
              >). I've been playing around with fine-tuning models for a couple
              of years, and wanted to share some insights and practical code.
              I’ve condensed what I’ve learned into a small set of notebooks at
              <a
                href="https://github.com/OpenPipe/OpenPipe/tree/main/examples/classify-recipes"
                >https://github.com/OpenPipe/OpenPipe/tree/main/examples/clas...</a
              >, covering labeling data, fine-tuning, running efficient
              inference, and evaluating costs/performance. The 7B model we train
              here matches GPT-4’s labels 95% of the time on the test set, and
              for the 5% of cases where they disagree it’s often because the
              correct answer is genuinely ambiguous.
              <p>
                What is fine-tuning? You can think of it as a more-powerful form
                of prompting, where instead of writing your instructions in text
                you actually encode them in the weights of the model itself. You
                do this by training an existing model on example input/output
                pairs that demonstrate the task you want your fine-tuned model
                to learn. Fine-tuning can work with as few as 50 examples but I
                usually try to get 1000+ if possible.
              </p>
              <p>
                Prompting still has some big advantages over fine-tuning. It's
                way easier/faster to iterate on your instructions than label
                data and re-train a model. And operationally it's easier to
                deploy one big model and just adjust its behavior as necessary
                vs deploying many small fine-tuned models that will likely each
                get lower utilization.
              </p>
              <p>
                Fine-tuning has one huge advantage though: it is far more
                effective at guiding a model's behavior than prompting, so you
                can often get away with a <i>much</i> smaller model. That gets
                you faster responses and lower inference costs. A fine-tuned
                Llama 7B model is 50x cheaper than GPT-3.5 on a per-token basis,
                and for many use cases can produce results that are as good or
                better!
              </p>
              <p>
                For example, classifying the 2M recipes at
                <a href="https://huggingface.co/datasets/corbt/all-recipes"
                  >https://huggingface.co/datasets/corbt/all-recipes</a
                >
                with GPT-4 would cost $23k. Even with GPT-3.5 it would cost over
                $1k. The model we fine-tuned performs similarly to GPT-4 and
                costs just $19 to run over the entire dataset.
              </p>
              <p>
                Disclaimer: My brother David and I are working on an open-source
                product called OpenPipe (<a
                  href="https://github.com/openpipe/openpipe"
                  >https://github.com/openpipe/openpipe</a
                >) to help engineers adopt fine-tuning as simply as possible.
                But none of the information above depends on our startup. The
                current post is just about sharing information that we’ve
                learned about fine-tuning. I hope it’s useful!
              </p>
            </div>
          </section>
        </section>
        <section id="37483734">
          <h3>
            <a class="item" href="https://throbol.com/"
              >Throbol – The Robot Oriented Language</a
            >
          </h3>
          <section>
            <h4>
              <span>2023-09-12 @ 16:28:59</span
              ><span class="points-container"
                >Points: <span class="points">19</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=37483734"
                  >Comments</a
                ><span class="descendants">: 2</span></span
              >
            </h4>
          </section>
        </section>
        <section id="37480561">
          <h3>
            <a
              class="item"
              href="https://thepalindrome.org/p/how-large-that-number-in-the-law"
              >How large is that number in the Law of Large Numbers?</a
            >
          </h3>
          <section>
            <h4>
              <span>2023-09-12 @ 13:06:33</span
              ><span class="points-container"
                >Points: <span class="points">152</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=37480561"
                  >Comments</a
                ><span class="descendants">: 60</span></span
              >
            </h4>
          </section>
        </section>
        <section id="37479472">
          <h3>
            <a
              class="item"
              href="https://apnews.com/article/sweden-digital-education-backlash-reading-writing-1dd964c628f76361c43dbf3964f7dbf4"
              >Sweden brings more books and handwriting practice back to its
              tech-heavy schools</a
            >
          </h3>
          <section>
            <h4>
              <span>2023-09-12 @ 11:30:57</span
              ><span class="points-container"
                >Points: <span class="points">258</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=37479472"
                  >Comments</a
                ><span class="descendants">: 223</span></span
              >
            </h4>
          </section>
        </section>
        <section id="37477380">
          <h3>
            <a
              class="item"
              href="https://www.chronicle.com/article/robinson-crusoe-walks-into-a-bar"
              >Robinson Crusoe Walks Into a Bar: A literary scholar and an
              improbable lawsuit</a
            >
          </h3>
          <section>
            <h4>
              <span>2023-09-12 @ 06:07:02</span
              ><span class="points-container"
                >Points: <span class="points">12</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=37477380"
                  >Comments</a
                ><span class="descendants">: 1</span></span
              >
            </h4>
          </section>
        </section>
        <section id="37474623">
          <h3>
            <a
              class="item"
              href="https://onlinelibrary.wiley.com/doi/10.1002/advs.202301673"
              >Recyclable thin-film soft electronics for smart packaging and
              e-skins</a
            >
          </h3>
          <section>
            <h4>
              <span>2023-09-11 @ 22:35:51</span
              ><span class="points-container"
                >Points: <span class="points">16</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=37474623"
                  >Comments</a
                ><span class="descendants">: 1</span></span
              >
            </h4>
          </section>
        </section>
        <section id="37472347">
          <h3>
            <a
              class="item"
              href="https://en.wikipedia.org/wiki/Rubber_hose_animation"
              >Rubber hose animation</a
            >
          </h3>
          <section>
            <h4>
              <span>2023-09-11 @ 19:20:00</span
              ><span class="points-container"
                >Points: <span class="points">5</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=37472347"
                  >Comments</a
                ><span class="descendants">: 1</span></span
              >
            </h4>
          </section>
        </section>
        <section id="37469864">
          <h3>
            <a
              class="item"
              href="https://www.atlasobscura.com/articles/last-gas-lamp-theater-england"
              >How to Ensure the Last Gas-Lamp Theater in the World Doesn’t Blow
              Up</a
            >
          </h3>
          <section>
            <h4>
              <span>2023-09-11 @ 16:41:31</span
              ><span class="points-container"
                >Points: <span class="points">10</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=37469864"
                  >Comments</a
                ><span class="descendants">: 1</span></span
              >
            </h4>
          </section>
        </section>
        <section id="37465586">
          <h3>
            <a class="item" href="https://astrochart.github.io/"
              >CHART: Completely Hackable Amateur Radio Telescope</a
            >
          </h3>
          <section>
            <h4>
              <span>2023-09-11 @ 11:18:42</span
              ><span class="points-container"
                >Points: <span class="points">183</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=37465586"
                  >Comments</a
                ><span class="descendants">: 49</span></span
              >
            </h4>
          </section>
        </section>
        <section id="37463059">
          <h3>
            <a
              class="item"
              href="https://reason.com/2023/09/10/the-pirate-preservationists/"
              >The Pirate Preservationists</a
            >
          </h3>
          <section>
            <h4>
              <span>2023-09-11 @ 04:59:54</span
              ><span class="points-container"
                >Points: <span class="points">74</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=37463059"
                  >Comments</a
                ><span class="descendants">: 4</span></span
              >
            </h4>
          </section>
        </section>
      </section>
      <section id="archives">
        <h2>
          <a
            href="https://github.com/kherrick/hacker-news/blob/main/archives/index.md"
            >Archives</a
          >
        </h2>
        <section>
          <h3>
            <a
              href="https://github.com/kherrick/hacker-news/blob/main/archives/2023/index.md"
              >2023</a
            >
          </h3>
        </section>
        <section>
          <h3>
            <a
              href="https://github.com/kherrick/hacker-news/blob/main/archives/2022/index.md"
              >2022</a
            >
          </h3>
        </section>
      </section>
    </main>
    <script type="module">
      import { buildDescendants } from "./lib/build-html-descendants.js";
      import { buildNextItem } from "./lib/build-html-next-item.js";
      import { getNextDateTime } from "./lib/date-time.js";

      const updateSectionById = (id) =>
        fetch(`https://hacker-news.firebaseio.com/v0/item/${id}.json`).then(
          (result) =>
            result.json().then(({ descendants, id, score, text, type }) => {
              const currentItem = document.getElementById(id);

              if (score) {
                currentItem.querySelector(".points").textContent = score;
              }

              if (descendants && (type === "poll" || type === "story")) {
                const currentDescendants =
                  currentItem.querySelector(".descendants");

                if (currentDescendants) {
                  currentDescendants.textContent = `: ${descendants}`;
                } else {
                  const comments = buildDescendants(
                    document,
                    descendants,
                    `https://news.ycombinator.com/item?id=${id}`
                  );

                  currentItem.querySelector("h4").appendChild(comments);
                }
              }

              if (text) {
                const currentText = currentItem.querySelector(".text");

                if (currentText) {
                  currentText.innerHTML = text.replace(/\0/g, "");
                } else {
                  const content = document.createElement("div");
                  content.innerHTML = text.replace(/\0/g, "");
                  content.setAttribute("class", "text");

                  currentItem.appendChild(content);
                }
              }
            })
        );

      class UpdateQueue {
        constructor() {
          this._ids = [];
          this._isUpdating = false;
        }

        addItemById(id) {
          this._ids.push(id);
        }

        async flush() {
          const id = this._ids.shift();

          if (id) {
            this._isUpdating = true;

            await updateSectionById(id);
            await this.flush();
          } else {
            this._isUpdating = false;

            setTimeout(async () => {
              if (!this._isUpdating && this._ids && this._ids.length) {
                await this.flush();
              }
            }, 0);
          }
        }
      }

      // get latest data
      const latestSection = document.getElementById("latest");

      for (let item of latestSection.querySelectorAll("section[id]")) {
        updateSectionById(item.getAttribute("id"));
      }

      if ("IntersectionObserver" in window) {
        window.hackerNewsState = { index: [], nextTimeIndex: -1 };

        const addNewsItem = async (newsItem, queue) => {
          try {
            const { date, time, itemComments, itemTitle, itemLink } = newsItem;
            const section = await buildNextItem({
              document,
              dateTime: `${date}, ${time}`,
              itemComments,
              itemLink,
              itemTitle: new DOMParser().parseFromString(
                itemTitle.replace(/\\/g, ""),
                "text/html"
              ).documentElement.textContent,
              fetchItemDetails: false,
            });

            // display loading indicator for section
            section.querySelector(".points-container").innerHTML =
              'Points: <span class="points"><img style="height: 100%;" src="lib/images/loading.svg" /></span>';

            const id = section.getAttribute("id");
            if (!document.getElementById(id)) {
              document.getElementById("latest").appendChild(section);

              queue.addItemById(id);
            }
          } catch (error) {}
        };

        const buildArchiveIndex = async (lastDateTime) => {
          const nextDate = lastDateTime.slice(0, 10);
          const nextYear = nextDate.slice(0, 4);

          return (
            await (
              await fetch(
                `https://raw.githubusercontent.com/kherrick/hacker-news/main/archives/${nextYear}/${nextDate}/index.md`
              )
            ).text()
          )
            .split("\n")
            .filter((line) => line.match(new RegExp("^\\* \\[")))
            .map((line) => {
              const segment = line.replace("* ", "").split("](");
              const pubDate = segment[0].slice(1);

              const itemComments = segment[1].split(") - [")[0];
              const itemTitle = segment[1].split(") - [")[1];
              const itemLink = segment[2].slice(0, -1);
              const date = pubDate.slice(0, 10);
              const time = pubDate.slice(-8);

              return {
                date,
                itemComments,
                itemLink,
                itemTitle,
                time,
              };
            });
        };

        const handleIntersectingEntry = async (entry, queue) => {
          if (entry.isIntersecting) {
            const lastDateTime = document
              .getElementById("latest")
              .querySelector(
                "section:last-child > section > h4 > span"
              ).textContent;

            const nextDateTime = getNextDateTime(lastDateTime ?? "", -1);
            const archiveIndex = await buildArchiveIndex(nextDateTime);
            const nextTimeIndex = archiveIndex.findIndex(
              ({ time }) => time === nextDateTime.slice(-8)
            );

            const handleIndexUpdate = (index, existingIndexValues = []) => {
              index.forEach((i) => {
                existingIndexValues.push(i);
              });
              return existingIndexValues;
            };

            window.hackerNewsState = {
              index: handleIndexUpdate(
                archiveIndex,
                window.hackerNewsState.index
              ),
              nextTimeIndex,
            };

            let currentTimeIndex = nextTimeIndex + 1;
            const items = Object.values(window.hackerNewsState.index);
            for (let item of items) {
              if (currentTimeIndex < window.hackerNewsState.index.length) {
                addNewsItem(items[currentTimeIndex], queue);

                currentTimeIndex = currentTimeIndex + 1;
              }
            }

            queue.flush();
          }
        };

        const archives = document.getElementById("archives");
        const archivesObserver = new IntersectionObserver(
          (entries) => {
            const queue = new UpdateQueue();

            entries.forEach((entry) => handleIntersectingEntry(entry, queue));
          },
          {
            root: null,
            rootMargin: "0px",
            threshold: 0,
          }
        );

        archivesObserver.observe(archives);

        let latestSectionsExpanded = true;
        const handleLatestHeaderClick = () => {
          latestSectionsExpanded = !latestSectionsExpanded;

          if (latestSectionsExpanded) {
            archivesObserver.observe(archives);
          } else {
            archivesObserver.disconnect(archives);
          }

          for (let section of document.querySelectorAll("#latest > section")) {
            section.style.display = latestSectionsExpanded ? "block" : "none";
          }
        };

        const latestHeader = document.querySelector("#latest > h2");
        latestHeader.style.cursor = "pointer";
        latestHeader.addEventListener("click", handleLatestHeaderClick);
      }
    </script>
    <script type="module">
      import { Workbox } from "https://storage.googleapis.com/workbox-cdn/releases/6.4.1/workbox-window.prod.mjs";

      if ("serviceWorker" in navigator) {
        const base = document.querySelector("base");
        const serviceWorkerPath = `${
          base ? base.href.replace(/\/$/, "") : ""
        }/service-worker.js`;

        const wb = new Workbox(serviceWorkerPath);

        // setup event listeners
        wb.addEventListener("waiting", (event) => {
          wb.addEventListener("controlling", () => {
            window.location.reload();
          });

          wb.messageSkipWaiting();
        });

        wb.register();
      }
    </script>
  </body>
</html>
