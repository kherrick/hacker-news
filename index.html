<!DOCTYPE html>
<html lang="en" xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta charset="utf-8" />
    <meta
      content="width=device-width, initial-scale=1.0, viewport-fit=cover"
      name="viewport"
    />
    <meta name="description" content="Hacker News" />
    <meta name="theme-color" content="#fff" />
    <title>Hacker News</title>
    <link rel="manifest" href="manifest.json" />
    <link
      href="data:image/x-icon;base64,AAABAAEAAQECAAEAAQA4AAAAFgAAACgAAAABAAAAAgAAAAEAAQAAAAAAAAAAAAAAAAAAAAAAAAAAAAABAAEAAQECAAEAAQA4AAAAFgAAACgAAAABAAAAAgAAAAEAAQAAAAAAAAAAAAAAAAAAAAAAAAAA"
      rel="icon"
      type="image/x-icon"
    />
    <link
      href="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAgAAAAIAAQMAAADOtka5AAAAA1BMVEUAAACnej3aAAAANklEQVR42u3BAQEAAACCIP+vbkhAAQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAB8G4IAAAFjdVCkAAAAAElFTkSuQmCC"
      rel="apple-touch-icon"
    />
    <style>
      /*<!--*/
      body {
        color: rgb(25, 25, 25);
        font-family: Verdana, Geneva, sans-serif;
        margin: 0;
      }

      a {
        text-decoration: none;
      }

      a:link,
      a:focus,
      a:hover,
      a:active {
        color: rgb(75, 75, 125);
      }

      a:visited {
        color: rgb(25, 25, 25);
      }

      h1 > a,
      h1 > a:link,
      h1 > a:focus,
      h1 > a:hover,
      h1 > a:active,
      h1 > a:visited,
      h2 > a,
      h2 > a:link,
      h2 > a:focus,
      h2 > a:hover,
      h2 > a:active,
      h2 > a:visited {
        color: rgb(25, 25, 25);
      }

      h1 {
        background-color: rgb(255, 102, 0);
        margin: 0;
        padding: 1rem;
      }

      h2 {
        background-color: rgb(200, 200, 200);
        margin: 1rem 0;
        padding: 0.5rem 0.5rem 0.5rem 1rem;
      }

      #latest > section,
      #archives > section {
        margin: 0 1rem 1rem 1rem;
        padding-bottom: 1rem;
      }

      #latest > section:not(:last-child),
      #archives > section:not(:last-child) {
        border-bottom: 1px dotted rgb(200, 200, 200);
      }

      section > h3 {
        margin: 0 0 0.5rem 0;
      }

      section > h4 {
        font-weight: normal;
        margin: 0 0 0 1rem;
      }

      .descendants-container,
      .points-container {
        align-items: center;
        border-left: 1px solid #333;
        display: inline-flex;
        margin-left: 0.5rem;
        padding-left: 0.5rem;
        text-align: center;
      }

      .points {
        align-items: center;
        display: inline-flex;
        height: 1rem;
        margin-left: 1ch;
        min-width: 3ch;
      }

      .text {
        line-height: 1.5rem;
        margin: 1rem 1rem 0 1rem;
        overflow: auto;
      }

      .text > p:first-child {
        margin-top: 1rem;
      }

      .text > p:last-child {
        margin-bottom: 0;
      }
      /*-->*/
    </style>
  </head>

  <body>
    <main>
      <h1><a href="https://kherrick.github.io/hacker-news/">Hacker News</a></h1>
      <section id="latest">
        <h2>Latest</h2>
        <section id="35397418">
          <h3>
            <a
              class="item"
              href="https://worldcoin.org/blog/engineering/humanness-in-the-age-of-ai"
              >Humanness in the Age of AI</a
            >
          </h3>
          <section>
            <h4>
              <span>2023-04-01 @ 05:27:52</span
              ><span class="points-container"
                >Points: <span class="points">24</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=35397418"
                  >Comments</a
                ><span class="descendants">: 17</span></span
              >
            </h4>
          </section>
        </section>
        <section id="35397271">
          <h3>
            <a
              class="item"
              href="https://www.residentcontrarian.com/p/he-who-submits-a-resume-has-already"
              >He who submits a resume has already lost</a
            >
          </h3>
          <section>
            <h4>
              <span>2023-04-01 @ 04:55:30</span
              ><span class="points-container"
                >Points: <span class="points">93</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=35397271"
                  >Comments</a
                ><span class="descendants">: 59</span></span
              >
            </h4>
          </section>
        </section>
        <section id="35397071">
          <h3>
            <a
              class="item"
              href="https://arstechnica.com/gadgets/2023/03/google-drive-does-a-surprise-rollout-of-file-limits-locking-out-some-users/"
              >Google Drive does a surprise rollout of file limits, locking out
              some users</a
            >
          </h3>
          <section>
            <h4>
              <span>2023-04-01 @ 04:16:46</span
              ><span class="points-container"
                >Points: <span class="points">110</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=35397071"
                  >Comments</a
                ><span class="descendants">: 55</span></span
              >
            </h4>
          </section>
        </section>
        <section id="35396696">
          <h3>
            <a class="item" href="https://aplcart.info/"
              >APLcart – Find your way in APL</a
            >
          </h3>
          <section>
            <h4>
              <span>2023-04-01 @ 03:10:56</span
              ><span class="points-container"
                >Points: <span class="points">44</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=35396696"
                  >Comments</a
                ><span class="descendants">: 3</span></span
              >
            </h4>
          </section>
        </section>
        <section id="35396165">
          <h3>
            <a class="item" href="https://sharegpt.com/c/ICZsSl7"
              >ChatGPT simulates 1987 BBS System</a
            >
          </h3>
          <section>
            <h4>
              <span>2023-04-01 @ 01:40:41</span
              ><span class="points-container"
                >Points: <span class="points">98</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=35396165"
                  >Comments</a
                ><span class="descendants">: 47</span></span
              >
            </h4>
          </section>
        </section>
        <section id="35395085">
          <h3>
            <a
              class="item"
              href="https://eukaryotewritesblog.com/2017/06/30/book-review-barriers/"
              >Book review: Barriers to Bioweapons</a
            >
          </h3>
          <section>
            <h4>
              <span>2023-03-31 @ 23:18:18</span
              ><span class="points-container"
                >Points: <span class="points">43</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=35395085"
                  >Comments</a
                ><span class="descendants">: 7</span></span
              >
            </h4>
          </section>
        </section>
        <section id="35394758">
          <h3>
            <a class="item" href="https://digicamfinder.com/"
              >Show HN: DigicamFinder – open-sourced DPReview camera data</a
            >
          </h3>
          <section>
            <h4>
              <span>2023-03-31 @ 22:42:57</span
              ><span class="points-container"
                >Points: <span class="points">108</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=35394758"
                  >Comments</a
                ><span class="descendants">: 15</span></span
              >
            </h4>
            <div class="text">
              <a href="https://news.ycombinator.com/item?id=35248296"
                >https://news.ycombinator.com/item?id=35248296</a
              >
              we were thinking how to preserve the 25 years of valuable DPReview
              camera data. Archive.org has been great, but it's not usable by
              the general public.
              <p>
                The best way to keep it safe going forward, is to have the
                community own it, so we open sourced it:
                <a href="https://github.com/open-product-data/digital-cameras"
                  >https://github.com/open-product-data/digital-cameras</a
                >
              </p>
              <p>
                I'm aware of a number of attempts to make product data
                open-sourced, but none have the power of the photo geeks behind
                it :)
              </p>
              <p>
                Thoughts or ideas? + really looking for some contribution love.
              </p>
            </div>
          </section>
        </section>
        <section id="35394297">
          <h3>
            <a class="item" href="https://www.youtube.com/watch?v=dgd88zE3O38"
              >Asahi Linux M1 GPU drivers can now run Windows games via Steam
              Proton</a
            >
          </h3>
          <section>
            <h4>
              <span>2023-03-31 @ 22:04:37</span
              ><span class="points-container"
                >Points: <span class="points">171</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=35394297"
                  >Comments</a
                ><span class="descendants">: 74</span></span
              >
            </h4>
          </section>
        </section>
        <section id="35393579">
          <h3>
            <a class="item" href="https://www.tesorio.com/careers#job-openings"
              >Tesorio Is Hiring Head of Data Science, Senior DevOps and Senior
              Be Engineer</a
            >
          </h3>
          <section>
            <h4>
              <span>2023-03-31 @ 21:00:03</span
              ><span class="points-container"
                >Points: <span class="points">1</span></span
              >
            </h4>
          </section>
        </section>
        <section id="35393458">
          <h3>
            <a
              class="item"
              href="https://www.cbsnews.com/pittsburgh/news/cdc-team-sick-east-palestine-ohio-train-derailment/"
              >CDC team studying East Palestine train derailment fell ill during
              investigation</a
            >
          </h3>
          <section>
            <h4>
              <span>2023-03-31 @ 20:50:39</span
              ><span class="points-container"
                >Points: <span class="points">366</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=35393458"
                  >Comments</a
                ><span class="descendants">: 113</span></span
              >
            </h4>
          </section>
        </section>
        <section id="35393284">
          <h3>
            <a
              class="item"
              href="https://github.com/ggerganov/llama.cpp/pull/613"
              >Llama.cpp 30B runs with only 6GB of RAM now</a
            >
          </h3>
          <section>
            <h4>
              <span>2023-03-31 @ 20:37:50</span
              ><span class="points-container"
                >Points: <span class="points">918</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=35393284"
                  >Comments</a
                ><span class="descendants">: 240</span></span
              >
            </h4>
          </section>
        </section>
        <section id="35391868">
          <h3>
            <a
              class="item"
              href="https://twitter.com/jburnmurdoch/status/1641799698058035200"
              >The average American has the same life expectancy as the worst
              part of England</a
            >
          </h3>
          <section>
            <h4>
              <span>2023-03-31 @ 19:08:39</span
              ><span class="points-container"
                >Points: <span class="points">249</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=35391868"
                  >Comments</a
                ><span class="descendants">: 265</span></span
              >
            </h4>
          </section>
        </section>
        <section id="35391433">
          <h3>
            <a
              class="item"
              href="https://blog.twitter.com/engineering/en_us/topics/open-source/2023/twitter-recommendation-algorithm"
              >Twitter's Recommendation Algorithm</a
            >
          </h3>
          <section>
            <h4>
              <span>2023-03-31 @ 18:42:16</span
              ><span class="points-container"
                >Points: <span class="points">1220</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=35391433"
                  >Comments</a
                ><span class="descendants">: 848</span></span
              >
            </h4>
          </section>
        </section>
        <section id="35391370">
          <h3>
            <a
              class="item"
              href="https://krebsonsecurity.com/2023/03/german-police-raid-ddos-friendly-host-flyhosting/"
              >German police raid DDoS-friendly host FlyHosting</a
            >
          </h3>
          <section>
            <h4>
              <span>2023-03-31 @ 18:37:44</span
              ><span class="points-container"
                >Points: <span class="points">161</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=35391370"
                  >Comments</a
                ><span class="descendants">: 27</span></span
              >
            </h4>
          </section>
        </section>
        <section id="35391115">
          <h3>
            <a
              class="item"
              href="https://simonwillison.net/2023/Mar/17/beat-chatgpt-in-a-browser/"
              >Could you train a ChatGPT-beating model for $85k and run it in a
              browser?</a
            >
          </h3>
          <section>
            <h4>
              <span>2023-03-31 @ 18:21:07</span
              ><span class="points-container"
                >Points: <span class="points">380</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=35391115"
                  >Comments</a
                ><span class="descendants">: 161</span></span
              >
            </h4>
          </section>
        </section>
        <section id="35390853">
          <h3>
            <a
              class="item"
              href="https://electrek.co/2023/03/31/heat-pump-sales-2022/"
              >Heat pump sales outpaced gas furnace sales in the US in 2022</a
            >
          </h3>
          <section>
            <h4>
              <span>2023-03-31 @ 18:07:04</span
              ><span class="points-container"
                >Points: <span class="points">295</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=35390853"
                  >Comments</a
                ><span class="descendants">: 186</span></span
              >
            </h4>
          </section>
        </section>
        <section id="35390153">
          <h3>
            <a class="item" href="https://arxiv.org/abs/2303.17580"
              >HuggingGPT: Solving AI tasks with ChatGPT and its friends in
              HuggingFace</a
            >
          </h3>
          <section>
            <h4>
              <span>2023-03-31 @ 17:22:19</span
              ><span class="points-container"
                >Points: <span class="points">173</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=35390153"
                  >Comments</a
                ><span class="descendants">: 176</span></span
              >
            </h4>
          </section>
        </section>
        <section id="35389566">
          <h3>
            <a
              class="item"
              href="https://www.nytimes.com/2023/03/31/technology/facial-recognition-false-arrests.html"
              >Police relied on Clearview AI and put the wrong person in jail</a
            >
          </h3>
          <section>
            <h4>
              <span>2023-03-31 @ 16:35:38</span
              ><span class="points-container"
                >Points: <span class="points">404</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=35389566"
                  >Comments</a
                ><span class="descendants">: 103</span></span
              >
            </h4>
          </section>
        </section>
        <section id="35389110">
          <h3>
            <a class="item" href="https://news.ycombinator.com/item?id=35389110"
              >Launch HN: Inri (YC W23) – Wealthfront for Investing in India</a
            >
          </h3>
          <section>
            <h4>
              <span>2023-03-31 @ 16:02:50</span
              ><span class="points-container"
                >Points: <span class="points">93</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=35389110"
                  >Comments</a
                ><span class="descendants">: 67</span></span
              >
            </h4>
            <div class="text">
              <a href="https://www.goinri.com/">https://www.goinri.com/</a>), an
              investment platform for Indian expats to diversify capital in
              India, without any taxation or repatriation hassles. Super excited
              to be launching on HN, the platform that I personally nerd on and
              has helped me discover some of my favorite products early.
              <p>
                My cofounder Hemant (@hemantgangolia) has been living in the US
                since 6 years and has tried multiple times to invest in India.
                He couldn't go ahead with the process because bank account
                opening was a challenge and the process after that wasn't clear.
                There is complexity around taxation, moving money back and a
                general lack of clarity on where to invest.
              </p>
              <p>
                Even though there are currently over 30 million Indian expats
                globally, there are no digital, full-service solutions offered
                for them specifically. US solutions focus only on US investments
                and Indian solutions focus only on Indian customers—this makes
                the India &lt;&gt; US belt underserved. Indian banks with
                overseas branches offer these services, but investors don’t
                trust these banks because of conflict of interest. There are
                other small players in the market but they expect customers to
                do their own service, which is not what customers want, based on
                our learnings.
              </p>
              <p>
                We found a lot of other Indian expats in the same situation as
                us - wanting to invest in India for financial and emotional
                reasons, but unable to do so easily or consistently. We wished a
                simple product existed to solve for this online. We couldn’t
                find one, so we built it.
              </p>
              <p>
                Inri is like Wealthfront for your India investments. It is a web
                platform that offers curated mutual fund portfolios and solves
                for all tax compliance and repatriation needs online. We have
                curated the funds based on performance, history and compliance
                based on your resident country, and funds are selected based on
                your risk preference, similarly to Wealthfront. We facilitate
                investments through central platforms like National Stock
                Exchange and show the holdings via a dashboard on the platform
                once the investments are done. Additionally, we do this while
                making tax compliance and repatriation easy.
              </p>
              <p>
                Just log in to the platform, upload your documents, approve the
                emails with details confirmation and you’re sorted. Currently,
                only people with a PAN card (Indian financial identity document)
                can invest.
              </p>
              <p>
                Our early customers are all people who have tried doing this
                before, but gave up because of all the hassle. The fact that
                they could get invested in just 2 days vs weeks for traditional
                alternatives was unheard of to them.
              </p>
              <p>
                We know this is a bit of a niche product for HN but we also know
                that there are quite a few Indian expats like us here, who could
                make use of it—and we hope it makes interesting enough reading
                for everybody else. We would love to get your feedback! Thank
                you!
              </p>
            </div>
          </section>
        </section>
        <section id="35386948">
          <h3>
            <a
              class="item"
              href="https://www.dylanpaulus.com/posts/postgres-is-a-graph-database/"
              >Postgres as a graph database</a
            >
          </h3>
          <section>
            <h4>
              <span>2023-03-31 @ 13:35:36</span
              ><span class="points-container"
                >Points: <span class="points">492</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=35386948"
                  >Comments</a
                ><span class="descendants">: 108</span></span
              >
            </h4>
          </section>
        </section>
        <section id="35385075">
          <h3>
            <a
              class="item"
              href="https://www.politico.eu/article/italian-privacy-regulator-bans-chatgpt/"
              >Italian privacy regulator bans ChatGPT</a
            >
          </h3>
          <section>
            <h4>
              <span>2023-03-31 @ 10:49:15</span
              ><span class="points-container"
                >Points: <span class="points">414</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=35385075"
                  >Comments</a
                ><span class="descendants">: 596</span></span
              >
            </h4>
          </section>
        </section>
        <section id="35383527">
          <h3>
            <a
              class="item"
              href="https://lifehacker.com/a-new-beginning-for-lifehacker-1850278940"
              >A New Beginning for LifeHacker</a
            >
          </h3>
          <section>
            <h4>
              <span>2023-03-31 @ 06:44:56</span
              ><span class="points-container"
                >Points: <span class="points">19</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=35383527"
                  >Comments</a
                ><span class="descendants">: 4</span></span
              >
            </h4>
          </section>
        </section>
        <section id="35383195">
          <h3>
            <a
              class="item"
              href="https://www.nature.com/articles/s41586-023-05754-w"
              >Entwined African and Asian genetic roots of medieval people of
              the Swahili coast</a
            >
          </h3>
          <section>
            <h4>
              <span>2023-03-31 @ 06:00:56</span
              ><span class="points-container"
                >Points: <span class="points">45</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=35383195"
                  >Comments</a
                ><span class="descendants">: 20</span></span
              >
            </h4>
          </section>
        </section>
        <section id="35382614">
          <h3>
            <a class="item" href="https://atoptics.co.uk/fz694.htm"
              >Bouguer’s Halo</a
            >
          </h3>
          <section>
            <h4>
              <span>2023-03-31 @ 04:35:06</span
              ><span class="points-container"
                >Points: <span class="points">11</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=35382614"
                  >Comments</a
                ><span class="descendants">: 0</span></span
              >
            </h4>
          </section>
        </section>
        <section id="35382252">
          <h3>
            <a
              class="item"
              href="https://htwingnut.com/2022/09/11/ssd-as-long-term-storage-testing/"
              >SSD as Long Term Storage Testing</a
            >
          </h3>
          <section>
            <h4>
              <span>2023-03-31 @ 03:42:20</span
              ><span class="points-container"
                >Points: <span class="points">90</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=35382252"
                  >Comments</a
                ><span class="descendants">: 50</span></span
              >
            </h4>
          </section>
        </section>
        <section id="35380459">
          <h3>
            <a
              class="item"
              href="https://gist.github.com/chrispsn/3450fe6172a7cc441d0819379ed3a32a"
              >K: We need to talk about group</a
            >
          </h3>
          <section>
            <h4>
              <span>2023-03-30 @ 23:48:20</span
              ><span class="points-container"
                >Points: <span class="points">80</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=35380459"
                  >Comments</a
                ><span class="descendants">: 67</span></span
              >
            </h4>
          </section>
        </section>
        <section id="35378771">
          <h3>
            <a
              class="item"
              href="https://lifeofaudrey.com/2018/07/03/osbridge.html"
              >Saying Goodbye to Open Source Bridge (2018)</a
            >
          </h3>
          <section>
            <h4>
              <span>2023-03-30 @ 21:01:12</span
              ><span class="points-container"
                >Points: <span class="points">14</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=35378771"
                  >Comments</a
                ><span class="descendants">: 2</span></span
              >
            </h4>
          </section>
        </section>
        <section id="35378109">
          <h3>
            <a class="item" href="https://iliana.fyi/blog/acropalypse-now/"
              >The undocumented Android change that led to aCropalypse was
              reported during beta</a
            >
          </h3>
          <section>
            <h4>
              <span>2023-03-30 @ 20:01:15</span
              ><span class="points-container"
                >Points: <span class="points">232</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=35378109"
                  >Comments</a
                ><span class="descendants">: 60</span></span
              >
            </h4>
          </section>
        </section>
        <section id="35376863">
          <h3>
            <a
              class="item"
              href="https://arstechnica.com/gaming/2023/03/my-quest-to-recreate-street-fighters-long-lost-pneumatic-controls/"
              >My quest to re-create Street Fighter’s long-lost pneumatic
              controls</a
            >
          </h3>
          <section>
            <h4>
              <span>2023-03-30 @ 18:13:43</span
              ><span class="points-container"
                >Points: <span class="points">160</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=35376863"
                  >Comments</a
                ><span class="descendants">: 16</span></span
              >
            </h4>
          </section>
        </section>
        <section id="35369312">
          <h3>
            <a
              class="item"
              href="https://thehustle.co/how-the-inventor-of-the-troll-doll-missed-out-on-a-fortune/"
              >The inventor of the troll doll only made a sliver of the
              proceeds</a
            >
          </h3>
          <section>
            <h4>
              <span>2023-03-30 @ 07:30:51</span
              ><span class="points-container"
                >Points: <span class="points">41</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=35369312"
                  >Comments</a
                ><span class="descendants">: 21</span></span
              >
            </h4>
          </section>
        </section>
      </section>
      <section id="archives">
        <h2>
          <a
            href="https://github.com/kherrick/hacker-news/blob/main/archives/index.md"
            >Archives</a
          >
        </h2>
        <section>
          <h3>
            <a
              href="https://github.com/kherrick/hacker-news/blob/main/archives/2023/index.md"
              >2023</a
            >
          </h3>
        </section>
        <section>
          <h3>
            <a
              href="https://github.com/kherrick/hacker-news/blob/main/archives/2022/index.md"
              >2022</a
            >
          </h3>
        </section>
      </section>
    </main>
    <script type="module">
      import { buildDescendants } from "./lib/build-html-descendants.js";
      import { buildNextItem } from "./lib/build-html-next-item.js";
      import { getNextDateTime } from "./lib/date-time.js";

      const updateSectionById = (id) =>
        fetch(`https://hacker-news.firebaseio.com/v0/item/${id}.json`).then(
          (result) =>
            result.json().then(({ descendants, id, score, text, type }) => {
              const currentItem = document.getElementById(id);

              if (score) {
                currentItem.querySelector(".points").textContent = score;
              }

              if (descendants && (type === "poll" || type === "story")) {
                const currentDescendants =
                  currentItem.querySelector(".descendants");

                if (currentDescendants) {
                  currentDescendants.textContent = `: ${descendants}`;
                } else {
                  const comments = buildDescendants(
                    document,
                    descendants,
                    `https://news.ycombinator.com/item?id=${id}`
                  );

                  currentItem.querySelector("h4").appendChild(comments);
                }
              }

              if (text) {
                const currentText = currentItem.querySelector(".text");

                if (currentText) {
                  currentText.innerHTML = text.replace(/\0/g, "");
                } else {
                  const content = document.createElement("div");
                  content.innerHTML = text.replace(/\0/g, "");
                  content.setAttribute("class", "text");

                  currentItem.appendChild(content);
                }
              }
            })
        );

      class UpdateQueue {
        constructor() {
          this._ids = [];
          this._isUpdating = false;
        }

        addItemById(id) {
          this._ids.push(id);
        }

        async flush() {
          const id = this._ids.shift();

          if (id) {
            this._isUpdating = true;

            await updateSectionById(id);
            await this.flush();
          } else {
            this._isUpdating = false;

            setTimeout(async () => {
              if (!this._isUpdating && this._ids && this._ids.length) {
                await this.flush();
              }
            }, 0);
          }
        }
      }

      // get latest data
      const latestSection = document.getElementById("latest");

      for (let item of latestSection.querySelectorAll("section[id]")) {
        updateSectionById(item.getAttribute("id"));
      }

      if ("IntersectionObserver" in window) {
        window.hackerNewsState = { index: [], nextTimeIndex: -1 };

        const addNewsItem = async (newsItem, queue) => {
          try {
            const { date, time, itemComments, itemTitle, itemLink } = newsItem;
            const section = await buildNextItem({
              document,
              dateTime: `${date}, ${time}`,
              itemComments,
              itemLink,
              itemTitle: new DOMParser().parseFromString(
                itemTitle.replace(/\\/g, ""),
                "text/html"
              ).documentElement.textContent,
              fetchItemDetails: false,
            });

            // display loading indicator for section
            section.querySelector(".points-container").innerHTML =
              'Points: <span class="points"><img style="height: 100%;" src="lib/images/loading.svg" /></span>';

            const id = section.getAttribute("id");
            if (!document.getElementById(id)) {
              document.getElementById("latest").appendChild(section);

              queue.addItemById(id);
            }
          } catch (error) {}
        };

        const buildArchiveIndex = async (lastDateTime) => {
          const nextDate = lastDateTime.slice(0, 10);
          const nextYear = nextDate.slice(0, 4);

          return (
            await (
              await fetch(
                `https://raw.githubusercontent.com/kherrick/hacker-news/main/archives/${nextYear}/${nextDate}/index.md`
              )
            ).text()
          )
            .split("\n")
            .filter((line) => line.match(new RegExp("^\\* \\[")))
            .map((line) => {
              const segment = line.replace("* ", "").split("](");
              const pubDate = segment[0].slice(1);

              const itemComments = segment[1].split(") - [")[0];
              const itemTitle = segment[1].split(") - [")[1];
              const itemLink = segment[2].slice(0, -1);
              const date = pubDate.slice(0, 10);
              const time = pubDate.slice(-8);

              return {
                date,
                itemComments,
                itemLink,
                itemTitle,
                time,
              };
            });
        };

        const handleIntersectingEntry = async (entry, queue) => {
          if (entry.isIntersecting) {
            const lastDateTime = document
              .getElementById("latest")
              .querySelector(
                "section:last-child > section > h4 > span"
              ).textContent;

            const nextDateTime = getNextDateTime(lastDateTime ?? "", -1);
            const archiveIndex = await buildArchiveIndex(nextDateTime);
            const nextTimeIndex = archiveIndex.findIndex(
              ({ time }) => time === nextDateTime.slice(-8)
            );

            const handleIndexUpdate = (index, existingIndexValues = []) => {
              index.forEach((i) => {
                existingIndexValues.push(i);
              });
              return existingIndexValues;
            };

            window.hackerNewsState = {
              index: handleIndexUpdate(
                archiveIndex,
                window.hackerNewsState.index
              ),
              nextTimeIndex,
            };

            let currentTimeIndex = nextTimeIndex + 1;
            const items = Object.values(window.hackerNewsState.index);
            for (let item of items) {
              if (currentTimeIndex < window.hackerNewsState.index.length) {
                addNewsItem(items[currentTimeIndex], queue);

                currentTimeIndex = currentTimeIndex + 1;
              }
            }

            queue.flush();
          }
        };

        const archives = document.getElementById("archives");
        const archivesObserver = new IntersectionObserver(
          (entries) => {
            const queue = new UpdateQueue();

            entries.forEach((entry) => handleIntersectingEntry(entry, queue));
          },
          {
            root: null,
            rootMargin: "0px",
            threshold: 0,
          }
        );

        archivesObserver.observe(archives);

        let latestSectionsExpanded = true;
        const handleLatestHeaderClick = () => {
          latestSectionsExpanded = !latestSectionsExpanded;

          if (latestSectionsExpanded) {
            archivesObserver.observe(archives);
          } else {
            archivesObserver.disconnect(archives);
          }

          for (let section of document.querySelectorAll("#latest > section")) {
            section.style.display = latestSectionsExpanded ? "block" : "none";
          }
        };

        const latestHeader = document.querySelector("#latest > h2");
        latestHeader.style.cursor = "pointer";
        latestHeader.addEventListener("click", handleLatestHeaderClick);
      }
    </script>
    <script type="module">
      import { Workbox } from "https://storage.googleapis.com/workbox-cdn/releases/6.4.1/workbox-window.prod.mjs";

      if ("serviceWorker" in navigator) {
        const base = document.querySelector("base");
        const serviceWorkerPath = `${
          base ? base.href.replace(/\/$/, "") : ""
        }/service-worker.js`;

        const wb = new Workbox(serviceWorkerPath);

        // setup event listeners
        wb.addEventListener("waiting", (event) => {
          wb.addEventListener("controlling", () => {
            window.location.reload();
          });

          wb.messageSkipWaiting();
        });

        wb.register();
      }
    </script>
  </body>
</html>
