<!DOCTYPE html>
<html lang="en" xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta charset="utf-8" />
    <meta
      content="width=device-width, initial-scale=1.0, viewport-fit=cover"
      name="viewport"
    />
    <meta name="description" content="Hacker News" />
    <meta name="theme-color" content="#fff" />
    <title>Hacker News</title>
    <link rel="manifest" href="manifest.json" />
    <link
      href="data:image/x-icon;base64,AAABAAEAAQECAAEAAQA4AAAAFgAAACgAAAABAAAAAgAAAAEAAQAAAAAAAAAAAAAAAAAAAAAAAAAAAAABAAEAAQECAAEAAQA4AAAAFgAAACgAAAABAAAAAgAAAAEAAQAAAAAAAAAAAAAAAAAAAAAAAAAA"
      rel="icon"
      type="image/x-icon"
    />
    <link
      href="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAgAAAAIAAQMAAADOtka5AAAAA1BMVEUAAACnej3aAAAANklEQVR42u3BAQEAAACCIP+vbkhAAQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAB8G4IAAAFjdVCkAAAAAElFTkSuQmCC"
      rel="apple-touch-icon"
    />
    <style>
      /*<!--*/
      body {
        color: rgb(25, 25, 25);
        font-family: Verdana, Geneva, sans-serif;
        margin: 0;
      }

      a {
        text-decoration: none;
      }

      a:link,
      a:focus,
      a:hover,
      a:active {
        color: rgb(75, 75, 125);
      }

      a:visited {
        color: rgb(25, 25, 25);
      }

      h1 > a,
      h1 > a:link,
      h1 > a:focus,
      h1 > a:hover,
      h1 > a:active,
      h1 > a:visited,
      h2 > a,
      h2 > a:link,
      h2 > a:focus,
      h2 > a:hover,
      h2 > a:active,
      h2 > a:visited {
        color: rgb(25, 25, 25);
      }

      h1 {
        background-color: rgb(255, 102, 0);
        margin: 0;
        padding: 1rem;
      }

      h2 {
        background-color: rgb(200, 200, 200);
        margin: 1rem 0;
        padding: 0.5rem 0.5rem 0.5rem 1rem;
      }

      #latest > section,
      #archives > section {
        margin: 0 1rem 1rem 1rem;
        padding-bottom: 1rem;
      }

      #latest > section:not(:last-child),
      #archives > section:not(:last-child) {
        border-bottom: 1px dotted rgb(200, 200, 200);
      }

      section > h3 {
        margin: 0 0 0.5rem 0;
      }

      section > h4 {
        font-weight: normal;
        margin: 0 0 0 1rem;
      }

      .descendants-container,
      .points-container {
        align-items: center;
        border-left: 1px solid #333;
        display: inline-flex;
        margin-left: 0.5rem;
        padding-left: 0.5rem;
        text-align: center;
      }

      .points {
        align-items: center;
        display: inline-flex;
        height: 1rem;
        margin-left: 1ch;
        min-width: 3ch;
      }

      .text {
        line-height: 1.5rem;
        margin: 1rem 1rem 0 1rem;
        overflow: auto;
      }

      .text > p:first-child {
        margin-top: 1rem;
      }

      .text > p:last-child {
        margin-bottom: 0;
      }
      /*-->*/
    </style>
  </head>

  <body>
    <main>
      <h1><a href="https://kherrick.github.io/hacker-news/">Hacker News</a></h1>
      <section id="latest">
        <h2>Latest</h2>
        <section id="41548767">
          <h3>
            <a class="item" href="https://www.youtube.com/watch?v=ehp23hrrEHY"
              >Turning Disposable Vapes into a Fast Charge Power Bank</a
            >
          </h3>
          <section>
            <h4>
              <span>2024-09-15 @ 17:15:31</span
              ><span class="points-container"
                >Points: <span class="points">4</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=41548767"
                  >Comments</a
                ><span class="descendants">: 0</span></span
              >
            </h4>
          </section>
        </section>
        <section id="41548663">
          <h3>
            <a
              class="item"
              href="https://www.ycombinator.com/companies/continue/jobs/smcxRnM-software-engineer"
              >Continue (YC S23) Is Hiring a Software Engineer in San
              Francisco</a
            >
          </h3>
          <section>
            <h4>
              <span>2024-09-15 @ 17:00:51</span
              ><span class="points-container"
                >Points: <span class="points">1</span></span
              >
            </h4>
          </section>
        </section>
        <section id="41548601">
          <h3>
            <a
              class="item"
              href="https://www.gq.com/story/how-to-make-millions-as-a-professional-whistleblower"
              >How to Make Millions as a Professional Whistleblower</a
            >
          </h3>
          <section>
            <h4>
              <span>2024-09-15 @ 16:53:01</span
              ><span class="points-container"
                >Points: <span class="points">6</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=41548601"
                  >Comments</a
                ><span class="descendants">: 0</span></span
              >
            </h4>
          </section>
        </section>
        <section id="41548515">
          <h3>
            <a
              class="item"
              href="https://arstechnica.com/cars/2024/09/human-drivers-are-to-blame-for-most-serious-waymo-collisions/"
              >Human drivers keep rear-ending Waymos</a
            >
          </h3>
          <section>
            <h4>
              <span>2024-09-15 @ 16:39:48</span
              ><span class="points-container"
                >Points: <span class="points">27</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=41548515"
                  >Comments</a
                ><span class="descendants">: 19</span></span
              >
            </h4>
          </section>
        </section>
        <section id="41548474">
          <h3>
            <a class="item" href="https://lwn.net/Articles/990307/"
              >Linux 6.11 Released</a
            >
          </h3>
          <section>
            <h4>
              <span>2024-09-15 @ 16:33:47</span
              ><span class="points-container"
                >Points: <span class="points">58</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=41548474"
                  >Comments</a
                ><span class="descendants">: 6</span></span
              >
            </h4>
          </section>
        </section>
        <section id="41548016">
          <h3>
            <a
              class="item"
              href="https://www.freyaindia.co.uk/p/our-new-religion-isnt-enough"
              >Our New Religion Isn't Enough</a
            >
          </h3>
          <section>
            <h4>
              <span>2024-09-15 @ 15:22:27</span
              ><span class="points-container"
                >Points: <span class="points">17</span></span
              >
            </h4>
          </section>
        </section>
        <section id="41547899">
          <h3>
            <a
              class="item"
              href="https://datatracker.ietf.org/doc/draft-ietf-httpbis-compression-dictionary/"
              >Compression Dictionary Transport</a
            >
          </h3>
          <section>
            <h4>
              <span>2024-09-15 @ 15:02:26</span
              ><span class="points-container"
                >Points: <span class="points">39</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=41547899"
                  >Comments</a
                ><span class="descendants">: 14</span></span
              >
            </h4>
          </section>
        </section>
        <section id="41547841">
          <h3>
            <a
              class="item"
              href="https://blog.codesolvent.com/2024/09/declarative-programming-with-aillms.html"
              >Declarative Programming with AI/LLMs</a
            >
          </h3>
          <section>
            <h4>
              <span>2024-09-15 @ 14:54:18</span
              ><span class="points-container"
                >Points: <span class="points">36</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=41547841"
                  >Comments</a
                ><span class="descendants">: 16</span></span
              >
            </h4>
          </section>
        </section>
        <section id="41547816">
          <h3>
            <a
              class="item"
              href="https://bytepawn.com/randomness-extractors-making-fair-coins-out-of-biased-coins.html"
              >Randomness extractors: making fair coins out of biased coins</a
            >
          </h3>
          <section>
            <h4>
              <span>2024-09-15 @ 14:50:13</span
              ><span class="points-container"
                >Points: <span class="points">25</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=41547816"
                  >Comments</a
                ><span class="descendants">: 2</span></span
              >
            </h4>
          </section>
        </section>
        <section id="41547773">
          <h3>
            <a
              class="item"
              href="https://www.honest-broker.com/p/the-death-of-the-magazine"
              >The Death of the Magazine</a
            >
          </h3>
          <section>
            <h4>
              <span>2024-09-15 @ 14:44:29</span
              ><span class="points-container"
                >Points: <span class="points">38</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=41547773"
                  >Comments</a
                ><span class="descendants">: 39</span></span
              >
            </h4>
          </section>
        </section>
        <section id="41547405">
          <h3>
            <a
              class="item"
              href="https://github.com/TzuHuanTai/RaspberryPi_WebRTC"
              >Open Source security camera on Raspberry Pi</a
            >
          </h3>
          <section>
            <h4>
              <span>2024-09-15 @ 13:32:37</span
              ><span class="points-container"
                >Points: <span class="points">54</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=41547405"
                  >Comments</a
                ><span class="descendants">: 8</span></span
              >
            </h4>
          </section>
        </section>
        <section id="41546769">
          <h3>
            <a class="item" href="https://learngitbranching.js.org/"
              >Learn Git Branching</a
            >
          </h3>
          <section>
            <h4>
              <span>2024-09-15 @ 11:14:41</span
              ><span class="points-container"
                >Points: <span class="points">56</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=41546769"
                  >Comments</a
                ><span class="descendants">: 11</span></span
              >
            </h4>
          </section>
        </section>
        <section id="41546032">
          <h3>
            <a
              class="item"
              href="https://coralogix.com/blog/mastering-null-semantics-translating-sql-expressions-to-opensearch-dsl/"
              >Mastering Null Semantics: Translating SQL Expressions to
              OpenSearch DSL</a
            >
          </h3>
          <section>
            <h4>
              <span>2024-09-15 @ 08:07:21</span
              ><span class="points-container"
                >Points: <span class="points">29</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=41546032"
                  >Comments</a
                ><span class="descendants">: 5</span></span
              >
            </h4>
          </section>
        </section>
        <section id="41546015">
          <h3>
            <a
              class="item"
              href="https://thechipletter.substack.com/p/at-and-ts-crisp-hobbits"
              >AT&amp;amp;T's Hobbit Microprocessor (2023)</a
            >
          </h3>
          <section>
            <h4>
              <span>2024-09-15 @ 08:04:02</span
              ><span class="points-container"
                >Points: <span class="points">71</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=41546015"
                  >Comments</a
                ><span class="descendants">: 21</span></span
              >
            </h4>
          </section>
        </section>
        <section id="41545737">
          <h3>
            <a class="item" href="https://github.com/glzr-io/glazewm"
              >i3wm inspired wm for Windows</a
            >
          </h3>
          <section>
            <h4>
              <span>2024-09-15 @ 06:52:11</span
              ><span class="points-container"
                >Points: <span class="points">58</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=41545737"
                  >Comments</a
                ><span class="descendants">: 12</span></span
              >
            </h4>
          </section>
        </section>
        <section id="41545100">
          <h3>
            <a class="item" href="https://www.implicitcad.org/"
              >Powerful, Open-Source, Programmatic CAD</a
            >
          </h3>
          <section>
            <h4>
              <span>2024-09-15 @ 04:02:10</span
              ><span class="points-container"
                >Points: <span class="points">86</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=41545100"
                  >Comments</a
                ><span class="descendants">: 10</span></span
              >
            </h4>
          </section>
        </section>
        <section id="41544969">
          <h3>
            <a class="item" href="https://github.com/dleemiller/WordLlama"
              >Show HN: Wordllama – Things you can do with the token embeddings
              of an LLM</a
            >
          </h3>
          <section>
            <h4>
              <span>2024-09-15 @ 03:25:14</span
              ><span class="points-container"
                >Points: <span class="points">281</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=41544969"
                  >Comments</a
                ><span class="descendants">: 21</span></span
              >
            </h4>
            <div class="text">
              <i>semantically</i>. You don’t need to install pytorch to use it,
              or any deep learning runtimes.
              <p>
                How can this be accomplished? The model is simply token
                embeddings that are average pooled. To create this model, I
                extracted token embedding (nn.Embedding) vectors from LLMs,
                concatenated them along the embedding dimension, added a
                learnable weight parameter, and projected them to a smaller
                dimension. Using the sentence transformers framework and
                datasets, I trained the pooled embedding with multiple negatives
                ranking loss and matryoshka representation learning so they can
                be truncated. After training, the weights and projections are no
                longer needed, because there is no contextual calculations. I
                inference the entire token vocabulary and save the new token
                embeddings to be loaded to numpy.
              </p>
              <p>
                While the results are not impressive compared to transformer
                models, they perform well on MTEB benchmarks compared to word
                embedding models (which they are most similar to), while being
                much smaller in size (smallest model, 32k vocab, 64-dim is only
                4MB).
              </p>
              <p>
                On the utility side, I’ve been adding some tools that I think
                it’ll be useful for. In addition to general embedding, there’s
                algorithms for ranking, filtering, clustering, deduplicating and
                similarity. Some of them have a cython implementation, and I’m
                continuing to work on benchmarking them and improving them as I
                have time. In addition to “standard” models that use cosine
                similarity for some algorithms, there are binarized models that
                use hamming distance. This is a slightly faster, similarity
                algorithm, with significantly less memory per embedding (float32
                -&gt; 1 bit).
              </p>
              <p>
                Hope you enjoy it, and find it useful. PS I haven’t figured out
                Windows builds yet, but Linux and Mac are supported.
              </p>
            </div>
          </section>
        </section>
        <section id="41544386">
          <h3>
            <a class="item" href="https://cs.pomona.edu/classes/cs181g/"
              >CSCI 181G PO: Game Engine Programming</a
            >
          </h3>
          <section>
            <h4>
              <span>2024-09-15 @ 01:14:32</span
              ><span class="points-container"
                >Points: <span class="points">99</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=41544386"
                  >Comments</a
                ><span class="descendants">: 14</span></span
              >
            </h4>
          </section>
        </section>
        <section id="41544364">
          <h3>
            <a
              class="item"
              href="https://zachxbt.mirror.xyz/B0-UJtxN41cJhpPtKv0v2LZ8u-0PwZ4ecMPEdX4l8vE"
              >Lazarus Group laundered $200M from 25 crypto hacks to fiat</a
            >
          </h3>
          <section>
            <h4>
              <span>2024-09-15 @ 01:09:25</span
              ><span class="points-container"
                >Points: <span class="points">237</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=41544364"
                  >Comments</a
                ><span class="descendants">: 163</span></span
              >
            </h4>
          </section>
        </section>
        <section id="41543642">
          <h3>
            <a
              class="item"
              href="https://github.com/lets-all-be-stupid-forever/circuit-artist"
              >Show HN: I made a digital circuit drawing and simulation game</a
            >
          </h3>
          <section>
            <h4>
              <span>2024-09-14 @ 22:43:51</span
              ><span class="points-container"
                >Points: <span class="points">83</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=41543642"
                  >Comments</a
                ><span class="descendants">: 6</span></span
              >
            </h4>
            <div class="text">
              <p>
                The circuit is just an image. The primitives are (i) connected
                wires which have undefined, 0 or 1 state during simulation
                (displayed brighter or darker in function of the state) and (ii)
                NANDs, which are little pixel triangles. During simulation the
                user can interact with any wire by clicking on it, toggling its
                state, which is cool for messing around when learning. The
                simulation uses a unit-delay event driven algorithm.
              </p>
              <p>
                Then, on top of that there are little wire interfaces on the
                left side of the image that communicate with an external system.
                This external system is defined in lua and is simulated together
                with the main circuit (they alternate until convergence). By
                default there's a sandbox mode with a clock and a power-on-reset
                signal. The user can choose other "levels", where the API change
                and there are some problems to solve, from finding if a number
                is multiple of 3 to solving hanoi tower to finding if a number
                is prime. The idea is that if the user want to learn but not
                sure what to do they can try to solve these puzzles, or they can
                change the lua scripts to add their own stuff/interface for a
                custom project.
              </p>
              <p>
                I've also included a small wiki (circuitopedia) with some basic
                digital concepts to guide those who are new or are a bit rusty.
                It's not super detailed but I guess it can at the very least
                present the concepts so the user can dig further on more serious
                material if they want to.
              </p>
              <p>
                I developed the game in C with raylib, with scripting in
                lua/luajit. I've put the game on steam (for windows) and
                released the source code on github under GPLv3. There's also a
                web demo version on itch.io, even though it's a bit laggy:
                <a
                  href="https://lets-all-be-stupid-foreva.itch.io/circuit-artist-demo"
                  >https://lets-all-be-stupid-foreva.itch.io/circuit-artist-dem...</a
                >
                .
              </p>
              <p>Feedback is appreciated!</p>
            </div>
          </section>
        </section>
        <section id="41543386">
          <h3>
            <a class="item" href="https://openscad.org/"
              >OpenSCAD: The Programmer's Solid 3D CAD Modeller</a
            >
          </h3>
          <section>
            <h4>
              <span>2024-09-14 @ 22:02:14</span
              ><span class="points-container"
                >Points: <span class="points">402</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=41543386"
                  >Comments</a
                ><span class="descendants">: 152</span></span
              >
            </h4>
          </section>
        </section>
        <section id="41541459">
          <h3>
            <a class="item" href="https://bofh.bjash.com/"
              >The Bastard Operator from Hell (1999)</a
            >
          </h3>
          <section>
            <h4>
              <span>2024-09-14 @ 17:46:42</span
              ><span class="points-container"
                >Points: <span class="points">232</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=41541459"
                  >Comments</a
                ><span class="descendants">: 78</span></span
              >
            </h4>
          </section>
        </section>
        <section id="41540950">
          <h3>
            <a
              class="item"
              href="https://www.science.org/content/article/one-five-genetics-papers-contains-errors-thanks-microsoft-excel"
              >One in five genetics papers contains errors thanks to Excel
              (2016)</a
            >
          </h3>
          <section>
            <h4>
              <span>2024-09-14 @ 16:49:10</span
              ><span class="points-container"
                >Points: <span class="points">355</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=41540950"
                  >Comments</a
                ><span class="descendants">: 222</span></span
              >
            </h4>
          </section>
        </section>
        <section id="41530571">
          <h3>
            <a
              class="item"
              href="https://newatlas.com/technology/throwable-tactical-camera-panoramic-thermal-images/"
              >Throwable tactical camera transmits 360° panoramic thermal
              images</a
            >
          </h3>
          <section>
            <h4>
              <span>2024-09-13 @ 12:27:52</span
              ><span class="points-container"
                >Points: <span class="points">39</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=41530571"
                  >Comments</a
                ><span class="descendants">: 21</span></span
              >
            </h4>
          </section>
        </section>
        <section id="41529129">
          <h3>
            <a
              class="item"
              href="https://blog.moontower.ai/jensens-inequality-as-an-intuition-tool/"
              >Jensen's Inequality as an Intuition Tool</a
            >
          </h3>
          <section>
            <h4>
              <span>2024-09-13 @ 08:21:36</span
              ><span class="points-container"
                >Points: <span class="points">16</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=41529129"
                  >Comments</a
                ><span class="descendants">: 3</span></span
              >
            </h4>
          </section>
        </section>
        <section id="41520950">
          <h3>
            <a
              class="item"
              href="https://blog.fantasticgardenersmelbourne.com.au/art-of-niwaki/"
              >The art of niwaki (Japanese tree pruning) (2017)</a
            >
          </h3>
          <section>
            <h4>
              <span>2024-09-12 @ 13:49:12</span
              ><span class="points-container"
                >Points: <span class="points">55</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=41520950"
                  >Comments</a
                ><span class="descendants">: 7</span></span
              >
            </h4>
          </section>
        </section>
        <section id="41520620">
          <h3>
            <a
              class="item"
              href="https://gizmodo.com/these-hi-tech-bifocals-improved-my-eyesight-despite-making-me-look-dorky-2000496406"
              >Hi-Tech Bifocals Improved My Eyesight but Made Me Look Like a
              Dork</a
            >
          </h3>
          <section>
            <h4>
              <span>2024-09-12 @ 13:21:33</span
              ><span class="points-container"
                >Points: <span class="points">22</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=41520620"
                  >Comments</a
                ><span class="descendants">: 6</span></span
              >
            </h4>
          </section>
        </section>
        <section id="41517059">
          <h3>
            <a
              class="item"
              href="https://svpow.com/2024/09/07/were-not-going-to-run-out-of-new-anatomy-anytime-soon/"
              >We're not going to run out of new anatomy anytime soon</a
            >
          </h3>
          <section>
            <h4>
              <span>2024-09-12 @ 02:35:45</span
              ><span class="points-container"
                >Points: <span class="points">133</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=41517059"
                  >Comments</a
                ><span class="descendants">: 67</span></span
              >
            </h4>
          </section>
        </section>
        <section id="41505528">
          <h3>
            <a
              class="item"
              href="http://schwitzsplinters.blogspot.com/2024/09/the-disunity-of-consciousness-in.html"
              >The disunity of consciousness in everyday experience</a
            >
          </h3>
          <section>
            <h4>
              <span>2024-09-10 @ 21:02:40</span
              ><span class="points-container"
                >Points: <span class="points">90</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=41505528"
                  >Comments</a
                ><span class="descendants">: 58</span></span
              >
            </h4>
          </section>
        </section>
        <section id="41501625">
          <h3>
            <a
              class="item"
              href="https://festina-lente-productions.com/articles/strtod-is-wild/"
              >Strtod Is Wild</a
            >
          </h3>
          <section>
            <h4>
              <span>2024-09-10 @ 15:16:35</span
              ><span class="points-container"
                >Points: <span class="points">49</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=41501625"
                  >Comments</a
                ><span class="descendants">: 13</span></span
              >
            </h4>
          </section>
        </section>
      </section>
      <section id="archives">
        <h2>
          <a
            href="https://github.com/kherrick/hacker-news/blob/main/archives/index.md"
            >Archives</a
          >
        </h2>
        <section>
          <h3>
            <a
              href="https://github.com/kherrick/hacker-news/blob/main/archives/2024/index.md"
              >2024</a
            >
          </h3>
        </section>
        <section>
          <h3>
            <a
              href="https://github.com/kherrick/hacker-news/blob/main/archives/2023/index.md"
              >2023</a
            >
          </h3>
        </section>
        <section>
          <h3>
            <a
              href="https://github.com/kherrick/hacker-news/blob/main/archives/2022/index.md"
              >2022</a
            >
          </h3>
        </section>
      </section>
    </main>
    <script type="module">
      import { buildDescendants } from "./lib/build-html-descendants.js";
      import { buildNextItem } from "./lib/build-html-next-item.js";
      import { getNextDateTime } from "./lib/date-time.js";

      const updateSectionById = (id) =>
        fetch(`https://hacker-news.firebaseio.com/v0/item/${id}.json`).then(
          (result) =>
            result.json().then(({ descendants, id, score, text, type }) => {
              const currentItem = document.getElementById(id);

              if (score) {
                currentItem.querySelector(".points").textContent = score;
              }

              if (descendants && (type === "poll" || type === "story")) {
                const currentDescendants =
                  currentItem.querySelector(".descendants");

                if (currentDescendants) {
                  currentDescendants.textContent = `: ${descendants}`;
                } else {
                  const comments = buildDescendants(
                    document,
                    descendants,
                    `https://news.ycombinator.com/item?id=${id}`
                  );

                  currentItem.querySelector("h4").appendChild(comments);
                }
              }

              if (text) {
                const currentText = currentItem.querySelector(".text");

                if (currentText) {
                  currentText.innerHTML = text.replace(/\0/g, "");
                } else {
                  const content = document.createElement("div");
                  content.innerHTML = text.replace(/\0/g, "");
                  content.setAttribute("class", "text");

                  currentItem.appendChild(content);
                }
              }
            })
        );

      class UpdateQueue {
        constructor() {
          this._ids = [];
          this._isUpdating = false;
        }

        addItemById(id) {
          this._ids.push(id);
        }

        async flush() {
          const id = this._ids.shift();

          if (id) {
            this._isUpdating = true;

            await updateSectionById(id);
            await this.flush();
          } else {
            this._isUpdating = false;

            setTimeout(async () => {
              if (!this._isUpdating && this._ids && this._ids.length) {
                await this.flush();
              }
            }, 0);
          }
        }
      }

      // get latest data
      const latestSection = document.getElementById("latest");

      for (let item of latestSection.querySelectorAll("section[id]")) {
        updateSectionById(item.getAttribute("id"));
      }

      if ("IntersectionObserver" in window) {
        window.hackerNewsState = { index: [], nextTimeIndex: -1 };

        const addNewsItem = async (newsItem, queue) => {
          try {
            const { date, time, itemComments, itemTitle, itemLink } = newsItem;
            const section = await buildNextItem({
              document,
              dateTime: `${date}, ${time}`,
              itemComments,
              itemLink,
              itemTitle: new DOMParser().parseFromString(
                itemTitle.replace(/\\/g, ""),
                "text/html"
              ).documentElement.textContent,
              fetchItemDetails: false,
            });

            // display loading indicator for section
            section.querySelector(".points-container").innerHTML =
              'Points: <span class="points"><img style="height: 100%;" src="lib/images/loading.svg" /></span>';

            const id = section.getAttribute("id");
            if (!document.getElementById(id)) {
              document.getElementById("latest").appendChild(section);

              queue.addItemById(id);
            }
          } catch (error) {}
        };

        const buildArchiveIndex = async (lastDateTime) => {
          const nextDate = lastDateTime.slice(0, 10);
          const nextYear = nextDate.slice(0, 4);

          return (
            await (
              await fetch(
                `https://raw.githubusercontent.com/kherrick/hacker-news/main/archives/${nextYear}/${nextDate}/index.md`
              )
            ).text()
          )
            .split("\n")
            .filter((line) => line.match(new RegExp("^\\* \\[")))
            .map((line) => {
              const segment = line.replace("* ", "").split("](");
              const pubDate = segment[0].slice(1);

              const itemComments = segment[1].split(") - [")[0];
              const itemTitle = segment[1].split(") - [")[1];
              const itemLink = segment[2].slice(0, -1);
              const date = pubDate.slice(0, 10);
              const time = pubDate.slice(-8);

              return {
                date,
                itemComments,
                itemLink,
                itemTitle,
                time,
              };
            });
        };

        const handleIntersectingEntry = async (entry, queue) => {
          if (entry.isIntersecting) {
            const lastDateTime = document
              .getElementById("latest")
              .querySelector(
                "section:last-child > section > h4 > span"
              ).textContent;

            const nextDateTime = getNextDateTime(lastDateTime ?? "", -1);
            const archiveIndex = await buildArchiveIndex(nextDateTime);
            const nextTimeIndex = archiveIndex.findIndex(
              ({ time }) => time === nextDateTime.slice(-8)
            );

            const handleIndexUpdate = (index, existingIndexValues = []) => {
              index.forEach((i) => {
                existingIndexValues.push(i);
              });
              return existingIndexValues;
            };

            window.hackerNewsState = {
              index: handleIndexUpdate(
                archiveIndex,
                window.hackerNewsState.index
              ),
              nextTimeIndex,
            };

            let currentTimeIndex = nextTimeIndex + 1;
            const items = Object.values(window.hackerNewsState.index);
            for (let item of items) {
              if (currentTimeIndex < window.hackerNewsState.index.length) {
                addNewsItem(items[currentTimeIndex], queue);

                currentTimeIndex = currentTimeIndex + 1;
              }
            }

            queue.flush();
          }
        };

        const archives = document.getElementById("archives");
        const archivesObserver = new IntersectionObserver(
          (entries) => {
            const queue = new UpdateQueue();

            entries.forEach((entry) => handleIntersectingEntry(entry, queue));
          },
          {
            root: null,
            rootMargin: "0px",
            threshold: 0,
          }
        );

        archivesObserver.observe(archives);

        let latestSectionsExpanded = true;
        const handleLatestHeaderClick = () => {
          latestSectionsExpanded = !latestSectionsExpanded;

          if (latestSectionsExpanded) {
            archivesObserver.observe(archives);
          } else {
            archivesObserver.disconnect(archives);
          }

          for (let section of document.querySelectorAll("#latest > section")) {
            section.style.display = latestSectionsExpanded ? "block" : "none";
          }
        };

        const latestHeader = document.querySelector("#latest > h2");
        latestHeader.style.cursor = "pointer";
        latestHeader.addEventListener("click", handleLatestHeaderClick);
      }
    </script>
    <script type="module">
      import { Workbox } from "https://storage.googleapis.com/workbox-cdn/releases/6.4.1/workbox-window.prod.mjs";

      if ("serviceWorker" in navigator) {
        const base = document.querySelector("base");
        const serviceWorkerPath = `${
          base ? base.href.replace(/\/$/, "") : ""
        }/service-worker.js`;

        const wb = new Workbox(serviceWorkerPath);

        // setup event listeners
        wb.addEventListener("waiting", (event) => {
          wb.addEventListener("controlling", () => {
            window.location.reload();
          });

          wb.messageSkipWaiting();
        });

        wb.register();
      }
    </script>
  </body>
</html>
