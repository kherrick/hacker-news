<!DOCTYPE html>
<html lang="en" xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta charset="utf-8" />
    <meta
      content="width=device-width, initial-scale=1.0, viewport-fit=cover"
      name="viewport"
    />
    <meta name="description" content="Hacker News" />
    <meta name="theme-color" content="#fff" />
    <title>Hacker News</title>
    <link rel="manifest" href="manifest.json" />
    <link
      href="data:image/x-icon;base64,AAABAAEAAQECAAEAAQA4AAAAFgAAACgAAAABAAAAAgAAAAEAAQAAAAAAAAAAAAAAAAAAAAAAAAAAAAABAAEAAQECAAEAAQA4AAAAFgAAACgAAAABAAAAAgAAAAEAAQAAAAAAAAAAAAAAAAAAAAAAAAAA"
      rel="icon"
      type="image/x-icon"
    />
    <link
      href="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAgAAAAIAAQMAAADOtka5AAAAA1BMVEUAAACnej3aAAAANklEQVR42u3BAQEAAACCIP+vbkhAAQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAB8G4IAAAFjdVCkAAAAAElFTkSuQmCC"
      rel="apple-touch-icon"
    />
    <style>
      /*<!--*/
      body {
        color: rgb(25, 25, 25);
        font-family: Verdana, Geneva, sans-serif;
        margin: 0;
      }

      a {
        text-decoration: none;
      }

      a:link,
      a:focus,
      a:hover,
      a:active {
        color: rgb(75, 75, 125);
      }

      a:visited {
        color: rgb(25, 25, 25);
      }

      h1 > a,
      h1 > a:link,
      h1 > a:focus,
      h1 > a:hover,
      h1 > a:active,
      h1 > a:visited,
      h2 > a,
      h2 > a:link,
      h2 > a:focus,
      h2 > a:hover,
      h2 > a:active,
      h2 > a:visited {
        color: rgb(25, 25, 25);
      }

      h1 {
        background-color: rgb(255, 102, 0);
        margin: 0;
        padding: 1rem;
      }

      h2 {
        background-color: rgb(200, 200, 200);
        margin: 1rem 0;
        padding: 0.5rem 0.5rem 0.5rem 1rem;
      }

      #latest > section,
      #archives > section {
        margin: 0 1rem 1rem 1rem;
        padding-bottom: 1rem;
      }

      #latest > section:not(:last-child),
      #archives > section:not(:last-child) {
        border-bottom: 1px dotted rgb(200, 200, 200);
      }

      section > h3 {
        margin: 0 0 0.5rem 0;
      }

      section > h4 {
        font-weight: normal;
        margin: 0 0 0 1rem;
      }

      .descendants-container,
      .points-container {
        align-items: center;
        border-left: 1px solid #333;
        display: inline-flex;
        margin-left: 0.5rem;
        padding-left: 0.5rem;
        text-align: center;
      }

      .points {
        align-items: center;
        display: inline-flex;
        height: 1rem;
        margin-left: 1ch;
        min-width: 3ch;
      }

      .text {
        line-height: 1.5rem;
        margin: 1rem 1rem 0 1rem;
        overflow: auto;
      }

      .text > p:first-child {
        margin-top: 1rem;
      }

      .text > p:last-child {
        margin-bottom: 0;
      }
      /*-->*/
    </style>
  </head>

  <body>
    <main>
      <h1><a href="https://kherrick.github.io/hacker-news/">Hacker News</a></h1>
      <section id="latest">
        <h2>Latest</h2>
        <section id="40756034">
          <h3>
            <a class="item" href="https://www.farmfe.org/"
              >Farm: Fast vite compatible build tool written in Rust</a
            >
          </h3>
          <section>
            <h4>
              <span>2024-06-22 @ 03:34:39</span
              ><span class="points-container"
                >Points: <span class="points">24</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=40756034"
                  >Comments</a
                ><span class="descendants">: 6</span></span
              >
            </h4>
          </section>
        </section>
        <section id="40755969">
          <h3>
            <a
              class="item"
              href="https://arstechnica.com/space/2024/06/nasa-indefinitely-delays-return-of-starliner-to-review-propulsion-data/"
              >NASA indefinitely delays return of Starliner to review propulsion
              data</a
            >
          </h3>
          <section>
            <h4>
              <span>2024-06-22 @ 03:17:30</span
              ><span class="points-container"
                >Points: <span class="points">14</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=40755969"
                  >Comments</a
                ><span class="descendants">: 0</span></span
              >
            </h4>
          </section>
        </section>
        <section id="40755688">
          <h3>
            <a
              class="item"
              href="https://groups.google.com/g/comp.lang.forth/c/ThWiGXwKqv4"
              >A Forth Story (1995)</a
            >
          </h3>
          <section>
            <h4>
              <span>2024-06-22 @ 02:26:14</span
              ><span class="points-container"
                >Points: <span class="points">16</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=40755688"
                  >Comments</a
                ><span class="descendants">: 1</span></span
              >
            </h4>
          </section>
        </section>
        <section id="40755563">
          <h3>
            <a
              class="item"
              href="https://arstechnica.com/ai/2024/06/researchers-describe-how-to-tell-if-chatgpt-is-confabulating/"
              >Researchers describe how to tell if ChatGPT is confabulating</a
            >
          </h3>
          <section>
            <h4>
              <span>2024-06-22 @ 01:57:18</span
              ><span class="points-container"
                >Points: <span class="points">20</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=40755563"
                  >Comments</a
                ><span class="descendants">: 7</span></span
              >
            </h4>
          </section>
        </section>
        <section id="40755444">
          <h3>
            <a
              class="item"
              href="https://www.howtogeek.com/my-windows-computer-just-doesnt-feel-like-mine-anymore/"
              >My Windows Computer Just Doesn't Feel Like Mine Anymore</a
            >
          </h3>
          <section>
            <h4>
              <span>2024-06-22 @ 01:29:24</span
              ><span class="points-container"
                >Points: <span class="points">167</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=40755444"
                  >Comments</a
                ><span class="descendants">: 146</span></span
              >
            </h4>
          </section>
        </section>
        <section id="40754982">
          <h3>
            <a
              class="item"
              href="https://www.seagate.com/innovation/multi-actuator-hard-drives/"
              >MACH.2 Multi-Actuator Hard Drives</a
            >
          </h3>
          <section>
            <h4>
              <span>2024-06-21 @ 23:41:22</span
              ><span class="points-container"
                >Points: <span class="points">22</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=40754982"
                  >Comments</a
                ><span class="descendants">: 33</span></span
              >
            </h4>
            <div class="text">
              Apparently both Seagate and Western Digital sell dual-actuator
              disks (double the IOPS and throughput up to 448 IOPS and 524 MB/s
              per drive)
            </div>
          </section>
        </section>
        <section id="40754229">
          <h3>
            <a
              class="item"
              href="https://arstechnica.com/tech-policy/2024/06/internet-archive-forced-to-remove-500000-books-after-publishers-court-win/"
              >Internet Archive forced to remove 500k books after publishers'
              court win</a
            >
          </h3>
          <section>
            <h4>
              <span>2024-06-21 @ 21:53:54</span
              ><span class="points-container"
                >Points: <span class="points">304</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=40754229"
                  >Comments</a
                ><span class="descendants">: 225</span></span
              >
            </h4>
          </section>
        </section>
        <section id="40753856">
          <h3>
            <a
              class="item"
              href="https://biggieblog.com/solving-puzzles-faster-than-humanly-possible/"
              >Solving puzzles faster than humanly possible</a
            >
          </h3>
          <section>
            <h4>
              <span>2024-06-21 @ 21:10:28</span
              ><span class="points-container"
                >Points: <span class="points">34</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=40753856"
                  >Comments</a
                ><span class="descendants">: 3</span></span
              >
            </h4>
          </section>
        </section>
        <section id="40753773">
          <h3>
            <a
              class="item"
              href="https://gist.github.com/owulveryck/4ac8c96c16f5a48de24f8a0e949ad9a5"
              >Hope without optimism – transcription of a talk by Dave Snowden
              (2022)</a
            >
          </h3>
          <section>
            <h4>
              <span>2024-06-21 @ 21:02:19</span
              ><span class="points-container"
                >Points: <span class="points">24</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=40753773"
                  >Comments</a
                ><span class="descendants">: 10</span></span
              >
            </h4>
          </section>
        </section>
        <section id="40753752">
          <h3>
            <a
              class="item"
              href="https://www.emergetools.com/careers/jobs/senior-frontend-engineer"
              >Emerge Tools (YC W21) is hiring a senior front end engineer</a
            >
          </h3>
          <section>
            <h4>
              <span>2024-06-21 @ 21:00:43</span
              ><span class="points-container"
                >Points: <span class="points">1</span></span
              >
            </h4>
          </section>
        </section>
        <section id="40753417">
          <h3>
            <a
              class="item"
              href="https://github.com/jamespfennell/new-typesetting-system"
              >NTS (TeX reimplementation in Java from 2001) still compiles under
              Java 16</a
            >
          </h3>
          <section>
            <h4>
              <span>2024-06-21 @ 20:23:14</span
              ><span class="points-container"
                >Points: <span class="points">39</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=40753417"
                  >Comments</a
                ><span class="descendants">: 12</span></span
              >
            </h4>
          </section>
        </section>
        <section id="40751813">
          <h3>
            <a
              class="item"
              href="https://navyhistory.au/aster-shootdown-over-sydney-in-1955/"
              >Aster shootdown over Sydney in 1955</a
            >
          </h3>
          <section>
            <h4>
              <span>2024-06-21 @ 17:33:28</span
              ><span class="points-container"
                >Points: <span class="points">158</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=40751813"
                  >Comments</a
                ><span class="descendants">: 45</span></span
              >
            </h4>
          </section>
        </section>
        <section id="40751468">
          <h3>
            <a class="item" href="https://criu.org/Main_Page"
              >CRIU, a project to implement checkpoint/restore functionality for
              Linux</a
            >
          </h3>
          <section>
            <h4>
              <span>2024-06-21 @ 16:59:52</span
              ><span class="points-container"
                >Points: <span class="points">138</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=40751468"
                  >Comments</a
                ><span class="descendants">: 51</span></span
              >
            </h4>
          </section>
        </section>
        <section id="40751178">
          <h3>
            <a
              class="item"
              href="https://github.com/nkaz001/hftbacktest/tree/master/rust"
              >Show HN: High-frequency trading and market-making backtesting
              tool with examples</a
            >
          </h3>
          <section>
            <h4>
              <span>2024-06-21 @ 16:30:17</span
              ><span class="points-container"
                >Points: <span class="points">76</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=40751178"
                  >Comments</a
                ><span class="descendants">: 28</span></span
              >
            </h4>
          </section>
        </section>
        <section id="40751108">
          <h3>
            <a
              class="item"
              href="https://www.sfchronicle.com/bayarea/article/self-driving-cars-waymo-sf-19523750.php"
              >Self-driving Waymos secure final clearance for expansion beyond
              S.F</a
            >
          </h3>
          <section>
            <h4>
              <span>2024-06-21 @ 16:24:09</span
              ><span class="points-container"
                >Points: <span class="points">179</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=40751108"
                  >Comments</a
                ><span class="descendants">: 207</span></span
              >
            </h4>
          </section>
        </section>
        <section id="40751020">
          <h3>
            <a
              class="item"
              href="https://blog.jitx.com/jitx-corporate-blog/testing-generative-ai-for-circuit-board-design"
              >Testing Generative AI for Circuit Board Design</a
            >
          </h3>
          <section>
            <h4>
              <span>2024-06-21 @ 16:16:31</span
              ><span class="points-container"
                >Points: <span class="points">270</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=40751020"
                  >Comments</a
                ><span class="descendants">: 131</span></span
              >
            </h4>
          </section>
        </section>
        <section id="40750171">
          <h3>
            <a
              class="item"
              href="https://mattsclancy.substack.com/p/twitter-and-the-spread-of-academic"
              >Twitter and the spread of academic knowledge</a
            >
          </h3>
          <section>
            <h4>
              <span>2024-06-21 @ 14:44:59</span
              ><span class="points-container"
                >Points: <span class="points">66</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=40750171"
                  >Comments</a
                ><span class="descendants">: 3</span></span
              >
            </h4>
          </section>
        </section>
        <section id="40749670">
          <h3>
            <a class="item" href="https://zachartrand.github.io/SoME-3-Living/"
              >How does a computer/calculator compute logarithms?</a
            >
          </h3>
          <section>
            <h4>
              <span>2024-06-21 @ 13:54:24</span
              ><span class="points-container"
                >Points: <span class="points">116</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=40749670"
                  >Comments</a
                ><span class="descendants">: 52</span></span
              >
            </h4>
          </section>
        </section>
        <section id="40749624">
          <h3>
            <a class="item" href="https://lemmy.world/post/16763534"
              >Spending 3 months investigating a 7-year old bug and fixing it in
              1 line of code</a
            >
          </h3>
          <section>
            <h4>
              <span>2024-06-21 @ 13:49:55</span
              ><span class="points-container"
                >Points: <span class="points">241</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=40749624"
                  >Comments</a
                ><span class="descendants">: 69</span></span
              >
            </h4>
          </section>
        </section>
        <section id="40749426">
          <h3>
            <a
              class="item"
              href="https://arstechnica.com/gaming/2024/06/from-infocom-to-80-days-an-oral-history-of-text-games-and-interactive-fiction/"
              >From Infocom to 80 Days: An oral history of text games and
              interactive fiction</a
            >
          </h3>
          <section>
            <h4>
              <span>2024-06-21 @ 13:30:21</span
              ><span class="points-container"
                >Points: <span class="points">166</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=40749426"
                  >Comments</a
                ><span class="descendants">: 63</span></span
              >
            </h4>
          </section>
        </section>
        <section id="40747845">
          <h3>
            <a class="item" href="https://github.com/Eliah-Lakhin/lady-deirdre"
              >Show HN: Lady Deirdre 2 – Rust Framework for Compilers and LSP
              Servers</a
            >
          </h3>
          <section>
            <h4>
              <span>2024-06-21 @ 09:40:40</span
              ><span class="points-container"
                >Points: <span class="points">98</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=40747845"
                  >Comments</a
                ><span class="descendants">: 27</span></span
              >
            </h4>
            <div class="text">
              <p>I would like to share with you my project, Lady Deirdre.</p>
              <p>
                Lady Deirdre is a framework that helps you create new
                programming languages in Rust. It is specifically designed to
                develop compilers and interpreters with support for code editor
                extensions (LSP servers) from day one.
              </p>
              <p>
                The framework includes essential components to design parsers
                and semantic analyzers capable of incrementally reparsing
                dynamically evolving source code.
              </p>
              <p>
                Lady Deirdre can be seen as a replacement for preexisting
                projects with similar goals, such as Tree-Sitter, Rowan, or
                Salsa. However, Lady Deirdre aims to offer a unified framework
                API that guides you through the steps of programming language
                development, providing even more components necessary to develop
                a full-featured language ecosystem. For example, components to
                develop a source code formatter.
              </p>
              <p>I will be happy to answer any questions.</p>
              <p>Ilya</p>
            </div>
          </section>
        </section>
        <section id="40746773">
          <h3>
            <a class="item" href="https://github.com/mayneyao/eidos"
              >Show HN: Eidos – Offline alternative to Notion</a
            >
          </h3>
          <section>
            <h4>
              <span>2024-06-21 @ 06:30:02</span
              ><span class="points-container"
                >Points: <span class="points">110</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=40746773"
                  >Comments</a
                ><span class="descendants">: 22</span></span
              >
            </h4>
            <div class="text">
              <p>
                Notion, like most SaaS products, is not open-source, so I can't
                customize it to my heart's content. I can only wait and vote for
                new features, but I can code, and I don't want to wait. I really
                like the concepts of FOSS, solid, and local-first. SaaS could
                die. Long may the SQLite. So, I built Eidos based on sqlite for
                managing my personal data throughout my lifetime in one place.
                Eidos is a long-term project for me. It looks like Notion, but
                the core is more like "obsidian.sqlite" with a powerful
                extension system.
              </p>
              <p>Here are a few key ideas:</p>
              <p>
                - Eidos is built based on sqlite-wasm and runs entirely in the
                browser. It can be used immediately, with no installation or
                configuration required. It's a pure PWA, with full offline
                support.
              </p>
              <p>
                - A block-styled document editor and an Airtable-like table,
                built on top of SQLite, where each table is a real SQLite table.
              </p>
              <p>
                - A powerful extension system inspired by Figma plugin and
                Cloudflare worker. You can write scripts in TypeScript directly
                in the browser. It is easy to manipulate data in docs, tables,
                and the file system. It also supports API.
              </p>
              <p>
                - If you're not a developer, you're still in luck. We're living
                in an AI era. LLM empowers people to craft their own software
                without writing any code. Eidos deeply integrated with LLM. You
                can translate, summarize, talk to your data, process table data
                in batches, and more. It makes your life easier with AI. You can
                fully customize your prompts and freely choose your LLM
                provider, without being locked to any vendor.
              </p>
              <p>
                To be honest, so far, there are still some bugs and
                shortcomings, and it hasn't yet reached my envisioned
                perfection. There is still some work to be done, but the basic
                framework has taken shape. I've been working on it for a year
                and have eaten my own dog food for the past half year. To help
                Eidos become better (and celebrate the release of the Elden
                Ring's DLC), I've decided to make it open-source and gather more
                feedback. Now, I'm going to take a break and play Shadow of the
                Erdtree.
              </p>
              <p>- <a href="https://eidos.space">https://eidos.space</a></p>
            </div>
          </section>
        </section>
        <section id="40746144">
          <h3>
            <a
              class="item"
              href="https://lichess.org/@/jk_182/blog/using-stockfish-to-identify-ideal-squares/x3U2g3NP"
              >Using Stockfish to identify ideal squares</a
            >
          </h3>
          <section>
            <h4>
              <span>2024-06-21 @ 04:25:36</span
              ><span class="points-container"
                >Points: <span class="points">20</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=40746144"
                  >Comments</a
                ><span class="descendants">: 2</span></span
              >
            </h4>
          </section>
        </section>
        <section id="40739549">
          <h3>
            <a
              class="item"
              href="https://www.cnn.com/2024/06/19/travel/barf-bag-collectors-hobby-cec/index.html"
              >Hobbyists who collect barf bags</a
            >
          </h3>
          <section>
            <h4>
              <span>2024-06-20 @ 15:05:14</span
              ><span class="points-container"
                >Points: <span class="points">28</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=40739549"
                  >Comments</a
                ><span class="descendants">: 16</span></span
              >
            </h4>
          </section>
        </section>
        <section id="40739046">
          <h3>
            <a
              class="item"
              href="https://dl.acm.org/doi/pdf/10.1145/319838.319870"
              >Connection Machine Lisp (1986)</a
            >
          </h3>
          <section>
            <h4>
              <span>2024-06-20 @ 14:17:02</span
              ><span class="points-container"
                >Points: <span class="points">48</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=40739046"
                  >Comments</a
                ><span class="descendants">: 7</span></span
              >
            </h4>
          </section>
        </section>
        <section id="40738739">
          <h3>
            <a class="item" href="https://aravind.rs/numbers"
              >Show HN: Primeval Numbers</a
            >
          </h3>
          <section>
            <h4>
              <span>2024-06-20 @ 13:46:33</span
              ><span class="points-container"
                >Points: <span class="points">9</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=40738739"
                  >Comments</a
                ><span class="descendants">: 7</span></span
              >
            </h4>
          </section>
        </section>
        <section id="40728714">
          <h3>
            <a
              class="item"
              href="https://tidyfirst.substack.com/p/the-trough-of-despair"
              >Software design gets worse before it gets better</a
            >
          </h3>
          <section>
            <h4>
              <span>2024-06-19 @ 14:36:30</span
              ><span class="points-container"
                >Points: <span class="points">151</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=40728714"
                  >Comments</a
                ><span class="descendants">: 85</span></span
              >
            </h4>
          </section>
        </section>
        <section id="40720548">
          <h3>
            <a class="item" href="https://eggcorns.lascribe.net"
              >The Eggcorn Database</a
            >
          </h3>
          <section>
            <h4>
              <span>2024-06-18 @ 18:12:15</span
              ><span class="points-container"
                >Points: <span class="points">47</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=40720548"
                  >Comments</a
                ><span class="descendants">: 6</span></span
              >
            </h4>
          </section>
        </section>
        <section id="40719278">
          <h3>
            <a
              class="item"
              href="https://medicalxpress.com/news/2024-06-ingestible-device-gastric-electrophysiological.html"
              >An ingestible device to record gastric electrophysiological
              activity</a
            >
          </h3>
          <section>
            <h4>
              <span>2024-06-18 @ 15:54:14</span
              ><span class="points-container"
                >Points: <span class="points">18</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=40719278"
                  >Comments</a
                ><span class="descendants">: 3</span></span
              >
            </h4>
          </section>
        </section>
        <section id="40713595">
          <h3>
            <a class="item" href="https://dtsec.us/2023-04-24-Sleep/"
              >An Introduction to Sleep Obfuscation for Malware (2023)</a
            >
          </h3>
          <section>
            <h4>
              <span>2024-06-18 @ 02:45:57</span
              ><span class="points-container"
                >Points: <span class="points">9</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=40713595"
                  >Comments</a
                ><span class="descendants">: 0</span></span
              >
            </h4>
          </section>
        </section>
      </section>
      <section id="archives">
        <h2>
          <a
            href="https://github.com/kherrick/hacker-news/blob/main/archives/index.md"
            >Archives</a
          >
        </h2>
        <section>
          <h3>
            <a
              href="https://github.com/kherrick/hacker-news/blob/main/archives/2024/index.md"
              >2024</a
            >
          </h3>
        </section>
        <section>
          <h3>
            <a
              href="https://github.com/kherrick/hacker-news/blob/main/archives/2023/index.md"
              >2023</a
            >
          </h3>
        </section>
        <section>
          <h3>
            <a
              href="https://github.com/kherrick/hacker-news/blob/main/archives/2022/index.md"
              >2022</a
            >
          </h3>
        </section>
      </section>
    </main>
    <script type="module">
      import { buildDescendants } from "./lib/build-html-descendants.js";
      import { buildNextItem } from "./lib/build-html-next-item.js";
      import { getNextDateTime } from "./lib/date-time.js";

      const updateSectionById = (id) =>
        fetch(`https://hacker-news.firebaseio.com/v0/item/${id}.json`).then(
          (result) =>
            result.json().then(({ descendants, id, score, text, type }) => {
              const currentItem = document.getElementById(id);

              if (score) {
                currentItem.querySelector(".points").textContent = score;
              }

              if (descendants && (type === "poll" || type === "story")) {
                const currentDescendants =
                  currentItem.querySelector(".descendants");

                if (currentDescendants) {
                  currentDescendants.textContent = `: ${descendants}`;
                } else {
                  const comments = buildDescendants(
                    document,
                    descendants,
                    `https://news.ycombinator.com/item?id=${id}`
                  );

                  currentItem.querySelector("h4").appendChild(comments);
                }
              }

              if (text) {
                const currentText = currentItem.querySelector(".text");

                if (currentText) {
                  currentText.innerHTML = text.replace(/\0/g, "");
                } else {
                  const content = document.createElement("div");
                  content.innerHTML = text.replace(/\0/g, "");
                  content.setAttribute("class", "text");

                  currentItem.appendChild(content);
                }
              }
            })
        );

      class UpdateQueue {
        constructor() {
          this._ids = [];
          this._isUpdating = false;
        }

        addItemById(id) {
          this._ids.push(id);
        }

        async flush() {
          const id = this._ids.shift();

          if (id) {
            this._isUpdating = true;

            await updateSectionById(id);
            await this.flush();
          } else {
            this._isUpdating = false;

            setTimeout(async () => {
              if (!this._isUpdating && this._ids && this._ids.length) {
                await this.flush();
              }
            }, 0);
          }
        }
      }

      // get latest data
      const latestSection = document.getElementById("latest");

      for (let item of latestSection.querySelectorAll("section[id]")) {
        updateSectionById(item.getAttribute("id"));
      }

      if ("IntersectionObserver" in window) {
        window.hackerNewsState = { index: [], nextTimeIndex: -1 };

        const addNewsItem = async (newsItem, queue) => {
          try {
            const { date, time, itemComments, itemTitle, itemLink } = newsItem;
            const section = await buildNextItem({
              document,
              dateTime: `${date}, ${time}`,
              itemComments,
              itemLink,
              itemTitle: new DOMParser().parseFromString(
                itemTitle.replace(/\\/g, ""),
                "text/html"
              ).documentElement.textContent,
              fetchItemDetails: false,
            });

            // display loading indicator for section
            section.querySelector(".points-container").innerHTML =
              'Points: <span class="points"><img style="height: 100%;" src="lib/images/loading.svg" /></span>';

            const id = section.getAttribute("id");
            if (!document.getElementById(id)) {
              document.getElementById("latest").appendChild(section);

              queue.addItemById(id);
            }
          } catch (error) {}
        };

        const buildArchiveIndex = async (lastDateTime) => {
          const nextDate = lastDateTime.slice(0, 10);
          const nextYear = nextDate.slice(0, 4);

          return (
            await (
              await fetch(
                `https://raw.githubusercontent.com/kherrick/hacker-news/main/archives/${nextYear}/${nextDate}/index.md`
              )
            ).text()
          )
            .split("\n")
            .filter((line) => line.match(new RegExp("^\\* \\[")))
            .map((line) => {
              const segment = line.replace("* ", "").split("](");
              const pubDate = segment[0].slice(1);

              const itemComments = segment[1].split(") - [")[0];
              const itemTitle = segment[1].split(") - [")[1];
              const itemLink = segment[2].slice(0, -1);
              const date = pubDate.slice(0, 10);
              const time = pubDate.slice(-8);

              return {
                date,
                itemComments,
                itemLink,
                itemTitle,
                time,
              };
            });
        };

        const handleIntersectingEntry = async (entry, queue) => {
          if (entry.isIntersecting) {
            const lastDateTime = document
              .getElementById("latest")
              .querySelector(
                "section:last-child > section > h4 > span"
              ).textContent;

            const nextDateTime = getNextDateTime(lastDateTime ?? "", -1);
            const archiveIndex = await buildArchiveIndex(nextDateTime);
            const nextTimeIndex = archiveIndex.findIndex(
              ({ time }) => time === nextDateTime.slice(-8)
            );

            const handleIndexUpdate = (index, existingIndexValues = []) => {
              index.forEach((i) => {
                existingIndexValues.push(i);
              });
              return existingIndexValues;
            };

            window.hackerNewsState = {
              index: handleIndexUpdate(
                archiveIndex,
                window.hackerNewsState.index
              ),
              nextTimeIndex,
            };

            let currentTimeIndex = nextTimeIndex + 1;
            const items = Object.values(window.hackerNewsState.index);
            for (let item of items) {
              if (currentTimeIndex < window.hackerNewsState.index.length) {
                addNewsItem(items[currentTimeIndex], queue);

                currentTimeIndex = currentTimeIndex + 1;
              }
            }

            queue.flush();
          }
        };

        const archives = document.getElementById("archives");
        const archivesObserver = new IntersectionObserver(
          (entries) => {
            const queue = new UpdateQueue();

            entries.forEach((entry) => handleIntersectingEntry(entry, queue));
          },
          {
            root: null,
            rootMargin: "0px",
            threshold: 0,
          }
        );

        archivesObserver.observe(archives);

        let latestSectionsExpanded = true;
        const handleLatestHeaderClick = () => {
          latestSectionsExpanded = !latestSectionsExpanded;

          if (latestSectionsExpanded) {
            archivesObserver.observe(archives);
          } else {
            archivesObserver.disconnect(archives);
          }

          for (let section of document.querySelectorAll("#latest > section")) {
            section.style.display = latestSectionsExpanded ? "block" : "none";
          }
        };

        const latestHeader = document.querySelector("#latest > h2");
        latestHeader.style.cursor = "pointer";
        latestHeader.addEventListener("click", handleLatestHeaderClick);
      }
    </script>
    <script type="module">
      import { Workbox } from "https://storage.googleapis.com/workbox-cdn/releases/6.4.1/workbox-window.prod.mjs";

      if ("serviceWorker" in navigator) {
        const base = document.querySelector("base");
        const serviceWorkerPath = `${
          base ? base.href.replace(/\/$/, "") : ""
        }/service-worker.js`;

        const wb = new Workbox(serviceWorkerPath);

        // setup event listeners
        wb.addEventListener("waiting", (event) => {
          wb.addEventListener("controlling", () => {
            window.location.reload();
          });

          wb.messageSkipWaiting();
        });

        wb.register();
      }
    </script>
  </body>
</html>
