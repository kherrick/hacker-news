<!DOCTYPE html>
<html lang="en" xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta charset="utf-8" />
    <meta
      content="width=device-width, initial-scale=1.0, viewport-fit=cover"
      name="viewport"
    />
    <meta name="description" content="Hacker News" />
    <meta name="theme-color" content="#fff" />
    <title>Hacker News</title>
    <link rel="manifest" href="manifest.json" />
    <link
      href="data:image/x-icon;base64,AAABAAEAAQECAAEAAQA4AAAAFgAAACgAAAABAAAAAgAAAAEAAQAAAAAAAAAAAAAAAAAAAAAAAAAAAAABAAEAAQECAAEAAQA4AAAAFgAAACgAAAABAAAAAgAAAAEAAQAAAAAAAAAAAAAAAAAAAAAAAAAA"
      rel="icon"
      type="image/x-icon"
    />
    <link
      href="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAgAAAAIAAQMAAADOtka5AAAAA1BMVEUAAACnej3aAAAANklEQVR42u3BAQEAAACCIP+vbkhAAQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAB8G4IAAAFjdVCkAAAAAElFTkSuQmCC"
      rel="apple-touch-icon"
    />
    <style>
      /*<!--*/
      body {
        color: rgb(25, 25, 25);
        font-family: Verdana, Geneva, sans-serif;
        margin: 0;
      }

      a {
        text-decoration: none;
      }

      a:link,
      a:focus,
      a:hover,
      a:active {
        color: rgb(75, 75, 125);
      }

      a:visited {
        color: rgb(25, 25, 25);
      }

      h1 > a,
      h1 > a:link,
      h1 > a:focus,
      h1 > a:hover,
      h1 > a:active,
      h1 > a:visited,
      h2 > a,
      h2 > a:link,
      h2 > a:focus,
      h2 > a:hover,
      h2 > a:active,
      h2 > a:visited {
        color: rgb(25, 25, 25);
      }

      h1 {
        background-color: rgb(255, 102, 0);
        margin: 0;
        padding: 1rem;
      }

      h2 {
        background-color: rgb(200, 200, 200);
        margin: 1rem 0;
        padding: 0.5rem 0.5rem 0.5rem 1rem;
      }

      #latest > section,
      #archives > section {
        margin: 0 1rem 1rem 1rem;
        padding-bottom: 1rem;
      }

      #latest > section:not(:last-child),
      #archives > section:not(:last-child) {
        border-bottom: 1px dotted rgb(200, 200, 200);
      }

      section > h3 {
        margin: 0 0 0.5rem 0;
      }

      section > h4 {
        font-weight: normal;
        margin: 0 0 0 1rem;
      }

      .descendants-container,
      .points-container {
        align-items: center;
        border-left: 1px solid #333;
        display: inline-flex;
        margin-left: 0.5rem;
        padding-left: 0.5rem;
        text-align: center;
      }

      .points {
        align-items: center;
        display: inline-flex;
        height: 1rem;
        margin-left: 1ch;
        min-width: 3ch;
      }

      .text {
        line-height: 1.5rem;
        margin: 1rem 1rem 0 1rem;
        overflow: auto;
      }

      .text > p:first-child {
        margin-top: 1rem;
      }

      .text > p:last-child {
        margin-bottom: 0;
      }
      /*-->*/
    </style>
  </head>

  <body>
    <main>
      <h1><a href="https://kherrick.github.io/hacker-news/">Hacker News</a></h1>
      <section id="latest">
        <h2>Latest</h2>
        <section id="45531284">
          <h3>
            <a
              class="item"
              href="https://www.macfound.org/programs/awards/fellows/"
              >2025 MacArthur Fellows</a
            >
          </h3>
          <section>
            <h4>
              <span>2025-10-09 @ 18:25:49</span
              ><span class="points-container"
                >Points: <span class="points">15</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=45531284"
                  >Comments</a
                ><span class="descendants">: 3</span></span
              >
            </h4>
          </section>
        </section>
        <section id="45531262">
          <h3>
            <a
              class="item"
              href="https://nagix.github.io/sea-level-rise-3d-map/"
              >Sea Rise Simulator (2023)</a
            >
          </h3>
          <section>
            <h4>
              <span>2025-10-09 @ 18:23:43</span
              ><span class="points-container"
                >Points: <span class="points">14</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=45531262"
                  >Comments</a
                ><span class="descendants">: 0</span></span
              >
            </h4>
          </section>
        </section>
        <section id="45530832">
          <h3>
            <a
              class="item"
              href="https://rubycentral.org/news/rubygems-org-aws-root-access-event-september-2025/"
              >Rubygems.org AWS Root Access Event – September 2025</a
            >
          </h3>
          <section>
            <h4>
              <span>2025-10-09 @ 17:48:23</span
              ><span class="points-container"
                >Points: <span class="points">110</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=45530832"
                  >Comments</a
                ><span class="descendants">: 38</span></span
              >
            </h4>
          </section>
        </section>
        <section id="45530744">
          <h3>
            <a class="item" href="https://www.subwaybuilder.com/"
              >Subway Builder: A realistic subway simulation game</a
            >
          </h3>
          <section>
            <h4>
              <span>2025-10-09 @ 17:38:29</span
              ><span class="points-container"
                >Points: <span class="points">59</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=45530744"
                  >Comments</a
                ><span class="descendants">: 26</span></span
              >
            </h4>
          </section>
        </section>
        <section id="45530388">
          <h3>
            <a class="item" href="https://github.com/wizenheimer/blaze"
              >Show HN: I wrote a full text search engine in Go</a
            >
          </h3>
          <section>
            <h4>
              <span>2025-10-09 @ 17:09:22</span
              ><span class="points-container"
                >Points: <span class="points">17</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=45530388"
                  >Comments</a
                ><span class="descendants">: 8</span></span
              >
            </h4>
          </section>
        </section>
        <section id="45530261">
          <h3>
            <a class="item" href="https://blog.gavide.dev/blog/esp32-and-termux"
              >ESP32 and Termux</a
            >
          </h3>
          <section>
            <h4>
              <span>2025-10-09 @ 16:56:52</span
              ><span class="points-container"
                >Points: <span class="points">43</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=45530261"
                  >Comments</a
                ><span class="descendants">: 5</span></span
              >
            </h4>
          </section>
        </section>
        <section id="45529748">
          <h3>
            <a class="item" href="https://github.com/raphamorim/goiaba"
              >Goiaba: An experimental Go compiler, written in Rust</a
            >
          </h3>
          <section>
            <h4>
              <span>2025-10-09 @ 16:15:08</span
              ><span class="points-container"
                >Points: <span class="points">32</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=45529748"
                  >Comments</a
                ><span class="descendants">: 15</span></span
              >
            </h4>
          </section>
        </section>
        <section id="45529628">
          <h3>
            <a class="item" href="https://www.extend.ai/"
              >Launch HN: Extend (YC W23) – Turn your messiest documents into
              data</a
            >
          </h3>
          <section>
            <h4>
              <span>2025-10-09 @ 16:06:49</span
              ><span class="points-container"
                >Points: <span class="points">34</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=45529628"
                  >Comments</a
                ><span class="descendants">: 16</span></span
              >
            </h4>
            <div class="text">
              <a href="https://www.extend.ai/">https://www.extend.ai/</a>).
              Extend is a toolkit for AI teams to ingest any kind of messy
              document (e.g. PDFs, images, excel files) and build incredible
              products.
              <p>
                We built Extend to handle the hardest documents that break most
                pipelines. You can see some examples here in our demo (no signup
                required):
                <a href="https://dashboard.extend.ai/demo"
                  >https://dashboard.extend.ai/demo</a
                >
              </p>
              <p>
                I know you're probably thinking “not another document API
                startup”. Unfortunately, the problem just isn’t solved yet!
              </p>
              <p>
                I’ve personally spent months struggling to build reliable
                document pipelines at a previous job. The long tail of edge
                cases is endless — massive tables split across pages, 100pg+
                files, messy handwriting, scribbled signatures, checkboxes
                represented in 10 different formats, multiple file types… the
                list just keeps going. After seeing countless other teams during
                our time in YC run into these same issues, we started building
                Extend.
              </p>
              <p>
                We initially launched with a set of APIs for engineers to parse,
                classify, split, and extract documents. That started to take
                off, and soon we were deployed in production at companies
                building everything from medical agents, to real-time bank
                account onboarding, to mortgage automation. Over time, we’ve
                worked closely with these teams and seen first-hand how large
                the gap is between raw OCR/model outputs —&gt; a
                production-ready pipeline (LLMs and VLMs aren’t magic).
              </p>
              <p>
                Unlike other solutions in the space, we're specifically focused
                on three core areas: (1) the computer vision layer, (2) LLM
                context engineering, and (3) the surrounding product tooling.
                The combination of all three is what we think it takes to hit
                99% accuracy and maintain it at scale.
              </p>
              <p>
                For instance, to parse messy handwriting, we built an agentic
                OCR correction layer which uses a VLM to review and make edits
                to low confidence OCR errors. To tackle multi-page tabular data,
                we built a semantic chunking engine which can detect the optimal
                boundaries within a document so models can excel with smaller
                context inputs.
              </p>
              <p>
                We also shipped a prompt optimization agent to automate the
                endless prompt engineering whack-a-mole teams spend time on.
                It’s built as a background agent to replicate the best prompter
                on your team, and runs in a loop with access to a set of tools
                (view files, run evals, analyze results, and update schemas).
              </p>
              <p>
                The most surprising part of this whole experience has been
                seeing how many crazy PDF formats are out there! We've run into
                everything from supermarket inventory magazines, pesticide
                labels, construction blueprints, and satellite manufacturing
                plans.
              </p>
              <p>
                Everything described above is live today. You can see it in
                action here (no signup):
                <a href="https://dashboard.extend.ai/demo"
                  >https://dashboard.extend.ai/demo</a
                >. To upload your own files, you can log in and do so (we’re
                adding free usage credits to all accounts that sign up today).
              </p>
              <p>
                We’re excited to be sharing with HN! We’d love to hear about
                your experiences building document pipelines. Please try it out,
                and share any and all feedback with us (e.g. hard documents that
                didn’t work, feature requests).
              </p>
            </div>
          </section>
        </section>
        <section id="45529587">
          <h3>
            <a
              class="item"
              href="https://www.anthropic.com/research/small-samples-poison"
              >A small number of samples can poison LLMs of any size</a
            >
          </h3>
          <section>
            <h4>
              <span>2025-10-09 @ 16:04:04</span
              ><span class="points-container"
                >Points: <span class="points">347</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=45529587"
                  >Comments</a
                ><span class="descendants">: 88</span></span
              >
            </h4>
          </section>
        </section>
        <section id="45529577">
          <h3>
            <a
              class="item"
              href="https://today.ucsd.edu/story/cybersecurity-training-programs-dont-prevent-employees-from-falling-for-phishing-scams"
              >Cybersecurity training programs don't prevent phishing scams</a
            >
          </h3>
          <section>
            <h4>
              <span>2025-10-09 @ 16:03:06</span
              ><span class="points-container"
                >Points: <span class="points">45</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=45529577"
                  >Comments</a
                ><span class="descendants">: 50</span></span
              >
            </h4>
          </section>
        </section>
        <section id="45529393">
          <h3>
            <a class="item" href="https://github.com/mafik/keyer"
              >Show HN: I've built a tiny hand-held keyboard</a
            >
          </h3>
          <section>
            <h4>
              <span>2025-10-09 @ 15:51:20</span
              ><span class="points-container"
                >Points: <span class="points">132</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=45529393"
                  >Comments</a
                ><span class="descendants">: 48</span></span
              >
            </h4>
            <div class="text">
              I bet you didn't knew you can use modelling clay (as opposed to 3d
              printing) to make nice devices by hand :)
            </div>
          </section>
        </section>
        <section id="45528342">
          <h3>
            <a
              class="item"
              href="https://romanzipp.com/blog/why-a-homelab-why-self-host"
              >Why Self-Host?</a
            >
          </h3>
          <section>
            <h4>
              <span>2025-10-09 @ 14:39:12</span
              ><span class="points-container"
                >Points: <span class="points">246</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=45528342"
                  >Comments</a
                ><span class="descendants">: 172</span></span
              >
            </h4>
          </section>
        </section>
        <section id="45528308">
          <h3>
            <a
              class="item"
              href="https://www.drugtargetreview.com/news/189235/new-nanotherapy-clears-amyloid-%CE%B2-reversing-alzheimers-in-mice/"
              >New nanotherapy clears amyloid-β, reversing symptoms of
              Alzheimer's in mice</a
            >
          </h3>
          <section>
            <h4>
              <span>2025-10-09 @ 14:36:52</span
              ><span class="points-container"
                >Points: <span class="points">138</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=45528308"
                  >Comments</a
                ><span class="descendants">: 68</span></span
              >
            </h4>
          </section>
        </section>
        <section id="45527758">
          <h3>
            <a
              class="item"
              href="https://yossarian.net/til/post/python-s-splitlines-does-a-lot-more-than-just-newlines/"
              >Python's splitlines does more than just newlines</a
            >
          </h3>
          <section>
            <h4>
              <span>2025-10-09 @ 13:55:04</span
              ><span class="points-container"
                >Points: <span class="points">72</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=45527758"
                  >Comments</a
                ><span class="descendants">: 27</span></span
              >
            </h4>
          </section>
        </section>
        <section id="45527507">
          <h3>
            <a
              class="item"
              href="https://danielmangum.com/posts/laptop-hdmi-monitor-sbc/"
              >Using a laptop as an HDMI monitor for an SBC</a
            >
          </h3>
          <section>
            <h4>
              <span>2025-10-09 @ 13:36:01</span
              ><span class="points-container"
                >Points: <span class="points">72</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=45527507"
                  >Comments</a
                ><span class="descendants">: 45</span></span
              >
            </h4>
          </section>
        </section>
        <section id="45527402">
          <h3>
            <a
              class="item"
              href="https://www.figure.ai/news/introducing-figure-03"
              >Figure 03, our 3rd generation humanoid robot</a
            >
          </h3>
          <section>
            <h4>
              <span>2025-10-09 @ 13:27:14</span
              ><span class="points-container"
                >Points: <span class="points">174</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=45527402"
                  >Comments</a
                ><span class="descendants">: 183</span></span
              >
            </h4>
          </section>
        </section>
        <section id="45527003">
          <h3>
            <a
              class="item"
              href="https://www.nobelprize.org/prizes/literature/2025/press-release/"
              >Nobel Prize in Literature 2025: László Krasznahorkai</a
            >
          </h3>
          <section>
            <h4>
              <span>2025-10-09 @ 12:54:18</span
              ><span class="points-container"
                >Points: <span class="points">188</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=45527003"
                  >Comments</a
                ><span class="descendants">: 78</span></span
              >
            </h4>
          </section>
        </section>
        <section id="45526890">
          <h3>
            <a class="item" href="https://github.com/ashtonjamesd/lavandula"
              >Show HN: I built a web framework in C</a
            >
          </h3>
          <section>
            <h4>
              <span>2025-10-09 @ 12:45:28</span
              ><span class="points-container"
                >Points: <span class="points">199</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=45526890"
                  >Comments</a
                ><span class="descendants">: 120</span></span
              >
            </h4>
          </section>
        </section>
        <section id="45526754">
          <h3>
            <a
              class="item"
              href="https://www.nbcnews.com/health/health-care/guilty-proven-innocent-fight-doctors-insurance-companies-downcoding-rcna230714"
              >The fight between doctors and insurance companies over
              'downcoding'</a
            >
          </h3>
          <section>
            <h4>
              <span>2025-10-09 @ 12:36:05</span
              ><span class="points-container"
                >Points: <span class="points">73</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=45526754"
                  >Comments</a
                ><span class="descendants">: 81</span></span
              >
            </h4>
          </section>
        </section>
        <section id="45526582">
          <h3>
            <a
              class="item"
              href="https://www.ketzu.net/dark-patterns-buying-a-bahncard-at-deutsche-bahn/"
              >Dark patterns: Buying a Bahncard at Deutsche Bahn</a
            >
          </h3>
          <section>
            <h4>
              <span>2025-10-09 @ 12:17:54</span
              ><span class="points-container"
                >Points: <span class="points">69</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=45526582"
                  >Comments</a
                ><span class="descendants">: 80</span></span
              >
            </h4>
          </section>
        </section>
        <section id="45526042">
          <h3>
            <a
              class="item"
              href="http://www.goodmath.org/blog/2010/01/13/zippers-making-functional-updates-efficient/"
              >Zippers: Making Functional "Updates" Efficient (2010)</a
            >
          </h3>
          <section>
            <h4>
              <span>2025-10-09 @ 11:07:29</span
              ><span class="points-container"
                >Points: <span class="points">55</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=45526042"
                  >Comments</a
                ><span class="descendants">: 13</span></span
              >
            </h4>
          </section>
        </section>
        <section id="45524702">
          <h3>
            <a
              class="item"
              href="https://blog.miguelgrinberg.com/post/python-3-14-is-here-how-fast-is-it"
              >Python 3.14 is here. How fast is it?</a
            >
          </h3>
          <section>
            <h4>
              <span>2025-10-09 @ 07:40:42</span
              ><span class="points-container"
                >Points: <span class="points">94</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=45524702"
                  >Comments</a
                ><span class="descendants">: 87</span></span
              >
            </h4>
          </section>
        </section>
        <section id="45524437">
          <h3>
            <a
              class="item"
              href="https://www.ycombinator.com/companies/the-forecasting-company/jobs/cXJzAhA-founding-machine-learning-engineer"
              >The Forecasting Company (YC S24) Is Hiring a Machine Learning
              Engineer</a
            >
          </h3>
          <section>
            <h4>
              <span>2025-10-09 @ 07:01:07</span
              ><span class="points-container"
                >Points: <span class="points">1</span></span
              >
            </h4>
          </section>
        </section>
        <section id="45523537">
          <h3>
            <a
              class="item"
              href="https://kix.dev/two-things-llm-coding-agents-are-still-bad-at/"
              >Two things LLM coding agents are still bad at</a
            >
          </h3>
          <section>
            <h4>
              <span>2025-10-09 @ 04:33:48</span
              ><span class="points-container"
                >Points: <span class="points">275</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=45523537"
                  >Comments</a
                ><span class="descendants">: 308</span></span
              >
            </h4>
          </section>
        </section>
        <section id="45520996">
          <h3>
            <a
              class="item"
              href="https://newrepublic.com/article/108017/whats-so-great-about-excellence"
              >What’s So Great About Excellence? (1981)</a
            >
          </h3>
          <section>
            <h4>
              <span>2025-10-08 @ 21:48:53</span
              ><span class="points-container"
                >Points: <span class="points">7</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=45520996"
                  >Comments</a
                ><span class="descendants">: 0</span></span
              >
            </h4>
          </section>
        </section>
        <section id="45490957">
          <h3>
            <a class="item" href="https://github.com/psalias2006/gpu-hot"
              >Real-time Nvidia GPU dashboard</a
            >
          </h3>
          <section>
            <h4>
              <span>2025-10-06 @ 13:04:53</span
              ><span class="points-container"
                >Points: <span class="points">71</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=45490957"
                  >Comments</a
                ><span class="descendants">: 37</span></span
              >
            </h4>
          </section>
        </section>
        <section id="45490652">
          <h3>
            <a class="item" href="https://vkoskiv.com/first-linux-patch/"
              >My first contribution to Linux</a
            >
          </h3>
          <section>
            <h4>
              <span>2025-10-06 @ 12:31:32</span
              ><span class="points-container"
                >Points: <span class="points">167</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=45490652"
                  >Comments</a
                ><span class="descendants">: 20</span></span
              >
            </h4>
          </section>
        </section>
        <section id="45489884">
          <h3>
            <a
              class="item"
              href="https://simonwillison.net/2025/Oct/5/parallel-coding-agents/"
              >Embracing the parallel coding agent lifestyle</a
            >
          </h3>
          <section>
            <h4>
              <span>2025-10-06 @ 10:40:28</span
              ><span class="points-container"
                >Points: <span class="points">22</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=45489884"
                  >Comments</a
                ><span class="descendants">: 24</span></span
              >
            </h4>
          </section>
        </section>
        <section id="45488647">
          <h3>
            <a
              class="item"
              href="https://marma.dev/articles/2025/under-the-hood-vec-t"
              >Under the hood: Vec</a
            >
          </h3>
          <section>
            <h4>
              <span>2025-10-06 @ 07:38:03</span
              ><span class="points-container"
                >Points: <span class="points">143</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=45488647"
                  >Comments</a
                ><span class="descendants">: 111</span></span
              >
            </h4>
          </section>
        </section>
        <section id="45488201">
          <h3>
            <a
              class="item"
              href="https://skoredin.pro/blog/golang/cpu-cache-friendly-go"
              >CPU cache-friendly data structures in Go</a
            >
          </h3>
          <section>
            <h4>
              <span>2025-10-06 @ 06:23:28</span
              ><span class="points-container"
                >Points: <span class="points">118</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=45488201"
                  >Comments</a
                ><span class="descendants">: 40</span></span
              >
            </h4>
          </section>
        </section>
      </section>
      <section id="archives">
        <h2>
          <a
            href="https://github.com/kherrick/hacker-news/blob/main/archives/index.md"
            >Archives</a
          >
        </h2>
        <section>
          <h3>
            <a
              href="https://github.com/kherrick/hacker-news/blob/main/archives/2025/index.md"
              >2025</a
            >
          </h3>
        </section>
        <section>
          <h3>
            <a
              href="https://github.com/kherrick/hacker-news/blob/main/archives/2024/index.md"
              >2024</a
            >
          </h3>
        </section>
        <section>
          <h3>
            <a
              href="https://github.com/kherrick/hacker-news/blob/main/archives/2023/index.md"
              >2023</a
            >
          </h3>
        </section>
        <section>
          <h3>
            <a
              href="https://github.com/kherrick/hacker-news/blob/main/archives/2022/index.md"
              >2022</a
            >
          </h3>
        </section>
      </section>
    </main>
    <script type="module">
      import { buildDescendants } from "./lib/build-html-descendants.js";
      import { buildNextItem } from "./lib/build-html-next-item.js";
      import { getNextDateTime } from "./lib/date-time.js";

      const updateSectionById = (id) =>
        fetch(`https://hacker-news.firebaseio.com/v0/item/${id}.json`).then(
          (result) =>
            result.json().then(({ descendants, id, score, text, type }) => {
              const currentItem = document.getElementById(id);

              if (score) {
                currentItem.querySelector(".points").textContent = score;
              }

              if (descendants && (type === "poll" || type === "story")) {
                const currentDescendants =
                  currentItem.querySelector(".descendants");

                if (currentDescendants) {
                  currentDescendants.textContent = `: ${descendants}`;
                } else {
                  const comments = buildDescendants(
                    document,
                    descendants,
                    `https://news.ycombinator.com/item?id=${id}`
                  );

                  currentItem.querySelector("h4").appendChild(comments);
                }
              }

              if (text) {
                const currentText = currentItem.querySelector(".text");

                if (currentText) {
                  currentText.innerHTML = text.replace(/\0/g, "");
                } else {
                  const content = document.createElement("div");
                  content.innerHTML = text.replace(/\0/g, "");
                  content.setAttribute("class", "text");

                  currentItem.appendChild(content);
                }
              }
            })
        );

      class UpdateQueue {
        constructor() {
          this._ids = [];
          this._isUpdating = false;
        }

        addItemById(id) {
          this._ids.push(id);
        }

        async flush() {
          const id = this._ids.shift();

          if (id) {
            this._isUpdating = true;

            await updateSectionById(id);
            await this.flush();
          } else {
            this._isUpdating = false;

            setTimeout(async () => {
              if (!this._isUpdating && this._ids && this._ids.length) {
                await this.flush();
              }
            }, 0);
          }
        }
      }

      // get latest data
      const latestSection = document.getElementById("latest");

      for (let item of latestSection.querySelectorAll("section[id]")) {
        updateSectionById(item.getAttribute("id"));
      }

      if ("IntersectionObserver" in window) {
        window.hackerNewsState = { index: [], nextTimeIndex: -1 };

        const addNewsItem = async (newsItem, queue) => {
          try {
            const { date, time, itemComments, itemTitle, itemLink } = newsItem;
            const section = await buildNextItem({
              document,
              dateTime: `${date}, ${time}`,
              itemComments,
              itemLink,
              itemTitle: new DOMParser().parseFromString(
                itemTitle.replace(/\\/g, ""),
                "text/html"
              ).documentElement.textContent,
              fetchItemDetails: false,
            });

            // display loading indicator for section
            section.querySelector(".points-container").innerHTML =
              'Points: <span class="points"><img style="height: 100%;" src="lib/images/loading.svg" /></span>';

            const id = section.getAttribute("id");
            if (!document.getElementById(id)) {
              document.getElementById("latest").appendChild(section);

              queue.addItemById(id);
            }
          } catch (error) {}
        };

        const buildArchiveIndex = async (lastDateTime) => {
          const nextDate = lastDateTime.slice(0, 10);
          const nextYear = nextDate.slice(0, 4);

          return (
            await (
              await fetch(
                `https://raw.githubusercontent.com/kherrick/hacker-news/main/archives/${nextYear}/${nextDate}/index.md`
              )
            ).text()
          )
            .split("\n")
            .filter((line) => line.match(new RegExp("^\\* \\[")))
            .map((line) => {
              const segment = line.replace("* ", "").split("](");
              const pubDate = segment[0].slice(1);

              const itemComments = segment[1].split(") - [")[0];
              const itemTitle = segment[1].split(") - [")[1];
              const itemLink = segment[2].slice(0, -1);
              const date = pubDate.slice(0, 10);
              const time = pubDate.slice(-8);

              return {
                date,
                itemComments,
                itemLink,
                itemTitle,
                time,
              };
            });
        };

        const handleIntersectingEntry = async (entry, queue) => {
          if (entry.isIntersecting) {
            const lastDateTime = document
              .getElementById("latest")
              .querySelector(
                "section:last-child > section > h4 > span"
              ).textContent;

            const nextDateTime = getNextDateTime(lastDateTime ?? "", -1);
            const archiveIndex = await buildArchiveIndex(nextDateTime);
            const nextTimeIndex = archiveIndex.findIndex(
              ({ time }) => time === nextDateTime.slice(-8)
            );

            const handleIndexUpdate = (index, existingIndexValues = []) => {
              index.forEach((i) => {
                existingIndexValues.push(i);
              });
              return existingIndexValues;
            };

            window.hackerNewsState = {
              index: handleIndexUpdate(
                archiveIndex,
                window.hackerNewsState.index
              ),
              nextTimeIndex,
            };

            let currentTimeIndex = nextTimeIndex + 1;
            const items = Object.values(window.hackerNewsState.index);
            for (let item of items) {
              if (currentTimeIndex < window.hackerNewsState.index.length) {
                addNewsItem(items[currentTimeIndex], queue);

                currentTimeIndex = currentTimeIndex + 1;
              }
            }

            queue.flush();
          }
        };

        const archives = document.getElementById("archives");
        const archivesObserver = new IntersectionObserver(
          (entries) => {
            const queue = new UpdateQueue();

            entries.forEach((entry) => handleIntersectingEntry(entry, queue));
          },
          {
            root: null,
            rootMargin: "0px",
            threshold: 0,
          }
        );

        archivesObserver.observe(archives);

        let latestSectionsExpanded = true;
        const handleLatestHeaderClick = () => {
          latestSectionsExpanded = !latestSectionsExpanded;

          if (latestSectionsExpanded) {
            archivesObserver.observe(archives);
          } else {
            archivesObserver.disconnect(archives);
          }

          for (let section of document.querySelectorAll("#latest > section")) {
            section.style.display = latestSectionsExpanded ? "block" : "none";
          }
        };

        const latestHeader = document.querySelector("#latest > h2");
        latestHeader.style.cursor = "pointer";
        latestHeader.addEventListener("click", handleLatestHeaderClick);
      }
    </script>
    <script type="module">
      import { Workbox } from "https://storage.googleapis.com/workbox-cdn/releases/6.4.1/workbox-window.prod.mjs";

      if ("serviceWorker" in navigator) {
        const base = document.querySelector("base");
        const serviceWorkerPath = `${
          base ? base.href.replace(/\/$/, "") : ""
        }/service-worker.js`;

        const wb = new Workbox(serviceWorkerPath);

        // setup event listeners
        wb.addEventListener("waiting", (event) => {
          wb.addEventListener("controlling", () => {
            window.location.reload();
          });

          wb.messageSkipWaiting();
        });

        wb.register();
      }
    </script>
  </body>
</html>
