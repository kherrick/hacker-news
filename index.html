<!DOCTYPE html>
<html lang="en" xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta charset="utf-8" />
    <meta
      content="width=device-width, initial-scale=1.0, viewport-fit=cover"
      name="viewport"
    />
    <meta name="description" content="Hacker News" />
    <meta name="theme-color" content="#fff" />
    <title>Hacker News</title>
    <link rel="manifest" href="manifest.json" />
    <link
      href="data:image/x-icon;base64,AAABAAEAAQECAAEAAQA4AAAAFgAAACgAAAABAAAAAgAAAAEAAQAAAAAAAAAAAAAAAAAAAAAAAAAAAAABAAEAAQECAAEAAQA4AAAAFgAAACgAAAABAAAAAgAAAAEAAQAAAAAAAAAAAAAAAAAAAAAAAAAA"
      rel="icon"
      type="image/x-icon"
    />
    <link
      href="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAgAAAAIAAQMAAADOtka5AAAAA1BMVEUAAACnej3aAAAANklEQVR42u3BAQEAAACCIP+vbkhAAQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAB8G4IAAAFjdVCkAAAAAElFTkSuQmCC"
      rel="apple-touch-icon"
    />
    <style>
      /*<!--*/
      body {
        color: rgb(25, 25, 25);
        font-family: Verdana, Geneva, sans-serif;
        margin: 0;
      }

      a {
        text-decoration: none;
      }

      a:link,
      a:focus,
      a:hover,
      a:active {
        color: rgb(75, 75, 125);
      }

      a:visited {
        color: rgb(25, 25, 25);
      }

      h1 > a,
      h1 > a:link,
      h1 > a:focus,
      h1 > a:hover,
      h1 > a:active,
      h1 > a:visited,
      h2 > a,
      h2 > a:link,
      h2 > a:focus,
      h2 > a:hover,
      h2 > a:active,
      h2 > a:visited {
        color: rgb(25, 25, 25);
      }

      h1 {
        background-color: rgb(255, 102, 0);
        margin: 0;
        padding: 1rem;
      }

      h2 {
        background-color: rgb(200, 200, 200);
        margin: 1rem 0;
        padding: 0.5rem 0.5rem 0.5rem 1rem;
      }

      #latest > section,
      #archives > section {
        margin: 0 1rem 1rem 1rem;
        padding-bottom: 1rem;
      }

      #latest > section:not(:last-child),
      #archives > section:not(:last-child) {
        border-bottom: 1px dotted rgb(200, 200, 200);
      }

      section > h3 {
        margin: 0 0 0.5rem 0;
      }

      section > h4 {
        font-weight: normal;
        margin: 0 0 0 1rem;
      }

      .descendants-container,
      .points-container {
        align-items: center;
        border-left: 1px solid #333;
        display: inline-flex;
        margin-left: 0.5rem;
        padding-left: 0.5rem;
        text-align: center;
      }

      .points {
        align-items: center;
        display: inline-flex;
        height: 1rem;
        margin-left: 1ch;
        min-width: 3ch;
      }

      .text {
        line-height: 1.5rem;
        margin: 1rem 1rem 0 1rem;
        overflow: auto;
      }

      .text > p:first-child {
        margin-top: 1rem;
      }

      .text > p:last-child {
        margin-bottom: 0;
      }
      /*-->*/
    </style>
  </head>

  <body>
    <main>
      <h1><a href="https://kherrick.github.io/hacker-news/">Hacker News</a></h1>
      <section id="latest">
        <h2>Latest</h2>
        <section id="37436298">
          <h3>
            <a
              class="item"
              href="https://www.businessinsider.com/chatgpt-losing-hype-traffic-down-three-months-in-a-row-2023-9"
              >ChatGPT is losing some of its hype, traffic falls for the third
              month in a row</a
            >
          </h3>
          <section>
            <h4>
              <span>2023-09-08 @ 17:05:58</span
              ><span class="points-container"
                >Points: <span class="points">16</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=37436298"
                  >Comments</a
                ><span class="descendants">: 15</span></span
              >
            </h4>
          </section>
        </section>
        <section id="37436236">
          <h3>
            <a
              class="item"
              href="https://www.ycombinator.com/companies/artie/jobs/PzBhYqV-founding-engineer"
              >Artie (YC S23) is hiring a founding engineer</a
            >
          </h3>
          <section>
            <h4>
              <span>2023-09-08 @ 17:01:02</span
              ><span class="points-container"
                >Points: <span class="points">1</span></span
              >
            </h4>
          </section>
        </section>
        <section id="37435656">
          <h3>
            <a
              class="item"
              href="https://apnews.com/article/spacex-starship-launch-accident-faa-a8d6cec63de579af4b6d5f040e51825d"
              >SpaceX can't launch its giant rocket again until fixes are made,
              FAA says</a
            >
          </h3>
          <section>
            <h4>
              <span>2023-09-08 @ 16:19:12</span
              ><span class="points-container"
                >Points: <span class="points">42</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=37435656"
                  >Comments</a
                ><span class="descendants">: 20</span></span
              >
            </h4>
          </section>
        </section>
        <section id="37435515">
          <h3>
            <a class="item" href="https://bitbashing.io/async-rust.html"
              >Maybe Rust isn’t a good tool for massively concurrent, userspace
              software</a
            >
          </h3>
          <section>
            <h4>
              <span>2023-09-08 @ 16:10:55</span
              ><span class="points-container"
                >Points: <span class="points">191</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=37435515"
                  >Comments</a
                ><span class="descendants">: 124</span></span
              >
            </h4>
          </section>
        </section>
        <section id="37435454">
          <h3>
            <a
              class="item"
              href="https://heatmap.news/economy/heirloom-carbon-microsoft-removal"
              >Microsoft’s Remarkably Big Bet on Carbon-Absorbing Rocks</a
            >
          </h3>
          <section>
            <h4>
              <span>2023-09-08 @ 16:06:37</span
              ><span class="points-container"
                >Points: <span class="points">50</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=37435454"
                  >Comments</a
                ><span class="descendants">: 23</span></span
              >
            </h4>
          </section>
        </section>
        <section id="37435450">
          <h3>
            <a
              class="item"
              href="https://gist.github.com/osy/45e612345376a65c56d0678834535166"
              >TPM provides zero practical security</a
            >
          </h3>
          <section>
            <h4>
              <span>2023-09-08 @ 16:06:24</span
              ><span class="points-container"
                >Points: <span class="points">15</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=37435450"
                  >Comments</a
                ><span class="descendants">: 2</span></span
              >
            </h4>
          </section>
        </section>
        <section id="37435215">
          <h3>
            <a
              class="item"
              href="https://www.ecu.edu.au/newsroom/articles/research/move-over-lithium-ion-zinc-air-batteries-a-cheaper-and-safer-alternative"
              >Move over lithium-ion: Zinc-air batteries a cheaper and safer
              alternative</a
            >
          </h3>
          <section>
            <h4>
              <span>2023-09-08 @ 15:49:56</span
              ><span class="points-container"
                >Points: <span class="points">35</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=37435215"
                  >Comments</a
                ><span class="descendants">: 24</span></span
              >
            </h4>
          </section>
        </section>
        <section id="37434918">
          <h3>
            <a class="item" href="https://procreate.com/dreams"
              >Procreate Dreams</a
            >
          </h3>
          <section>
            <h4>
              <span>2023-09-08 @ 15:32:57</span
              ><span class="points-container"
                >Points: <span class="points">161</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=37434918"
                  >Comments</a
                ><span class="descendants">: 56</span></span
              >
            </h4>
          </section>
        </section>
        <section id="37434381">
          <h3>
            <a
              class="item"
              href="https://www.birmingham.ac.uk/news/2023/bees-struggle-to-find-flowers-because-of-air-pollution"
              >Bees struggle to find flowers because of air pollution</a
            >
          </h3>
          <section>
            <h4>
              <span>2023-09-08 @ 14:59:13</span
              ><span class="points-container"
                >Points: <span class="points">122</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=37434381"
                  >Comments</a
                ><span class="descendants">: 24</span></span
              >
            </h4>
          </section>
        </section>
        <section id="37434117">
          <h3>
            <a
              class="item"
              href="https://github.com/oven-sh/bun/releases/tag/bun-v1.0.0"
              >Bun v1.0.0</a
            >
          </h3>
          <section>
            <h4>
              <span>2023-09-08 @ 14:41:03</span
              ><span class="points-container"
                >Points: <span class="points">274</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=37434117"
                  >Comments</a
                ><span class="descendants">: 106</span></span
              >
            </h4>
          </section>
        </section>
        <section id="37434069">
          <h3>
            <a class="item" href="https://arxiv.org/abs/2309.03409"
              >Large Language Models as Optimizers. +50% on Big Bench Hard</a
            >
          </h3>
          <section>
            <h4>
              <span>2023-09-08 @ 14:37:30</span
              ><span class="points-container"
                >Points: <span class="points">44</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=37434069"
                  >Comments</a
                ><span class="descendants">: 9</span></span
              >
            </h4>
          </section>
        </section>
        <section id="37433743">
          <h3>
            <a
              class="item"
              href="https://about.honywen.com/publication/2023ase/#"
              >A Study of Malicious Code in PyPI Ecosystem</a
            >
          </h3>
          <section>
            <h4>
              <span>2023-09-08 @ 14:12:27</span
              ><span class="points-container"
                >Points: <span class="points">22</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=37433743"
                  >Comments</a
                ><span class="descendants">: 14</span></span
              >
            </h4>
          </section>
        </section>
        <section id="37433523">
          <h3>
            <a class="item" href="https://emoji.fly.dev"
              >Emoji Generator with AI</a
            >
          </h3>
          <section>
            <h4>
              <span>2023-09-08 @ 13:54:13</span
              ><span class="points-container"
                >Points: <span class="points">184</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=37433523"
                  >Comments</a
                ><span class="descendants">: 81</span></span
              >
            </h4>
          </section>
        </section>
        <section id="37433515">
          <h3>
            <a
              class="item"
              href="https://www.we-find-wildness.com/2011/08/ken-isaacs-how-to-build-your-own-living-structures/"
              >How to build your own living structures (1974, 2011)</a
            >
          </h3>
          <section>
            <h4>
              <span>2023-09-08 @ 13:53:51</span
              ><span class="points-container"
                >Points: <span class="points">15</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=37433515"
                  >Comments</a
                ><span class="descendants">: 6</span></span
              >
            </h4>
          </section>
        </section>
        <section id="37433495">
          <h3>
            <a
              class="item"
              href="https://growth.design/case-studies/apple-privacy-policy"
              >Apple vs. Meta: The Illusion of Privacy</a
            >
          </h3>
          <section>
            <h4>
              <span>2023-09-08 @ 13:52:36</span
              ><span class="points-container"
                >Points: <span class="points">255</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=37433495"
                  >Comments</a
                ><span class="descendants">: 204</span></span
              >
            </h4>
          </section>
        </section>
        <section id="37433380">
          <h3>
            <a class="item" href="https://www.h2fly.de/"
              >H2Fly – Breaking the Hydrogen Barrier</a
            >
          </h3>
          <section>
            <h4>
              <span>2023-09-08 @ 13:42:42</span
              ><span class="points-container"
                >Points: <span class="points">17</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=37433380"
                  >Comments</a
                ><span class="descendants">: 12</span></span
              >
            </h4>
          </section>
        </section>
        <section id="37433218">
          <h3>
            <a class="item" href="https://rivet.ironcladapp.com/"
              >Show HN: Rivet – open-source AI Agent dev env with real-world
              applications</a
            >
          </h3>
          <section>
            <h4>
              <span>2023-09-08 @ 13:29:05</span
              ><span class="points-container"
                >Points: <span class="points">77</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=37433218"
                  >Comments</a
                ><span class="descendants">: 17</span></span
              >
            </h4>
            <div class="text">
              <p>
                Backstory: A few months ago, inspired by things like LangChain
                and LlamaIndex, we started building an AI agent that could work
                with legal contracts. Unfortunately, we couldn't just use
                retrieval augmented generation (RAG), because a lot of contracts
                are basically identical (many chunks with near-identical
                embeddings), except for a few key details. So, we turned to
                things like ReAct and AutoGPT for inspiration.
              </p>
              <p>
                At first, things went great. We were adding agent capabilities,
                doing chain-of-thought prompting.
              </p>
              <p>But then we hit a wall.</p>
              <p>
                The agent became too complex. We had debugger breakpoints on
                almost every line of code, but we still had no idea where the
                agent was breaking. Every change we made destabilized something
                else. After two weeks of fumbling, I decided to end the project.
              </p>
              <p>But one of my teammates, Andy, didn't give up.</p>
              <p>
                The following week, he showed me v0 of Rivet. He'd used it to
                refactor and improve our existing agent. I was skeptical... it
                just seemed like a visual programming environment, and I was not
                a fan. But I gave it a shot, and suddenly found myself able to
                add new skills to the agent, debug brittle areas with ease, and
                update prompts with confidence.
              </p>
              <p>
                Rivet is a game-changer. And more than that, it makes building
                with LLMs super fun.
              </p>
              <p>What exactly makes it different?</p>
              <p>
                First, the debugger is incredible. You have to experience it to
                believe it. You can update a graph, and then immediately run it,
                and see where it succeeded or failed. Even better: you can
                attach Rivet as a remote debugger, and watch your agent graphs
                execute in your app.
              </p>
              <p>
                Second, visual programming is actually a game-changer for
                prompting LLMs. I don't know why exactly, but it's way easier to
                understand and organize your work when you have an extra
                dimension to work with.
              </p>
              <p>
                Finally, Rivet is built to be embedded into a larger application
                (TypeScript for now, but we've also found a way to run it in
                Python). Beyond importing Rivet as a dependency, you can also
                define "external functions" dynamically at run-time. It feels
                pretty sketchy to give a LLM a key and unfettered access to an
                API. With Rivet, you can give it access to a specific set of
                defined functions, potentially pre-scoped to the access level
                you want.
              </p>
              <p>
                ...Sorry that was long. If you read this whole thing, thank you!
              </p>
              <p>
                We're really excited to hear what you think! We just launched
                our first Rivet-based application at Ironclad, and we've been
                working with companies like Sourcegraph, Attentive, AssemblyAI,
                Bento, and Willow to make Rivet useful for others.
              </p>
            </div>
          </section>
        </section>
        <section id="37433186">
          <h3>
            <a class="item" href="https://mtlynch.io/aardvarkd/"
              >Aardvark'd: The Fog Creek Documentary, 18 Years Later</a
            >
          </h3>
          <section>
            <h4>
              <span>2023-09-08 @ 13:26:45</span
              ><span class="points-container"
                >Points: <span class="points">152</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=37433186"
                  >Comments</a
                ><span class="descendants">: 40</span></span
              >
            </h4>
          </section>
        </section>
        <section id="37433036">
          <h3>
            <a
              class="item"
              href="https://www.techdirt.com/2023/09/08/fcc-proposes-voluntary-security-labels-for-internet-of-things-devices-most-companies-will-probably-ignore/"
              >FCC Proposes Voluntary Security Labels for IoT Most Companies
              Will Likely Ignore</a
            >
          </h3>
          <section>
            <h4>
              <span>2023-09-08 @ 13:13:07</span
              ><span class="points-container"
                >Points: <span class="points">65</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=37433036"
                  >Comments</a
                ><span class="descendants">: 42</span></span
              >
            </h4>
          </section>
        </section>
        <section id="37432948">
          <h3>
            <a
              class="item"
              href="https://www.theregister.com/2023/09/08/tsmc_ai_chip_crunch/"
              >TSMC warns AI chip crunch will last another 18 months</a
            >
          </h3>
          <section>
            <h4>
              <span>2023-09-08 @ 13:03:32</span
              ><span class="points-container"
                >Points: <span class="points">102</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=37432948"
                  >Comments</a
                ><span class="descendants">: 55</span></span
              >
            </h4>
          </section>
        </section>
        <section id="37431644">
          <h3>
            <a class="item" href="http://touchpianist.com/">Touch Pianist</a>
          </h3>
          <section>
            <h4>
              <span>2023-09-08 @ 09:56:08</span
              ><span class="points-container"
                >Points: <span class="points">429</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=37431644"
                  >Comments</a
                ><span class="descendants">: 140</span></span
              >
            </h4>
          </section>
        </section>
        <section id="37431560">
          <h3>
            <a
              class="item"
              href="https://jpcamara.com/2023/04/12/pgbouncer-is-useful.html"
              >PgBouncer is useful, important, and fraught with peril</a
            >
          </h3>
          <section>
            <h4>
              <span>2023-09-08 @ 09:43:22</span
              ><span class="points-container"
                >Points: <span class="points">119</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=37431560"
                  >Comments</a
                ><span class="descendants">: 48</span></span
              >
            </h4>
          </section>
        </section>
        <section id="37430759">
          <h3>
            <a
              class="item"
              href="https://oscarbenjamin.github.io/blog/czi/post1.html"
              >Towards a New SymPy</a
            >
          </h3>
          <section>
            <h4>
              <span>2023-09-08 @ 07:50:49</span
              ><span class="points-container"
                >Points: <span class="points">54</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=37430759"
                  >Comments</a
                ><span class="descendants">: 23</span></span
              >
            </h4>
          </section>
        </section>
        <section id="37428937">
          <h3>
            <a
              class="item"
              href="https://journals.sagepub.com/doi/epub/10.1177/09637214221121570"
              >Critical ignoring as a core competence for digital citizens
              (2022)</a
            >
          </h3>
          <section>
            <h4>
              <span>2023-09-08 @ 03:36:11</span
              ><span class="points-container"
                >Points: <span class="points">81</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=37428937"
                  >Comments</a
                ><span class="descendants">: 46</span></span
              >
            </h4>
          </section>
        </section>
        <section id="37426107">
          <h3>
            <a
              class="item"
              href="https://www.robinsloan.com/newsletters/what-would-a-wizard-read/#walking"
              >The thinking path</a
            >
          </h3>
          <section>
            <h4>
              <span>2023-09-07 @ 21:52:02</span
              ><span class="points-container"
                >Points: <span class="points">84</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=37426107"
                  >Comments</a
                ><span class="descendants">: 16</span></span
              >
            </h4>
          </section>
        </section>
        <section id="37425052">
          <h3>
            <a
              class="item"
              href="https://phys.org/news/2023-08-china-ancient-pipe-networks-communal.html"
              >China's ancient water pipe networks show no evidence of a
              centralized authority</a
            >
          </h3>
          <section>
            <h4>
              <span>2023-09-07 @ 20:25:09</span
              ><span class="points-container"
                >Points: <span class="points">192</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=37425052"
                  >Comments</a
                ><span class="descendants">: 119</span></span
              >
            </h4>
          </section>
        </section>
        <section id="37425007">
          <h3>
            <a
              class="item"
              href="https://citizenlab.ca/2023/09/blastpass-nso-group-iphone-zero-click-zero-day-exploit-captured-in-the-wild/"
              >NSO group iPhone zero-click, zero-day exploit captured in the
              wild</a
            >
          </h3>
          <section>
            <h4>
              <span>2023-09-07 @ 20:21:01</span
              ><span class="points-container"
                >Points: <span class="points">1325</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=37425007"
                  >Comments</a
                ><span class="descendants">: 730</span></span
              >
            </h4>
          </section>
        </section>
        <section id="37416999">
          <h3>
            <a
              class="item"
              href="http://www.ws.binghamton.edu/fridrich/cube.html"
              >My speed cubing page</a
            >
          </h3>
          <section>
            <h4>
              <span>2023-09-07 @ 10:33:33</span
              ><span class="points-container"
                >Points: <span class="points">91</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=37416999"
                  >Comments</a
                ><span class="descendants">: 41</span></span
              >
            </h4>
          </section>
        </section>
        <section id="37415494">
          <h3>
            <a class="item" href="https://howqueryengineswork.com/"
              >How Query Engines Work</a
            >
          </h3>
          <section>
            <h4>
              <span>2023-09-07 @ 06:38:55</span
              ><span class="points-container"
                >Points: <span class="points">244</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=37415494"
                  >Comments</a
                ><span class="descendants">: 41</span></span
              >
            </h4>
          </section>
        </section>
        <section id="37412834">
          <h3>
            <a
              class="item"
              href="https://www.nature.com/articles/s41586-023-06502-w"
              >Specialized astrocytes mediate glutamatergic gliotransmission in
              the CNS</a
            >
          </h3>
          <section>
            <h4>
              <span>2023-09-06 @ 23:33:09</span
              ><span class="points-container"
                >Points: <span class="points">8</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=37412834"
                  >Comments</a
                ><span class="descendants">: 1</span></span
              >
            </h4>
          </section>
        </section>
      </section>
      <section id="archives">
        <h2>
          <a
            href="https://github.com/kherrick/hacker-news/blob/main/archives/index.md"
            >Archives</a
          >
        </h2>
        <section>
          <h3>
            <a
              href="https://github.com/kherrick/hacker-news/blob/main/archives/2023/index.md"
              >2023</a
            >
          </h3>
        </section>
        <section>
          <h3>
            <a
              href="https://github.com/kherrick/hacker-news/blob/main/archives/2022/index.md"
              >2022</a
            >
          </h3>
        </section>
      </section>
    </main>
    <script type="module">
      import { buildDescendants } from "./lib/build-html-descendants.js";
      import { buildNextItem } from "./lib/build-html-next-item.js";
      import { getNextDateTime } from "./lib/date-time.js";

      const updateSectionById = (id) =>
        fetch(`https://hacker-news.firebaseio.com/v0/item/${id}.json`).then(
          (result) =>
            result.json().then(({ descendants, id, score, text, type }) => {
              const currentItem = document.getElementById(id);

              if (score) {
                currentItem.querySelector(".points").textContent = score;
              }

              if (descendants && (type === "poll" || type === "story")) {
                const currentDescendants =
                  currentItem.querySelector(".descendants");

                if (currentDescendants) {
                  currentDescendants.textContent = `: ${descendants}`;
                } else {
                  const comments = buildDescendants(
                    document,
                    descendants,
                    `https://news.ycombinator.com/item?id=${id}`
                  );

                  currentItem.querySelector("h4").appendChild(comments);
                }
              }

              if (text) {
                const currentText = currentItem.querySelector(".text");

                if (currentText) {
                  currentText.innerHTML = text.replace(/\0/g, "");
                } else {
                  const content = document.createElement("div");
                  content.innerHTML = text.replace(/\0/g, "");
                  content.setAttribute("class", "text");

                  currentItem.appendChild(content);
                }
              }
            })
        );

      class UpdateQueue {
        constructor() {
          this._ids = [];
          this._isUpdating = false;
        }

        addItemById(id) {
          this._ids.push(id);
        }

        async flush() {
          const id = this._ids.shift();

          if (id) {
            this._isUpdating = true;

            await updateSectionById(id);
            await this.flush();
          } else {
            this._isUpdating = false;

            setTimeout(async () => {
              if (!this._isUpdating && this._ids && this._ids.length) {
                await this.flush();
              }
            }, 0);
          }
        }
      }

      // get latest data
      const latestSection = document.getElementById("latest");

      for (let item of latestSection.querySelectorAll("section[id]")) {
        updateSectionById(item.getAttribute("id"));
      }

      if ("IntersectionObserver" in window) {
        window.hackerNewsState = { index: [], nextTimeIndex: -1 };

        const addNewsItem = async (newsItem, queue) => {
          try {
            const { date, time, itemComments, itemTitle, itemLink } = newsItem;
            const section = await buildNextItem({
              document,
              dateTime: `${date}, ${time}`,
              itemComments,
              itemLink,
              itemTitle: new DOMParser().parseFromString(
                itemTitle.replace(/\\/g, ""),
                "text/html"
              ).documentElement.textContent,
              fetchItemDetails: false,
            });

            // display loading indicator for section
            section.querySelector(".points-container").innerHTML =
              'Points: <span class="points"><img style="height: 100%;" src="lib/images/loading.svg" /></span>';

            const id = section.getAttribute("id");
            if (!document.getElementById(id)) {
              document.getElementById("latest").appendChild(section);

              queue.addItemById(id);
            }
          } catch (error) {}
        };

        const buildArchiveIndex = async (lastDateTime) => {
          const nextDate = lastDateTime.slice(0, 10);
          const nextYear = nextDate.slice(0, 4);

          return (
            await (
              await fetch(
                `https://raw.githubusercontent.com/kherrick/hacker-news/main/archives/${nextYear}/${nextDate}/index.md`
              )
            ).text()
          )
            .split("\n")
            .filter((line) => line.match(new RegExp("^\\* \\[")))
            .map((line) => {
              const segment = line.replace("* ", "").split("](");
              const pubDate = segment[0].slice(1);

              const itemComments = segment[1].split(") - [")[0];
              const itemTitle = segment[1].split(") - [")[1];
              const itemLink = segment[2].slice(0, -1);
              const date = pubDate.slice(0, 10);
              const time = pubDate.slice(-8);

              return {
                date,
                itemComments,
                itemLink,
                itemTitle,
                time,
              };
            });
        };

        const handleIntersectingEntry = async (entry, queue) => {
          if (entry.isIntersecting) {
            const lastDateTime = document
              .getElementById("latest")
              .querySelector(
                "section:last-child > section > h4 > span"
              ).textContent;

            const nextDateTime = getNextDateTime(lastDateTime ?? "", -1);
            const archiveIndex = await buildArchiveIndex(nextDateTime);
            const nextTimeIndex = archiveIndex.findIndex(
              ({ time }) => time === nextDateTime.slice(-8)
            );

            const handleIndexUpdate = (index, existingIndexValues = []) => {
              index.forEach((i) => {
                existingIndexValues.push(i);
              });
              return existingIndexValues;
            };

            window.hackerNewsState = {
              index: handleIndexUpdate(
                archiveIndex,
                window.hackerNewsState.index
              ),
              nextTimeIndex,
            };

            let currentTimeIndex = nextTimeIndex + 1;
            const items = Object.values(window.hackerNewsState.index);
            for (let item of items) {
              if (currentTimeIndex < window.hackerNewsState.index.length) {
                addNewsItem(items[currentTimeIndex], queue);

                currentTimeIndex = currentTimeIndex + 1;
              }
            }

            queue.flush();
          }
        };

        const archives = document.getElementById("archives");
        const archivesObserver = new IntersectionObserver(
          (entries) => {
            const queue = new UpdateQueue();

            entries.forEach((entry) => handleIntersectingEntry(entry, queue));
          },
          {
            root: null,
            rootMargin: "0px",
            threshold: 0,
          }
        );

        archivesObserver.observe(archives);

        let latestSectionsExpanded = true;
        const handleLatestHeaderClick = () => {
          latestSectionsExpanded = !latestSectionsExpanded;

          if (latestSectionsExpanded) {
            archivesObserver.observe(archives);
          } else {
            archivesObserver.disconnect(archives);
          }

          for (let section of document.querySelectorAll("#latest > section")) {
            section.style.display = latestSectionsExpanded ? "block" : "none";
          }
        };

        const latestHeader = document.querySelector("#latest > h2");
        latestHeader.style.cursor = "pointer";
        latestHeader.addEventListener("click", handleLatestHeaderClick);
      }
    </script>
    <script type="module">
      import { Workbox } from "https://storage.googleapis.com/workbox-cdn/releases/6.4.1/workbox-window.prod.mjs";

      if ("serviceWorker" in navigator) {
        const base = document.querySelector("base");
        const serviceWorkerPath = `${
          base ? base.href.replace(/\/$/, "") : ""
        }/service-worker.js`;

        const wb = new Workbox(serviceWorkerPath);

        // setup event listeners
        wb.addEventListener("waiting", (event) => {
          wb.addEventListener("controlling", () => {
            window.location.reload();
          });

          wb.messageSkipWaiting();
        });

        wb.register();
      }
    </script>
  </body>
</html>
