<!DOCTYPE html>
<html lang="en" xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta charset="utf-8" />
    <meta
      content="width=device-width, initial-scale=1.0, viewport-fit=cover"
      name="viewport"
    />
    <meta name="description" content="Hacker News" />
    <meta name="theme-color" content="#fff" />
    <title>Hacker News</title>
    <link rel="manifest" href="manifest.json" />
    <link
      href="data:image/x-icon;base64,AAABAAEAAQECAAEAAQA4AAAAFgAAACgAAAABAAAAAgAAAAEAAQAAAAAAAAAAAAAAAAAAAAAAAAAAAAABAAEAAQECAAEAAQA4AAAAFgAAACgAAAABAAAAAgAAAAEAAQAAAAAAAAAAAAAAAAAAAAAAAAAA"
      rel="icon"
      type="image/x-icon"
    />
    <link
      href="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAgAAAAIAAQMAAADOtka5AAAAA1BMVEUAAACnej3aAAAANklEQVR42u3BAQEAAACCIP+vbkhAAQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAB8G4IAAAFjdVCkAAAAAElFTkSuQmCC"
      rel="apple-touch-icon"
    />
    <style>
      /*<!--*/
      body {
        color: rgb(25, 25, 25);
        font-family: Verdana, Geneva, sans-serif;
        margin: 0;
      }

      a {
        text-decoration: none;
      }

      a:link,
      a:focus,
      a:hover,
      a:active {
        color: rgb(75, 75, 125);
      }

      a:visited {
        color: rgb(25, 25, 25);
      }

      h1 > a,
      h1 > a:link,
      h1 > a:focus,
      h1 > a:hover,
      h1 > a:active,
      h1 > a:visited,
      h2 > a,
      h2 > a:link,
      h2 > a:focus,
      h2 > a:hover,
      h2 > a:active,
      h2 > a:visited {
        color: rgb(25, 25, 25);
      }

      h1 {
        background-color: rgb(255, 102, 0);
        margin: 0;
        padding: 1rem;
      }

      h2 {
        background-color: rgb(200, 200, 200);
        margin: 1rem 0;
        padding: 0.5rem 0.5rem 0.5rem 1rem;
      }

      #latest > section,
      #archives > section {
        margin: 0 1rem 1rem 1rem;
        padding-bottom: 1rem;
      }

      #latest > section:not(:last-child),
      #archives > section:not(:last-child) {
        border-bottom: 1px dotted rgb(200, 200, 200);
      }

      section > h3 {
        margin: 0 0 0.5rem 0;
      }

      section > h4 {
        font-weight: normal;
        margin: 0 0 0 1rem;
      }

      .descendants-container,
      .points-container {
        align-items: center;
        border-left: 1px solid #333;
        display: inline-flex;
        margin-left: 0.5rem;
        padding-left: 0.5rem;
        text-align: center;
      }

      .points {
        align-items: center;
        display: inline-flex;
        height: 1rem;
        margin-left: 1ch;
        min-width: 3ch;
      }

      .text {
        line-height: 1.5rem;
        margin: 1rem 1rem 0 1rem;
        overflow: auto;
      }

      .text > p:first-child {
        margin-top: 1rem;
      }

      .text > p:last-child {
        margin-bottom: 0;
      }
      /*-->*/
    </style>
  </head>

  <body>
    <main>
      <h1><a href="https://kherrick.github.io/hacker-news/">Hacker News</a></h1>
      <section id="latest">
        <h2>Latest</h2>
        <section id="43957481">
          <h3>
            <a
              class="item"
              href="https://www.thecooldown.com/green-tech/biomass-satellite-carbon-capture-forests/"
              >Satellite will have to be turned off when it floats over the
              US</a
            >
          </h3>
          <section>
            <h4>
              <span>2025-05-11 @ 21:54:40</span
              ><span class="points-container"
                >Points: <span class="points">10</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=43957481"
                  >Comments</a
                ><span class="descendants">: 10</span></span
              >
            </h4>
          </section>
        </section>
        <section id="43957231">
          <h3>
            <a
              class="item"
              href="https://www.thetimes.com/sport/formula-one/article/professor-martin-elliott-interview-surgeon-f1-pitstops-babies-ferrari-j3sbkjssk"
              >The surgeon who used F1 pitstop techniques to save lives of
              babies</a
            >
          </h3>
          <section>
            <h4>
              <span>2025-05-11 @ 21:15:56</span
              ><span class="points-container"
                >Points: <span class="points">18</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=43957231"
                  >Comments</a
                ><span class="descendants">: 0</span></span
              >
            </h4>
          </section>
        </section>
        <section id="43957010">
          <h3>
            <a
              class="item"
              href="https://1517.substack.com/p/why-bell-labs-worked"
              >Why Bell Labs Worked</a
            >
          </h3>
          <section>
            <h4>
              <span>2025-05-11 @ 20:47:20</span
              ><span class="points-container"
                >Points: <span class="points">36</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=43957010"
                  >Comments</a
                ><span class="descendants">: 15</span></span
              >
            </h4>
          </section>
        </section>
        <section id="43956115">
          <h3>
            <a
              class="item"
              href="https://news.wm.edu/2025/05/06/2024-sea-level-report-cards-map-futures-of-u-s-coastal-communities/"
              >2024 sea level 'report cards' map futures of U.S. coastal
              communities</a
            >
          </h3>
          <section>
            <h4>
              <span>2025-05-11 @ 18:59:47</span
              ><span class="points-container"
                >Points: <span class="points">84</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=43956115"
                  >Comments</a
                ><span class="descendants">: 72</span></span
              >
            </h4>
          </section>
        </section>
        <section id="43956095">
          <h3>
            <a
              class="item"
              href="https://blog.plan99.net/why-not-capability-languages-a8e6cbdf9682"
              >Why not object capability languages?</a
            >
          </h3>
          <section>
            <h4>
              <span>2025-05-11 @ 18:57:07</span
              ><span class="points-container"
                >Points: <span class="points">40</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=43956095"
                  >Comments</a
                ><span class="descendants">: 13</span></span
              >
            </h4>
          </section>
        </section>
        <section id="43955842">
          <h3>
            <a class="item" href="https://github.com/jaypyles/Scraperr"
              >Scraperr – A Self Hosted Webscraper</a
            >
          </h3>
          <section>
            <h4>
              <span>2025-05-11 @ 18:29:18</span
              ><span class="points-container"
                >Points: <span class="points">60</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=43955842"
                  >Comments</a
                ><span class="descendants">: 14</span></span
              >
            </h4>
          </section>
        </section>
        <section id="43955525">
          <h3>
            <a
              class="item"
              href="https://insideevs.com/features/759153/car-companies-software-companies/"
              >Car companies are in a billion-dollar software war</a
            >
          </h3>
          <section>
            <h4>
              <span>2025-05-11 @ 17:51:04</span
              ><span class="points-container"
                >Points: <span class="points">126</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=43955525"
                  >Comments</a
                ><span class="descendants">: 206</span></span
              >
            </h4>
          </section>
        </section>
        <section id="43955397">
          <h3>
            <a
              class="item"
              href="https://vlaaad.github.io/lsp-client-in-200-lines-of-code"
              >LSP client in Clojure in 200 lines of code</a
            >
          </h3>
          <section>
            <h4>
              <span>2025-05-11 @ 17:38:38</span
              ><span class="points-container"
                >Points: <span class="points">61</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=43955397"
                  >Comments</a
                ><span class="descendants">: 0</span></span
              >
            </h4>
          </section>
        </section>
        <section id="43955374">
          <h3>
            <a
              class="item"
              href="https://www.customerexperiencedive.com/news/klarna-reinvests-human-talent-customer-service-AI-chatbot/747586/"
              >Klarna changes its AI tune and again recruits humans for customer
              service</a
            >
          </h3>
          <section>
            <h4>
              <span>2025-05-11 @ 17:35:22</span
              ><span class="points-container"
                >Points: <span class="points">150</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=43955374"
                  >Comments</a
                ><span class="descendants">: 67</span></span
              >
            </h4>
          </section>
        </section>
        <section id="43955333">
          <h3>
            <a class="item" href="https://glitchgallery.org/"
              >An online exhibition of pretty software bugs</a
            >
          </h3>
          <section>
            <h4>
              <span>2025-05-11 @ 17:29:16</span
              ><span class="points-container"
                >Points: <span class="points">42</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=43955333"
                  >Comments</a
                ><span class="descendants">: 1</span></span
              >
            </h4>
          </section>
        </section>
        <section id="43955326">
          <h3>
            <a
              class="item"
              href="http://pmaweb.caltech.edu/Courses/ph136/yr2012/"
              >Applications of Classical Physics</a
            >
          </h3>
          <section>
            <h4>
              <span>2025-05-11 @ 17:28:32</span
              ><span class="points-container"
                >Points: <span class="points">62</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=43955326"
                  >Comments</a
                ><span class="descendants">: 21</span></span
              >
            </h4>
          </section>
        </section>
        <section id="43955106">
          <h3>
            <a
              class="item"
              href="https://www.ycombinator.com/companies/synder/jobs/2Wnbc1f-business-development-representative"
              >Synder (YC S21) Is Hiring</a
            >
          </h3>
          <section>
            <h4>
              <span>2025-05-11 @ 17:00:00</span
              ><span class="points-container"
                >Points: <span class="points">1</span></span
              >
            </h4>
          </section>
        </section>
        <section id="43954896">
          <h3>
            <a class="item" href="https://plainvanillaweb.com/index.html"
              >Plain Vanilla Web</a
            >
          </h3>
          <section>
            <h4>
              <span>2025-05-11 @ 16:31:58</span
              ><span class="points-container"
                >Points: <span class="points">506</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=43954896"
                  >Comments</a
                ><span class="descendants">: 277</span></span
              >
            </h4>
          </section>
        </section>
        <section id="43954649">
          <h3>
            <a class="item" href="https://github.com/Efeckc17/simple-todo-c"
              >I built a native Windows Todo app in pure C (278 KB, no
              frameworks)</a
            >
          </h3>
          <section>
            <h4>
              <span>2025-05-11 @ 15:57:39</span
              ><span class="points-container"
                >Points: <span class="points">218</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=43954649"
                  >Comments</a
                ><span class="descendants">: 118</span></span
              >
            </h4>
          </section>
        </section>
        <section id="43954488">
          <h3>
            <a
              class="item"
              href="https://www.wsj.com/lifestyle/careers/skilled-trades-high-school-recruitment-fd9f8257"
              >High-school shop students attract skilled-trades job offers</a
            >
          </h3>
          <section>
            <h4>
              <span>2025-05-11 @ 15:31:39</span
              ><span class="points-container"
                >Points: <span class="points">96</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=43954488"
                  >Comments</a
                ><span class="descendants">: 136</span></span
              >
            </h4>
          </section>
        </section>
        <section id="43954459">
          <h3>
            <a
              class="item"
              href="https://torrentfreak.com/dns-piracy-blocking-orders-google-cloudflare-and-opendns-respond-differently-250511/"
              >DNS piracy blocking orders: Google, Cloudflare, and OpenDNS
              respond differently</a
            >
          </h3>
          <section>
            <h4>
              <span>2025-05-11 @ 15:26:47</span
              ><span class="points-container"
                >Points: <span class="points">143</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=43954459"
                  >Comments</a
                ><span class="descendants">: 128</span></span
              >
            </h4>
          </section>
        </section>
        <section id="43954249">
          <h3>
            <a
              class="item"
              href="https://en.wikipedia.org/wiki/Gonzalo_Guerrero"
              >Gonzalo Guerrero</a
            >
          </h3>
          <section>
            <h4>
              <span>2025-05-11 @ 14:54:56</span
              ><span class="points-container"
                >Points: <span class="points">73</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=43954249"
                  >Comments</a
                ><span class="descendants">: 22</span></span
              >
            </h4>
          </section>
        </section>
        <section id="43954178">
          <h3>
            <a class="item" href="https://openjdk.org/jeps/515"
              >JEP 515: Ahead-of-Time Method Profiling</a
            >
          </h3>
          <section>
            <h4>
              <span>2025-05-11 @ 14:43:09</span
              ><span class="points-container"
                >Points: <span class="points">82</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=43954178"
                  >Comments</a
                ><span class="descendants">: 5</span></span
              >
            </h4>
          </section>
        </section>
        <section id="43954054">
          <h3>
            <a
              class="item"
              href="https://pfister.dev/blog/2025/rp2350-uart-bl.html"
              >Booting the RP2350 from UART</a
            >
          </h3>
          <section>
            <h4>
              <span>2025-05-11 @ 14:26:49</span
              ><span class="points-container"
                >Points: <span class="points">45</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=43954054"
                  >Comments</a
                ><span class="descendants">: 2</span></span
              >
            </h4>
          </section>
        </section>
        <section id="43953883">
          <h3>
            <a
              class="item"
              href="https://www.finebooksmagazine.com/fine-books-news/title-work-deciphered-sealed-herculaneum-scroll-digital-unwrapping"
              >Title of work deciphered in sealed Herculaneum scroll via digital
              unwrapping</a
            >
          </h3>
          <section>
            <h4>
              <span>2025-05-11 @ 14:02:03</span
              ><span class="points-container"
                >Points: <span class="points">164</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=43953883"
                  >Comments</a
                ><span class="descendants">: 66</span></span
              >
            </h4>
          </section>
        </section>
        <section id="43953722">
          <h3>
            <a class="item" href="https://github.com/glassflow/clickhouse-etl"
              >Show HN: GlassFlow – OSS streaming dedup and joins from Kafka to
              ClickHouse</a
            >
          </h3>
          <section>
            <h4>
              <span>2025-05-11 @ 13:33:54</span
              ><span class="points-container"
                >Points: <span class="points">63</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=43953722"
                  >Comments</a
                ><span class="descendants">: 27</span></span
              >
            </h4>
            <div class="text">
              <a href="https://github.com/glassflow/clickhouse-etl"
                >https://github.com/glassflow/clickhouse-etl</a
              >
              <p>
                Why we built this: Dedup with batch data is straightforward. You
                load the data into a temporary table. Then, find only the latest
                versions of the record through hashes or keys and keep them.
                After that, move the clean data into your main table. But have
                you tried this with streaming data? Users of our prev product
                were running real-time analytics pipelines from Kafka to
                ClickHouse and noticed that the analyses were wrong due to
                duplicates. The source systems produced duplicates as they
                ingested similar user data from CRMs, shop systems and click
                streams.
              </p>
              <p>
                We wanted to solve this issue for them with the existing
                ClickHouse options, but ClickHouse ReplacingMergeTree has an
                uncontrollable background merging process. This means the new
                data is in the system, but you never know when they’ll finish
                the merging, and until then, your queries return incorrect
                results.
              </p>
              <p>
                We looked into using FINAL but haven't been happy with the speed
                for real-time workloads.
              </p>
              <p>
                We tried Flink, but there is too much overhead to manage Java
                Flink jobs, and a self-built solution would have put us in a
                position to set up and maintain state storage, possibly a very
                large one (number of unique keys), to keep track of whether we
                have already encountered a record. And if your dedupe service
                fails, you need to rehydrate that state before processing new
                records. That would have been too much maintenance for us.
              </p>
              <p>
                We decided to solve it by building a new product and are excited
                to share it with you.
              </p>
              <p>
                The key difference is that the streams are deduplicated before
                ingesting to ClickHouse. So, ClickHouse always has clean data
                and less load, eliminating the risk of wrong results. We want
                more people to benefit from it and decided to open-source it
                (Apache-2.0).
              </p>
              <p>Main components:</p>
              <p>
                - Streaming deduplication: You define the deduplication key and
                a time window (up to 7 days), and it handles the checks in real
                time to avoid duplicates before hitting ClickHouse. The state
                store is built in.
              </p>
              <p>
                - Temporal Stream Joins: You can join two Kafka streams on the
                fly with a few config inputs. You set the join key, choose a
                time window (up to 7 days), and you're good.
              </p>
              <p>
                - Built-in Kafka source connector: There is no need to build
                custom consumers or manage polling logic. Just point it at your
                Kafka cluster, and it auto-subscribes to the topics you define.
                Payloads are parsed as JSON by default, so you get structured
                data immediately. As underlying tech, we decided on NATS to make
                it lightweight and low-latency.
              </p>
              <p>
                - ClickHouse sink: Data gets pushed into ClickHouse through a
                native connector optimized for performance. You can tweak batch
                sizes and flush intervals to match your throughput needs. It
                handles retries automatically, so you don't lose data on
                transient failures.
              </p>
              <p>
                We'd love to hear your feedback and know if you solved it nicely
                with existing tools. Thanks for reading!
              </p>
            </div>
          </section>
        </section>
        <section id="43952714">
          <h3>
            <a class="item" href="https://epochalypse-project.org/"
              >The Epochalypse Project</a
            >
          </h3>
          <section>
            <h4>
              <span>2025-05-11 @ 10:08:53</span
              ><span class="points-container"
                >Points: <span class="points">153</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=43952714"
                  >Comments</a
                ><span class="descendants">: 69</span></span
              >
            </h4>
          </section>
        </section>
        <section id="43952239">
          <h3>
            <a
              class="item"
              href="https://forums.swift.org/t/xtool-cross-platform-xcode-replacement-build-ios-apps-on-linux-and-more/79803"
              >Build iOS Apps on Linux and Windows (WSL)</a
            >
          </h3>
          <section>
            <h4>
              <span>2025-05-11 @ 08:10:38</span
              ><span class="points-container"
                >Points: <span class="points">156</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=43952239"
                  >Comments</a
                ><span class="descendants">: 13</span></span
              >
            </h4>
          </section>
        </section>
        <section id="43950976">
          <h3>
            <a class="item" href="https://www.airs.com/blog/archives/670"
              >Leaving Google</a
            >
          </h3>
          <section>
            <h4>
              <span>2025-05-11 @ 03:01:56</span
              ><span class="points-container"
                >Points: <span class="points">405</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=43950976"
                  >Comments</a
                ><span class="descendants">: 246</span></span
              >
            </h4>
          </section>
        </section>
        <section id="43933091">
          <h3>
            <a
              class="item"
              href="https://kyla.substack.com/p/the-most-valuable-commodity-in-the"
              >The most valuable commodity in the world is friction</a
            >
          </h3>
          <section>
            <h4>
              <span>2025-05-09 @ 01:45:16</span
              ><span class="points-container"
                >Points: <span class="points">147</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=43933091"
                  >Comments</a
                ><span class="descendants">: 70</span></span
              >
            </h4>
          </section>
        </section>
        <section id="43932871">
          <h3>
            <a
              class="item"
              href="https://kirancodes.me/posts/log-how-to-prove-it-maths.html"
              >How to (actually) prove it – New Frontiers of Mathematics and
              Computing in Lean</a
            >
          </h3>
          <section>
            <h4>
              <span>2025-05-09 @ 01:00:53</span
              ><span class="points-container"
                >Points: <span class="points">50</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=43932871"
                  >Comments</a
                ><span class="descendants">: 5</span></span
              >
            </h4>
          </section>
        </section>
        <section id="43931366">
          <h3>
            <a
              class="item"
              href="https://www.gilesthomas.com/2025/05/llm-from-scratch-13-taking-stock-part-1-attention-heads-are-dumb"
              >Writing an LLM from scratch, part 13 – attention heads are
              dumb</a
            >
          </h3>
          <section>
            <h4>
              <span>2025-05-08 @ 21:06:02</span
              ><span class="points-container"
                >Points: <span class="points">171</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=43931366"
                  >Comments</a
                ><span class="descendants">: 28</span></span
              >
            </h4>
          </section>
        </section>
        <section id="43925005">
          <h3>
            <a
              class="item"
              href="https://www.dash0.com/blog/monitoring-minecraft-with-opentelemetry"
              >Monitoring my Minecraft server with OpenTelemetry and
              Prometheus</a
            >
          </h3>
          <section>
            <h4>
              <span>2025-05-08 @ 11:03:14</span
              ><span class="points-container"
                >Points: <span class="points">13</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=43925005"
                  >Comments</a
                ><span class="descendants">: 1</span></span
              >
            </h4>
            <div class="text">
              My kids demand SLOs stricter than Moon exploration technology, so
              I had to monitor our family’s Minecraft server Minecraft server
              like a pro. As luck would have it, I am one.
            </div>
          </section>
        </section>
        <section id="43924560">
          <h3>
            <a
              class="item"
              href="https://rohangautam.github.io/blog/fast_sweeping/fastsweeping/"
              >SDFs and the Fast sweeping algorithm in Jax</a
            >
          </h3>
          <section>
            <h4>
              <span>2025-05-08 @ 09:32:57</span
              ><span class="points-container"
                >Points: <span class="points">11</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=43924560"
                  >Comments</a
                ><span class="descendants">: 0</span></span
              >
            </h4>
          </section>
        </section>
        <section id="43924178">
          <h3>
            <a class="item" href="https://penplotter.art/"
              >Ink and Algorithms: Techniques, tools and the craft of pen
              plotting</a
            >
          </h3>
          <section>
            <h4>
              <span>2025-05-08 @ 08:14:38</span
              ><span class="points-container"
                >Points: <span class="points">39</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=43924178"
                  >Comments</a
                ><span class="descendants">: 1</span></span
              >
            </h4>
          </section>
        </section>
      </section>
      <section id="archives">
        <h2>
          <a
            href="https://github.com/kherrick/hacker-news/blob/main/archives/index.md"
            >Archives</a
          >
        </h2>
        <section>
          <h3>
            <a
              href="https://github.com/kherrick/hacker-news/blob/main/archives/2025/index.md"
              >2025</a
            >
          </h3>
        </section>
        <section>
          <h3>
            <a
              href="https://github.com/kherrick/hacker-news/blob/main/archives/2024/index.md"
              >2024</a
            >
          </h3>
        </section>
        <section>
          <h3>
            <a
              href="https://github.com/kherrick/hacker-news/blob/main/archives/2023/index.md"
              >2023</a
            >
          </h3>
        </section>
        <section>
          <h3>
            <a
              href="https://github.com/kherrick/hacker-news/blob/main/archives/2022/index.md"
              >2022</a
            >
          </h3>
        </section>
      </section>
    </main>
    <script type="module">
      import { buildDescendants } from "./lib/build-html-descendants.js";
      import { buildNextItem } from "./lib/build-html-next-item.js";
      import { getNextDateTime } from "./lib/date-time.js";

      const updateSectionById = (id) =>
        fetch(`https://hacker-news.firebaseio.com/v0/item/${id}.json`).then(
          (result) =>
            result.json().then(({ descendants, id, score, text, type }) => {
              const currentItem = document.getElementById(id);

              if (score) {
                currentItem.querySelector(".points").textContent = score;
              }

              if (descendants && (type === "poll" || type === "story")) {
                const currentDescendants =
                  currentItem.querySelector(".descendants");

                if (currentDescendants) {
                  currentDescendants.textContent = `: ${descendants}`;
                } else {
                  const comments = buildDescendants(
                    document,
                    descendants,
                    `https://news.ycombinator.com/item?id=${id}`
                  );

                  currentItem.querySelector("h4").appendChild(comments);
                }
              }

              if (text) {
                const currentText = currentItem.querySelector(".text");

                if (currentText) {
                  currentText.innerHTML = text.replace(/\0/g, "");
                } else {
                  const content = document.createElement("div");
                  content.innerHTML = text.replace(/\0/g, "");
                  content.setAttribute("class", "text");

                  currentItem.appendChild(content);
                }
              }
            })
        );

      class UpdateQueue {
        constructor() {
          this._ids = [];
          this._isUpdating = false;
        }

        addItemById(id) {
          this._ids.push(id);
        }

        async flush() {
          const id = this._ids.shift();

          if (id) {
            this._isUpdating = true;

            await updateSectionById(id);
            await this.flush();
          } else {
            this._isUpdating = false;

            setTimeout(async () => {
              if (!this._isUpdating && this._ids && this._ids.length) {
                await this.flush();
              }
            }, 0);
          }
        }
      }

      // get latest data
      const latestSection = document.getElementById("latest");

      for (let item of latestSection.querySelectorAll("section[id]")) {
        updateSectionById(item.getAttribute("id"));
      }

      if ("IntersectionObserver" in window) {
        window.hackerNewsState = { index: [], nextTimeIndex: -1 };

        const addNewsItem = async (newsItem, queue) => {
          try {
            const { date, time, itemComments, itemTitle, itemLink } = newsItem;
            const section = await buildNextItem({
              document,
              dateTime: `${date}, ${time}`,
              itemComments,
              itemLink,
              itemTitle: new DOMParser().parseFromString(
                itemTitle.replace(/\\/g, ""),
                "text/html"
              ).documentElement.textContent,
              fetchItemDetails: false,
            });

            // display loading indicator for section
            section.querySelector(".points-container").innerHTML =
              'Points: <span class="points"><img style="height: 100%;" src="lib/images/loading.svg" /></span>';

            const id = section.getAttribute("id");
            if (!document.getElementById(id)) {
              document.getElementById("latest").appendChild(section);

              queue.addItemById(id);
            }
          } catch (error) {}
        };

        const buildArchiveIndex = async (lastDateTime) => {
          const nextDate = lastDateTime.slice(0, 10);
          const nextYear = nextDate.slice(0, 4);

          return (
            await (
              await fetch(
                `https://raw.githubusercontent.com/kherrick/hacker-news/main/archives/${nextYear}/${nextDate}/index.md`
              )
            ).text()
          )
            .split("\n")
            .filter((line) => line.match(new RegExp("^\\* \\[")))
            .map((line) => {
              const segment = line.replace("* ", "").split("](");
              const pubDate = segment[0].slice(1);

              const itemComments = segment[1].split(") - [")[0];
              const itemTitle = segment[1].split(") - [")[1];
              const itemLink = segment[2].slice(0, -1);
              const date = pubDate.slice(0, 10);
              const time = pubDate.slice(-8);

              return {
                date,
                itemComments,
                itemLink,
                itemTitle,
                time,
              };
            });
        };

        const handleIntersectingEntry = async (entry, queue) => {
          if (entry.isIntersecting) {
            const lastDateTime = document
              .getElementById("latest")
              .querySelector(
                "section:last-child > section > h4 > span"
              ).textContent;

            const nextDateTime = getNextDateTime(lastDateTime ?? "", -1);
            const archiveIndex = await buildArchiveIndex(nextDateTime);
            const nextTimeIndex = archiveIndex.findIndex(
              ({ time }) => time === nextDateTime.slice(-8)
            );

            const handleIndexUpdate = (index, existingIndexValues = []) => {
              index.forEach((i) => {
                existingIndexValues.push(i);
              });
              return existingIndexValues;
            };

            window.hackerNewsState = {
              index: handleIndexUpdate(
                archiveIndex,
                window.hackerNewsState.index
              ),
              nextTimeIndex,
            };

            let currentTimeIndex = nextTimeIndex + 1;
            const items = Object.values(window.hackerNewsState.index);
            for (let item of items) {
              if (currentTimeIndex < window.hackerNewsState.index.length) {
                addNewsItem(items[currentTimeIndex], queue);

                currentTimeIndex = currentTimeIndex + 1;
              }
            }

            queue.flush();
          }
        };

        const archives = document.getElementById("archives");
        const archivesObserver = new IntersectionObserver(
          (entries) => {
            const queue = new UpdateQueue();

            entries.forEach((entry) => handleIntersectingEntry(entry, queue));
          },
          {
            root: null,
            rootMargin: "0px",
            threshold: 0,
          }
        );

        archivesObserver.observe(archives);

        let latestSectionsExpanded = true;
        const handleLatestHeaderClick = () => {
          latestSectionsExpanded = !latestSectionsExpanded;

          if (latestSectionsExpanded) {
            archivesObserver.observe(archives);
          } else {
            archivesObserver.disconnect(archives);
          }

          for (let section of document.querySelectorAll("#latest > section")) {
            section.style.display = latestSectionsExpanded ? "block" : "none";
          }
        };

        const latestHeader = document.querySelector("#latest > h2");
        latestHeader.style.cursor = "pointer";
        latestHeader.addEventListener("click", handleLatestHeaderClick);
      }
    </script>
    <script type="module">
      import { Workbox } from "https://storage.googleapis.com/workbox-cdn/releases/6.4.1/workbox-window.prod.mjs";

      if ("serviceWorker" in navigator) {
        const base = document.querySelector("base");
        const serviceWorkerPath = `${
          base ? base.href.replace(/\/$/, "") : ""
        }/service-worker.js`;

        const wb = new Workbox(serviceWorkerPath);

        // setup event listeners
        wb.addEventListener("waiting", (event) => {
          wb.addEventListener("controlling", () => {
            window.location.reload();
          });

          wb.messageSkipWaiting();
        });

        wb.register();
      }
    </script>
  </body>
</html>
