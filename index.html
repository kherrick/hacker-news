<!DOCTYPE html>
<html lang="en" xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta charset="utf-8" />
    <meta
      content="width=device-width, initial-scale=1.0, viewport-fit=cover"
      name="viewport"
    />
    <meta name="description" content="Hacker News" />
    <meta name="theme-color" content="#fff" />
    <title>Hacker News</title>
    <link rel="manifest" href="manifest.json" />
    <link
      href="data:image/x-icon;base64,AAABAAEAAQECAAEAAQA4AAAAFgAAACgAAAABAAAAAgAAAAEAAQAAAAAAAAAAAAAAAAAAAAAAAAAAAAABAAEAAQECAAEAAQA4AAAAFgAAACgAAAABAAAAAgAAAAEAAQAAAAAAAAAAAAAAAAAAAAAAAAAA"
      rel="icon"
      type="image/x-icon"
    />
    <link
      href="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAgAAAAIAAQMAAADOtka5AAAAA1BMVEUAAACnej3aAAAANklEQVR42u3BAQEAAACCIP+vbkhAAQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAB8G4IAAAFjdVCkAAAAAElFTkSuQmCC"
      rel="apple-touch-icon"
    />
    <style>
      /*<!--*/
      body {
        color: rgb(25, 25, 25);
        font-family: Verdana, Geneva, sans-serif;
        margin: 0;
      }

      a {
        text-decoration: none;
      }

      a:link,
      a:focus,
      a:hover,
      a:active {
        color: rgb(75, 75, 125);
      }

      a:visited {
        color: rgb(25, 25, 25);
      }

      h1 > a,
      h1 > a:link,
      h1 > a:focus,
      h1 > a:hover,
      h1 > a:active,
      h1 > a:visited,
      h2 > a,
      h2 > a:link,
      h2 > a:focus,
      h2 > a:hover,
      h2 > a:active,
      h2 > a:visited {
        color: rgb(25, 25, 25);
      }

      h1 {
        background-color: rgb(255, 102, 0);
        margin: 0;
        padding: 1rem;
      }

      h2 {
        background-color: rgb(200, 200, 200);
        margin: 1rem 0;
        padding: 0.5rem 0.5rem 0.5rem 1rem;
      }

      #latest > section,
      #archives > section {
        margin: 0 1rem 1rem 1rem;
        padding-bottom: 1rem;
      }

      #latest > section:not(:last-child),
      #archives > section:not(:last-child) {
        border-bottom: 1px dotted rgb(200, 200, 200);
      }

      section > h3 {
        margin: 0 0 0.5rem 0;
      }

      section > h4 {
        font-weight: normal;
        margin: 0 0 0 1rem;
      }

      .descendants-container,
      .points-container {
        align-items: center;
        border-left: 1px solid #333;
        display: inline-flex;
        margin-left: 0.5rem;
        padding-left: 0.5rem;
        text-align: center;
      }

      .points {
        align-items: center;
        display: inline-flex;
        height: 1rem;
        margin-left: 1ch;
        min-width: 3ch;
      }

      .text {
        line-height: 1.5rem;
        margin: 1rem 1rem 0 1rem;
        overflow: auto;
      }

      .text > p:first-child {
        margin-top: 1rem;
      }

      .text > p:last-child {
        margin-bottom: 0;
      }
      /*-->*/
    </style>
  </head>

  <body>
    <main>
      <h1><a href="https://kherrick.github.io/hacker-news/">Hacker News</a></h1>
      <section id="latest">
        <h2>Latest</h2>
        <section id="37362227">
          <h3>
            <a class="item" href="https://github.com/pwwang/toml-bench"
              >Toml-bench â€“ Which toml package to use in Python?</a
            >
          </h3>
          <section>
            <h4>
              <span>2023-09-02 @ 15:13:06</span
              ><span class="points-container"
                >Points: <span class="points">10</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=37362227"
                  >Comments</a
                ><span class="descendants">: 7</span></span
              >
            </h4>
          </section>
        </section>
        <section id="37362200">
          <h3>
            <a class="item" href="https://news.ycombinator.com/item?id=37362200"
              >Ask HN: How to Focus Again?</a
            >
          </h3>
          <section>
            <h4>
              <span>2023-09-02 @ 15:09:35</span
              ><span class="points-container"
                >Points: <span class="points">26</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=37362200"
                  >Comments</a
                ><span class="descendants">: 10</span></span
              >
            </h4>
            <div class="text">
              <p>
                I used to be able to set myself a task and focus on it until I
                finished. I could imagine a product and build an MVP in a
                weekend, flesh it out in a month and launch it. Now I can't
                focus on my tasks for more than a few minutes, I'm constantly
                context switching, procrastination is killing all productivity
                even for tasks that I was looking forward to. Today I wanted to
                really knuckle down and make some real progress on my side
                project. I've updated my iPad, fixed the leg on a tripod, cut
                the grass, cleaned the mower, scrubbed the driveway. Guess how
                much progress I made on the side project?
              </p>
              <p>
                I talked to my GP - she said it could be undiagnosed ADHD, I
                filled in a quiz she gave me but she said it will take 2 years
                to get diagnosed(!) I can't wait that long.
              </p>
              <p>
                How do I get back to how I used to be? Focused, driven,
                talented? I feel like part of me has rotted away and I want it
                back!
              </p>
            </div>
          </section>
        </section>
        <section id="37362151">
          <h3>
            <a class="item" href="https://xrss.infogulch.com/"
              >Show HN: XRss: An RSS Reader and web stack demo powered by
              Htmx</a
            >
          </h3>
          <section>
            <h4>
              <span>2023-09-02 @ 15:02:52</span
              ><span class="points-container"
                >Points: <span class="points">26</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=37362151"
                  >Comments</a
                ><span class="descendants">: 5</span></span
              >
            </h4>
            <div class="text">
              <p>
                The entire site UI for XRss comes from
                <i>a single HTML template file</i>. This index.html includes
                everything from SQL queries and route definitions and handlers
                to htmx state transition attributes and tailwindcss classes, and
                developing it requires <i>zero build steps</i> (amortized).
              </p>
              <p>
                Check out the source which manages to be at once banal and
                gnarly:
                <a
                  href="https://github.com/infogulch/xrss/blob/master/templates/index.html"
                  >https://github.com/infogulch/xrss/blob/master/templates/inde...</a
                >
              </p>
              <p>
                xtemplate preloads the whole template structure into memory and
                builds the router at startup, so responses to matching requests
                are rendered after a single lookup. Combined with direct queries
                to sqlite makes for a very snappy experience typically
                responding in less than 5ms. (Fingers crossed.)
              </p>
              <p>
                There are various places where XRss could be improved (PRs
                welcome!), but it already delivers on its purpose of
                demonstrating the plausibility of xtemplate. See the xtemplate
                readme for an overview of what you can do with it. I think of it
                as 'PHP but the syntax looks like Go templates'.
              </p>
              <p>
                <a href="https://github.com/infogulch/caddy-xtemplate"
                  >https://github.com/infogulch/caddy-xtemplate</a
                >
              </p>
              <p>
                Let me know what you think! Does remaking PHP from scratch out
                of Go templates make me a lunatic? (yes) Is it a good idea
                anyway? (yes) What kind of web application do you think would be
                a good fit for a platform like this?
              </p>
            </div>
          </section>
        </section>
        <section id="37362132">
          <h3>
            <a
              class="item"
              href="https://www.ucsf.edu/news/2023/08/426056/can-artificial-kidney-finally-free-patients-dialysis"
              >Can an Artificial Kidney Finally Free Patients from Dialysis?</a
            >
          </h3>
          <section>
            <h4>
              <span>2023-09-02 @ 15:00:30</span
              ><span class="points-container"
                >Points: <span class="points">25</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=37362132"
                  >Comments</a
                ><span class="descendants">: 1</span></span
              >
            </h4>
          </section>
        </section>
        <section id="37362088">
          <h3><a class="item" href="https://forgefed.org/">ForgeFed</a></h3>
          <section>
            <h4>
              <span>2023-09-02 @ 14:56:00</span
              ><span class="points-container"
                >Points: <span class="points">23</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=37362088"
                  >Comments</a
                ><span class="descendants">: 2</span></span
              >
            </h4>
          </section>
        </section>
        <section id="37362072">
          <h3>
            <a
              class="item"
              href="https://9to5mac.com/2023/09/01/spacex-iphone-emergency-satellites-globalstar/"
              >SpaceX sending iPhone Emergency SOS satellites to space</a
            >
          </h3>
          <section>
            <h4>
              <span>2023-09-02 @ 14:54:31</span
              ><span class="points-container"
                >Points: <span class="points">21</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=37362072"
                  >Comments</a
                ><span class="descendants">: 10</span></span
              >
            </h4>
          </section>
        </section>
        <section id="37361947">
          <h3>
            <a
              class="item"
              href="https://dannorth.net/2023/09/02/the-worst-programmer/"
              >The worst programmer I know</a
            >
          </h3>
          <section>
            <h4>
              <span>2023-09-02 @ 14:41:45</span
              ><span class="points-container"
                >Points: <span class="points">187</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=37361947"
                  >Comments</a
                ><span class="descendants">: 113</span></span
              >
            </h4>
          </section>
        </section>
        <section id="37361911">
          <h3>
            <a
              class="item"
              href="https://www.vox.com/future-perfect/2023/8/31/23852325/farming-myths-agricultural-exceptionalism-pollution-labor-animal-welfare-laws"
              >The myths we tell ourselves about American farming</a
            >
          </h3>
          <section>
            <h4>
              <span>2023-09-02 @ 14:37:35</span
              ><span class="points-container"
                >Points: <span class="points">40</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=37361911"
                  >Comments</a
                ><span class="descendants">: 13</span></span
              >
            </h4>
          </section>
        </section>
        <section id="37361882">
          <h3>
            <a
              class="item"
              href="https://journals.sagepub.com/doi/10.1177/01461672231191356"
              >Spirituality of Science: Implications for Meaning, Well-Being,
              and Learning</a
            >
          </h3>
          <section>
            <h4>
              <span>2023-09-02 @ 14:35:33</span
              ><span class="points-container"
                >Points: <span class="points">14</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=37361882"
                  >Comments</a
                ><span class="descendants">: 10</span></span
              >
            </h4>
          </section>
        </section>
        <section id="37361863">
          <h3>
            <a
              class="item"
              href="https://news.umich.edu/groundwater-depletion-rates-in-india-could-triple-in-coming-decades-as-climate-warms-study-shows/"
              >Groundwater depletion in India may triple due to climate warming,
              study finds</a
            >
          </h3>
          <section>
            <h4>
              <span>2023-09-02 @ 14:32:59</span
              ><span class="points-container"
                >Points: <span class="points">31</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=37361863"
                  >Comments</a
                ><span class="descendants">: 6</span></span
              >
            </h4>
          </section>
        </section>
        <section id="37361462">
          <h3>
            <a
              class="item"
              href="https://www.techdirt.com/2023/09/01/tesla-rivian-put-on-fake-show-of-support-for-right-to-repair/"
              >Tesla, Rivian Put on Fake Show of Support for â€˜Right to
              Repairâ€™</a
            >
          </h3>
          <section>
            <h4>
              <span>2023-09-02 @ 13:41:54</span
              ><span class="points-container"
                >Points: <span class="points">120</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=37361462"
                  >Comments</a
                ><span class="descendants">: 90</span></span
              >
            </h4>
          </section>
        </section>
        <section id="37361275">
          <h3>
            <a
              class="item"
              href="https://www.abortretry.fail/p/the-history-of-windows-nt-31"
              >Windows NT 3.1</a
            >
          </h3>
          <section>
            <h4>
              <span>2023-09-02 @ 13:20:53</span
              ><span class="points-container"
                >Points: <span class="points">55</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=37361275"
                  >Comments</a
                ><span class="descendants">: 20</span></span
              >
            </h4>
          </section>
        </section>
        <section id="37361094">
          <h3>
            <a class="item" href="https://www.drcathicks.com/post/on-craft"
              >On Craft</a
            >
          </h3>
          <section>
            <h4>
              <span>2023-09-02 @ 12:55:11</span
              ><span class="points-container"
                >Points: <span class="points">89</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=37361094"
                  >Comments</a
                ><span class="descendants">: 9</span></span
              >
            </h4>
          </section>
        </section>
        <section id="37361050">
          <h3>
            <a class="item" href="https://alexanderobenauer.com/labnotes/038/"
              >Semantic Zoom</a
            >
          </h3>
          <section>
            <h4>
              <span>2023-09-02 @ 12:50:09</span
              ><span class="points-container"
                >Points: <span class="points">101</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=37361050"
                  >Comments</a
                ><span class="descendants">: 27</span></span
              >
            </h4>
          </section>
        </section>
        <section id="37360762">
          <h3>
            <a class="item" href="https://nautil.us/call-of-the-liar-363420/"
              >Call of the Liar</a
            >
          </h3>
          <section>
            <h4>
              <span>2023-09-02 @ 12:08:25</span
              ><span class="points-container"
                >Points: <span class="points">22</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=37360762"
                  >Comments</a
                ><span class="descendants">: 3</span></span
              >
            </h4>
          </section>
        </section>
        <section id="37360251">
          <h3>
            <a
              class="item"
              href="https://nicholas.carlini.com/writing/llm-forecast/question/Capital-of-Paris"
              >A GPT-4 capability forecasting challenge</a
            >
          </h3>
          <section>
            <h4>
              <span>2023-09-02 @ 10:40:26</span
              ><span class="points-container"
                >Points: <span class="points">93</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=37360251"
                  >Comments</a
                ><span class="descendants">: 62</span></span
              >
            </h4>
          </section>
        </section>
        <section id="37360249">
          <h3>
            <a
              class="item"
              href="https://stytch.com/blog/open-sourcing-sqx-a-way-to-build-flexible-database-models-in-go/"
              >Open-sourcing SQX, a way to build flexible database models in
              Go</a
            >
          </h3>
          <section>
            <h4>
              <span>2023-09-02 @ 10:39:50</span
              ><span class="points-container"
                >Points: <span class="points">50</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=37360249"
                  >Comments</a
                ><span class="descendants">: 9</span></span
              >
            </h4>
          </section>
        </section>
        <section id="37360186">
          <h3>
            <a class="item" href="https://www.youtube.com/watch?v=ckrrQTkTqIo"
              >Recursive Racks [video]</a
            >
          </h3>
          <section>
            <h4>
              <span>2023-09-02 @ 10:28:02</span
              ><span class="points-container"
                >Points: <span class="points">26</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=37360186"
                  >Comments</a
                ><span class="descendants">: 3</span></span
              >
            </h4>
          </section>
        </section>
        <section id="37359256">
          <h3>
            <a class="item" href="https://arxiv.org/abs/2308.16025"
              >A Critical Analysis of the What3Words Geocoding Algorithm</a
            >
          </h3>
          <section>
            <h4>
              <span>2023-09-02 @ 07:31:28</span
              ><span class="points-container"
                >Points: <span class="points">107</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=37359256"
                  >Comments</a
                ><span class="descendants">: 105</span></span
              >
            </h4>
          </section>
        </section>
        <section id="37359193">
          <h3>
            <a
              class="item"
              href="https://tylervigen.com/the-mystery-of-the-bloomfield-bridge"
              >The Mystery of the Bloomfield Bridge</a
            >
          </h3>
          <section>
            <h4>
              <span>2023-09-02 @ 07:12:34</span
              ><span class="points-container"
                >Points: <span class="points">358</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=37359193"
                  >Comments</a
                ><span class="descendants">: 92</span></span
              >
            </h4>
          </section>
        </section>
        <section id="37359146">
          <h3>
            <a
              class="item"
              href="https://www.ycombinator.com/companies/playht/jobs/G6vI660-senior-ml-engineer-large-language-models"
              >PlayHT (YC W23) Is Hiring Senior ML Engineers (LLMs, Generative
              AI)</a
            >
          </h3>
          <section>
            <h4>
              <span>2023-09-02 @ 07:01:07</span
              ><span class="points-container"
                >Points: <span class="points">1</span></span
              >
            </h4>
          </section>
        </section>
        <section id="37358577">
          <h3>
            <a
              class="item"
              href="https://www.math3ma.com/blog/the-tensor-product-demystified"
              >The tensor product, demystified (2018)</a
            >
          </h3>
          <section>
            <h4>
              <span>2023-09-02 @ 04:30:35</span
              ><span class="points-container"
                >Points: <span class="points">64</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=37358577"
                  >Comments</a
                ><span class="descendants">: 13</span></span
              >
            </h4>
          </section>
        </section>
        <section id="37358400">
          <h3>
            <a
              class="item"
              href="https://stingingfly.org/2017/10/24/edit-lousy-writing/"
              >How to edit your own lousy writing (2017)</a
            >
          </h3>
          <section>
            <h4>
              <span>2023-09-02 @ 03:41:42</span
              ><span class="points-container"
                >Points: <span class="points">143</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=37358400"
                  >Comments</a
                ><span class="descendants">: 52</span></span
              >
            </h4>
          </section>
        </section>
        <section id="37355372">
          <h3>
            <a
              class="item"
              href="https://cyber.wtf/2023/09/01/qakbot-takedown-payload-analysis/"
              >Qakbot takedown payload analysis</a
            >
          </h3>
          <section>
            <h4>
              <span>2023-09-01 @ 19:45:15</span
              ><span class="points-container"
                >Points: <span class="points">5</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=37355372"
                  >Comments</a
                ><span class="descendants">: 0</span></span
              >
            </h4>
          </section>
        </section>
        <section id="37352970">
          <h3>
            <a
              class="item"
              href="https://naveenarun.wordpress.com/2023/08/31/doing-laundry-on-campus-without-a-phone/"
              >Doing laundry on campus without a phone</a
            >
          </h3>
          <section>
            <h4>
              <span>2023-09-01 @ 16:31:03</span
              ><span class="points-container"
                >Points: <span class="points">264</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=37352970"
                  >Comments</a
                ><span class="descendants">: 374</span></span
              >
            </h4>
          </section>
        </section>
        <section id="37351373">
          <h3>
            <a class="item" href="https://kb.osu.edu/handle/1811/28443"
              >Indian Influences on Rastafarianism</a
            >
          </h3>
          <section>
            <h4>
              <span>2023-09-01 @ 14:37:11</span
              ><span class="points-container"
                >Points: <span class="points">71</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=37351373"
                  >Comments</a
                ><span class="descendants">: 21</span></span
              >
            </h4>
          </section>
        </section>
        <section id="37348079">
          <h3>
            <a
              class="item"
              href="https://ochagavia.nl/blog/becoming-a-contractor/"
              >Becoming a contractor</a
            >
          </h3>
          <section>
            <h4>
              <span>2023-09-01 @ 08:14:25</span
              ><span class="points-container"
                >Points: <span class="points">155</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=37348079"
                  >Comments</a
                ><span class="descendants">: 77</span></span
              >
            </h4>
          </section>
        </section>
        <section id="37347757">
          <h3>
            <a class="item" href="http://www.p01.org/expi/">EXPI by p01</a>
          </h3>
          <section>
            <h4>
              <span>2023-09-01 @ 07:21:26</span
              ><span class="points-container"
                >Points: <span class="points">17</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=37347757"
                  >Comments</a
                ><span class="descendants">: 2</span></span
              >
            </h4>
          </section>
        </section>
        <section id="37346585">
          <h3>
            <a
              class="item"
              href="https://www.newstatesman.com/culture/history/2023/08/making-ep-thompson"
              >The Making of EP Thompson</a
            >
          </h3>
          <section>
            <h4>
              <span>2023-09-01 @ 03:46:05</span
              ><span class="points-container"
                >Points: <span class="points">15</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=37346585"
                  >Comments</a
                ><span class="descendants">: 0</span></span
              >
            </h4>
          </section>
        </section>
        <section id="37343450">
          <h3>
            <a
              class="item"
              href="https://physicsworld.com/a/the-physics-of-hand-clapping-heres-how-to-do-it-best/"
              >The physics of hand clapping</a
            >
          </h3>
          <section>
            <h4>
              <span>2023-08-31 @ 20:44:56</span
              ><span class="points-container"
                >Points: <span class="points">63</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=37343450"
                  >Comments</a
                ><span class="descendants">: 21</span></span
              >
            </h4>
          </section>
        </section>
      </section>
      <section id="archives">
        <h2>
          <a
            href="https://github.com/kherrick/hacker-news/blob/main/archives/index.md"
            >Archives</a
          >
        </h2>
        <section>
          <h3>
            <a
              href="https://github.com/kherrick/hacker-news/blob/main/archives/2023/index.md"
              >2023</a
            >
          </h3>
        </section>
        <section>
          <h3>
            <a
              href="https://github.com/kherrick/hacker-news/blob/main/archives/2022/index.md"
              >2022</a
            >
          </h3>
        </section>
      </section>
    </main>
    <script type="module">
      import { buildDescendants } from "./lib/build-html-descendants.js";
      import { buildNextItem } from "./lib/build-html-next-item.js";
      import { getNextDateTime } from "./lib/date-time.js";

      const updateSectionById = (id) =>
        fetch(`https://hacker-news.firebaseio.com/v0/item/${id}.json`).then(
          (result) =>
            result.json().then(({ descendants, id, score, text, type }) => {
              const currentItem = document.getElementById(id);

              if (score) {
                currentItem.querySelector(".points").textContent = score;
              }

              if (descendants && (type === "poll" || type === "story")) {
                const currentDescendants =
                  currentItem.querySelector(".descendants");

                if (currentDescendants) {
                  currentDescendants.textContent = `: ${descendants}`;
                } else {
                  const comments = buildDescendants(
                    document,
                    descendants,
                    `https://news.ycombinator.com/item?id=${id}`
                  );

                  currentItem.querySelector("h4").appendChild(comments);
                }
              }

              if (text) {
                const currentText = currentItem.querySelector(".text");

                if (currentText) {
                  currentText.innerHTML = text.replace(/\0/g, "");
                } else {
                  const content = document.createElement("div");
                  content.innerHTML = text.replace(/\0/g, "");
                  content.setAttribute("class", "text");

                  currentItem.appendChild(content);
                }
              }
            })
        );

      class UpdateQueue {
        constructor() {
          this._ids = [];
          this._isUpdating = false;
        }

        addItemById(id) {
          this._ids.push(id);
        }

        async flush() {
          const id = this._ids.shift();

          if (id) {
            this._isUpdating = true;

            await updateSectionById(id);
            await this.flush();
          } else {
            this._isUpdating = false;

            setTimeout(async () => {
              if (!this._isUpdating && this._ids && this._ids.length) {
                await this.flush();
              }
            }, 0);
          }
        }
      }

      // get latest data
      const latestSection = document.getElementById("latest");

      for (let item of latestSection.querySelectorAll("section[id]")) {
        updateSectionById(item.getAttribute("id"));
      }

      if ("IntersectionObserver" in window) {
        window.hackerNewsState = { index: [], nextTimeIndex: -1 };

        const addNewsItem = async (newsItem, queue) => {
          try {
            const { date, time, itemComments, itemTitle, itemLink } = newsItem;
            const section = await buildNextItem({
              document,
              dateTime: `${date}, ${time}`,
              itemComments,
              itemLink,
              itemTitle: new DOMParser().parseFromString(
                itemTitle.replace(/\\/g, ""),
                "text/html"
              ).documentElement.textContent,
              fetchItemDetails: false,
            });

            // display loading indicator for section
            section.querySelector(".points-container").innerHTML =
              'Points: <span class="points"><img style="height: 100%;" src="lib/images/loading.svg" /></span>';

            const id = section.getAttribute("id");
            if (!document.getElementById(id)) {
              document.getElementById("latest").appendChild(section);

              queue.addItemById(id);
            }
          } catch (error) {}
        };

        const buildArchiveIndex = async (lastDateTime) => {
          const nextDate = lastDateTime.slice(0, 10);
          const nextYear = nextDate.slice(0, 4);

          return (
            await (
              await fetch(
                `https://raw.githubusercontent.com/kherrick/hacker-news/main/archives/${nextYear}/${nextDate}/index.md`
              )
            ).text()
          )
            .split("\n")
            .filter((line) => line.match(new RegExp("^\\* \\[")))
            .map((line) => {
              const segment = line.replace("* ", "").split("](");
              const pubDate = segment[0].slice(1);

              const itemComments = segment[1].split(") - [")[0];
              const itemTitle = segment[1].split(") - [")[1];
              const itemLink = segment[2].slice(0, -1);
              const date = pubDate.slice(0, 10);
              const time = pubDate.slice(-8);

              return {
                date,
                itemComments,
                itemLink,
                itemTitle,
                time,
              };
            });
        };

        const handleIntersectingEntry = async (entry, queue) => {
          if (entry.isIntersecting) {
            const lastDateTime = document
              .getElementById("latest")
              .querySelector(
                "section:last-child > section > h4 > span"
              ).textContent;

            const nextDateTime = getNextDateTime(lastDateTime ?? "", -1);
            const archiveIndex = await buildArchiveIndex(nextDateTime);
            const nextTimeIndex = archiveIndex.findIndex(
              ({ time }) => time === nextDateTime.slice(-8)
            );

            const handleIndexUpdate = (index, existingIndexValues = []) => {
              index.forEach((i) => {
                existingIndexValues.push(i);
              });
              return existingIndexValues;
            };

            window.hackerNewsState = {
              index: handleIndexUpdate(
                archiveIndex,
                window.hackerNewsState.index
              ),
              nextTimeIndex,
            };

            let currentTimeIndex = nextTimeIndex + 1;
            const items = Object.values(window.hackerNewsState.index);
            for (let item of items) {
              if (currentTimeIndex < window.hackerNewsState.index.length) {
                addNewsItem(items[currentTimeIndex], queue);

                currentTimeIndex = currentTimeIndex + 1;
              }
            }

            queue.flush();
          }
        };

        const archives = document.getElementById("archives");
        const archivesObserver = new IntersectionObserver(
          (entries) => {
            const queue = new UpdateQueue();

            entries.forEach((entry) => handleIntersectingEntry(entry, queue));
          },
          {
            root: null,
            rootMargin: "0px",
            threshold: 0,
          }
        );

        archivesObserver.observe(archives);

        let latestSectionsExpanded = true;
        const handleLatestHeaderClick = () => {
          latestSectionsExpanded = !latestSectionsExpanded;

          if (latestSectionsExpanded) {
            archivesObserver.observe(archives);
          } else {
            archivesObserver.disconnect(archives);
          }

          for (let section of document.querySelectorAll("#latest > section")) {
            section.style.display = latestSectionsExpanded ? "block" : "none";
          }
        };

        const latestHeader = document.querySelector("#latest > h2");
        latestHeader.style.cursor = "pointer";
        latestHeader.addEventListener("click", handleLatestHeaderClick);
      }
    </script>
    <script type="module">
      import { Workbox } from "https://storage.googleapis.com/workbox-cdn/releases/6.4.1/workbox-window.prod.mjs";

      if ("serviceWorker" in navigator) {
        const base = document.querySelector("base");
        const serviceWorkerPath = `${
          base ? base.href.replace(/\/$/, "") : ""
        }/service-worker.js`;

        const wb = new Workbox(serviceWorkerPath);

        // setup event listeners
        wb.addEventListener("waiting", (event) => {
          wb.addEventListener("controlling", () => {
            window.location.reload();
          });

          wb.messageSkipWaiting();
        });

        wb.register();
      }
    </script>
  </body>
</html>
