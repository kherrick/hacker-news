<!DOCTYPE html>
<html lang="en" xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta charset="utf-8" />
    <meta
      content="width=device-width, initial-scale=1.0, viewport-fit=cover"
      name="viewport"
    />
    <meta name="description" content="Hacker News" />
    <meta name="theme-color" content="#fff" />
    <title>Hacker News</title>
    <link rel="manifest" href="manifest.json" />
    <link
      href="data:image/x-icon;base64,AAABAAEAAQECAAEAAQA4AAAAFgAAACgAAAABAAAAAgAAAAEAAQAAAAAAAAAAAAAAAAAAAAAAAAAAAAABAAEAAQECAAEAAQA4AAAAFgAAACgAAAABAAAAAgAAAAEAAQAAAAAAAAAAAAAAAAAAAAAAAAAA"
      rel="icon"
      type="image/x-icon"
    />
    <link
      href="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAgAAAAIAAQMAAADOtka5AAAAA1BMVEUAAACnej3aAAAANklEQVR42u3BAQEAAACCIP+vbkhAAQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAB8G4IAAAFjdVCkAAAAAElFTkSuQmCC"
      rel="apple-touch-icon"
    />
    <style>
      /*<!--*/
      body {
        color: rgb(25, 25, 25);
        font-family: Verdana, Geneva, sans-serif;
        margin: 0;
      }

      a {
        text-decoration: none;
      }

      a:link,
      a:focus,
      a:hover,
      a:active {
        color: rgb(75, 75, 125);
      }

      a:visited {
        color: rgb(25, 25, 25);
      }

      h1 > a,
      h1 > a:link,
      h1 > a:focus,
      h1 > a:hover,
      h1 > a:active,
      h1 > a:visited,
      h2 > a,
      h2 > a:link,
      h2 > a:focus,
      h2 > a:hover,
      h2 > a:active,
      h2 > a:visited {
        color: rgb(25, 25, 25);
      }

      h1 {
        background-color: rgb(255, 102, 0);
        margin: 0;
        padding: 1rem;
      }

      h2 {
        background-color: rgb(200, 200, 200);
        margin: 1rem 0;
        padding: 0.5rem 0.5rem 0.5rem 1rem;
      }

      #latest > section,
      #archives > section {
        margin: 0 1rem 1rem 1rem;
        padding-bottom: 1rem;
      }

      #latest > section:not(:last-child),
      #archives > section:not(:last-child) {
        border-bottom: 1px dotted rgb(200, 200, 200);
      }

      section > h3 {
        margin: 0 0 0.5rem 0;
      }

      section > h4 {
        font-weight: normal;
        margin: 0 0 0 1rem;
      }

      .descendants-container,
      .points-container {
        align-items: center;
        border-left: 1px solid #333;
        display: inline-flex;
        margin-left: 0.5rem;
        padding-left: 0.5rem;
        text-align: center;
      }

      .points {
        align-items: center;
        display: inline-flex;
        height: 1rem;
        margin-left: 1ch;
        min-width: 3ch;
      }

      .text {
        line-height: 1.5rem;
        margin: 1rem 1rem 0 1rem;
        overflow: auto;
      }

      .text > p:first-child {
        margin-top: 1rem;
      }

      .text > p:last-child {
        margin-bottom: 0;
      }
      /*-->*/
    </style>
  </head>

  <body>
    <main>
      <h1><a href="https://kherrick.github.io/hacker-news/">Hacker News</a></h1>
      <section id="latest">
        <h2>Latest</h2>
        <section id="44013154">
          <h3>
            <a class="item" href="https://sidsite.com/posts/life-transformer/"
              >Transformer neural net learns to run Conway's Game of Life just
              from examples</a
            >
          </h3>
          <section>
            <h4>
              <span>2025-05-17 @ 09:31:14</span
              ><span class="points-container"
                >Points: <span class="points">33</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=44013154"
                  >Comments</a
                ><span class="descendants">: 13</span></span
              >
            </h4>
          </section>
        </section>
        <section id="44012729">
          <h3>
            <a class="item" href="https://seiya.me/blog/riscv-hypervisor"
              >Implementing a RISC-V Hypervisor</a
            >
          </h3>
          <section>
            <h4>
              <span>2025-05-17 @ 07:46:29</span
              ><span class="points-container"
                >Points: <span class="points">22</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=44012729"
                  >Comments</a
                ><span class="descendants">: 0</span></span
              >
            </h4>
          </section>
        </section>
        <section id="44012615">
          <h3>
            <a class="item" href="https://github.com/prathyvsh/os-catalog"
              >Catalog of Novel Operating Systems</a
            >
          </h3>
          <section>
            <h4>
              <span>2025-05-17 @ 07:19:55</span
              ><span class="points-container"
                >Points: <span class="points">41</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=44012615"
                  >Comments</a
                ><span class="descendants">: 12</span></span
              >
            </h4>
          </section>
        </section>
        <section id="44012227">
          <h3>
            <a
              class="item"
              href="https://v8.dev/features/explicit-resource-management"
              >JavaScript's New Superpower: Explicit Resource Management</a
            >
          </h3>
          <section>
            <h4>
              <span>2025-05-17 @ 05:23:20</span
              ><span class="points-container"
                >Points: <span class="points">127</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=44012227"
                  >Comments</a
                ><span class="descendants">: 72</span></span
              >
            </h4>
          </section>
        </section>
        <section id="44012074">
          <h3>
            <a class="item" href="https://github.com/moustafa-nasr/fahmatrix"
              >Show HN: Fahmatrix – A Lightweight, Pandas-Like DataFrame Library
              for Java</a
            >
          </h3>
          <section>
            <h4>
              <span>2025-05-17 @ 04:39:31</span
              ><span class="points-container"
                >Points: <span class="points">32</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=44012074"
                  >Comments</a
                ><span class="descendants">: 5</span></span
              >
            </h4>
            <div class="text">
              <p>
                After working extensively with Python’s data stack, I often ran
                into limitations related to speed, especially in larger or
                long-running data workflows. So I built Fahmatrix from scratch
                to offer similar APIs for manipulating CSVs, performing summary
                statistics, slicing rows/columns, and more — but all in Java.
              </p>
              <p>Features:</p>
              <p>Lightweight and dependency-free</p>
              <p>CSV/TSV import with auto-headers</p>
              <p>Series/DataFrame structures (like pandas)</p>
              <p>describe(), mean(), stdDev(), percentile() and more</p>
              <p>Fast parallel operations on numeric columns</p>
              <p>Java 17+ support</p>
              <p>
                Docs:
                <a href="https://moustafa-nasr.github.io/Fahmatrix/"
                  >https://moustafa-nasr.github.io/Fahmatrix/</a
                >
                GitHub:
                <a href="https://github.com/moustafa-nasr/fahmatrix"
                  >https://github.com/moustafa-nasr/fahmatrix</a
                >
              </p>
              <p>
                I’d love feedback from the Java and data communities —
                especially if you’ve ever wanted a simple dataframe utility in
                Java without needing full-scale ML libraries.
              </p>
              <p>Happy to answer any questions!</p>
            </div>
          </section>
        </section>
        <section id="44011669">
          <h3>
            <a
              class="item"
              href="https://lwn.net/SubscriberLink/1017720/7155ecb9602e9ef2/"
              >A kernel developer plays with Home Assistant</a
            >
          </h3>
          <section>
            <h4>
              <span>2025-05-17 @ 02:50:15</span
              ><span class="points-container"
                >Points: <span class="points">110</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=44011669"
                  >Comments</a
                ><span class="descendants">: 42</span></span
              >
            </h4>
          </section>
        </section>
        <section id="44011515">
          <h3>
            <a class="item" href="https://github.com/xtool-org/xtool"
              >XTool – Cross-platform Xcode replacement</a
            >
          </h3>
          <section>
            <h4>
              <span>2025-05-17 @ 02:10:36</span
              ><span class="points-container"
                >Points: <span class="points">130</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=44011515"
                  >Comments</a
                ><span class="descendants">: 32</span></span
              >
            </h4>
          </section>
        </section>
        <section id="44011489">
          <h3>
            <a class="item" href="https://phl.upr.edu/wow/outreach"
              >Wow@Home – Network of Amateur Radio Telescopes</a
            >
          </h3>
          <section>
            <h4>
              <span>2025-05-17 @ 02:02:14</span
              ><span class="points-container"
                >Points: <span class="points">134</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=44011489"
                  >Comments</a
                ><span class="descendants">: 9</span></span
              >
            </h4>
          </section>
        </section>
        <section id="44011254">
          <h3>
            <a class="item" href="https://github.com/merliot/hub"
              >Show HN: Merliot – plugging physical devices into LLMs</a
            >
          </h3>
          <section>
            <h4>
              <span>2025-05-17 @ 01:09:38</span
              ><span class="points-container"
                >Points: <span class="points">51</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=44011254"
                  >Comments</a
                ><span class="descendants">: 12</span></span
              >
            </h4>
            <div class="text">
              <p>
                What does that mean? It means you can control and interact with
                your physical devices, your security cameras, your thermometer,
                seamlessly using natural language from an LLM host such as
                Claude Desktop or Cursor. The hub is a gateway between AI and
                the physical world.
              </p>
              <p>What could go wrong?</p>
            </div>
          </section>
        </section>
        <section id="44009848">
          <h3>
            <a
              class="item"
              href="https://cloud.google.com/blog/products/databases/techniques-for-improving-text-to-sql"
              >Getting AI to write good SQL</a
            >
          </h3>
          <section>
            <h4>
              <span>2025-05-16 @ 21:10:12</span
              ><span class="points-container"
                >Points: <span class="points">383</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=44009848"
                  >Comments</a
                ><span class="descendants">: 216</span></span
              >
            </h4>
          </section>
        </section>
        <section id="44009464">
          <h3>
            <a
              class="item"
              href="https://clojurescript.org/news/2025-05-16-release"
              >ClojureScript 1.12.42</a
            >
          </h3>
          <section>
            <h4>
              <span>2025-05-16 @ 20:20:20</span
              ><span class="points-container"
                >Points: <span class="points">165</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=44009464"
                  >Comments</a
                ><span class="descendants">: 30</span></span
              >
            </h4>
          </section>
        </section>
        <section id="44009321">
          <h3>
            <a class="item" href="https://github.com/dipampaul17/KVSplit"
              >Show HN: KVSplit – Run 2-3x longer contexts on Apple Silicon</a
            >
          </h3>
          <section>
            <h4>
              <span>2025-05-16 @ 20:04:58</span
              ><span class="points-container"
                >Points: <span class="points">249</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=44009321"
                  >Comments</a
                ><span class="descendants">: 37</span></span
              >
            </h4>
            <div class="text">
              <p>
                I patched llama.cpp to enable different bit-widths for keys vs.
                values on Apple Silicon. The results are surprising:
              </p>
              <p>
                - K8V4 (8-bit keys, 4-bit values): 59% memory reduction with
                only 0.86% perplexity loss - K4V8 (4-bit keys, 8-bit values):
                59% memory reduction but 6.06% perplexity loss - The
                configurations use the same number of bits, but K8V4 is 7×
                better for quality
              </p>
              <p>
                This means you can run LLMs with 2-3× longer context on the same
                Mac. Memory usage scales with sequence length, so savings
                compound as context grows.
              </p>
              <p>
                Implementation was straightforward: 1. Added --kvq-key and
                --kvq-val flags to llama.cpp 2. Applied existing quantization
                logic separately to K and V tensors 3. Validated with perplexity
                metrics across context lengths 4. Used Metal for acceleration
                (with -mlong-calls flag to avoid vectorization issues)
              </p>
              <p>
                Benchmarked on an M4 MacBook Pro running TinyLlama with 8K
                context windows. Compatible with Metal/MPS and optimized for
                Apple Silicon.
              </p>
              <p>
                GitHub:
                <a href="https://github.com/dipampaul17/KVSplit"
                  >https://github.com/dipampaul17/KVSplit</a
                >
              </p>
            </div>
          </section>
        </section>
        <section id="44008843">
          <h3>
            <a class="item" href="https://dcurt.is/thinking"
              >Thoughts on thinking</a
            >
          </h3>
          <section>
            <h4>
              <span>2025-05-16 @ 19:09:55</span
              ><span class="points-container"
                >Points: <span class="points">503</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=44008843"
                  >Comments</a
                ><span class="descendants">: 316</span></span
              >
            </h4>
          </section>
        </section>
        <section id="44006824">
          <h3>
            <a class="item" href="https://arxiv.org/abs/2505.09814"
              >X X^t can be faster</a
            >
          </h3>
          <section>
            <h4>
              <span>2025-05-16 @ 15:45:30</span
              ><span class="points-container"
                >Points: <span class="points">181</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=44006824"
                  >Comments</a
                ><span class="descendants">: 53</span></span
              >
            </h4>
          </section>
        </section>
        <section id="44006426">
          <h3>
            <a
              class="item"
              href="https://economics.mit.edu/news/assuring-accurate-research-record"
              >MIT asks arXiv to withdraw preprint of paper on AI and scientific
              discovery</a
            >
          </h3>
          <section>
            <h4>
              <span>2025-05-16 @ 15:09:25</span
              ><span class="points-container"
                >Points: <span class="points">323</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=44006426"
                  >Comments</a
                ><span class="descendants">: 171</span></span
              >
            </h4>
          </section>
        </section>
        <section id="44006381">
          <h3>
            <a class="item" href="https://news.ycombinator.com/item?id=44006381"
              >I'm Peter Roberts, immigration attorney, who does work for YC and
              startups. AMA</a
            >
          </h3>
          <section>
            <h4>
              <span>2025-05-16 @ 15:05:32</span
              ><span class="points-container"
                >Points: <span class="points">224</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=44006381"
                  >Comments</a
                ><span class="descendants">: 387</span></span
              >
            </h4>
            <div class="text">
              <p>
                Edit: I am taking a break now and will return later this
                afternoon/evening to respond to any comments and answer any
                questions. Thank you everyone for a great and engaged AMA so
                far.
              </p>
            </div>
          </section>
        </section>
        <section id="44006345">
          <h3>
            <a class="item" href="https://openai.com/index/introducing-codex/"
              >A Research Preview of Codex</a
            >
          </h3>
          <section>
            <h4>
              <span>2025-05-16 @ 15:02:02</span
              ><span class="points-container"
                >Points: <span class="points">445</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=44006345"
                  >Comments</a
                ><span class="descendants">: 378</span></span
              >
            </h4>
          </section>
        </section>
        <section id="44006231">
          <h3>
            <a class="item" href="https://github.com/gorenje/erlang-red"
              >Show HN: Visual flow-based programming for Erlang, inspired by
              Node-RED</a
            >
          </h3>
          <section>
            <h4>
              <span>2025-05-16 @ 14:54:13</span
              ><span class="points-container"
                >Points: <span class="points">229</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=44006231"
                  >Comments</a
                ><span class="descendants">: 95</span></span
              >
            </h4>
            <div class="text">
              <p>
                Erlang-RED has been my project for the last couple of months and
                I would love to get some feedback from the HN community.
              </p>
              <p>
                The idea is to take advantage of Erlangs message passing and low
                overhead processes to have true concurrency in Node-RED flows.
                Plus also to bring low-code visual flow-based programming to
                Erlang.
              </p>
            </div>
          </section>
        </section>
        <section id="44003445">
          <h3>
            <a
              class="item"
              href="https://labs.quansight.org/blog/free-threaded-one-year-recap"
              >The first year of free-threaded Python</a
            >
          </h3>
          <section>
            <h4>
              <span>2025-05-16 @ 09:42:31</span
              ><span class="points-container"
                >Points: <span class="points">276</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=44003445"
                  >Comments</a
                ><span class="descendants">: 271</span></span
              >
            </h4>
          </section>
        </section>
        <section id="43997135">
          <h3>
            <a class="item" href="https://popcorn.swmansion.com/"
              >Popcorn: Run Elixir in WASM</a
            >
          </h3>
          <section>
            <h4>
              <span>2025-05-15 @ 17:14:28</span
              ><span class="points-container"
                >Points: <span class="points">40</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=43997135"
                  >Comments</a
                ><span class="descendants">: 2</span></span
              >
            </h4>
          </section>
        </section>
        <section id="43994306">
          <h3>
            <a
              class="item"
              href="https://github.com/google/security-research/security/advisories/GHSA-qx2m-rcpc-v43v"
              >Oracle VM VirtualBox – VM Escape via VGA Device</a
            >
          </h3>
          <section>
            <h4>
              <span>2025-05-15 @ 12:28:16</span
              ><span class="points-container"
                >Points: <span class="points">25</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=43994306"
                  >Comments</a
                ><span class="descendants">: 7</span></span
              >
            </h4>
          </section>
        </section>
        <section id="43993711">
          <h3>
            <a class="item" href="https://aruarian.dance/blog/japan-ic-cards/"
              >Japan's IC cards are weird and wonderful</a
            >
          </h3>
          <section>
            <h4>
              <span>2025-05-15 @ 10:59:09</span
              ><span class="points-container"
                >Points: <span class="points">104</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=43993711"
                  >Comments</a
                ><span class="descendants">: 68</span></span
              >
            </h4>
          </section>
        </section>
        <section id="43991500">
          <h3>
            <a
              class="item"
              href="https://www.nature.com/articles/d41586-025-01464-7"
              >Hunting extreme microbes that redefine the limits of life</a
            >
          </h3>
          <section>
            <h4>
              <span>2025-05-15 @ 03:19:26</span
              ><span class="points-container"
                >Points: <span class="points">20</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=43991500"
                  >Comments</a
                ><span class="descendants">: 1</span></span
              >
            </h4>
          </section>
        </section>
        <section id="43984860">
          <h3>
            <a
              class="item"
              href="https://radanskoric.com/articles/coding-agent-in-ruby"
              >Coding agent in 94 lines of Ruby</a
            >
          </h3>
          <section>
            <h4>
              <span>2025-05-14 @ 14:17:57</span
              ><span class="points-container"
                >Points: <span class="points">118</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=43984860"
                  >Comments</a
                ><span class="descendants">: 57</span></span
              >
            </h4>
          </section>
        </section>
        <section id="43981971">
          <h3>
            <a class="item" href="https://github.com/Nicoshev/rapidhash"
              >New high-quality hash measures 71GB/s on M4</a
            >
          </h3>
          <section>
            <h4>
              <span>2025-05-14 @ 07:45:00</span
              ><span class="points-container"
                >Points: <span class="points">84</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=43981971"
                  >Comments</a
                ><span class="descendants">: 29</span></span
              >
            </h4>
          </section>
        </section>
        <section id="43981198">
          <h3>
            <a
              class="item"
              href="https://www.bbc.co.uk/news/articles/cx2enydkew3o"
              >How can traditional British TV survive the US streaming giants</a
            >
          </h3>
          <section>
            <h4>
              <span>2025-05-14 @ 05:44:32</span
              ><span class="points-container"
                >Points: <span class="points">33</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=43981198"
                  >Comments</a
                ><span class="descendants">: 85</span></span
              >
            </h4>
          </section>
        </section>
        <section id="43977901">
          <h3>
            <a
              class="item"
              href="https://www.uber.com/blog/fixrleak-fixing-java-resource-leaks-with-genai/"
              >Fixrleak: Fixing Java Resource Leaks with GenAI</a
            >
          </h3>
          <section>
            <h4>
              <span>2025-05-13 @ 21:26:12</span
              ><span class="points-container"
                >Points: <span class="points">9</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=43977901"
                  >Comments</a
                ><span class="descendants">: 10</span></span
              >
            </h4>
          </section>
        </section>
        <section id="43977890">
          <h3>
            <a
              class="item"
              href="https://www.wsj.com/articles/why-moderna-merged-its-tech-and-hr-departments-95318c2a"
              >Why Moderna Merged Its Tech and HR Departments</a
            >
          </h3>
          <section>
            <h4>
              <span>2025-05-13 @ 21:24:36</span
              ><span class="points-container"
                >Points: <span class="points">15</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=43977890"
                  >Comments</a
                ><span class="descendants">: 15</span></span
              >
            </h4>
          </section>
        </section>
        <section id="43972669">
          <h3>
            <a
              class="item"
              href="https://www.memorysafety.org/blog/rustls-server-perf/"
              >Rustls Server-Side Performance</a
            >
          </h3>
          <section>
            <h4>
              <span>2025-05-13 @ 13:22:36</span
              ><span class="points-container"
                >Points: <span class="points">123</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=43972669"
                  >Comments</a
                ><span class="descendants">: 35</span></span
              >
            </h4>
          </section>
        </section>
        <section id="43972334">
          <h3>
            <a class="item" href="https://www.speakeasy.com/mcp/mcp-tutorial"
              >MCP: An in-depth introduction</a
            >
          </h3>
          <section>
            <h4>
              <span>2025-05-13 @ 12:47:04</span
              ><span class="points-container"
                >Points: <span class="points">97</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=43972334"
                  >Comments</a
                ><span class="descendants">: 33</span></span
              >
            </h4>
          </section>
        </section>
      </section>
      <section id="archives">
        <h2>
          <a
            href="https://github.com/kherrick/hacker-news/blob/main/archives/index.md"
            >Archives</a
          >
        </h2>
        <section>
          <h3>
            <a
              href="https://github.com/kherrick/hacker-news/blob/main/archives/2025/index.md"
              >2025</a
            >
          </h3>
        </section>
        <section>
          <h3>
            <a
              href="https://github.com/kherrick/hacker-news/blob/main/archives/2024/index.md"
              >2024</a
            >
          </h3>
        </section>
        <section>
          <h3>
            <a
              href="https://github.com/kherrick/hacker-news/blob/main/archives/2023/index.md"
              >2023</a
            >
          </h3>
        </section>
        <section>
          <h3>
            <a
              href="https://github.com/kherrick/hacker-news/blob/main/archives/2022/index.md"
              >2022</a
            >
          </h3>
        </section>
      </section>
    </main>
    <script type="module">
      import { buildDescendants } from "./lib/build-html-descendants.js";
      import { buildNextItem } from "./lib/build-html-next-item.js";
      import { getNextDateTime } from "./lib/date-time.js";

      const updateSectionById = (id) =>
        fetch(`https://hacker-news.firebaseio.com/v0/item/${id}.json`).then(
          (result) =>
            result.json().then(({ descendants, id, score, text, type }) => {
              const currentItem = document.getElementById(id);

              if (score) {
                currentItem.querySelector(".points").textContent = score;
              }

              if (descendants && (type === "poll" || type === "story")) {
                const currentDescendants =
                  currentItem.querySelector(".descendants");

                if (currentDescendants) {
                  currentDescendants.textContent = `: ${descendants}`;
                } else {
                  const comments = buildDescendants(
                    document,
                    descendants,
                    `https://news.ycombinator.com/item?id=${id}`
                  );

                  currentItem.querySelector("h4").appendChild(comments);
                }
              }

              if (text) {
                const currentText = currentItem.querySelector(".text");

                if (currentText) {
                  currentText.innerHTML = text.replace(/\0/g, "");
                } else {
                  const content = document.createElement("div");
                  content.innerHTML = text.replace(/\0/g, "");
                  content.setAttribute("class", "text");

                  currentItem.appendChild(content);
                }
              }
            })
        );

      class UpdateQueue {
        constructor() {
          this._ids = [];
          this._isUpdating = false;
        }

        addItemById(id) {
          this._ids.push(id);
        }

        async flush() {
          const id = this._ids.shift();

          if (id) {
            this._isUpdating = true;

            await updateSectionById(id);
            await this.flush();
          } else {
            this._isUpdating = false;

            setTimeout(async () => {
              if (!this._isUpdating && this._ids && this._ids.length) {
                await this.flush();
              }
            }, 0);
          }
        }
      }

      // get latest data
      const latestSection = document.getElementById("latest");

      for (let item of latestSection.querySelectorAll("section[id]")) {
        updateSectionById(item.getAttribute("id"));
      }

      if ("IntersectionObserver" in window) {
        window.hackerNewsState = { index: [], nextTimeIndex: -1 };

        const addNewsItem = async (newsItem, queue) => {
          try {
            const { date, time, itemComments, itemTitle, itemLink } = newsItem;
            const section = await buildNextItem({
              document,
              dateTime: `${date}, ${time}`,
              itemComments,
              itemLink,
              itemTitle: new DOMParser().parseFromString(
                itemTitle.replace(/\\/g, ""),
                "text/html"
              ).documentElement.textContent,
              fetchItemDetails: false,
            });

            // display loading indicator for section
            section.querySelector(".points-container").innerHTML =
              'Points: <span class="points"><img style="height: 100%;" src="lib/images/loading.svg" /></span>';

            const id = section.getAttribute("id");
            if (!document.getElementById(id)) {
              document.getElementById("latest").appendChild(section);

              queue.addItemById(id);
            }
          } catch (error) {}
        };

        const buildArchiveIndex = async (lastDateTime) => {
          const nextDate = lastDateTime.slice(0, 10);
          const nextYear = nextDate.slice(0, 4);

          return (
            await (
              await fetch(
                `https://raw.githubusercontent.com/kherrick/hacker-news/main/archives/${nextYear}/${nextDate}/index.md`
              )
            ).text()
          )
            .split("\n")
            .filter((line) => line.match(new RegExp("^\\* \\[")))
            .map((line) => {
              const segment = line.replace("* ", "").split("](");
              const pubDate = segment[0].slice(1);

              const itemComments = segment[1].split(") - [")[0];
              const itemTitle = segment[1].split(") - [")[1];
              const itemLink = segment[2].slice(0, -1);
              const date = pubDate.slice(0, 10);
              const time = pubDate.slice(-8);

              return {
                date,
                itemComments,
                itemLink,
                itemTitle,
                time,
              };
            });
        };

        const handleIntersectingEntry = async (entry, queue) => {
          if (entry.isIntersecting) {
            const lastDateTime = document
              .getElementById("latest")
              .querySelector(
                "section:last-child > section > h4 > span"
              ).textContent;

            const nextDateTime = getNextDateTime(lastDateTime ?? "", -1);
            const archiveIndex = await buildArchiveIndex(nextDateTime);
            const nextTimeIndex = archiveIndex.findIndex(
              ({ time }) => time === nextDateTime.slice(-8)
            );

            const handleIndexUpdate = (index, existingIndexValues = []) => {
              index.forEach((i) => {
                existingIndexValues.push(i);
              });
              return existingIndexValues;
            };

            window.hackerNewsState = {
              index: handleIndexUpdate(
                archiveIndex,
                window.hackerNewsState.index
              ),
              nextTimeIndex,
            };

            let currentTimeIndex = nextTimeIndex + 1;
            const items = Object.values(window.hackerNewsState.index);
            for (let item of items) {
              if (currentTimeIndex < window.hackerNewsState.index.length) {
                addNewsItem(items[currentTimeIndex], queue);

                currentTimeIndex = currentTimeIndex + 1;
              }
            }

            queue.flush();
          }
        };

        const archives = document.getElementById("archives");
        const archivesObserver = new IntersectionObserver(
          (entries) => {
            const queue = new UpdateQueue();

            entries.forEach((entry) => handleIntersectingEntry(entry, queue));
          },
          {
            root: null,
            rootMargin: "0px",
            threshold: 0,
          }
        );

        archivesObserver.observe(archives);

        let latestSectionsExpanded = true;
        const handleLatestHeaderClick = () => {
          latestSectionsExpanded = !latestSectionsExpanded;

          if (latestSectionsExpanded) {
            archivesObserver.observe(archives);
          } else {
            archivesObserver.disconnect(archives);
          }

          for (let section of document.querySelectorAll("#latest > section")) {
            section.style.display = latestSectionsExpanded ? "block" : "none";
          }
        };

        const latestHeader = document.querySelector("#latest > h2");
        latestHeader.style.cursor = "pointer";
        latestHeader.addEventListener("click", handleLatestHeaderClick);
      }
    </script>
    <script type="module">
      import { Workbox } from "https://storage.googleapis.com/workbox-cdn/releases/6.4.1/workbox-window.prod.mjs";

      if ("serviceWorker" in navigator) {
        const base = document.querySelector("base");
        const serviceWorkerPath = `${
          base ? base.href.replace(/\/$/, "") : ""
        }/service-worker.js`;

        const wb = new Workbox(serviceWorkerPath);

        // setup event listeners
        wb.addEventListener("waiting", (event) => {
          wb.addEventListener("controlling", () => {
            window.location.reload();
          });

          wb.messageSkipWaiting();
        });

        wb.register();
      }
    </script>
  </body>
</html>
