<!DOCTYPE html>
<html lang="en" xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta charset="utf-8" />
    <meta
      content="width=device-width, initial-scale=1.0, viewport-fit=cover"
      name="viewport"
    />
    <meta name="description" content="Hacker News" />
    <meta name="theme-color" content="#fff" />
    <title>Hacker News</title>
    <link rel="manifest" href="manifest.json" />
    <link
      href="data:image/x-icon;base64,AAABAAEAAQECAAEAAQA4AAAAFgAAACgAAAABAAAAAgAAAAEAAQAAAAAAAAAAAAAAAAAAAAAAAAAAAAABAAEAAQECAAEAAQA4AAAAFgAAACgAAAABAAAAAgAAAAEAAQAAAAAAAAAAAAAAAAAAAAAAAAAA"
      rel="icon"
      type="image/x-icon"
    />
    <link
      href="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAgAAAAIAAQMAAADOtka5AAAAA1BMVEUAAACnej3aAAAANklEQVR42u3BAQEAAACCIP+vbkhAAQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAB8G4IAAAFjdVCkAAAAAElFTkSuQmCC"
      rel="apple-touch-icon"
    />
    <style>
      /*<!--*/
      body {
        color: rgb(25, 25, 25);
        font-family: Verdana, Geneva, sans-serif;
        margin: 0;
      }

      a {
        text-decoration: none;
      }

      a:link,
      a:focus,
      a:hover,
      a:active {
        color: rgb(75, 75, 125);
      }

      a:visited {
        color: rgb(25, 25, 25);
      }

      h1 > a,
      h1 > a:link,
      h1 > a:focus,
      h1 > a:hover,
      h1 > a:active,
      h1 > a:visited,
      h2 > a,
      h2 > a:link,
      h2 > a:focus,
      h2 > a:hover,
      h2 > a:active,
      h2 > a:visited {
        color: rgb(25, 25, 25);
      }

      h1 {
        background-color: rgb(255, 102, 0);
        margin: 0;
        padding: 1rem;
      }

      h2 {
        background-color: rgb(200, 200, 200);
        margin: 1rem 0;
        padding: 0.5rem 0.5rem 0.5rem 1rem;
      }

      #latest > section,
      #archives > section {
        margin: 0 1rem 1rem 1rem;
        padding-bottom: 1rem;
      }

      #latest > section:not(:last-child),
      #archives > section:not(:last-child) {
        border-bottom: 1px dotted rgb(200, 200, 200);
      }

      section > h3 {
        margin: 0 0 0.5rem 0;
      }

      section > h4 {
        font-weight: normal;
        margin: 0 0 0 1rem;
      }

      .descendants-container,
      .points-container {
        align-items: center;
        border-left: 1px solid #333;
        display: inline-flex;
        margin-left: 0.5rem;
        padding-left: 0.5rem;
        text-align: center;
      }

      .points {
        align-items: center;
        display: inline-flex;
        height: 1rem;
        margin-left: 1ch;
        min-width: 3ch;
      }

      .text {
        line-height: 1.5rem;
        margin: 1rem 1rem 0 1rem;
        overflow: auto;
      }

      .text > p:first-child {
        margin-top: 1rem;
      }

      .text > p:last-child {
        margin-bottom: 0;
      }
      /*-->*/
    </style>
  </head>

  <body>
    <main>
      <h1><a href="https://kherrick.github.io/hacker-news/">Hacker News</a></h1>
      <section id="latest">
        <h2>Latest</h2>
        <section id="36407245">
          <h3>
            <a
              class="item"
              href="https://docs.gitlab.com/ee/user/free_user_limit.html"
              >Gitlab has introduced a five-user limit for free groups</a
            >
          </h3>
          <section>
            <h4>
              <span>2023-06-20 @ 17:14:32</span
              ><span class="points-container"
                >Points: <span class="points">24</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=36407245"
                  >Comments</a
                ><span class="descendants">: 12</span></span
              >
            </h4>
          </section>
        </section>
        <section id="36406352">
          <h3>
            <a
              class="item"
              href="https://github.com/settinger/selectric_typeballs"
              >How to make your own Selectric Typeballs</a
            >
          </h3>
          <section>
            <h4>
              <span>2023-06-20 @ 16:18:29</span
              ><span class="points-container"
                >Points: <span class="points">13</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=36406352"
                  >Comments</a
                ><span class="descendants">: 3</span></span
              >
            </h4>
          </section>
        </section>
        <section id="36405761">
          <h3>
            <a class="item" href="https://github.com/shayonj/pg_easy_replicate"
              >Minimal downtime major PostgreSQL version upgrades with
              pg_easy_replicate</a
            >
          </h3>
          <section>
            <h4>
              <span>2023-06-20 @ 15:46:23</span
              ><span class="points-container"
                >Points: <span class="points">107</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=36405761"
                  >Comments</a
                ><span class="descendants">: 19</span></span
              >
            </h4>
          </section>
        </section>
        <section id="36405024">
          <h3>
            <a
              class="item"
              href="https://www.usatoday.com/story/opinion/2023/06/20/gannett-ceo-why-we-are-suing-google-for-its-business-practices/70336910007/"
              >Gannett CEO: Here's why we are suing Google for deceptive
              business practices</a
            >
          </h3>
          <section>
            <h4>
              <span>2023-06-20 @ 14:59:14</span
              ><span class="points-container"
                >Points: <span class="points">140</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=36405024"
                  >Comments</a
                ><span class="descendants">: 86</span></span
              >
            </h4>
          </section>
        </section>
        <section id="36405004">
          <h3>
            <a class="item" href="https://render.com/blog/render-series-b"
              >Render Raises $50M Series B</a
            >
          </h3>
          <section>
            <h4>
              <span>2023-06-20 @ 14:58:08</span
              ><span class="points-container"
                >Points: <span class="points">38</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=36405004"
                  >Comments</a
                ><span class="descendants">: 8</span></span
              >
            </h4>
          </section>
        </section>
        <section id="36404758">
          <h3>
            <a
              class="item"
              href="https://www.swpc.noaa.gov/products/alerts-watches-and-warnings"
              >Warning: Geomagnetic K-index of 4 expected; electron 2MeV
              Integral Flux &amp;gt;1000pfu</a
            >
          </h3>
          <section>
            <h4>
              <span>2023-06-20 @ 14:42:16</span
              ><span class="points-container"
                >Points: <span class="points">16</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=36404758"
                  >Comments</a
                ><span class="descendants">: 9</span></span
              >
            </h4>
          </section>
        </section>
        <section id="36404743">
          <h3>
            <a class="item" href="https://stackoverflow.co/labs/"
              >Stackoverflow is investing into baking GenAI</a
            >
          </h3>
          <section>
            <h4>
              <span>2023-06-20 @ 14:41:12</span
              ><span class="points-container"
                >Points: <span class="points">64</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=36404743"
                  >Comments</a
                ><span class="descendants">: 63</span></span
              >
            </h4>
          </section>
        </section>
        <section id="36404622">
          <h3>
            <a class="item" href="https://github.com/undb-xyz/undb"
              >Undb – Private first, unified, self-hosted no code database</a
            >
          </h3>
          <section>
            <h4>
              <span>2023-06-20 @ 14:34:13</span
              ><span class="points-container"
                >Points: <span class="points">62</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=36404622"
                  >Comments</a
                ><span class="descendants">: 21</span></span
              >
            </h4>
          </section>
        </section>
        <section id="36403607">
          <h3>
            <a class="item" href="https://news.ycombinator.com/item?id=36403607"
              >Tell HN: Stripe killed my music locker service, so I'm open
              sourcing it</a
            >
          </h3>
          <section>
            <h4>
              <span>2023-06-20 @ 13:24:24</span
              ><span class="points-container"
                >Points: <span class="points">352</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=36403607"
                  >Comments</a
                ><span class="descendants">: 131</span></span
              >
            </h4>
            <div class="text">
              <p>
                I run a small website at inter.tube. It lets you upload your
                music collection and stores it in Backblaze B2. It provides a
                simple web interface to listen to your collection, and support
                for the Subsonic API (allowing native apps to use it).
                Fundamentally it is not very different from something like
                Dropbox or Backblaze: it is a "dumb" backup that simply stores
                what you give it. It doesn't perform "matching" against other
                files, it doesn't allow you to access music you didn't
                explicitly upload, and it doesn't even deduplicate files between
                different users. It doesn't allow "sharing" of music either,
                download links are tied to a short access token for a specific
                user's login session. The only difference between other backup
                services is that we use the metadata tags in your uploads to
                organize things better. According to Capitol Records, Inc. v.
                MP3Tunes, LLC, this is absolutely OK in the eyes of the law
                (thank you to a fellow HN user for telling me about this court
                case). Note that we don't even perform deduplication, which was
                the main controversy in that case.
              </p>
              <p>
                I have been using Stripe happily for a couple years now, but
                suddenly (less than 10 minutes after a subscription payment went
                through), Stripe decided that I violated their Restricted
                Business policy, in particular "Products and services that
                infringe intellectual property rights: Sales or distribution of
                music, movies, software, or any other licensed materials without
                appropriate authorization". I thought this was a
                misunderstanding so I clarified that we don't sell music, just
                storage space (see paragraph above), but they denied my appeal
                with a short template response.
              </p>
              <p>
                This saddens me because my reasons for starting the site are the
                exact opposite of piracy! I was sick of artists getting paid
                virtually nothing for streaming service plays, so I decided to
                buy full albums directly from the artist as much as I could.
                inter.tube just allows you to keep your collection safe and
                easily accessible.
              </p>
              <p>
                I'm posting this mostly to warn other Stripe users that
                essentially any backup service could "violate" these terms, so
                be careful about the marketing blurbs on your website. Probably
                any mention of "music" whatsoever is enough to get your account
                nuked. I really liked Stripe, always recommended it because of
                its nice API, but I won't be doing that anymore.
              </p>
              <p>
                inter.tube will likely die. I'm going to refund my few paying
                users and disable account registration later, I guess.
              </p>
              <p>
                As a bonus, I've open-sourced inter.tube. However, it is
                difficult to run because it relies on a bunch of random cloud
                services (Backblaze B2 + Cloudflare Workers + Lambda) and
                there's some hard-coded stuff in there, so it's probably not
                very useful beyond curiosity. If anyone would like to help me
                with the open sourcing, let me know, and I'll get back to you
                whenever I have time. Of course, feel free to fork it as well. I
                am also on GitHub sponsors if anyone would like to sponsor me to
                help make it easier to self-host (or at least self-deploy).
              </p>
              <p>Source code: https://github.com/guregu/intertube</p>
            </div>
          </section>
        </section>
        <section id="36403494">
          <h3>
            <a
              class="item"
              href="https://ev-edition.com/2023/06/rivian-joins-forces-with-tesla-embracing-their-charging-standard-for-electric-vehicles/"
              >Rivian Joins Forces with Tesla, Embracing Their Charging Standard
              for EVs</a
            >
          </h3>
          <section>
            <h4>
              <span>2023-06-20 @ 13:16:17</span
              ><span class="points-container"
                >Points: <span class="points">208</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=36403494"
                  >Comments</a
                ><span class="descendants">: 277</span></span
              >
            </h4>
          </section>
        </section>
        <section id="36403430">
          <h3>
            <a class="item" href="https://the-federation.info/platform/73"
              >Lemmy stats (users, posts, nodes, comments)</a
            >
          </h3>
          <section>
            <h4>
              <span>2023-06-20 @ 13:09:06</span
              ><span class="points-container"
                >Points: <span class="points">137</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=36403430"
                  >Comments</a
                ><span class="descendants">: 85</span></span
              >
            </h4>
          </section>
        </section>
        <section id="36403355">
          <h3>
            <a
              class="item"
              href="https://gist.github.com/nat-418/bdccb2428cde750c9f42bf9bbc1a50d3"
              >Why Tcl?</a
            >
          </h3>
          <section>
            <h4>
              <span>2023-06-20 @ 13:01:31</span
              ><span class="points-container"
                >Points: <span class="points">127</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=36403355"
                  >Comments</a
                ><span class="descendants">: 85</span></span
              >
            </h4>
          </section>
        </section>
        <section id="36403345">
          <h3>
            <a
              class="item"
              href="https://www.ncbi.nlm.nih.gov/pmc/articles/PMC9326257/"
              >Benzene Exposure Alters Endocrine Activity</a
            >
          </h3>
          <section>
            <h4>
              <span>2023-06-20 @ 12:59:57</span
              ><span class="points-container"
                >Points: <span class="points">81</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=36403345"
                  >Comments</a
                ><span class="descendants">: 54</span></span
              >
            </h4>
          </section>
        </section>
        <section id="36403280">
          <h3>
            <a class="item" href="https://pubmed.ncbi.nlm.nih.gov/37293324/"
              >Loneliness is stronger when not alone</a
            >
          </h3>
          <section>
            <h4>
              <span>2023-06-20 @ 12:53:15</span
              ><span class="points-container"
                >Points: <span class="points">346</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=36403280"
                  >Comments</a
                ><span class="descendants">: 270</span></span
              >
            </h4>
          </section>
        </section>
        <section id="36403087">
          <h3>
            <a
              class="item"
              href="https://making.close.com/posts/native-enums-or-check-constraints-in-postgresql"
              >Representing Enums in PostgreSQL</a
            >
          </h3>
          <section>
            <h4>
              <span>2023-06-20 @ 12:31:44</span
              ><span class="points-container"
                >Points: <span class="points">77</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=36403087"
                  >Comments</a
                ><span class="descendants">: 40</span></span
              >
            </h4>
          </section>
        </section>
        <section id="36402390">
          <h3>
            <a
              class="item"
              href="https://adam-mcdaniel-blog.github.io/compilers-for-the-future/"
              >Compilers for the Future</a
            >
          </h3>
          <section>
            <h4>
              <span>2023-06-20 @ 11:15:21</span
              ><span class="points-container"
                >Points: <span class="points">46</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=36402390"
                  >Comments</a
                ><span class="descendants">: 38</span></span
              >
            </h4>
          </section>
        </section>
        <section id="36402162">
          <h3>
            <a
              class="item"
              href="https://mullvad.net/en/blog/2023/6/20/introducing-mullvad-leta-a-search-engine-used-in-the-mullvad-browser/"
              >Mullvad Leta: A search engine used in the Mullvad Browser</a
            >
          </h3>
          <section>
            <h4>
              <span>2023-06-20 @ 10:48:39</span
              ><span class="points-container"
                >Points: <span class="points">215</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=36402162"
                  >Comments</a
                ><span class="descendants">: 86</span></span
              >
            </h4>
          </section>
        </section>
        <section id="36401999">
          <h3>
            <a class="item" href="https://sub.rehab/"
              >Sub.Rehab – See where Reddit communities have relocated</a
            >
          </h3>
          <section>
            <h4>
              <span>2023-06-20 @ 10:26:37</span
              ><span class="points-container"
                >Points: <span class="points">376</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=36401999"
                  >Comments</a
                ><span class="descendants">: 216</span></span
              >
            </h4>
          </section>
        </section>
        <section id="36401863">
          <h3>
            <a
              class="item"
              href="https://e360.yale.edu/features/on-site-distributed-premise-graywater-blackwater-recycling"
              >Cities turn to ‘extreme’ water recycling</a
            >
          </h3>
          <section>
            <h4>
              <span>2023-06-20 @ 10:05:54</span
              ><span class="points-container"
                >Points: <span class="points">118</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=36401863"
                  >Comments</a
                ><span class="descendants">: 221</span></span
              >
            </h4>
          </section>
        </section>
        <section id="36401854">
          <h3>
            <a class="item" href="https://darekkay.com/blog/rss-styling/"
              >Style your RSS feed</a
            >
          </h3>
          <section>
            <h4>
              <span>2023-06-20 @ 10:04:29</span
              ><span class="points-container"
                >Points: <span class="points">265</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=36401854"
                  >Comments</a
                ><span class="descendants">: 106</span></span
              >
            </h4>
          </section>
        </section>
        <section id="36401747">
          <h3>
            <a class="item" href="https://samwho.dev/hashing/">Hashing</a>
          </h3>
          <section>
            <h4>
              <span>2023-06-20 @ 09:48:26</span
              ><span class="points-container"
                >Points: <span class="points">185</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=36401747"
                  >Comments</a
                ><span class="descendants">: 41</span></span
              >
            </h4>
          </section>
        </section>
        <section id="36401676">
          <h3>
            <a class="item" href="https://smoothshadows.com/"
              >I made a smooth shadows generator</a
            >
          </h3>
          <section>
            <h4>
              <span>2023-06-20 @ 09:38:31</span
              ><span class="points-container"
                >Points: <span class="points">172</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=36401676"
                  >Comments</a
                ><span class="descendants">: 42</span></span
              >
            </h4>
          </section>
        </section>
        <section id="36401359">
          <h3>
            <a
              class="item"
              href="https://yotam.net/posts/why-i-give-up-on-free-software-phones/"
              >I Give Up on Free Software Phones</a
            >
          </h3>
          <section>
            <h4>
              <span>2023-06-20 @ 08:53:07</span
              ><span class="points-container"
                >Points: <span class="points">35</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=36401359"
                  >Comments</a
                ><span class="descendants">: 24</span></span
              >
            </h4>
          </section>
        </section>
        <section id="36400744">
          <h3>
            <a
              class="item"
              href="https://www.ycombinator.com/companies/slauth-io/jobs/5MlboDb-cto"
              >Slauth.io (YC S22) Is Hiring a CTO</a
            >
          </h3>
          <section>
            <h4>
              <span>2023-06-20 @ 07:21:00</span
              ><span class="points-container"
                >Points: <span class="points">1</span></span
              >
            </h4>
          </section>
        </section>
        <section id="36400524">
          <h3>
            <a
              class="item"
              href="https://www.undeadly.org/cgi?action=article;sid=20230620064255"
              >OpenBSD: Shutdown/reboot now require membership of group
              _shutdown</a
            >
          </h3>
          <section>
            <h4>
              <span>2023-06-20 @ 06:43:32</span
              ><span class="points-container"
                >Points: <span class="points">120</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=36400524"
                  >Comments</a
                ><span class="descendants">: 91</span></span
              >
            </h4>
          </section>
        </section>
        <section id="36400283">
          <h3>
            <a class="item" href="https://www.cpushack.com/CPU/cpu.html"
              >Great Microprocessors of the Past and Present (2003)</a
            >
          </h3>
          <section>
            <h4>
              <span>2023-06-20 @ 06:01:08</span
              ><span class="points-container"
                >Points: <span class="points">29</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=36400283"
                  >Comments</a
                ><span class="descendants">: 7</span></span
              >
            </h4>
          </section>
        </section>
        <section id="36399874">
          <h3>
            <a
              class="item"
              href="http://commonplace.online/article/underage-enlistment-in-the-united-states-and-the-confederacy/"
              >Underage Enlistment in the United States and the Confederacy</a
            >
          </h3>
          <section>
            <h4>
              <span>2023-06-20 @ 04:52:58</span
              ><span class="points-container"
                >Points: <span class="points">24</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=36399874"
                  >Comments</a
                ><span class="descendants">: 29</span></span
              >
            </h4>
          </section>
        </section>
        <section id="36387292">
          <h3>
            <a
              class="item"
              href="https://www.afar.com/magazine/a-love-letter-to-driving-alone"
              >A Love Letter to Driving Alone</a
            >
          </h3>
          <section>
            <h4>
              <span>2023-06-19 @ 04:18:33</span
              ><span class="points-container"
                >Points: <span class="points">92</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=36387292"
                  >Comments</a
                ><span class="descendants">: 108</span></span
              >
            </h4>
          </section>
        </section>
        <section id="36385729">
          <h3>
            <a
              class="item"
              href="https://www.tweag.io/blog/2023-04-20-medical-computing-at-scale/"
              >Processing medical images at scale on the cloud</a
            >
          </h3>
          <section>
            <h4>
              <span>2023-06-18 @ 23:51:57</span
              ><span class="points-container"
                >Points: <span class="points">52</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=36385729"
                  >Comments</a
                ><span class="descendants">: 1</span></span
              >
            </h4>
          </section>
        </section>
        <section id="36385198">
          <h3>
            <a
              class="item"
              href="https://literateprograms.org/mind_reading_machine__awk_.html"
              >Shannon's Mind-Reading Machine</a
            >
          </h3>
          <section>
            <h4>
              <span>2023-06-18 @ 22:30:04</span
              ><span class="points-container"
                >Points: <span class="points">19</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=36385198"
                  >Comments</a
                ><span class="descendants">: 11</span></span
              >
            </h4>
          </section>
        </section>
      </section>
      <section id="archives">
        <h2>
          <a
            href="https://github.com/kherrick/hacker-news/blob/main/archives/index.md"
            >Archives</a
          >
        </h2>
        <section>
          <h3>
            <a
              href="https://github.com/kherrick/hacker-news/blob/main/archives/2023/index.md"
              >2023</a
            >
          </h3>
        </section>
        <section>
          <h3>
            <a
              href="https://github.com/kherrick/hacker-news/blob/main/archives/2022/index.md"
              >2022</a
            >
          </h3>
        </section>
      </section>
    </main>
    <script type="module">
      import { buildDescendants } from "./lib/build-html-descendants.js";
      import { buildNextItem } from "./lib/build-html-next-item.js";
      import { getNextDateTime } from "./lib/date-time.js";

      const updateSectionById = (id) =>
        fetch(`https://hacker-news.firebaseio.com/v0/item/${id}.json`).then(
          (result) =>
            result.json().then(({ descendants, id, score, text, type }) => {
              const currentItem = document.getElementById(id);

              if (score) {
                currentItem.querySelector(".points").textContent = score;
              }

              if (descendants && (type === "poll" || type === "story")) {
                const currentDescendants =
                  currentItem.querySelector(".descendants");

                if (currentDescendants) {
                  currentDescendants.textContent = `: ${descendants}`;
                } else {
                  const comments = buildDescendants(
                    document,
                    descendants,
                    `https://news.ycombinator.com/item?id=${id}`
                  );

                  currentItem.querySelector("h4").appendChild(comments);
                }
              }

              if (text) {
                const currentText = currentItem.querySelector(".text");

                if (currentText) {
                  currentText.innerHTML = text.replace(/\0/g, "");
                } else {
                  const content = document.createElement("div");
                  content.innerHTML = text.replace(/\0/g, "");
                  content.setAttribute("class", "text");

                  currentItem.appendChild(content);
                }
              }
            })
        );

      class UpdateQueue {
        constructor() {
          this._ids = [];
          this._isUpdating = false;
        }

        addItemById(id) {
          this._ids.push(id);
        }

        async flush() {
          const id = this._ids.shift();

          if (id) {
            this._isUpdating = true;

            await updateSectionById(id);
            await this.flush();
          } else {
            this._isUpdating = false;

            setTimeout(async () => {
              if (!this._isUpdating && this._ids && this._ids.length) {
                await this.flush();
              }
            }, 0);
          }
        }
      }

      // get latest data
      const latestSection = document.getElementById("latest");

      for (let item of latestSection.querySelectorAll("section[id]")) {
        updateSectionById(item.getAttribute("id"));
      }

      if ("IntersectionObserver" in window) {
        window.hackerNewsState = { index: [], nextTimeIndex: -1 };

        const addNewsItem = async (newsItem, queue) => {
          try {
            const { date, time, itemComments, itemTitle, itemLink } = newsItem;
            const section = await buildNextItem({
              document,
              dateTime: `${date}, ${time}`,
              itemComments,
              itemLink,
              itemTitle: new DOMParser().parseFromString(
                itemTitle.replace(/\\/g, ""),
                "text/html"
              ).documentElement.textContent,
              fetchItemDetails: false,
            });

            // display loading indicator for section
            section.querySelector(".points-container").innerHTML =
              'Points: <span class="points"><img style="height: 100%;" src="lib/images/loading.svg" /></span>';

            const id = section.getAttribute("id");
            if (!document.getElementById(id)) {
              document.getElementById("latest").appendChild(section);

              queue.addItemById(id);
            }
          } catch (error) {}
        };

        const buildArchiveIndex = async (lastDateTime) => {
          const nextDate = lastDateTime.slice(0, 10);
          const nextYear = nextDate.slice(0, 4);

          return (
            await (
              await fetch(
                `https://raw.githubusercontent.com/kherrick/hacker-news/main/archives/${nextYear}/${nextDate}/index.md`
              )
            ).text()
          )
            .split("\n")
            .filter((line) => line.match(new RegExp("^\\* \\[")))
            .map((line) => {
              const segment = line.replace("* ", "").split("](");
              const pubDate = segment[0].slice(1);

              const itemComments = segment[1].split(") - [")[0];
              const itemTitle = segment[1].split(") - [")[1];
              const itemLink = segment[2].slice(0, -1);
              const date = pubDate.slice(0, 10);
              const time = pubDate.slice(-8);

              return {
                date,
                itemComments,
                itemLink,
                itemTitle,
                time,
              };
            });
        };

        const handleIntersectingEntry = async (entry, queue) => {
          if (entry.isIntersecting) {
            const lastDateTime = document
              .getElementById("latest")
              .querySelector(
                "section:last-child > section > h4 > span"
              ).textContent;

            const nextDateTime = getNextDateTime(lastDateTime ?? "", -1);
            const archiveIndex = await buildArchiveIndex(nextDateTime);
            const nextTimeIndex = archiveIndex.findIndex(
              ({ time }) => time === nextDateTime.slice(-8)
            );

            const handleIndexUpdate = (index, existingIndexValues = []) => {
              index.forEach((i) => {
                existingIndexValues.push(i);
              });
              return existingIndexValues;
            };

            window.hackerNewsState = {
              index: handleIndexUpdate(
                archiveIndex,
                window.hackerNewsState.index
              ),
              nextTimeIndex,
            };

            let currentTimeIndex = nextTimeIndex + 1;
            const items = Object.values(window.hackerNewsState.index);
            for (let item of items) {
              if (currentTimeIndex < window.hackerNewsState.index.length) {
                addNewsItem(items[currentTimeIndex], queue);

                currentTimeIndex = currentTimeIndex + 1;
              }
            }

            queue.flush();
          }
        };

        const archives = document.getElementById("archives");
        const archivesObserver = new IntersectionObserver(
          (entries) => {
            const queue = new UpdateQueue();

            entries.forEach((entry) => handleIntersectingEntry(entry, queue));
          },
          {
            root: null,
            rootMargin: "0px",
            threshold: 0,
          }
        );

        archivesObserver.observe(archives);

        let latestSectionsExpanded = true;
        const handleLatestHeaderClick = () => {
          latestSectionsExpanded = !latestSectionsExpanded;

          if (latestSectionsExpanded) {
            archivesObserver.observe(archives);
          } else {
            archivesObserver.disconnect(archives);
          }

          for (let section of document.querySelectorAll("#latest > section")) {
            section.style.display = latestSectionsExpanded ? "block" : "none";
          }
        };

        const latestHeader = document.querySelector("#latest > h2");
        latestHeader.style.cursor = "pointer";
        latestHeader.addEventListener("click", handleLatestHeaderClick);
      }
    </script>
    <script type="module">
      import { Workbox } from "https://storage.googleapis.com/workbox-cdn/releases/6.4.1/workbox-window.prod.mjs";

      if ("serviceWorker" in navigator) {
        const base = document.querySelector("base");
        const serviceWorkerPath = `${
          base ? base.href.replace(/\/$/, "") : ""
        }/service-worker.js`;

        const wb = new Workbox(serviceWorkerPath);

        // setup event listeners
        wb.addEventListener("waiting", (event) => {
          wb.addEventListener("controlling", () => {
            window.location.reload();
          });

          wb.messageSkipWaiting();
        });

        wb.register();
      }
    </script>
  </body>
</html>
