<!DOCTYPE html>
<html lang="en" xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta charset="utf-8" />
    <meta
      content="width=device-width, initial-scale=1.0, viewport-fit=cover"
      name="viewport"
    />
    <meta name="description" content="Hacker News" />
    <meta name="theme-color" content="#fff" />
    <title>Hacker News</title>
    <link rel="manifest" href="manifest.json" />
    <link
      href="data:image/x-icon;base64,AAABAAEAAQECAAEAAQA4AAAAFgAAACgAAAABAAAAAgAAAAEAAQAAAAAAAAAAAAAAAAAAAAAAAAAAAAABAAEAAQECAAEAAQA4AAAAFgAAACgAAAABAAAAAgAAAAEAAQAAAAAAAAAAAAAAAAAAAAAAAAAA"
      rel="icon"
      type="image/x-icon"
    />
    <link
      href="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAgAAAAIAAQMAAADOtka5AAAAA1BMVEUAAACnej3aAAAANklEQVR42u3BAQEAAACCIP+vbkhAAQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAB8G4IAAAFjdVCkAAAAAElFTkSuQmCC"
      rel="apple-touch-icon"
    />
    <style>
      /*<!--*/
      body {
        color: rgb(25, 25, 25);
        font-family: Verdana, Geneva, sans-serif;
        margin: 0;
      }

      a {
        text-decoration: none;
      }

      a:link,
      a:focus,
      a:hover,
      a:active {
        color: rgb(75, 75, 125);
      }

      a:visited {
        color: rgb(25, 25, 25);
      }

      h1 > a,
      h1 > a:link,
      h1 > a:focus,
      h1 > a:hover,
      h1 > a:active,
      h1 > a:visited,
      h2 > a,
      h2 > a:link,
      h2 > a:focus,
      h2 > a:hover,
      h2 > a:active,
      h2 > a:visited {
        color: rgb(25, 25, 25);
      }

      h1 {
        background-color: rgb(255, 102, 0);
        margin: 0;
        padding: 1rem;
      }

      h2 {
        background-color: rgb(200, 200, 200);
        margin: 1rem 0;
        padding: 0.5rem 0.5rem 0.5rem 1rem;
      }

      #latest > section,
      #archives > section {
        margin: 0 1rem 1rem 1rem;
        padding-bottom: 1rem;
      }

      #latest > section:not(:last-child),
      #archives > section:not(:last-child) {
        border-bottom: 1px dotted rgb(200, 200, 200);
      }

      section > h3 {
        margin: 0 0 0.5rem 0;
      }

      section > h4 {
        font-weight: normal;
        margin: 0 0 0 1rem;
      }

      .descendants-container,
      .points-container {
        align-items: center;
        border-left: 1px solid #333;
        display: inline-flex;
        margin-left: 0.5rem;
        padding-left: 0.5rem;
        text-align: center;
      }

      .points {
        align-items: center;
        display: inline-flex;
        height: 1rem;
        margin-left: 1ch;
        min-width: 3ch;
      }

      .text {
        line-height: 1.5rem;
        margin: 1rem 1rem 0 1rem;
        overflow: auto;
      }

      .text > p:first-child {
        margin-top: 1rem;
      }

      .text > p:last-child {
        margin-bottom: 0;
      }
      /*-->*/
    </style>
  </head>

  <body>
    <main>
      <h1><a href="https://kherrick.github.io/hacker-news/">Hacker News</a></h1>
      <section id="latest">
        <h2>Latest</h2>
        <section id="36432637">
          <h3>
            <a
              class="item"
              href="https://invent.kde.org/plasma/kwin/-/issues/169"
              >Roadmap to Vulkan for KDE window manager KWin</a
            >
          </h3>
          <section>
            <h4>
              <span>2023-06-22 @ 14:23:57</span
              ><span class="points-container"
                >Points: <span class="points">12</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=36432637"
                  >Comments</a
                ><span class="descendants">: 0</span></span
              >
            </h4>
          </section>
        </section>
        <section id="36432598">
          <h3>
            <a class="item" href="https://news.ycombinator.com/item?id=36432598"
              >Ask HN: How to Break into AI Engineering</a
            >
          </h3>
          <section>
            <h4>
              <span>2023-06-22 @ 14:21:24</span
              ><span class="points-container"
                >Points: <span class="points">12</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=36432598"
                  >Comments</a
                ><span class="descendants">: 4</span></span
              >
            </h4>
            <div class="text"><p>Gracias!</p></div>
          </section>
        </section>
        <section id="36432591">
          <h3>
            <a
              class="item"
              href="https://www.nbcnews.com/news/world/syria-migrants-boat-sinking-titanic-submersive-missing-rcna90336"
              >Sunken boat killing hundreds overshadowed by Titan submersible
              coverage</a
            >
          </h3>
          <section>
            <h4>
              <span>2023-06-22 @ 14:21:13</span
              ><span class="points-container"
                >Points: <span class="points">10</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=36432591"
                  >Comments</a
                ><span class="descendants">: 0</span></span
              >
            </h4>
          </section>
        </section>
        <section id="36432369">
          <h3>
            <a class="item" href="https://github.com/aeon-toolkit/aeon"
              >Aeon: A unified framework for machine learning with time
              series</a
            >
          </h3>
          <section>
            <h4>
              <span>2023-06-22 @ 14:05:03</span
              ><span class="points-container"
                >Points: <span class="points">6</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=36432369"
                  >Comments</a
                ><span class="descendants">: 0</span></span
              >
            </h4>
          </section>
        </section>
        <section id="36432279">
          <h3>
            <a
              class="item"
              href="https://www.technologyreview.com/2023/06/22/1075405/the-people-paid-to-train-ai-are-outsourcing-their-work-to-ai/"
              >People paid to train AI are outsourcing their work to AI</a
            >
          </h3>
          <section>
            <h4>
              <span>2023-06-22 @ 13:59:07</span
              ><span class="points-container"
                >Points: <span class="points">48</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=36432279"
                  >Comments</a
                ><span class="descendants">: 10</span></span
              >
            </h4>
          </section>
        </section>
        <section id="36432225">
          <h3>
            <a
              class="item"
              href="https://pratik.is/writing/essays/neverending-hustle"
              >The hustle never ends and I'm so over it</a
            >
          </h3>
          <section>
            <h4>
              <span>2023-06-22 @ 13:55:52</span
              ><span class="points-container"
                >Points: <span class="points">72</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=36432225"
                  >Comments</a
                ><span class="descendants">: 35</span></span
              >
            </h4>
          </section>
        </section>
        <section id="36432145">
          <h3>
            <a
              class="item"
              href="https://arstechnica.com/gadgets/2023/06/camera-review-site-dpreview-finds-a-buyer-avoids-shutdown-by-amazon/"
              >Camera review site DPReview finds a buyer, avoids shutdown by
              Amazon</a
            >
          </h3>
          <section>
            <h4>
              <span>2023-06-22 @ 13:49:55</span
              ><span class="points-container"
                >Points: <span class="points">44</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=36432145"
                  >Comments</a
                ><span class="descendants">: 2</span></span
              >
            </h4>
          </section>
        </section>
        <section id="36431917">
          <h3>
            <a class="item" href="https://nanochess.org/video_chess.html"
              >Atari 2600 Video Chess disassembled and commented</a
            >
          </h3>
          <section>
            <h4>
              <span>2023-06-22 @ 13:33:27</span
              ><span class="points-container"
                >Points: <span class="points">53</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=36431917"
                  >Comments</a
                ><span class="descendants">: 2</span></span
              >
            </h4>
          </section>
        </section>
        <section id="36431826">
          <h3>
            <a
              class="item"
              href="https://developer.apple.com/documentation/visionOS"
              >VisionOS developer docs and Vision Pro SDK now available</a
            >
          </h3>
          <section>
            <h4>
              <span>2023-06-22 @ 13:26:54</span
              ><span class="points-container"
                >Points: <span class="points">14</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=36431826"
                  >Comments</a
                ><span class="descendants">: 1</span></span
              >
            </h4>
          </section>
        </section>
        <section id="36431302">
          <h3>
            <a
              class="item"
              href="https://www.vox.com/technology/2023/6/20/23762655/tech-perk-remote-work-freedom-airbnb-yelp"
              >The hottest new perk in tech is freedom</a
            >
          </h3>
          <section>
            <h4>
              <span>2023-06-22 @ 12:46:19</span
              ><span class="points-container"
                >Points: <span class="points">59</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=36431302"
                  >Comments</a
                ><span class="descendants">: 20</span></span
              >
            </h4>
          </section>
        </section>
        <section id="36431268">
          <h3>
            <a
              class="item"
              href="https://tinyempires.substack.com/p/4-mistakes-to-avoid-to-build-a-better"
              >Biggest mistakes to avoid to build a better 1-person business</a
            >
          </h3>
          <section>
            <h4>
              <span>2023-06-22 @ 12:43:26</span
              ><span class="points-container"
                >Points: <span class="points">169</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=36431268"
                  >Comments</a
                ><span class="descendants">: 73</span></span
              >
            </h4>
          </section>
        </section>
        <section id="36431154">
          <h3>
            <a
              class="item"
              href="https://www.gregegan.net/DIDICOSM/Loops/Loops.html"
              >Loops Across Space</a
            >
          </h3>
          <section>
            <h4>
              <span>2023-06-22 @ 12:32:36</span
              ><span class="points-container"
                >Points: <span class="points">57</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=36431154"
                  >Comments</a
                ><span class="descendants">: 21</span></span
              >
            </h4>
          </section>
        </section>
        <section id="36431004">
          <h3>
            <a class="item" href="https://news.ycombinator.com/item?id=36431004"
              >Launch HN: OpenMeter (YC W23) – Real-Time, Open Source Usage
              Metering</a
            >
          </h3>
          <section>
            <h4>
              <span>2023-06-22 @ 12:19:44</span
              ><span class="points-container"
                >Points: <span class="points">33</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=36431004"
                  >Comments</a
                ><span class="descendants">: 7</span></span
              >
            </h4>
            <div class="text">
              <a href="http://openmeter.io">http://openmeter.io</a>). We are
              building an open-source project to help engineers to meter and
              attribute AI and compute usage for billing and analytics use
              cases. Our GitHub is at
              <a href="https://github.com/openmeterio/openmeter"
                >https://github.com/openmeterio/openmeter</a
              >, and there’s a demo video here:
              <a
                href="https://www.loom.com/share/bc1cfa1b7ed94e65bd3a82f9f0334d04"
                >https://www.loom.com/share/bc1cfa1b7ed94e65bd3a82f9f0334d04</a
              >.
              <p>
                Why? Companies are increasingly adopting usage-based pricing
                models, requiring accurate metering. In addition, many SaaS
                products are expected to offer AI capabilities. To effectively
                cover costs and stay profitable, these companies must meter AI
                usage and attribute it to their customers.
              </p>
              <p>
                When I worked at Stripe, my job was to price and attribute
                database usage to product teams. You can think about it like
                internal usage-based pricing to keep teams accountable and the
                business in the margins. This was when I realized that it’s
                challenging to extract usage data from various cloud
                infrastructure components (execution time, bytes stored, query
                complexity, backup size, etc.), meter it accurately, and handle
                failure scenarios like backfills and meter resets. I was
                frustrated that no standard exists to meter cloud
                infrastructure, and we had to do this on our own.
              </p>
              <p>
                Usage metering requires accurately processing large volumes of
                events in real-time to power billing use cases and modern
                data-intensive applications. Imagine you want to meter and bill
                workload execution on a per-second granularity or meter the
                number of API calls you make to a third party and act instantly
                on events like a user hitting a billing threshold. The real-time
                aspect requires instant aggregations and queries; scalability
                means to able to ingest and process millions of usage events per
                second; it must be accurate—billing requires precise metering;
                and it must be fault tolerant, with built-in idempotency, event
                backfills, and meter resets.
              </p>
              <p>
                This is challenging to build out, and the obvious approaches
                don’t work well: writing to a database for each usage event is
                expensive; monitoring systems are cheaper but inaccurate and
                lack idempotency (distributed systems use at-least-once
                delivery); batch processing in the data warehouse has
                unacceptable latency.
              </p>
              <p>
                Companies also need to extract usage data from cloud
                infrastructure (Kubernetes, AWS, etc.), vendors (OpenAI, Twilio,
                etc.), and hardware components to attribute metered usage to
                their customers. Collecting usage in many cases requires writing
                custom code like measuring execution duration, listening to
                lifecycle events, scraping APIs periodically, parsing log
                streams, and attributing usage of shared and multi-tenant
                resources.
              </p>
              <p>
                OpenMeter leverages stream processing to be able to update
                meters in real-time while processing large volumes of events
                simultaneously. The core is written in Go and uses the
                CloudEvents format to describe usage, Kafka to ingest events,
                and ksqlDB to dedupe and aggregate meters. We are also working
                on a Postgres sink for long-term storage. Check out our GitHub
                to learn more:
                <a href="https://github.com/openmeterio/openmeter"
                  >https://github.com/openmeterio/openmeter</a
                >
              </p>
              <p>
                Other companies in the usage-based billing space are focused on
                payments and basically want to be Stripe replacements. With
                OpenMeter, we’re focusing instead on the engineering challenge
                of collecting usage data from cloud infrastructure and balancing
                tradeoffs between cost, scale, accuracy, and staleness. We’re
                not trying to be a payment platform—rather, we want to empower
                engineers to provide fresh and accurate usage data to Product,
                Sales, and Finance, helping them with billing, analytics, and
                revenue use cases.
              </p>
              <p>
                We’re building OpenMeter as an open-source project (Apache 2.0),
                with the goal of making it the standard to collect and share
                usage across many solutions and providers. In the future, we’ll
                offer a hosted / cloud version of OpenMeter with high
                availability guarantees and easy integrations to payment, CRM,
                and analytics solutions.
              </p>
              <p>
                What usage metering issues or experiences do you have? We would
                love to hear your feedback on OpenMeter and to learn from which
                sources you need to extract usage and how the metered data is
                leveraged. Looking forward to your comments!
              </p>
            </div>
          </section>
        </section>
        <section id="36430796">
          <h3>
            <a class="item" href="https://up.codes/careers"
              >UpCodes (YC S17) is doubling engineering and hiring other roles
              too</a
            >
          </h3>
          <section>
            <h4>
              <span>2023-06-22 @ 12:00:14</span
              ><span class="points-container"
                >Points: <span class="points">1</span></span
              >
            </h4>
          </section>
        </section>
        <section id="36430320">
          <h3>
            <a
              class="item"
              href="https://www.thearchaeologist.org/blog/the-abcd-family-tree-by-starkey-comics"
              >Scripts descended from Egyptian hieroglyphs</a
            >
          </h3>
          <section>
            <h4>
              <span>2023-06-22 @ 11:00:57</span
              ><span class="points-container"
                >Points: <span class="points">22</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=36430320"
                  >Comments</a
                ><span class="descendants">: 12</span></span
              >
            </h4>
          </section>
        </section>
        <section id="36430280">
          <h3>
            <a
              class="item"
              href="https://wideangle.co/blog/is-recaptcha-illegal-under-gdpr"
              >Is Google reCAPTCHA GDPR Compliant?</a
            >
          </h3>
          <section>
            <h4>
              <span>2023-06-22 @ 10:55:52</span
              ><span class="points-container"
                >Points: <span class="points">104</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=36430280"
                  >Comments</a
                ><span class="descendants">: 139</span></span
              >
            </h4>
          </section>
        </section>
        <section id="36430172">
          <h3>
            <a
              class="item"
              href="https://kguttag.com/2023/06/21/apple-vision-pro-part-3-why-it-may-be-lousy-for-watching-movies-on-a-plane/"
              >Apple Vision Pro – Why It May Be Lousy for Watching Movies on a
              Plane</a
            >
          </h3>
          <section>
            <h4>
              <span>2023-06-22 @ 10:39:45</span
              ><span class="points-container"
                >Points: <span class="points">74</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=36430172"
                  >Comments</a
                ><span class="descendants">: 179</span></span
              >
            </h4>
          </section>
        </section>
        <section id="36430105">
          <h3>
            <a
              class="item"
              href="https://www.phoronix.com/news/GCC-Code-of-Conduct"
              >GCC Adopts a Code of Conduct</a
            >
          </h3>
          <section>
            <h4>
              <span>2023-06-22 @ 10:30:09</span
              ><span class="points-container"
                >Points: <span class="points">60</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=36430105"
                  >Comments</a
                ><span class="descendants">: 158</span></span
              >
            </h4>
          </section>
        </section>
        <section id="36429988">
          <h3>
            <a
              class="item"
              href="https://www.pcgamer.com/discord-is-opening-the-monetization-floodgates-get-ready-for-microtransaction-stores-and-paid-exclusive-memes/"
              >Discord is opening the monetization floodgates with
              microtransaction stores</a
            >
          </h3>
          <section>
            <h4>
              <span>2023-06-22 @ 10:10:11</span
              ><span class="points-container"
                >Points: <span class="points">76</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=36429988"
                  >Comments</a
                ><span class="descendants">: 114</span></span
              >
            </h4>
          </section>
        </section>
        <section id="36429986">
          <h3>
            <a
              class="item"
              href="https://www.cybertec-postgresql.com/en/unexpected-downsides-of-uuid-keys-in-postgresql/"
              >Unexpected downsides of UUID keys in PostgreSQL</a
            >
          </h3>
          <section>
            <h4>
              <span>2023-06-22 @ 10:10:10</span
              ><span class="points-container"
                >Points: <span class="points">155</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=36429986"
                  >Comments</a
                ><span class="descendants">: 113</span></span
              >
            </h4>
          </section>
        </section>
        <section id="36428044">
          <h3>
            <a class="item" href="https://bvisness.me/coroutines/"
              >Coroutines make robot code easy for high schoolers</a
            >
          </h3>
          <section>
            <h4>
              <span>2023-06-22 @ 04:35:31</span
              ><span class="points-container"
                >Points: <span class="points">128</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=36428044"
                  >Comments</a
                ><span class="descendants">: 68</span></span
              >
            </h4>
          </section>
        </section>
        <section id="36427849">
          <h3>
            <a
              class="item"
              href="https://jasonfeifer.beehiiv.com/p/the-thing-that-seems-like-a-bad-idea-maybe-try-it"
              >How to do the thing you've been avoiding</a
            >
          </h3>
          <section>
            <h4>
              <span>2023-06-22 @ 03:54:19</span
              ><span class="points-container"
                >Points: <span class="points">378</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=36427849"
                  >Comments</a
                ><span class="descendants">: 167</span></span
              >
            </h4>
          </section>
        </section>
        <section id="36427583">
          <h3>
            <a
              class="item"
              href="https://claudioholanda.ch/en/blog/svelte-kit-after-3-billion-requests/"
              >Thoughts on Svelte(Kit), one year and 3B requests later</a
            >
          </h3>
          <section>
            <h4>
              <span>2023-06-22 @ 03:09:59</span
              ><span class="points-container"
                >Points: <span class="points">250</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=36427583"
                  >Comments</a
                ><span class="descendants">: 131</span></span
              >
            </h4>
          </section>
        </section>
        <section id="36427374">
          <h3>
            <a
              class="item"
              href="https://www-sop.inria.fr/members/Ian.Jermyn/philosophy/writings/Boxonmaths.pdf"
              >Science and Statistics (1976) [pdf]</a
            >
          </h3>
          <section>
            <h4>
              <span>2023-06-22 @ 02:33:56</span
              ><span class="points-container"
                >Points: <span class="points">70</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=36427374"
                  >Comments</a
                ><span class="descendants">: 4</span></span
              >
            </h4>
          </section>
        </section>
        <section id="36426136">
          <h3>
            <a class="item" href="https://arxiv.org/abs/2305.20030"
              >Tree-Ring Watermark: Invisible Robust Fingerprints of Diffusion
              Images</a
            >
          </h3>
          <section>
            <h4>
              <span>2023-06-21 @ 23:24:25</span
              ><span class="points-container"
                >Points: <span class="points">90</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=36426136"
                  >Comments</a
                ><span class="descendants">: 60</span></span
              >
            </h4>
          </section>
        </section>
        <section id="36421315">
          <h3>
            <a
              class="item"
              href="https://unchartedterritories.tomaspueyo.com/p/maps-distort-how-we-see-the-world"
              >Maps distort how we see the world</a
            >
          </h3>
          <section>
            <h4>
              <span>2023-06-21 @ 17:08:55</span
              ><span class="points-container"
                >Points: <span class="points">599</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=36421315"
                  >Comments</a
                ><span class="descendants">: 291</span></span
              >
            </h4>
          </section>
        </section>
        <section id="36419352">
          <h3>
            <a
              class="item"
              href="https://thebaffler.com/latest/brains-on-drugs-semley"
              >Brains on Drugs: How tinkering with consciousness became a
              societal sin</a
            >
          </h3>
          <section>
            <h4>
              <span>2023-06-21 @ 15:00:34</span
              ><span class="points-container"
                >Points: <span class="points">142</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=36419352"
                  >Comments</a
                ><span class="descendants">: 195</span></span
              >
            </h4>
          </section>
        </section>
        <section id="36415891">
          <h3>
            <a
              class="item"
              href="https://dannybate.com/2022/11/21/the-almost-romance-languages/"
              >The Almost Romance Languages</a
            >
          </h3>
          <section>
            <h4>
              <span>2023-06-21 @ 08:24:51</span
              ><span class="points-container"
                >Points: <span class="points">77</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=36415891"
                  >Comments</a
                ><span class="descendants">: 42</span></span
              >
            </h4>
          </section>
        </section>
        <section id="36399842">
          <h3>
            <a
              class="item"
              href="https://placesjournal.org/article/reconsidering-housing-theorist-john-habraken/"
              >Mass Support: Dutch architect saw the potential of industrialized
              building</a
            >
          </h3>
          <section>
            <h4>
              <span>2023-06-20 @ 04:47:28</span
              ><span class="points-container"
                >Points: <span class="points">46</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=36399842"
                  >Comments</a
                ><span class="descendants">: 7</span></span
              >
            </h4>
          </section>
        </section>
        <section id="36399832">
          <h3>
            <a
              class="item"
              href="https://claytonwramsey.github.io/2023/06/20/fiddler-const-magic.html"
              >Blowing up my compile times for dubious benefits</a
            >
          </h3>
          <section>
            <h4>
              <span>2023-06-20 @ 04:46:56</span
              ><span class="points-container"
                >Points: <span class="points">88</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=36399832"
                  >Comments</a
                ><span class="descendants">: 26</span></span
              >
            </h4>
          </section>
        </section>
      </section>
      <section id="archives">
        <h2>
          <a
            href="https://github.com/kherrick/hacker-news/blob/main/archives/index.md"
            >Archives</a
          >
        </h2>
        <section>
          <h3>
            <a
              href="https://github.com/kherrick/hacker-news/blob/main/archives/2023/index.md"
              >2023</a
            >
          </h3>
        </section>
        <section>
          <h3>
            <a
              href="https://github.com/kherrick/hacker-news/blob/main/archives/2022/index.md"
              >2022</a
            >
          </h3>
        </section>
      </section>
    </main>
    <script type="module">
      import { buildDescendants } from "./lib/build-html-descendants.js";
      import { buildNextItem } from "./lib/build-html-next-item.js";
      import { getNextDateTime } from "./lib/date-time.js";

      const updateSectionById = (id) =>
        fetch(`https://hacker-news.firebaseio.com/v0/item/${id}.json`).then(
          (result) =>
            result.json().then(({ descendants, id, score, text, type }) => {
              const currentItem = document.getElementById(id);

              if (score) {
                currentItem.querySelector(".points").textContent = score;
              }

              if (descendants && (type === "poll" || type === "story")) {
                const currentDescendants =
                  currentItem.querySelector(".descendants");

                if (currentDescendants) {
                  currentDescendants.textContent = `: ${descendants}`;
                } else {
                  const comments = buildDescendants(
                    document,
                    descendants,
                    `https://news.ycombinator.com/item?id=${id}`
                  );

                  currentItem.querySelector("h4").appendChild(comments);
                }
              }

              if (text) {
                const currentText = currentItem.querySelector(".text");

                if (currentText) {
                  currentText.innerHTML = text.replace(/\0/g, "");
                } else {
                  const content = document.createElement("div");
                  content.innerHTML = text.replace(/\0/g, "");
                  content.setAttribute("class", "text");

                  currentItem.appendChild(content);
                }
              }
            })
        );

      class UpdateQueue {
        constructor() {
          this._ids = [];
          this._isUpdating = false;
        }

        addItemById(id) {
          this._ids.push(id);
        }

        async flush() {
          const id = this._ids.shift();

          if (id) {
            this._isUpdating = true;

            await updateSectionById(id);
            await this.flush();
          } else {
            this._isUpdating = false;

            setTimeout(async () => {
              if (!this._isUpdating && this._ids && this._ids.length) {
                await this.flush();
              }
            }, 0);
          }
        }
      }

      // get latest data
      const latestSection = document.getElementById("latest");

      for (let item of latestSection.querySelectorAll("section[id]")) {
        updateSectionById(item.getAttribute("id"));
      }

      if ("IntersectionObserver" in window) {
        window.hackerNewsState = { index: [], nextTimeIndex: -1 };

        const addNewsItem = async (newsItem, queue) => {
          try {
            const { date, time, itemComments, itemTitle, itemLink } = newsItem;
            const section = await buildNextItem({
              document,
              dateTime: `${date}, ${time}`,
              itemComments,
              itemLink,
              itemTitle: new DOMParser().parseFromString(
                itemTitle.replace(/\\/g, ""),
                "text/html"
              ).documentElement.textContent,
              fetchItemDetails: false,
            });

            // display loading indicator for section
            section.querySelector(".points-container").innerHTML =
              'Points: <span class="points"><img style="height: 100%;" src="lib/images/loading.svg" /></span>';

            const id = section.getAttribute("id");
            if (!document.getElementById(id)) {
              document.getElementById("latest").appendChild(section);

              queue.addItemById(id);
            }
          } catch (error) {}
        };

        const buildArchiveIndex = async (lastDateTime) => {
          const nextDate = lastDateTime.slice(0, 10);
          const nextYear = nextDate.slice(0, 4);

          return (
            await (
              await fetch(
                `https://raw.githubusercontent.com/kherrick/hacker-news/main/archives/${nextYear}/${nextDate}/index.md`
              )
            ).text()
          )
            .split("\n")
            .filter((line) => line.match(new RegExp("^\\* \\[")))
            .map((line) => {
              const segment = line.replace("* ", "").split("](");
              const pubDate = segment[0].slice(1);

              const itemComments = segment[1].split(") - [")[0];
              const itemTitle = segment[1].split(") - [")[1];
              const itemLink = segment[2].slice(0, -1);
              const date = pubDate.slice(0, 10);
              const time = pubDate.slice(-8);

              return {
                date,
                itemComments,
                itemLink,
                itemTitle,
                time,
              };
            });
        };

        const handleIntersectingEntry = async (entry, queue) => {
          if (entry.isIntersecting) {
            const lastDateTime = document
              .getElementById("latest")
              .querySelector(
                "section:last-child > section > h4 > span"
              ).textContent;

            const nextDateTime = getNextDateTime(lastDateTime ?? "", -1);
            const archiveIndex = await buildArchiveIndex(nextDateTime);
            const nextTimeIndex = archiveIndex.findIndex(
              ({ time }) => time === nextDateTime.slice(-8)
            );

            const handleIndexUpdate = (index, existingIndexValues = []) => {
              index.forEach((i) => {
                existingIndexValues.push(i);
              });
              return existingIndexValues;
            };

            window.hackerNewsState = {
              index: handleIndexUpdate(
                archiveIndex,
                window.hackerNewsState.index
              ),
              nextTimeIndex,
            };

            let currentTimeIndex = nextTimeIndex + 1;
            const items = Object.values(window.hackerNewsState.index);
            for (let item of items) {
              if (currentTimeIndex < window.hackerNewsState.index.length) {
                addNewsItem(items[currentTimeIndex], queue);

                currentTimeIndex = currentTimeIndex + 1;
              }
            }

            queue.flush();
          }
        };

        const archives = document.getElementById("archives");
        const archivesObserver = new IntersectionObserver(
          (entries) => {
            const queue = new UpdateQueue();

            entries.forEach((entry) => handleIntersectingEntry(entry, queue));
          },
          {
            root: null,
            rootMargin: "0px",
            threshold: 0,
          }
        );

        archivesObserver.observe(archives);

        let latestSectionsExpanded = true;
        const handleLatestHeaderClick = () => {
          latestSectionsExpanded = !latestSectionsExpanded;

          if (latestSectionsExpanded) {
            archivesObserver.observe(archives);
          } else {
            archivesObserver.disconnect(archives);
          }

          for (let section of document.querySelectorAll("#latest > section")) {
            section.style.display = latestSectionsExpanded ? "block" : "none";
          }
        };

        const latestHeader = document.querySelector("#latest > h2");
        latestHeader.style.cursor = "pointer";
        latestHeader.addEventListener("click", handleLatestHeaderClick);
      }
    </script>
    <script type="module">
      import { Workbox } from "https://storage.googleapis.com/workbox-cdn/releases/6.4.1/workbox-window.prod.mjs";

      if ("serviceWorker" in navigator) {
        const base = document.querySelector("base");
        const serviceWorkerPath = `${
          base ? base.href.replace(/\/$/, "") : ""
        }/service-worker.js`;

        const wb = new Workbox(serviceWorkerPath);

        // setup event listeners
        wb.addEventListener("waiting", (event) => {
          wb.addEventListener("controlling", () => {
            window.location.reload();
          });

          wb.messageSkipWaiting();
        });

        wb.register();
      }
    </script>
  </body>
</html>
