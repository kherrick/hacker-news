<!DOCTYPE html>
<html lang="en" xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta charset="utf-8" />
    <meta
      content="width=device-width, initial-scale=1.0, viewport-fit=cover"
      name="viewport"
    />
    <meta name="description" content="Hacker News" />
    <meta name="theme-color" content="#fff" />
    <title>Hacker News</title>
    <link rel="manifest" href="manifest.json" />
    <link
      href="data:image/x-icon;base64,AAABAAEAAQECAAEAAQA4AAAAFgAAACgAAAABAAAAAgAAAAEAAQAAAAAAAAAAAAAAAAAAAAAAAAAAAAABAAEAAQECAAEAAQA4AAAAFgAAACgAAAABAAAAAgAAAAEAAQAAAAAAAAAAAAAAAAAAAAAAAAAA"
      rel="icon"
      type="image/x-icon"
    />
    <link
      href="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAgAAAAIAAQMAAADOtka5AAAAA1BMVEUAAACnej3aAAAANklEQVR42u3BAQEAAACCIP+vbkhAAQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAB8G4IAAAFjdVCkAAAAAElFTkSuQmCC"
      rel="apple-touch-icon"
    />
    <style>
      /*<!--*/
      body {
        color: rgb(25, 25, 25);
        font-family: Verdana, Geneva, sans-serif;
        margin: 0;
      }

      a {
        text-decoration: none;
      }

      a:link,
      a:focus,
      a:hover,
      a:active {
        color: rgb(75, 75, 125);
      }

      a:visited {
        color: rgb(25, 25, 25);
      }

      h1 > a,
      h1 > a:link,
      h1 > a:focus,
      h1 > a:hover,
      h1 > a:active,
      h1 > a:visited,
      h2 > a,
      h2 > a:link,
      h2 > a:focus,
      h2 > a:hover,
      h2 > a:active,
      h2 > a:visited {
        color: rgb(25, 25, 25);
      }

      h1 {
        background-color: rgb(255, 102, 0);
        margin: 0;
        padding: 1rem;
      }

      h2 {
        background-color: rgb(200, 200, 200);
        margin: 1rem 0;
        padding: 0.5rem 0.5rem 0.5rem 1rem;
      }

      #latest > section,
      #archives > section {
        margin: 0 1rem 1rem 1rem;
        padding-bottom: 1rem;
      }

      #latest > section:not(:last-child),
      #archives > section:not(:last-child) {
        border-bottom: 1px dotted rgb(200, 200, 200);
      }

      section > h3 {
        margin: 0 0 0.5rem 0;
      }

      section > h4 {
        font-weight: normal;
        margin: 0 0 0 1rem;
      }

      .descendants-container,
      .points-container {
        align-items: center;
        border-left: 1px solid #333;
        display: inline-flex;
        margin-left: 0.5rem;
        padding-left: 0.5rem;
        text-align: center;
      }

      .points {
        align-items: center;
        display: inline-flex;
        height: 1rem;
        margin-left: 1ch;
        min-width: 3ch;
      }

      .text {
        line-height: 1.5rem;
        margin: 1rem 1rem 0 1rem;
        overflow: auto;
      }

      .text > p:first-child {
        margin-top: 1rem;
      }

      .text > p:last-child {
        margin-bottom: 0;
      }
      /*-->*/
    </style>
  </head>

  <body>
    <main>
      <h1><a href="https://kherrick.github.io/hacker-news/">Hacker News</a></h1>
      <section id="latest">
        <h2>Latest</h2>
        <section id="40602886">
          <h3>
            <a
              class="item"
              href="https://gist.github.com/velzie/053ffedeaecea1a801a2769ab86ab376"
              >PSA: How to keep using adblockers on Chrome and Chromium</a
            >
          </h3>
          <section>
            <h4>
              <span>2024-06-06 @ 22:04:26</span
              ><span class="points-container"
                >Points: <span class="points">85</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=40602886"
                  >Comments</a
                ><span class="descendants">: 45</span></span
              >
            </h4>
          </section>
        </section>
        <section id="40601801">
          <h3>
            <a
              class="item"
              href="https://www.theregister.com/2024/06/06/mike_lynch_cleared/"
              >Mike Lynch cleared in Autonomy fraud trial</a
            >
          </h3>
          <section>
            <h4>
              <span>2024-06-06 @ 20:08:31</span
              ><span class="points-container"
                >Points: <span class="points">39</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=40601801"
                  >Comments</a
                ><span class="descendants">: 17</span></span
              >
            </h4>
          </section>
        </section>
        <section id="40601776">
          <h3>
            <a
              class="item"
              href="https://gizmodo.com/watch-boeing-starliner-dock-iss-astronauts-1851521917"
              >Boeing's starliner docks at ISS after five thrusters unexpectedly
              shut off</a
            >
          </h3>
          <section>
            <h4>
              <span>2024-06-06 @ 20:06:33</span
              ><span class="points-container"
                >Points: <span class="points">73</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=40601776"
                  >Comments</a
                ><span class="descendants">: 43</span></span
              >
            </h4>
          </section>
        </section>
        <section id="40600775">
          <h3>
            <a class="item" href="https://www.together.ai/blog/dragonfly-v1"
              >Dragonfly: A large vision-language model with multi-resolution
              zoom</a
            >
          </h3>
          <section>
            <h4>
              <span>2024-06-06 @ 18:31:04</span
              ><span class="points-container"
                >Points: <span class="points">78</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=40600775"
                  >Comments</a
                ><span class="descendants">: 9</span></span
              >
            </h4>
          </section>
        </section>
        <section id="40600748">
          <h3>
            <a
              class="item"
              href="https://thequietus.com/interviews/lola-de-la-mata-oceans-on-azimuth-tinnitus-interview/"
              >An Interview with Lola De La Mata about tinnitus</a
            >
          </h3>
          <section>
            <h4>
              <span>2024-06-06 @ 18:28:22</span
              ><span class="points-container"
                >Points: <span class="points">89</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=40600748"
                  >Comments</a
                ><span class="descendants">: 81</span></span
              >
            </h4>
          </section>
        </section>
        <section id="40600384">
          <h3>
            <a class="item" href="https://codeandbitters.com/main-as-usize/"
              >Let rand = main as usize (2022)</a
            >
          </h3>
          <section>
            <h4>
              <span>2024-06-06 @ 17:55:28</span
              ><span class="points-container"
                >Points: <span class="points">77</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=40600384"
                  >Comments</a
                ><span class="descendants">: 30</span></span
              >
            </h4>
          </section>
        </section>
        <section id="40600083">
          <h3>
            <a class="item" href="https://www.workatastartup.com/jobs/66928"
              >Yarn (YC W24) Is Hiring Founding Engineers in NYC</a
            >
          </h3>
          <section>
            <h4>
              <span>2024-06-06 @ 17:27:08</span
              ><span class="points-container"
                >Points: <span class="points">1</span></span
              >
            </h4>
          </section>
        </section>
        <section id="40599857">
          <h3>
            <a class="item" href="https://telegram.org/blog/telegram-stars"
              >Telegram Stars: Pay for Digital Goods and More</a
            >
          </h3>
          <section>
            <h4>
              <span>2024-06-06 @ 17:09:58</span
              ><span class="points-container"
                >Points: <span class="points">34</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=40599857"
                  >Comments</a
                ><span class="descendants">: 25</span></span
              >
            </h4>
          </section>
        </section>
        <section id="40599749">
          <h3>
            <a
              class="item"
              href="https://openai.com/index/extracting-concepts-from-gpt-4/"
              >Extracting concepts from GPT-4</a
            >
          </h3>
          <section>
            <h4>
              <span>2024-06-06 @ 17:01:37</span
              ><span class="points-container"
                >Points: <span class="points">128</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=40599749"
                  >Comments</a
                ><span class="descendants">: 50</span></span
              >
            </h4>
          </section>
        </section>
        <section id="40599419">
          <h3>
            <a class="item" href="https://xpipe.io"
              >Show HN: XPipe, a brand-new type of remote file browser and shell
              connection hub</a
            >
          </h3>
          <section>
            <h4>
              <span>2024-06-06 @ 16:34:31</span
              ><span class="points-container"
                >Points: <span class="points">42</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=40599419"
                  >Comments</a
                ><span class="descendants">: 17</span></span
              >
            </h4>
            <div class="text">
              <p>
                At first glance it might not look very novel, but if you dig a
                little deeper, you will see that the entire foundation of how it
                communicates with remote systems is completely different from
                any other solution out there. What happens in the background can
                essentially be explained this way: It launches a local shell
                process like cmd, sh, etc. and in it executes a command that
                opens a remote shell connection such as ssh user@host. All
                communication is then done through the stdin/stdout/stderr of
                that process. From there, it detects what kind of server and
                environment, e.g. shell type, os, etc. you have logged into and
                adjusts how it talks to the remote system. By then using file
                system related commands such as ls, rm, touch, etc. and its
                equivalents, it can realize a functional file manager that works
                on essentially every system without any protocol requirements.
                For other types of connections, it can just execute things like
                docker exec -i to open a shell into a container and work the
                same way. Right now it supports: - SSH by running your locally
                installed SSH CLI client - Docker, Podman, LXD, and Kubernetes
                containers - WSL, MSYS2, and Cygwin environments on Windows -
                Various other things like some VMs for VMware and Proxmox, but
                work is still going on on there
              </p>
              <p>
                This approach to delegate everything to your installed tools is
                also utilized for other tasks. That means that I can save a lot
                of development time while you can happily use the tools you are
                comfortable with in conjunction with XPipe. In fact, XPipe
                doesn't ship with any libraries or tools for remote shell
                connections, protocol handling, or terminal integration at all.
                It just delegates everything to your own text editor, terminal
                emulator, RDP clients, and more.
              </p>
              <p>
                Due to its nature, XPipe has to handle a lot of sensitive
                information like passwords, keys, and more. To tackle the topics
                of security and privacy, I put an emphasis on security settings
                and created a dedicated security page in the docs that should
                hopefully contain all relevant information. There is also a
                password manager integration, so you don't have to store any
                sensitive information in XPipe itself if you use a compatible
                password manager.
              </p>
              <p>
                As it is a common use case to synchronize connection information
                across many systems, e.g. your desktop at home and laptop for
                travel, there is also a git integration which allows you to have
                XPipe automatically synchronize all connection information with
                a remote git repository of your choice. It supports any git
                remote repository, advanced authentication measures like SSH
                auth, GPG signing, and more. You can also use this for
                collaboration if you're working in a team.
              </p>
              <p>
                The early stage development has been quite challenging as this
                new approach requires a completely new implementation, but I am
                confident that it's ready now. I appreciate any kind of feedback
                from you to guide me in the right development direction from
                here.
              </p>
              <p>Enjoy!</p>
            </div>
          </section>
        </section>
        <section id="40599018">
          <h3>
            <a class="item" href="https://qwenlm.github.io/blog/qwen2/"
              >Qwen2 LLM Released</a
            >
          </h3>
          <section>
            <h4>
              <span>2024-06-06 @ 16:01:13</span
              ><span class="points-container"
                >Points: <span class="points">175</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=40599018"
                  >Comments</a
                ><span class="descendants">: 87</span></span
              >
            </h4>
          </section>
        </section>
        <section id="40598629">
          <h3>
            <a class="item" href="https://github.com/hackerb9/lsix"
              >lsix: Like "ls", but for images</a
            >
          </h3>
          <section>
            <h4>
              <span>2024-06-06 @ 15:29:56</span
              ><span class="points-container"
                >Points: <span class="points">157</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=40598629"
                  >Comments</a
                ><span class="descendants">: 73</span></span
              >
            </h4>
          </section>
        </section>
        <section id="40597503">
          <h3>
            <a
              class="item"
              href="https://link.springer.com/article/10.1007/s13347-023-00616-9"
              >The right not to be subjected to AI profiling based on publicly
              available data</a
            >
          </h3>
          <section>
            <h4>
              <span>2024-06-06 @ 14:03:17</span
              ><span class="points-container"
                >Points: <span class="points">212</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=40597503"
                  >Comments</a
                ><span class="descendants">: 162</span></span
              >
            </h4>
          </section>
        </section>
        <section id="40597249">
          <h3>
            <a
              class="item"
              href="https://www.smithsonianmag.com/history/martha-gellhorn-was-the-only-woman-to-report-on-the-d-day-landings-from-the-ground-180984456/"
              >Martha Gellhorn, the only woman to report on the D-Day landings
              from the ground</a
            >
          </h3>
          <section>
            <h4>
              <span>2024-06-06 @ 13:35:24</span
              ><span class="points-container"
                >Points: <span class="points">85</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=40597249"
                  >Comments</a
                ><span class="descendants">: 45</span></span
              >
            </h4>
          </section>
        </section>
        <section id="40597216">
          <h3>
            <a
              class="item"
              href="https://sashamaps.net/docs/maps/roman-roads-original/"
              >Roman Roads (2017)</a
            >
          </h3>
          <section>
            <h4>
              <span>2024-06-06 @ 13:32:36</span
              ><span class="points-container"
                >Points: <span class="points">297</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=40597216"
                  >Comments</a
                ><span class="descendants">: 92</span></span
              >
            </h4>
          </section>
        </section>
        <section id="40596883">
          <h3>
            <a
              class="item"
              href="https://twitter.com/SpaceX/status/1798701489097183286"
              >Super Heavy has splashed down in The Gulf of Mexico</a
            >
          </h3>
          <section>
            <h4>
              <span>2024-06-06 @ 13:02:48</span
              ><span class="points-container"
                >Points: <span class="points">488</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=40596883"
                  >Comments</a
                ><span class="descendants">: 522</span></span
              >
            </h4>
          </section>
        </section>
        <section id="40596711">
          <h3>
            <a class="item" href="https://github.com/potamides/DeTikZify"
              >Show HN: Synthesize TikZ Graphics Programs for Scientific Figures
              and Sketches</a
            >
          </h3>
          <section>
            <h4>
              <span>2024-06-06 @ 12:42:13</span
              ><span class="points-container"
                >Points: <span class="points">82</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=40596711"
                  >Comments</a
                ><span class="descendants">: 7</span></span
              >
            </h4>
            <div class="text">
              Creating high-quality scientific figures can be time-consuming and
              challenging, even though sketching ideas on paper is relatively
              easy. Furthermore, recreating existing figures that are not stored
              in formats preserving semantic information is equally complex. To
              tackle this problem, we introduce DeTikZify, a novel multimodal
              language model that automatically synthesizes scientific figures
              as semantics-preserving TikZ graphics programs based on sketches
              and existing figures. We also introduce a Monte Carlo Tree
              Search-based inference algorithm that enables DeTikZify to
              iteratively refine its outputs without the need for additional
              training.
            </div>
          </section>
        </section>
        <section id="40596689">
          <h3>
            <a class="item" href="https://github.com/nikitabobko/AeroSpace"
              >AeroSpace is an i3-like tiling window manager for macOS</a
            >
          </h3>
          <section>
            <h4>
              <span>2024-06-06 @ 12:39:01</span
              ><span class="points-container"
                >Points: <span class="points">268</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=40596689"
                  >Comments</a
                ><span class="descendants">: 104</span></span
              >
            </h4>
          </section>
        </section>
        <section id="40596535">
          <h3>
            <a
              class="item"
              href="https://medicalxpress.com/news/2024-06-brain-overgrowth-dictates-autism-severity.html"
              >Brain overgrowth dictates autism severity, new research
              suggests</a
            >
          </h3>
          <section>
            <h4>
              <span>2024-06-06 @ 12:18:39</span
              ><span class="points-container"
                >Points: <span class="points">70</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=40596535"
                  >Comments</a
                ><span class="descendants">: 76</span></span
              >
            </h4>
          </section>
        </section>
        <section id="40595920">
          <h3>
            <a
              class="item"
              href="https://every.to/the-crazy-ones/the-misfit-who-built-the-ibm-pc"
              >Don Estridge: A misfit who built the IBM PC</a
            >
          </h3>
          <section>
            <h4>
              <span>2024-06-06 @ 10:55:32</span
              ><span class="points-container"
                >Points: <span class="points">140</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=40595920"
                  >Comments</a
                ><span class="descendants">: 72</span></span
              >
            </h4>
          </section>
        </section>
        <section id="40595741">
          <h3>
            <a class="item" href="https://edw.is/learning-vulkan/"
              >I learned Vulkan and wrote a small game engine with it</a
            >
          </h3>
          <section>
            <h4>
              <span>2024-06-06 @ 10:24:23</span
              ><span class="points-container"
                >Points: <span class="points">352</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=40595741"
                  >Comments</a
                ><span class="descendants">: 144</span></span
              >
            </h4>
          </section>
        </section>
        <section id="40595499">
          <h3>
            <a
              class="item"
              href="https://geospatial.netlify.app/posts/gds-2024-04-20-cathedrals/"
              >Saint Michael Sword: Are the cathedrals really on a straight
              line?</a
            >
          </h3>
          <section>
            <h4>
              <span>2024-06-06 @ 09:48:59</span
              ><span class="points-container"
                >Points: <span class="points">272</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=40595499"
                  >Comments</a
                ><span class="descendants">: 185</span></span
              >
            </h4>
          </section>
        </section>
        <section id="40595384">
          <h3>
            <a
              class="item"
              href="https://www.qemu.org/2018/02/09/understanding-qemu-devices/"
              >Understanding QEMU Devices (2018)</a
            >
          </h3>
          <section>
            <h4>
              <span>2024-06-06 @ 09:33:19</span
              ><span class="points-container"
                >Points: <span class="points">123</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=40595384"
                  >Comments</a
                ><span class="descendants">: 39</span></span
              >
            </h4>
          </section>
        </section>
        <section id="40593540">
          <h3>
            <a
              class="item"
              href="https://mkukri.xyz/2024/06/01/tpm-gpio-fail.html"
              >TPM GPIO fail: How bad OEM firmware ruins Intel TPM security</a
            >
          </h3>
          <section>
            <h4>
              <span>2024-06-06 @ 04:34:57</span
              ><span class="points-container"
                >Points: <span class="points">168</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=40593540"
                  >Comments</a
                ><span class="descendants">: 105</span></span
              >
            </h4>
          </section>
        </section>
        <section id="40585277">
          <h3>
            <a
              class="item"
              href="https://victorianweb.org/technology/packer/merryweather.html"
              >Dr. George Merryweather's 1851 Tempest Prognosticator</a
            >
          </h3>
          <section>
            <h4>
              <span>2024-06-05 @ 14:33:51</span
              ><span class="points-container"
                >Points: <span class="points">7</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=40585277"
                  >Comments</a
                ><span class="descendants">: 1</span></span
              >
            </h4>
          </section>
        </section>
        <section id="40583632">
          <h3>
            <a class="item" href="https://spectrum.ieee.org/hybrid-bonding"
              >Hybrid Bonding: 3D Chip Tech to Save Moore's Law</a
            >
          </h3>
          <section>
            <h4>
              <span>2024-06-05 @ 11:24:21</span
              ><span class="points-container"
                >Points: <span class="points">4</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=40583632"
                  >Comments</a
                ><span class="descendants">: 2</span></span
              >
            </h4>
          </section>
        </section>
        <section id="40582475">
          <h3>
            <a
              class="item"
              href="https://www.pentagrid.ch/en/blog/ariane-allegro-hotel-check-in-terminal-kios-escape/"
              >Kiosk mode bypass for an Ariane Allegro Scenario Player based
              hotel check-in te</a
            >
          </h3>
          <section>
            <h4>
              <span>2024-06-05 @ 07:57:12</span
              ><span class="points-container"
                >Points: <span class="points">48</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=40582475"
                  >Comments</a
                ><span class="descendants">: 19</span></span
              >
            </h4>
          </section>
        </section>
        <section id="40582357">
          <h3>
            <a class="item" href="https://raould.github.io/pn0gstr0m/"
              >Show HN: 2d web paddle game</a
            >
          </h3>
          <section>
            <h4>
              <span>2024-06-05 @ 07:37:38</span
              ><span class="points-container"
                >Points: <span class="points">127</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=40582357"
                  >Comments</a
                ><span class="descendants">: 35</span></span
              >
            </h4>
            <div class="text">
              Simple retro paddle arcade game written in Javascript, using good
              ol' Canvas.
            </div>
          </section>
        </section>
        <section id="40581904">
          <h3>
            <a
              class="item"
              href="https://ericnormand.substack.com/p/compromised-visions-are-superior"
              >Compromised Visions Are Superior</a
            >
          </h3>
          <section>
            <h4>
              <span>2024-06-05 @ 06:22:26</span
              ><span class="points-container"
                >Points: <span class="points">31</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=40581904"
                  >Comments</a
                ><span class="descendants">: 20</span></span
              >
            </h4>
          </section>
        </section>
        <section id="40579892">
          <h3>
            <a
              class="item"
              href="https://mattweidner.com/2024/06/04/server-architectures.html"
              >Architectures for Central Server Collaboration</a
            >
          </h3>
          <section>
            <h4>
              <span>2024-06-04 @ 23:13:28</span
              ><span class="points-container"
                >Points: <span class="points">71</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=40579892"
                  >Comments</a
                ><span class="descendants">: 2</span></span
              >
            </h4>
          </section>
        </section>
      </section>
      <section id="archives">
        <h2>
          <a
            href="https://github.com/kherrick/hacker-news/blob/main/archives/index.md"
            >Archives</a
          >
        </h2>
        <section>
          <h3>
            <a
              href="https://github.com/kherrick/hacker-news/blob/main/archives/2024/index.md"
              >2024</a
            >
          </h3>
        </section>
        <section>
          <h3>
            <a
              href="https://github.com/kherrick/hacker-news/blob/main/archives/2023/index.md"
              >2023</a
            >
          </h3>
        </section>
        <section>
          <h3>
            <a
              href="https://github.com/kherrick/hacker-news/blob/main/archives/2022/index.md"
              >2022</a
            >
          </h3>
        </section>
      </section>
    </main>
    <script type="module">
      import { buildDescendants } from "./lib/build-html-descendants.js";
      import { buildNextItem } from "./lib/build-html-next-item.js";
      import { getNextDateTime } from "./lib/date-time.js";

      const updateSectionById = (id) =>
        fetch(`https://hacker-news.firebaseio.com/v0/item/${id}.json`).then(
          (result) =>
            result.json().then(({ descendants, id, score, text, type }) => {
              const currentItem = document.getElementById(id);

              if (score) {
                currentItem.querySelector(".points").textContent = score;
              }

              if (descendants && (type === "poll" || type === "story")) {
                const currentDescendants =
                  currentItem.querySelector(".descendants");

                if (currentDescendants) {
                  currentDescendants.textContent = `: ${descendants}`;
                } else {
                  const comments = buildDescendants(
                    document,
                    descendants,
                    `https://news.ycombinator.com/item?id=${id}`
                  );

                  currentItem.querySelector("h4").appendChild(comments);
                }
              }

              if (text) {
                const currentText = currentItem.querySelector(".text");

                if (currentText) {
                  currentText.innerHTML = text.replace(/\0/g, "");
                } else {
                  const content = document.createElement("div");
                  content.innerHTML = text.replace(/\0/g, "");
                  content.setAttribute("class", "text");

                  currentItem.appendChild(content);
                }
              }
            })
        );

      class UpdateQueue {
        constructor() {
          this._ids = [];
          this._isUpdating = false;
        }

        addItemById(id) {
          this._ids.push(id);
        }

        async flush() {
          const id = this._ids.shift();

          if (id) {
            this._isUpdating = true;

            await updateSectionById(id);
            await this.flush();
          } else {
            this._isUpdating = false;

            setTimeout(async () => {
              if (!this._isUpdating && this._ids && this._ids.length) {
                await this.flush();
              }
            }, 0);
          }
        }
      }

      // get latest data
      const latestSection = document.getElementById("latest");

      for (let item of latestSection.querySelectorAll("section[id]")) {
        updateSectionById(item.getAttribute("id"));
      }

      if ("IntersectionObserver" in window) {
        window.hackerNewsState = { index: [], nextTimeIndex: -1 };

        const addNewsItem = async (newsItem, queue) => {
          try {
            const { date, time, itemComments, itemTitle, itemLink } = newsItem;
            const section = await buildNextItem({
              document,
              dateTime: `${date}, ${time}`,
              itemComments,
              itemLink,
              itemTitle: new DOMParser().parseFromString(
                itemTitle.replace(/\\/g, ""),
                "text/html"
              ).documentElement.textContent,
              fetchItemDetails: false,
            });

            // display loading indicator for section
            section.querySelector(".points-container").innerHTML =
              'Points: <span class="points"><img style="height: 100%;" src="lib/images/loading.svg" /></span>';

            const id = section.getAttribute("id");
            if (!document.getElementById(id)) {
              document.getElementById("latest").appendChild(section);

              queue.addItemById(id);
            }
          } catch (error) {}
        };

        const buildArchiveIndex = async (lastDateTime) => {
          const nextDate = lastDateTime.slice(0, 10);
          const nextYear = nextDate.slice(0, 4);

          return (
            await (
              await fetch(
                `https://raw.githubusercontent.com/kherrick/hacker-news/main/archives/${nextYear}/${nextDate}/index.md`
              )
            ).text()
          )
            .split("\n")
            .filter((line) => line.match(new RegExp("^\\* \\[")))
            .map((line) => {
              const segment = line.replace("* ", "").split("](");
              const pubDate = segment[0].slice(1);

              const itemComments = segment[1].split(") - [")[0];
              const itemTitle = segment[1].split(") - [")[1];
              const itemLink = segment[2].slice(0, -1);
              const date = pubDate.slice(0, 10);
              const time = pubDate.slice(-8);

              return {
                date,
                itemComments,
                itemLink,
                itemTitle,
                time,
              };
            });
        };

        const handleIntersectingEntry = async (entry, queue) => {
          if (entry.isIntersecting) {
            const lastDateTime = document
              .getElementById("latest")
              .querySelector(
                "section:last-child > section > h4 > span"
              ).textContent;

            const nextDateTime = getNextDateTime(lastDateTime ?? "", -1);
            const archiveIndex = await buildArchiveIndex(nextDateTime);
            const nextTimeIndex = archiveIndex.findIndex(
              ({ time }) => time === nextDateTime.slice(-8)
            );

            const handleIndexUpdate = (index, existingIndexValues = []) => {
              index.forEach((i) => {
                existingIndexValues.push(i);
              });
              return existingIndexValues;
            };

            window.hackerNewsState = {
              index: handleIndexUpdate(
                archiveIndex,
                window.hackerNewsState.index
              ),
              nextTimeIndex,
            };

            let currentTimeIndex = nextTimeIndex + 1;
            const items = Object.values(window.hackerNewsState.index);
            for (let item of items) {
              if (currentTimeIndex < window.hackerNewsState.index.length) {
                addNewsItem(items[currentTimeIndex], queue);

                currentTimeIndex = currentTimeIndex + 1;
              }
            }

            queue.flush();
          }
        };

        const archives = document.getElementById("archives");
        const archivesObserver = new IntersectionObserver(
          (entries) => {
            const queue = new UpdateQueue();

            entries.forEach((entry) => handleIntersectingEntry(entry, queue));
          },
          {
            root: null,
            rootMargin: "0px",
            threshold: 0,
          }
        );

        archivesObserver.observe(archives);

        let latestSectionsExpanded = true;
        const handleLatestHeaderClick = () => {
          latestSectionsExpanded = !latestSectionsExpanded;

          if (latestSectionsExpanded) {
            archivesObserver.observe(archives);
          } else {
            archivesObserver.disconnect(archives);
          }

          for (let section of document.querySelectorAll("#latest > section")) {
            section.style.display = latestSectionsExpanded ? "block" : "none";
          }
        };

        const latestHeader = document.querySelector("#latest > h2");
        latestHeader.style.cursor = "pointer";
        latestHeader.addEventListener("click", handleLatestHeaderClick);
      }
    </script>
    <script type="module">
      import { Workbox } from "https://storage.googleapis.com/workbox-cdn/releases/6.4.1/workbox-window.prod.mjs";

      if ("serviceWorker" in navigator) {
        const base = document.querySelector("base");
        const serviceWorkerPath = `${
          base ? base.href.replace(/\/$/, "") : ""
        }/service-worker.js`;

        const wb = new Workbox(serviceWorkerPath);

        // setup event listeners
        wb.addEventListener("waiting", (event) => {
          wb.addEventListener("controlling", () => {
            window.location.reload();
          });

          wb.messageSkipWaiting();
        });

        wb.register();
      }
    </script>
  </body>
</html>
