<!DOCTYPE html>
<html lang="en" xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta charset="utf-8" />
    <meta
      content="width=device-width, initial-scale=1.0, viewport-fit=cover"
      name="viewport"
    />
    <meta name="description" content="Hacker News" />
    <meta name="theme-color" content="#fff" />
    <title>Hacker News</title>
    <link rel="manifest" href="manifest.json" />
    <link
      href="data:image/x-icon;base64,AAABAAEAAQECAAEAAQA4AAAAFgAAACgAAAABAAAAAgAAAAEAAQAAAAAAAAAAAAAAAAAAAAAAAAAAAAABAAEAAQECAAEAAQA4AAAAFgAAACgAAAABAAAAAgAAAAEAAQAAAAAAAAAAAAAAAAAAAAAAAAAA"
      rel="icon"
      type="image/x-icon"
    />
    <link
      href="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAgAAAAIAAQMAAADOtka5AAAAA1BMVEUAAACnej3aAAAANklEQVR42u3BAQEAAACCIP+vbkhAAQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAB8G4IAAAFjdVCkAAAAAElFTkSuQmCC"
      rel="apple-touch-icon"
    />
    <style>
      /*<!--*/
      body {
        color: rgb(25, 25, 25);
        font-family: Verdana, Geneva, sans-serif;
        margin: 0;
      }

      a {
        text-decoration: none;
      }

      a:link,
      a:focus,
      a:hover,
      a:active {
        color: rgb(75, 75, 125);
      }

      a:visited {
        color: rgb(25, 25, 25);
      }

      h1 > a,
      h1 > a:link,
      h1 > a:focus,
      h1 > a:hover,
      h1 > a:active,
      h1 > a:visited,
      h2 > a,
      h2 > a:link,
      h2 > a:focus,
      h2 > a:hover,
      h2 > a:active,
      h2 > a:visited {
        color: rgb(25, 25, 25);
      }

      h1 {
        background-color: rgb(255, 102, 0);
        margin: 0;
        padding: 1rem;
      }

      h2 {
        background-color: rgb(200, 200, 200);
        margin: 1rem 0;
        padding: 0.5rem 0.5rem 0.5rem 1rem;
      }

      #latest > section,
      #archives > section {
        margin: 0 1rem 1rem 1rem;
        padding-bottom: 1rem;
      }

      #latest > section:not(:last-child),
      #archives > section:not(:last-child) {
        border-bottom: 1px dotted rgb(200, 200, 200);
      }

      section > h3 {
        margin: 0 0 0.5rem 0;
      }

      section > h4 {
        font-weight: normal;
        margin: 0 0 0 1rem;
      }

      .descendants-container,
      .points-container {
        align-items: center;
        border-left: 1px solid #333;
        display: inline-flex;
        margin-left: 0.5rem;
        padding-left: 0.5rem;
        text-align: center;
      }

      .points {
        align-items: center;
        display: inline-flex;
        height: 1rem;
        margin-left: 1ch;
        min-width: 3ch;
      }

      .text {
        line-height: 1.5rem;
        margin: 1rem 1rem 0 1rem;
        overflow: auto;
      }

      .text > p:first-child {
        margin-top: 1rem;
      }

      .text > p:last-child {
        margin-bottom: 0;
      }
      /*-->*/
    </style>
  </head>

  <body>
    <main>
      <h1><a href="https://kherrick.github.io/hacker-news/">Hacker News</a></h1>
      <section id="latest">
        <h2>Latest</h2>
        <section id="38553008">
          <h3>
            <a class="item" href="https://news.ycombinator.com/item?id=38553008"
              >Tell HN: ZFS silent data corruption bugfix – my research
              results</a
            >
          </h3>
          <section>
            <h4>
              <span>2023-12-07 @ 04:59:49</span
              ><span class="points-container"
                >Points: <span class="points">25</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=38553008"
                  >Comments</a
                ><span class="descendants">: 1</span></span
              >
            </h4>
            <div class="text">
              <p>
                since I'm personally affected by this bug[1] and this scared me
                somehow, I thought I'd post my research results to have a
                discussion about the details.
              </p>
              <p>
                I must say I lost a bit of trust in ZFS, since it was 'sold' as
                rock solid unbreakable file system and now what... the sheer
                complexity of ZFS let's me think that this was not the only bug
                of this kind existing undetected in the source code.
              </p>
              <p>
                However the communication was clear and precise, other
                filesystems had similar problems and I just love the feature set
                of zfs. So I'll give it another shot hoping that future
                revisions will be safe(r).
              </p>
              <p>Here are my conclusions so far:</p>
              <p></p>
              <pre><code>  1. ZFS had a silent data corruption bug recently discussed on HN [6][7]
  2. `Silent` means, you can't do anything about it without upgrading zfs (scrubs, checks, etc. don't help)
  3. There is no tool to check if your data has been corrupted
  4. Only once written and untouched data should be relatively safe (e.g. backups), the bug mainly affects reading data [4]
  5. Setting `zfs_dmu_offset_next_sync=0` reduces probability of being affected, but no guarantee [4]
  6. The bug affected any version before 2.2.2 and 2.1.14[2], but were more likely between 2.1.4 and 2.2.1 because a behaviour change in coreutils
  7. The causing problem already existed much longer (since 2006?) - this is a question mark [4]
  8. On linux, do a `sudo modinfo zfs | grep version` to see the version number

</code></pre>
              So the only way to ENSURE your data is ok is checksumming all
              files on another filesystem at file level and compare or
              re-transfering all data from another filesystem after upgrading
              zfs to the latest version.
              <p>
                Please let me know, if I missed something or got something
                wrong.
              </p>
              <p>Sources:</p>
              <p>
                [1]:
                https://www.phoronix.com/news/OpenZFS-Data-Corruption-Battle
              </p>
              <p>[2]: https://www.phoronix.com/news/OpenZFS-2.2.2-Released</p>
              <p>
                [3]:
                https://www.theregister.com/2023/12/04/two_new_versions_of_openzfs/
              </p>
              <p>
                [4]:
                https://www.reddit.com/r/zfs/comments/1826lgs/psa_its_not_block_cloning_its_a_data_corruption/
              </p>
              <p>[5]: https://news.ycombinator.com/item?id=38519382</p>
              <p>[6]: https://news.ycombinator.com/item?id=38405731</p>
              <p>[7]: https://news.ycombinator.com/item?id=38380240</p>
            </div>
          </section>
        </section>
        <section id="38552789">
          <h3>
            <a
              class="item"
              href="https://engineering.fb.com/2023/12/06/security/building-end-to-end-security-for-messenger/"
              >Building end-to-end security for Messenger – Engineering at
              Meta</a
            >
          </h3>
          <section>
            <h4>
              <span>2023-12-07 @ 04:21:51</span
              ><span class="points-container"
                >Points: <span class="points">14</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=38552789"
                  >Comments</a
                ><span class="descendants">: 3</span></span
              >
            </h4>
          </section>
        </section>
        <section id="38552628">
          <h3>
            <a
              class="item"
              href="https://terrytao.wordpress.com/2023/12/05/a-slightly-longer-lean-4-proof-tour/"
              >A slightly longer Lean 4 proof tour</a
            >
          </h3>
          <section>
            <h4>
              <span>2023-12-07 @ 03:49:56</span
              ><span class="points-container"
                >Points: <span class="points">10</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=38552628"
                  >Comments</a
                ><span class="descendants">: 1</span></span
              >
            </h4>
          </section>
        </section>
        <section id="38552434">
          <h3>
            <a
              class="item"
              href="https://www.ign.com/articles/bungie-devs-say-atmosphere-is-soul-crushing-amid-layoffs-cuts-and-fear-of-total-sony-takeover"
              >Bungie Devs Atmosphere 'Soul-Crushing' Amid Layoffs, Cuts, Fear
              of Sony Takeover</a
            >
          </h3>
          <section>
            <h4>
              <span>2023-12-07 @ 03:17:40</span
              ><span class="points-container"
                >Points: <span class="points">50</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=38552434"
                  >Comments</a
                ><span class="descendants">: 38</span></span
              >
            </h4>
          </section>
        </section>
        <section id="38552267">
          <h3>
            <a
              class="item"
              href="https://www.economist.com/interactive/science-and-technology/2023/12/06/the-extremely-telescope-will-trasform-astronomy"
              >The extremely large telescope will transform astronomy</a
            >
          </h3>
          <section>
            <h4>
              <span>2023-12-07 @ 02:55:40</span
              ><span class="points-container"
                >Points: <span class="points">10</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=38552267"
                  >Comments</a
                ><span class="descendants">: 1</span></span
              >
            </h4>
          </section>
        </section>
        <section id="38552186">
          <h3>
            <a class="item" href="https://arxiv.org/abs/2311.16141"
              >Brain-Inspired Efficient Pruning: Criticality in Spiking Neural
              Networks</a
            >
          </h3>
          <section>
            <h4>
              <span>2023-12-07 @ 02:42:38</span
              ><span class="points-container"
                >Points: <span class="points">5</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=38552186"
                  >Comments</a
                ><span class="descendants">: 0</span></span
              >
            </h4>
          </section>
        </section>
        <section id="38552159">
          <h3>
            <a
              class="item"
              href="https://www.notebookcheck.net/Windows-11-scores-dead-last-in-gaming-performance-tests-against-3-Linux-gaming-distros.778624.0.html"
              >Windows 11 is last in gaming performance tests against 3 Linux
              gaming distros</a
            >
          </h3>
          <section>
            <h4>
              <span>2023-12-07 @ 02:39:32</span
              ><span class="points-container"
                >Points: <span class="points">58</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=38552159"
                  >Comments</a
                ><span class="descendants">: 31</span></span
              >
            </h4>
          </section>
        </section>
        <section id="38551890">
          <h3>
            <a
              class="item"
              href="https://stackdiary.com/23andme-updates-tos-to-force-binding-arbitration/"
              >23andMe updates their TOS to force binding arbitration</a
            >
          </h3>
          <section>
            <h4>
              <span>2023-12-07 @ 01:54:06</span
              ><span class="points-container"
                >Points: <span class="points">143</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=38551890"
                  >Comments</a
                ><span class="descendants">: 76</span></span
              >
            </h4>
          </section>
        </section>
        <section id="38551809">
          <h3>
            <a
              class="item"
              href="https://www.wired.com/2009/05/five-disk-floppy-raid-4mb-of-blistering-fast-storage/"
              >Five-Disk Floppy Raid: 4MB of Blistering Fast Storage (2009)</a
            >
          </h3>
          <section>
            <h4>
              <span>2023-12-07 @ 01:38:07</span
              ><span class="points-container"
                >Points: <span class="points">27</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=38551809"
                  >Comments</a
                ><span class="descendants">: 9</span></span
              >
            </h4>
          </section>
        </section>
        <section id="38550994">
          <h3>
            <a
              class="item"
              href="https://www.cam.ac.uk/research/news/diamonds-and-rust-help-unveil-impossible-quasi-particles"
              >Researchers have discovered magnetic monopole quasi-particles</a
            >
          </h3>
          <section>
            <h4>
              <span>2023-12-06 @ 23:38:40</span
              ><span class="points-container"
                >Points: <span class="points">104</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=38550994"
                  >Comments</a
                ><span class="descendants">: 57</span></span
              >
            </h4>
          </section>
        </section>
        <section id="38550737">
          <h3>
            <a
              class="item"
              href="https://www.macaulaylibrary.org/2021/06/22/behind-the-scenes-of-sound-id-in-merlin/"
              >Merlin Sound ID – Identify Birds Using Your Phone (How It
              Works)</a
            >
          </h3>
          <section>
            <h4>
              <span>2023-12-06 @ 23:08:24</span
              ><span class="points-container"
                >Points: <span class="points">98</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=38550737"
                  >Comments</a
                ><span class="descendants">: 15</span></span
              >
            </h4>
          </section>
        </section>
        <section id="38550675">
          <h3>
            <a
              class="item"
              href="https://www.anthropic.com/index/claude-2-1-prompting"
              >Long context prompting for Claude 2.1</a
            >
          </h3>
          <section>
            <h4>
              <span>2023-12-06 @ 23:00:20</span
              ><span class="points-container"
                >Points: <span class="points">129</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=38550675"
                  >Comments</a
                ><span class="descendants">: 45</span></span
              >
            </h4>
          </section>
        </section>
        <section id="38550408">
          <h3>
            <a
              class="item"
              href="https://moonbase.lgbt/blog/100m-accelerated-backhopping/"
              >Gordon Freeman at the Olympic Games</a
            >
          </h3>
          <section>
            <h4>
              <span>2023-12-06 @ 22:32:46</span
              ><span class="points-container"
                >Points: <span class="points">138</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=38550408"
                  >Comments</a
                ><span class="descendants">: 28</span></span
              >
            </h4>
          </section>
        </section>
        <section id="38550026">
          <h3>
            <a
              class="item"
              href="https://zeus.ugent.be/blog/23-24/open-source-esp32-wifi-mac/"
              >Unveiling secrets of the ESP32: creating an open-source MAC
              layer</a
            >
          </h3>
          <section>
            <h4>
              <span>2023-12-06 @ 21:50:34</span
              ><span class="points-container"
                >Points: <span class="points">170</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=38550026"
                  >Comments</a
                ><span class="descendants">: 70</span></span
              >
            </h4>
          </section>
        </section>
        <section id="38549407">
          <h3>
            <a class="item" href="https://spellbrush.com/careers"
              >Spellbrush (YC W18), Hiring AI Anime Researchers and Gamedevs
              (Tokyo/SF)</a
            >
          </h3>
          <section>
            <h4>
              <span>2023-12-06 @ 21:01:08</span
              ><span class="points-container"
                >Points: <span class="points">1</span></span
              >
            </h4>
          </section>
        </section>
        <section id="38548774">
          <h3>
            <a
              class="item"
              href="https://www.lrb.co.uk/the-paper/v45/n24/julian-barnes/painting-is-terribly-difficult"
              >Painting is Terribly Difficult</a
            >
          </h3>
          <section>
            <h4>
              <span>2023-12-06 @ 20:02:53</span
              ><span class="points-container"
                >Points: <span class="points">45</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=38548774"
                  >Comments</a
                ><span class="descendants">: 45</span></span
              >
            </h4>
          </section>
        </section>
        <section id="38548130">
          <h3>
            <a
              class="item"
              href="https://wikimediafoundation.org/news/2023/12/05/introducing-wikifunctions-first-wikimedia-project-to-launch-in-a-decade-creates-new-forms-of-knowledge/"
              >Wikifunctions</a
            >
          </h3>
          <section>
            <h4>
              <span>2023-12-06 @ 19:04:28</span
              ><span class="points-container"
                >Points: <span class="points">246</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=38548130"
                  >Comments</a
                ><span class="descendants">: 108</span></span
              >
            </h4>
          </section>
        </section>
        <section id="38546520">
          <h3>
            <a class="item" href="https://spotlightjs.com/"
              >Spotlight: Sentry for Development</a
            >
          </h3>
          <section>
            <h4>
              <span>2023-12-06 @ 17:03:27</span
              ><span class="points-container"
                >Points: <span class="points">119</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=38546520"
                  >Comments</a
                ><span class="descendants">: 73</span></span
              >
            </h4>
          </section>
        </section>
        <section id="38545207">
          <h3>
            <a class="item" href="https://github.com/CopilotKit/CopilotKit"
              >Show HN: CopilotKit- Build in-app AI chatbots and AI-powered
              textareas</a
            >
          </h3>
          <section>
            <h4>
              <span>2023-12-06 @ 15:35:41</span
              ><span class="points-container"
                >Points: <span class="points">164</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=38545207"
                  >Comments</a
                ><span class="descendants">: 63</span></span
              >
            </h4>
          </section>
        </section>
        <section id="38544729">
          <h3>
            <a class="item" href="https://deepmind.google/technologies/gemini/"
              >Gemini AI</a
            >
          </h3>
          <section>
            <h4>
              <span>2023-12-06 @ 15:03:47</span
              ><span class="points-container"
                >Points: <span class="points">1587</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=38544729"
                  >Comments</a
                ><span class="descendants">: 1288</span></span
              >
            </h4>
          </section>
        </section>
        <section id="38542166">
          <h3>
            <a
              class="item"
              href="https://www.quantamagazine.org/the-often-overlooked-experiment-that-revealed-the-quantum-world-20231205/"
              >Stern-Gerlach experiment used to probe the clash of quantum
              theory and gravity</a
            >
          </h3>
          <section>
            <h4>
              <span>2023-12-06 @ 10:06:46</span
              ><span class="points-container"
                >Points: <span class="points">20</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=38542166"
                  >Comments</a
                ><span class="descendants">: 3</span></span
              >
            </h4>
          </section>
        </section>
        <section id="38541516">
          <h3>
            <a
              class="item"
              href="https://www.writesoftwarewell.com/cdpath-easily-navigate-directories-in-the-terminal/"
              >Cdpath: Easily Navigate Directories in the Terminal</a
            >
          </h3>
          <section>
            <h4>
              <span>2023-12-06 @ 08:03:12</span
              ><span class="points-container"
                >Points: <span class="points">23</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=38541516"
                  >Comments</a
                ><span class="descendants">: 17</span></span
              >
            </h4>
          </section>
        </section>
        <section id="38541217">
          <h3>
            <a class="item" href="https://osf.io/preprints/osf/285cs"
              >Vowels and Diphthongs in Sperm Whales</a
            >
          </h3>
          <section>
            <h4>
              <span>2023-12-06 @ 07:11:16</span
              ><span class="points-container"
                >Points: <span class="points">21</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=38541217"
                  >Comments</a
                ><span class="descendants">: 4</span></span
              >
            </h4>
          </section>
        </section>
        <section id="38538754">
          <h3>
            <a
              class="item"
              href="https://lemire.me/blog/2023/10/19/for-processing-strings-streams-in-c-can-be-slow/"
              >For processing strings, streams in C++ can be slow</a
            >
          </h3>
          <section>
            <h4>
              <span>2023-12-06 @ 00:08:39</span
              ><span class="points-container"
                >Points: <span class="points">37</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=38538754"
                  >Comments</a
                ><span class="descendants">: 25</span></span
              >
            </h4>
          </section>
        </section>
        <section id="38538144">
          <h3>
            <a
              class="item"
              href="https://docs.syncthing.net/specs/untrusted.html"
              >Syncthing: Untrusted Device Encryption</a
            >
          </h3>
          <section>
            <h4>
              <span>2023-12-05 @ 22:59:54</span
              ><span class="points-container"
                >Points: <span class="points">13</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=38538144"
                  >Comments</a
                ><span class="descendants">: 0</span></span
              >
            </h4>
          </section>
        </section>
        <section id="38537873">
          <h3>
            <a
              class="item"
              href="https://github.blog/2023-12-05-addressing-post-quantum-cryptography-with-codeql/"
              >Addressing post-quantum cryptography with CodeQL</a
            >
          </h3>
          <section>
            <h4>
              <span>2023-12-05 @ 22:34:50</span
              ><span class="points-container"
                >Points: <span class="points">7</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=38537873"
                  >Comments</a
                ><span class="descendants">: 3</span></span
              >
            </h4>
          </section>
        </section>
        <section id="38535446">
          <h3>
            <a
              class="item"
              href="https://www.damninteresting.com/the-sheep-incident/"
              >The Sheep Incident (2008)</a
            >
          </h3>
          <section>
            <h4>
              <span>2023-12-05 @ 19:05:51</span
              ><span class="points-container"
                >Points: <span class="points">89</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=38535446"
                  >Comments</a
                ><span class="descendants">: 22</span></span
              >
            </h4>
          </section>
        </section>
        <section id="38534153">
          <h3>
            <a
              class="item"
              href="https://www.bikobatanari.art/posts/2023/east-west-website-culture"
              >Browsing the Eastern Side of the Personal Web</a
            >
          </h3>
          <section>
            <h4>
              <span>2023-12-05 @ 17:37:27</span
              ><span class="points-container"
                >Points: <span class="points">96</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=38534153"
                  >Comments</a
                ><span class="descendants">: 27</span></span
              >
            </h4>
          </section>
        </section>
        <section id="38529143">
          <h3>
            <a
              class="item"
              href="https://medium.com/@happybits/how-hackerman-would-create-an-image-just-by-typing-zeros-and-ones-a-deep-dive-into-gif-file-32bada0926c0"
              >How Hackerman would create an image just by typing 0 and 1 – deep
              dive into GIF</a
            >
          </h3>
          <section>
            <h4>
              <span>2023-12-05 @ 10:30:36</span
              ><span class="points-container"
                >Points: <span class="points">113</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=38529143"
                  >Comments</a
                ><span class="descendants">: 37</span></span
              >
            </h4>
          </section>
        </section>
        <section id="38515571">
          <h3>
            <a
              class="item"
              href="https://binarly.io/posts/The_Far_Reaching_Consequences_of_LogoFAIL/"
              >LogoFAIL: Secure Boot bypass with manipulated boot logos</a
            >
          </h3>
          <section>
            <h4>
              <span>2023-12-04 @ 10:14:35</span
              ><span class="points-container"
                >Points: <span class="points">199</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=38515571"
                  >Comments</a
                ><span class="descendants">: 250</span></span
              >
            </h4>
          </section>
        </section>
      </section>
      <section id="archives">
        <h2>
          <a
            href="https://github.com/kherrick/hacker-news/blob/main/archives/index.md"
            >Archives</a
          >
        </h2>
        <section>
          <h3>
            <a
              href="https://github.com/kherrick/hacker-news/blob/main/archives/2023/index.md"
              >2023</a
            >
          </h3>
        </section>
        <section>
          <h3>
            <a
              href="https://github.com/kherrick/hacker-news/blob/main/archives/2022/index.md"
              >2022</a
            >
          </h3>
        </section>
      </section>
    </main>
    <script type="module">
      import { buildDescendants } from "./lib/build-html-descendants.js";
      import { buildNextItem } from "./lib/build-html-next-item.js";
      import { getNextDateTime } from "./lib/date-time.js";

      const updateSectionById = (id) =>
        fetch(`https://hacker-news.firebaseio.com/v0/item/${id}.json`).then(
          (result) =>
            result.json().then(({ descendants, id, score, text, type }) => {
              const currentItem = document.getElementById(id);

              if (score) {
                currentItem.querySelector(".points").textContent = score;
              }

              if (descendants && (type === "poll" || type === "story")) {
                const currentDescendants =
                  currentItem.querySelector(".descendants");

                if (currentDescendants) {
                  currentDescendants.textContent = `: ${descendants}`;
                } else {
                  const comments = buildDescendants(
                    document,
                    descendants,
                    `https://news.ycombinator.com/item?id=${id}`
                  );

                  currentItem.querySelector("h4").appendChild(comments);
                }
              }

              if (text) {
                const currentText = currentItem.querySelector(".text");

                if (currentText) {
                  currentText.innerHTML = text.replace(/\0/g, "");
                } else {
                  const content = document.createElement("div");
                  content.innerHTML = text.replace(/\0/g, "");
                  content.setAttribute("class", "text");

                  currentItem.appendChild(content);
                }
              }
            })
        );

      class UpdateQueue {
        constructor() {
          this._ids = [];
          this._isUpdating = false;
        }

        addItemById(id) {
          this._ids.push(id);
        }

        async flush() {
          const id = this._ids.shift();

          if (id) {
            this._isUpdating = true;

            await updateSectionById(id);
            await this.flush();
          } else {
            this._isUpdating = false;

            setTimeout(async () => {
              if (!this._isUpdating && this._ids && this._ids.length) {
                await this.flush();
              }
            }, 0);
          }
        }
      }

      // get latest data
      const latestSection = document.getElementById("latest");

      for (let item of latestSection.querySelectorAll("section[id]")) {
        updateSectionById(item.getAttribute("id"));
      }

      if ("IntersectionObserver" in window) {
        window.hackerNewsState = { index: [], nextTimeIndex: -1 };

        const addNewsItem = async (newsItem, queue) => {
          try {
            const { date, time, itemComments, itemTitle, itemLink } = newsItem;
            const section = await buildNextItem({
              document,
              dateTime: `${date}, ${time}`,
              itemComments,
              itemLink,
              itemTitle: new DOMParser().parseFromString(
                itemTitle.replace(/\\/g, ""),
                "text/html"
              ).documentElement.textContent,
              fetchItemDetails: false,
            });

            // display loading indicator for section
            section.querySelector(".points-container").innerHTML =
              'Points: <span class="points"><img style="height: 100%;" src="lib/images/loading.svg" /></span>';

            const id = section.getAttribute("id");
            if (!document.getElementById(id)) {
              document.getElementById("latest").appendChild(section);

              queue.addItemById(id);
            }
          } catch (error) {}
        };

        const buildArchiveIndex = async (lastDateTime) => {
          const nextDate = lastDateTime.slice(0, 10);
          const nextYear = nextDate.slice(0, 4);

          return (
            await (
              await fetch(
                `https://raw.githubusercontent.com/kherrick/hacker-news/main/archives/${nextYear}/${nextDate}/index.md`
              )
            ).text()
          )
            .split("\n")
            .filter((line) => line.match(new RegExp("^\\* \\[")))
            .map((line) => {
              const segment = line.replace("* ", "").split("](");
              const pubDate = segment[0].slice(1);

              const itemComments = segment[1].split(") - [")[0];
              const itemTitle = segment[1].split(") - [")[1];
              const itemLink = segment[2].slice(0, -1);
              const date = pubDate.slice(0, 10);
              const time = pubDate.slice(-8);

              return {
                date,
                itemComments,
                itemLink,
                itemTitle,
                time,
              };
            });
        };

        const handleIntersectingEntry = async (entry, queue) => {
          if (entry.isIntersecting) {
            const lastDateTime = document
              .getElementById("latest")
              .querySelector(
                "section:last-child > section > h4 > span"
              ).textContent;

            const nextDateTime = getNextDateTime(lastDateTime ?? "", -1);
            const archiveIndex = await buildArchiveIndex(nextDateTime);
            const nextTimeIndex = archiveIndex.findIndex(
              ({ time }) => time === nextDateTime.slice(-8)
            );

            const handleIndexUpdate = (index, existingIndexValues = []) => {
              index.forEach((i) => {
                existingIndexValues.push(i);
              });
              return existingIndexValues;
            };

            window.hackerNewsState = {
              index: handleIndexUpdate(
                archiveIndex,
                window.hackerNewsState.index
              ),
              nextTimeIndex,
            };

            let currentTimeIndex = nextTimeIndex + 1;
            const items = Object.values(window.hackerNewsState.index);
            for (let item of items) {
              if (currentTimeIndex < window.hackerNewsState.index.length) {
                addNewsItem(items[currentTimeIndex], queue);

                currentTimeIndex = currentTimeIndex + 1;
              }
            }

            queue.flush();
          }
        };

        const archives = document.getElementById("archives");
        const archivesObserver = new IntersectionObserver(
          (entries) => {
            const queue = new UpdateQueue();

            entries.forEach((entry) => handleIntersectingEntry(entry, queue));
          },
          {
            root: null,
            rootMargin: "0px",
            threshold: 0,
          }
        );

        archivesObserver.observe(archives);

        let latestSectionsExpanded = true;
        const handleLatestHeaderClick = () => {
          latestSectionsExpanded = !latestSectionsExpanded;

          if (latestSectionsExpanded) {
            archivesObserver.observe(archives);
          } else {
            archivesObserver.disconnect(archives);
          }

          for (let section of document.querySelectorAll("#latest > section")) {
            section.style.display = latestSectionsExpanded ? "block" : "none";
          }
        };

        const latestHeader = document.querySelector("#latest > h2");
        latestHeader.style.cursor = "pointer";
        latestHeader.addEventListener("click", handleLatestHeaderClick);
      }
    </script>
    <script type="module">
      import { Workbox } from "https://storage.googleapis.com/workbox-cdn/releases/6.4.1/workbox-window.prod.mjs";

      if ("serviceWorker" in navigator) {
        const base = document.querySelector("base");
        const serviceWorkerPath = `${
          base ? base.href.replace(/\/$/, "") : ""
        }/service-worker.js`;

        const wb = new Workbox(serviceWorkerPath);

        // setup event listeners
        wb.addEventListener("waiting", (event) => {
          wb.addEventListener("controlling", () => {
            window.location.reload();
          });

          wb.messageSkipWaiting();
        });

        wb.register();
      }
    </script>
  </body>
</html>
