<!DOCTYPE html>
<html lang="en" xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta charset="utf-8" />
    <meta
      content="width=device-width, initial-scale=1.0, viewport-fit=cover"
      name="viewport"
    />
    <meta name="description" content="Hacker News" />
    <meta name="theme-color" content="#fff" />
    <title>Hacker News</title>
    <link rel="manifest" href="manifest.json" />
    <link
      href="data:image/x-icon;base64,AAABAAEAAQECAAEAAQA4AAAAFgAAACgAAAABAAAAAgAAAAEAAQAAAAAAAAAAAAAAAAAAAAAAAAAAAAABAAEAAQECAAEAAQA4AAAAFgAAACgAAAABAAAAAgAAAAEAAQAAAAAAAAAAAAAAAAAAAAAAAAAA"
      rel="icon"
      type="image/x-icon"
    />
    <link
      href="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAgAAAAIAAQMAAADOtka5AAAAA1BMVEUAAACnej3aAAAANklEQVR42u3BAQEAAACCIP+vbkhAAQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAB8G4IAAAFjdVCkAAAAAElFTkSuQmCC"
      rel="apple-touch-icon"
    />
    <style>
      /*<!--*/
      body {
        color: rgb(25, 25, 25);
        font-family: Verdana, Geneva, sans-serif;
        margin: 0;
      }

      a {
        text-decoration: none;
      }

      a:link,
      a:focus,
      a:hover,
      a:active {
        color: rgb(75, 75, 125);
      }

      a:visited {
        color: rgb(25, 25, 25);
      }

      h1 > a,
      h1 > a:link,
      h1 > a:focus,
      h1 > a:hover,
      h1 > a:active,
      h1 > a:visited,
      h2 > a,
      h2 > a:link,
      h2 > a:focus,
      h2 > a:hover,
      h2 > a:active,
      h2 > a:visited {
        color: rgb(25, 25, 25);
      }

      h1 {
        background-color: rgb(255, 102, 0);
        margin: 0;
        padding: 1rem;
      }

      h2 {
        background-color: rgb(200, 200, 200);
        margin: 1rem 0;
        padding: 0.5rem 0.5rem 0.5rem 1rem;
      }

      #latest > section,
      #archives > section {
        margin: 0 1rem 1rem 1rem;
        padding-bottom: 1rem;
      }

      #latest > section:not(:last-child),
      #archives > section:not(:last-child) {
        border-bottom: 1px dotted rgb(200, 200, 200);
      }

      section > h3 {
        margin: 0 0 0.5rem 0;
      }

      section > h4 {
        font-weight: normal;
        margin: 0 0 0 1rem;
      }

      .descendants-container,
      .points-container {
        align-items: center;
        border-left: 1px solid #333;
        display: inline-flex;
        margin-left: 0.5rem;
        padding-left: 0.5rem;
        text-align: center;
      }

      .points {
        align-items: center;
        display: inline-flex;
        height: 1rem;
        margin-left: 1ch;
        min-width: 3ch;
      }

      .text {
        line-height: 1.5rem;
        margin: 1rem 1rem 0 1rem;
        overflow: auto;
      }

      .text > p:first-child {
        margin-top: 1rem;
      }

      .text > p:last-child {
        margin-bottom: 0;
      }
      /*-->*/
    </style>
  </head>

  <body>
    <main>
      <h1><a href="https://kherrick.github.io/hacker-news/">Hacker News</a></h1>
      <section id="latest">
        <h2>Latest</h2>
        <section id="37218879">
          <h3>
            <a
              class="item"
              href="https://www.st.com/en/microcontrollers-microprocessors/stm32mp1-series.html"
              >STM32 family grows to microprocessor/Linux level with STM32MP1</a
            >
          </h3>
          <section>
            <h4>
              <span>2023-08-22 @ 05:04:49</span
              ><span class="points-container"
                >Points: <span class="points">44</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=37218879"
                  >Comments</a
                ><span class="descendants">: 14</span></span
              >
            </h4>
          </section>
        </section>
        <section id="37218841">
          <h3>
            <a
              class="item"
              href="https://blog.ioces.com/matt/posts/i-walked-across-luxembourg/"
              >I walked across Luxembourg</a
            >
          </h3>
          <section>
            <h4>
              <span>2023-08-22 @ 04:57:26</span
              ><span class="points-container"
                >Points: <span class="points">66</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=37218841"
                  >Comments</a
                ><span class="descendants">: 16</span></span
              >
            </h4>
          </section>
        </section>
        <section id="37218783">
          <h3>
            <a
              class="item"
              href="https://github.com/ergomake/layerform/blob/main/blog/terraform-states.md"
              >Manipulating Terraform states for fun, profit, and reusability</a
            >
          </h3>
          <section>
            <h4>
              <span>2023-08-22 @ 04:45:10</span
              ><span class="points-container"
                >Points: <span class="points">11</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=37218783"
                  >Comments</a
                ><span class="descendants">: 4</span></span
              >
            </h4>
          </section>
        </section>
        <section id="37218727">
          <h3>
            <a
              class="item"
              href="https://scienceswitch.com/2023/08/22/revolutionary-electrolyzer-efficiently-converts-co2-into-renewable-propane-fuel/"
              >Electrolyzer efficiently converts CO2 into renewable propane
              fuel</a
            >
          </h3>
          <section>
            <h4>
              <span>2023-08-22 @ 04:34:04</span
              ><span class="points-container"
                >Points: <span class="points">73</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=37218727"
                  >Comments</a
                ><span class="descendants">: 42</span></span
              >
            </h4>
          </section>
        </section>
        <section id="37218531">
          <h3>
            <a
              class="item"
              href="https://journals.aps.org/pre/abstract/10.1103/PhysRevE.108.024130"
              >Charging capacitors from thermal fluctuations using diodes</a
            >
          </h3>
          <section>
            <h4>
              <span>2023-08-22 @ 04:00:29</span
              ><span class="points-container"
                >Points: <span class="points">19</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=37218531"
                  >Comments</a
                ><span class="descendants">: 6</span></span
              >
            </h4>
          </section>
        </section>
        <section id="37218289">
          <h3>
            <a class="item" href="https://nixos.wiki/wiki/Impermanence"
              >Impermanence</a
            >
          </h3>
          <section>
            <h4>
              <span>2023-08-22 @ 03:24:45</span
              ><span class="points-container"
                >Points: <span class="points">64</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=37218289"
                  >Comments</a
                ><span class="descendants">: 17</span></span
              >
            </h4>
          </section>
        </section>
        <section id="37218268">
          <h3>
            <a
              class="item"
              href="https://www.commonwealmagazine.org/parking-grabar-slate-henry-paved-paradise"
              >Asphalt Wasteland: Maybe parking does explain the world</a
            >
          </h3>
          <section>
            <h4>
              <span>2023-08-22 @ 03:21:56</span
              ><span class="points-container"
                >Points: <span class="points">30</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=37218268"
                  >Comments</a
                ><span class="descendants">: 41</span></span
              >
            </h4>
          </section>
        </section>
        <section id="37218263">
          <h3>
            <a
              class="item"
              href="https://www.hillelwayne.com/post/ahk-scripts-project/"
              >Learn AutoHotKey by stealing my scripts</a
            >
          </h3>
          <section>
            <h4>
              <span>2023-08-22 @ 03:20:32</span
              ><span class="points-container"
                >Points: <span class="points">130</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=37218263"
                  >Comments</a
                ><span class="descendants">: 47</span></span
              >
            </h4>
          </section>
        </section>
        <section id="37218114">
          <h3>
            <a
              class="item"
              href="https://blog.0x7d0.dev/history/unlocking-discord-nitro-features-for-free/"
              >Unlocking Discord Nitro features for free</a
            >
          </h3>
          <section>
            <h4>
              <span>2023-08-22 @ 02:58:43</span
              ><span class="points-container"
                >Points: <span class="points">109</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=37218114"
                  >Comments</a
                ><span class="descendants">: 40</span></span
              >
            </h4>
          </section>
        </section>
        <section id="37217940">
          <h3>
            <a
              class="item"
              href="https://www.economist.com/business/2023/08/21/americas-corporate-giants-are-getting-harder-to-topple"
              >Incumbents are fighting back against disrupters</a
            >
          </h3>
          <section>
            <h4>
              <span>2023-08-22 @ 02:35:23</span
              ><span class="points-container"
                >Points: <span class="points">126</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=37217940"
                  >Comments</a
                ><span class="descendants">: 95</span></span
              >
            </h4>
          </section>
        </section>
        <section id="37217917">
          <h3>
            <a
              class="item"
              href="https://www.jessewright.com/jeff-bezos-on-ai-1998"
              >Jeff Bezos on AI (1998) [video]</a
            >
          </h3>
          <section>
            <h4>
              <span>2023-08-22 @ 02:31:27</span
              ><span class="points-container"
                >Points: <span class="points">107</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=37217917"
                  >Comments</a
                ><span class="descendants">: 57</span></span
              >
            </h4>
          </section>
        </section>
        <section id="37217871">
          <h3>
            <a class="item" href="https://www.compuserve.com/">Compuserve</a>
          </h3>
          <section>
            <h4>
              <span>2023-08-22 @ 02:25:17</span
              ><span class="points-container"
                >Points: <span class="points">80</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=37217871"
                  >Comments</a
                ><span class="descendants">: 44</span></span
              >
            </h4>
          </section>
        </section>
        <section id="37217364">
          <h3>
            <a
              class="item"
              href="https://www.ycombinator.com/companies/justpaid-io/jobs/oCjZzPi-founding-frontend-engineer-contract-to-hire"
              >Justpaid.io (YC W23) Is Hiring Founding Frontend Engineer</a
            >
          </h3>
          <section>
            <h4>
              <span>2023-08-22 @ 01:12:05</span
              ><span class="points-container"
                >Points: <span class="points">1</span></span
              >
            </h4>
          </section>
        </section>
        <section id="37215974">
          <h3>
            <a class="item" href="https://krisnova.net/posts/ego-death/"
              >Ego Death</a
            >
          </h3>
          <section>
            <h4>
              <span>2023-08-21 @ 22:05:17</span
              ><span class="points-container"
                >Points: <span class="points">124</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=37215974"
                  >Comments</a
                ><span class="descendants">: 67</span></span
              >
            </h4>
          </section>
        </section>
        <section id="37215829">
          <h3>
            <a
              class="item"
              href="https://www.niemanlab.org/2023/08/not-a-replacement-of-journalists-in-any-way-ap-clarifies-standards-around-generative-ai/"
              >Associated Press clarifies standards around generative AI</a
            >
          </h3>
          <section>
            <h4>
              <span>2023-08-21 @ 21:51:45</span
              ><span class="points-container"
                >Points: <span class="points">65</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=37215829"
                  >Comments</a
                ><span class="descendants">: 24</span></span
              >
            </h4>
          </section>
        </section>
        <section id="37215557">
          <h3>
            <a
              class="item"
              href="https://addons.mozilla.org/en-US/firefox/addon/ublock-origin-lite/"
              >uBlock Origin Lite now available on Firefox</a
            >
          </h3>
          <section>
            <h4>
              <span>2023-08-21 @ 21:23:51</span
              ><span class="points-container"
                >Points: <span class="points">505</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=37215557"
                  >Comments</a
                ><span class="descendants">: 245</span></span
              >
            </h4>
          </section>
        </section>
        <section id="37215246">
          <h3>
            <a
              class="item"
              href="http://blog.rfox.eu/en/Hardware/SolarPi_experiment_2_Finally_something_that_works.html"
              >SolarPi experiment 2: Finally something that works</a
            >
          </h3>
          <section>
            <h4>
              <span>2023-08-21 @ 20:57:23</span
              ><span class="points-container"
                >Points: <span class="points">89</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=37215246"
                  >Comments</a
                ><span class="descendants">: 43</span></span
              >
            </h4>
          </section>
        </section>
        <section id="37214733">
          <h3>
            <a
              class="item"
              href="https://security.googleblog.com/2023/08/pixel-binary-transparency-verifiable.html"
              >Pixel Binary Transparency: verifiable security for Pixel
              devices</a
            >
          </h3>
          <section>
            <h4>
              <span>2023-08-21 @ 20:12:40</span
              ><span class="points-container"
                >Points: <span class="points">167</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=37214733"
                  >Comments</a
                ><span class="descendants">: 90</span></span
              >
            </h4>
          </section>
        </section>
        <section id="37214342">
          <h3>
            <a class="item" href="https://getconvoy.io/blog/why-open-source/"
              >Why Open Source?</a
            >
          </h3>
          <section>
            <h4>
              <span>2023-08-21 @ 19:41:39</span
              ><span class="points-container"
                >Points: <span class="points">145</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=37214342"
                  >Comments</a
                ><span class="descendants">: 93</span></span
              >
            </h4>
          </section>
        </section>
        <section id="37211642">
          <h3>
            <a
              class="item"
              href="https://davidgomes.com/the-broad-set-of-computer-science-problems-faced-at-cloud-database-companies/"
              >The broad set of computer science problems faced at cloud
              database companies</a
            >
          </h3>
          <section>
            <h4>
              <span>2023-08-21 @ 16:17:56</span
              ><span class="points-container"
                >Points: <span class="points">153</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=37211642"
                  >Comments</a
                ><span class="descendants">: 40</span></span
              >
            </h4>
          </section>
        </section>
        <section id="37211365">
          <h3>
            <a
              class="item"
              href="https://techxplore.com/news/2023-08-clever-coating-lampshades-indoor-air.html"
              >Clever coating turns lampshades into indoor air purifiers</a
            >
          </h3>
          <section>
            <h4>
              <span>2023-08-21 @ 15:58:50</span
              ><span class="points-container"
                >Points: <span class="points">8</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=37211365"
                  >Comments</a
                ><span class="descendants">: 1</span></span
              >
            </h4>
          </section>
        </section>
        <section id="37211230">
          <h3>
            <a
              class="item"
              href="https://www.folklore.org/StoryView.py?story=Saving_Lives.txt"
              >Saving Lives</a
            >
          </h3>
          <section>
            <h4>
              <span>2023-08-21 @ 15:51:18</span
              ><span class="points-container"
                >Points: <span class="points">309</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=37211230"
                  >Comments</a
                ><span class="descendants">: 282</span></span
              >
            </h4>
          </section>
        </section>
        <section id="37210146">
          <h3>
            <a class="item" href="https://www.youtube.com/watch?v=BYOiYvdaCis"
              >How to use a Breadboard. How do breadboards work? (2021)
              [video]</a
            >
          </h3>
          <section>
            <h4>
              <span>2023-08-21 @ 14:39:47</span
              ><span class="points-container"
                >Points: <span class="points">31</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=37210146"
                  >Comments</a
                ><span class="descendants">: 4</span></span
              >
            </h4>
          </section>
        </section>
        <section id="37210103">
          <h3>
            <a
              class="item"
              href="https://www.phoronix.com/news/FreeBSD-Port-Linux-DRM-KO"
              >FreeBSD Experimenting with a Port of Nvidia's Linux Open DRM
              Kernel Driver</a
            >
          </h3>
          <section>
            <h4>
              <span>2023-08-21 @ 14:36:22</span
              ><span class="points-container"
                >Points: <span class="points">100</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=37210103"
                  >Comments</a
                ><span class="descendants">: 25</span></span
              >
            </h4>
          </section>
        </section>
        <section id="37209888">
          <h3>
            <a
              class="item"
              href="https://www.beautifulpublicdata.com/all-of-the-license-plates-in-the-united-states/"
              >All of the vehicle license plates available in America</a
            >
          </h3>
          <section>
            <h4>
              <span>2023-08-21 @ 14:19:18</span
              ><span class="points-container"
                >Points: <span class="points">199</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=37209888"
                  >Comments</a
                ><span class="descendants">: 235</span></span
              >
            </h4>
          </section>
        </section>
        <section id="37207927">
          <h3>
            <a class="item" href="https://bluegrassarchive.com/"
              >Bluegrass Archive</a
            >
          </h3>
          <section>
            <h4>
              <span>2023-08-21 @ 11:12:39</span
              ><span class="points-container"
                >Points: <span class="points">82</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=37207927"
                  >Comments</a
                ><span class="descendants">: 26</span></span
              >
            </h4>
          </section>
        </section>
        <section id="37207183">
          <h3>
            <a
              class="item"
              href="https://outsidetheasylum.blog/the-economics-of-organized-play/"
              >The Economics of Organized Play</a
            >
          </h3>
          <section>
            <h4>
              <span>2023-08-21 @ 09:32:57</span
              ><span class="points-container"
                >Points: <span class="points">16</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=37207183"
                  >Comments</a
                ><span class="descendants">: 1</span></span
              >
            </h4>
          </section>
        </section>
        <section id="37205559">
          <h3>
            <a
              class="item"
              href="https://www.sciencedirect.com/science/article/pii/S2666979X2300174X"
              >Genome of the Tyrolean Iceman reveals unusually high Anatolian
              farmer ancestry</a
            >
          </h3>
          <section>
            <h4>
              <span>2023-08-21 @ 04:40:10</span
              ><span class="points-container"
                >Points: <span class="points">26</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=37205559"
                  >Comments</a
                ><span class="descendants">: 14</span></span
              >
            </h4>
          </section>
        </section>
        <section id="37205536">
          <h3>
            <a
              class="item"
              href="https://utcc.utoronto.ca/~cks/space/blog/unix/UnixTechnologyAndIdea"
              >Unix is both a technology and an idea</a
            >
          </h3>
          <section>
            <h4>
              <span>2023-08-21 @ 04:34:43</span
              ><span class="points-container"
                >Points: <span class="points">64</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=37205536"
                  >Comments</a
                ><span class="descendants">: 17</span></span
              >
            </h4>
          </section>
        </section>
        <section id="37194128">
          <h3>
            <a class="item" href="https://ad8e.pages.dev/keyboard"
              >Show HN: Just intonation keyboard â€“ play music without knowing
              music</a
            >
          </h3>
          <section>
            <h4>
              <span>2023-08-19 @ 22:49:00</span
              ><span class="points-container"
                >Points: <span class="points">284</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=37194128"
                  >Comments</a
                ><span class="descendants">: 52</span></span
              >
            </h4>
            <div class="text">
              <p>
                You can play without knowing any music theory. Hit arbitrary
                notes with the rhythm you want, and the pitches will work. Not
                understanding the buttons is fine. Even rolling your elbow
                around your keyboard is fine.
              </p>
              <p>
                If you are a musician and press the wrong key while playing a
                song, it will still fit. It will sound like you made an
                intelligent, conscious choice to play another note, even though
                you know in your heart it was an accident. Beginner jazz
                musicians rejoice.
              </p>
              <p>
                It's not an AI making choices for you; it's just a very elegant
                interface. What makes this possible is several new discoveries
                in psychoacoustics about how harmony works. While a piano lays
                out notes in pitch space, this keyboard is able to lay out notes
                in consonance space. When you play random notes, they tend to be
                "close together" on the physical keyboard. Distance on the
                keyboard maps well to distance in consonance space, so those
                random notes are close together in consonance space and sound
                good together.
              </p>
              <p>
                According to Miles Davis, a "wrong" note becomes correct in the
                right context. If you try to play a wrong note, the purple
                buttons you press will automatically land you in the right
                context, even if you don't know what that context is yourself.
                So you can stumble your way through an improv and the keyboard
                will offer the right notes without needing you to think about
                it.
              </p>
              <p>
                Harmonic consonance of chords can be read directly off the
                numbers in the keyboard, which implies that these numbers are a
                good language to think about music with. It doesn't take years
                of training, just reading the rules. The key harmony insight
                that you can do on this keyboard, and not on a piano, is to add
                frequencies linearly (like 400 Hz + 300 Hz). The reason this
                matters is that linear combinations of frequencies are a major
                factor of harmony, in lattice tones. So to see how dissonant or
                consonant a chord is, you want to check how distant it is from a
                sum or arithmetic progression. On a piano, to do the same, you'd
                have to memorize fractional approximations of 2^(N/12), then add
                and subtract these fractions, which is very difficult. For
                example, how far is 6/5 + 4/3 from 5/2? Hard to say! But if
                denominators are cleared, it's easy to compare 36 40 45: they're
                off by 1 from an arithmetic progression. This also applies to
                overlapping notes, not just chords. Having all the keys
                accessible on a piano is very convenient, but this translation
                layer of 2^(N/12) approximation + fractional arithmetic makes it
                hard to see harmony beyond the pairwise ratios.
              </p>
              <p>
                The subset of playable songs is different from a piano, which
                means that songs in your existing piano repertoire will snip off
                some notes. Hardware for thumb keys would fix this, so you could
                play your existing piano songs in full, plus other songs a piano
                can't play. I don't have such hardware so I haven't implemented
                this. The other way is to have two keyboards and a partner.
              </p>
              <p>
                The remaining issue is that there is no sheet music in just
                intonation. Unfortunately, I have had no success in finding
                piano sheet music in a common, interpretable format. So while I
                do have a converter from 12 equal temperament to just
                intonation, there are no input files to use it with...
              </p>
            </div>
          </section>
        </section>
      </section>
      <section id="archives">
        <h2>
          <a
            href="https://github.com/kherrick/hacker-news/blob/main/archives/index.md"
            >Archives</a
          >
        </h2>
        <section>
          <h3>
            <a
              href="https://github.com/kherrick/hacker-news/blob/main/archives/2023/index.md"
              >2023</a
            >
          </h3>
        </section>
        <section>
          <h3>
            <a
              href="https://github.com/kherrick/hacker-news/blob/main/archives/2022/index.md"
              >2022</a
            >
          </h3>
        </section>
      </section>
    </main>
    <script type="module">
      import { buildDescendants } from "./lib/build-html-descendants.js";
      import { buildNextItem } from "./lib/build-html-next-item.js";
      import { getNextDateTime } from "./lib/date-time.js";

      const updateSectionById = (id) =>
        fetch(`https://hacker-news.firebaseio.com/v0/item/${id}.json`).then(
          (result) =>
            result.json().then(({ descendants, id, score, text, type }) => {
              const currentItem = document.getElementById(id);

              if (score) {
                currentItem.querySelector(".points").textContent = score;
              }

              if (descendants && (type === "poll" || type === "story")) {
                const currentDescendants =
                  currentItem.querySelector(".descendants");

                if (currentDescendants) {
                  currentDescendants.textContent = `: ${descendants}`;
                } else {
                  const comments = buildDescendants(
                    document,
                    descendants,
                    `https://news.ycombinator.com/item?id=${id}`
                  );

                  currentItem.querySelector("h4").appendChild(comments);
                }
              }

              if (text) {
                const currentText = currentItem.querySelector(".text");

                if (currentText) {
                  currentText.innerHTML = text.replace(/\0/g, "");
                } else {
                  const content = document.createElement("div");
                  content.innerHTML = text.replace(/\0/g, "");
                  content.setAttribute("class", "text");

                  currentItem.appendChild(content);
                }
              }
            })
        );

      class UpdateQueue {
        constructor() {
          this._ids = [];
          this._isUpdating = false;
        }

        addItemById(id) {
          this._ids.push(id);
        }

        async flush() {
          const id = this._ids.shift();

          if (id) {
            this._isUpdating = true;

            await updateSectionById(id);
            await this.flush();
          } else {
            this._isUpdating = false;

            setTimeout(async () => {
              if (!this._isUpdating && this._ids && this._ids.length) {
                await this.flush();
              }
            }, 0);
          }
        }
      }

      // get latest data
      const latestSection = document.getElementById("latest");

      for (let item of latestSection.querySelectorAll("section[id]")) {
        updateSectionById(item.getAttribute("id"));
      }

      if ("IntersectionObserver" in window) {
        window.hackerNewsState = { index: [], nextTimeIndex: -1 };

        const addNewsItem = async (newsItem, queue) => {
          try {
            const { date, time, itemComments, itemTitle, itemLink } = newsItem;
            const section = await buildNextItem({
              document,
              dateTime: `${date}, ${time}`,
              itemComments,
              itemLink,
              itemTitle: new DOMParser().parseFromString(
                itemTitle.replace(/\\/g, ""),
                "text/html"
              ).documentElement.textContent,
              fetchItemDetails: false,
            });

            // display loading indicator for section
            section.querySelector(".points-container").innerHTML =
              'Points: <span class="points"><img style="height: 100%;" src="lib/images/loading.svg" /></span>';

            const id = section.getAttribute("id");
            if (!document.getElementById(id)) {
              document.getElementById("latest").appendChild(section);

              queue.addItemById(id);
            }
          } catch (error) {}
        };

        const buildArchiveIndex = async (lastDateTime) => {
          const nextDate = lastDateTime.slice(0, 10);
          const nextYear = nextDate.slice(0, 4);

          return (
            await (
              await fetch(
                `https://raw.githubusercontent.com/kherrick/hacker-news/main/archives/${nextYear}/${nextDate}/index.md`
              )
            ).text()
          )
            .split("\n")
            .filter((line) => line.match(new RegExp("^\\* \\[")))
            .map((line) => {
              const segment = line.replace("* ", "").split("](");
              const pubDate = segment[0].slice(1);

              const itemComments = segment[1].split(") - [")[0];
              const itemTitle = segment[1].split(") - [")[1];
              const itemLink = segment[2].slice(0, -1);
              const date = pubDate.slice(0, 10);
              const time = pubDate.slice(-8);

              return {
                date,
                itemComments,
                itemLink,
                itemTitle,
                time,
              };
            });
        };

        const handleIntersectingEntry = async (entry, queue) => {
          if (entry.isIntersecting) {
            const lastDateTime = document
              .getElementById("latest")
              .querySelector(
                "section:last-child > section > h4 > span"
              ).textContent;

            const nextDateTime = getNextDateTime(lastDateTime ?? "", -1);
            const archiveIndex = await buildArchiveIndex(nextDateTime);
            const nextTimeIndex = archiveIndex.findIndex(
              ({ time }) => time === nextDateTime.slice(-8)
            );

            const handleIndexUpdate = (index, existingIndexValues = []) => {
              index.forEach((i) => {
                existingIndexValues.push(i);
              });
              return existingIndexValues;
            };

            window.hackerNewsState = {
              index: handleIndexUpdate(
                archiveIndex,
                window.hackerNewsState.index
              ),
              nextTimeIndex,
            };

            let currentTimeIndex = nextTimeIndex + 1;
            const items = Object.values(window.hackerNewsState.index);
            for (let item of items) {
              if (currentTimeIndex < window.hackerNewsState.index.length) {
                addNewsItem(items[currentTimeIndex], queue);

                currentTimeIndex = currentTimeIndex + 1;
              }
            }

            queue.flush();
          }
        };

        const archives = document.getElementById("archives");
        const archivesObserver = new IntersectionObserver(
          (entries) => {
            const queue = new UpdateQueue();

            entries.forEach((entry) => handleIntersectingEntry(entry, queue));
          },
          {
            root: null,
            rootMargin: "0px",
            threshold: 0,
          }
        );

        archivesObserver.observe(archives);

        let latestSectionsExpanded = true;
        const handleLatestHeaderClick = () => {
          latestSectionsExpanded = !latestSectionsExpanded;

          if (latestSectionsExpanded) {
            archivesObserver.observe(archives);
          } else {
            archivesObserver.disconnect(archives);
          }

          for (let section of document.querySelectorAll("#latest > section")) {
            section.style.display = latestSectionsExpanded ? "block" : "none";
          }
        };

        const latestHeader = document.querySelector("#latest > h2");
        latestHeader.style.cursor = "pointer";
        latestHeader.addEventListener("click", handleLatestHeaderClick);
      }
    </script>
    <script type="module">
      import { Workbox } from "https://storage.googleapis.com/workbox-cdn/releases/6.4.1/workbox-window.prod.mjs";

      if ("serviceWorker" in navigator) {
        const base = document.querySelector("base");
        const serviceWorkerPath = `${
          base ? base.href.replace(/\/$/, "") : ""
        }/service-worker.js`;

        const wb = new Workbox(serviceWorkerPath);

        // setup event listeners
        wb.addEventListener("waiting", (event) => {
          wb.addEventListener("controlling", () => {
            window.location.reload();
          });

          wb.messageSkipWaiting();
        });

        wb.register();
      }
    </script>
  </body>
</html>
