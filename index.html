<!DOCTYPE html>
<html lang="en" xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta charset="utf-8" />
    <meta
      content="width=device-width, initial-scale=1.0, viewport-fit=cover"
      name="viewport"
    />
    <meta name="description" content="Hacker News" />
    <meta name="theme-color" content="#fff" />
    <title>Hacker News</title>
    <link rel="manifest" href="manifest.json" />
    <link
      href="data:image/x-icon;base64,AAABAAEAAQECAAEAAQA4AAAAFgAAACgAAAABAAAAAgAAAAEAAQAAAAAAAAAAAAAAAAAAAAAAAAAAAAABAAEAAQECAAEAAQA4AAAAFgAAACgAAAABAAAAAgAAAAEAAQAAAAAAAAAAAAAAAAAAAAAAAAAA"
      rel="icon"
      type="image/x-icon"
    />
    <link
      href="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAgAAAAIAAQMAAADOtka5AAAAA1BMVEUAAACnej3aAAAANklEQVR42u3BAQEAAACCIP+vbkhAAQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAB8G4IAAAFjdVCkAAAAAElFTkSuQmCC"
      rel="apple-touch-icon"
    />
    <style>
      /*<!--*/
      body {
        color: rgb(25, 25, 25);
        font-family: Verdana, Geneva, sans-serif;
        margin: 0;
      }

      a {
        text-decoration: none;
      }

      a:link,
      a:focus,
      a:hover,
      a:active {
        color: rgb(75, 75, 125);
      }

      a:visited {
        color: rgb(25, 25, 25);
      }

      h1 > a,
      h1 > a:link,
      h1 > a:focus,
      h1 > a:hover,
      h1 > a:active,
      h1 > a:visited,
      h2 > a,
      h2 > a:link,
      h2 > a:focus,
      h2 > a:hover,
      h2 > a:active,
      h2 > a:visited {
        color: rgb(25, 25, 25);
      }

      h1 {
        background-color: rgb(255, 102, 0);
        margin: 0;
        padding: 1rem;
      }

      h2 {
        background-color: rgb(200, 200, 200);
        margin: 1rem 0;
        padding: 0.5rem 0.5rem 0.5rem 1rem;
      }

      #latest > section,
      #archives > section {
        margin: 0 1rem 1rem 1rem;
        padding-bottom: 1rem;
      }

      #latest > section:not(:last-child),
      #archives > section:not(:last-child) {
        border-bottom: 1px dotted rgb(200, 200, 200);
      }

      section > h3 {
        margin: 0 0 0.5rem 0;
      }

      section > h4 {
        font-weight: normal;
        margin: 0 0 0 1rem;
      }

      .descendants-container,
      .points-container {
        align-items: center;
        border-left: 1px solid #333;
        display: inline-flex;
        margin-left: 0.5rem;
        padding-left: 0.5rem;
        text-align: center;
      }

      .points {
        align-items: center;
        display: inline-flex;
        height: 1rem;
        margin-left: 1ch;
        min-width: 3ch;
      }

      .text {
        line-height: 1.5rem;
        margin: 1rem 1rem 0 1rem;
        overflow: auto;
      }

      .text > p:first-child {
        margin-top: 1rem;
      }

      .text > p:last-child {
        margin-bottom: 0;
      }
      /*-->*/
    </style>
  </head>

  <body>
    <main>
      <h1><a href="https://kherrick.github.io/hacker-news/">Hacker News</a></h1>
      <section id="latest">
        <h2>Latest</h2>
        <section id="43663865">
          <h3>
            <a class="item" href="https://vert.sh"
              >Open source and self hostable/private file converter</a
            >
          </h3>
          <section>
            <h4>
              <span>2025-04-12 @ 12:40:13</span
              ><span class="points-container"
                >Points: <span class="points">42</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=43663865"
                  >Comments</a
                ><span class="descendants">: 8</span></span
              >
            </h4>
          </section>
        </section>
        <section id="43663777">
          <h3>
            <a
              class="item"
              href="https://www.theregister.com/2025/04/12/ai_code_suggestions_sabotage_supply_chain/"
              >AI can't stop making up software dependencies and sabotaging
              everything</a
            >
          </h3>
          <section>
            <h4>
              <span>2025-04-12 @ 12:22:35</span
              ><span class="points-container"
                >Points: <span class="points">72</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=43663777"
                  >Comments</a
                ><span class="descendants">: 29</span></span
              >
            </h4>
          </section>
        </section>
        <section id="43663658">
          <h3>
            <a class="item" href="https://www.instantdb.com/hiring/ts-hacker"
              >Instant (YC S22) Is Hiring a Founding TypeScript Engineer</a
            >
          </h3>
          <section>
            <h4>
              <span>2025-04-12 @ 12:00:15</span
              ><span class="points-container"
                >Points: <span class="points">1</span></span
              >
            </h4>
          </section>
        </section>
        <section id="43661680">
          <h3>
            <a
              class="item"
              href="https://data-and-politics.ghost.io/70-million-in-60-seconds-how-insider-information-helped-someone-28x-their-money/"
              >$70M in 60 Seconds: How Insider Info Helped Someone 28x Their
              Money</a
            >
          </h3>
          <section>
            <h4>
              <span>2025-04-12 @ 05:47:10</span
              ><span class="points-container"
                >Points: <span class="points">622</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=43661680"
                  >Comments</a
                ><span class="descendants">: 309</span></span
              >
            </h4>
          </section>
        </section>
        <section id="43661329">
          <h3>
            <a
              class="item"
              href="https://fractalfir.github.io/generated_html/cg_clr_odd_platforms.html"
              >Rust to C compiler â€“ 95.9% test pass rate, odd platforms</a
            >
          </h3>
          <section>
            <h4>
              <span>2025-04-12 @ 04:21:15</span
              ><span class="points-container"
                >Points: <span class="points">191</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=43661329"
                  >Comments</a
                ><span class="descendants">: 91</span></span
              >
            </h4>
          </section>
        </section>
        <section id="43661235">
          <h3>
            <a
              class="item"
              href="https://www.thealgorithmicbridge.com/p/google-is-winning-on-every-ai-front"
              >Google Is Winning on Every AI Front</a
            >
          </h3>
          <section>
            <h4>
              <span>2025-04-12 @ 03:58:50</span
              ><span class="points-container"
                >Points: <span class="points">475</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=43661235"
                  >Comments</a
                ><span class="descendants">: 359</span></span
              >
            </h4>
          </section>
        </section>
        <section id="43659370">
          <h3>
            <a
              class="item"
              href="https://hntrl.io/posts/you-dont-need-websockets/"
              >You might not need WebSockets</a
            >
          </h3>
          <section>
            <h4>
              <span>2025-04-11 @ 22:27:16</span
              ><span class="points-container"
                >Points: <span class="points">307</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=43659370"
                  >Comments</a
                ><span class="descendants">: 199</span></span
              >
            </h4>
          </section>
        </section>
        <section id="43659365">
          <h3>
            <a
              class="item"
              href="https://www.hodinkee.com/articles/introducing-vacheron-constantin-les-cabinotiers-solaria"
              >Vacheron Constantin breaks the world record for most complicated
              wristwatch</a
            >
          </h3>
          <section>
            <h4>
              <span>2025-04-11 @ 22:26:41</span
              ><span class="points-container"
                >Points: <span class="points">235</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=43659365"
                  >Comments</a
                ><span class="descendants">: 218</span></span
              >
            </h4>
          </section>
        </section>
        <section id="43655914">
          <h3>
            <a
              class="item"
              href="https://chrismalek.me/posts/data-star-first-impressions/"
              >Datastar: Web Framework for the Future?</a
            >
          </h3>
          <section>
            <h4>
              <span>2025-04-11 @ 16:53:20</span
              ><span class="points-container"
                >Points: <span class="points">226</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=43655914"
                  >Comments</a
                ><span class="descendants">: 132</span></span
              >
            </h4>
          </section>
        </section>
        <section id="43655603">
          <h3>
            <a
              class="item"
              href="https://www.dropsitenews.com/p/leaked-data-israeli-censorship-meta"
              >Leaked data reveals Israeli govt campaign to remove pro-Palestine
              posts on Meta</a
            >
          </h3>
          <section>
            <h4>
              <span>2025-04-11 @ 16:24:58</span
              ><span class="points-container"
                >Points: <span class="points">964</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=43655603"
                  >Comments</a
                ><span class="descendants">: 632</span></span
              >
            </h4>
          </section>
        </section>
        <section id="43655221">
          <h3>
            <a
              class="item"
              href="https://stevana.github.io/erlangs_not_about_lightweight_processes_and_message_passing.html"
              >Erlang's not about lightweight processes and message passing
              (2023)</a
            >
          </h3>
          <section>
            <h4>
              <span>2025-04-11 @ 15:50:49</span
              ><span class="points-container"
                >Points: <span class="points">274</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=43655221"
                  >Comments</a
                ><span class="descendants">: 148</span></span
              >
            </h4>
          </section>
        </section>
        <section id="43654813">
          <h3>
            <a class="item" href="https://webrtcforthecurious.com"
              >WebRTC for the Curious</a
            >
          </h3>
          <section>
            <h4>
              <span>2025-04-11 @ 15:18:21</span
              ><span class="points-container"
                >Points: <span class="points">162</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=43654813"
                  >Comments</a
                ><span class="descendants">: 31</span></span
              >
            </h4>
          </section>
        </section>
        <section id="43653885">
          <h3>
            <a
              class="item"
              href="https://petapixel.com/2025/04/10/adobe-deletes-bluesky-posts-after-furious-backlash/"
              >Adobe deletes Bluesky posts after backlash</a
            >
          </h3>
          <section>
            <h4>
              <span>2025-04-11 @ 14:01:06</span
              ><span class="points-container"
                >Points: <span class="points">408</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=43653885"
                  >Comments</a
                ><span class="descendants">: 489</span></span
              >
            </h4>
          </section>
        </section>
        <section id="43653672">
          <h3>
            <a class="item" href="https://lwn.net/Articles/1014979/"
              >Fedora change aims for 99% package reproducibility</a
            >
          </h3>
          <section>
            <h4>
              <span>2025-04-11 @ 13:40:26</span
              ><span class="points-container"
                >Points: <span class="points">372</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=43653672"
                  >Comments</a
                ><span class="descendants">: 184</span></span
              >
            </h4>
          </section>
        </section>
        <section id="43653421">
          <h3>
            <a
              class="item"
              href="https://www.theregister.com/2025/04/11/windows_2000_best_microsoft/"
              >Windows 2000 Server named peak Microsoft</a
            >
          </h3>
          <section>
            <h4>
              <span>2025-04-11 @ 13:16:46</span
              ><span class="points-container"
                >Points: <span class="points">177</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=43653421"
                  >Comments</a
                ><span class="descendants">: 238</span></span
              >
            </h4>
          </section>
        </section>
        <section id="43652723">
          <h3>
            <a
              class="item"
              href="https://rakhim.exotext.com/but-what-if-i-really-want-a-faster-horse"
              >But what if I want a faster horse?</a
            >
          </h3>
          <section>
            <h4>
              <span>2025-04-11 @ 11:39:18</span
              ><span class="points-container"
                >Points: <span class="points">1337</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=43652723"
                  >Comments</a
                ><span class="descendants">: 569</span></span
              >
            </h4>
          </section>
        </section>
        <section id="43651532">
          <h3>
            <a
              class="item"
              href="https://neurofrontiers.blog/why-lead-is-still-bad-for-your-brain/"
              >Lead is still bad for your brain</a
            >
          </h3>
          <section>
            <h4>
              <span>2025-04-11 @ 08:15:57</span
              ><span class="points-container"
                >Points: <span class="points">185</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=43651532"
                  >Comments</a
                ><span class="descendants">: 146</span></span
              >
            </h4>
          </section>
        </section>
        <section id="43643467">
          <h3>
            <a
              class="item"
              href="https://www.sciencealert.com/once-lush-sahara-was-home-to-a-surprisingly-unique-group-of-humans"
              >Once lush Sahara was home to a surprisingly unique group of
              humans</a
            >
          </h3>
          <section>
            <h4>
              <span>2025-04-10 @ 13:16:25</span
              ><span class="points-container"
                >Points: <span class="points">116</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=43643467"
                  >Comments</a
                ><span class="descendants">: 22</span></span
              >
            </h4>
          </section>
        </section>
        <section id="43641649">
          <h3>
            <a
              class="item"
              href="https://www.bps.org.uk/research-digest/delusional-themes-may-be-more-varied-we-thought"
              >Delusional themes may be more varied than we thought</a
            >
          </h3>
          <section>
            <h4>
              <span>2025-04-10 @ 07:47:46</span
              ><span class="points-container"
                >Points: <span class="points">8</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=43641649"
                  >Comments</a
                ><span class="descendants">: 2</span></span
              >
            </h4>
          </section>
        </section>
        <section id="43640345">
          <h3>
            <a
              class="item"
              href="https://stonehill-website.s3.amazonaws.com/files/resources/1926-ames-catalog-2.pdf"
              >Ames Shovel and Tool Catalog of Shovels, Spades and Scoops (1926)
              [pdf]</a
            >
          </h3>
          <section>
            <h4>
              <span>2025-04-10 @ 03:31:17</span
              ><span class="points-container"
                >Points: <span class="points">21</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=43640345"
                  >Comments</a
                ><span class="descendants">: 7</span></span
              >
            </h4>
          </section>
        </section>
        <section id="43639253">
          <h3>
            <a
              class="item"
              href="https://www.popularmechanics.com/science/a40008994/why-the-prince-ruperts-drop-is-so-strong/"
              >Why 'Prince Rupert's Drop' Glass Is Strong Enough to Shatter a
              Bullet</a
            >
          </h3>
          <section>
            <h4>
              <span>2025-04-09 @ 23:55:12</span
              ><span class="points-container"
                >Points: <span class="points">35</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=43639253"
                  >Comments</a
                ><span class="descendants">: 12</span></span
              >
            </h4>
          </section>
        </section>
        <section id="43638520">
          <h3>
            <a
              class="item"
              href="https://www.planetary.org/articles/every-picture-from-venus-surface-ever"
              >Every picture from Venus' surface, ever (2021)</a
            >
          </h3>
          <section>
            <h4>
              <span>2025-04-09 @ 22:01:42</span
              ><span class="points-container"
                >Points: <span class="points">61</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=43638520"
                  >Comments</a
                ><span class="descendants">: 9</span></span
              >
            </h4>
          </section>
        </section>
        <section id="43632373">
          <h3>
            <a
              class="item"
              href="https://blog.fxn.ai/python-at-the-speed-of-rust/"
              >Show HN: Python at the Speed of Rust</a
            >
          </h3>
          <section>
            <h4>
              <span>2025-04-09 @ 14:12:09</span
              ><span class="points-container"
                >Points: <span class="points">39</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=43632373"
                  >Comments</a
                ><span class="descendants">: 11</span></span
              >
            </h4>
            <div class="text">
              <p>
                Iâ€™ve been very interested in solving this problem with a great
                developer experience. Over time, I gradually realized that the
                highest-impact thing to have was a way to go from existing
                Python code to a self-contained native binaryâ€”in other words, a
                Python compiler.
              </p>
              <p>
                I was already pretty familiar with a successful attempt: when
                Apple introduced armv8 on the iPhone 5s, they quickly mandated
                64-bit support for all apps. Unityâ€”where I had been programming
                since I was 11â€”kinda got f*cked because they used Mono to run
                developersâ€™ C# code, and Mono didnâ€™t support 64-bit ARM. Unity
                ended up building IL2CPP, which transpiles the C# intermediate
                language into C++, then cross-compiles it. Till date, this is
                perhaps the most amazing technical feat Unity has achieved imo.
              </p>
              <p>
                I set out to build something similar, but this time starting
                from Python. Itâ€™s a pretty difficult problem, given the dynamic
                nature of the language. The key unlock was the PyTorch 2.0
                release, where they pioneered the use of symbolic tracing to
                power `torch.compile`. In a nutshell, they register a callback
                with the Python interpreter (using CPythonâ€™s frame evaluation
                API), run a function with fake inputs, and record an IR graph of
                everything that happened in the function.
              </p>
              <p>
                Once you have an IR graph, you can lower it to C++/Rust code,
                operation-by-operation, by propagating type information
                throughout the program (see the blog post for an example). And
                now is the perfect time to have this infrastructure, because
                LLMs can do all the hard work of writing and validating the
                required operations in native code.
              </p>
              <p>
                Anyway, I wanted to share the proof-of-concept and gather
                feedback. Using Function is pretty simple, just decorate a
                module-level function with `@compile` then use the CLI to
                compile it: `fxn compile module.py` .
              </p>
              <p>TL;DR: Get Rust performance without having to learn Rust ;)</p>
            </div>
          </section>
        </section>
        <section id="43632049">
          <h3>
            <a
              class="item"
              href="https://www.cnbc.com/2025/04/09/google-will-let-companies-run-gemini-models-in-their-own-data-centers.html"
              >Google will let companies run Gemini models in their own data
              centers</a
            >
          </h3>
          <section>
            <h4>
              <span>2025-04-09 @ 13:47:27</span
              ><span class="points-container"
                >Points: <span class="points">188</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=43632049"
                  >Comments</a
                ><span class="descendants">: 55</span></span
              >
            </h4>
          </section>
        </section>
        <section id="43629380">
          <h3>
            <a class="item" href="https://github.com/hanickadot/shorty"
              >C++: terser (shorter) lambda == SHORTY (ab-use?)</a
            >
          </h3>
          <section>
            <h4>
              <span>2025-04-09 @ 06:15:26</span
              ><span class="points-container"
                >Points: <span class="points">26</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=43629380"
                  >Comments</a
                ><span class="descendants">: 11</span></span
              >
            </h4>
          </section>
        </section>
        <section id="43628070">
          <h3>
            <a
              class="item"
              href="https://mssv.net/2025/04/07/a-puzzle-designer-on-blue-prince-a-roguelike-puzzle-masterpiece/"
              >Blue Prince is a roguelike puzzle masterpiece</a
            >
          </h3>
          <section>
            <h4>
              <span>2025-04-09 @ 01:27:48</span
              ><span class="points-container"
                >Points: <span class="points">152</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=43628070"
                  >Comments</a
                ><span class="descendants">: 86</span></span
              >
            </h4>
          </section>
        </section>
        <section id="43626108">
          <h3>
            <a class="item" href="https://obryant.dev/p/yakread-algorithm/"
              >Yakread's Ranking Algorithm</a
            >
          </h3>
          <section>
            <h4>
              <span>2025-04-08 @ 20:27:12</span
              ><span class="points-container"
                >Points: <span class="points">35</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=43626108"
                  >Comments</a
                ><span class="descendants">: 5</span></span
              >
            </h4>
          </section>
        </section>
        <section id="43621378">
          <h3>
            <a
              class="item"
              href="https://arstechnica.com/science/2025/04/researchers-build-a-risc-v-processor-using-a-2d-semiconductor/"
              >A 32-bit processor made with an atomically thin semiconductor</a
            >
          </h3>
          <section>
            <h4>
              <span>2025-04-08 @ 13:08:49</span
              ><span class="points-container"
                >Points: <span class="points">193</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=43621378"
                  >Comments</a
                ><span class="descendants">: 36</span></span
              >
            </h4>
          </section>
        </section>
        <section id="43619032">
          <h3>
            <a
              class="item"
              href="https://www.neelnanda.io/blog/43-making-friends"
              >Intentionally Making Close Friends (2021)</a
            >
          </h3>
          <section>
            <h4>
              <span>2025-04-08 @ 06:54:36</span
              ><span class="points-container"
                >Points: <span class="points">241</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=43619032"
                  >Comments</a
                ><span class="descendants">: 51</span></span
              >
            </h4>
          </section>
        </section>
        <section id="43612835">
          <h3>
            <a
              class="item"
              href="https://www.newscientist.com/article/2474993-bonobos-use-a-kind-of-syntax-once-thought-to-be-unique-to-humans/"
              >Bonobos use a kind of syntax once thought to be unique to
              humans</a
            >
          </h3>
          <section>
            <h4>
              <span>2025-04-07 @ 15:51:21</span
              ><span class="points-container"
                >Points: <span class="points">165</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=43612835"
                  >Comments</a
                ><span class="descendants">: 108</span></span
              >
            </h4>
          </section>
        </section>
      </section>
      <section id="archives">
        <h2>
          <a
            href="https://github.com/kherrick/hacker-news/blob/main/archives/index.md"
            >Archives</a
          >
        </h2>
        <section>
          <h3>
            <a
              href="https://github.com/kherrick/hacker-news/blob/main/archives/2025/index.md"
              >2025</a
            >
          </h3>
        </section>
        <section>
          <h3>
            <a
              href="https://github.com/kherrick/hacker-news/blob/main/archives/2024/index.md"
              >2024</a
            >
          </h3>
        </section>
        <section>
          <h3>
            <a
              href="https://github.com/kherrick/hacker-news/blob/main/archives/2023/index.md"
              >2023</a
            >
          </h3>
        </section>
        <section>
          <h3>
            <a
              href="https://github.com/kherrick/hacker-news/blob/main/archives/2022/index.md"
              >2022</a
            >
          </h3>
        </section>
      </section>
    </main>
    <script type="module">
      import { buildDescendants } from "./lib/build-html-descendants.js";
      import { buildNextItem } from "./lib/build-html-next-item.js";
      import { getNextDateTime } from "./lib/date-time.js";

      const updateSectionById = (id) =>
        fetch(`https://hacker-news.firebaseio.com/v0/item/${id}.json`).then(
          (result) =>
            result.json().then(({ descendants, id, score, text, type }) => {
              const currentItem = document.getElementById(id);

              if (score) {
                currentItem.querySelector(".points").textContent = score;
              }

              if (descendants && (type === "poll" || type === "story")) {
                const currentDescendants =
                  currentItem.querySelector(".descendants");

                if (currentDescendants) {
                  currentDescendants.textContent = `: ${descendants}`;
                } else {
                  const comments = buildDescendants(
                    document,
                    descendants,
                    `https://news.ycombinator.com/item?id=${id}`
                  );

                  currentItem.querySelector("h4").appendChild(comments);
                }
              }

              if (text) {
                const currentText = currentItem.querySelector(".text");

                if (currentText) {
                  currentText.innerHTML = text.replace(/\0/g, "");
                } else {
                  const content = document.createElement("div");
                  content.innerHTML = text.replace(/\0/g, "");
                  content.setAttribute("class", "text");

                  currentItem.appendChild(content);
                }
              }
            })
        );

      class UpdateQueue {
        constructor() {
          this._ids = [];
          this._isUpdating = false;
        }

        addItemById(id) {
          this._ids.push(id);
        }

        async flush() {
          const id = this._ids.shift();

          if (id) {
            this._isUpdating = true;

            await updateSectionById(id);
            await this.flush();
          } else {
            this._isUpdating = false;

            setTimeout(async () => {
              if (!this._isUpdating && this._ids && this._ids.length) {
                await this.flush();
              }
            }, 0);
          }
        }
      }

      // get latest data
      const latestSection = document.getElementById("latest");

      for (let item of latestSection.querySelectorAll("section[id]")) {
        updateSectionById(item.getAttribute("id"));
      }

      if ("IntersectionObserver" in window) {
        window.hackerNewsState = { index: [], nextTimeIndex: -1 };

        const addNewsItem = async (newsItem, queue) => {
          try {
            const { date, time, itemComments, itemTitle, itemLink } = newsItem;
            const section = await buildNextItem({
              document,
              dateTime: `${date}, ${time}`,
              itemComments,
              itemLink,
              itemTitle: new DOMParser().parseFromString(
                itemTitle.replace(/\\/g, ""),
                "text/html"
              ).documentElement.textContent,
              fetchItemDetails: false,
            });

            // display loading indicator for section
            section.querySelector(".points-container").innerHTML =
              'Points: <span class="points"><img style="height: 100%;" src="lib/images/loading.svg" /></span>';

            const id = section.getAttribute("id");
            if (!document.getElementById(id)) {
              document.getElementById("latest").appendChild(section);

              queue.addItemById(id);
            }
          } catch (error) {}
        };

        const buildArchiveIndex = async (lastDateTime) => {
          const nextDate = lastDateTime.slice(0, 10);
          const nextYear = nextDate.slice(0, 4);

          return (
            await (
              await fetch(
                `https://raw.githubusercontent.com/kherrick/hacker-news/main/archives/${nextYear}/${nextDate}/index.md`
              )
            ).text()
          )
            .split("\n")
            .filter((line) => line.match(new RegExp("^\\* \\[")))
            .map((line) => {
              const segment = line.replace("* ", "").split("](");
              const pubDate = segment[0].slice(1);

              const itemComments = segment[1].split(") - [")[0];
              const itemTitle = segment[1].split(") - [")[1];
              const itemLink = segment[2].slice(0, -1);
              const date = pubDate.slice(0, 10);
              const time = pubDate.slice(-8);

              return {
                date,
                itemComments,
                itemLink,
                itemTitle,
                time,
              };
            });
        };

        const handleIntersectingEntry = async (entry, queue) => {
          if (entry.isIntersecting) {
            const lastDateTime = document
              .getElementById("latest")
              .querySelector(
                "section:last-child > section > h4 > span"
              ).textContent;

            const nextDateTime = getNextDateTime(lastDateTime ?? "", -1);
            const archiveIndex = await buildArchiveIndex(nextDateTime);
            const nextTimeIndex = archiveIndex.findIndex(
              ({ time }) => time === nextDateTime.slice(-8)
            );

            const handleIndexUpdate = (index, existingIndexValues = []) => {
              index.forEach((i) => {
                existingIndexValues.push(i);
              });
              return existingIndexValues;
            };

            window.hackerNewsState = {
              index: handleIndexUpdate(
                archiveIndex,
                window.hackerNewsState.index
              ),
              nextTimeIndex,
            };

            let currentTimeIndex = nextTimeIndex + 1;
            const items = Object.values(window.hackerNewsState.index);
            for (let item of items) {
              if (currentTimeIndex < window.hackerNewsState.index.length) {
                addNewsItem(items[currentTimeIndex], queue);

                currentTimeIndex = currentTimeIndex + 1;
              }
            }

            queue.flush();
          }
        };

        const archives = document.getElementById("archives");
        const archivesObserver = new IntersectionObserver(
          (entries) => {
            const queue = new UpdateQueue();

            entries.forEach((entry) => handleIntersectingEntry(entry, queue));
          },
          {
            root: null,
            rootMargin: "0px",
            threshold: 0,
          }
        );

        archivesObserver.observe(archives);

        let latestSectionsExpanded = true;
        const handleLatestHeaderClick = () => {
          latestSectionsExpanded = !latestSectionsExpanded;

          if (latestSectionsExpanded) {
            archivesObserver.observe(archives);
          } else {
            archivesObserver.disconnect(archives);
          }

          for (let section of document.querySelectorAll("#latest > section")) {
            section.style.display = latestSectionsExpanded ? "block" : "none";
          }
        };

        const latestHeader = document.querySelector("#latest > h2");
        latestHeader.style.cursor = "pointer";
        latestHeader.addEventListener("click", handleLatestHeaderClick);
      }
    </script>
    <script type="module">
      import { Workbox } from "https://storage.googleapis.com/workbox-cdn/releases/6.4.1/workbox-window.prod.mjs";

      if ("serviceWorker" in navigator) {
        const base = document.querySelector("base");
        const serviceWorkerPath = `${
          base ? base.href.replace(/\/$/, "") : ""
        }/service-worker.js`;

        const wb = new Workbox(serviceWorkerPath);

        // setup event listeners
        wb.addEventListener("waiting", (event) => {
          wb.addEventListener("controlling", () => {
            window.location.reload();
          });

          wb.messageSkipWaiting();
        });

        wb.register();
      }
    </script>
  </body>
</html>
