<!DOCTYPE html>
<html lang="en" xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta charset="utf-8" />
    <meta
      content="width=device-width, initial-scale=1.0, viewport-fit=cover"
      name="viewport"
    />
    <meta name="description" content="Hacker News" />
    <meta name="theme-color" content="#fff" />
    <title>Hacker News</title>
    <link rel="manifest" href="manifest.json" />
    <link
      href="data:image/x-icon;base64,AAABAAEAAQECAAEAAQA4AAAAFgAAACgAAAABAAAAAgAAAAEAAQAAAAAAAAAAAAAAAAAAAAAAAAAAAAABAAEAAQECAAEAAQA4AAAAFgAAACgAAAABAAAAAgAAAAEAAQAAAAAAAAAAAAAAAAAAAAAAAAAA"
      rel="icon"
      type="image/x-icon"
    />
    <link
      href="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAgAAAAIAAQMAAADOtka5AAAAA1BMVEUAAACnej3aAAAANklEQVR42u3BAQEAAACCIP+vbkhAAQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAB8G4IAAAFjdVCkAAAAAElFTkSuQmCC"
      rel="apple-touch-icon"
    />
    <style>
      /*<!--*/
      body {
        color: rgb(25, 25, 25);
        font-family: Verdana, Geneva, sans-serif;
        margin: 0;
      }

      a {
        text-decoration: none;
      }

      a:link,
      a:focus,
      a:hover,
      a:active {
        color: rgb(75, 75, 125);
      }

      a:visited {
        color: rgb(25, 25, 25);
      }

      h1 > a,
      h1 > a:link,
      h1 > a:focus,
      h1 > a:hover,
      h1 > a:active,
      h1 > a:visited,
      h2 > a,
      h2 > a:link,
      h2 > a:focus,
      h2 > a:hover,
      h2 > a:active,
      h2 > a:visited {
        color: rgb(25, 25, 25);
      }

      h1 {
        background-color: rgb(255, 102, 0);
        margin: 0;
        padding: 1rem;
      }

      h2 {
        background-color: rgb(200, 200, 200);
        margin: 1rem 0;
        padding: 0.5rem 0.5rem 0.5rem 1rem;
      }

      #latest > section,
      #archives > section {
        margin: 0 1rem 1rem 1rem;
        padding-bottom: 1rem;
      }

      #latest > section:not(:last-child),
      #archives > section:not(:last-child) {
        border-bottom: 1px dotted rgb(200, 200, 200);
      }

      section > h3 {
        margin: 0 0 0.5rem 0;
      }

      section > h4 {
        font-weight: normal;
        margin: 0 0 0 1rem;
      }

      .descendants-container,
      .points-container {
        align-items: center;
        border-left: 1px solid #333;
        display: inline-flex;
        margin-left: 0.5rem;
        padding-left: 0.5rem;
        text-align: center;
      }

      .points {
        align-items: center;
        display: inline-flex;
        height: 1rem;
        margin-left: 1ch;
        min-width: 3ch;
      }

      .text {
        line-height: 1.5rem;
        margin: 1rem 1rem 0 1rem;
        overflow: auto;
      }

      .text > p:first-child {
        margin-top: 1rem;
      }

      .text > p:last-child {
        margin-bottom: 0;
      }
      /*-->*/
    </style>
  </head>

  <body>
    <main>
      <h1><a href="https://kherrick.github.io/hacker-news/">Hacker News</a></h1>
      <section id="latest">
        <h2>Latest</h2>
        <section id="38604519">
          <h3>
            <a
              class="item"
              href="https://twitter.com/fabianstelzer/status/1734296159873536214"
              >GPT-4 has Seasonal Depression</a
            >
          </h3>
          <section>
            <h4>
              <span>2023-12-11 @ 19:45:23</span
              ><span class="points-container"
                >Points: <span class="points">88</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=38604519"
                  >Comments</a
                ><span class="descendants">: 25</span></span
              >
            </h4>
          </section>
        </section>
        <section id="38604470">
          <h3>
            <a class="item" href="https://www.fntastic.com"
              >Fntastic announces shutdown four days after releasing "The Day
              Before"</a
            >
          </h3>
          <section>
            <h4>
              <span>2023-12-11 @ 19:42:02</span
              ><span class="points-container"
                >Points: <span class="points">44</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=38604470"
                  >Comments</a
                ><span class="descendants">: 40</span></span
              >
            </h4>
          </section>
        </section>
        <section id="38603853">
          <h3>
            <a class="item" href="https://github.com/bricks-cloud/BricksLLM"
              >Show HN: I built an OSS alternative to Azure OpenAI services</a
            >
          </h3>
          <section>
            <h4>
              <span>2023-12-11 @ 18:56:23</span
              ><span class="points-container"
                >Points: <span class="points">45</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=38603853"
                  >Comments</a
                ><span class="descendants">: 18</span></span
              >
            </h4>
            <div class="text">
              <p>
                Azure OpenAI services was born out of companies needing enhanced
                security and access control for using different GPT models. I
                want to build an OSS version of Azure OpenAI services that
                people could self host in their own infrastructure.
              </p>
              <p>"How can I track LLM spend per API key?"</p>
              <p>
                "Can I create a development OpenAI API key with limited access
                for Bob?"
              </p>
              <p>"Can I see my LLM spend breakdown by models and endpoints?"</p>
              <p>
                "Can I create 100 OpenAI API keys that my students could use in
                a classroom setting?"
              </p>
              <p>These are questions that BricksLLM helps you answer.</p>
              <p>
                BricksLLM is an API gateway that let you create API keys with
                rate limit, cost control and ttl that could be used to access
                all OpenAI and Anthropic endpoints with out of box analytics.
              </p>
              <p>
                When I first started building with OpenAI APIs, I was constantly
                worried about API keys being comprised since vanilla OpenAI API
                keys would grant you unlimited access to all of their models.
                There are stories of people losing thousands of dollars and the
                existence of a black market for stolen OpenAI API keys.
              </p>
              <p>
                This is why I started building a proxy for ourselves that allows
                for the creation of API keys with rate limits and cost controls.
                I built BricksLLM in Go since that was the language I used to
                build performative ads exchanges that scaled to thousands of
                requests per second at my previous job. A lot of developer tools
                in LLM ops are built with Python which I believe might be
                suboptimal in terms of performance and compute resource
                efficiency.
              </p>
              <p>
                One of the challenges building this platform is to get accurate
                token counts for different OpenAI and Anthropic models. LLM
                providers are not exactly transparent with the way how they
                count prompt and completion tokens. In addition to user input,
                OpenAI and Anthropic pad prompt inputs with additional
                instructions or phrases that contribute to the final token
                counts. For example, Anthropic's actual completion token
                consumption is consistently 4 more than the token count of the
                completion output.
              </p>
              <p>
                The latency of the gateway hovers around 50ms. Half of the
                latency comes from the tokenizer. If I start utilizing Go
                routines, might be able to lower the latency of the gateway to
                30ms.
              </p>
              <p>
                BricksLLM is not an observability platform, but we do provide
                integration with Datadog so you can get more insights regarding
                what is going on inside the proxy. Compared to other tools in
                the LLMOps space, I believe that BricksLLM has the most
                comprehensive features when it comes to access control.
              </p>
              <p>Let me know what you guys think.</p>
            </div>
          </section>
        </section>
        <section id="38603207">
          <h3>
            <a
              class="item"
              href="https://www.cerebras.net/blog/introducing-gigagpt-gpt-3-sized-models-in-565-lines-of-code"
              >GigaGPT: GPT-3 sized models in 565 lines of code</a
            >
          </h3>
          <section>
            <h4>
              <span>2023-12-11 @ 18:13:28</span
              ><span class="points-container"
                >Points: <span class="points">174</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=38603207"
                  >Comments</a
                ><span class="descendants">: 53</span></span
              >
            </h4>
          </section>
        </section>
        <section id="38603193">
          <h3>
            <a class="item" href="http://sizeof.cat/post/web-browser-telemetry/"
              >Web Browser Telemetry</a
            >
          </h3>
          <section>
            <h4>
              <span>2023-12-11 @ 18:12:22</span
              ><span class="points-container"
                >Points: <span class="points">51</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=38603193"
                  >Comments</a
                ><span class="descendants">: 35</span></span
              >
            </h4>
          </section>
        </section>
        <section id="38603014">
          <h3>
            <a class="item" href="https://walt-video-diffusion.github.io/"
              >Photorealistic Video Generation with Diffusion Models</a
            >
          </h3>
          <section>
            <h4>
              <span>2023-12-11 @ 18:00:07</span
              ><span class="points-container"
                >Points: <span class="points">103</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=38603014"
                  >Comments</a
                ><span class="descendants">: 29</span></span
              >
            </h4>
          </section>
        </section>
        <section id="38602575">
          <h3>
            <a class="item" href="https://blog.beeper.com/p/beeper-mini-is-back"
              >Beeper Mini is back</a
            >
          </h3>
          <section>
            <h4>
              <span>2023-12-11 @ 17:30:14</span
              ><span class="points-container"
                >Points: <span class="points">603</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=38602575"
                  >Comments</a
                ><span class="descendants">: 758</span></span
              >
            </h4>
          </section>
        </section>
        <section id="38602281">
          <h3>
            <a class="item" href="https://patterns.app/"
              >Patterns (YC S21) is hiring to automate analytics with LLMs</a
            >
          </h3>
          <section>
            <h4>
              <span>2023-12-11 @ 17:00:41</span
              ><span class="points-container"
                >Points: <span class="points">1</span></span
              >
            </h4>
          </section>
        </section>
        <section id="38602228">
          <h3>
            <a
              class="item"
              href="https://www.atlasobscura.com/articles/herds-of-glacier-mice-baffle-scientists"
              >'Glacier mice' baffle scientists</a
            >
          </h3>
          <section>
            <h4>
              <span>2023-12-11 @ 16:53:58</span
              ><span class="points-container"
                >Points: <span class="points">56</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=38602228"
                  >Comments</a
                ><span class="descendants">: 12</span></span
              >
            </h4>
          </section>
        </section>
        <section id="38601435">
          <h3>
            <a
              class="item"
              href="https://cdacamar.github.io/data%20structures/algorithms/benchmarking/text%20editors/c++/rethinking-undo/"
              >Text Editor Data Structures: Rethinking Undo</a
            >
          </h3>
          <section>
            <h4>
              <span>2023-12-11 @ 15:27:42</span
              ><span class="points-container"
                >Points: <span class="points">63</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=38601435"
                  >Comments</a
                ><span class="descendants">: 14</span></span
              >
            </h4>
          </section>
        </section>
        <section id="38600743">
          <h3>
            <a class="item" href="https://github.com/maxpert/marmot"
              >Marmot: Multi-writer distributed SQLite based on NATS</a
            >
          </h3>
          <section>
            <h4>
              <span>2023-12-11 @ 14:09:02</span
              ><span class="points-container"
                >Points: <span class="points">91</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=38600743"
                  >Comments</a
                ><span class="descendants">: 29</span></span
              >
            </h4>
          </section>
        </section>
        <section id="38600031">
          <h3>
            <a
              class="item"
              href="https://arstechnica.com/science/2023/12/why-scientists-are-making-transparent-wood/"
              >Transparent wood could soon find uses in smartphone screens,
              insulated windows</a
            >
          </h3>
          <section>
            <h4>
              <span>2023-12-11 @ 12:31:00</span
              ><span class="points-container"
                >Points: <span class="points">105</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=38600031"
                  >Comments</a
                ><span class="descendants">: 83</span></span
              >
            </h4>
          </section>
        </section>
        <section id="38599270">
          <h3>
            <a class="item" href="https://smart.tohands.in/"
              >Tohands – Smart calculator for small businesses</a
            >
          </h3>
          <section>
            <h4>
              <span>2023-12-11 @ 10:27:03</span
              ><span class="points-container"
                >Points: <span class="points">226</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=38599270"
                  >Comments</a
                ><span class="descendants">: 73</span></span
              >
            </h4>
          </section>
        </section>
        <section id="38599168">
          <h3>
            <a
              class="item"
              href="https://orlp.net/blog/magical-fibonacci-formulae/"
              >Magical Fibonacci Formulae</a
            >
          </h3>
          <section>
            <h4>
              <span>2023-12-11 @ 10:05:58</span
              ><span class="points-container"
                >Points: <span class="points">115</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=38599168"
                  >Comments</a
                ><span class="descendants">: 17</span></span
              >
            </h4>
          </section>
        </section>
        <section id="38599027">
          <h3>
            <a
              class="item"
              href="https://migeel.sk/blog/2023/12/08/building-bare-metal-bootable-game-for-raspberry-pi-in-csharp/"
              >Building a bare-metal bootable game for Raspberry Pi in C#</a
            >
          </h3>
          <section>
            <h4>
              <span>2023-12-11 @ 09:35:23</span
              ><span class="points-container"
                >Points: <span class="points">154</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=38599027"
                  >Comments</a
                ><span class="descendants">: 76</span></span
              >
            </h4>
          </section>
        </section>
        <section id="38598861">
          <h3>
            <a
              class="item"
              href="https://www.jedec.org/news/pressreleases/jedec-publishes-new-camm2-memory-module-standard"
              >Jedec Publishes New CAMM2 Memory Module Standard</a
            >
          </h3>
          <section>
            <h4>
              <span>2023-12-11 @ 09:03:26</span
              ><span class="points-container"
                >Points: <span class="points">83</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=38598861"
                  >Comments</a
                ><span class="descendants">: 23</span></span
              >
            </h4>
          </section>
        </section>
        <section id="38598742">
          <h3>
            <a
              class="item"
              href="https://www.archaeology.org/issues/537-features/top10/11937-zambia-kalambo-river-earliest-woodworking"
              >Earliest Carpenters: 476k-year-old log structure discovered in
              Zambia</a
            >
          </h3>
          <section>
            <h4>
              <span>2023-12-11 @ 08:40:30</span
              ><span class="points-container"
                >Points: <span class="points">154</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=38598742"
                  >Comments</a
                ><span class="descendants">: 96</span></span
              >
            </h4>
          </section>
        </section>
        <section id="38598568">
          <h3>
            <a class="item" href="https://mistral.ai/news/la-plateforme/"
              >Mistral: Our first AI endpoints are available in early access</a
            >
          </h3>
          <section>
            <h4>
              <span>2023-12-11 @ 08:03:06</span
              ><span class="points-container"
                >Points: <span class="points">403</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=38598568"
                  >Comments</a
                ><span class="descendants">: 112</span></span
              >
            </h4>
          </section>
        </section>
        <section id="38598559">
          <h3>
            <a class="item" href="https://mistral.ai/news/mixtral-of-experts/"
              >Mistral: Mixtral of Experts</a
            >
          </h3>
          <section>
            <h4>
              <span>2023-12-11 @ 08:01:29</span
              ><span class="points-container"
                >Points: <span class="points">586</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=38598559"
                  >Comments</a
                ><span class="descendants">: 270</span></span
              >
            </h4>
          </section>
        </section>
        <section id="38598325">
          <h3>
            <a
              class="item"
              href="https://www.mistys-internet.website/blog/blog/2023/12/10/fixing-classical-cats-or/"
              >Fixing Classical Cats: How I Got Tricked by 28-Year-Old Defensive
              Programming</a
            >
          </h3>
          <section>
            <h4>
              <span>2023-12-11 @ 07:09:02</span
              ><span class="points-container"
                >Points: <span class="points">142</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=38598325"
                  >Comments</a
                ><span class="descendants">: 36</span></span
              >
            </h4>
          </section>
        </section>
        <section id="38597992">
          <h3>
            <a class="item" href="https://en.wikipedia.org/wiki/Eleanor_cross"
              >Eleanor Cross</a
            >
          </h3>
          <section>
            <h4>
              <span>2023-12-11 @ 05:47:17</span
              ><span class="points-container"
                >Points: <span class="points">36</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=38597992"
                  >Comments</a
                ><span class="descendants">: 13</span></span
              >
            </h4>
          </section>
        </section>
        <section id="38595140">
          <h3>
            <a
              class="item"
              href="https://publicdomainreview.org/collection/recueil-de-la-diversite-des-habits/"
              >The First Costume Book: 1562</a
            >
          </h3>
          <section>
            <h4>
              <span>2023-12-10 @ 21:16:09</span
              ><span class="points-container"
                >Points: <span class="points">5</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=38595140"
                  >Comments</a
                ><span class="descendants">: 1</span></span
              >
            </h4>
          </section>
        </section>
        <section id="38592662">
          <h3>
            <a
              class="item"
              href="https://www.nytimes.com/2023/12/10/science/mathematics-tiling-einstein.html"
              >What can you do with an Einstein?</a
            >
          </h3>
          <section>
            <h4>
              <span>2023-12-10 @ 16:28:44</span
              ><span class="points-container"
                >Points: <span class="points">7</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=38592662"
                  >Comments</a
                ><span class="descendants">: 2</span></span
              >
            </h4>
          </section>
        </section>
        <section id="38592432">
          <h3>
            <a
              class="item"
              href="https://literaryreview.co.uk/he-steals-them-of-course"
              >He steals them, of course</a
            >
          </h3>
          <section>
            <h4>
              <span>2023-12-10 @ 16:02:04</span
              ><span class="points-container"
                >Points: <span class="points">74</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=38592432"
                  >Comments</a
                ><span class="descendants">: 9</span></span
              >
            </h4>
          </section>
        </section>
        <section id="38591581">
          <h3>
            <a
              class="item"
              href="http://woodblock.com/surimono/atgallery01.html"
              >On Limited Editions (1998)</a
            >
          </h3>
          <section>
            <h4>
              <span>2023-12-10 @ 14:05:56</span
              ><span class="points-container"
                >Points: <span class="points">35</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=38591581"
                  >Comments</a
                ><span class="descendants">: 9</span></span
              >
            </h4>
          </section>
        </section>
        <section id="38591084">
          <h3>
            <a class="item" href="https://ciechanow.ski/mechanical-watch/"
              >Mechanical Watch (2022)</a
            >
          </h3>
          <section>
            <h4>
              <span>2023-12-10 @ 12:28:49</span
              ><span class="points-container"
                >Points: <span class="points">640</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=38591084"
                  >Comments</a
                ><span class="descendants">: 111</span></span
              >
            </h4>
          </section>
        </section>
        <section id="38591083">
          <h3>
            <a
              class="item"
              href="https://codeconfessions.substack.com/p/cpython-dynamic-dispatch-internals"
              >How many lines of C it takes to execute a + b in Python</a
            >
          </h3>
          <section>
            <h4>
              <span>2023-12-10 @ 12:28:17</span
              ><span class="points-container"
                >Points: <span class="points">239</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=38591083"
                  >Comments</a
                ><span class="descendants">: 136</span></span
              >
            </h4>
          </section>
        </section>
        <section id="38590786">
          <h3>
            <a class="item" href="http://cowlark.com/cowgol/index.html"
              >Cowgol 2.0 (2022)</a
            >
          </h3>
          <section>
            <h4>
              <span>2023-12-10 @ 11:15:08</span
              ><span class="points-container"
                >Points: <span class="points">19</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=38590786"
                  >Comments</a
                ><span class="descendants">: 4</span></span
              >
            </h4>
          </section>
        </section>
        <section id="38590156">
          <h3>
            <a
              class="item"
              href="https://www.quantamagazine.org/after-nearly-a-century-a-new-limit-for-patterns-in-graphs-20230502/"
              >Mathematicians have found a new upper limit to the Ramsey
              number</a
            >
          </h3>
          <section>
            <h4>
              <span>2023-12-10 @ 08:46:15</span
              ><span class="points-container"
                >Points: <span class="points">180</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=38590156"
                  >Comments</a
                ><span class="descendants">: 34</span></span
              >
            </h4>
          </section>
        </section>
        <section id="38589764">
          <h3>
            <a
              class="item"
              href="https://blog.owulveryck.info/2023/12/02/simplifying-complexity-the-journey-from-websockets-to-http-streams.html"
              >Capturing gestures: from Linux' EVDev to the browser</a
            >
          </h3>
          <section>
            <h4>
              <span>2023-12-10 @ 07:16:33</span
              ><span class="points-container"
                >Points: <span class="points">23</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=38589764"
                  >Comments</a
                ><span class="descendants">: 3</span></span
              >
            </h4>
          </section>
        </section>
      </section>
      <section id="archives">
        <h2>
          <a
            href="https://github.com/kherrick/hacker-news/blob/main/archives/index.md"
            >Archives</a
          >
        </h2>
        <section>
          <h3>
            <a
              href="https://github.com/kherrick/hacker-news/blob/main/archives/2023/index.md"
              >2023</a
            >
          </h3>
        </section>
        <section>
          <h3>
            <a
              href="https://github.com/kherrick/hacker-news/blob/main/archives/2022/index.md"
              >2022</a
            >
          </h3>
        </section>
      </section>
    </main>
    <script type="module">
      import { buildDescendants } from "./lib/build-html-descendants.js";
      import { buildNextItem } from "./lib/build-html-next-item.js";
      import { getNextDateTime } from "./lib/date-time.js";

      const updateSectionById = (id) =>
        fetch(`https://hacker-news.firebaseio.com/v0/item/${id}.json`).then(
          (result) =>
            result.json().then(({ descendants, id, score, text, type }) => {
              const currentItem = document.getElementById(id);

              if (score) {
                currentItem.querySelector(".points").textContent = score;
              }

              if (descendants && (type === "poll" || type === "story")) {
                const currentDescendants =
                  currentItem.querySelector(".descendants");

                if (currentDescendants) {
                  currentDescendants.textContent = `: ${descendants}`;
                } else {
                  const comments = buildDescendants(
                    document,
                    descendants,
                    `https://news.ycombinator.com/item?id=${id}`
                  );

                  currentItem.querySelector("h4").appendChild(comments);
                }
              }

              if (text) {
                const currentText = currentItem.querySelector(".text");

                if (currentText) {
                  currentText.innerHTML = text.replace(/\0/g, "");
                } else {
                  const content = document.createElement("div");
                  content.innerHTML = text.replace(/\0/g, "");
                  content.setAttribute("class", "text");

                  currentItem.appendChild(content);
                }
              }
            })
        );

      class UpdateQueue {
        constructor() {
          this._ids = [];
          this._isUpdating = false;
        }

        addItemById(id) {
          this._ids.push(id);
        }

        async flush() {
          const id = this._ids.shift();

          if (id) {
            this._isUpdating = true;

            await updateSectionById(id);
            await this.flush();
          } else {
            this._isUpdating = false;

            setTimeout(async () => {
              if (!this._isUpdating && this._ids && this._ids.length) {
                await this.flush();
              }
            }, 0);
          }
        }
      }

      // get latest data
      const latestSection = document.getElementById("latest");

      for (let item of latestSection.querySelectorAll("section[id]")) {
        updateSectionById(item.getAttribute("id"));
      }

      if ("IntersectionObserver" in window) {
        window.hackerNewsState = { index: [], nextTimeIndex: -1 };

        const addNewsItem = async (newsItem, queue) => {
          try {
            const { date, time, itemComments, itemTitle, itemLink } = newsItem;
            const section = await buildNextItem({
              document,
              dateTime: `${date}, ${time}`,
              itemComments,
              itemLink,
              itemTitle: new DOMParser().parseFromString(
                itemTitle.replace(/\\/g, ""),
                "text/html"
              ).documentElement.textContent,
              fetchItemDetails: false,
            });

            // display loading indicator for section
            section.querySelector(".points-container").innerHTML =
              'Points: <span class="points"><img style="height: 100%;" src="lib/images/loading.svg" /></span>';

            const id = section.getAttribute("id");
            if (!document.getElementById(id)) {
              document.getElementById("latest").appendChild(section);

              queue.addItemById(id);
            }
          } catch (error) {}
        };

        const buildArchiveIndex = async (lastDateTime) => {
          const nextDate = lastDateTime.slice(0, 10);
          const nextYear = nextDate.slice(0, 4);

          return (
            await (
              await fetch(
                `https://raw.githubusercontent.com/kherrick/hacker-news/main/archives/${nextYear}/${nextDate}/index.md`
              )
            ).text()
          )
            .split("\n")
            .filter((line) => line.match(new RegExp("^\\* \\[")))
            .map((line) => {
              const segment = line.replace("* ", "").split("](");
              const pubDate = segment[0].slice(1);

              const itemComments = segment[1].split(") - [")[0];
              const itemTitle = segment[1].split(") - [")[1];
              const itemLink = segment[2].slice(0, -1);
              const date = pubDate.slice(0, 10);
              const time = pubDate.slice(-8);

              return {
                date,
                itemComments,
                itemLink,
                itemTitle,
                time,
              };
            });
        };

        const handleIntersectingEntry = async (entry, queue) => {
          if (entry.isIntersecting) {
            const lastDateTime = document
              .getElementById("latest")
              .querySelector(
                "section:last-child > section > h4 > span"
              ).textContent;

            const nextDateTime = getNextDateTime(lastDateTime ?? "", -1);
            const archiveIndex = await buildArchiveIndex(nextDateTime);
            const nextTimeIndex = archiveIndex.findIndex(
              ({ time }) => time === nextDateTime.slice(-8)
            );

            const handleIndexUpdate = (index, existingIndexValues = []) => {
              index.forEach((i) => {
                existingIndexValues.push(i);
              });
              return existingIndexValues;
            };

            window.hackerNewsState = {
              index: handleIndexUpdate(
                archiveIndex,
                window.hackerNewsState.index
              ),
              nextTimeIndex,
            };

            let currentTimeIndex = nextTimeIndex + 1;
            const items = Object.values(window.hackerNewsState.index);
            for (let item of items) {
              if (currentTimeIndex < window.hackerNewsState.index.length) {
                addNewsItem(items[currentTimeIndex], queue);

                currentTimeIndex = currentTimeIndex + 1;
              }
            }

            queue.flush();
          }
        };

        const archives = document.getElementById("archives");
        const archivesObserver = new IntersectionObserver(
          (entries) => {
            const queue = new UpdateQueue();

            entries.forEach((entry) => handleIntersectingEntry(entry, queue));
          },
          {
            root: null,
            rootMargin: "0px",
            threshold: 0,
          }
        );

        archivesObserver.observe(archives);

        let latestSectionsExpanded = true;
        const handleLatestHeaderClick = () => {
          latestSectionsExpanded = !latestSectionsExpanded;

          if (latestSectionsExpanded) {
            archivesObserver.observe(archives);
          } else {
            archivesObserver.disconnect(archives);
          }

          for (let section of document.querySelectorAll("#latest > section")) {
            section.style.display = latestSectionsExpanded ? "block" : "none";
          }
        };

        const latestHeader = document.querySelector("#latest > h2");
        latestHeader.style.cursor = "pointer";
        latestHeader.addEventListener("click", handleLatestHeaderClick);
      }
    </script>
    <script type="module">
      import { Workbox } from "https://storage.googleapis.com/workbox-cdn/releases/6.4.1/workbox-window.prod.mjs";

      if ("serviceWorker" in navigator) {
        const base = document.querySelector("base");
        const serviceWorkerPath = `${
          base ? base.href.replace(/\/$/, "") : ""
        }/service-worker.js`;

        const wb = new Workbox(serviceWorkerPath);

        // setup event listeners
        wb.addEventListener("waiting", (event) => {
          wb.addEventListener("controlling", () => {
            window.location.reload();
          });

          wb.messageSkipWaiting();
        });

        wb.register();
      }
    </script>
  </body>
</html>
