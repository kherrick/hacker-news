<!DOCTYPE html>
<html lang="en" xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta charset="utf-8" />
    <meta
      content="width=device-width, initial-scale=1.0, viewport-fit=cover"
      name="viewport"
    />
    <meta name="description" content="Hacker News" />
    <meta name="theme-color" content="#fff" />
    <title>Hacker News</title>
    <link rel="manifest" href="manifest.json" />
    <link
      href="data:image/x-icon;base64,AAABAAEAAQECAAEAAQA4AAAAFgAAACgAAAABAAAAAgAAAAEAAQAAAAAAAAAAAAAAAAAAAAAAAAAAAAABAAEAAQECAAEAAQA4AAAAFgAAACgAAAABAAAAAgAAAAEAAQAAAAAAAAAAAAAAAAAAAAAAAAAA"
      rel="icon"
      type="image/x-icon"
    />
    <link
      href="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAgAAAAIAAQMAAADOtka5AAAAA1BMVEUAAACnej3aAAAANklEQVR42u3BAQEAAACCIP+vbkhAAQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAB8G4IAAAFjdVCkAAAAAElFTkSuQmCC"
      rel="apple-touch-icon"
    />
    <style>
      /*<!--*/
      body {
        color: rgb(25, 25, 25);
        font-family: Verdana, Geneva, sans-serif;
        margin: 0;
      }

      a {
        text-decoration: none;
      }

      a:link,
      a:focus,
      a:hover,
      a:active {
        color: rgb(75, 75, 125);
      }

      a:visited {
        color: rgb(25, 25, 25);
      }

      h1 > a,
      h1 > a:link,
      h1 > a:focus,
      h1 > a:hover,
      h1 > a:active,
      h1 > a:visited,
      h2 > a,
      h2 > a:link,
      h2 > a:focus,
      h2 > a:hover,
      h2 > a:active,
      h2 > a:visited {
        color: rgb(25, 25, 25);
      }

      h1 {
        background-color: rgb(255, 102, 0);
        margin: 0;
        padding: 1rem;
      }

      h2 {
        background-color: rgb(200, 200, 200);
        margin: 1rem 0;
        padding: 0.5rem 0.5rem 0.5rem 1rem;
      }

      #latest > section,
      #archives > section {
        margin: 0 1rem 1rem 1rem;
        padding-bottom: 1rem;
      }

      #latest > section:not(:last-child),
      #archives > section:not(:last-child) {
        border-bottom: 1px dotted rgb(200, 200, 200);
      }

      section > h3 {
        margin: 0 0 0.5rem 0;
      }

      section > h4 {
        font-weight: normal;
        margin: 0 0 0 1rem;
      }

      .descendants-container,
      .points-container {
        align-items: center;
        border-left: 1px solid #333;
        display: inline-flex;
        margin-left: 0.5rem;
        padding-left: 0.5rem;
        text-align: center;
      }

      .points {
        align-items: center;
        display: inline-flex;
        height: 1rem;
        margin-left: 1ch;
        min-width: 3ch;
      }

      .text {
        line-height: 1.5rem;
        margin: 1rem 1rem 0 1rem;
        overflow: auto;
      }

      .text > p:first-child {
        margin-top: 1rem;
      }

      .text > p:last-child {
        margin-bottom: 0;
      }
      /*-->*/
    </style>
  </head>

  <body>
    <main>
      <h1><a href="https://kherrick.github.io/hacker-news/">Hacker News</a></h1>
      <section id="latest">
        <h2>Latest</h2>
        <section id="44136108">
          <h3>
            <a
              class="item"
              href="https://biggo.com/news/202505261334_MinIO_Removes_Web_UI_Features"
              >MinIO Removes Web UI Features from Community Version, Pushes
              Users to Paid Plans</a
            >
          </h3>
          <section>
            <h4>
              <span>2025-05-30 @ 13:37:17</span
              ><span class="points-container"
                >Points: <span class="points">48</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=44136108"
                  >Comments</a
                ><span class="descendants">: 11</span></span
              >
            </h4>
          </section>
        </section>
        <section id="44135738">
          <h3>
            <a
              class="item"
              href="https://github.com/cwarden/git-add-interactive"
              >Show HN: Git-Add–Interactive with Enhancements</a
            >
          </h3>
          <section>
            <h4>
              <span>2025-05-30 @ 12:54:55</span
              ><span class="points-container"
                >Points: <span class="points">17</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=44135738"
                  >Comments</a
                ><span class="descendants">: 4</span></span
              >
            </h4>
            <div class="text">
              <p>- S to automatically split all hunks</p>
              <p>- G to set a global filter on hunks to show</p>
              <p>
                - A to automatically accept all hunks (after auto-splitting and
                global filter are applied)
              </p>
            </div>
          </section>
        </section>
        <section id="44135695">
          <h3>
            <a
              class="item"
              href="https://journals.plos.org/plosone/article?id=10.1371/journal.pone.0324016"
              >Behavioral responses of domestic cats to human odor</a
            >
          </h3>
          <section>
            <h4>
              <span>2025-05-30 @ 12:50:06</span
              ><span class="points-container"
                >Points: <span class="points">18</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=44135695"
                  >Comments</a
                ><span class="descendants">: 1</span></span
              >
            </h4>
          </section>
        </section>
        <section id="44135638">
          <h3>
            <a
              class="item"
              href="https://cacm.acm.org/practice/systems-correctness-practices-at-amazon-web-services/"
              >Systems Correctness Practices at Amazon Web Services</a
            >
          </h3>
          <section>
            <h4>
              <span>2025-05-30 @ 12:43:13</span
              ><span class="points-container"
                >Points: <span class="points">85</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=44135638"
                  >Comments</a
                ><span class="descendants">: 22</span></span
              >
            </h4>
          </section>
        </section>
        <section id="44135412">
          <h3>
            <a
              class="item"
              href="https://www.schneier.com/blog/archives/2025/05/why-take9-wont-improve-cybersecurity.html"
              >Take9 Won't Improve Cybersecurity</a
            >
          </h3>
          <section>
            <h4>
              <span>2025-05-30 @ 12:13:11</span
              ><span class="points-container"
                >Points: <span class="points">20</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=44135412"
                  >Comments</a
                ><span class="descendants">: 2</span></span
              >
            </h4>
          </section>
        </section>
        <section id="44134896">
          <h3>
            <a class="item" href="https://news.ycombinator.com/item?id=44134896"
              >Ask HN: What is the best LLM for consumer grade hardware?</a
            >
          </h3>
          <section>
            <h4>
              <span>2025-05-30 @ 11:02:19</span
              ><span class="points-container"
                >Points: <span class="points">70</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=44134896"
                  >Comments</a
                ><span class="descendants">: 47</span></span
              >
            </h4>
            <div class="text">
              I have a 5060ti with 16GB VRAM. I’m looking for a model that can
              hold basic conversations, no physics or advanced math required.
              Ideally something that can run reasonably fast, near real time.
            </div>
          </section>
        </section>
        <section id="44134728">
          <h3>
            <a
              class="item"
              href="https://www.orioledb.com/blog/orioledb-bridged-indexes"
              >Bridged Indexes in OrioleDB: architecture, internals and everyday
              use?</a
            >
          </h3>
          <section>
            <h4>
              <span>2025-05-30 @ 10:31:13</span
              ><span class="points-container"
                >Points: <span class="points">42</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=44134728"
                  >Comments</a
                ><span class="descendants">: 7</span></span
              >
            </h4>
          </section>
        </section>
        <section id="44134364">
          <h3>
            <a class="item" href="https://radio-astronomy.org/rasdr"
              >Radio Astronomy Software Defined Radio (Rasdr)</a
            >
          </h3>
          <section>
            <h4>
              <span>2025-05-30 @ 09:14:31</span
              ><span class="points-container"
                >Points: <span class="points">55</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=44134364"
                  >Comments</a
                ><span class="descendants">: 5</span></span
              >
            </h4>
          </section>
        </section>
        <section id="44134290">
          <h3>
            <a class="item" href="https://ndingwall.github.io/blog/tokenization"
              >Tokenization for language modeling: BPE vs. Unigram Language
              Modeling (2020)</a
            >
          </h3>
          <section>
            <h4>
              <span>2025-05-30 @ 08:59:02</span
              ><span class="points-container"
                >Points: <span class="points">40</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=44134290"
                  >Comments</a
                ><span class="descendants">: 8</span></span
              >
            </h4>
          </section>
        </section>
        <section id="44134208">
          <h3>
            <a
              class="item"
              href="https://theneuroscienceofeverydaylife.substack.com/p/mahna-mahna-do-doo-be-do-do-why-do"
              >Why do we get earworms?</a
            >
          </h3>
          <section>
            <h4>
              <span>2025-05-30 @ 08:44:14</span
              ><span class="points-container"
                >Points: <span class="points">29</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=44134208"
                  >Comments</a
                ><span class="descendants">: 39</span></span
              >
            </h4>
          </section>
        </section>
        <section id="44132823">
          <h3>
            <a
              class="item"
              href="https://github.com/muthuishere/mcp-server-bash-sdk"
              >Show HN: MCP Server SDK in Bash</a
            >
          </h3>
          <section>
            <h4>
              <span>2025-05-30 @ 04:25:23</span
              ><span class="points-container"
                >Points: <span class="points">94</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=44132823"
                  >Comments</a
                ><span class="descendants">: 24</span></span
              >
            </h4>
          </section>
        </section>
        <section id="44132744">
          <h3>
            <a class="item" href="https://trianglesplatting.github.io/"
              >Triangle splatting: radiance fields represented by triangles</a
            >
          </h3>
          <section>
            <h4>
              <span>2025-05-30 @ 04:07:17</span
              ><span class="points-container"
                >Points: <span class="points">117</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=44132744"
                  >Comments</a
                ><span class="descendants">: 47</span></span
              >
            </h4>
          </section>
        </section>
        <section id="44132673">
          <h3>
            <a
              class="item"
              href="https://www.chosenplaintext.ca/articles/radix-2-51-trick.html"
              >The radix 2^51 trick (2017)</a
            >
          </h3>
          <section>
            <h4>
              <span>2025-05-30 @ 03:55:37</span
              ><span class="points-container"
                >Points: <span class="points">299</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=44132673"
                  >Comments</a
                ><span class="descendants">: 51</span></span
              >
            </h4>
          </section>
        </section>
        <section id="44132486">
          <h3>
            <a
              class="item"
              href="https://openbao.org/blog/namespaces-announcement/"
              >OpenBao Namespaces</a
            >
          </h3>
          <section>
            <h4>
              <span>2025-05-30 @ 03:14:44</span
              ><span class="points-container"
                >Points: <span class="points">59</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=44132486"
                  >Comments</a
                ><span class="descendants">: 23</span></span
              >
            </h4>
          </section>
        </section>
        <section id="44132404">
          <h3>
            <a
              class="item"
              href="https://omeka-s.library.illinois.edu/s/MPAL/page/player-piano-rolls-landing"
              >Player Piano Rolls</a
            >
          </h3>
          <section>
            <h4>
              <span>2025-05-30 @ 02:58:02</span
              ><span class="points-container"
                >Points: <span class="points">52</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=44132404"
                  >Comments</a
                ><span class="descendants">: 39</span></span
              >
            </h4>
          </section>
        </section>
        <section id="44132075">
          <h3>
            <a
              class="item"
              href="https://krebsonsecurity.com/2025/05/u-s-sanctions-cloud-provider-funnull-as-top-source-of-pig-butchering-scams/"
              >U.S. sanctions cloud provider 'Funnull' as top source of 'pig
              butchering' scams</a
            >
          </h3>
          <section>
            <h4>
              <span>2025-05-30 @ 01:58:24</span
              ><span class="points-container"
                >Points: <span class="points">106</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=44132075"
                  >Comments</a
                ><span class="descendants">: 107</span></span
              >
            </h4>
          </section>
        </section>
        <section id="44131984">
          <h3>
            <a class="item" href="https://nostarch.com/practical-sdr"
              >Practical SDR: Getting started with software-defined radio</a
            >
          </h3>
          <section>
            <h4>
              <span>2025-05-30 @ 01:34:23</span
              ><span class="points-container"
                >Points: <span class="points">187</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=44131984"
                  >Comments</a
                ><span class="descendants">: 57</span></span
              >
            </h4>
          </section>
        </section>
        <section id="44128322">
          <h3>
            <a class="item" href="https://bfl.ai/models/flux-kontext"
              >FLUX.1 Kontext</a
            >
          </h3>
          <section>
            <h4>
              <span>2025-05-29 @ 17:40:35</span
              ><span class="points-container"
                >Points: <span class="points">431</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=44128322"
                  >Comments</a
                ><span class="descendants">: 103</span></span
              >
            </h4>
          </section>
        </section>
        <section id="44127109">
          <h3>
            <a class="item" href="https://weatherstar.netbymatt.com/"
              >WeatherStar 4000+: Weather Channel Simulator</a
            >
          </h3>
          <section>
            <h4>
              <span>2025-05-29 @ 15:38:45</span
              ><span class="points-container"
                >Points: <span class="points">658</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=44127109"
                  >Comments</a
                ><span class="descendants">: 124</span></span
              >
            </h4>
          </section>
        </section>
        <section id="44126612">
          <h3>
            <a class="item" href="https://commandline.stribny.name/"
              >Show HN: I wrote a modern Command Line Handbook</a
            >
          </h3>
          <section>
            <h4>
              <span>2025-05-29 @ 14:44:33</span
              ><span class="points-container"
                >Points: <span class="points">379</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=44126612"
                  >Comments</a
                ><span class="descendants">: 100</span></span
              >
            </h4>
            <div class="text">
              <p>
                A few years back I wrote an ebook about the Linux command line.
                Instead of focusing on a specific shell, paraphrasing manual
                pages, or providing long repetitive explanations, the idea was
                to create a modern guide that would help readers to understand
                the command line in the practical sense, cover the most common
                things people use the command line for, and do so without
                wasting the readers' time.
              </p>
              <p>
                The book contains material on terminals, shells (compatible with
                both Bash and Zsh), configuration, command line programs for
                typical use cases, shell scripting, and many tips and tricks to
                make working on the command line more convenient. I still
                consider it "an introduction" and it is not necessarily a book
                for the HN crowd that lives in the terminal, but I believe that
                the book will easily cover 80 % of the things most people want
                or need to do in the terminal.
              </p>
              <p>
                I made a couple of updates to the book over the years and just
                finished a significant one for 2025. The book is not perfect. I
                still see a lot of room for improvement, but I think it is good
                enough and I truly want to share it with everyone. Hence, pay
                what you want.
              </p>
              <p>
                EXAMPLE PAGES:
                <a
                  href="https://drive.google.com/file/d/1PkUcLv83Ib6nKYF88n3OBqeeVffAs3Sp/view?usp=sharing"
                  >https://drive.google.com/file/d/1PkUcLv83Ib6nKYF88n3OBqeeVff...</a
                >
              </p>
              <p>
                <a href="https://commandline.stribny.name/"
                  >https://commandline.stribny.name/</a
                >
              </p>
            </div>
          </section>
        </section>
        <section id="44121294">
          <h3>
            <a
              class="item"
              href="https://www.twz.com/land/everything-we-learned-about-lockheeds-quadstar-missile-aimed-at-replacing-fim-92-stingers"
              >Everything We Learned About Lockheed's "QuadStar" Stinger Missile
              Replacement</a
            >
          </h3>
          <section>
            <h4>
              <span>2025-05-28 @ 22:43:42</span
              ><span class="points-container"
                >Points: <span class="points">27</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=44121294"
                  >Comments</a
                ><span class="descendants">: 22</span></span
              >
            </h4>
          </section>
        </section>
        <section id="44120480">
          <h3>
            <a
              class="item"
              href="https://blog.racket-lang.org/2011/10/on-eval-in-dynamic-languages-generally.html"
              >On eval in dynamic languages generally and in Racket specifically
              (2011)</a
            >
          </h3>
          <section>
            <h4>
              <span>2025-05-28 @ 20:44:04</span
              ><span class="points-container"
                >Points: <span class="points">25</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=44120480"
                  >Comments</a
                ><span class="descendants">: 6</span></span
              >
            </h4>
          </section>
        </section>
        <section id="44118174">
          <h3>
            <a class="item" href="https://news.ycombinator.com/item?id=44118174"
              >Show HN: Every problem and solution in Beyond Cracking the Coding
              Interview</a
            >
          </h3>
          <section>
            <h4>
              <span>2025-05-28 @ 17:06:13</span
              ><span class="points-container"
                >Points: <span class="points">86</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=44118174"
                  >Comments</a
                ><span class="descendants">: 29</span></span
              >
            </h4>
            <div class="text">
              <p>
                We just compiled every problem (and solution) in the book and
                made them available for free. There are ~230 problems in total.
                Some of them are classics like n-queens, but almost all are new
                and not found in the original CTCI.
              </p>
              <p>
                You can read through the problems and solutions, or you work
                them with our AI Interviewer, which is also free. I'd recommend
                doing AI Interviewer before you read the solutions, but you can
                do it in whichever order you like. (When you first get into AI
                Interviewer, you can configure which topics you want problems
                on, and at what difficulty level, and you can add topics and
                change difficulty levels as you go.)
              </p>
              <p>
                Here's the link:
                <a
                  href="https://start.interviewing.io/beyond-ctci/all-problems/technical-topics"
                  >https://start.interviewing.io/beyond-ctci/all-problems/techn...</a
                >
                (You'll have to create an account if you don't already have one,
                but there's nothing else you need to do to access all the
                things.)
              </p>
            </div>
          </section>
        </section>
        <section id="44113706">
          <h3>
            <a
              class="item"
              href="https://redixhumayun.github.io/systems/2024/01/03/atomics-and-concurrency.html"
              >Atomics and Concurrency</a
            >
          </h3>
          <section>
            <h4>
              <span>2025-05-28 @ 08:00:48</span
              ><span class="points-container"
                >Points: <span class="points">59</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=44113706"
                  >Comments</a
                ><span class="descendants">: 8</span></span
              >
            </h4>
          </section>
        </section>
        <section id="44112653">
          <h3>
            <a class="item" href="https://www.youtube.com/watch?v=J0NNO91WyXM"
              >Printing metal on glass with lasers [video]</a
            >
          </h3>
          <section>
            <h4>
              <span>2025-05-28 @ 04:07:20</span
              ><span class="points-container"
                >Points: <span class="points">23</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=44112653"
                  >Comments</a
                ><span class="descendants">: 4</span></span
              >
            </h4>
          </section>
        </section>
        <section id="44110721">
          <h3>
            <a class="item" href="https://arxiv.org/abs/2505.18818"
              >Automated Verification of Monotonic Data Structure Traversals in
              C</a
            >
          </h3>
          <section>
            <h4>
              <span>2025-05-27 @ 21:12:33</span
              ><span class="points-container"
                >Points: <span class="points">9</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=44110721"
                  >Comments</a
                ><span class="descendants">: 0</span></span
              >
            </h4>
          </section>
        </section>
        <section id="44109017">
          <h3>
            <a
              class="item"
              href="https://phys.org/news/2025-05-atmospheric-memory-billions-people-monsoon.html"
              >The atmospheric memory that feeds billions of people: Monsoon
              rainfall mechanism</a
            >
          </h3>
          <section>
            <h4>
              <span>2025-05-27 @ 17:34:35</span
              ><span class="points-container"
                >Points: <span class="points">36</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=44109017"
                  >Comments</a
                ><span class="descendants">: 6</span></span
              >
            </h4>
          </section>
        </section>
        <section id="44106048">
          <h3>
            <a class="item" href="https://github.com/mathiasbynens/small"
              >Smallest Possible Files</a
            >
          </h3>
          <section>
            <h4>
              <span>2025-05-27 @ 11:57:01</span
              ><span class="points-container"
                >Points: <span class="points">62</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=44106048"
                  >Comments</a
                ><span class="descendants">: 30</span></span
              >
            </h4>
          </section>
        </section>
        <section id="44106007">
          <h3>
            <a
              class="item"
              href="https://daxe.substack.com/p/disarming-an-atomic-bomb-is-the-worst"
              >Dr John C. Clark, a scientist who disarmed atomic bombs twice</a
            >
          </h3>
          <section>
            <h4>
              <span>2025-05-27 @ 11:52:13</span
              ><span class="points-container"
                >Points: <span class="points">118</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=44106007"
                  >Comments</a
                ><span class="descendants">: 80</span></span
              >
            </h4>
          </section>
        </section>
        <section id="44105531">
          <h3>
            <a
              class="item"
              href="https://datadrivengamer.blogspot.com/2025/05/superauthenticity-computer-game-aspect.html"
              >Superauthenticity: Computer Game Aspect Ratios</a
            >
          </h3>
          <section>
            <h4>
              <span>2025-05-27 @ 10:20:12</span
              ><span class="points-container"
                >Points: <span class="points">24</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=44105531"
                  >Comments</a
                ><span class="descendants">: 9</span></span
              >
            </h4>
          </section>
        </section>
      </section>
      <section id="archives">
        <h2>
          <a
            href="https://github.com/kherrick/hacker-news/blob/main/archives/index.md"
            >Archives</a
          >
        </h2>
        <section>
          <h3>
            <a
              href="https://github.com/kherrick/hacker-news/blob/main/archives/2025/index.md"
              >2025</a
            >
          </h3>
        </section>
        <section>
          <h3>
            <a
              href="https://github.com/kherrick/hacker-news/blob/main/archives/2024/index.md"
              >2024</a
            >
          </h3>
        </section>
        <section>
          <h3>
            <a
              href="https://github.com/kherrick/hacker-news/blob/main/archives/2023/index.md"
              >2023</a
            >
          </h3>
        </section>
        <section>
          <h3>
            <a
              href="https://github.com/kherrick/hacker-news/blob/main/archives/2022/index.md"
              >2022</a
            >
          </h3>
        </section>
      </section>
    </main>
    <script type="module">
      import { buildDescendants } from "./lib/build-html-descendants.js";
      import { buildNextItem } from "./lib/build-html-next-item.js";
      import { getNextDateTime } from "./lib/date-time.js";

      const updateSectionById = (id) =>
        fetch(`https://hacker-news.firebaseio.com/v0/item/${id}.json`).then(
          (result) =>
            result.json().then(({ descendants, id, score, text, type }) => {
              const currentItem = document.getElementById(id);

              if (score) {
                currentItem.querySelector(".points").textContent = score;
              }

              if (descendants && (type === "poll" || type === "story")) {
                const currentDescendants =
                  currentItem.querySelector(".descendants");

                if (currentDescendants) {
                  currentDescendants.textContent = `: ${descendants}`;
                } else {
                  const comments = buildDescendants(
                    document,
                    descendants,
                    `https://news.ycombinator.com/item?id=${id}`
                  );

                  currentItem.querySelector("h4").appendChild(comments);
                }
              }

              if (text) {
                const currentText = currentItem.querySelector(".text");

                if (currentText) {
                  currentText.innerHTML = text.replace(/\0/g, "");
                } else {
                  const content = document.createElement("div");
                  content.innerHTML = text.replace(/\0/g, "");
                  content.setAttribute("class", "text");

                  currentItem.appendChild(content);
                }
              }
            })
        );

      class UpdateQueue {
        constructor() {
          this._ids = [];
          this._isUpdating = false;
        }

        addItemById(id) {
          this._ids.push(id);
        }

        async flush() {
          const id = this._ids.shift();

          if (id) {
            this._isUpdating = true;

            await updateSectionById(id);
            await this.flush();
          } else {
            this._isUpdating = false;

            setTimeout(async () => {
              if (!this._isUpdating && this._ids && this._ids.length) {
                await this.flush();
              }
            }, 0);
          }
        }
      }

      // get latest data
      const latestSection = document.getElementById("latest");

      for (let item of latestSection.querySelectorAll("section[id]")) {
        updateSectionById(item.getAttribute("id"));
      }

      if ("IntersectionObserver" in window) {
        window.hackerNewsState = { index: [], nextTimeIndex: -1 };

        const addNewsItem = async (newsItem, queue) => {
          try {
            const { date, time, itemComments, itemTitle, itemLink } = newsItem;
            const section = await buildNextItem({
              document,
              dateTime: `${date}, ${time}`,
              itemComments,
              itemLink,
              itemTitle: new DOMParser().parseFromString(
                itemTitle.replace(/\\/g, ""),
                "text/html"
              ).documentElement.textContent,
              fetchItemDetails: false,
            });

            // display loading indicator for section
            section.querySelector(".points-container").innerHTML =
              'Points: <span class="points"><img style="height: 100%;" src="lib/images/loading.svg" /></span>';

            const id = section.getAttribute("id");
            if (!document.getElementById(id)) {
              document.getElementById("latest").appendChild(section);

              queue.addItemById(id);
            }
          } catch (error) {}
        };

        const buildArchiveIndex = async (lastDateTime) => {
          const nextDate = lastDateTime.slice(0, 10);
          const nextYear = nextDate.slice(0, 4);

          return (
            await (
              await fetch(
                `https://raw.githubusercontent.com/kherrick/hacker-news/main/archives/${nextYear}/${nextDate}/index.md`
              )
            ).text()
          )
            .split("\n")
            .filter((line) => line.match(new RegExp("^\\* \\[")))
            .map((line) => {
              const segment = line.replace("* ", "").split("](");
              const pubDate = segment[0].slice(1);

              const itemComments = segment[1].split(") - [")[0];
              const itemTitle = segment[1].split(") - [")[1];
              const itemLink = segment[2].slice(0, -1);
              const date = pubDate.slice(0, 10);
              const time = pubDate.slice(-8);

              return {
                date,
                itemComments,
                itemLink,
                itemTitle,
                time,
              };
            });
        };

        const handleIntersectingEntry = async (entry, queue) => {
          if (entry.isIntersecting) {
            const lastDateTime = document
              .getElementById("latest")
              .querySelector(
                "section:last-child > section > h4 > span"
              ).textContent;

            const nextDateTime = getNextDateTime(lastDateTime ?? "", -1);
            const archiveIndex = await buildArchiveIndex(nextDateTime);
            const nextTimeIndex = archiveIndex.findIndex(
              ({ time }) => time === nextDateTime.slice(-8)
            );

            const handleIndexUpdate = (index, existingIndexValues = []) => {
              index.forEach((i) => {
                existingIndexValues.push(i);
              });
              return existingIndexValues;
            };

            window.hackerNewsState = {
              index: handleIndexUpdate(
                archiveIndex,
                window.hackerNewsState.index
              ),
              nextTimeIndex,
            };

            let currentTimeIndex = nextTimeIndex + 1;
            const items = Object.values(window.hackerNewsState.index);
            for (let item of items) {
              if (currentTimeIndex < window.hackerNewsState.index.length) {
                addNewsItem(items[currentTimeIndex], queue);

                currentTimeIndex = currentTimeIndex + 1;
              }
            }

            queue.flush();
          }
        };

        const archives = document.getElementById("archives");
        const archivesObserver = new IntersectionObserver(
          (entries) => {
            const queue = new UpdateQueue();

            entries.forEach((entry) => handleIntersectingEntry(entry, queue));
          },
          {
            root: null,
            rootMargin: "0px",
            threshold: 0,
          }
        );

        archivesObserver.observe(archives);

        let latestSectionsExpanded = true;
        const handleLatestHeaderClick = () => {
          latestSectionsExpanded = !latestSectionsExpanded;

          if (latestSectionsExpanded) {
            archivesObserver.observe(archives);
          } else {
            archivesObserver.disconnect(archives);
          }

          for (let section of document.querySelectorAll("#latest > section")) {
            section.style.display = latestSectionsExpanded ? "block" : "none";
          }
        };

        const latestHeader = document.querySelector("#latest > h2");
        latestHeader.style.cursor = "pointer";
        latestHeader.addEventListener("click", handleLatestHeaderClick);
      }
    </script>
    <script type="module">
      import { Workbox } from "https://storage.googleapis.com/workbox-cdn/releases/6.4.1/workbox-window.prod.mjs";

      if ("serviceWorker" in navigator) {
        const base = document.querySelector("base");
        const serviceWorkerPath = `${
          base ? base.href.replace(/\/$/, "") : ""
        }/service-worker.js`;

        const wb = new Workbox(serviceWorkerPath);

        // setup event listeners
        wb.addEventListener("waiting", (event) => {
          wb.addEventListener("controlling", () => {
            window.location.reload();
          });

          wb.messageSkipWaiting();
        });

        wb.register();
      }
    </script>
  </body>
</html>
