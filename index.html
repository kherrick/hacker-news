<!DOCTYPE html>
<html lang="en" xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta charset="utf-8" />
    <meta
      content="width=device-width, initial-scale=1.0, viewport-fit=cover"
      name="viewport"
    />
    <meta name="description" content="Hacker News" />
    <meta name="theme-color" content="#fff" />
    <title>Hacker News</title>
    <link rel="manifest" href="manifest.json" />
    <link
      href="data:image/x-icon;base64,AAABAAEAAQECAAEAAQA4AAAAFgAAACgAAAABAAAAAgAAAAEAAQAAAAAAAAAAAAAAAAAAAAAAAAAAAAABAAEAAQECAAEAAQA4AAAAFgAAACgAAAABAAAAAgAAAAEAAQAAAAAAAAAAAAAAAAAAAAAAAAAA"
      rel="icon"
      type="image/x-icon"
    />
    <link
      href="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAgAAAAIAAQMAAADOtka5AAAAA1BMVEUAAACnej3aAAAANklEQVR42u3BAQEAAACCIP+vbkhAAQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAB8G4IAAAFjdVCkAAAAAElFTkSuQmCC"
      rel="apple-touch-icon"
    />
    <style>
      /*<!--*/
      body {
        color: rgb(25, 25, 25);
        font-family: Verdana, Geneva, sans-serif;
        margin: 0;
      }

      a {
        text-decoration: none;
      }

      a:link,
      a:focus,
      a:hover,
      a:active {
        color: rgb(75, 75, 125);
      }

      a:visited {
        color: rgb(25, 25, 25);
      }

      h1 > a,
      h1 > a:link,
      h1 > a:focus,
      h1 > a:hover,
      h1 > a:active,
      h1 > a:visited,
      h2 > a,
      h2 > a:link,
      h2 > a:focus,
      h2 > a:hover,
      h2 > a:active,
      h2 > a:visited {
        color: rgb(25, 25, 25);
      }

      h1 {
        background-color: rgb(255, 102, 0);
        margin: 0;
        padding: 1rem;
      }

      h2 {
        background-color: rgb(200, 200, 200);
        margin: 1rem 0;
        padding: 0.5rem 0.5rem 0.5rem 1rem;
      }

      #latest > section,
      #archives > section {
        margin: 0 1rem 1rem 1rem;
        padding-bottom: 1rem;
      }

      #latest > section:not(:last-child),
      #archives > section:not(:last-child) {
        border-bottom: 1px dotted rgb(200, 200, 200);
      }

      section > h3 {
        margin: 0 0 0.5rem 0;
      }

      section > h4 {
        font-weight: normal;
        margin: 0 0 0 1rem;
      }

      .descendants-container,
      .points-container {
        align-items: center;
        border-left: 1px solid #333;
        display: inline-flex;
        margin-left: 0.5rem;
        padding-left: 0.5rem;
        text-align: center;
      }

      .points {
        align-items: center;
        display: inline-flex;
        height: 1rem;
        margin-left: 1ch;
        min-width: 3ch;
      }

      .text {
        line-height: 1.5rem;
        margin: 1rem 1rem 0 1rem;
        overflow: auto;
      }

      .text > p:first-child {
        margin-top: 1rem;
      }

      .text > p:last-child {
        margin-bottom: 0;
      }
      /*-->*/
    </style>
  </head>

  <body>
    <main>
      <h1><a href="https://kherrick.github.io/hacker-news/">Hacker News</a></h1>
      <section id="latest">
        <h2>Latest</h2>
        <section id="42948373">
          <h3>
            <a
              class="item"
              href="https://f-droid.org/2025/02/05/f-droid-awarded-otf-grant.html"
              >F-Droid Awarded Open Technology Fund's FOSS Sustainability
              Grant</a
            >
          </h3>
          <section>
            <h4>
              <span>2025-02-05 @ 13:44:26</span
              ><span class="points-container"
                >Points: <span class="points">148</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=42948373"
                  >Comments</a
                ><span class="descendants">: 21</span></span
              >
            </h4>
          </section>
        </section>
        <section id="42947383">
          <h3>
            <a class="item" href="https://www.fiwix.org/"
              >Fiwix: Small Unix-Like Kernel</a
            >
          </h3>
          <section>
            <h4>
              <span>2025-02-05 @ 12:09:23</span
              ><span class="points-container"
                >Points: <span class="points">21</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=42947383"
                  >Comments</a
                ><span class="descendants">: 2</span></span
              >
            </h4>
          </section>
        </section>
        <section id="42947306">
          <h3>
            <a
              class="item"
              href="https://www.ycombinator.com/companies/toma/jobs/eyhn3Si-founding-platform-engineer"
              >Toma (YC W24) Is Hiring a Founding Platform Engineer</a
            >
          </h3>
          <section>
            <h4>
              <span>2025-02-05 @ 12:01:00</span
              ><span class="points-container"
                >Points: <span class="points">1</span></span
              >
            </h4>
          </section>
        </section>
        <section id="42947049">
          <h3>
            <a
              class="item"
              href="https://www.neowin.net/news/microsoft-quietly-removes-official-windows-11-cputpm-bypass-for-unsupported-pcs/"
              >Microsoft deletes official Windows 11 CPU/TPM bypass for
              unsupported PCs</a
            >
          </h3>
          <section>
            <h4>
              <span>2025-02-05 @ 11:30:36</span
              ><span class="points-container"
                >Points: <span class="points">97</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=42947049"
                  >Comments</a
                ><span class="descendants">: 108</span></span
              >
            </h4>
          </section>
        </section>
        <section id="42946854">
          <h3>
            <a class="item" href="https://timkellogg.me/blog/2025/02/03/s1"
              >S1: The $6 R1 Competitor?</a
            >
          </h3>
          <section>
            <h4>
              <span>2025-02-05 @ 11:05:40</span
              ><span class="points-container"
                >Points: <span class="points">227</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=42946854"
                  >Comments</a
                ><span class="descendants">: 84</span></span
              >
            </h4>
          </section>
        </section>
        <section id="42946718">
          <h3>
            <a
              class="item"
              href="https://chromestatus.com/feature/5135990159835136"
              >Chrome 133 Supports DOM State-Preserving Move with
              moveBefore()</a
            >
          </h3>
          <section>
            <h4>
              <span>2025-02-05 @ 10:49:12</span
              ><span class="points-container"
                >Points: <span class="points">89</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=42946718"
                  >Comments</a
                ><span class="descendants">: 25</span></span
              >
            </h4>
          </section>
        </section>
        <section id="42946281">
          <h3>
            <a
              class="item"
              href="https://chriskiehl.com/article/thoughts-after-10-years"
              >Software development topics I've changed my mind on</a
            >
          </h3>
          <section>
            <h4>
              <span>2025-02-05 @ 09:50:30</span
              ><span class="points-container"
                >Points: <span class="points">259</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=42946281"
                  >Comments</a
                ><span class="descendants">: 258</span></span
              >
            </h4>
          </section>
        </section>
        <section id="42946232">
          <h3>
            <a class="item" href="https://research.swtch.com/godata"
              >Go Data Structures (2009)</a
            >
          </h3>
          <section>
            <h4>
              <span>2025-02-05 @ 09:44:32</span
              ><span class="points-container"
                >Points: <span class="points">83</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=42946232"
                  >Comments</a
                ><span class="descendants">: 23</span></span
              >
            </h4>
          </section>
        </section>
        <section id="42945146">
          <h3>
            <a class="item" href="https://gmsl.jgc.org/"
              >GNU Make Standard Library</a
            >
          </h3>
          <section>
            <h4>
              <span>2025-02-05 @ 07:30:59</span
              ><span class="points-container"
                >Points: <span class="points">60</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=42945146"
                  >Comments</a
                ><span class="descendants">: 38</span></span
              >
            </h4>
          </section>
        </section>
        <section id="42944858">
          <h3>
            <a class="item" href="https://nsjail.dev/"
              >NsJail: A light-weight process isolation tool for Linux</a
            >
          </h3>
          <section>
            <h4>
              <span>2025-02-05 @ 06:55:04</span
              ><span class="points-container"
                >Points: <span class="points">47</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=42944858"
                  >Comments</a
                ><span class="descendants">: 22</span></span
              >
            </h4>
          </section>
        </section>
        <section id="42944371">
          <h3>
            <a class="item" href="https://kagi.com/changelog#6155"
              >Kagi – Introducing Fair Pricing</a
            >
          </h3>
          <section>
            <h4>
              <span>2025-02-05 @ 05:50:16</span
              ><span class="points-container"
                >Points: <span class="points">801</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=42944371"
                  >Comments</a
                ><span class="descendants">: 361</span></span
              >
            </h4>
          </section>
        </section>
        <section id="42944203">
          <h3>
            <a
              class="item"
              href="https://www.tracingwoodgrains.com/p/the-full-story-of-the-faas-hiring"
              >The FAA’s Hiring Scandal</a
            >
          </h3>
          <section>
            <h4>
              <span>2025-02-05 @ 05:25:19</span
              ><span class="points-container"
                >Points: <span class="points">158</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=42944203"
                  >Comments</a
                ><span class="descendants">: 77</span></span
              >
            </h4>
          </section>
        </section>
        <section id="42944108">
          <h3>
            <a class="item" href="https://nanochess.org/pascal.html"
              >I coded a Pascal compiler for transputer as a teen in 1993</a
            >
          </h3>
          <section>
            <h4>
              <span>2025-02-05 @ 05:14:25</span
              ><span class="points-container"
                >Points: <span class="points">131</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=42944108"
                  >Comments</a
                ><span class="descendants">: 39</span></span
              >
            </h4>
          </section>
        </section>
        <section id="42942405">
          <h3>
            <a
              class="item"
              href="https://about.usps.com/newsroom/service-alerts/international/suspension-of-inbound-parcels-from-china-and-hong-kong.htm"
              >Suspension of inbound parcels from China and Hong Kong</a
            >
          </h3>
          <section>
            <h4>
              <span>2025-02-05 @ 01:43:10</span
              ><span class="points-container"
                >Points: <span class="points">453</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=42942405"
                  >Comments</a
                ><span class="descendants">: 453</span></span
              >
            </h4>
          </section>
        </section>
        <section id="42941283">
          <h3>
            <a class="item" href="https://beej.us/guide/bggit/"
              >Beej's Guide to Git</a
            >
          </h3>
          <section>
            <h4>
              <span>2025-02-05 @ 00:07:24</span
              ><span class="points-container"
                >Points: <span class="points">744</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=42941283"
                  >Comments</a
                ><span class="descendants">: 218</span></span
              >
            </h4>
          </section>
        </section>
        <section id="42941143">
          <h3>
            <a class="item" href="https://www.inkandswitch.com/ambsheets/"
              >Ambsheets: Spreadsheets for Exploring Scenarios</a
            >
          </h3>
          <section>
            <h4>
              <span>2025-02-04 @ 23:56:25</span
              ><span class="points-container"
                >Points: <span class="points">146</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=42941143"
                  >Comments</a
                ><span class="descendants">: 38</span></span
              >
            </h4>
          </section>
        </section>
        <section id="42940553">
          <h3>
            <a class="item" href="https://linusakesson.net/scene/nine/index.php"
              >Nine – seemingly impossible C64 demo</a
            >
          </h3>
          <section>
            <h4>
              <span>2025-02-04 @ 23:11:38</span
              ><span class="points-container"
                >Points: <span class="points">219</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=42940553"
                  >Comments</a
                ><span class="descendants">: 55</span></span
              >
            </h4>
          </section>
        </section>
        <section id="42940257">
          <h3>
            <a
              class="item"
              href="https://www.science.org/content/blog-post/what-s-happening-inside-nih"
              >What's happening inside the NIH and NSF</a
            >
          </h3>
          <section>
            <h4>
              <span>2025-02-04 @ 22:51:36</span
              ><span class="points-container"
                >Points: <span class="points">723</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=42940257"
                  >Comments</a
                ><span class="descendants">: 1001</span></span
              >
            </h4>
          </section>
        </section>
        <section id="42939862">
          <h3>
            <a class="item" href="https://infosecforactivists.org"
              >Infosec 101 for Activists</a
            >
          </h3>
          <section>
            <h4>
              <span>2025-02-04 @ 22:25:32</span
              ><span class="points-container"
                >Points: <span class="points">372</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=42939862"
                  >Comments</a
                ><span class="descendants">: 140</span></span
              >
            </h4>
          </section>
        </section>
        <section id="42937701">
          <h3>
            <a
              class="item"
              href="https://github.com/huggingface/smolagents/tree/main/examples/open_deep_research"
              >Open Deep Research</a
            >
          </h3>
          <section>
            <h4>
              <span>2025-02-04 @ 19:55:27</span
              ><span class="points-container"
                >Points: <span class="points">350</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=42937701"
                  >Comments</a
                ><span class="descendants">: 67</span></span
              >
            </h4>
          </section>
        </section>
        <section id="42936723">
          <h3>
            <a class="item" href="https://wikitok.vercel.app/">WikiTok</a>
          </h3>
          <section>
            <h4>
              <span>2025-02-04 @ 18:40:55</span
              ><span class="points-container"
                >Points: <span class="points">1268</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=42936723"
                  >Comments</a
                ><span class="descendants">: 204</span></span
              >
            </h4>
          </section>
        </section>
        <section id="42935516">
          <h3>
            <a
              class="item"
              href="https://gist.github.com/rtfeldman/77fb430ee57b42f5f2ca973a3992532f"
              >Roc rewrites the compiler in Zig</a
            >
          </h3>
          <section>
            <h4>
              <span>2025-02-04 @ 17:21:02</span
              ><span class="points-container"
                >Points: <span class="points">323</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=42935516"
                  >Comments</a
                ><span class="descendants">: 239</span></span
              >
            </h4>
          </section>
        </section>
        <section id="42934422">
          <h3>
            <a
              class="item"
              href="https://www.apple.com/newsroom/2025/02/introducing-apple-invites-a-new-app-that-brings-people-together/"
              >Apple Invites</a
            >
          </h3>
          <section>
            <h4>
              <span>2025-02-04 @ 16:21:58</span
              ><span class="points-container"
                >Points: <span class="points">589</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=42934422"
                  >Comments</a
                ><span class="descendants">: 808</span></span
              >
            </h4>
          </section>
        </section>
        <section id="42933840">
          <h3>
            <a
              class="item"
              href="https://www.cnn.com/2025/02/04/business/air-traffic-controller-shortage/index.html"
              >America desperately needs more air traffic controllers</a
            >
          </h3>
          <section>
            <h4>
              <span>2025-02-04 @ 15:44:21</span
              ><span class="points-container"
                >Points: <span class="points">321</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=42933840"
                  >Comments</a
                ><span class="descendants">: 579</span></span
              >
            </h4>
          </section>
        </section>
        <section id="42924182">
          <h3>
            <a class="item" href="https://www.bitwizard.nl/mtr/"
              >MTR: 'traceroute' and 'ping' in a single tool</a
            >
          </h3>
          <section>
            <h4>
              <span>2025-02-03 @ 22:26:35</span
              ><span class="points-container"
                >Points: <span class="points">58</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=42924182"
                  >Comments</a
                ><span class="descendants">: 28</span></span
              >
            </h4>
          </section>
        </section>
        <section id="42915786">
          <h3>
            <a
              class="item"
              href="https://info.juliahub.com/blog/julia-juliahub-advancing-innovation-and-growth"
              >Julia and JuliaHub: Advancing Innovation and Growth</a
            >
          </h3>
          <section>
            <h4>
              <span>2025-02-03 @ 07:19:29</span
              ><span class="points-container"
                >Points: <span class="points">69</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=42915786"
                  >Comments</a
                ><span class="descendants">: 18</span></span
              >
            </h4>
          </section>
        </section>
        <section id="42915435">
          <h3>
            <a class="item" href="https://apitally.io"
              >Show HN: Apitally – A simple, privacy-focused API monitoring and
              analytics tool</a
            >
          </h3>
          <section>
            <h4>
              <span>2025-02-03 @ 06:07:00</span
              ><span class="points-container"
                >Points: <span class="points">20</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=42915435"
                  >Comments</a
                ><span class="descendants">: 12</span></span
              >
            </h4>
            <div class="text">
              <a href="https://apitally.io">https://apitally.io</a>).
              <p>
                I’m building a simple API monitoring and analytics tool for
                Python / Node.js apps. It helps users understand API usage and
                performance, spot issues early and troubleshoot effectively when
                something goes wrong.
              </p>
              <p>Features include:</p>
              <p>
                - <i>Dashboards:</i> Provide insights into API traffic, errors,
                performance and consumers.
              </p>
              <p>
                - <i>Request logging:</i> Opt-in and highly configurable in
                terms of what data is logged. Users can drill down from
                aggregated metrics to individual requests (proven to be super
                helpful when troubleshooting issues).
              </p>
              <p>
                - <i>Custom alerts:</i> Based on 14 different API metrics with
                notifications delivered via email, Slack or Microsoft Teams.
              </p>
              <p>
                - <i>Validation error tracking:</i> Captures metrics about which
                fields failed validation and why. Works for web frameworks with
                built-in validation (e.g. FastAPI with pydantic), or that
                integrate with popular third-party validation libraries (e.g.
                Zod for Hono).
              </p>
              <p>
                - <i>Server error tracking:</i> Captures exception details and
                stack traces for 500 error responses. An integration with the
                Sentry SDK also captures event IDs, allowing users to click
                through to the relevant Sentry issue for more context.
              </p>
              <p>
                I first started developing Apitally to scratch my own itch.
                While working at a health tech company where I was responsible
                for API-based software products, I became frustrated with the
                monitoring tools we had in place - Datadog and the ELK stack.
                They were too complex for my API-centric use cases, and often a
                pain to use.
              </p>
              <p>
                As a result, I focused on making Apitally as simple as possible.
                This involved not just refining the UX of the dashboard, but
                also optimizing the developer experience with the open-source
                SDKs:
              </p>
              <p>
                -
                <a href="https://github.com/apitally/apitally-py"
                  >https://github.com/apitally/apitally-py</a
                >
                - Python SDK (supports FastAPI, Flask, Django, Litestar,
                Starlette)
              </p>
              <p>
                -
                <a href="https://github.com/apitally/apitally-js"
                  >https://github.com/apitally/apitally-js</a
                >
                - Node.js SDK (supports Express, NestJS, Fastify, Koa, Hono)
              </p>
              <p>
                My other focus was on data privacy, as that is a strict
                requirement in the healthcare industry. By default, Apitally
                doesn’t capture any sensitive data - metrics are aggregated on
                the client side (similar to Prometheus) and sent in the
                background in regular intervals.
              </p>
              <p>
                The hardest part has been implementing integrations for various
                web frameworks and supporting a wide range of versions. I
                learned a lot about the inner workings of web frameworks in the
                process. Good test coverage and an extensive test matrix were
                really important to not break people’s production APIs with
                buggy middleware.
              </p>
              <p>
                Apitally’s backend is built in Python and runs on a small
                Kubernetes cluster on DigitalOcean. It uses PostgreSQL and
                ClickHouse to store data and NATS JetStream as a message queue.
                I chose NATS for being lightweight and its exactly-once
                processing capabilities. I’m also impressed by ClickHouse’s
                performance given the low hardware specs of my server (4 vCPUs,
                8 GB RAM).
              </p>
              <p>
                Apitally is free to use for small hobby projects (with
                limitations), and I offer two paid tiers for $39 and $119 (USD)
                per month. The dashboard has a demo mode, allowing people to
                explore the product without having to set up their own app
                first.
              </p>
              <p>
                Thank you for reading about my bootstrapped indie product.
                Please let me know your thoughts and questions in the comments.
              </p>
            </div>
          </section>
        </section>
        <section id="42909613">
          <h3>
            <a
              class="item"
              href="https://www.nature.com/articles/s41598-021-92162-7"
              >Exploring Nine Simultaneous Transients on April 12th, 1950
              (2021)</a
            >
          </h3>
          <section>
            <h4>
              <span>2025-02-02 @ 16:25:38</span
              ><span class="points-container"
                >Points: <span class="points">11</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=42909613"
                  >Comments</a
                ><span class="descendants">: 0</span></span
              >
            </h4>
          </section>
        </section>
        <section id="42907239">
          <h3>
            <a
              class="item"
              href="https://blog.mastykarz.nl/calculate-number-language-model-tokens-string/"
              >Calculate the number of language model tokens for a string</a
            >
          </h3>
          <section>
            <h4>
              <span>2025-02-02 @ 08:47:02</span
              ><span class="points-container"
                >Points: <span class="points">13</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=42907239"
                  >Comments</a
                ><span class="descendants">: 2</span></span
              >
            </h4>
          </section>
        </section>
        <section id="42896918">
          <h3>
            <a class="item" href="https://codingcafe.jp/posts/signal-5yrs"
              >I spent five years building a webapp and got my first $1
              (2022)</a
            >
          </h3>
          <section>
            <h4>
              <span>2025-02-01 @ 08:47:33</span
              ><span class="points-container"
                >Points: <span class="points">199</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=42896918"
                  >Comments</a
                ><span class="descendants">: 65</span></span
              >
            </h4>
          </section>
        </section>
      </section>
      <section id="archives">
        <h2>
          <a
            href="https://github.com/kherrick/hacker-news/blob/main/archives/index.md"
            >Archives</a
          >
        </h2>
        <section>
          <h3>
            <a
              href="https://github.com/kherrick/hacker-news/blob/main/archives/2025/index.md"
              >2025</a
            >
          </h3>
        </section>
        <section>
          <h3>
            <a
              href="https://github.com/kherrick/hacker-news/blob/main/archives/2024/index.md"
              >2024</a
            >
          </h3>
        </section>
        <section>
          <h3>
            <a
              href="https://github.com/kherrick/hacker-news/blob/main/archives/2023/index.md"
              >2023</a
            >
          </h3>
        </section>
        <section>
          <h3>
            <a
              href="https://github.com/kherrick/hacker-news/blob/main/archives/2022/index.md"
              >2022</a
            >
          </h3>
        </section>
      </section>
    </main>
    <script type="module">
      import { buildDescendants } from "./lib/build-html-descendants.js";
      import { buildNextItem } from "./lib/build-html-next-item.js";
      import { getNextDateTime } from "./lib/date-time.js";

      const updateSectionById = (id) =>
        fetch(`https://hacker-news.firebaseio.com/v0/item/${id}.json`).then(
          (result) =>
            result.json().then(({ descendants, id, score, text, type }) => {
              const currentItem = document.getElementById(id);

              if (score) {
                currentItem.querySelector(".points").textContent = score;
              }

              if (descendants && (type === "poll" || type === "story")) {
                const currentDescendants =
                  currentItem.querySelector(".descendants");

                if (currentDescendants) {
                  currentDescendants.textContent = `: ${descendants}`;
                } else {
                  const comments = buildDescendants(
                    document,
                    descendants,
                    `https://news.ycombinator.com/item?id=${id}`
                  );

                  currentItem.querySelector("h4").appendChild(comments);
                }
              }

              if (text) {
                const currentText = currentItem.querySelector(".text");

                if (currentText) {
                  currentText.innerHTML = text.replace(/\0/g, "");
                } else {
                  const content = document.createElement("div");
                  content.innerHTML = text.replace(/\0/g, "");
                  content.setAttribute("class", "text");

                  currentItem.appendChild(content);
                }
              }
            })
        );

      class UpdateQueue {
        constructor() {
          this._ids = [];
          this._isUpdating = false;
        }

        addItemById(id) {
          this._ids.push(id);
        }

        async flush() {
          const id = this._ids.shift();

          if (id) {
            this._isUpdating = true;

            await updateSectionById(id);
            await this.flush();
          } else {
            this._isUpdating = false;

            setTimeout(async () => {
              if (!this._isUpdating && this._ids && this._ids.length) {
                await this.flush();
              }
            }, 0);
          }
        }
      }

      // get latest data
      const latestSection = document.getElementById("latest");

      for (let item of latestSection.querySelectorAll("section[id]")) {
        updateSectionById(item.getAttribute("id"));
      }

      if ("IntersectionObserver" in window) {
        window.hackerNewsState = { index: [], nextTimeIndex: -1 };

        const addNewsItem = async (newsItem, queue) => {
          try {
            const { date, time, itemComments, itemTitle, itemLink } = newsItem;
            const section = await buildNextItem({
              document,
              dateTime: `${date}, ${time}`,
              itemComments,
              itemLink,
              itemTitle: new DOMParser().parseFromString(
                itemTitle.replace(/\\/g, ""),
                "text/html"
              ).documentElement.textContent,
              fetchItemDetails: false,
            });

            // display loading indicator for section
            section.querySelector(".points-container").innerHTML =
              'Points: <span class="points"><img style="height: 100%;" src="lib/images/loading.svg" /></span>';

            const id = section.getAttribute("id");
            if (!document.getElementById(id)) {
              document.getElementById("latest").appendChild(section);

              queue.addItemById(id);
            }
          } catch (error) {}
        };

        const buildArchiveIndex = async (lastDateTime) => {
          const nextDate = lastDateTime.slice(0, 10);
          const nextYear = nextDate.slice(0, 4);

          return (
            await (
              await fetch(
                `https://raw.githubusercontent.com/kherrick/hacker-news/main/archives/${nextYear}/${nextDate}/index.md`
              )
            ).text()
          )
            .split("\n")
            .filter((line) => line.match(new RegExp("^\\* \\[")))
            .map((line) => {
              const segment = line.replace("* ", "").split("](");
              const pubDate = segment[0].slice(1);

              const itemComments = segment[1].split(") - [")[0];
              const itemTitle = segment[1].split(") - [")[1];
              const itemLink = segment[2].slice(0, -1);
              const date = pubDate.slice(0, 10);
              const time = pubDate.slice(-8);

              return {
                date,
                itemComments,
                itemLink,
                itemTitle,
                time,
              };
            });
        };

        const handleIntersectingEntry = async (entry, queue) => {
          if (entry.isIntersecting) {
            const lastDateTime = document
              .getElementById("latest")
              .querySelector(
                "section:last-child > section > h4 > span"
              ).textContent;

            const nextDateTime = getNextDateTime(lastDateTime ?? "", -1);
            const archiveIndex = await buildArchiveIndex(nextDateTime);
            const nextTimeIndex = archiveIndex.findIndex(
              ({ time }) => time === nextDateTime.slice(-8)
            );

            const handleIndexUpdate = (index, existingIndexValues = []) => {
              index.forEach((i) => {
                existingIndexValues.push(i);
              });
              return existingIndexValues;
            };

            window.hackerNewsState = {
              index: handleIndexUpdate(
                archiveIndex,
                window.hackerNewsState.index
              ),
              nextTimeIndex,
            };

            let currentTimeIndex = nextTimeIndex + 1;
            const items = Object.values(window.hackerNewsState.index);
            for (let item of items) {
              if (currentTimeIndex < window.hackerNewsState.index.length) {
                addNewsItem(items[currentTimeIndex], queue);

                currentTimeIndex = currentTimeIndex + 1;
              }
            }

            queue.flush();
          }
        };

        const archives = document.getElementById("archives");
        const archivesObserver = new IntersectionObserver(
          (entries) => {
            const queue = new UpdateQueue();

            entries.forEach((entry) => handleIntersectingEntry(entry, queue));
          },
          {
            root: null,
            rootMargin: "0px",
            threshold: 0,
          }
        );

        archivesObserver.observe(archives);

        let latestSectionsExpanded = true;
        const handleLatestHeaderClick = () => {
          latestSectionsExpanded = !latestSectionsExpanded;

          if (latestSectionsExpanded) {
            archivesObserver.observe(archives);
          } else {
            archivesObserver.disconnect(archives);
          }

          for (let section of document.querySelectorAll("#latest > section")) {
            section.style.display = latestSectionsExpanded ? "block" : "none";
          }
        };

        const latestHeader = document.querySelector("#latest > h2");
        latestHeader.style.cursor = "pointer";
        latestHeader.addEventListener("click", handleLatestHeaderClick);
      }
    </script>
    <script type="module">
      import { Workbox } from "https://storage.googleapis.com/workbox-cdn/releases/6.4.1/workbox-window.prod.mjs";

      if ("serviceWorker" in navigator) {
        const base = document.querySelector("base");
        const serviceWorkerPath = `${
          base ? base.href.replace(/\/$/, "") : ""
        }/service-worker.js`;

        const wb = new Workbox(serviceWorkerPath);

        // setup event listeners
        wb.addEventListener("waiting", (event) => {
          wb.addEventListener("controlling", () => {
            window.location.reload();
          });

          wb.messageSkipWaiting();
        });

        wb.register();
      }
    </script>
  </body>
</html>
