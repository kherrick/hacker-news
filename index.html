<!DOCTYPE html>
<html lang="en" xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta charset="utf-8" />
    <meta
      content="width=device-width, initial-scale=1.0, viewport-fit=cover"
      name="viewport"
    />
    <meta name="description" content="Hacker News" />
    <meta name="theme-color" content="#fff" />
    <title>Hacker News</title>
    <link rel="manifest" href="manifest.json" />
    <link
      href="data:image/x-icon;base64,AAABAAEAAQECAAEAAQA4AAAAFgAAACgAAAABAAAAAgAAAAEAAQAAAAAAAAAAAAAAAAAAAAAAAAAAAAABAAEAAQECAAEAAQA4AAAAFgAAACgAAAABAAAAAgAAAAEAAQAAAAAAAAAAAAAAAAAAAAAAAAAA"
      rel="icon"
      type="image/x-icon"
    />
    <link
      href="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAgAAAAIAAQMAAADOtka5AAAAA1BMVEUAAACnej3aAAAANklEQVR42u3BAQEAAACCIP+vbkhAAQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAB8G4IAAAFjdVCkAAAAAElFTkSuQmCC"
      rel="apple-touch-icon"
    />
    <style>
      /*<!--*/
      body {
        color: rgb(25, 25, 25);
        font-family: Verdana, Geneva, sans-serif;
        margin: 0;
      }

      a {
        text-decoration: none;
      }

      a:link,
      a:focus,
      a:hover,
      a:active {
        color: rgb(75, 75, 125);
      }

      a:visited {
        color: rgb(25, 25, 25);
      }

      h1 > a,
      h1 > a:link,
      h1 > a:focus,
      h1 > a:hover,
      h1 > a:active,
      h1 > a:visited,
      h2 > a,
      h2 > a:link,
      h2 > a:focus,
      h2 > a:hover,
      h2 > a:active,
      h2 > a:visited {
        color: rgb(25, 25, 25);
      }

      h1 {
        background-color: rgb(255, 102, 0);
        margin: 0;
        padding: 1rem;
      }

      h2 {
        background-color: rgb(200, 200, 200);
        margin: 1rem 0;
        padding: 0.5rem 0.5rem 0.5rem 1rem;
      }

      #latest > section,
      #archives > section {
        margin: 0 1rem 1rem 1rem;
        padding-bottom: 1rem;
      }

      #latest > section:not(:last-child),
      #archives > section:not(:last-child) {
        border-bottom: 1px dotted rgb(200, 200, 200);
      }

      section > h3 {
        margin: 0 0 0.5rem 0;
      }

      section > h4 {
        font-weight: normal;
        margin: 0 0 0 1rem;
      }

      .descendants-container,
      .points-container {
        align-items: center;
        border-left: 1px solid #333;
        display: inline-flex;
        margin-left: 0.5rem;
        padding-left: 0.5rem;
        text-align: center;
      }

      .points {
        align-items: center;
        display: inline-flex;
        height: 1rem;
        margin-left: 1ch;
        min-width: 3ch;
      }

      .text {
        line-height: 1.5rem;
        margin: 1rem 1rem 0 1rem;
        overflow: auto;
      }

      .text > p:first-child {
        margin-top: 1rem;
      }

      .text > p:last-child {
        margin-bottom: 0;
      }
      /*-->*/
    </style>
  </head>

  <body>
    <main>
      <h1><a href="https://kherrick.github.io/hacker-news/">Hacker News</a></h1>
      <section id="latest">
        <h2>Latest</h2>
        <section id="43889875">
          <h3>
            <a
              class="item"
              href="https://owentrueblood.com/blog/2025/05/04/helmdar/"
              >Helmdar: 3D Scanning Brooklyn on Rollerblades</a
            >
          </h3>
          <section>
            <h4>
              <span>2025-05-04 @ 21:49:40</span
              ><span class="points-container"
                >Points: <span class="points">7</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=43889875"
                  >Comments</a
                ><span class="descendants">: 0</span></span
              >
            </h4>
          </section>
        </section>
        <section id="43889610">
          <h3>
            <a
              class="item"
              href="https://victoriametrics.com/blog/go-graceful-shutdown/index.html"
              >Graceful Shutdown in Go: Practical Patterns</a
            >
          </h3>
          <section>
            <h4>
              <span>2025-05-04 @ 21:09:16</span
              ><span class="points-container"
                >Points: <span class="points">20</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=43889610"
                  >Comments</a
                ><span class="descendants">: 3</span></span
              >
            </h4>
          </section>
        </section>
        <section id="43889543">
          <h3>
            <a
              class="item"
              href="https://www.ycombinator.com/companies/kaipod-learning/jobs/Bs3H9uB-vp-of-engineering"
              >KaiPod Learning (YC S21) Is Hiring VP of Engineering</a
            >
          </h3>
          <section>
            <h4>
              <span>2025-05-04 @ 21:01:11</span
              ><span class="points-container"
                >Points: <span class="points">1</span></span
              >
            </h4>
          </section>
        </section>
        <section id="43889502">
          <h3>
            <a class="item" href="https://news.ycombinator.com/item?id=43889502"
              >Ask HN: Hackathons feel fake now – anyone else noticing this?</a
            >
          </h3>
          <section>
            <h4>
              <span>2025-05-04 @ 20:55:41</span
              ><span class="points-container"
                >Points: <span class="points">32</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=43889502"
                  >Comments</a
                ><span class="descendants">: 25</span></span
              >
            </h4>
            <div class="text">
              Been going to a bunch of hackathons in SF lately and honestly,
              everything feels fake. There are like 20 sponsors handing out
              credits for their tools that all do the same thing. Half the time,
              they can’t even explain what they’re for. They’re just hoping
              someone uses them so they can count it as adoption. Everyone jams
              these into projects to check a box, and what gets built is mostly
              BS with zero innovation. Was it always like this and I'm noticing
              it now, or has something changed?
            </div>
          </section>
        </section>
        <section id="43889311">
          <h3>
            <a
              class="item"
              href="https://www.thenewatlantis.com/publications/the-new-control-society"
              >The New Control Society</a
            >
          </h3>
          <section>
            <h4>
              <span>2025-05-04 @ 20:24:50</span
              ><span class="points-container"
                >Points: <span class="points">17</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=43889311"
                  >Comments</a
                ><span class="descendants">: 7</span></span
              >
            </h4>
          </section>
        </section>
        <section id="43888803">
          <h3>
            <a class="item" href="https://claytonwramsey.com/blog/prompt/"
              >I'd rather read the prompt</a
            >
          </h3>
          <section>
            <h4>
              <span>2025-05-04 @ 19:17:28</span
              ><span class="points-container"
                >Points: <span class="points">293</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=43888803"
                  >Comments</a
                ><span class="descendants">: 200</span></span
              >
            </h4>
          </section>
        </section>
        <section id="43888777">
          <h3>
            <a
              class="item"
              href="https://www.theballotboy.com/electing-the-doge"
              >The complicated business of electing a Doge</a
            >
          </h3>
          <section>
            <h4>
              <span>2025-05-04 @ 19:14:44</span
              ><span class="points-container"
                >Points: <span class="points">40</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=43888777"
                  >Comments</a
                ><span class="descendants">: 22</span></span
              >
            </h4>
          </section>
        </section>
        <section id="43888568">
          <h3>
            <a
              class="item"
              href="https://jazzberry.ai/blog/test-generation-as-the-foundation"
              >LLMs as Unbiased Oracles</a
            >
          </h3>
          <section>
            <h4>
              <span>2025-05-04 @ 18:45:43</span
              ><span class="points-container"
                >Points: <span class="points">20</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=43888568"
                  >Comments</a
                ><span class="descendants">: 10</span></span
              >
            </h4>
          </section>
        </section>
        <section id="43888239">
          <h3>
            <a
              class="item"
              href="https://terrytao.wordpress.com/2025/05/04/orders-of-infinity/"
              >Orders of Infinity</a
            >
          </h3>
          <section>
            <h4>
              <span>2025-05-04 @ 17:55:27</span
              ><span class="points-container"
                >Points: <span class="points">47</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=43888239"
                  >Comments</a
                ><span class="descendants">: 5</span></span
              >
            </h4>
          </section>
        </section>
        <section id="43888225">
          <h3>
            <a
              class="item"
              href="https://text-incubation.com/AI+code+is+legacy+code+from+day+one"
              >AI code is legacy code?</a
            >
          </h3>
          <section>
            <h4>
              <span>2025-05-04 @ 17:53:59</span
              ><span class="points-container"
                >Points: <span class="points">124</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=43888225"
                  >Comments</a
                ><span class="descendants">: 127</span></span
              >
            </h4>
          </section>
        </section>
        <section id="43888191">
          <h3>
            <a class="item" href="https://www.youtube.com/watch?v=7hdJQkn8rtA"
              >Critical Program Reading (1975) [video]</a
            >
          </h3>
          <section>
            <h4>
              <span>2025-05-04 @ 17:48:47</span
              ><span class="points-container"
                >Points: <span class="points">21</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=43888191"
                  >Comments</a
                ><span class="descendants">: 3</span></span
              >
            </h4>
          </section>
        </section>
        <section id="43888157">
          <h3>
            <a class="item" href="https://printserver.ink/"
              >Show HN: Driverless print server for legacy printers, profit goes
              to open-source</a
            >
          </h3>
          <section>
            <h4>
              <span>2025-05-04 @ 17:43:00</span
              ><span class="points-container"
                >Points: <span class="points">19</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=43888157"
                  >Comments</a
                ><span class="descendants">: 0</span></span
              >
            </h4>
            <div class="text">
              <p></p>
              <pre><code>  * Supports all OS: Windows, macOS, Linux, iOS, Android. No drivers needed. Windows-on-ARM and Apple M1/2/3/4 also supported.
  * Supports the majority of printers released before ≈2018
  * Profit from sold devices is shared between CUPS, SANE, AirSane open-source printing and scanning projects
  * Surplus and donations are accumulated to improve current open-source drivers and develop new ones
</code></pre>
              The printer driver is run inside the device. It comes with lots of
              open-source and official proprietary drivers. x86-only drivers are
              running under box86 emulation, with little visible performance
              impact, ensuring wide compatibility with many printers and MFPs.
              <p>
                All of this is bundled in a retail-like device, with simple web
                interface[1][2]. No tinkering and no DIY required, it's safe to
                plug off the power cord every time, and you can do factory
                reset.
              </p>
              <p>
                The print server is secure by default: it conforms to most of
                the IoT Device Security Specification 1.0[3] best practices, has
                built-in firewall to ensure LAN-only operation, and does not
                include anti-consumer features.
              </p>
              <p>
                All devices come with technical support, where I act as a
                middleman between all the involved projects and printer drivers.
                If there's a bug, I first try to debug the issue remotely, and
                if it's not possible, end up buying the same printer and debug
                it until the issue is resolved. All the fixes made during the
                development are contributed back to the origin projects, and
                there were many bugs fixed: almost every package has additional
                patches compared to original Debian 12 disto state.
              </p>
              <p>
                [1]:
                <a href="https://printserver.ink/webface-main.png"
                  >https://printserver.ink/webface-main.png</a
                >
              </p>
              <p>
                [2]:
                <a href="https://printserver.ink/webface-other.png"
                  >https://printserver.ink/webface-other.png</a
                >
              </p>
              <p>
                [3]:
                <a
                  href="https://csa-iot.org/wp-content/uploads/2024/03/23-80986-013-PSWG-1.0-Specification-18-March-2024.pdf"
                  >https://csa-iot.org/wp-content/uploads/2024/03/23-80986-013-...</a
                >
              </p>
              <p>
                P.S. Brother printer lovers, the latest Brother L2800dw (2024)
                laser comes with the chipped cartridge, which you can't refill
                and reset forever anymore. The printer allows to continue
                printing with an "empty" cartridge with a special menu item, but
                it does so only to fixed amount of pages, and then stops. It
                doesn't allow to use cartridges without chips.
              </p>
            </div>
          </section>
        </section>
        <section id="43888117">
          <h3>
            <a class="item" href="https://blog.rahix.de/design-for-3d-printing/"
              >Design for 3D-Printing</a
            >
          </h3>
          <section>
            <h4>
              <span>2025-05-04 @ 17:38:13</span
              ><span class="points-container"
                >Points: <span class="points">288</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=43888117"
                  >Comments</a
                ><span class="descendants">: 75</span></span
              >
            </h4>
          </section>
        </section>
        <section id="43888005">
          <h3>
            <a
              class="item"
              href="https://zeux.io/2025/05/03/load-store-conflicts/"
              >Load-Store Conflicts</a
            >
          </h3>
          <section>
            <h4>
              <span>2025-05-04 @ 17:18:42</span
              ><span class="points-container"
                >Points: <span class="points">68</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=43888005"
                  >Comments</a
                ><span class="descendants">: 5</span></span
              >
            </h4>
          </section>
        </section>
        <section id="43887998">
          <h3>
            <a class="item" href="https://alhassy.com/TypedLisp.html"
              >Typed Lisp, a Primer</a
            >
          </h3>
          <section>
            <h4>
              <span>2025-05-04 @ 17:17:35</span
              ><span class="points-container"
                >Points: <span class="points">38</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=43887998"
                  >Comments</a
                ><span class="descendants">: 6</span></span
              >
            </h4>
          </section>
        </section>
        <section id="43887708">
          <h3>
            <a
              class="item"
              href="https://raw.githubusercontent.com/Stefan20162016/linux-insides-code/master/bootloader.asm"
              >Minimal Linux Bootloader (2018)</a
            >
          </h3>
          <section>
            <h4>
              <span>2025-05-04 @ 16:36:02</span
              ><span class="points-container"
                >Points: <span class="points">48</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=43887708"
                  >Comments</a
                ><span class="descendants">: 13</span></span
              >
            </h4>
          </section>
        </section>
        <section id="43887637">
          <h3>
            <a class="item" href="https://rentry.co/samplers"
              >Dummy's Guide to Modern LLM Sampling</a
            >
          </h3>
          <section>
            <h4>
              <span>2025-05-04 @ 16:26:28</span
              ><span class="points-container"
                >Points: <span class="points">128</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=43887637"
                  >Comments</a
                ><span class="descendants">: 24</span></span
              >
            </h4>
          </section>
        </section>
        <section id="43887546">
          <h3>
            <a class="item" href="https://github.com/benb0jangles/EzTrak"
              >Show HN: EZ-TRAK Satellite Hand Tracking Suite</a
            >
          </h3>
          <section>
            <h4>
              <span>2025-05-04 @ 16:10:41</span
              ><span class="points-container"
                >Points: <span class="points">34</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=43887546"
                  >Comments</a
                ><span class="descendants">: 5</span></span
              >
            </h4>
            <div class="text">
              EZ-TRAK is a comprehensive satellite tracking suite designed for
              amateur radio operators, weather satellite enthusiasts, and
              educational purposes. The software interfaces with an EZ-TRAK BLE
              device which is mounted to a lightweight foldable portable
              satellite dish antenna to hand track satellites in real-time,
              providing azimuth and elevation data for optimal antenna
              positioning.
            </div>
          </section>
        </section>
        <section id="43886601">
          <h3>
            <a class="item" href="https://github.com/Foreseerr/TScale"
              >TScale – distributed training on consumer GPUs</a
            >
          </h3>
          <section>
            <h4>
              <span>2025-05-04 @ 13:29:55</span
              ><span class="points-container"
                >Points: <span class="points">106</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=43886601"
                  >Comments</a
                ><span class="descendants">: 23</span></span
              >
            </h4>
          </section>
        </section>
        <section id="43886243">
          <h3>
            <a
              class="item"
              href="https://oxfordamerican.org/oa-now/the-alabama-landline-that-keeps-ringing"
              >An Alabama landline that keeps ringing</a
            >
          </h3>
          <section>
            <h4>
              <span>2025-05-04 @ 12:02:35</span
              ><span class="points-container"
                >Points: <span class="points">240</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=43886243"
                  >Comments</a
                ><span class="descendants">: 82</span></span
              >
            </h4>
          </section>
        </section>
        <section id="43885478">
          <h3>
            <a
              class="item"
              href="http://pascal.hansotten.com/niklaus-wirth/project-oberon/oberon-pi/"
              >Oberon Pi</a
            >
          </h3>
          <section>
            <h4>
              <span>2025-05-04 @ 08:54:44</span
              ><span class="points-container"
                >Points: <span class="points">152</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=43885478"
                  >Comments</a
                ><span class="descendants">: 26</span></span
              >
            </h4>
          </section>
        </section>
        <section id="43883040">
          <h3>
            <a class="item" href="https://github.com/Jacksaur/Gorgeous-GRUB"
              >Gorgeous-GRUB: collection of decent community-made GRUB themes</a
            >
          </h3>
          <section>
            <h4>
              <span>2025-05-03 @ 22:57:58</span
              ><span class="points-container"
                >Points: <span class="points">403</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=43883040"
                  >Comments</a
                ><span class="descendants">: 110</span></span
              >
            </h4>
          </section>
        </section>
        <section id="43882287">
          <h3>
            <a
              class="item"
              href="https://arstechnica.com/science/2025/05/cyborg-cicadas-play-pachelbels-canon/"
              >Cyborg cicadas play Pachelbel's Canon</a
            >
          </h3>
          <section>
            <h4>
              <span>2025-05-03 @ 21:00:54</span
              ><span class="points-container"
                >Points: <span class="points">4</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=43882287"
                  >Comments</a
                ><span class="descendants">: 1</span></span
              >
            </h4>
          </section>
        </section>
        <section id="43877644">
          <h3>
            <a
              class="item"
              href="https://acoup.blog/2025/05/02/collections-why-archers-didnt-volley-fire/"
              >Why Archers Didn't Volley Fire</a
            >
          </h3>
          <section>
            <h4>
              <span>2025-05-03 @ 08:28:23</span
              ><span class="points-container"
                >Points: <span class="points">73</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=43877644"
                  >Comments</a
                ><span class="descendants">: 22</span></span
              >
            </h4>
          </section>
        </section>
        <section id="43877419">
          <h3>
            <a
              class="item"
              href="https://www.historytoday.com/archive/feature/merovingians-do-nothing-kings"
              >The Merovingians: 'Do-Nothing Kings'?</a
            >
          </h3>
          <section>
            <h4>
              <span>2025-05-03 @ 07:25:31</span
              ><span class="points-container"
                >Points: <span class="points">8</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=43877419"
                  >Comments</a
                ><span class="descendants">: 2</span></span
              >
            </h4>
          </section>
        </section>
        <section id="43875476">
          <h3>
            <a
              class="item"
              href="https://micahflee.com/tm-sgnl-the-obscure-unofficial-signal-app-mike-waltz-uses-to-text-with-trump-officials/"
              >Technical analysis of TM SGNL, the unofficial Signal app Trump
              officials used</a
            >
          </h3>
          <section>
            <h4>
              <span>2025-05-02 @ 23:20:59</span
              ><span class="points-container"
                >Points: <span class="points">80</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=43875476"
                  >Comments</a
                ><span class="descendants">: 17</span></span
              >
            </h4>
          </section>
        </section>
        <section id="43874641">
          <h3>
            <a
              class="item"
              href="https://www.space.com/astronomy/solar-system/evidence-of-controversial-planet-9-uncovered-in-sky-surveys-taken-23-years-apart"
              >Evidence of controversial Planet 9 uncovered in sky surveys taken
              23 years apart</a
            >
          </h3>
          <section>
            <h4>
              <span>2025-05-02 @ 21:13:07</span
              ><span class="points-container"
                >Points: <span class="points">137</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=43874641"
                  >Comments</a
                ><span class="descendants">: 106</span></span
              >
            </h4>
          </section>
        </section>
        <section id="43866329">
          <h3>
            <a
              class="item"
              href="https://lucasb.eyer.be/articles/vit_cnn_speed.html"
              >The Speed of VITs and CNNs</a
            >
          </h3>
          <section>
            <h4>
              <span>2025-05-02 @ 04:53:46</span
              ><span class="points-container"
                >Points: <span class="points">56</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=43866329"
                  >Comments</a
                ><span class="descendants">: 13</span></span
              >
            </h4>
          </section>
        </section>
        <section id="43852217">
          <h3>
            <a
              class="item"
              href="https://www.crowdsupply.com/eevengers/thunderscope/updates/revving-up-for-production"
              >Thunderscope update: My take: Why open source is better</a
            >
          </h3>
          <section>
            <h4>
              <span>2025-05-01 @ 00:16:26</span
              ><span class="points-container"
                >Points: <span class="points">20</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=43852217"
                  >Comments</a
                ><span class="descendants">: 1</span></span
              >
            </h4>
          </section>
        </section>
        <section id="43845174">
          <h3>
            <a
              class="item"
              href="https://news.mit.edu/2025/kids-eeg-monitoring-consciousness-safely-reduces-anesthetic-use-0429"
              >In kids, EEG monitoring of consciousness safely reduces
              anesthetic use</a
            >
          </h3>
          <section>
            <h4>
              <span>2025-04-30 @ 13:46:38</span
              ><span class="points-container"
                >Points: <span class="points">105</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=43845174"
                  >Comments</a
                ><span class="descendants">: 61</span></span
              >
            </h4>
          </section>
        </section>
      </section>
      <section id="archives">
        <h2>
          <a
            href="https://github.com/kherrick/hacker-news/blob/main/archives/index.md"
            >Archives</a
          >
        </h2>
        <section>
          <h3>
            <a
              href="https://github.com/kherrick/hacker-news/blob/main/archives/2025/index.md"
              >2025</a
            >
          </h3>
        </section>
        <section>
          <h3>
            <a
              href="https://github.com/kherrick/hacker-news/blob/main/archives/2024/index.md"
              >2024</a
            >
          </h3>
        </section>
        <section>
          <h3>
            <a
              href="https://github.com/kherrick/hacker-news/blob/main/archives/2023/index.md"
              >2023</a
            >
          </h3>
        </section>
        <section>
          <h3>
            <a
              href="https://github.com/kherrick/hacker-news/blob/main/archives/2022/index.md"
              >2022</a
            >
          </h3>
        </section>
      </section>
    </main>
    <script type="module">
      import { buildDescendants } from "./lib/build-html-descendants.js";
      import { buildNextItem } from "./lib/build-html-next-item.js";
      import { getNextDateTime } from "./lib/date-time.js";

      const updateSectionById = (id) =>
        fetch(`https://hacker-news.firebaseio.com/v0/item/${id}.json`).then(
          (result) =>
            result.json().then(({ descendants, id, score, text, type }) => {
              const currentItem = document.getElementById(id);

              if (score) {
                currentItem.querySelector(".points").textContent = score;
              }

              if (descendants && (type === "poll" || type === "story")) {
                const currentDescendants =
                  currentItem.querySelector(".descendants");

                if (currentDescendants) {
                  currentDescendants.textContent = `: ${descendants}`;
                } else {
                  const comments = buildDescendants(
                    document,
                    descendants,
                    `https://news.ycombinator.com/item?id=${id}`
                  );

                  currentItem.querySelector("h4").appendChild(comments);
                }
              }

              if (text) {
                const currentText = currentItem.querySelector(".text");

                if (currentText) {
                  currentText.innerHTML = text.replace(/\0/g, "");
                } else {
                  const content = document.createElement("div");
                  content.innerHTML = text.replace(/\0/g, "");
                  content.setAttribute("class", "text");

                  currentItem.appendChild(content);
                }
              }
            })
        );

      class UpdateQueue {
        constructor() {
          this._ids = [];
          this._isUpdating = false;
        }

        addItemById(id) {
          this._ids.push(id);
        }

        async flush() {
          const id = this._ids.shift();

          if (id) {
            this._isUpdating = true;

            await updateSectionById(id);
            await this.flush();
          } else {
            this._isUpdating = false;

            setTimeout(async () => {
              if (!this._isUpdating && this._ids && this._ids.length) {
                await this.flush();
              }
            }, 0);
          }
        }
      }

      // get latest data
      const latestSection = document.getElementById("latest");

      for (let item of latestSection.querySelectorAll("section[id]")) {
        updateSectionById(item.getAttribute("id"));
      }

      if ("IntersectionObserver" in window) {
        window.hackerNewsState = { index: [], nextTimeIndex: -1 };

        const addNewsItem = async (newsItem, queue) => {
          try {
            const { date, time, itemComments, itemTitle, itemLink } = newsItem;
            const section = await buildNextItem({
              document,
              dateTime: `${date}, ${time}`,
              itemComments,
              itemLink,
              itemTitle: new DOMParser().parseFromString(
                itemTitle.replace(/\\/g, ""),
                "text/html"
              ).documentElement.textContent,
              fetchItemDetails: false,
            });

            // display loading indicator for section
            section.querySelector(".points-container").innerHTML =
              'Points: <span class="points"><img style="height: 100%;" src="lib/images/loading.svg" /></span>';

            const id = section.getAttribute("id");
            if (!document.getElementById(id)) {
              document.getElementById("latest").appendChild(section);

              queue.addItemById(id);
            }
          } catch (error) {}
        };

        const buildArchiveIndex = async (lastDateTime) => {
          const nextDate = lastDateTime.slice(0, 10);
          const nextYear = nextDate.slice(0, 4);

          return (
            await (
              await fetch(
                `https://raw.githubusercontent.com/kherrick/hacker-news/main/archives/${nextYear}/${nextDate}/index.md`
              )
            ).text()
          )
            .split("\n")
            .filter((line) => line.match(new RegExp("^\\* \\[")))
            .map((line) => {
              const segment = line.replace("* ", "").split("](");
              const pubDate = segment[0].slice(1);

              const itemComments = segment[1].split(") - [")[0];
              const itemTitle = segment[1].split(") - [")[1];
              const itemLink = segment[2].slice(0, -1);
              const date = pubDate.slice(0, 10);
              const time = pubDate.slice(-8);

              return {
                date,
                itemComments,
                itemLink,
                itemTitle,
                time,
              };
            });
        };

        const handleIntersectingEntry = async (entry, queue) => {
          if (entry.isIntersecting) {
            const lastDateTime = document
              .getElementById("latest")
              .querySelector(
                "section:last-child > section > h4 > span"
              ).textContent;

            const nextDateTime = getNextDateTime(lastDateTime ?? "", -1);
            const archiveIndex = await buildArchiveIndex(nextDateTime);
            const nextTimeIndex = archiveIndex.findIndex(
              ({ time }) => time === nextDateTime.slice(-8)
            );

            const handleIndexUpdate = (index, existingIndexValues = []) => {
              index.forEach((i) => {
                existingIndexValues.push(i);
              });
              return existingIndexValues;
            };

            window.hackerNewsState = {
              index: handleIndexUpdate(
                archiveIndex,
                window.hackerNewsState.index
              ),
              nextTimeIndex,
            };

            let currentTimeIndex = nextTimeIndex + 1;
            const items = Object.values(window.hackerNewsState.index);
            for (let item of items) {
              if (currentTimeIndex < window.hackerNewsState.index.length) {
                addNewsItem(items[currentTimeIndex], queue);

                currentTimeIndex = currentTimeIndex + 1;
              }
            }

            queue.flush();
          }
        };

        const archives = document.getElementById("archives");
        const archivesObserver = new IntersectionObserver(
          (entries) => {
            const queue = new UpdateQueue();

            entries.forEach((entry) => handleIntersectingEntry(entry, queue));
          },
          {
            root: null,
            rootMargin: "0px",
            threshold: 0,
          }
        );

        archivesObserver.observe(archives);

        let latestSectionsExpanded = true;
        const handleLatestHeaderClick = () => {
          latestSectionsExpanded = !latestSectionsExpanded;

          if (latestSectionsExpanded) {
            archivesObserver.observe(archives);
          } else {
            archivesObserver.disconnect(archives);
          }

          for (let section of document.querySelectorAll("#latest > section")) {
            section.style.display = latestSectionsExpanded ? "block" : "none";
          }
        };

        const latestHeader = document.querySelector("#latest > h2");
        latestHeader.style.cursor = "pointer";
        latestHeader.addEventListener("click", handleLatestHeaderClick);
      }
    </script>
    <script type="module">
      import { Workbox } from "https://storage.googleapis.com/workbox-cdn/releases/6.4.1/workbox-window.prod.mjs";

      if ("serviceWorker" in navigator) {
        const base = document.querySelector("base");
        const serviceWorkerPath = `${
          base ? base.href.replace(/\/$/, "") : ""
        }/service-worker.js`;

        const wb = new Workbox(serviceWorkerPath);

        // setup event listeners
        wb.addEventListener("waiting", (event) => {
          wb.addEventListener("controlling", () => {
            window.location.reload();
          });

          wb.messageSkipWaiting();
        });

        wb.register();
      }
    </script>
  </body>
</html>
