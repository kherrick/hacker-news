<!DOCTYPE html>
<html lang="en" xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta charset="utf-8" />
    <meta
      content="width=device-width, initial-scale=1.0, viewport-fit=cover"
      name="viewport"
    />
    <meta name="description" content="Hacker News" />
    <meta name="theme-color" content="#fff" />
    <title>Hacker News</title>
    <link rel="manifest" href="manifest.json" />
    <link
      href="data:image/x-icon;base64,AAABAAEAAQECAAEAAQA4AAAAFgAAACgAAAABAAAAAgAAAAEAAQAAAAAAAAAAAAAAAAAAAAAAAAAAAAABAAEAAQECAAEAAQA4AAAAFgAAACgAAAABAAAAAgAAAAEAAQAAAAAAAAAAAAAAAAAAAAAAAAAA"
      rel="icon"
      type="image/x-icon"
    />
    <link
      href="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAgAAAAIAAQMAAADOtka5AAAAA1BMVEUAAACnej3aAAAANklEQVR42u3BAQEAAACCIP+vbkhAAQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAB8G4IAAAFjdVCkAAAAAElFTkSuQmCC"
      rel="apple-touch-icon"
    />
    <style>
      /*<!--*/
      body {
        color: rgb(25, 25, 25);
        font-family: Verdana, Geneva, sans-serif;
        margin: 0;
      }

      a {
        text-decoration: none;
      }

      a:link,
      a:focus,
      a:hover,
      a:active {
        color: rgb(75, 75, 125);
      }

      a:visited {
        color: rgb(25, 25, 25);
      }

      h1 > a,
      h1 > a:link,
      h1 > a:focus,
      h1 > a:hover,
      h1 > a:active,
      h1 > a:visited,
      h2 > a,
      h2 > a:link,
      h2 > a:focus,
      h2 > a:hover,
      h2 > a:active,
      h2 > a:visited {
        color: rgb(25, 25, 25);
      }

      h1 {
        background-color: rgb(255, 102, 0);
        margin: 0;
        padding: 1rem;
      }

      h2 {
        background-color: rgb(200, 200, 200);
        margin: 1rem 0;
        padding: 0.5rem 0.5rem 0.5rem 1rem;
      }

      #latest > section,
      #archives > section {
        margin: 0 1rem 1rem 1rem;
        padding-bottom: 1rem;
      }

      #latest > section:not(:last-child),
      #archives > section:not(:last-child) {
        border-bottom: 1px dotted rgb(200, 200, 200);
      }

      section > h3 {
        margin: 0 0 0.5rem 0;
      }

      section > h4 {
        font-weight: normal;
        margin: 0 0 0 1rem;
      }

      .descendants-container,
      .points-container {
        align-items: center;
        border-left: 1px solid #333;
        display: inline-flex;
        margin-left: 0.5rem;
        padding-left: 0.5rem;
        text-align: center;
      }

      .points {
        align-items: center;
        display: inline-flex;
        height: 1rem;
        margin-left: 1ch;
        min-width: 3ch;
      }

      .text {
        line-height: 1.5rem;
        margin: 1rem 1rem 0 1rem;
        overflow: auto;
      }

      .text > p:first-child {
        margin-top: 1rem;
      }

      .text > p:last-child {
        margin-bottom: 0;
      }
      /*-->*/
    </style>
  </head>

  <body>
    <main>
      <h1><a href="https://kherrick.github.io/hacker-news/">Hacker News</a></h1>
      <section id="latest">
        <h2>Latest</h2>
        <section id="35984928">
          <h3>
            <a class="item" href="https://www.bbc.com/news/technology-65622403"
              >One million cancel broadband as living costs rise (UK)</a
            >
          </h3>
          <section>
            <h4>
              <span>2023-05-18 @ 07:13:02</span
              ><span class="points-container"
                >Points: <span class="points">33</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=35984928"
                  >Comments</a
                ><span class="descendants">: 54</span></span
              >
            </h4>
          </section>
        </section>
        <section id="35984302">
          <h3>
            <a
              class="item"
              href="https://www.theguardian.com/technology/2023/may/18/we-are-losing-money-companies-in-apples-repair-program-say-they-cant-compete-with-tech-giant"
              >Companies in Apple’s repair program say they can’t compete with
              tech giant</a
            >
          </h3>
          <section>
            <h4>
              <span>2023-05-18 @ 05:07:18</span
              ><span class="points-container"
                >Points: <span class="points">36</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=35984302"
                  >Comments</a
                ><span class="descendants">: 14</span></span
              >
            </h4>
          </section>
        </section>
        <section id="35984101">
          <h3>
            <a class="item" href="https://icfp23.sigplan.org/"
              >ACM Sigplan ICFP will be in Seattle, WA, USA on 4–9 September
              2023</a
            >
          </h3>
          <section>
            <h4>
              <span>2023-05-18 @ 04:22:33</span
              ><span class="points-container"
                >Points: <span class="points">9</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=35984101"
                  >Comments</a
                ><span class="descendants">: 2</span></span
              >
            </h4>
          </section>
        </section>
        <section id="35984028">
          <h3>
            <a
              class="item"
              href="https://lareviewofbooks.org/article/the-work-of-the-audiobook/"
              >The Work of the Audiobook</a
            >
          </h3>
          <section>
            <h4>
              <span>2023-05-18 @ 04:06:38</span
              ><span class="points-container"
                >Points: <span class="points">22</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=35984028"
                  >Comments</a
                ><span class="descendants">: 8</span></span
              >
            </h4>
          </section>
        </section>
        <section id="35983876">
          <h3>
            <a
              class="item"
              href="https://utcc.utoronto.ca/~cks/space/blog/unix/DesktopsAlwaysThere"
              >Graphical Unix has always had desktop environments</a
            >
          </h3>
          <section>
            <h4>
              <span>2023-05-18 @ 03:30:40</span
              ><span class="points-container"
                >Points: <span class="points">35</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=35983876"
                  >Comments</a
                ><span class="descendants">: 11</span></span
              >
            </h4>
          </section>
        </section>
        <section id="35983866">
          <h3>
            <a
              class="item"
              href="https://www.downtowndougbrown.com/2023/05/what-happened-with-asus-routers-this-morning/"
              >What happened with ASUS routers this morning?</a
            >
          </h3>
          <section>
            <h4>
              <span>2023-05-18 @ 03:29:10</span
              ><span class="points-container"
                >Points: <span class="points">250</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=35983866"
                  >Comments</a
                ><span class="descendants">: 115</span></span
              >
            </h4>
          </section>
        </section>
        <section id="35983707">
          <h3>
            <a
              class="item"
              href="https://blog.yenniejun.com/p/all-languages-are-not-created-tokenized"
              >Language models cost 10x more in some languages than others</a
            >
          </h3>
          <section>
            <h4>
              <span>2023-05-18 @ 03:02:34</span
              ><span class="points-container"
                >Points: <span class="points">48</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=35983707"
                  >Comments</a
                ><span class="descendants">: 43</span></span
              >
            </h4>
          </section>
        </section>
        <section id="35983517">
          <h3>
            <a
              class="item"
              href="https://duckdb.org/2023/05/17/announcing-duckdb-080.html"
              >DuckDB 0.8</a
            >
          </h3>
          <section>
            <h4>
              <span>2023-05-18 @ 02:23:21</span
              ><span class="points-container"
                >Points: <span class="points">106</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=35983517"
                  >Comments</a
                ><span class="descendants">: 54</span></span
              >
            </h4>
          </section>
        </section>
        <section id="35983349">
          <h3>
            <a class="item" href="https://github.com/abiosoft/colima"
              >Colima: Container runtimes on macOS (and Linux) with minimal
              setup</a
            >
          </h3>
          <section>
            <h4>
              <span>2023-05-18 @ 01:47:31</span
              ><span class="points-container"
                >Points: <span class="points">62</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=35983349"
                  >Comments</a
                ><span class="descendants">: 16</span></span
              >
            </h4>
          </section>
        </section>
        <section id="35983012">
          <h3>
            <a
              class="item"
              href="https://www.vice.com/en/article/pkagbb/the-oldest-known-blueprints-depict-stone-age-megastructures"
              >The oldest known blueprints depict Stone Age ‘megastructures’</a
            >
          </h3>
          <section>
            <h4>
              <span>2023-05-18 @ 00:53:03</span
              ><span class="points-container"
                >Points: <span class="points">42</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=35983012"
                  >Comments</a
                ><span class="descendants">: 23</span></span
              >
            </h4>
          </section>
        </section>
        <section id="35982732">
          <h3>
            <a
              class="item"
              href="https://medium.com/airbnb-engineering/improving-performance-with-http-streaming-ba9e72c66408"
              >Improving Performance with HTTP Streaming</a
            >
          </h3>
          <section>
            <h4>
              <span>2023-05-17 @ 23:58:50</span
              ><span class="points-container"
                >Points: <span class="points">33</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=35982732"
                  >Comments</a
                ><span class="descendants">: 16</span></span
              >
            </h4>
          </section>
        </section>
        <section id="35982507">
          <h3>
            <a
              class="item"
              href="https://www.quantamagazine.org/new-math-shows-when-solar-systems-become-unstable-20230516/"
              >New proof finds the ‘ultimate instability’ in a solar system
              model</a
            >
          </h3>
          <section>
            <h4>
              <span>2023-05-17 @ 23:26:15</span
              ><span class="points-container"
                >Points: <span class="points">45</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=35982507"
                  >Comments</a
                ><span class="descendants">: 16</span></span
              >
            </h4>
          </section>
        </section>
        <section id="35982083">
          <h3>
            <a class="item" href="https://github.com/google/simhospital"
              >Simulated Hospital</a
            >
          </h3>
          <section>
            <h4>
              <span>2023-05-17 @ 22:34:25</span
              ><span class="points-container"
                >Points: <span class="points">106</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=35982083"
                  >Comments</a
                ><span class="descendants">: 35</span></span
              >
            </h4>
          </section>
        </section>
        <section id="35982037">
          <h3>
            <a class="item" href="https://github.com/yhzhang0128/egos-2000"
              >A minimal operating system (2K LOC) on QEMU and a RISC-V board</a
            >
          </h3>
          <section>
            <h4>
              <span>2023-05-17 @ 22:28:44</span
              ><span class="points-container"
                >Points: <span class="points">15</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=35982037"
                  >Comments</a
                ><span class="descendants">: 0</span></span
              >
            </h4>
          </section>
        </section>
        <section id="35981743">
          <h3>
            <a
              class="item"
              href="https://blog.gingerbeardman.com/2023/05/17/intelligentpad-component-based-drag-and-drop-software-creator/"
              >IntelligentPad (1989): a component-based drag-and-drop software
              creator</a
            >
          </h3>
          <section>
            <h4>
              <span>2023-05-17 @ 21:53:41</span
              ><span class="points-container"
                >Points: <span class="points">37</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=35981743"
                  >Comments</a
                ><span class="descendants">: 7</span></span
              >
            </h4>
          </section>
        </section>
        <section id="35981662">
          <h3>
            <a
              class="item"
              href="https://shaneosullivan.wordpress.com/2023/05/17/using-bun-js-as-a-bundler/"
              >Using Bun.js as a Bundler</a
            >
          </h3>
          <section>
            <h4>
              <span>2023-05-17 @ 21:46:39</span
              ><span class="points-container"
                >Points: <span class="points">106</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=35981662"
                  >Comments</a
                ><span class="descendants">: 32</span></span
              >
            </h4>
          </section>
        </section>
        <section id="35981311">
          <h3>
            <a
              class="item"
              href="https://www.wired.com/story/usps-mail-surveillance-letter/"
              >The US post office is spying on the mail – senators want to stop
              it</a
            >
          </h3>
          <section>
            <h4>
              <span>2023-05-17 @ 21:10:24</span
              ><span class="points-container"
                >Points: <span class="points">170</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=35981311"
                  >Comments</a
                ><span class="descendants">: 62</span></span
              >
            </h4>
          </section>
        </section>
        <section id="35981238">
          <h3>
            <a
              class="item"
              href="https://github.com/AdmTal/PostgreSQL-Query-Lock-Explainer"
              >Show HN: Postgres query lock explainer</a
            >
          </h3>
          <section>
            <h4>
              <span>2023-05-17 @ 21:02:14</span
              ><span class="points-container"
                >Points: <span class="points">107</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=35981238"
                  >Comments</a
                ><span class="descendants">: 12</span></span
              >
            </h4>
            <div class="text">
              <p>
                I made this tool - it’s kind of like “explain” but it tells you
                about what locks would be required by the query.
              </p>
              <p>
                I was making it as part of a larger tool that would try to
                prevent deadlocks during migrations at my last company, I never
                finished it.
              </p>
            </div>
          </section>
        </section>
        <section id="35980223">
          <h3>
            <a class="item" href="https://github.com/nickm980/smallville"
              >Show HN: Smallville – Create generative agents for simulations
              and games</a
            >
          </h3>
          <section>
            <h4>
              <span>2023-05-17 @ 19:41:16</span
              ><span class="points-container"
                >Points: <span class="points">83</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=35980223"
                  >Comments</a
                ><span class="descendants">: 18</span></span
              >
            </h4>
            <div class="text">
              <p>
                This project was intended to make it easy for anyone to create
                custom simulations and my attempt to recreate Generative Agents:
                Interactive Simulacra of Human Behavior. I’ve been working on
                Smallville for the past few weeks and hope other people also
                find it useful. Would love to hear any thoughts about the
                project and where I should take it from here.
              </p>
            </div>
          </section>
        </section>
        <section id="35979977">
          <h3>
            <a class="item" href="https://imslp.org/">Petrucci Music Library</a>
          </h3>
          <section>
            <h4>
              <span>2023-05-17 @ 19:22:22</span
              ><span class="points-container"
                >Points: <span class="points">217</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=35979977"
                  >Comments</a
                ><span class="descendants">: 60</span></span
              >
            </h4>
          </section>
        </section>
        <section id="35978864">
          <h3>
            <a class="item" href="https://github.com/ray-project/llm-numbers"
              >Numbers every LLM developer should know</a
            >
          </h3>
          <section>
            <h4>
              <span>2023-05-17 @ 17:50:07</span
              ><span class="points-container"
                >Points: <span class="points">351</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=35978864"
                  >Comments</a
                ><span class="descendants">: 83</span></span
              >
            </h4>
          </section>
        </section>
        <section id="35978757">
          <h3>
            <a
              class="item"
              href="https://blog.mastermind.dev/indexes-in-postgresql"
              >Understanding database indexes in PostgreSQL</a
            >
          </h3>
          <section>
            <h4>
              <span>2023-05-17 @ 17:42:15</span
              ><span class="points-container"
                >Points: <span class="points">224</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=35978757"
                  >Comments</a
                ><span class="descendants">: 12</span></span
              >
            </h4>
          </section>
        </section>
        <section id="35976488">
          <h3>
            <a class="item" href="https://beepberry.sqfmi.com/"
              >Show HN: Beepberry – a portable e-paper computer for hackers</a
            >
          </h3>
          <section>
            <h4>
              <span>2023-05-17 @ 15:13:53</span
              ><span class="points-container"
                >Points: <span class="points">539</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=35976488"
                  >Comments</a
                ><span class="descendants">: 185</span></span
              >
            </h4>
            <div class="text">
              <p>
                I wanted to create a ‘weekend’ device that would let me stay in
                touch with friends and family, without the distractions of a
                full smartphone. I imagined a tiny, hackable e-paper screen with
                a physical keyboard, powered by a Raspberry Pi, that I could use
                to chat around my home…and pretty much nothing else.
              </p>
              <p>
                Before Beeper, the idea probably would not have gone anywhere.
                Most chat apps do not have an API, making it practically
                impossible to hack something like this together. Enter Beeper,
                with connections to 15+ chat networks. Built on top of Matrix,
                Beeper is fully hackable. You can write alternative fun clients
                [1], bots [2] and more!
              </p>
              <p>
                Today, sqfmi is starting to take pre-orders at
                <a href="https://beepberry.sqfmi.com"
                  >https://beepberry.sqfmi.com</a
                >
                for the first batch. It’s $79 (or $99 including a Pi Zero).
                Specs: Sharp Memory LCD (same display tech as in Pebble!), Pi
                Zero (BT/WIFI), physical keyboard, 2000mAh lipo.
              </p>
              <p>
                On top of being an amazing Beeper chat device, it’s basically an
                e-paper Cyberdeck that fits in your pocket. It’s a ton of fun to
                hack on. Keep in mind - THIS IS NOT A REAL FINISHED PRODUCT.
                It’s basically a devkit.
              </p>
              <p>
                More info in the blog post:
                <a href="https://blog.beeper.com/p/beeper-x-sqmfi-beepberry"
                  >https://blog.beeper.com/p/beeper-x-sqmfi-beepberry</a
                >, or join the Discord/Matrix channel
                <a
                  href="https://beepberry.sqfmi.com/docs/getting-started#join-the-beepberry-discord"
                  >https://beepberry.sqfmi.com/docs/getting-started#join-the-be...</a
                >. I’ll hang out a bit here to answer questions as well.
              </p>
              <p>
                [0] <a href="https://beeper.com">https://beeper.com</a> [1]
                <a href="https://github.com/tulir/gomuks"
                  >https://github.com/tulir/gomuks</a
                >
                [2]
                <a href="https://github.com/maubot/maubot"
                  >https://github.com/maubot/maubot</a
                >
              </p>
            </div>
          </section>
        </section>
        <section id="35970604">
          <h3>
            <a
              class="item"
              href="https://www.theparisreview.org/blog/2023/05/15/the-dress-diary-of-mrs-anne-sykes/#more-164077"
              >The Dress Diary of Mrs. Anne Sykes</a
            >
          </h3>
          <section>
            <h4>
              <span>2023-05-17 @ 02:29:44</span
              ><span class="points-container"
                >Points: <span class="points">15</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=35970604"
                  >Comments</a
                ><span class="descendants">: 0</span></span
              >
            </h4>
          </section>
        </section>
        <section id="35960743">
          <h3>
            <a class="item" href="http://literateprogramming.com/articles.html"
              >Literate Programming: Articles</a
            >
          </h3>
          <section>
            <h4>
              <span>2023-05-16 @ 12:14:02</span
              ><span class="points-container"
                >Points: <span class="points">6</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=35960743"
                  >Comments</a
                ><span class="descendants">: 1</span></span
              >
            </h4>
          </section>
        </section>
        <section id="35960116">
          <h3>
            <a
              class="item"
              href="https://nawalcooking.blogspot.com/2021/06/medieval-arabs-ate-sandwiches-too-keep.html"
              >Medieval Arabs ate sandwiches too? (2021)</a
            >
          </h3>
          <section>
            <h4>
              <span>2023-05-16 @ 11:04:39</span
              ><span class="points-container"
                >Points: <span class="points">21</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=35960116"
                  >Comments</a
                ><span class="descendants">: 22</span></span
              >
            </h4>
          </section>
        </section>
        <section id="35959502">
          <h3>
            <a
              class="item"
              href="https://people.mpi-inf.mpg.de/~mehlhorn/ftp/Mehlhorn-Sanders-Toolbox.pdf"
              >Algorithms and Data Structures (2007) [pdf]</a
            >
          </h3>
          <section>
            <h4>
              <span>2023-05-16 @ 09:35:40</span
              ><span class="points-container"
                >Points: <span class="points">56</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=35959502"
                  >Comments</a
                ><span class="descendants">: 2</span></span
              >
            </h4>
          </section>
        </section>
        <section id="35958673">
          <h3>
            <a class="item" href="https://www.bbc.co.uk/sport/65568403"
              >The Speed Project: A Race Between Los Angeles and Las Vegas</a
            >
          </h3>
          <section>
            <h4>
              <span>2023-05-16 @ 07:23:00</span
              ><span class="points-container"
                >Points: <span class="points">22</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=35958673"
                  >Comments</a
                ><span class="descendants">: 9</span></span
              >
            </h4>
          </section>
        </section>
        <section id="35958590">
          <h3>
            <a
              class="item"
              href="https://www.theguardian.com/environment/2023/may/16/the-war-on-japanese-knotweed"
              >The war on Japanese knotweed</a
            >
          </h3>
          <section>
            <h4>
              <span>2023-05-16 @ 07:08:22</span
              ><span class="points-container"
                >Points: <span class="points">49</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=35958590"
                  >Comments</a
                ><span class="descendants">: 22</span></span
              >
            </h4>
          </section>
        </section>
        <section id="35954306">
          <h3>
            <a
              class="item"
              href="https://www.historytoday.com/archive/out-margins/old-traditions-and-new-hopes"
              >Old Traditions and New Hopes</a
            >
          </h3>
          <section>
            <h4>
              <span>2023-05-15 @ 20:50:22</span
              ><span class="points-container"
                >Points: <span class="points">6</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=35954306"
                  >Comments</a
                ><span class="descendants">: 0</span></span
              >
            </h4>
          </section>
        </section>
      </section>
      <section id="archives">
        <h2>
          <a
            href="https://github.com/kherrick/hacker-news/blob/main/archives/index.md"
            >Archives</a
          >
        </h2>
        <section>
          <h3>
            <a
              href="https://github.com/kherrick/hacker-news/blob/main/archives/2023/index.md"
              >2023</a
            >
          </h3>
        </section>
        <section>
          <h3>
            <a
              href="https://github.com/kherrick/hacker-news/blob/main/archives/2022/index.md"
              >2022</a
            >
          </h3>
        </section>
      </section>
    </main>
    <script type="module">
      import { buildDescendants } from "./lib/build-html-descendants.js";
      import { buildNextItem } from "./lib/build-html-next-item.js";
      import { getNextDateTime } from "./lib/date-time.js";

      const updateSectionById = (id) =>
        fetch(`https://hacker-news.firebaseio.com/v0/item/${id}.json`).then(
          (result) =>
            result.json().then(({ descendants, id, score, text, type }) => {
              const currentItem = document.getElementById(id);

              if (score) {
                currentItem.querySelector(".points").textContent = score;
              }

              if (descendants && (type === "poll" || type === "story")) {
                const currentDescendants =
                  currentItem.querySelector(".descendants");

                if (currentDescendants) {
                  currentDescendants.textContent = `: ${descendants}`;
                } else {
                  const comments = buildDescendants(
                    document,
                    descendants,
                    `https://news.ycombinator.com/item?id=${id}`
                  );

                  currentItem.querySelector("h4").appendChild(comments);
                }
              }

              if (text) {
                const currentText = currentItem.querySelector(".text");

                if (currentText) {
                  currentText.innerHTML = text.replace(/\0/g, "");
                } else {
                  const content = document.createElement("div");
                  content.innerHTML = text.replace(/\0/g, "");
                  content.setAttribute("class", "text");

                  currentItem.appendChild(content);
                }
              }
            })
        );

      class UpdateQueue {
        constructor() {
          this._ids = [];
          this._isUpdating = false;
        }

        addItemById(id) {
          this._ids.push(id);
        }

        async flush() {
          const id = this._ids.shift();

          if (id) {
            this._isUpdating = true;

            await updateSectionById(id);
            await this.flush();
          } else {
            this._isUpdating = false;

            setTimeout(async () => {
              if (!this._isUpdating && this._ids && this._ids.length) {
                await this.flush();
              }
            }, 0);
          }
        }
      }

      // get latest data
      const latestSection = document.getElementById("latest");

      for (let item of latestSection.querySelectorAll("section[id]")) {
        updateSectionById(item.getAttribute("id"));
      }

      if ("IntersectionObserver" in window) {
        window.hackerNewsState = { index: [], nextTimeIndex: -1 };

        const addNewsItem = async (newsItem, queue) => {
          try {
            const { date, time, itemComments, itemTitle, itemLink } = newsItem;
            const section = await buildNextItem({
              document,
              dateTime: `${date}, ${time}`,
              itemComments,
              itemLink,
              itemTitle: new DOMParser().parseFromString(
                itemTitle.replace(/\\/g, ""),
                "text/html"
              ).documentElement.textContent,
              fetchItemDetails: false,
            });

            // display loading indicator for section
            section.querySelector(".points-container").innerHTML =
              'Points: <span class="points"><img style="height: 100%;" src="lib/images/loading.svg" /></span>';

            const id = section.getAttribute("id");
            if (!document.getElementById(id)) {
              document.getElementById("latest").appendChild(section);

              queue.addItemById(id);
            }
          } catch (error) {}
        };

        const buildArchiveIndex = async (lastDateTime) => {
          const nextDate = lastDateTime.slice(0, 10);
          const nextYear = nextDate.slice(0, 4);

          return (
            await (
              await fetch(
                `https://raw.githubusercontent.com/kherrick/hacker-news/main/archives/${nextYear}/${nextDate}/index.md`
              )
            ).text()
          )
            .split("\n")
            .filter((line) => line.match(new RegExp("^\\* \\[")))
            .map((line) => {
              const segment = line.replace("* ", "").split("](");
              const pubDate = segment[0].slice(1);

              const itemComments = segment[1].split(") - [")[0];
              const itemTitle = segment[1].split(") - [")[1];
              const itemLink = segment[2].slice(0, -1);
              const date = pubDate.slice(0, 10);
              const time = pubDate.slice(-8);

              return {
                date,
                itemComments,
                itemLink,
                itemTitle,
                time,
              };
            });
        };

        const handleIntersectingEntry = async (entry, queue) => {
          if (entry.isIntersecting) {
            const lastDateTime = document
              .getElementById("latest")
              .querySelector(
                "section:last-child > section > h4 > span"
              ).textContent;

            const nextDateTime = getNextDateTime(lastDateTime ?? "", -1);
            const archiveIndex = await buildArchiveIndex(nextDateTime);
            const nextTimeIndex = archiveIndex.findIndex(
              ({ time }) => time === nextDateTime.slice(-8)
            );

            const handleIndexUpdate = (index, existingIndexValues = []) => {
              index.forEach((i) => {
                existingIndexValues.push(i);
              });
              return existingIndexValues;
            };

            window.hackerNewsState = {
              index: handleIndexUpdate(
                archiveIndex,
                window.hackerNewsState.index
              ),
              nextTimeIndex,
            };

            let currentTimeIndex = nextTimeIndex + 1;
            const items = Object.values(window.hackerNewsState.index);
            for (let item of items) {
              if (currentTimeIndex < window.hackerNewsState.index.length) {
                addNewsItem(items[currentTimeIndex], queue);

                currentTimeIndex = currentTimeIndex + 1;
              }
            }

            queue.flush();
          }
        };

        const archives = document.getElementById("archives");
        const archivesObserver = new IntersectionObserver(
          (entries) => {
            const queue = new UpdateQueue();

            entries.forEach((entry) => handleIntersectingEntry(entry, queue));
          },
          {
            root: null,
            rootMargin: "0px",
            threshold: 0,
          }
        );

        archivesObserver.observe(archives);

        let latestSectionsExpanded = true;
        const handleLatestHeaderClick = () => {
          latestSectionsExpanded = !latestSectionsExpanded;

          if (latestSectionsExpanded) {
            archivesObserver.observe(archives);
          } else {
            archivesObserver.disconnect(archives);
          }

          for (let section of document.querySelectorAll("#latest > section")) {
            section.style.display = latestSectionsExpanded ? "block" : "none";
          }
        };

        const latestHeader = document.querySelector("#latest > h2");
        latestHeader.style.cursor = "pointer";
        latestHeader.addEventListener("click", handleLatestHeaderClick);
      }
    </script>
    <script type="module">
      import { Workbox } from "https://storage.googleapis.com/workbox-cdn/releases/6.4.1/workbox-window.prod.mjs";

      if ("serviceWorker" in navigator) {
        const base = document.querySelector("base");
        const serviceWorkerPath = `${
          base ? base.href.replace(/\/$/, "") : ""
        }/service-worker.js`;

        const wb = new Workbox(serviceWorkerPath);

        // setup event listeners
        wb.addEventListener("waiting", (event) => {
          wb.addEventListener("controlling", () => {
            window.location.reload();
          });

          wb.messageSkipWaiting();
        });

        wb.register();
      }
    </script>
  </body>
</html>
