<!DOCTYPE html>
<html lang="en" xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta charset="utf-8" />
    <meta
      content="width=device-width, initial-scale=1.0, viewport-fit=cover"
      name="viewport"
    />
    <meta name="description" content="Hacker News" />
    <meta name="theme-color" content="#fff" />
    <title>Hacker News</title>
    <link rel="manifest" href="manifest.json" />
    <link
      href="data:image/x-icon;base64,AAABAAEAAQECAAEAAQA4AAAAFgAAACgAAAABAAAAAgAAAAEAAQAAAAAAAAAAAAAAAAAAAAAAAAAAAAABAAEAAQECAAEAAQA4AAAAFgAAACgAAAABAAAAAgAAAAEAAQAAAAAAAAAAAAAAAAAAAAAAAAAA"
      rel="icon"
      type="image/x-icon"
    />
    <link
      href="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAgAAAAIAAQMAAADOtka5AAAAA1BMVEUAAACnej3aAAAANklEQVR42u3BAQEAAACCIP+vbkhAAQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAB8G4IAAAFjdVCkAAAAAElFTkSuQmCC"
      rel="apple-touch-icon"
    />
    <style>
      /*<!--*/
      body {
        color: rgb(25, 25, 25);
        font-family: Verdana, Geneva, sans-serif;
        margin: 0;
      }

      a {
        text-decoration: none;
      }

      a:link,
      a:focus,
      a:hover,
      a:active {
        color: rgb(75, 75, 125);
      }

      a:visited {
        color: rgb(25, 25, 25);
      }

      h1 > a,
      h1 > a:link,
      h1 > a:focus,
      h1 > a:hover,
      h1 > a:active,
      h1 > a:visited,
      h2 > a,
      h2 > a:link,
      h2 > a:focus,
      h2 > a:hover,
      h2 > a:active,
      h2 > a:visited {
        color: rgb(25, 25, 25);
      }

      h1 {
        background-color: rgb(255, 102, 0);
        margin: 0;
        padding: 1rem;
      }

      h2 {
        background-color: rgb(200, 200, 200);
        margin: 1rem 0;
        padding: 0.5rem 0.5rem 0.5rem 1rem;
      }

      #latest > section,
      #archives > section {
        margin: 0 1rem 1rem 1rem;
        padding-bottom: 1rem;
      }

      #latest > section:not(:last-child),
      #archives > section:not(:last-child) {
        border-bottom: 1px dotted rgb(200, 200, 200);
      }

      section > h3 {
        margin: 0 0 0.5rem 0;
      }

      section > h4 {
        font-weight: normal;
        margin: 0 0 0 1rem;
      }

      .descendants-container,
      .points-container {
        align-items: center;
        border-left: 1px solid #333;
        display: inline-flex;
        margin-left: 0.5rem;
        padding-left: 0.5rem;
        text-align: center;
      }

      .points {
        align-items: center;
        display: inline-flex;
        height: 1rem;
        margin-left: 1ch;
        min-width: 3ch;
      }

      .text {
        line-height: 1.5rem;
        margin: 1rem 1rem 0 1rem;
        overflow: auto;
      }

      .text > p:first-child {
        margin-top: 1rem;
      }

      .text > p:last-child {
        margin-bottom: 0;
      }
      /*-->*/
    </style>
  </head>

  <body>
    <main>
      <h1><a href="https://kherrick.github.io/hacker-news/">Hacker News</a></h1>
      <section id="latest">
        <h2>Latest</h2>
        <section id="37138807">
          <h3>
            <a
              class="item"
              href="https://langdev.stackexchange.com/questions/2692/how-should-i-read-type-system-notation"
              >How should I read type system notation?</a
            >
          </h3>
          <section>
            <h4>
              <span>2023-08-15 @ 20:15:27</span
              ><span class="points-container"
                >Points: <span class="points">76</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=37138807"
                  >Comments</a
                ><span class="descendants">: 15</span></span
              >
            </h4>
          </section>
        </section>
        <section id="37138691">
          <h3>
            <a
              class="item"
              href="https://arstechnica.com/gadgets/2023/08/the-printers-that-require-ink-to-scan-and-fax/"
              >Requiring ink to scan a document–yet another insult from the
              printer industry</a
            >
          </h3>
          <section>
            <h4>
              <span>2023-08-15 @ 20:06:17</span
              ><span class="points-container"
                >Points: <span class="points">124</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=37138691"
                  >Comments</a
                ><span class="descendants">: 50</span></span
              >
            </h4>
          </section>
        </section>
        <section id="37138681">
          <h3>
            <a
              class="item"
              href="https://arstechnica.com/tech-policy/2023/08/isps-complain-that-listing-every-fee-is-too-hard-urge-fcc-to-scrap-new-rule/"
              >ISPs complain that listing every fee is too hard, urge FCC to
              scrap new rule</a
            >
          </h3>
          <section>
            <h4>
              <span>2023-08-15 @ 20:05:43</span
              ><span class="points-container"
                >Points: <span class="points">113</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=37138681"
                  >Comments</a
                ><span class="descendants">: 69</span></span
              >
            </h4>
          </section>
        </section>
        <section id="37138672">
          <h3>
            <a
              class="item"
              href="https://nonint.com/2022/05/30/my-deep-learning-rig/"
              >My Deep Learning Rig</a
            >
          </h3>
          <section>
            <h4>
              <span>2023-08-15 @ 20:05:06</span
              ><span class="points-container"
                >Points: <span class="points">13</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=37138672"
                  >Comments</a
                ><span class="descendants">: 3</span></span
              >
            </h4>
          </section>
        </section>
        <section id="37138102">
          <h3>
            <a
              class="item"
              href="https://newton.spacedys.com/neodys2/NEOScan/risk_page/ZTm0038/index_summary_ZTm0038.html"
              >Asteroid ZTm0038 with a &amp;gt;3% impact probability</a
            >
          </h3>
          <section>
            <h4>
              <span>2023-08-15 @ 19:19:16</span
              ><span class="points-container"
                >Points: <span class="points">159</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=37138102"
                  >Comments</a
                ><span class="descendants">: 139</span></span
              >
            </h4>
          </section>
        </section>
        <section id="37137810">
          <h3>
            <a class="item" href="https://probml.github.io/pml-book/book2.html"
              >Probabilistic Machine Learning: Advanced Topics</a
            >
          </h3>
          <section>
            <h4>
              <span>2023-08-15 @ 18:57:16</span
              ><span class="points-container"
                >Points: <span class="points">59</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=37137810"
                  >Comments</a
                ><span class="descendants">: 10</span></span
              >
            </h4>
          </section>
        </section>
        <section id="37137110">
          <h3>
            <a
              class="item"
              href="https://blog.redplanetlabs.com/2023/08/15/how-we-reduced-the-cost-of-building-twitter-at-twitter-scale-by-100x/"
              >We reduced the cost of building Mastodon at Twitter-scale by
              100x</a
            >
          </h3>
          <section>
            <h4>
              <span>2023-08-15 @ 17:54:13</span
              ><span class="points-container"
                >Points: <span class="points">556</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=37137110"
                  >Comments</a
                ><span class="descendants">: 219</span></span
              >
            </h4>
          </section>
        </section>
        <section id="37136898">
          <h3>
            <a class="item" href="https://github.com/varunshenoy/opendream"
              >Opendream: A layer-based UI for Stable Diffusion</a
            >
          </h3>
          <section>
            <h4>
              <span>2023-08-15 @ 17:38:10</span
              ><span class="points-container"
                >Points: <span class="points">236</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=37136898"
                  >Comments</a
                ><span class="descendants">: 38</span></span
              >
            </h4>
          </section>
        </section>
        <section id="37136340">
          <h3>
            <a
              class="item"
              href="https://www.ycombinator.com/companies/seam/jobs/9VKC412-product-manager"
              >Seam (YC S20), API for IoT, Is Hiring a Founding PM</a
            >
          </h3>
          <section>
            <h4>
              <span>2023-08-15 @ 17:00:32</span
              ><span class="points-container"
                >Points: <span class="points">1</span></span
              >
            </h4>
          </section>
        </section>
        <section id="37134520">
          <h3>
            <a class="item" href="https://gigamonkeys.com/code-reading/"
              >Code Is Not Literature (2014)</a
            >
          </h3>
          <section>
            <h4>
              <span>2023-08-15 @ 14:36:35</span
              ><span class="points-container"
                >Points: <span class="points">160</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=37134520"
                  >Comments</a
                ><span class="descendants">: 117</span></span
              >
            </h4>
          </section>
        </section>
        <section id="37134293">
          <h3>
            <a class="item" href="https://github.com/ergomake/layerform"
              >Show HN: Layerform – Open-source development environments using
              Terraform files</a
            >
          </h3>
          <section>
            <h4>
              <span>2023-08-15 @ 14:15:51</span
              ><span class="points-container"
                >Points: <span class="points">69</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=37134293"
                  >Comments</a
                ><span class="descendants">: 12</span></span
              >
            </h4>
            <div class="text">
              <p>
                Whenever engineers run layerform spawn, we use plain .tf files
                to give them their own "staging" environment that looks just
                like production.
              </p>
              <p>
                Many teams have a single (or too few) staging environments,
                which developers have to queue to use. This is particularly a
                problem when a system is large, because then engineers can't run
                it on their machines and cannot easily test their changes in a
                production-like environment. Often they end up with a cluttered
                Slack channel in which engineers wait for their turn to use
                staging. Sometimes, they don't even have that clunky channel and
                end up merging broken code or shipping bugs to production. Lucas
                and I decided to solve this because we previously suffered with
                shared staging environments.
              </p>
              <p>
                Layerform gives each developer their own production-like
                environment.This eliminates the bottleneck, increasing the
                number of deploys engineers make. Additionally, it reduces the
                amount of bugs and rework because developers have a
                production-like environment to develop and test against. They
                can just run "layerform spawn" and get their own staging.
              </p>
              <p>
                We wrap the MPL-licensed Terraform and allow engineers to
                encapsulate each part of their infrastructure into layers. They
                can then create multiple instances of a particular layer to
                create a development environment.The benefit of using layers
                instead of raw Terraform modules is that they're much easier to
                write and reuse, meaning multiple development environments can
                run on top of the same infrastructure.
              </p>
              <p>
                Layerform's environments are quick and cheap to spin up because
                they share core pieces of infrastructure. Additionally,
                Layerform can automatically tag components in each layer, making
                it easier for FinOps teams to manage costs and do chargebacks.
              </p>
              <p>
                For example: with Layerform, a product developer can spin up
                their own lambdas and pods for staging while still using a
                shared Kubernetes cluster and Kafka instance. That way,
                development environments are quicker to spin up and cheaper to
                maintain. Each developer's layer also gets a tag, meaning FinOps
                teams know how much each team's environments cost.
              </p>
              <p>
                For the sake of transparency, the way we intend to make money is
                by providing a managed service with governance, management, and
                cost-control features, including turning off environments
                automatically on inactivity or after business hours. The
                Layerform CLI itself will remain free and open (GPL).
              </p>
              <p>
                You can download the Layerform CLI right now and use it for
                free. Currently, all the state, permissions, and layer
                definitions stay in your cloud, under your control.
              </p>
              <p>
                After the whole license change thing, I think it's also worth
                mentioning we'll be building on top of the community's fork and
                will consider adding support for Pulumi too.
              </p>
              <p>
                We'd love your feedback on our solution to eliminate “the
                staging bottleneck". What do you think?
              </p>
            </div>
          </section>
        </section>
        <section id="37134092">
          <h3>
            <a
              class="item"
              href="https://www.phoronix.com/news/Firefox-Faster-SunSpider"
              >Firefox finally outperforming Google Chrome in SunSpider</a
            >
          </h3>
          <section>
            <h4>
              <span>2023-08-15 @ 13:58:44</span
              ><span class="points-container"
                >Points: <span class="points">720</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=37134092"
                  >Comments</a
                ><span class="descendants">: 350</span></span
              >
            </h4>
          </section>
        </section>
        <section id="37134089">
          <h3>
            <a
              class="item"
              href="https://thenewstack.io/entrepreneurship-for-engineers-selling-open-source-software/"
              >Selling open-source software</a
            >
          </h3>
          <section>
            <h4>
              <span>2023-08-15 @ 13:58:17</span
              ><span class="points-container"
                >Points: <span class="points">133</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=37134089"
                  >Comments</a
                ><span class="descendants">: 53</span></span
              >
            </h4>
          </section>
        </section>
        <section id="37133504">
          <h3>
            <a
              class="item"
              href="http://marble.onl/posts/why_host_your_own_llm.html"
              >Why host your own LLM?</a
            >
          </h3>
          <section>
            <h4>
              <span>2023-08-15 @ 13:06:31</span
              ><span class="points-container"
                >Points: <span class="points">207</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=37133504"
                  >Comments</a
                ><span class="descendants">: 103</span></span
              >
            </h4>
          </section>
        </section>
        <section id="37133163">
          <h3>
            <a
              class="item"
              href="https://github.com/Dicklesworthstone/llama_embeddings_fastapi_service"
              >Show HN: Llama2 Embeddings FastAPI Server</a
            >
          </h3>
          <section>
            <h4>
              <span>2023-08-15 @ 12:31:27</span
              ><span class="points-container"
                >Points: <span class="points">145</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=37133163"
                  >Comments</a
                ><span class="descendants">: 26</span></span
              >
            </h4>
            <div class="text">
              <p>
                It lets you not only submit text strings and get back the
                embeddings, but also to compare two strings and get back their
                similarity score (i.e., the cosine similarity of their embedding
                vectors). You can also upload a plaintext file or PDF and get
                back all the embeddings for every sentence in the file as a
                zipped JSON file (and you can specify the layout of this JSON
                file).
              </p>
              <p>
                Each time an embedding is computed for a given string with a
                given LLM, that vector is stored in the SQlite database and can
                be returned immediately. You can also search across all stored
                vectors easily using a query string; this uses FAISS which is
                integrated.
              </p>
              <p>
                There are lots of nice performance enhancements, including
                parallel inference, db write queue, fully async everything, and
                even a RAM Disk feature to speed up model loading.
              </p>
              <p>
                I’m working now on adding additional API endpoints for easily
                generating sentiment scores using presets for different focus
                areas, but that’s still work-in-progress (the code for this so
                far is in the repo though).
              </p>
            </div>
          </section>
        </section>
        <section id="37133128">
          <h3>
            <a class="item" href="https://www.lottielab.com/"
              >Show HN: Lottielab – Create product animations in the browser
              easily</a
            >
          </h3>
          <section>
            <h4>
              <span>2023-08-15 @ 12:28:20</span
              ><span class="points-container"
                >Points: <span class="points">24</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=37133128"
                  >Comments</a
                ><span class="descendants">: 3</span></span
              >
            </h4>
            <div class="text">
              Hi HN! Today we are releasing Lottielab, a web-based animation
              tool, to the public as an open beta. The main tool for editing and
              exporting Lottie animations today is Adobe After Effects, a
              30-year-old visual effects tool that’s not fit for this purpose,
              has a steep learning curve, and requires a patchwork of
              error-prone plugins. With Lottielab, we are aiming to reduce the
              friction of creating and editing product animations by providing
              an easy-to-use editor with out-of-the-box support for import and
              export of the Lottie format and many others. Feel free to play
              around with the tool and let me know what you think - I'm here to
              answer your questions. Happy animating!
            </div>
          </section>
        </section>
        <section id="37133054">
          <h3>
            <a class="item" href="https://opentf.org/">The OpenTF Manifesto</a>
          </h3>
          <section>
            <h4>
              <span>2023-08-15 @ 12:19:33</span
              ><span class="points-container"
                >Points: <span class="points">439</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=37133054"
                  >Comments</a
                ><span class="descendants">: 252</span></span
              >
            </h4>
          </section>
        </section>
        <section id="37133033">
          <h3>
            <a
              class="item"
              href="https://www.polygon.com/23827844/nintendo-ds-dsi-3ds-camera-lofi-photo-trend"
              >Nintendo DS cameras are the best lo-fi photo trend</a
            >
          </h3>
          <section>
            <h4>
              <span>2023-08-15 @ 12:17:14</span
              ><span class="points-container"
                >Points: <span class="points">108</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=37133033"
                  >Comments</a
                ><span class="descendants">: 70</span></span
              >
            </h4>
          </section>
        </section>
        <section id="37133023">
          <h3>
            <a
              class="item"
              href="https://nautil.us/why-darwin-admired-the-humble-earthworm-361515/"
              >Why Darwin admired the humble earthworm</a
            >
          </h3>
          <section>
            <h4>
              <span>2023-08-15 @ 12:16:10</span
              ><span class="points-container"
                >Points: <span class="points">28</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=37133023"
                  >Comments</a
                ><span class="descendants">: 6</span></span
              >
            </h4>
          </section>
        </section>
        <section id="37132651">
          <h3>
            <a class="item" href="https://servicer.dev"
              >Show HN: Servicer, pm2 alternative built on Rust and systemd</a
            >
          </h3>
          <section>
            <h4>
              <span>2023-08-15 @ 11:34:26</span
              ><span class="points-container"
                >Points: <span class="points">134</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=37132651"
                  >Comments</a
                ><span class="descendants">: 36</span></span
              >
            </h4>
            <div class="text">
              <p>
                Servicer abstracts this setup behind an easy to use CLI, for
                instance you can use `ser create index.js --interpreter node
                --enable --start` to create a `.service` file, enable it on boot
                and start it. Servicer will also help if you wish to write your
                own custom `.service` files. Run `ser edit foo --editor vi` to
                create a service file in Vim. Servicer will provide a starting
                template so you don't need to google it. There are additional
                utilities like `ser which index.js` to view the path of the
                service and unit file.
              </p>
              <p>
                ``` Paths for index.js.ser.service:
                +--------------+-----------------------------------------------------------+
                | name | path |
                +--------------+-----------------------------------------------------------+
                | Service file | /etc/systemd/system/index.js.ser.service |
                +--------------+-----------------------------------------------------------+
                | Unit file |
                /org/freedesktop/systemd1/unit/index_2ejs_2eser_2eservice |
                +--------------+-----------------------------------------------------------+
                ```
              </p>
              <p>
                Servicer is daemonless and does not run in the background. It
                simply sets up systemd and gets out of the way. There are no
                forked services, everything is natively set up on systemd. You
                don't need to worry about resource consumption or servicer going
                down which will cause your app to stop.
              </p>
              <p>
                Do give it a spin and review the codebase. The code is open
                source and MIT licensed-
                <a href="https://github.com/servicer-labs/servicer"
                  >https://github.com/servicer-labs/servicer</a
                >
              </p>
            </div>
          </section>
        </section>
        <section id="37131957">
          <h3>
            <a class="item" href="https://tristam.ie/2023/758/"
              >Privacy friendly ESP32 smart doorbell with Home Assistant local
              integration</a
            >
          </h3>
          <section>
            <h4>
              <span>2023-08-15 @ 09:46:12</span
              ><span class="points-container"
                >Points: <span class="points">290</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=37131957"
                  >Comments</a
                ><span class="descendants">: 138</span></span
              >
            </h4>
          </section>
        </section>
        <section id="37131808">
          <h3>
            <a
              class="item"
              href="http://sims.durgadas.com/punchcards/ibm029.html"
              >Virtual IBM Punch Card Data Processing (2018)</a
            >
          </h3>
          <section>
            <h4>
              <span>2023-08-15 @ 09:19:00</span
              ><span class="points-container"
                >Points: <span class="points">5</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=37131808"
                  >Comments</a
                ><span class="descendants">: 0</span></span
              >
            </h4>
          </section>
        </section>
        <section id="37129799">
          <h3>
            <a
              class="item"
              href="https://archive.org/details/wrightsbookofpou00wrig"
              >Wright's Book of Poultry (1911)</a
            >
          </h3>
          <section>
            <h4>
              <span>2023-08-15 @ 03:24:18</span
              ><span class="points-container"
                >Points: <span class="points">15</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=37129799"
                  >Comments</a
                ><span class="descendants">: 4</span></span
              >
            </h4>
          </section>
        </section>
        <section id="37129764">
          <h3>
            <a
              class="item"
              href="https://www.youtube.com/playlist?list=PLA_-EWSPTJcu4i7RFCl_KeGrrz37C4_Oc"
              >Functional Programming 1</a
            >
          </h3>
          <section>
            <h4>
              <span>2023-08-15 @ 03:18:18</span
              ><span class="points-container"
                >Points: <span class="points">5</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=37129764"
                  >Comments</a
                ><span class="descendants">: 3</span></span
              >
            </h4>
          </section>
        </section>
        <section id="37129417">
          <h3>
            <a
              class="item"
              href="https://www.newyorker.com/magazine/2023/08/21/the-man-who-organized-nature-the-life-of-linnaeus-gunnar-broberg-book-review"
              >Carl Linnaeus Set Out to Label All of Life</a
            >
          </h3>
          <section>
            <h4>
              <span>2023-08-15 @ 02:22:52</span
              ><span class="points-container"
                >Points: <span class="points">37</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=37129417"
                  >Comments</a
                ><span class="descendants">: 13</span></span
              >
            </h4>
          </section>
        </section>
        <section id="37128929">
          <h3>
            <a
              class="item"
              href="https://www.gosh.org/about-us/peter-pan/copyright/"
              >Peter Pan Copyright</a
            >
          </h3>
          <section>
            <h4>
              <span>2023-08-15 @ 01:10:56</span
              ><span class="points-container"
                >Points: <span class="points">29</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=37128929"
                  >Comments</a
                ><span class="descendants">: 10</span></span
              >
            </h4>
          </section>
        </section>
        <section id="37128885">
          <h3>
            <a
              class="item"
              href="https://www.nature.com/articles/d41586-023-02555-z"
              >How to be successful as a research mathematician? Follow your
              gut</a
            >
          </h3>
          <section>
            <h4>
              <span>2023-08-15 @ 01:06:03</span
              ><span class="points-container"
                >Points: <span class="points">61</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=37128885"
                  >Comments</a
                ><span class="descendants">: 32</span></span
              >
            </h4>
          </section>
        </section>
        <section id="37125337">
          <h3>
            <a
              class="item"
              href="https://store.steampowered.com/app/2262930/Bombe/"
              >Bombe: Minesweeper, but you only solve each situation once</a
            >
          </h3>
          <section>
            <h4>
              <span>2023-08-14 @ 19:04:43</span
              ><span class="points-container"
                >Points: <span class="points">76</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=37125337"
                  >Comments</a
                ><span class="descendants">: 23</span></span
              >
            </h4>
          </section>
        </section>
        <section id="37119795">
          <h3>
            <a
              class="item"
              href="https://www.wired.com/story/archiving-hip-hop-history/"
              >Hip hop historians who are racing to preserve its story</a
            >
          </h3>
          <section>
            <h4>
              <span>2023-08-14 @ 11:30:50</span
              ><span class="points-container"
                >Points: <span class="points">127</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=37119795"
                  >Comments</a
                ><span class="descendants">: 101</span></span
              >
            </h4>
          </section>
        </section>
        <section id="37118239">
          <h3>
            <a
              class="item"
              href="https://leancrew.com/all-this/2023/08/decimal-to-fraction/"
              >Decimal to fraction</a
            >
          </h3>
          <section>
            <h4>
              <span>2023-08-14 @ 06:56:11</span
              ><span class="points-container"
                >Points: <span class="points">71</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=37118239"
                  >Comments</a
                ><span class="descendants">: 33</span></span
              >
            </h4>
          </section>
        </section>
      </section>
      <section id="archives">
        <h2>
          <a
            href="https://github.com/kherrick/hacker-news/blob/main/archives/index.md"
            >Archives</a
          >
        </h2>
        <section>
          <h3>
            <a
              href="https://github.com/kherrick/hacker-news/blob/main/archives/2023/index.md"
              >2023</a
            >
          </h3>
        </section>
        <section>
          <h3>
            <a
              href="https://github.com/kherrick/hacker-news/blob/main/archives/2022/index.md"
              >2022</a
            >
          </h3>
        </section>
      </section>
    </main>
    <script type="module">
      import { buildDescendants } from "./lib/build-html-descendants.js";
      import { buildNextItem } from "./lib/build-html-next-item.js";
      import { getNextDateTime } from "./lib/date-time.js";

      const updateSectionById = (id) =>
        fetch(`https://hacker-news.firebaseio.com/v0/item/${id}.json`).then(
          (result) =>
            result.json().then(({ descendants, id, score, text, type }) => {
              const currentItem = document.getElementById(id);

              if (score) {
                currentItem.querySelector(".points").textContent = score;
              }

              if (descendants && (type === "poll" || type === "story")) {
                const currentDescendants =
                  currentItem.querySelector(".descendants");

                if (currentDescendants) {
                  currentDescendants.textContent = `: ${descendants}`;
                } else {
                  const comments = buildDescendants(
                    document,
                    descendants,
                    `https://news.ycombinator.com/item?id=${id}`
                  );

                  currentItem.querySelector("h4").appendChild(comments);
                }
              }

              if (text) {
                const currentText = currentItem.querySelector(".text");

                if (currentText) {
                  currentText.innerHTML = text.replace(/\0/g, "");
                } else {
                  const content = document.createElement("div");
                  content.innerHTML = text.replace(/\0/g, "");
                  content.setAttribute("class", "text");

                  currentItem.appendChild(content);
                }
              }
            })
        );

      class UpdateQueue {
        constructor() {
          this._ids = [];
          this._isUpdating = false;
        }

        addItemById(id) {
          this._ids.push(id);
        }

        async flush() {
          const id = this._ids.shift();

          if (id) {
            this._isUpdating = true;

            await updateSectionById(id);
            await this.flush();
          } else {
            this._isUpdating = false;

            setTimeout(async () => {
              if (!this._isUpdating && this._ids && this._ids.length) {
                await this.flush();
              }
            }, 0);
          }
        }
      }

      // get latest data
      const latestSection = document.getElementById("latest");

      for (let item of latestSection.querySelectorAll("section[id]")) {
        updateSectionById(item.getAttribute("id"));
      }

      if ("IntersectionObserver" in window) {
        window.hackerNewsState = { index: [], nextTimeIndex: -1 };

        const addNewsItem = async (newsItem, queue) => {
          try {
            const { date, time, itemComments, itemTitle, itemLink } = newsItem;
            const section = await buildNextItem({
              document,
              dateTime: `${date}, ${time}`,
              itemComments,
              itemLink,
              itemTitle: new DOMParser().parseFromString(
                itemTitle.replace(/\\/g, ""),
                "text/html"
              ).documentElement.textContent,
              fetchItemDetails: false,
            });

            // display loading indicator for section
            section.querySelector(".points-container").innerHTML =
              'Points: <span class="points"><img style="height: 100%;" src="lib/images/loading.svg" /></span>';

            const id = section.getAttribute("id");
            if (!document.getElementById(id)) {
              document.getElementById("latest").appendChild(section);

              queue.addItemById(id);
            }
          } catch (error) {}
        };

        const buildArchiveIndex = async (lastDateTime) => {
          const nextDate = lastDateTime.slice(0, 10);
          const nextYear = nextDate.slice(0, 4);

          return (
            await (
              await fetch(
                `https://raw.githubusercontent.com/kherrick/hacker-news/main/archives/${nextYear}/${nextDate}/index.md`
              )
            ).text()
          )
            .split("\n")
            .filter((line) => line.match(new RegExp("^\\* \\[")))
            .map((line) => {
              const segment = line.replace("* ", "").split("](");
              const pubDate = segment[0].slice(1);

              const itemComments = segment[1].split(") - [")[0];
              const itemTitle = segment[1].split(") - [")[1];
              const itemLink = segment[2].slice(0, -1);
              const date = pubDate.slice(0, 10);
              const time = pubDate.slice(-8);

              return {
                date,
                itemComments,
                itemLink,
                itemTitle,
                time,
              };
            });
        };

        const handleIntersectingEntry = async (entry, queue) => {
          if (entry.isIntersecting) {
            const lastDateTime = document
              .getElementById("latest")
              .querySelector(
                "section:last-child > section > h4 > span"
              ).textContent;

            const nextDateTime = getNextDateTime(lastDateTime ?? "", -1);
            const archiveIndex = await buildArchiveIndex(nextDateTime);
            const nextTimeIndex = archiveIndex.findIndex(
              ({ time }) => time === nextDateTime.slice(-8)
            );

            const handleIndexUpdate = (index, existingIndexValues = []) => {
              index.forEach((i) => {
                existingIndexValues.push(i);
              });
              return existingIndexValues;
            };

            window.hackerNewsState = {
              index: handleIndexUpdate(
                archiveIndex,
                window.hackerNewsState.index
              ),
              nextTimeIndex,
            };

            let currentTimeIndex = nextTimeIndex + 1;
            const items = Object.values(window.hackerNewsState.index);
            for (let item of items) {
              if (currentTimeIndex < window.hackerNewsState.index.length) {
                addNewsItem(items[currentTimeIndex], queue);

                currentTimeIndex = currentTimeIndex + 1;
              }
            }

            queue.flush();
          }
        };

        const archives = document.getElementById("archives");
        const archivesObserver = new IntersectionObserver(
          (entries) => {
            const queue = new UpdateQueue();

            entries.forEach((entry) => handleIntersectingEntry(entry, queue));
          },
          {
            root: null,
            rootMargin: "0px",
            threshold: 0,
          }
        );

        archivesObserver.observe(archives);

        let latestSectionsExpanded = true;
        const handleLatestHeaderClick = () => {
          latestSectionsExpanded = !latestSectionsExpanded;

          if (latestSectionsExpanded) {
            archivesObserver.observe(archives);
          } else {
            archivesObserver.disconnect(archives);
          }

          for (let section of document.querySelectorAll("#latest > section")) {
            section.style.display = latestSectionsExpanded ? "block" : "none";
          }
        };

        const latestHeader = document.querySelector("#latest > h2");
        latestHeader.style.cursor = "pointer";
        latestHeader.addEventListener("click", handleLatestHeaderClick);
      }
    </script>
    <script type="module">
      import { Workbox } from "https://storage.googleapis.com/workbox-cdn/releases/6.4.1/workbox-window.prod.mjs";

      if ("serviceWorker" in navigator) {
        const base = document.querySelector("base");
        const serviceWorkerPath = `${
          base ? base.href.replace(/\/$/, "") : ""
        }/service-worker.js`;

        const wb = new Workbox(serviceWorkerPath);

        // setup event listeners
        wb.addEventListener("waiting", (event) => {
          wb.addEventListener("controlling", () => {
            window.location.reload();
          });

          wb.messageSkipWaiting();
        });

        wb.register();
      }
    </script>
  </body>
</html>
