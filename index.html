<!DOCTYPE html>
<html lang="en" xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta charset="utf-8" />
    <meta
      content="width=device-width, initial-scale=1.0, viewport-fit=cover"
      name="viewport"
    />
    <meta name="description" content="Hacker News" />
    <meta name="theme-color" content="#fff" />
    <title>Hacker News</title>
    <link rel="manifest" href="manifest.json" />
    <link
      href="data:image/x-icon;base64,AAABAAEAAQECAAEAAQA4AAAAFgAAACgAAAABAAAAAgAAAAEAAQAAAAAAAAAAAAAAAAAAAAAAAAAAAAABAAEAAQECAAEAAQA4AAAAFgAAACgAAAABAAAAAgAAAAEAAQAAAAAAAAAAAAAAAAAAAAAAAAAA"
      rel="icon"
      type="image/x-icon"
    />
    <link
      href="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAgAAAAIAAQMAAADOtka5AAAAA1BMVEUAAACnej3aAAAANklEQVR42u3BAQEAAACCIP+vbkhAAQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAB8G4IAAAFjdVCkAAAAAElFTkSuQmCC"
      rel="apple-touch-icon"
    />
    <style>
      /*<!--*/
      body {
        color: rgb(25, 25, 25);
        font-family: Verdana, Geneva, sans-serif;
        margin: 0;
      }

      a {
        text-decoration: none;
      }

      a:link,
      a:focus,
      a:hover,
      a:active {
        color: rgb(75, 75, 125);
      }

      a:visited {
        color: rgb(25, 25, 25);
      }

      h1 > a,
      h1 > a:link,
      h1 > a:focus,
      h1 > a:hover,
      h1 > a:active,
      h1 > a:visited,
      h2 > a,
      h2 > a:link,
      h2 > a:focus,
      h2 > a:hover,
      h2 > a:active,
      h2 > a:visited {
        color: rgb(25, 25, 25);
      }

      h1 {
        background-color: rgb(255, 102, 0);
        margin: 0;
        padding: 1rem;
      }

      h2 {
        background-color: rgb(200, 200, 200);
        margin: 1rem 0;
        padding: 0.5rem 0.5rem 0.5rem 1rem;
      }

      #latest > section,
      #archives > section {
        margin: 0 1rem 1rem 1rem;
        padding-bottom: 1rem;
      }

      #latest > section:not(:last-child),
      #archives > section:not(:last-child) {
        border-bottom: 1px dotted rgb(200, 200, 200);
      }

      section > h3 {
        margin: 0 0 0.5rem 0;
      }

      section > h4 {
        font-weight: normal;
        margin: 0 0 0 1rem;
      }

      .descendants-container,
      .points-container {
        align-items: center;
        border-left: 1px solid #333;
        display: inline-flex;
        margin-left: 0.5rem;
        padding-left: 0.5rem;
        text-align: center;
      }

      .points {
        align-items: center;
        display: inline-flex;
        height: 1rem;
        margin-left: 1ch;
        min-width: 3ch;
      }

      .text {
        line-height: 1.5rem;
        margin: 1rem 1rem 0 1rem;
        overflow: auto;
      }

      .text > p:first-child {
        margin-top: 1rem;
      }

      .text > p:last-child {
        margin-bottom: 0;
      }
      /*-->*/
    </style>
  </head>

  <body>
    <main>
      <h1><a href="https://kherrick.github.io/hacker-news/">Hacker News</a></h1>
      <section id="latest">
        <h2>Latest</h2>
        <section id="44271630">
          <h3>
            <a
              class="item"
              href="https://omc345.substack.com/p/from-skeuomorphic-to-liquid-glass"
              >Apple's Liquid Glass is prep work for AR interfaces, not just a
              design refresh</a
            >
          </h3>
          <section>
            <h4>
              <span>2025-06-13 @ 19:44:58</span
              ><span class="points-container"
                >Points: <span class="points">76</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=44271630"
                  >Comments</a
                ><span class="descendants">: 67</span></span
              >
            </h4>
          </section>
        </section>
        <section id="44271284">
          <h3>
            <a class="item" href="https://arxiv.org/abs/2506.10943"
              >Self-Adapting Language Models</a
            >
          </h3>
          <section>
            <h4>
              <span>2025-06-13 @ 19:03:42</span
              ><span class="points-container"
                >Points: <span class="points">24</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=44271284"
                  >Comments</a
                ><span class="descendants">: 2</span></span
              >
            </h4>
          </section>
        </section>
        <section id="44271217">
          <h3>
            <a class="item" href="https://github.com/Kaamuli/Bloxi"
              >Simulink (Matlab) Copilot</a
            >
          </h3>
          <section>
            <h4>
              <span>2025-06-13 @ 18:58:49</span
              ><span class="points-container"
                >Points: <span class="points">17</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=44271217"
                  >Comments</a
                ><span class="descendants">: 2</span></span
              >
            </h4>
          </section>
        </section>
        <section id="44271191">
          <h3>
            <a
              class="item"
              href="https://www.astralcodexten.com/p/the-claude-bliss-attractor"
              >The Claude Bliss Attractor</a
            >
          </h3>
          <section>
            <h4>
              <span>2025-06-13 @ 18:55:54</span
              ><span class="points-container"
                >Points: <span class="points">50</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=44271191"
                  >Comments</a
                ><span class="descendants">: 3</span></span
              >
            </h4>
          </section>
        </section>
        <section id="44270965">
          <h3>
            <a
              class="item"
              href="https://www.psu.edu/news/research/story/strange-radio-pulses-detected-coming-ice-antarctica#"
              >Radio pulses detected coming from ice in Antarctica</a
            >
          </h3>
          <section>
            <h4>
              <span>2025-06-13 @ 18:30:47</span
              ><span class="points-container"
                >Points: <span class="points">31</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=44270965"
                  >Comments</a
                ><span class="descendants">: 10</span></span
              >
            </h4>
          </section>
        </section>
        <section id="44270709">
          <h3>
            <a
              class="item"
              href="https://philmckinney.substack.com/p/i-convinced-hps-board-to-buy-palm"
              >I convinced HP's board to buy Palm and watched them kill it</a
            >
          </h3>
          <section>
            <h4>
              <span>2025-06-13 @ 18:03:30</span
              ><span class="points-container"
                >Points: <span class="points">311</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=44270709"
                  >Comments</a
                ><span class="descendants">: 279</span></span
              >
            </h4>
          </section>
        </section>
        <section id="44270434">
          <h3>
            <a class="item" href="https://akkartik.name/freewheeling/"
              >Using computers more freely and safely (2023)</a
            >
          </h3>
          <section>
            <h4>
              <span>2025-06-13 @ 17:27:20</span
              ><span class="points-container"
                >Points: <span class="points">45</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=44270434"
                  >Comments</a
                ><span class="descendants">: 1</span></span
              >
            </h4>
          </section>
        </section>
        <section id="44270144">
          <h3>
            <a
              class="item"
              href="https://quomodocumque.wordpress.com/2017/06/27/when-random-people-give-money-to-random-other-people/"
              >When random people give money to random other people (2017)</a
            >
          </h3>
          <section>
            <h4>
              <span>2025-06-13 @ 16:49:46</span
              ><span class="points-container"
                >Points: <span class="points">52</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=44270144"
                  >Comments</a
                ><span class="descendants">: 40</span></span
              >
            </h4>
          </section>
        </section>
        <section id="44269289">
          <h3>
            <a
              class="item"
              href="https://www.nhatcher.com/post/on-hats-and-sats/"
              >The Hat, the Spectre and SAT Solvers (2024)</a
            >
          </h3>
          <section>
            <h4>
              <span>2025-06-13 @ 15:14:20</span
              ><span class="points-container"
                >Points: <span class="points">54</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=44269289"
                  >Comments</a
                ><span class="descendants">: 4</span></span
              >
            </h4>
          </section>
        </section>
        <section id="44269270">
          <h3>
            <a class="item" href="https://luxeengine.com/">Luxe Game Engine</a>
          </h3>
          <section>
            <h4>
              <span>2025-06-13 @ 15:12:11</span
              ><span class="points-container"
                >Points: <span class="points">116</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=44269270"
                  >Comments</a
                ><span class="descendants">: 43</span></span
              >
            </h4>
          </section>
        </section>
        <section id="44269002">
          <h3>
            <a
              class="item"
              href="https://research.mietek.io/mi.MartinLof2006.html"
              >100 years of Zermelo's axiom of choice: What was the problem with
              it? (2006)</a
            >
          </h3>
          <section>
            <h4>
              <span>2025-06-13 @ 14:46:15</span
              ><span class="points-container"
                >Points: <span class="points">76</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=44269002"
                  >Comments</a
                ><span class="descendants">: 69</span></span
              >
            </h4>
          </section>
        </section>
        <section id="44268782">
          <h3>
            <a class="item" href="https://oxcaml.org/"
              >OxCaml - a set of extensions to the OCaml programming
              language.</a
            >
          </h3>
          <section>
            <h4>
              <span>2025-06-13 @ 14:20:38</span
              ><span class="points-container"
                >Points: <span class="points">215</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=44268782"
                  >Comments</a
                ><span class="descendants">: 63</span></span
              >
            </h4>
          </section>
        </section>
        <section id="44268644">
          <h3>
            <a class="item" href="https://tattoy.sh"
              >Show HN: Tattoy – a text-based terminal compositor</a
            >
          </h3>
          <section>
            <h4>
              <span>2025-06-13 @ 14:04:35</span
              ><span class="points-container"
                >Points: <span class="points">131</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=44268644"
                  >Comments</a
                ><span class="descendants">: 34</span></span
              >
            </h4>
            <div class="text">
              <p>
                Firstly it solves the age-old problem of low-contrast text, like
                when you `ls` a broken symlink and the red background colour is
                too near your current theme's foreground colour. Tattoy solves
                this by using none other than the web's WCAG 2.1 contrast
                algorithm for accessible text.
              </p>
              <p>
                Secondly, an explicit design goal is that Tattoy should be able
                to polyfill new terminal protocols, the `xwayland` of the TTY if
                you will. Say if we want to experiment with completely
                deprecating ANSI codes, then any application that uses a new
                protocol can be run in Tattoy which itself runs in any
                ANSI-standard terminal emulator as normal. You can read more
                about this idea here:
                <a href="https://tattoy.sh/news/an-end-to-terminal-ansi-codes/"
                  >https://tattoy.sh/news/an-end-to-terminal-ansi-codes/</a
                >
              </p>
              <p>
                But ultimately this has been something more akin to an art
                project, something to enjoy for the sheer aesthetic pleasure.
              </p>
            </div>
          </section>
        </section>
        <section id="44268545">
          <h3>
            <a class="item" href="https://github.com/Techwolf12/qrkey"
              >Show HN: Qrkey – Offline private key backup on paper</a
            >
          </h3>
          <section>
            <h4>
              <span>2025-06-13 @ 13:51:22</span
              ><span class="points-container"
                >Points: <span class="points">54</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=44268545"
                  >Comments</a
                ><span class="descendants">: 32</span></span
              >
            </h4>
          </section>
        </section>
        <section id="44268448">
          <h3>
            <a class="item" href="https://news.ycombinator.com/item?id=44268448"
              >Ask HN: How do I give back to people helped me when I was young
              and had nothing?</a
            >
          </h3>
          <section>
            <h4>
              <span>2025-06-13 @ 13:42:45</span
              ><span class="points-container"
                >Points: <span class="points">244</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=44268448"
                  >Comments</a
                ><span class="descendants">: 142</span></span
              >
            </h4>
            <div class="text">
              <p>
                How do you meaningfully give back to people who helped you early
                on (when you literally have nothing...haha)? What forms of
                gratitude have you found most meaningful?
              </p>
              <p>Appreciate any comments.</p>
            </div>
          </section>
        </section>
        <section id="44268286">
          <h3>
            <a class="item" href="https://arxiv.org/abs/2502.13293"
              >Geometry from Quantum Temporal Correlations</a
            >
          </h3>
          <section>
            <h4>
              <span>2025-06-13 @ 13:21:47</span
              ><span class="points-container"
                >Points: <span class="points">38</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=44268286"
                  >Comments</a
                ><span class="descendants">: 18</span></span
              >
            </h4>
          </section>
        </section>
        <section id="44268197">
          <h3>
            <a
              class="item"
              href="https://www.nytimes.com/2025/06/12/technology/meta-scale-ai.html"
              >Meta invests $14.3B in Scale AI to kick-start superintelligence
              lab</a
            >
          </h3>
          <section>
            <h4>
              <span>2025-06-13 @ 13:09:56</span
              ><span class="points-container"
                >Points: <span class="points">349</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=44268197"
                  >Comments</a
                ><span class="descendants">: 368</span></span
              >
            </h4>
          </section>
        </section>
        <section id="44267746">
          <h3>
            <a
              class="item"
              href="https://www.ycombinator.com/companies/kyber/jobs/5kSq3Jd-technical-account-manager-tam"
              >Kyber (YC W23) Is Hiring a Technical Account Manager</a
            >
          </h3>
          <section>
            <h4>
              <span>2025-06-13 @ 12:01:11</span
              ><span class="points-container"
                >Points: <span class="points">1</span></span
              >
            </h4>
          </section>
        </section>
        <section id="44266828">
          <h3>
            <a
              class="item"
              href="https://joshworth.com/dev/pixelspace/pixelspace_solarsystem.html"
              >If the moon were only 1 pixel: A tediously accurate solar system
              model (2014)</a
            >
          </h3>
          <section>
            <h4>
              <span>2025-06-13 @ 08:40:05</span
              ><span class="points-container"
                >Points: <span class="points">561</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=44266828"
                  >Comments</a
                ><span class="descendants">: 193</span></span
              >
            </h4>
          </section>
        </section>
        <section id="44265233">
          <h3>
            <a class="item" href="https://osor.io/text"
              >Rendering Crispy Text on the GPU</a
            >
          </h3>
          <section>
            <h4>
              <span>2025-06-13 @ 02:27:24</span
              ><span class="points-container"
                >Points: <span class="points">370</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=44265233"
                  >Comments</a
                ><span class="descendants">: 117</span></span
              >
            </h4>
          </section>
        </section>
        <section id="44264958">
          <h3>
            <a
              class="item"
              href="https://jasone.github.io/2025/06/12/jemalloc-postmortem/"
              >Jemalloc Postmortem</a
            >
          </h3>
          <section>
            <h4>
              <span>2025-06-13 @ 01:37:17</span
              ><span class="points-container"
                >Points: <span class="points">668</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=44264958"
                  >Comments</a
                ><span class="descendants">: 198</span></span
              >
            </h4>
          </section>
        </section>
        <section id="44263780">
          <h3>
            <a
              class="item"
              href="https://krebsonsecurity.com/2025/06/inside-a-dark-adtech-empire-fed-by-fake-captchas/"
              >A Dark Adtech Empire Fed by Fake CAPTCHAs</a
            >
          </h3>
          <section>
            <h4>
              <span>2025-06-12 @ 22:15:43</span
              ><span class="points-container"
                >Points: <span class="points">216</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=44263780"
                  >Comments</a
                ><span class="descendants">: 107</span></span
              >
            </h4>
          </section>
        </section>
        <section id="44261777">
          <h3>
            <a
              class="item"
              href="https://tailscale.com/blog/frequent-reath-security"
              >Frequent reauth doesn't make you more secure</a
            >
          </h3>
          <section>
            <h4>
              <span>2025-06-12 @ 19:05:12</span
              ><span class="points-container"
                >Points: <span class="points">1109</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=44261777"
                  >Comments</a
                ><span class="descendants">: 469</span></span
              >
            </h4>
          </section>
        </section>
        <section id="44258670">
          <h3>
            <a
              class="item"
              href="https://github.com/ChefKissInc/QEMUAppleSilicon"
              >iPhone 11 emulation done in QEMU</a
            >
          </h3>
          <section>
            <h4>
              <span>2025-06-12 @ 15:04:59</span
              ><span class="points-container"
                >Points: <span class="points">360</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=44258670"
                  >Comments</a
                ><span class="descendants">: 30</span></span
              >
            </h4>
          </section>
        </section>
        <section id="44256765">
          <h3>
            <a class="item" href="https://tritium.legal/preview"
              >Show HN: Tritium – The Legal IDE in Rust</a
            >
          </h3>
          <section>
            <h4>
              <span>2025-06-12 @ 12:06:59</span
              ><span class="points-container"
                >Points: <span class="points">289</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=44256765"
                  >Comments</a
                ><span class="descendants">: 161</span></span
              >
            </h4>
            <div class="text">
              <p>
                Hi HN! I'd like to submit for your consideration Tritium (<a
                  href="https://tritium.legal"
                  >https://tritium.legal</a
                >). Tritium aims to bring the power of the integrated
                development environment (IDE) to corporate lawyers.
              </p>
              <p>
                My name is Drew Miller, and I'm lawyer admitted to the New York
                bar. I have spent the last 13 years in and out of corporate
                transactional practice, while building side projects in various
                languages using vanilla Vim. One day at work, I was asked to
                implement a legal technology product at my firm. Of course the
                only product available for editing and running programs in a
                locked-down environment was VS Code and its friends like
                Puppeteer from Microsoft.
              </p>
              <p>
                I was really blown away at all of the capabilities of go-to
                definition and out-of-the box syntax highlighting as well as the
                debugger integration. I made the switch to a full IDE for my
                side projects immediately. And it hit me: why don't we have this
                exact same tool in corporate law?
              </p>
              <p>
                Corporate lawyers spent hours upon hours fumbling between
                various applications and instances of Word and Adobe. There are
                sub-par differencing products that make `patch` look like the
                future. They do this while charging you ridiculous rates.
              </p>
              <p>
                I left my practice a few months later to build Tritium. Tritium
                aims to be the lawyer's VS Code: an all-in-one drafting cockpit
                that treats a deal's entire document suite as a single,
                searchable, AI-enhanced workspace while remaining fast, local,
                and secure.
              </p>
              <p>
                Tritium is implemented in pure Rust. It is cross-platform and
                I'm excited for the prospect of lawyers running Linux as their
                daily driver. It leverages a modified version of the super fast
                egui.rs immediate-mode GUI library. The windows build includes a
                Rust COM implementation which was probably one of the more
                technical challenges other than laying out and rendering the
                text.
              </p>
              <p>
                Download a copy at
                <a href="https://tritium.legal/download"
                  >https://tritium.legal/download</a
                >
                or try out a web-only WASM preview here:
                <a href="https://tritium.legal/preview"
                  >https://tritium.legal/preview</a
                >
              </p>
              <p>
                Let me know your thoughts! Your criticisms are the most
                important. Thank you for the time.
              </p>
            </div>
          </section>
        </section>
        <section id="44256499">
          <h3>
            <a
              class="item"
              href="https://www.laurieherault.com/articles/a-thermal-receipt-printer-cured-my-procrastination"
              >A receipt printer cured my procrastination</a
            >
          </h3>
          <section>
            <h4>
              <span>2025-06-12 @ 11:41:04</span
              ><span class="points-container"
                >Points: <span class="points">1104</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=44256499"
                  >Comments</a
                ><span class="descendants">: 559</span></span
              >
            </h4>
          </section>
        </section>
        <section id="44243059">
          <h3>
            <a
              class="item"
              href="https://wvutoday.wvu.edu/stories/2025/06/02/wvu-student-makes-long-awaited-discovery-of-mystery-fungus-sought-by-lsd-s-inventor"
              >Student discovers fungus predicted by Albert Hoffman</a
            >
          </h3>
          <section>
            <h4>
              <span>2025-06-11 @ 00:36:00</span
              ><span class="points-container"
                >Points: <span class="points">14</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=44243059"
                  >Comments</a
                ><span class="descendants">: 1</span></span
              >
            </h4>
          </section>
        </section>
        <section id="44241797">
          <h3>
            <a
              class="item"
              href="https://opg.optica.org/optica/fulltext.cfm?uri=optica-12-5-674&amp;id=570897"
              >High-speed fluorescence light field tomography of whole freely
              moving organisms</a
            >
          </h3>
          <section>
            <h4>
              <span>2025-06-10 @ 21:43:33</span
              ><span class="points-container"
                >Points: <span class="points">16</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=44241797"
                  >Comments</a
                ><span class="descendants">: 0</span></span
              >
            </h4>
          </section>
        </section>
        <section id="44238072">
          <h3>
            <a class="item" href="https://www.thiings.co/things">Thiings</a>
          </h3>
          <section>
            <h4>
              <span>2025-06-10 @ 15:30:23</span
              ><span class="points-container"
                >Points: <span class="points">90</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=44238072"
                  >Comments</a
                ><span class="descendants">: 37</span></span
              >
            </h4>
          </section>
        </section>
        <section id="44231044">
          <h3>
            <a
              class="item"
              href="https://blog.polybdenum.com/2020/07/04/subtype-inference-by-example-part-1-introducing-cubiml.html"
              >Subtype Inference by Example</a
            >
          </h3>
          <section>
            <h4>
              <span>2025-06-10 @ 00:04:40</span
              ><span class="points-container"
                >Points: <span class="points">16</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=44231044"
                  >Comments</a
                ><span class="descendants">: 4</span></span
              >
            </h4>
          </section>
        </section>
      </section>
      <section id="archives">
        <h2>
          <a
            href="https://github.com/kherrick/hacker-news/blob/main/archives/index.md"
            >Archives</a
          >
        </h2>
        <section>
          <h3>
            <a
              href="https://github.com/kherrick/hacker-news/blob/main/archives/2025/index.md"
              >2025</a
            >
          </h3>
        </section>
        <section>
          <h3>
            <a
              href="https://github.com/kherrick/hacker-news/blob/main/archives/2024/index.md"
              >2024</a
            >
          </h3>
        </section>
        <section>
          <h3>
            <a
              href="https://github.com/kherrick/hacker-news/blob/main/archives/2023/index.md"
              >2023</a
            >
          </h3>
        </section>
        <section>
          <h3>
            <a
              href="https://github.com/kherrick/hacker-news/blob/main/archives/2022/index.md"
              >2022</a
            >
          </h3>
        </section>
      </section>
    </main>
    <script type="module">
      import { buildDescendants } from "./lib/build-html-descendants.js";
      import { buildNextItem } from "./lib/build-html-next-item.js";
      import { getNextDateTime } from "./lib/date-time.js";

      const updateSectionById = (id) =>
        fetch(`https://hacker-news.firebaseio.com/v0/item/${id}.json`).then(
          (result) =>
            result.json().then(({ descendants, id, score, text, type }) => {
              const currentItem = document.getElementById(id);

              if (score) {
                currentItem.querySelector(".points").textContent = score;
              }

              if (descendants && (type === "poll" || type === "story")) {
                const currentDescendants =
                  currentItem.querySelector(".descendants");

                if (currentDescendants) {
                  currentDescendants.textContent = `: ${descendants}`;
                } else {
                  const comments = buildDescendants(
                    document,
                    descendants,
                    `https://news.ycombinator.com/item?id=${id}`
                  );

                  currentItem.querySelector("h4").appendChild(comments);
                }
              }

              if (text) {
                const currentText = currentItem.querySelector(".text");

                if (currentText) {
                  currentText.innerHTML = text.replace(/\0/g, "");
                } else {
                  const content = document.createElement("div");
                  content.innerHTML = text.replace(/\0/g, "");
                  content.setAttribute("class", "text");

                  currentItem.appendChild(content);
                }
              }
            })
        );

      class UpdateQueue {
        constructor() {
          this._ids = [];
          this._isUpdating = false;
        }

        addItemById(id) {
          this._ids.push(id);
        }

        async flush() {
          const id = this._ids.shift();

          if (id) {
            this._isUpdating = true;

            await updateSectionById(id);
            await this.flush();
          } else {
            this._isUpdating = false;

            setTimeout(async () => {
              if (!this._isUpdating && this._ids && this._ids.length) {
                await this.flush();
              }
            }, 0);
          }
        }
      }

      // get latest data
      const latestSection = document.getElementById("latest");

      for (let item of latestSection.querySelectorAll("section[id]")) {
        updateSectionById(item.getAttribute("id"));
      }

      if ("IntersectionObserver" in window) {
        window.hackerNewsState = { index: [], nextTimeIndex: -1 };

        const addNewsItem = async (newsItem, queue) => {
          try {
            const { date, time, itemComments, itemTitle, itemLink } = newsItem;
            const section = await buildNextItem({
              document,
              dateTime: `${date}, ${time}`,
              itemComments,
              itemLink,
              itemTitle: new DOMParser().parseFromString(
                itemTitle.replace(/\\/g, ""),
                "text/html"
              ).documentElement.textContent,
              fetchItemDetails: false,
            });

            // display loading indicator for section
            section.querySelector(".points-container").innerHTML =
              'Points: <span class="points"><img style="height: 100%;" src="lib/images/loading.svg" /></span>';

            const id = section.getAttribute("id");
            if (!document.getElementById(id)) {
              document.getElementById("latest").appendChild(section);

              queue.addItemById(id);
            }
          } catch (error) {}
        };

        const buildArchiveIndex = async (lastDateTime) => {
          const nextDate = lastDateTime.slice(0, 10);
          const nextYear = nextDate.slice(0, 4);

          return (
            await (
              await fetch(
                `https://raw.githubusercontent.com/kherrick/hacker-news/main/archives/${nextYear}/${nextDate}/index.md`
              )
            ).text()
          )
            .split("\n")
            .filter((line) => line.match(new RegExp("^\\* \\[")))
            .map((line) => {
              const segment = line.replace("* ", "").split("](");
              const pubDate = segment[0].slice(1);

              const itemComments = segment[1].split(") - [")[0];
              const itemTitle = segment[1].split(") - [")[1];
              const itemLink = segment[2].slice(0, -1);
              const date = pubDate.slice(0, 10);
              const time = pubDate.slice(-8);

              return {
                date,
                itemComments,
                itemLink,
                itemTitle,
                time,
              };
            });
        };

        const handleIntersectingEntry = async (entry, queue) => {
          if (entry.isIntersecting) {
            const lastDateTime = document
              .getElementById("latest")
              .querySelector(
                "section:last-child > section > h4 > span"
              ).textContent;

            const nextDateTime = getNextDateTime(lastDateTime ?? "", -1);
            const archiveIndex = await buildArchiveIndex(nextDateTime);
            const nextTimeIndex = archiveIndex.findIndex(
              ({ time }) => time === nextDateTime.slice(-8)
            );

            const handleIndexUpdate = (index, existingIndexValues = []) => {
              index.forEach((i) => {
                existingIndexValues.push(i);
              });
              return existingIndexValues;
            };

            window.hackerNewsState = {
              index: handleIndexUpdate(
                archiveIndex,
                window.hackerNewsState.index
              ),
              nextTimeIndex,
            };

            let currentTimeIndex = nextTimeIndex + 1;
            const items = Object.values(window.hackerNewsState.index);
            for (let item of items) {
              if (currentTimeIndex < window.hackerNewsState.index.length) {
                addNewsItem(items[currentTimeIndex], queue);

                currentTimeIndex = currentTimeIndex + 1;
              }
            }

            queue.flush();
          }
        };

        const archives = document.getElementById("archives");
        const archivesObserver = new IntersectionObserver(
          (entries) => {
            const queue = new UpdateQueue();

            entries.forEach((entry) => handleIntersectingEntry(entry, queue));
          },
          {
            root: null,
            rootMargin: "0px",
            threshold: 0,
          }
        );

        archivesObserver.observe(archives);

        let latestSectionsExpanded = true;
        const handleLatestHeaderClick = () => {
          latestSectionsExpanded = !latestSectionsExpanded;

          if (latestSectionsExpanded) {
            archivesObserver.observe(archives);
          } else {
            archivesObserver.disconnect(archives);
          }

          for (let section of document.querySelectorAll("#latest > section")) {
            section.style.display = latestSectionsExpanded ? "block" : "none";
          }
        };

        const latestHeader = document.querySelector("#latest > h2");
        latestHeader.style.cursor = "pointer";
        latestHeader.addEventListener("click", handleLatestHeaderClick);
      }
    </script>
    <script type="module">
      import { Workbox } from "https://storage.googleapis.com/workbox-cdn/releases/6.4.1/workbox-window.prod.mjs";

      if ("serviceWorker" in navigator) {
        const base = document.querySelector("base");
        const serviceWorkerPath = `${
          base ? base.href.replace(/\/$/, "") : ""
        }/service-worker.js`;

        const wb = new Workbox(serviceWorkerPath);

        // setup event listeners
        wb.addEventListener("waiting", (event) => {
          wb.addEventListener("controlling", () => {
            window.location.reload();
          });

          wb.messageSkipWaiting();
        });

        wb.register();
      }
    </script>
  </body>
</html>
