<!DOCTYPE html>
<html lang="en" xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta charset="utf-8" />
    <meta
      content="width=device-width, initial-scale=1.0, viewport-fit=cover"
      name="viewport"
    />
    <meta name="description" content="Hacker News" />
    <meta name="theme-color" content="#fff" />
    <title>Hacker News</title>
    <link rel="manifest" href="manifest.json" />
    <link
      href="data:image/x-icon;base64,AAABAAEAAQECAAEAAQA4AAAAFgAAACgAAAABAAAAAgAAAAEAAQAAAAAAAAAAAAAAAAAAAAAAAAAAAAABAAEAAQECAAEAAQA4AAAAFgAAACgAAAABAAAAAgAAAAEAAQAAAAAAAAAAAAAAAAAAAAAAAAAA"
      rel="icon"
      type="image/x-icon"
    />
    <link
      href="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAgAAAAIAAQMAAADOtka5AAAAA1BMVEUAAACnej3aAAAANklEQVR42u3BAQEAAACCIP+vbkhAAQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAB8G4IAAAFjdVCkAAAAAElFTkSuQmCC"
      rel="apple-touch-icon"
    />
    <style>
      /*<!--*/
      body {
        color: rgb(25, 25, 25);
        font-family: Verdana, Geneva, sans-serif;
        margin: 0;
      }

      a {
        text-decoration: none;
      }

      a:link,
      a:focus,
      a:hover,
      a:active {
        color: rgb(75, 75, 125);
      }

      a:visited {
        color: rgb(25, 25, 25);
      }

      h1 > a,
      h1 > a:link,
      h1 > a:focus,
      h1 > a:hover,
      h1 > a:active,
      h1 > a:visited,
      h2 > a,
      h2 > a:link,
      h2 > a:focus,
      h2 > a:hover,
      h2 > a:active,
      h2 > a:visited {
        color: rgb(25, 25, 25);
      }

      h1 {
        background-color: rgb(255, 102, 0);
        margin: 0;
        padding: 1rem;
      }

      h2 {
        background-color: rgb(200, 200, 200);
        margin: 1rem 0;
        padding: 0.5rem 0.5rem 0.5rem 1rem;
      }

      #latest > section,
      #archives > section {
        margin: 0 1rem 1rem 1rem;
        padding-bottom: 1rem;
      }

      #latest > section:not(:last-child),
      #archives > section:not(:last-child) {
        border-bottom: 1px dotted rgb(200, 200, 200);
      }

      section > h3 {
        margin: 0 0 0.5rem 0;
      }

      section > h4 {
        font-weight: normal;
        margin: 0 0 0 1rem;
      }

      .descendants-container,
      .points-container {
        align-items: center;
        border-left: 1px solid #333;
        display: inline-flex;
        margin-left: 0.5rem;
        padding-left: 0.5rem;
        text-align: center;
      }

      .points {
        align-items: center;
        display: inline-flex;
        height: 1rem;
        margin-left: 1ch;
        min-width: 3ch;
      }

      .text {
        line-height: 1.5rem;
        margin: 1rem 1rem 0 1rem;
        overflow: auto;
      }

      .text > p:first-child {
        margin-top: 1rem;
      }

      .text > p:last-child {
        margin-bottom: 0;
      }
      /*-->*/
    </style>
  </head>

  <body>
    <main>
      <h1><a href="https://kherrick.github.io/hacker-news/">Hacker News</a></h1>
      <section id="latest">
        <h2>Latest</h2>
        <section id="44805261">
          <h3>
            <a
              class="item"
              href="https://www.hhs.gov/press-room/hhs-winds-down-mrna-development-under-barda.html"
              >HHS Winds Down mRNA Vaccine Development Under BARDA</a
            >
          </h3>
          <section>
            <h4>
              <span>2025-08-05 @ 22:29:49</span
              ><span class="points-container"
                >Points: <span class="points">59</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=44805261"
                  >Comments</a
                ><span class="descendants">: 26</span></span
              >
            </h4>
          </section>
        </section>
        <section id="44804761">
          <h3>
            <a class="item" href="https://simonwillison.net/2025/Aug/5/gpt-oss/"
              >OpenAI's new open weight (Apache 2) models are good</a
            >
          </h3>
          <section>
            <h4>
              <span>2025-08-05 @ 21:42:29</span
              ><span class="points-container"
                >Points: <span class="points">29</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=44804761"
                  >Comments</a
                ><span class="descendants">: 0</span></span
              >
            </h4>
          </section>
        </section>
        <section id="44804411">
          <h3>
            <a
              class="item"
              href="https://blog.google/products/gemini/storybooks/"
              >Create personal illustrated storybooks in the Gemini app</a
            >
          </h3>
          <section>
            <h4>
              <span>2025-08-05 @ 21:14:49</span
              ><span class="points-container"
                >Points: <span class="points">42</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=44804411"
                  >Comments</a
                ><span class="descendants">: 14</span></span
              >
            </h4>
          </section>
        </section>
        <section id="44804230">
          <h3>
            <a
              class="item"
              href="https://www.ycombinator.com/companies/kyber/jobs/6RvaAVR-enterprise-account-executive-ae"
              >Kyber (YC W23) is hiring enterprise account executives</a
            >
          </h3>
          <section>
            <h4>
              <span>2025-08-05 @ 21:02:21</span
              ><span class="points-container"
                >Points: <span class="points">1</span></span
              >
            </h4>
          </section>
        </section>
        <section id="44804043">
          <h3>
            <a
              class="item"
              href="https://byroot.github.io/ruby/json/2025/08/02/whats-wrong-with-the-json-gem-api.html"
              >What's wrong with the JSON gem API?</a
            >
          </h3>
          <section>
            <h4>
              <span>2025-08-05 @ 20:46:38</span
              ><span class="points-container"
                >Points: <span class="points">28</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=44804043"
                  >Comments</a
                ><span class="descendants">: 6</span></span
              >
            </h4>
          </section>
        </section>
        <section id="44802886">
          <h3>
            <a class="item" href="https://ergaster.org/til/base64-encoded-json/"
              >Spotting base64 encoded JSON, certificates, and private keys</a
            >
          </h3>
          <section>
            <h4>
              <span>2025-08-05 @ 19:17:38</span
              ><span class="points-container"
                >Points: <span class="points">202</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=44802886"
                  >Comments</a
                ><span class="descendants">: 87</span></span
              >
            </h4>
          </section>
        </section>
        <section id="44802414">
          <h3>
            <a class="item" href="https://ollama.com/turbo">Ollama Turbo</a>
          </h3>
          <section>
            <h4>
              <span>2025-08-05 @ 18:46:18</span
              ><span class="points-container"
                >Points: <span class="points">202</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=44802414"
                  >Comments</a
                ><span class="descendants">: 123</span></span
              >
            </h4>
          </section>
        </section>
        <section id="44801486">
          <h3>
            <a
              class="item"
              href="https://www.notebookcheck.net/Desperate-measures-to-save-Intel-US-reportedly-forcing-TSMC-to-buy-49-stake-in-Intel-to-secure-tariff-relief-for-Taiwan.1079424.0.html"
              >US reportedly forcing TSMC to buy 49% stake in Intel to secure
              tariff relief</a
            >
          </h3>
          <section>
            <h4>
              <span>2025-08-05 @ 17:44:01</span
              ><span class="points-container"
                >Points: <span class="points">250</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=44801486"
                  >Comments</a
                ><span class="descendants">: 281</span></span
              >
            </h4>
          </section>
        </section>
        <section id="44801399">
          <h3>
            <a class="item" href="https://playwhittle.com/"
              >Show HN: Whittle â€“ A Shrinking Word Game</a
            >
          </h3>
          <section>
            <h4>
              <span>2025-08-05 @ 17:39:26</span
              ><span class="points-container"
                >Points: <span class="points">77</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=44801399"
                  >Comments</a
                ><span class="descendants">: 34</span></span
              >
            </h4>
            <div class="text">
              <p>
                The idea for the game came to me in a dream (really) and I built
                the puzzle generator with my partner, who's also a software
                engineer. It's a labor of love! Any feedback or suggestions are
                welcome. Thanks for playing!
              </p>
            </div>
          </section>
        </section>
        <section id="44801027">
          <h3>
            <a class="item" href="https://github.com/w3c/png/issues/39"
              >Consider using Zstandard and/or LZ4 instead of Deflate</a
            >
          </h3>
          <section>
            <h4>
              <span>2025-08-05 @ 17:18:37</span
              ><span class="points-container"
                >Points: <span class="points">107</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=44801027"
                  >Comments</a
                ><span class="descendants">: 66</span></span
              >
            </h4>
          </section>
        </section>
        <section id="44800746">
          <h3>
            <a class="item" href="https://openai.com/open-models/"
              >Open models by OpenAI</a
            >
          </h3>
          <section>
            <h4>
              <span>2025-08-05 @ 17:02:02</span
              ><span class="points-container"
                >Points: <span class="points">1241</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=44800746"
                  >Comments</a
                ><span class="descendants">: 471</span></span
              >
            </h4>
            <div class="text">
              <a href="https://openai.com/index/introducing-gpt-oss/"
                >https://openai.com/index/introducing-gpt-oss/</a
              >
            </div>
          </section>
        </section>
        <section id="44800185">
          <h3>
            <a
              class="item"
              href="https://www.anthropic.com/news/claude-opus-4-1"
              >Claude Opus 4.1</a
            >
          </h3>
          <section>
            <h4>
              <span>2025-08-05 @ 16:28:05</span
              ><span class="points-container"
                >Points: <span class="points">591</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=44800185"
                  >Comments</a
                ><span class="descendants">: 217</span></span
              >
            </h4>
          </section>
        </section>
        <section id="44799494">
          <h3>
            <a
              class="item"
              href="https://www.githubstatus.com/incidents/6swp0zf7lk8h"
              >GitHub pull requests were down</a
            >
          </h3>
          <section>
            <h4>
              <span>2025-08-05 @ 15:44:09</span
              ><span class="points-container"
                >Points: <span class="points">106</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=44799494"
                  >Comments</a
                ><span class="descendants">: 146</span></span
              >
            </h4>
          </section>
        </section>
        <section id="44799479">
          <h3>
            <a
              class="item"
              href="https://elevenlabs.io/blog/eleven-music-is-here"
              >Eleven Music</a
            >
          </h3>
          <section>
            <h4>
              <span>2025-08-05 @ 15:42:40</span
              ><span class="points-container"
                >Points: <span class="points">154</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=44799479"
                  >Comments</a
                ><span class="descendants">: 172</span></span
              >
            </h4>
          </section>
        </section>
        <section id="44798695">
          <h3>
            <a
              class="item"
              href="https://www.lanl.gov/media/publications/1663/dynamics-of-dynamic-imaging"
              >Los Alamos is capturing real-time images of explosions at 7mths
              of a second</a
            >
          </h3>
          <section>
            <h4>
              <span>2025-08-05 @ 14:47:07</span
              ><span class="points-container"
                >Points: <span class="points">101</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=44798695"
                  >Comments</a
                ><span class="descendants">: 82</span></span
              >
            </h4>
          </section>
        </section>
        <section id="44798553">
          <h3>
            <a class="item" href="https://github.com/stagewise-io/stagewise"
              >Show HN: Stagewise (YC S25) â€“ Front end coding agent for existing
              codebases</a
            >
          </h3>
          <section>
            <h4>
              <span>2025-08-05 @ 14:38:36</span
              ><span class="points-container"
                >Points: <span class="points">27</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=44798553"
                  >Comments</a
                ><span class="descendants">: 30</span></span
              >
            </h4>
            <div class="text">
              <a href="https://stagewise.io">https://stagewise.io</a>), a
              frontend coding agent that lives inside your browser on localhost
              and operates on local codebases.
              <p>
                You can spawn the agent into locally running web apps in dev
                mode with `npx stagewise` from the project root. The agent lets
                you then click on HTML Elements in your app, enter prompts like
                'increase the height here' and will implement the changes in
                your source code.
              </p>
              <p>
                Before stagewise, we were building a vertical SaaS for logistics
                from scratch and loved using prototyping tools like v0 or
                lovable to get to the first version. But when switching from v0/
                lovable to Cursor for local development, we felt like the
                frontend magic was gone. So, we decided to build stagewise to
                bring that same magic to local development.
              </p>
              <p>
                The first version of stagewise just forwarded a prompt with
                browser context to existing IDEs and agents (Cursor, Cline, ..)
                and went viral on X after we open sourced it. However, the APIs
                of existing coding agents were very limiting, so we figured that
                building our own agent would unlock the full potential of
                stagewise.
              </p>
              <p>
                Here's how it works: When you run `npx stagewise`, our cli
                proxies your running web application in dev mode and injects a
                toolbar containing the coding agent on top of it. Each prompt
                you send will be enriched with browser context and sent to our
                cli, which will call our backend and modify the source code of
                your local codebase accordingly.
              </p>
              <p>
                Here's a demo of our agent changing the login UI of Cal.com, a
                popular open-source meeting scheduling app:
                <a href="https://www.youtube.com/watch?v=BkDcAozK9L4"
                  >https://www.youtube.com/watch?v=BkDcAozK9L4</a
                >.
              </p>
              <p>
                So far, we've seen great adoption from non-technical users who
                wanted to continue building their lovable prototype locally. We
                personally use the agent almost daily to make changes to our
                landing page and to build the UI of new features on our console
                (<a href="https://console.stagewise.io"
                  >https://console.stagewise.io</a
                >).
              </p>
              <p>
                If you have an app running in dev mode, simply `cd` into the app
                directory and run `npx stagewise` - the agent should appear,
                ready to play with.
              </p>
              <p>We're very excited to hear your feedback!</p>
            </div>
          </section>
        </section>
        <section id="44798434">
          <h3>
            <a class="item" href="https://prog21.dadgum.com/57.html"
              >No Comment (2010)</a
            >
          </h3>
          <section>
            <h4>
              <span>2025-08-05 @ 14:30:19</span
              ><span class="points-container"
                >Points: <span class="points">58</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=44798434"
                  >Comments</a
                ><span class="descendants">: 46</span></span
              >
            </h4>
          </section>
        </section>
        <section id="44798189">
          <h3>
            <a
              class="item"
              href="https://colton.dev/blog/curing-your-ai-10x-engineer-imposter-syndrome/"
              >Things that helped me get out of the AI 10x engineer imposter
              syndrome</a
            >
          </h3>
          <section>
            <h4>
              <span>2025-08-05 @ 14:10:42</span
              ><span class="points-container"
                >Points: <span class="points">659</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=44798189"
                  >Comments</a
                ><span class="descendants">: 505</span></span
              >
            </h4>
          </section>
        </section>
        <section id="44798166">
          <h3>
            <a
              class="item"
              href="https://deepmind.google/discover/blog/genie-3-a-new-frontier-for-world-models/"
              >Genie 3: A new frontier for world models</a
            >
          </h3>
          <section>
            <h4>
              <span>2025-08-05 @ 14:08:52</span
              ><span class="points-container"
                >Points: <span class="points">1031</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=44798166"
                  >Comments</a
                ><span class="descendants">: 380</span></span
              >
            </h4>
          </section>
        </section>
        <section id="44796953">
          <h3>
            <a class="item" href="https://www.buildyourownlisp.com/"
              >Build Your Own Lisp</a
            >
          </h3>
          <section>
            <h4>
              <span>2025-08-05 @ 11:55:20</span
              ><span class="points-container"
                >Points: <span class="points">213</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=44796953"
                  >Comments</a
                ><span class="descendants">: 56</span></span
              >
            </h4>
          </section>
        </section>
        <section id="44796526">
          <h3>
            <a
              class="item"
              href="https://www.science.org/content/article/scientific-fraud-has-become-industry-alarming-analysis-finds"
              >Scientific fraud has become an 'industry,' analysis finds</a
            >
          </h3>
          <section>
            <h4>
              <span>2025-08-05 @ 10:56:07</span
              ><span class="points-container"
                >Points: <span class="points">251</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=44796526"
                  >Comments</a
                ><span class="descendants">: 218</span></span
              >
            </h4>
          </section>
        </section>
        <section id="44795825">
          <h3>
            <a
              class="item"
              href="https://apps.apple.com/app/ublock-origin-lite/id6745342698"
              >uBlock Origin Lite now available for Safari</a
            >
          </h3>
          <section>
            <h4>
              <span>2025-08-05 @ 09:01:54</span
              ><span class="points-container"
                >Points: <span class="points">928</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=44795825"
                  >Comments</a
                ><span class="descendants">: 357</span></span
              >
            </h4>
          </section>
        </section>
        <section id="44794926">
          <h3>
            <a
              class="item"
              href="https://echarts.apache.org/handbook/en/basics/release-note/v6-feature/"
              >Apache ECharts 6</a
            >
          </h3>
          <section>
            <h4>
              <span>2025-08-05 @ 06:33:04</span
              ><span class="points-container"
                >Points: <span class="points">249</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=44794926"
                  >Comments</a
                ><span class="descendants">: 30</span></span
              >
            </h4>
          </section>
        </section>
        <section id="44793446">
          <h3>
            <a class="item" href="https://news.ycombinator.com/item?id=44793446"
              >Tell HN: Anthropic expires paid credits after a year</a
            >
          </h3>
          <section>
            <h4>
              <span>2025-08-05 @ 01:43:40</span
              ><span class="points-container"
                >Points: <span class="points">160</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=44793446"
                  >Comments</a
                ><span class="descendants">: 83</span></span
              >
            </h4>
            <div class="text">
              <p>&gt;</p>
              <p>
                &gt; To ensure uninterrupted service, we recommend enabling
                auto-reload for your organization. When enabled, weâ€™ll
                automatically add credits when your balance reaches a specified
                minimum. You can enable auto-reload in the Anthropic Console.
              </p>
            </div>
          </section>
        </section>
        <section id="44778810">
          <h3>
            <a
              class="item"
              href="https://publicdomainreview.org/collection/manifesto-antropofago/"
              >Cannibal Modernity: Oswald de Andrade's Manifesto AntropÃ³fago
              (1928)</a
            >
          </h3>
          <section>
            <h4>
              <span>2025-08-03 @ 18:59:47</span
              ><span class="points-container"
                >Points: <span class="points">18</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=44778810"
                  >Comments</a
                ><span class="descendants">: 2</span></span
              >
            </h4>
          </section>
        </section>
        <section id="44776695">
          <h3>
            <a
              class="item"
              href="https://leftarcode.com/posts/afd-reverse-engineering-part1/"
              >Under the Hood of AFD.sys Part 1: Investigating Undocumented
              Interfaces</a
            >
          </h3>
          <section>
            <h4>
              <span>2025-08-03 @ 14:06:47</span
              ><span class="points-container"
                >Points: <span class="points">20</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=44776695"
                  >Comments</a
                ><span class="descendants">: 5</span></span
              >
            </h4>
          </section>
        </section>
        <section id="44776505">
          <h3>
            <a
              class="item"
              href="https://www.bbc.com/news/articles/cglzl1ez283o"
              >The mystery of Winston Churchill's dead platypus was unsolved
              until now</a
            >
          </h3>
          <section>
            <h4>
              <span>2025-08-03 @ 13:35:40</span
              ><span class="points-container"
                >Points: <span class="points">31</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=44776505"
                  >Comments</a
                ><span class="descendants">: 7</span></span
              >
            </h4>
          </section>
        </section>
        <section id="44768745">
          <h3>
            <a
              class="item"
              href="https://www.uninformativ.de/blog/postings/2025-08-02/0/POSTING-en.html"
              >The X11 Security extension from the 1990s</a
            >
          </h3>
          <section>
            <h4>
              <span>2025-08-02 @ 16:06:33</span
              ><span class="points-container"
                >Points: <span class="points">40</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=44768745"
                  >Comments</a
                ><span class="descendants">: 18</span></span
              >
            </h4>
          </section>
        </section>
        <section id="44766771">
          <h3>
            <a class="item" href="https://news.ycombinator.com/item?id=44766771"
              >Ask HN: Have you ever regretted open-sourcing something?</a
            >
          </h3>
          <section>
            <h4>
              <span>2025-08-02 @ 11:37:00</span
              ><span class="points-container"
                >Points: <span class="points">79</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=44766771"
                  >Comments</a
                ><span class="descendants">: 115</span></span
              >
            </h4>
            <div class="text">
              <p>
                Maybe it became a burden to maintain, attracted the wrong users,
                or got used in ways you didnâ€™t expect.
              </p>
              <p>Would love to hear your experience - good or bad.</p>
            </div>
          </section>
        </section>
        <section id="44765981">
          <h3>
            <a
              class="item"
              href="https://www.wired.com/story/the-first-widespread-cure-for-hiv-could-be-in-children/"
              >The First Widespread Cure for HIV Could Be in Children</a
            >
          </h3>
          <section>
            <h4>
              <span>2025-08-02 @ 09:20:42</span
              ><span class="points-container"
                >Points: <span class="points">48</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=44765981"
                  >Comments</a
                ><span class="descendants">: 9</span></span
              >
            </h4>
          </section>
        </section>
      </section>
      <section id="archives">
        <h2>
          <a
            href="https://github.com/kherrick/hacker-news/blob/main/archives/index.md"
            >Archives</a
          >
        </h2>
        <section>
          <h3>
            <a
              href="https://github.com/kherrick/hacker-news/blob/main/archives/2025/index.md"
              >2025</a
            >
          </h3>
        </section>
        <section>
          <h3>
            <a
              href="https://github.com/kherrick/hacker-news/blob/main/archives/2024/index.md"
              >2024</a
            >
          </h3>
        </section>
        <section>
          <h3>
            <a
              href="https://github.com/kherrick/hacker-news/blob/main/archives/2023/index.md"
              >2023</a
            >
          </h3>
        </section>
        <section>
          <h3>
            <a
              href="https://github.com/kherrick/hacker-news/blob/main/archives/2022/index.md"
              >2022</a
            >
          </h3>
        </section>
      </section>
    </main>
    <script type="module">
      import { buildDescendants } from "./lib/build-html-descendants.js";
      import { buildNextItem } from "./lib/build-html-next-item.js";
      import { getNextDateTime } from "./lib/date-time.js";

      const updateSectionById = (id) =>
        fetch(`https://hacker-news.firebaseio.com/v0/item/${id}.json`).then(
          (result) =>
            result.json().then(({ descendants, id, score, text, type }) => {
              const currentItem = document.getElementById(id);

              if (score) {
                currentItem.querySelector(".points").textContent = score;
              }

              if (descendants && (type === "poll" || type === "story")) {
                const currentDescendants =
                  currentItem.querySelector(".descendants");

                if (currentDescendants) {
                  currentDescendants.textContent = `: ${descendants}`;
                } else {
                  const comments = buildDescendants(
                    document,
                    descendants,
                    `https://news.ycombinator.com/item?id=${id}`
                  );

                  currentItem.querySelector("h4").appendChild(comments);
                }
              }

              if (text) {
                const currentText = currentItem.querySelector(".text");

                if (currentText) {
                  currentText.innerHTML = text.replace(/\0/g, "");
                } else {
                  const content = document.createElement("div");
                  content.innerHTML = text.replace(/\0/g, "");
                  content.setAttribute("class", "text");

                  currentItem.appendChild(content);
                }
              }
            })
        );

      class UpdateQueue {
        constructor() {
          this._ids = [];
          this._isUpdating = false;
        }

        addItemById(id) {
          this._ids.push(id);
        }

        async flush() {
          const id = this._ids.shift();

          if (id) {
            this._isUpdating = true;

            await updateSectionById(id);
            await this.flush();
          } else {
            this._isUpdating = false;

            setTimeout(async () => {
              if (!this._isUpdating && this._ids && this._ids.length) {
                await this.flush();
              }
            }, 0);
          }
        }
      }

      // get latest data
      const latestSection = document.getElementById("latest");

      for (let item of latestSection.querySelectorAll("section[id]")) {
        updateSectionById(item.getAttribute("id"));
      }

      if ("IntersectionObserver" in window) {
        window.hackerNewsState = { index: [], nextTimeIndex: -1 };

        const addNewsItem = async (newsItem, queue) => {
          try {
            const { date, time, itemComments, itemTitle, itemLink } = newsItem;
            const section = await buildNextItem({
              document,
              dateTime: `${date}, ${time}`,
              itemComments,
              itemLink,
              itemTitle: new DOMParser().parseFromString(
                itemTitle.replace(/\\/g, ""),
                "text/html"
              ).documentElement.textContent,
              fetchItemDetails: false,
            });

            // display loading indicator for section
            section.querySelector(".points-container").innerHTML =
              'Points: <span class="points"><img style="height: 100%;" src="lib/images/loading.svg" /></span>';

            const id = section.getAttribute("id");
            if (!document.getElementById(id)) {
              document.getElementById("latest").appendChild(section);

              queue.addItemById(id);
            }
          } catch (error) {}
        };

        const buildArchiveIndex = async (lastDateTime) => {
          const nextDate = lastDateTime.slice(0, 10);
          const nextYear = nextDate.slice(0, 4);

          return (
            await (
              await fetch(
                `https://raw.githubusercontent.com/kherrick/hacker-news/main/archives/${nextYear}/${nextDate}/index.md`
              )
            ).text()
          )
            .split("\n")
            .filter((line) => line.match(new RegExp("^\\* \\[")))
            .map((line) => {
              const segment = line.replace("* ", "").split("](");
              const pubDate = segment[0].slice(1);

              const itemComments = segment[1].split(") - [")[0];
              const itemTitle = segment[1].split(") - [")[1];
              const itemLink = segment[2].slice(0, -1);
              const date = pubDate.slice(0, 10);
              const time = pubDate.slice(-8);

              return {
                date,
                itemComments,
                itemLink,
                itemTitle,
                time,
              };
            });
        };

        const handleIntersectingEntry = async (entry, queue) => {
          if (entry.isIntersecting) {
            const lastDateTime = document
              .getElementById("latest")
              .querySelector(
                "section:last-child > section > h4 > span"
              ).textContent;

            const nextDateTime = getNextDateTime(lastDateTime ?? "", -1);
            const archiveIndex = await buildArchiveIndex(nextDateTime);
            const nextTimeIndex = archiveIndex.findIndex(
              ({ time }) => time === nextDateTime.slice(-8)
            );

            const handleIndexUpdate = (index, existingIndexValues = []) => {
              index.forEach((i) => {
                existingIndexValues.push(i);
              });
              return existingIndexValues;
            };

            window.hackerNewsState = {
              index: handleIndexUpdate(
                archiveIndex,
                window.hackerNewsState.index
              ),
              nextTimeIndex,
            };

            let currentTimeIndex = nextTimeIndex + 1;
            const items = Object.values(window.hackerNewsState.index);
            for (let item of items) {
              if (currentTimeIndex < window.hackerNewsState.index.length) {
                addNewsItem(items[currentTimeIndex], queue);

                currentTimeIndex = currentTimeIndex + 1;
              }
            }

            queue.flush();
          }
        };

        const archives = document.getElementById("archives");
        const archivesObserver = new IntersectionObserver(
          (entries) => {
            const queue = new UpdateQueue();

            entries.forEach((entry) => handleIntersectingEntry(entry, queue));
          },
          {
            root: null,
            rootMargin: "0px",
            threshold: 0,
          }
        );

        archivesObserver.observe(archives);

        let latestSectionsExpanded = true;
        const handleLatestHeaderClick = () => {
          latestSectionsExpanded = !latestSectionsExpanded;

          if (latestSectionsExpanded) {
            archivesObserver.observe(archives);
          } else {
            archivesObserver.disconnect(archives);
          }

          for (let section of document.querySelectorAll("#latest > section")) {
            section.style.display = latestSectionsExpanded ? "block" : "none";
          }
        };

        const latestHeader = document.querySelector("#latest > h2");
        latestHeader.style.cursor = "pointer";
        latestHeader.addEventListener("click", handleLatestHeaderClick);
      }
    </script>
    <script type="module">
      import { Workbox } from "https://storage.googleapis.com/workbox-cdn/releases/6.4.1/workbox-window.prod.mjs";

      if ("serviceWorker" in navigator) {
        const base = document.querySelector("base");
        const serviceWorkerPath = `${
          base ? base.href.replace(/\/$/, "") : ""
        }/service-worker.js`;

        const wb = new Workbox(serviceWorkerPath);

        // setup event listeners
        wb.addEventListener("waiting", (event) => {
          wb.addEventListener("controlling", () => {
            window.location.reload();
          });

          wb.messageSkipWaiting();
        });

        wb.register();
      }
    </script>
  </body>
</html>
