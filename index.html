<!DOCTYPE html>
<html lang="en" xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta charset="utf-8" />
    <meta
      content="width=device-width, initial-scale=1.0, viewport-fit=cover"
      name="viewport"
    />
    <meta name="description" content="Hacker News" />
    <meta name="theme-color" content="#fff" />
    <title>Hacker News</title>
    <link rel="manifest" href="manifest.json" />
    <link
      href="data:image/x-icon;base64,AAABAAEAAQECAAEAAQA4AAAAFgAAACgAAAABAAAAAgAAAAEAAQAAAAAAAAAAAAAAAAAAAAAAAAAAAAABAAEAAQECAAEAAQA4AAAAFgAAACgAAAABAAAAAgAAAAEAAQAAAAAAAAAAAAAAAAAAAAAAAAAA"
      rel="icon"
      type="image/x-icon"
    />
    <link
      href="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAgAAAAIAAQMAAADOtka5AAAAA1BMVEUAAACnej3aAAAANklEQVR42u3BAQEAAACCIP+vbkhAAQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAB8G4IAAAFjdVCkAAAAAElFTkSuQmCC"
      rel="apple-touch-icon"
    />
    <style>
      /*<!--*/
      body {
        color: rgb(25, 25, 25);
        font-family: Verdana, Geneva, sans-serif;
        margin: 0;
      }

      a {
        text-decoration: none;
      }

      a:link,
      a:focus,
      a:hover,
      a:active {
        color: rgb(75, 75, 125);
      }

      a:visited {
        color: rgb(25, 25, 25);
      }

      h1 > a,
      h1 > a:link,
      h1 > a:focus,
      h1 > a:hover,
      h1 > a:active,
      h1 > a:visited,
      h2 > a,
      h2 > a:link,
      h2 > a:focus,
      h2 > a:hover,
      h2 > a:active,
      h2 > a:visited {
        color: rgb(25, 25, 25);
      }

      h1 {
        background-color: rgb(255, 102, 0);
        margin: 0;
        padding: 1rem;
      }

      h2 {
        background-color: rgb(200, 200, 200);
        margin: 1rem 0;
        padding: 0.5rem 0.5rem 0.5rem 1rem;
      }

      #latest > section,
      #archives > section {
        margin: 0 1rem 1rem 1rem;
        padding-bottom: 1rem;
      }

      #latest > section:not(:last-child),
      #archives > section:not(:last-child) {
        border-bottom: 1px dotted rgb(200, 200, 200);
      }

      section > h3 {
        margin: 0 0 0.5rem 0;
      }

      section > h4 {
        font-weight: normal;
        margin: 0 0 0 1rem;
      }

      .descendants-container,
      .points-container {
        align-items: center;
        border-left: 1px solid #333;
        display: inline-flex;
        margin-left: 0.5rem;
        padding-left: 0.5rem;
        text-align: center;
      }

      .points {
        align-items: center;
        display: inline-flex;
        height: 1rem;
        margin-left: 1ch;
        min-width: 3ch;
      }

      .text {
        line-height: 1.5rem;
        margin: 1rem 1rem 0 1rem;
        overflow: auto;
      }

      .text > p:first-child {
        margin-top: 1rem;
      }

      .text > p:last-child {
        margin-bottom: 0;
      }
      /*-->*/
    </style>
  </head>

  <body>
    <main>
      <h1><a href="https://kherrick.github.io/hacker-news/">Hacker News</a></h1>
      <section id="latest">
        <h2>Latest</h2>
        <section id="39490247">
          <h3>
            <a class="item" href="https://ipbl.herrbischoff.com/"
              >Herr Bischoff's Spam Blocklists</a
            >
          </h3>
          <section>
            <h4>
              <span>2024-02-24 @ 09:08:48</span
              ><span class="points-container"
                >Points: <span class="points">7</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=39490247"
                  >Comments</a
                ><span class="descendants">: 0</span></span
              >
            </h4>
          </section>
        </section>
        <section id="39490139">
          <h3>
            <a
              class="item"
              href="https://jnsgr.uk/2024/02/contributing-scrutiny-to-nixpkgs/"
              >Contributing Scrutiny to Nixpkgs</a
            >
          </h3>
          <section>
            <h4>
              <span>2024-02-24 @ 08:39:55</span
              ><span class="points-container"
                >Points: <span class="points">6</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=39490139"
                  >Comments</a
                ><span class="descendants">: 0</span></span
              >
            </h4>
          </section>
        </section>
        <section id="39490075">
          <h3>
            <a
              class="item"
              href="https://kirbysayshi.com/2020/03/21/considering-then-abandoning-jsx-for-structured-yaml-config.html"
              >Considering then abandoning JSX for structured YAML config</a
            >
          </h3>
          <section>
            <h4>
              <span>2024-02-24 @ 08:26:47</span
              ><span class="points-container"
                >Points: <span class="points">13</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=39490075"
                  >Comments</a
                ><span class="descendants">: 2</span></span
              >
            </h4>
          </section>
        </section>
        <section id="39489920">
          <h3>
            <a
              class="item"
              href="https://notes.atomutek.org/power-metal-and-dragons.html"
              >Power Metal: is it really about dragons? (2018)</a
            >
          </h3>
          <section>
            <h4>
              <span>2024-02-24 @ 07:47:15</span
              ><span class="points-container"
                >Points: <span class="points">74</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=39489920"
                  >Comments</a
                ><span class="descendants">: 17</span></span
              >
            </h4>
          </section>
        </section>
        <section id="39489660">
          <h3>
            <a
              class="item"
              href="https://www.quantamagazine.org/never-repeating-tiles-can-safeguard-quantum-information-20240223/"
              >Never-Repeating Tiles Can Safeguard Quantum Information</a
            >
          </h3>
          <section>
            <h4>
              <span>2024-02-24 @ 06:43:23</span
              ><span class="points-container"
                >Points: <span class="points">26</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=39489660"
                  >Comments</a
                ><span class="descendants">: 2</span></span
              >
            </h4>
          </section>
        </section>
        <section id="39489519">
          <h3>
            <a
              class="item"
              href="https://www.pcloadletter.dev/blog/big-tech-quality/"
              >Quality is a hard sell in big tech</a
            >
          </h3>
          <section>
            <h4>
              <span>2024-02-24 @ 06:09:46</span
              ><span class="points-container"
                >Points: <span class="points">103</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=39489519"
                  >Comments</a
                ><span class="descendants">: 80</span></span
              >
            </h4>
          </section>
        </section>
        <section id="39488836">
          <h3>
            <a
              class="item"
              href="https://btxx.org/posts/Please_Make_Your_Table_Headings_Sticky/"
              >Please make your table headings sticky</a
            >
          </h3>
          <section>
            <h4>
              <span>2024-02-24 @ 03:16:51</span
              ><span class="points-container"
                >Points: <span class="points">157</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=39488836"
                  >Comments</a
                ><span class="descendants">: 39</span></span
              >
            </h4>
          </section>
        </section>
        <section id="39488833">
          <h3>
            <a
              class="item"
              href="https://jbennetcodes.medium.com/how-to-lose-two-jobs-in-one-year-e8e428702b91"
              >Losing two jobs in one year</a
            >
          </h3>
          <section>
            <h4>
              <span>2024-02-24 @ 03:16:05</span
              ><span class="points-container"
                >Points: <span class="points">168</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=39488833"
                  >Comments</a
                ><span class="descendants">: 96</span></span
              >
            </h4>
          </section>
        </section>
        <section id="39488719">
          <h3>
            <a
              class="item"
              href="https://exaspark.medium.com/the-ultimate-guide-to-postgresql-data-change-tracking-c3fa88779572"
              >The Ultimate Guide to PostgreSQL Data Change Tracking</a
            >
          </h3>
          <section>
            <h4>
              <span>2024-02-24 @ 02:54:22</span
              ><span class="points-container"
                >Points: <span class="points">65</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=39488719"
                  >Comments</a
                ><span class="descendants">: 6</span></span
              >
            </h4>
          </section>
        </section>
        <section id="39488668">
          <h3>
            <a
              class="item"
              href="https://explainextended.com/2023/12/31/happy-new-year-15/"
              >GPT in 500 Lines of SQL</a
            >
          </h3>
          <section>
            <h4>
              <span>2024-02-24 @ 02:45:31</span
              ><span class="points-container"
                >Points: <span class="points">485</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=39488668"
                  >Comments</a
                ><span class="descendants">: 27</span></span
              >
            </h4>
          </section>
        </section>
        <section id="39488529">
          <h3>
            <a class="item" href="https://github.com/Victormeriqui/Consol3"
              >Show HN: Consol3 – A 3D engine for the terminal that executes on
              the CPU</a
            >
          </h3>
          <section>
            <h4>
              <span>2024-02-24 @ 02:17:42</span
              ><span class="points-container"
                >Points: <span class="points">94</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=39488529"
                  >Comments</a
                ><span class="descendants">: 10</span></span
              >
            </h4>
            <div class="text">
              <p>This has been my hobby project for quite a few years now</p>
              <p>
                It started as a small engine to serve as a sandbox to try out
                new 3d graphics ideas
              </p>
              <p>
                After adding many features through out the years and re-writing
                the entire engine a few times, this is the latest state
              </p>
              <p>
                It currently supports loading models with animations, textures,
                lights, shadow maps, normal maps, and some other goodies
              </p>
              <p>
                I've also recently added voxel raymarching as an alternative
                renderer, along with a fun physics simulation :)
              </p>
            </div>
          </section>
        </section>
        <section id="39488375">
          <h3>
            <a
              class="item"
              href="https://spectrum.ieee.org/data-storage-petabit-optical-disc"
              >DVD's New Cousin Can Store More Than a Petabit</a
            >
          </h3>
          <section>
            <h4>
              <span>2024-02-24 @ 01:44:00</span
              ><span class="points-container"
                >Points: <span class="points">70</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=39488375"
                  >Comments</a
                ><span class="descendants">: 41</span></span
              >
            </h4>
          </section>
        </section>
        <section id="39487341">
          <h3>
            <a
              class="item"
              href="https://www.theverge.com/2024/2/23/24081249/slack-slackbot-gizmodo-tom-mckay"
              >A former Gizmodo writer changed name to 'Slackbot', stayed
              undetected for months</a
            >
          </h3>
          <section>
            <h4>
              <span>2024-02-23 @ 23:10:11</span
              ><span class="points-container"
                >Points: <span class="points">272</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=39487341"
                  >Comments</a
                ><span class="descendants">: 88</span></span
              >
            </h4>
          </section>
        </section>
        <section id="39487124">
          <h3>
            <a class="item" href="https://intrinsic-lora.github.io/"
              >Generative Models: What do they know? Do they know things? Let's
              find out</a
            >
          </h3>
          <section>
            <h4>
              <span>2024-02-23 @ 22:46:46</span
              ><span class="points-container"
                >Points: <span class="points">261</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=39487124"
                  >Comments</a
                ><span class="descendants">: 74</span></span
              >
            </h4>
          </section>
        </section>
        <section id="39487026">
          <h3>
            <a class="item" href="https://joshuabird.com/blog/post/mocap-drones"
              >Open Source Motion Capture for Autonomous Drones (2023)</a
            >
          </h3>
          <section>
            <h4>
              <span>2024-02-23 @ 22:35:30</span
              ><span class="points-container"
                >Points: <span class="points">56</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=39487026"
                  >Comments</a
                ><span class="descendants">: 8</span></span
              >
            </h4>
          </section>
        </section>
        <section id="39486717">
          <h3>
            <a
              class="item"
              href="https://read.engineerscodex.com/p/metas-new-llm-based-test-generator"
              >Meta's new LLM-based test generator</a
            >
          </h3>
          <section>
            <h4>
              <span>2024-02-23 @ 22:04:58</span
              ><span class="points-container"
                >Points: <span class="points">296</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=39486717"
                  >Comments</a
                ><span class="descendants">: 149</span></span
              >
            </h4>
          </section>
        </section>
        <section id="39486517">
          <h3>
            <a
              class="item"
              href="https://jobs.lever.co/glass-health-inc?team=Product%20%26%20Engineering"
              >Glass Health (YC W23) is hiring across multiple engineering
              roles</a
            >
          </h3>
          <section>
            <h4>
              <span>2024-02-23 @ 21:45:03</span
              ><span class="points-container"
                >Points: <span class="points">1</span></span
              >
            </h4>
          </section>
        </section>
        <section id="39485996">
          <h3>
            <a class="item" href="https://pubmed.ncbi.nlm.nih.gov/38012960/"
              >Emergence of stone-tool use behavior in a population of common
              macaques</a
            >
          </h3>
          <section>
            <h4>
              <span>2024-02-23 @ 20:57:30</span
              ><span class="points-container"
                >Points: <span class="points">59</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=39485996"
                  >Comments</a
                ><span class="descendants">: 21</span></span
              >
            </h4>
          </section>
        </section>
        <section id="39484907">
          <h3>
            <a class="item" href="https://scuttlebutt.nz/"
              >Scuttlebutt social network: a decentralised platform</a
            >
          </h3>
          <section>
            <h4>
              <span>2024-02-23 @ 19:14:18</span
              ><span class="points-container"
                >Points: <span class="points">198</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=39484907"
                  >Comments</a
                ><span class="descendants">: 112</span></span
              >
            </h4>
          </section>
        </section>
        <section id="39484590">
          <h3>
            <a class="item" href="https://refractify.io/"
              >Show HN: Refractify – Optical software against myopia</a
            >
          </h3>
          <section>
            <h4>
              <span>2024-02-23 @ 18:47:23</span
              ><span class="points-container"
                >Points: <span class="points">121</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=39484590"
                  >Comments</a
                ><span class="descendants">: 37</span></span
              >
            </h4>
            <div class="text">
              <p>
                So I quit my job and implemented this software, did a short
                video with a 3D artist about it.
              </p>
              <p>
                Turns out marketing is expensive, so I made an open source
                browser extension version too.
              </p>
              <p>How it works?</p>
              <p>
                There is a small neural network on the retina that tries to
                detect if the eye is far-sighted(most people are born
                far-sighted), and it is producing dopamine to slow or increase
                eye growth rate. It is not very smart, and if you do a lot of
                near-work it can think you are still hyperopic, causing further
                myopia progression.
              </p>
              <p>
                So, based on the refractive properties of the eye the software
                calculates the signal that would convince the retinal neural
                network that the eye is long enough, so it would produce
                dopamine, a known signal to stop axial eye growth. (based on
                myopic defocus LCA from the papers[2][3])
              </p>
              <p>
                Some myopia control techniques work similarly, like MiSight and
                Hoya lenses.
              </p>
              <p>
                Since then I got a Neurobiologist co-founder and the goal is to
                best understand the Retinal NN to create the best anti-myopic
                effect that does not interfere with productivity.
              </p>
              <p>
                The effect can be tried live on the site. Also check out the
                github repo. Any questions suggestions welcome!
              </p>
              <p>
                [1]
                <a href="https://news.ycombinator.com/item?id=37019143"
                  >https://news.ycombinator.com/item?id=37019143</a
                >
                [2]
                <a href="https://www.nature.com/articles/s41598-022-26323-7"
                  >https://www.nature.com/articles/s41598-022-26323-7</a
                >
                [3]
                <a
                  href="https://www.sciencedirect.com/science/article/abs/pii/S0014483522002676?via%3Dihub"
                  >https://www.sciencedirect.com/science/article/abs/pii/S00144...</a
                >
              </p>
            </div>
          </section>
        </section>
        <section id="39483482">
          <h3>
            <a class="item" href="https://ok-robot.github.io/"
              >Show HN: OK-Robot: open, modular home robot framework for
              pick-and-drop anywhere</a
            >
          </h3>
          <section>
            <h4>
              <span>2024-02-23 @ 17:23:23</span
              ><span class="points-container"
                >Points: <span class="points">459</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=39483482"
                  >Comments</a
                ><span class="descendants">: 97</span></span
              >
            </h4>
            <div class="text">
              <p>
                We based everything off of the current best machine learning
                models, and so things don't quite work perfectly all the time,
                so we are hoping to build it together with the community! Our
                code is open:
                <a href="https://github.com/ok-robot/ok-robot"
                  >https://github.com/ok-robot/ok-robot</a
                >
                and we have a Discord server for discussion and support:
                <a href="https://discord.gg/wzzZJxqKYC"
                  >https://discord.gg/wzzZJxqKYC</a
                >
                If you are curious what works and what doesn't work, take a
                quick look at
                <a href="https://ok-robot.github.io/#analysis"
                  >https://ok-robot.github.io/#analysis</a
                >
                or read our paper for a detailed analysis:
                <a href="https://arxiv.org/abs/2401.12202"
                  >https://arxiv.org/abs/2401.12202</a
                >
              </p>
              <p>
                P.S.: while the code is open the project unfortunately isn't
                fully open source since one of our dependencies, AnyGrasp, has a
                closed-source, educational license. Apologize in advance, but we
                used it since that was the best grasping model we could have
                access to!
              </p>
              <p>
                Would love to hear more thoughts and feedback on this project!
              </p>
            </div>
          </section>
        </section>
        <section id="39481554">
          <h3>
            <a class="item" href="https://github.com/google/gemma.cpp"
              >Gemma.cpp: lightweight, standalone C++ inference engine for Gemma
              models</a
            >
          </h3>
          <section>
            <h4>
              <span>2024-02-23 @ 15:15:23</span
              ><span class="points-container"
                >Points: <span class="points">380</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=39481554"
                  >Comments</a
                ><span class="descendants">: 127</span></span
              >
            </h4>
          </section>
        </section>
        <section id="39479278">
          <h3>
            <a
              class="item"
              href="http://www.os2museum.com/wp/unlocking-netware-2-0a/"
              >Unlocking NetWare 2.0a</a
            >
          </h3>
          <section>
            <h4>
              <span>2024-02-23 @ 11:19:48</span
              ><span class="points-container"
                >Points: <span class="points">24</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=39479278"
                  >Comments</a
                ><span class="descendants">: 1</span></span
              >
            </h4>
          </section>
        </section>
        <section id="39478935">
          <h3>
            <a
              class="item"
              href="https://maxrozen.com/lessons-from-my-third-year-running-a-saas"
              >Lessons from my third year running a SaaS</a
            >
          </h3>
          <section>
            <h4>
              <span>2024-02-23 @ 10:14:20</span
              ><span class="points-container"
                >Points: <span class="points">52</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=39478935"
                  >Comments</a
                ><span class="descendants">: 9</span></span
              >
            </h4>
          </section>
        </section>
        <section id="39478860">
          <h3>
            <a class="item" href="http://shoesrb.com/"
              >Shoes makes building little graphical programs for Mac, Windows,
              Linux simple</a
            >
          </h3>
          <section>
            <h4>
              <span>2024-02-23 @ 10:03:33</span
              ><span class="points-container"
                >Points: <span class="points">80</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=39478860"
                  >Comments</a
                ><span class="descendants">: 19</span></span
              >
            </h4>
          </section>
        </section>
        <section id="39478441">
          <h3>
            <a class="item" href="https://susam.net/lisp-in-vim.html"
              >Lisp Programming with Vim (2019)</a
            >
          </h3>
          <section>
            <h4>
              <span>2024-02-23 @ 08:57:35</span
              ><span class="points-container"
                >Points: <span class="points">56</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=39478441"
                  >Comments</a
                ><span class="descendants">: 3</span></span
              >
            </h4>
          </section>
        </section>
        <section id="39478074">
          <h3>
            <a
              class="item"
              href="http://lembransation.blogspot.com/2022/01/ten-years-of-remembering-every-day-that.html"
              >Ten years of remembering every day that passes</a
            >
          </h3>
          <section>
            <h4>
              <span>2024-02-23 @ 08:03:43</span
              ><span class="points-container"
                >Points: <span class="points">36</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=39478074"
                  >Comments</a
                ><span class="descendants">: 5</span></span
              >
            </h4>
          </section>
        </section>
        <section id="39477821">
          <h3>
            <a class="item" href="https://go.dev/blog/generic-slice-functions"
              >Go(lang): Robust generic functions on slices</a
            >
          </h3>
          <section>
            <h4>
              <span>2024-02-23 @ 07:19:03</span
              ><span class="points-container"
                >Points: <span class="points">74</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=39477821"
                  >Comments</a
                ><span class="descendants">: 24</span></span
              >
            </h4>
          </section>
        </section>
        <section id="39465932">
          <h3>
            <a class="item" href="https://codeberg.org/amano.kenji/j3blocks"
              >J3blocks is a Janet scripting system for i3bar and swaybar</a
            >
          </h3>
          <section>
            <h4>
              <span>2024-02-22 @ 12:06:36</span
              ><span class="points-container"
                >Points: <span class="points">41</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=39465932"
                  >Comments</a
                ><span class="descendants">: 5</span></span
              >
            </h4>
          </section>
        </section>
        <section id="39465258">
          <h3>
            <a class="item" href="https://lilypond.org/"
              >LilyPond: Music notation for everyone</a
            >
          </h3>
          <section>
            <h4>
              <span>2024-02-22 @ 10:22:08</span
              ><span class="points-container"
                >Points: <span class="points">242</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=39465258"
                  >Comments</a
                ><span class="descendants">: 68</span></span
              >
            </h4>
          </section>
        </section>
      </section>
      <section id="archives">
        <h2>
          <a
            href="https://github.com/kherrick/hacker-news/blob/main/archives/index.md"
            >Archives</a
          >
        </h2>
        <section>
          <h3>
            <a
              href="https://github.com/kherrick/hacker-news/blob/main/archives/2024/index.md"
              >2024</a
            >
          </h3>
        </section>
        <section>
          <h3>
            <a
              href="https://github.com/kherrick/hacker-news/blob/main/archives/2023/index.md"
              >2023</a
            >
          </h3>
        </section>
        <section>
          <h3>
            <a
              href="https://github.com/kherrick/hacker-news/blob/main/archives/2022/index.md"
              >2022</a
            >
          </h3>
        </section>
      </section>
    </main>
    <script type="module">
      import { buildDescendants } from "./lib/build-html-descendants.js";
      import { buildNextItem } from "./lib/build-html-next-item.js";
      import { getNextDateTime } from "./lib/date-time.js";

      const updateSectionById = (id) =>
        fetch(`https://hacker-news.firebaseio.com/v0/item/${id}.json`).then(
          (result) =>
            result.json().then(({ descendants, id, score, text, type }) => {
              const currentItem = document.getElementById(id);

              if (score) {
                currentItem.querySelector(".points").textContent = score;
              }

              if (descendants && (type === "poll" || type === "story")) {
                const currentDescendants =
                  currentItem.querySelector(".descendants");

                if (currentDescendants) {
                  currentDescendants.textContent = `: ${descendants}`;
                } else {
                  const comments = buildDescendants(
                    document,
                    descendants,
                    `https://news.ycombinator.com/item?id=${id}`
                  );

                  currentItem.querySelector("h4").appendChild(comments);
                }
              }

              if (text) {
                const currentText = currentItem.querySelector(".text");

                if (currentText) {
                  currentText.innerHTML = text.replace(/\0/g, "");
                } else {
                  const content = document.createElement("div");
                  content.innerHTML = text.replace(/\0/g, "");
                  content.setAttribute("class", "text");

                  currentItem.appendChild(content);
                }
              }
            })
        );

      class UpdateQueue {
        constructor() {
          this._ids = [];
          this._isUpdating = false;
        }

        addItemById(id) {
          this._ids.push(id);
        }

        async flush() {
          const id = this._ids.shift();

          if (id) {
            this._isUpdating = true;

            await updateSectionById(id);
            await this.flush();
          } else {
            this._isUpdating = false;

            setTimeout(async () => {
              if (!this._isUpdating && this._ids && this._ids.length) {
                await this.flush();
              }
            }, 0);
          }
        }
      }

      // get latest data
      const latestSection = document.getElementById("latest");

      for (let item of latestSection.querySelectorAll("section[id]")) {
        updateSectionById(item.getAttribute("id"));
      }

      if ("IntersectionObserver" in window) {
        window.hackerNewsState = { index: [], nextTimeIndex: -1 };

        const addNewsItem = async (newsItem, queue) => {
          try {
            const { date, time, itemComments, itemTitle, itemLink } = newsItem;
            const section = await buildNextItem({
              document,
              dateTime: `${date}, ${time}`,
              itemComments,
              itemLink,
              itemTitle: new DOMParser().parseFromString(
                itemTitle.replace(/\\/g, ""),
                "text/html"
              ).documentElement.textContent,
              fetchItemDetails: false,
            });

            // display loading indicator for section
            section.querySelector(".points-container").innerHTML =
              'Points: <span class="points"><img style="height: 100%;" src="lib/images/loading.svg" /></span>';

            const id = section.getAttribute("id");
            if (!document.getElementById(id)) {
              document.getElementById("latest").appendChild(section);

              queue.addItemById(id);
            }
          } catch (error) {}
        };

        const buildArchiveIndex = async (lastDateTime) => {
          const nextDate = lastDateTime.slice(0, 10);
          const nextYear = nextDate.slice(0, 4);

          return (
            await (
              await fetch(
                `https://raw.githubusercontent.com/kherrick/hacker-news/main/archives/${nextYear}/${nextDate}/index.md`
              )
            ).text()
          )
            .split("\n")
            .filter((line) => line.match(new RegExp("^\\* \\[")))
            .map((line) => {
              const segment = line.replace("* ", "").split("](");
              const pubDate = segment[0].slice(1);

              const itemComments = segment[1].split(") - [")[0];
              const itemTitle = segment[1].split(") - [")[1];
              const itemLink = segment[2].slice(0, -1);
              const date = pubDate.slice(0, 10);
              const time = pubDate.slice(-8);

              return {
                date,
                itemComments,
                itemLink,
                itemTitle,
                time,
              };
            });
        };

        const handleIntersectingEntry = async (entry, queue) => {
          if (entry.isIntersecting) {
            const lastDateTime = document
              .getElementById("latest")
              .querySelector(
                "section:last-child > section > h4 > span"
              ).textContent;

            const nextDateTime = getNextDateTime(lastDateTime ?? "", -1);
            const archiveIndex = await buildArchiveIndex(nextDateTime);
            const nextTimeIndex = archiveIndex.findIndex(
              ({ time }) => time === nextDateTime.slice(-8)
            );

            const handleIndexUpdate = (index, existingIndexValues = []) => {
              index.forEach((i) => {
                existingIndexValues.push(i);
              });
              return existingIndexValues;
            };

            window.hackerNewsState = {
              index: handleIndexUpdate(
                archiveIndex,
                window.hackerNewsState.index
              ),
              nextTimeIndex,
            };

            let currentTimeIndex = nextTimeIndex + 1;
            const items = Object.values(window.hackerNewsState.index);
            for (let item of items) {
              if (currentTimeIndex < window.hackerNewsState.index.length) {
                addNewsItem(items[currentTimeIndex], queue);

                currentTimeIndex = currentTimeIndex + 1;
              }
            }

            queue.flush();
          }
        };

        const archives = document.getElementById("archives");
        const archivesObserver = new IntersectionObserver(
          (entries) => {
            const queue = new UpdateQueue();

            entries.forEach((entry) => handleIntersectingEntry(entry, queue));
          },
          {
            root: null,
            rootMargin: "0px",
            threshold: 0,
          }
        );

        archivesObserver.observe(archives);

        let latestSectionsExpanded = true;
        const handleLatestHeaderClick = () => {
          latestSectionsExpanded = !latestSectionsExpanded;

          if (latestSectionsExpanded) {
            archivesObserver.observe(archives);
          } else {
            archivesObserver.disconnect(archives);
          }

          for (let section of document.querySelectorAll("#latest > section")) {
            section.style.display = latestSectionsExpanded ? "block" : "none";
          }
        };

        const latestHeader = document.querySelector("#latest > h2");
        latestHeader.style.cursor = "pointer";
        latestHeader.addEventListener("click", handleLatestHeaderClick);
      }
    </script>
    <script type="module">
      import { Workbox } from "https://storage.googleapis.com/workbox-cdn/releases/6.4.1/workbox-window.prod.mjs";

      if ("serviceWorker" in navigator) {
        const base = document.querySelector("base");
        const serviceWorkerPath = `${
          base ? base.href.replace(/\/$/, "") : ""
        }/service-worker.js`;

        const wb = new Workbox(serviceWorkerPath);

        // setup event listeners
        wb.addEventListener("waiting", (event) => {
          wb.addEventListener("controlling", () => {
            window.location.reload();
          });

          wb.messageSkipWaiting();
        });

        wb.register();
      }
    </script>
  </body>
</html>
