<!DOCTYPE html>
<html lang="en" xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta charset="utf-8" />
    <meta
      content="width=device-width, initial-scale=1.0, viewport-fit=cover"
      name="viewport"
    />
    <meta name="description" content="Hacker News" />
    <meta name="theme-color" content="#fff" />
    <title>Hacker News</title>
    <link rel="manifest" href="manifest.json" />
    <link
      href="data:image/x-icon;base64,AAABAAEAAQECAAEAAQA4AAAAFgAAACgAAAABAAAAAgAAAAEAAQAAAAAAAAAAAAAAAAAAAAAAAAAAAAABAAEAAQECAAEAAQA4AAAAFgAAACgAAAABAAAAAgAAAAEAAQAAAAAAAAAAAAAAAAAAAAAAAAAA"
      rel="icon"
      type="image/x-icon"
    />
    <link
      href="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAgAAAAIAAQMAAADOtka5AAAAA1BMVEUAAACnej3aAAAANklEQVR42u3BAQEAAACCIP+vbkhAAQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAB8G4IAAAFjdVCkAAAAAElFTkSuQmCC"
      rel="apple-touch-icon"
    />
    <style>
      /*<!--*/
      body {
        color: rgb(25, 25, 25);
        font-family: Verdana, Geneva, sans-serif;
        margin: 0;
      }

      a {
        text-decoration: none;
      }

      a:link,
      a:focus,
      a:hover,
      a:active {
        color: rgb(75, 75, 125);
      }

      a:visited {
        color: rgb(25, 25, 25);
      }

      h1 > a,
      h1 > a:link,
      h1 > a:focus,
      h1 > a:hover,
      h1 > a:active,
      h1 > a:visited,
      h2 > a,
      h2 > a:link,
      h2 > a:focus,
      h2 > a:hover,
      h2 > a:active,
      h2 > a:visited {
        color: rgb(25, 25, 25);
      }

      h1 {
        background-color: rgb(255, 102, 0);
        margin: 0;
        padding: 1rem;
      }

      h2 {
        background-color: rgb(200, 200, 200);
        margin: 1rem 0;
        padding: 0.5rem 0.5rem 0.5rem 1rem;
      }

      #latest > section,
      #archives > section {
        margin: 0 1rem 1rem 1rem;
        padding-bottom: 1rem;
      }

      #latest > section:not(:last-child),
      #archives > section:not(:last-child) {
        border-bottom: 1px dotted rgb(200, 200, 200);
      }

      section > h3 {
        margin: 0 0 0.5rem 0;
      }

      section > h4 {
        font-weight: normal;
        margin: 0 0 0 1rem;
      }

      .descendants-container,
      .points-container {
        align-items: center;
        border-left: 1px solid #333;
        display: inline-flex;
        margin-left: 0.5rem;
        padding-left: 0.5rem;
        text-align: center;
      }

      .points {
        align-items: center;
        display: inline-flex;
        height: 1rem;
        margin-left: 1ch;
        min-width: 3ch;
      }

      .text {
        line-height: 1.5rem;
        margin: 1rem 1rem 0 1rem;
        overflow: auto;
      }

      .text > p:first-child {
        margin-top: 1rem;
      }

      .text > p:last-child {
        margin-bottom: 0;
      }
      /*-->*/
    </style>
  </head>

  <body>
    <main>
      <h1><a href="https://kherrick.github.io/hacker-news/">Hacker News</a></h1>
      <section id="latest">
        <h2>Latest</h2>
        <section id="42966455">
          <h3>
            <a class="item" href="https://news.ycombinator.com/item?id=42966455"
              >Verse (YC W22) Is Hiring</a
            >
          </h3>
          <section>
            <h4>
              <span>2025-02-06 @ 21:00:23</span
              ><span class="points-container"
                >Points: <span class="points">1</span></span
              >
            </h4>
            <div class="text">
              <p>
                Verse is one of the fastest platforms ever to reach over 10
                million users. We're building a home on the internet for people
                to showcase their identity with unlimited expression and keep up
                with their friends. If you’re looking for the crazy consumer
                startup ride where you build products that millions of people
                use, this is the place for you. Even our last product, Discz,
                was coined “one of the hottest music apps in the world” by
                Rolling Stone. We are a lean team based out of NYC that is
                backed by top VCs including Union Square Ventures, Greylock, and
                Y Combinator.
              </p>
              <p>
                Apply here:
                <a href="https://www.ycombinator.com/companies/verse/jobs"
                  >https://www.ycombinator.com/companies/verse/jobs</a
                >
              </p>
            </div>
          </section>
        </section>
        <section id="42965954">
          <h3>
            <a class="item" href="https://github.com/agentsea/r1-computer-use"
              >R1 Computer Use</a
            >
          </h3>
          <section>
            <h4>
              <span>2025-02-06 @ 20:02:03</span
              ><span class="points-container"
                >Points: <span class="points">93</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=42965954"
                  >Comments</a
                ><span class="descendants">: 42</span></span
              >
            </h4>
          </section>
        </section>
        <section id="42965627">
          <h3>
            <a class="item" href="https://en.wikipedia.org/wiki/Perpetual_stew"
              >Perpetual Stew</a
            >
          </h3>
          <section>
            <h4>
              <span>2025-02-06 @ 19:27:37</span
              ><span class="points-container"
                >Points: <span class="points">38</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=42965627"
                  >Comments</a
                ><span class="descendants">: 41</span></span
              >
            </h4>
          </section>
        </section>
        <section id="42965404">
          <h3>
            <a
              class="item"
              href="https://devblogs.microsoft.com/go/go-1-24-fips-update/"
              >Microsoft Go 1.24 FIPS changes</a
            >
          </h3>
          <section>
            <h4>
              <span>2025-02-06 @ 19:03:50</span
              ><span class="points-container"
                >Points: <span class="points">54</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=42965404"
                  >Comments</a
                ><span class="descendants">: 37</span></span
              >
            </h4>
          </section>
        </section>
        <section id="42965267">
          <h3>
            <a
              class="item"
              href="https://github.com/US-Artificial-Intelligence/scraper"
              >Self-hosted, simple web browser service – send URL, get
              screenshots</a
            >
          </h3>
          <section>
            <h4>
              <span>2025-02-06 @ 18:48:05</span
              ><span class="points-container"
                >Points: <span class="points">80</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=42965267"
                  >Comments</a
                ><span class="descendants">: 44</span></span
              >
            </h4>
          </section>
        </section>
        <section id="42965198">
          <h3>
            <a
              class="item"
              href="https://github.com/QuadrupleA/sqlite-page-explorer"
              >SQLite Disk Page Explorer</a
            >
          </h3>
          <section>
            <h4>
              <span>2025-02-06 @ 18:40:30</span
              ><span class="points-container"
                >Points: <span class="points">125</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=42965198"
                  >Comments</a
                ><span class="descendants">: 19</span></span
              >
            </h4>
          </section>
        </section>
        <section id="42964773">
          <h3>
            <a
              class="item"
              href="https://blog.pierre-ricadat.com/scala-3-migration-report-from-the-field"
              >Scala 3 Migration: Report from the Field</a
            >
          </h3>
          <section>
            <h4>
              <span>2025-02-06 @ 17:54:50</span
              ><span class="points-container"
                >Points: <span class="points">102</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=42964773"
                  >Comments</a
                ><span class="descendants">: 34</span></span
              >
            </h4>
          </section>
        </section>
        <section id="42963501">
          <h3>
            <a class="item" href="https://jdh.hamkins.org/transfinite-nim/"
              >Transfinite NIM (the game, not the programming language)</a
            >
          </h3>
          <section>
            <h4>
              <span>2025-02-06 @ 15:48:54</span
              ><span class="points-container"
                >Points: <span class="points">55</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=42963501"
                  >Comments</a
                ><span class="descendants">: 14</span></span
              >
            </h4>
          </section>
        </section>
        <section id="42963346">
          <h3>
            <a class="item" href="https://thestrikeagency.com/kaos/"
              >Show HN: An homage to Tom Dowdy's 1991 screensaver, "Kaos"</a
            >
          </h3>
          <section>
            <h4>
              <span>2025-02-06 @ 15:35:32</span
              ><span class="points-container"
                >Points: <span class="points">98</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=42963346"
                  >Comments</a
                ><span class="descendants">: 49</span></span
              >
            </h4>
            <div class="text">
              <p>
                Kaos would take anywhere from 10 to 30 seconds to slowly iterate
                on a single image, starting with a few colored dots and growing
                into webs within webs of algorithmic beauty.
              </p>
              <p>
                I'm not sure how Tom Dowdy actually wrote the program. What I've
                done here is to try to reverse engineer how it might have
                worked, but to animate it at the same time.
              </p>
              <p>
                Freezing a frame (by clicking) seems to often yield something
                close to the original. My method is to cycle between 1 and 30
                lines, with spaced out pixels, and then iterate the whole buffer
                to draw fainter and fainter points within a radius from any
                point that's already lit, while also amplifying the ones that
                were lit before and shifting their colors slightly at the same
                time.
              </p>
              <p>
                Anyway, I did this tonight but I've been thinking about it for
                weeks, so, I hope someone enjoys it. Cheers!
              </p>
            </div>
          </section>
        </section>
        <section id="42962702">
          <h3>
            <a
              class="item"
              href="https://www.zetter-zeroday.com/u-s-government-disclosed-39-zero-day-vulnerabilities-in-2023-per-first-ever-report/"
              >U.S. Government Disclosed 39 Zero-Day Vulnerabilities in 2023,
              First-Ever Report</a
            >
          </h3>
          <section>
            <h4>
              <span>2025-02-06 @ 14:35:04</span
              ><span class="points-container"
                >Points: <span class="points">177</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=42962702"
                  >Comments</a
                ><span class="descendants">: 110</span></span
              >
            </h4>
          </section>
        </section>
        <section id="42962508">
          <h3>
            <a
              class="item"
              href="https://lisyarus.github.io/blog/posts/simulating-water-over-terrain.html"
              >Simulating Water over Terrain</a
            >
          </h3>
          <section>
            <h4>
              <span>2025-02-06 @ 14:15:28</span
              ><span class="points-container"
                >Points: <span class="points">216</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=42962508"
                  >Comments</a
                ><span class="descendants">: 25</span></span
              >
            </h4>
          </section>
        </section>
        <section id="42961795">
          <h3>
            <a class="item" href="http://loki3.com/flex/explore/"
              >Explorable Flexagons: Learn to create and flex flexagons
              (2020)</a
            >
          </h3>
          <section>
            <h4>
              <span>2025-02-06 @ 12:39:37</span
              ><span class="points-container"
                >Points: <span class="points">31</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=42961795"
                  >Comments</a
                ><span class="descendants">: 9</span></span
              >
            </h4>
          </section>
        </section>
        <section id="42961606">
          <h3>
            <a
              class="item"
              href="https://www.genuineideas.com/ArticlesIndex/wave.html"
              >Science of Microwave Ovens (2016)</a
            >
          </h3>
          <section>
            <h4>
              <span>2025-02-06 @ 12:09:55</span
              ><span class="points-container"
                >Points: <span class="points">56</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=42961606"
                  >Comments</a
                ><span class="descendants">: 51</span></span
              >
            </h4>
          </section>
        </section>
        <section id="42960989">
          <h3>
            <a class="item" href="https://arxiv.org/abs/2406.03445"
              >Pre-Trained Large Language Models Use Fourier Features for
              Addition (2024)</a
            >
          </h3>
          <section>
            <h4>
              <span>2025-02-06 @ 10:31:06</span
              ><span class="points-container"
                >Points: <span class="points">98</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=42960989"
                  >Comments</a
                ><span class="descendants">: 29</span></span
              >
            </h4>
          </section>
        </section>
        <section id="42960907">
          <h3>
            <a class="item" href="https://spectrum.ieee.org/aluminum-battery"
              >Aluminum Batteries Outlive Lithium-Ion with a Pinch of Salt</a
            >
          </h3>
          <section>
            <h4>
              <span>2025-02-06 @ 10:13:26</span
              ><span class="points-container"
                >Points: <span class="points">129</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=42960907"
                  >Comments</a
                ><span class="descendants">: 75</span></span
              >
            </h4>
          </section>
        </section>
        <section id="42960144">
          <h3>
            <a
              class="item"
              href="https://gladdendesign.com/collections/paper-apps"
              >Paper Apps</a
            >
          </h3>
          <section>
            <h4>
              <span>2025-02-06 @ 07:58:33</span
              ><span class="points-container"
                >Points: <span class="points">488</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=42960144"
                  >Comments</a
                ><span class="descendants">: 80</span></span
              >
            </h4>
          </section>
        </section>
        <section id="42959226">
          <h3>
            <a
              class="item"
              href="https://github.com/heap-exploitation/heap-explorer"
              >Show HN: Heap Explorer</a
            >
          </h3>
          <section>
            <h4>
              <span>2025-02-06 @ 04:54:18</span
              ><span class="points-container"
                >Points: <span class="points">32</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=42959226"
                  >Comments</a
                ><span class="descendants">: 3</span></span
              >
            </h4>
            <div class="text">
              <p>
                It's fun to pause processes, free a bunch of their allocations,
                then resume them. Most of the time, the processes continue as
                though nothing happened, but sometimes they do interesting
                things :)
              </p>
            </div>
          </section>
        </section>
        <section id="42958696">
          <h3>
            <a
              class="item"
              href="https://danielchasehooper.com/posts/code-animated-rick/"
              >Programming SDF Animations of Rick and Morty</a
            >
          </h3>
          <section>
            <h4>
              <span>2025-02-06 @ 03:30:34</span
              ><span class="points-container"
                >Points: <span class="points">396</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=42958696"
                  >Comments</a
                ><span class="descendants">: 35</span></span
              >
            </h4>
          </section>
        </section>
        <section id="42957823">
          <h3>
            <a
              class="item"
              href="https://nemanjatrifunovic.substack.com/p/6502-is-a-good-starting-point-for"
              >I believe 6502 instruction set is a good first assembly
              language</a
            >
          </h3>
          <section>
            <h4>
              <span>2025-02-06 @ 01:28:17</span
              ><span class="points-container"
                >Points: <span class="points">223</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=42957823"
                  >Comments</a
                ><span class="descendants">: 257</span></span
              >
            </h4>
          </section>
        </section>
        <section id="42955356">
          <h3>
            <a
              class="item"
              href="https://scrollprize.substack.com/p/exciting-news-from-scroll-5"
              >News from Scroll 5</a
            >
          </h3>
          <section>
            <h4>
              <span>2025-02-05 @ 21:23:09</span
              ><span class="points-container"
                >Points: <span class="points">57</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=42955356"
                  >Comments</a
                ><span class="descendants">: 3</span></span
              >
            </h4>
          </section>
        </section>
        <section id="42955176">
          <h3>
            <a
              class="item"
              href="https://n0rdy.foo/posts/20250121/okta-bcrypt-lessons-for-better-apis/"
              >Okta Bcrypt incident lessons for designing better APIs</a
            >
          </h3>
          <section>
            <h4>
              <span>2025-02-05 @ 21:10:25</span
              ><span class="points-container"
                >Points: <span class="points">360</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=42955176"
                  >Comments</a
                ><span class="descendants">: 150</span></span
              >
            </h4>
          </section>
        </section>
        <section id="42953508">
          <h3>
            <a class="item" href="https://news.ycombinator.com/item?id=42953508"
              >Tell HN: Cloudflare is blocking Pale Moon and other
              non-mainstream browsers</a
            >
          </h3>
          <section>
            <h4>
              <span>2025-02-05 @ 19:08:12</span
              ><span class="points-container"
                >Points: <span class="points">1255</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=42953508"
                  >Comments</a
                ><span class="descendants">: 449</span></span
              >
            </h4>
            <div class="text">
              <p>
                Cloudflare's Browser Intergrity Check/Verification/Challenge
                feature used by many websites, is denying access to users of
                non-mainstream browsers like Pale Moon.
              </p>
              <p>Users reports began on January 31:</p>
              <p>
                <a
                  href="https://forum.palemoon.org/viewtopic.php?f=3&amp;t=32045"
                  >https://forum.palemoon.org/viewtopic.php?f=3&amp;t=32045</a
                >
              </p>
              <p>
                This situation occurs at least once a year, and there is no easy
                way to contact Cloudflare. Their "Submit feedback" tool yields
                no results. A Cloudflare Community topic was flagged as "spam"
                by members of that community and was promptly locked with no
                real solution, and no official response from Cloudflare:
              </p>
              <p>
                <a
                  href="https://community.cloudflare.com/t/access-denied-to-pale-moon-desktop-browser/764330"
                  >https://community.cloudflare.com/t/access-denied-to-pale-moo...</a
                >
              </p>
              <p>
                Partial list of other browsers that are being denied access:
              </p>
              <p>Falkon, SeaMonkey, IceCat, Basilisk.</p>
              <p>
                Hacker News 2022 post about the same issue, which brought
                attention and had Cloudflare quickly patching the issue:
              </p>
              <p>
                <a href="https://news.ycombinator.com/item?id=31317886"
                  >https://news.ycombinator.com/item?id=31317886</a
                >
              </p>
              <p>
                A Cloudflare product manager declared back then: "...we do not
                want to be in the business of saying one browser is more
                legitimate than another."
              </p>
              <p>
                As of now, there is no official response from Cloudflare.
                Internet access is still denied by their tool.
              </p>
            </div>
          </section>
        </section>
        <section id="42949181">
          <h3>
            <a
              class="item"
              href="https://tedium.co/2025/02/05/warner-bros-youtube-full-movie-releases/"
              >Why is Warner Bros. Discovery putting old movies on YouTube?</a
            >
          </h3>
          <section>
            <h4>
              <span>2025-02-05 @ 14:47:32</span
              ><span class="points-container"
                >Points: <span class="points">616</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=42949181"
                  >Comments</a
                ><span class="descendants">: 459</span></span
              >
            </h4>
          </section>
        </section>
        <section id="42947447">
          <h3>
            <a class="item" href="https://github.com/atgreen/openldk"
              >OpenLDK: A Java JIT compiler and runtime in Common Lisp</a
            >
          </h3>
          <section>
            <h4>
              <span>2025-02-05 @ 12:17:47</span
              ><span class="points-container"
                >Points: <span class="points">98</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=42947447"
                  >Comments</a
                ><span class="descendants">: 29</span></span
              >
            </h4>
          </section>
        </section>
        <section id="42947081">
          <h3>
            <a
              class="item"
              href="https://www.overcomingbias.com/p/my-status-circles"
              >My Status Circles</a
            >
          </h3>
          <section>
            <h4>
              <span>2025-02-05 @ 11:35:13</span
              ><span class="points-container"
                >Points: <span class="points">9</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=42947081"
                  >Comments</a
                ><span class="descendants">: 6</span></span
              >
            </h4>
          </section>
        </section>
        <section id="42946752">
          <h3>
            <a
              class="item"
              href="https://spillhistorie.no/qa-with-game-designer-steve-meretzky/"
              >Steve Meretzky – Working with Douglas Adams on the Hitchhiker's
              Guide</a
            >
          </h3>
          <section>
            <h4>
              <span>2025-02-05 @ 10:53:02</span
              ><span class="points-container"
                >Points: <span class="points">13</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=42946752"
                  >Comments</a
                ><span class="descendants">: 3</span></span
              >
            </h4>
          </section>
        </section>
        <section id="42917135">
          <h3>
            <a class="item" href="https://github.com/chipsalliance/t1"
              >T1: A RISC-V Vector processor implementation</a
            >
          </h3>
          <section>
            <h4>
              <span>2025-02-03 @ 11:22:44</span
              ><span class="points-container"
                >Points: <span class="points">84</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=42917135"
                  >Comments</a
                ><span class="descendants">: 12</span></span
              >
            </h4>
          </section>
        </section>
        <section id="42915944">
          <h3>
            <a
              class="item"
              href="https://blog.voyageai.com/2024/12/04/code-retrieval-eval/"
              >Evaluating Code Embeddings</a
            >
          </h3>
          <section>
            <h4>
              <span>2025-02-03 @ 07:54:34</span
              ><span class="points-container"
                >Points: <span class="points">21</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=42915944"
                  >Comments</a
                ><span class="descendants">: 0</span></span
              >
            </h4>
          </section>
        </section>
        <section id="42910667">
          <h3>
            <a class="item" href="https://github.com/faiface/par-lang"
              >Par: Process language with an interactive playground for
              exploring concurrency</a
            >
          </h3>
          <section>
            <h4>
              <span>2025-02-02 @ 18:41:04</span
              ><span class="points-container"
                >Points: <span class="points">48</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=42910667"
                  >Comments</a
                ><span class="descendants">: 2</span></span
              >
            </h4>
          </section>
        </section>
        <section id="42905900">
          <h3>
            <a
              class="item"
              href="https://winnielim.org/journal/minimum-effective-dose/"
              >Minimum effective dose</a
            >
          </h3>
          <section>
            <h4>
              <span>2025-02-02 @ 04:43:00</span
              ><span class="points-container"
                >Points: <span class="points">330</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=42905900"
                  >Comments</a
                ><span class="descendants">: 176</span></span
              >
            </h4>
          </section>
        </section>
      </section>
      <section id="archives">
        <h2>
          <a
            href="https://github.com/kherrick/hacker-news/blob/main/archives/index.md"
            >Archives</a
          >
        </h2>
        <section>
          <h3>
            <a
              href="https://github.com/kherrick/hacker-news/blob/main/archives/2025/index.md"
              >2025</a
            >
          </h3>
        </section>
        <section>
          <h3>
            <a
              href="https://github.com/kherrick/hacker-news/blob/main/archives/2024/index.md"
              >2024</a
            >
          </h3>
        </section>
        <section>
          <h3>
            <a
              href="https://github.com/kherrick/hacker-news/blob/main/archives/2023/index.md"
              >2023</a
            >
          </h3>
        </section>
        <section>
          <h3>
            <a
              href="https://github.com/kherrick/hacker-news/blob/main/archives/2022/index.md"
              >2022</a
            >
          </h3>
        </section>
      </section>
    </main>
    <script type="module">
      import { buildDescendants } from "./lib/build-html-descendants.js";
      import { buildNextItem } from "./lib/build-html-next-item.js";
      import { getNextDateTime } from "./lib/date-time.js";

      const updateSectionById = (id) =>
        fetch(`https://hacker-news.firebaseio.com/v0/item/${id}.json`).then(
          (result) =>
            result.json().then(({ descendants, id, score, text, type }) => {
              const currentItem = document.getElementById(id);

              if (score) {
                currentItem.querySelector(".points").textContent = score;
              }

              if (descendants && (type === "poll" || type === "story")) {
                const currentDescendants =
                  currentItem.querySelector(".descendants");

                if (currentDescendants) {
                  currentDescendants.textContent = `: ${descendants}`;
                } else {
                  const comments = buildDescendants(
                    document,
                    descendants,
                    `https://news.ycombinator.com/item?id=${id}`
                  );

                  currentItem.querySelector("h4").appendChild(comments);
                }
              }

              if (text) {
                const currentText = currentItem.querySelector(".text");

                if (currentText) {
                  currentText.innerHTML = text.replace(/\0/g, "");
                } else {
                  const content = document.createElement("div");
                  content.innerHTML = text.replace(/\0/g, "");
                  content.setAttribute("class", "text");

                  currentItem.appendChild(content);
                }
              }
            })
        );

      class UpdateQueue {
        constructor() {
          this._ids = [];
          this._isUpdating = false;
        }

        addItemById(id) {
          this._ids.push(id);
        }

        async flush() {
          const id = this._ids.shift();

          if (id) {
            this._isUpdating = true;

            await updateSectionById(id);
            await this.flush();
          } else {
            this._isUpdating = false;

            setTimeout(async () => {
              if (!this._isUpdating && this._ids && this._ids.length) {
                await this.flush();
              }
            }, 0);
          }
        }
      }

      // get latest data
      const latestSection = document.getElementById("latest");

      for (let item of latestSection.querySelectorAll("section[id]")) {
        updateSectionById(item.getAttribute("id"));
      }

      if ("IntersectionObserver" in window) {
        window.hackerNewsState = { index: [], nextTimeIndex: -1 };

        const addNewsItem = async (newsItem, queue) => {
          try {
            const { date, time, itemComments, itemTitle, itemLink } = newsItem;
            const section = await buildNextItem({
              document,
              dateTime: `${date}, ${time}`,
              itemComments,
              itemLink,
              itemTitle: new DOMParser().parseFromString(
                itemTitle.replace(/\\/g, ""),
                "text/html"
              ).documentElement.textContent,
              fetchItemDetails: false,
            });

            // display loading indicator for section
            section.querySelector(".points-container").innerHTML =
              'Points: <span class="points"><img style="height: 100%;" src="lib/images/loading.svg" /></span>';

            const id = section.getAttribute("id");
            if (!document.getElementById(id)) {
              document.getElementById("latest").appendChild(section);

              queue.addItemById(id);
            }
          } catch (error) {}
        };

        const buildArchiveIndex = async (lastDateTime) => {
          const nextDate = lastDateTime.slice(0, 10);
          const nextYear = nextDate.slice(0, 4);

          return (
            await (
              await fetch(
                `https://raw.githubusercontent.com/kherrick/hacker-news/main/archives/${nextYear}/${nextDate}/index.md`
              )
            ).text()
          )
            .split("\n")
            .filter((line) => line.match(new RegExp("^\\* \\[")))
            .map((line) => {
              const segment = line.replace("* ", "").split("](");
              const pubDate = segment[0].slice(1);

              const itemComments = segment[1].split(") - [")[0];
              const itemTitle = segment[1].split(") - [")[1];
              const itemLink = segment[2].slice(0, -1);
              const date = pubDate.slice(0, 10);
              const time = pubDate.slice(-8);

              return {
                date,
                itemComments,
                itemLink,
                itemTitle,
                time,
              };
            });
        };

        const handleIntersectingEntry = async (entry, queue) => {
          if (entry.isIntersecting) {
            const lastDateTime = document
              .getElementById("latest")
              .querySelector(
                "section:last-child > section > h4 > span"
              ).textContent;

            const nextDateTime = getNextDateTime(lastDateTime ?? "", -1);
            const archiveIndex = await buildArchiveIndex(nextDateTime);
            const nextTimeIndex = archiveIndex.findIndex(
              ({ time }) => time === nextDateTime.slice(-8)
            );

            const handleIndexUpdate = (index, existingIndexValues = []) => {
              index.forEach((i) => {
                existingIndexValues.push(i);
              });
              return existingIndexValues;
            };

            window.hackerNewsState = {
              index: handleIndexUpdate(
                archiveIndex,
                window.hackerNewsState.index
              ),
              nextTimeIndex,
            };

            let currentTimeIndex = nextTimeIndex + 1;
            const items = Object.values(window.hackerNewsState.index);
            for (let item of items) {
              if (currentTimeIndex < window.hackerNewsState.index.length) {
                addNewsItem(items[currentTimeIndex], queue);

                currentTimeIndex = currentTimeIndex + 1;
              }
            }

            queue.flush();
          }
        };

        const archives = document.getElementById("archives");
        const archivesObserver = new IntersectionObserver(
          (entries) => {
            const queue = new UpdateQueue();

            entries.forEach((entry) => handleIntersectingEntry(entry, queue));
          },
          {
            root: null,
            rootMargin: "0px",
            threshold: 0,
          }
        );

        archivesObserver.observe(archives);

        let latestSectionsExpanded = true;
        const handleLatestHeaderClick = () => {
          latestSectionsExpanded = !latestSectionsExpanded;

          if (latestSectionsExpanded) {
            archivesObserver.observe(archives);
          } else {
            archivesObserver.disconnect(archives);
          }

          for (let section of document.querySelectorAll("#latest > section")) {
            section.style.display = latestSectionsExpanded ? "block" : "none";
          }
        };

        const latestHeader = document.querySelector("#latest > h2");
        latestHeader.style.cursor = "pointer";
        latestHeader.addEventListener("click", handleLatestHeaderClick);
      }
    </script>
    <script type="module">
      import { Workbox } from "https://storage.googleapis.com/workbox-cdn/releases/6.4.1/workbox-window.prod.mjs";

      if ("serviceWorker" in navigator) {
        const base = document.querySelector("base");
        const serviceWorkerPath = `${
          base ? base.href.replace(/\/$/, "") : ""
        }/service-worker.js`;

        const wb = new Workbox(serviceWorkerPath);

        // setup event listeners
        wb.addEventListener("waiting", (event) => {
          wb.addEventListener("controlling", () => {
            window.location.reload();
          });

          wb.messageSkipWaiting();
        });

        wb.register();
      }
    </script>
  </body>
</html>
