<!DOCTYPE html>
<html lang="en" xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta charset="utf-8" />
    <meta
      content="width=device-width, initial-scale=1.0, viewport-fit=cover"
      name="viewport"
    />
    <meta name="description" content="Hacker News" />
    <meta name="theme-color" content="#fff" />
    <title>Hacker News</title>
    <link rel="manifest" href="manifest.json" />
    <link
      href="data:image/x-icon;base64,AAABAAEAAQECAAEAAQA4AAAAFgAAACgAAAABAAAAAgAAAAEAAQAAAAAAAAAAAAAAAAAAAAAAAAAAAAABAAEAAQECAAEAAQA4AAAAFgAAACgAAAABAAAAAgAAAAEAAQAAAAAAAAAAAAAAAAAAAAAAAAAA"
      rel="icon"
      type="image/x-icon"
    />
    <link
      href="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAgAAAAIAAQMAAADOtka5AAAAA1BMVEUAAACnej3aAAAANklEQVR42u3BAQEAAACCIP+vbkhAAQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAB8G4IAAAFjdVCkAAAAAElFTkSuQmCC"
      rel="apple-touch-icon"
    />
    <style>
      /*<!--*/
      body {
        color: rgb(25, 25, 25);
        font-family: Verdana, Geneva, sans-serif;
        margin: 0;
      }

      a {
        text-decoration: none;
      }

      a:link,
      a:focus,
      a:hover,
      a:active {
        color: rgb(75, 75, 125);
      }

      a:visited {
        color: rgb(25, 25, 25);
      }

      h1 > a,
      h1 > a:link,
      h1 > a:focus,
      h1 > a:hover,
      h1 > a:active,
      h1 > a:visited,
      h2 > a,
      h2 > a:link,
      h2 > a:focus,
      h2 > a:hover,
      h2 > a:active,
      h2 > a:visited {
        color: rgb(25, 25, 25);
      }

      h1 {
        background-color: rgb(255, 102, 0);
        margin: 0;
        padding: 1rem;
      }

      h2 {
        background-color: rgb(200, 200, 200);
        margin: 1rem 0;
        padding: 0.5rem 0.5rem 0.5rem 1rem;
      }

      #latest > section,
      #archives > section {
        margin: 0 1rem 1rem 1rem;
        padding-bottom: 1rem;
      }

      #latest > section:not(:last-child),
      #archives > section:not(:last-child) {
        border-bottom: 1px dotted rgb(200, 200, 200);
      }

      section > h3 {
        margin: 0 0 0.5rem 0;
      }

      section > h4 {
        font-weight: normal;
        margin: 0 0 0 1rem;
      }

      .descendants-container,
      .points-container {
        align-items: center;
        border-left: 1px solid #333;
        display: inline-flex;
        margin-left: 0.5rem;
        padding-left: 0.5rem;
        text-align: center;
      }

      .points {
        align-items: center;
        display: inline-flex;
        height: 1rem;
        margin-left: 1ch;
        min-width: 3ch;
      }

      .text {
        line-height: 1.5rem;
        margin: 1rem 1rem 0 1rem;
        overflow: auto;
      }

      .text > p:first-child {
        margin-top: 1rem;
      }

      .text > p:last-child {
        margin-bottom: 0;
      }
      /*-->*/
    </style>
  </head>

  <body>
    <main>
      <h1><a href="https://kherrick.github.io/hacker-news/">Hacker News</a></h1>
      <section id="latest">
        <h2>Latest</h2>
        <section id="36678914">
          <h3>
            <a
              class="item"
              href="https://en.wikipedia.org/wiki/Tragedy_of_the_anticommons"
              >Tragedy of the Anticommons</a
            >
          </h3>
          <section>
            <h4>
              <span>2023-07-11 @ 10:23:10</span
              ><span class="points-container"
                >Points: <span class="points">5</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=36678914"
                  >Comments</a
                ><span class="descendants">: 0</span></span
              >
            </h4>
          </section>
        </section>
        <section id="36678818">
          <h3>
            <a
              class="item"
              href="https://arstechnica.com/space/2023/07/spacex-launches-its-fleet-leading-rocket-booster-for-record-16th-time/"
              >SpaceX is stretching the lifetime of its reusable Falcon 9
              boosters</a
            >
          </h3>
          <section>
            <h4>
              <span>2023-07-11 @ 10:12:41</span
              ><span class="points-container"
                >Points: <span class="points">23</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=36678818"
                  >Comments</a
                ><span class="descendants">: 1</span></span
              >
            </h4>
          </section>
        </section>
        <section id="36678475">
          <h3>
            <a
              class="item"
              href="https://sourcery.ai/blog/measuring_working_memory/"
              >Working memory: metric for state a programmer needs to keep in
              their head</a
            >
          </h3>
          <section>
            <h4>
              <span>2023-07-11 @ 09:35:59</span
              ><span class="points-container"
                >Points: <span class="points">22</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=36678475"
                  >Comments</a
                ><span class="descendants">: 4</span></span
              >
            </h4>
          </section>
        </section>
        <section id="36678457">
          <h3>
            <a
              class="item"
              href="https://nnethercote.github.io/2023/07/11/back-end-parallelism-in-the-rust-compiler.html"
              >Back-end parallelism in the Rust compiler</a
            >
          </h3>
          <section>
            <h4>
              <span>2023-07-11 @ 09:33:12</span
              ><span class="points-container"
                >Points: <span class="points">6</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=36678457"
                  >Comments</a
                ><span class="descendants">: 1</span></span
              >
            </h4>
          </section>
        </section>
        <section id="36678412">
          <h3>
            <a
              class="item"
              href="https://nhigham.com/2023/07/11/what-is-the-numerical-range-of-a-matrix/"
              >What Is the Numerical Range of a Matrix?</a
            >
          </h3>
          <section>
            <h4>
              <span>2023-07-11 @ 09:27:25</span
              ><span class="points-container"
                >Points: <span class="points">6</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=36678412"
                  >Comments</a
                ><span class="descendants">: 1</span></span
              >
            </h4>
          </section>
        </section>
        <section id="36678375">
          <h3>
            <a
              class="item"
              href="https://www.economist.com/by-invitation/2023/07/10/mathew-lawrence-on-why-privatisation-has-been-a-costly-failure-in-britain"
              >Why privatisation has been a costly failure in Britain</a
            >
          </h3>
          <section>
            <h4>
              <span>2023-07-11 @ 09:20:43</span
              ><span class="points-container"
                >Points: <span class="points">204</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=36678375"
                  >Comments</a
                ><span class="descendants">: 257</span></span
              >
            </h4>
          </section>
        </section>
        <section id="36678348">
          <h3>
            <a class="item" href="https://news.ycombinator.com/item?id=36678348"
              >Mailgun: Public Security Disclosure</a
            >
          </h3>
          <section>
            <h4>
              <span>2023-07-11 @ 09:16:38</span
              ><span class="points-container"
                >Points: <span class="points">39</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=36678348"
                  >Comments</a
                ><span class="descendants">: 8</span></span
              >
            </h4>
            <div class="text">
              <p>
                "complex incoming messages are simplified and parsed into all of
                the data you need with Inbound Routes." [1]
              </p>
              <p>Mailgun refers to DKIM/SPF/DMARC with:</p>
              <p>
                "Mailgun leads the charge in email authentication by requiring
                DKIM and SPF records by default before you can begin sending."
                [2]
              </p>
              <p>
                However, nowhere does it say that Mailgun does not provide SPF
                or DKIM validation checks on inbound emails. Confusingly, these
                headers appear only for a subset of inbound emails.
              </p>
              <p>Attack scenario:</p>
              <p>
                1) Pick any domain using mailgun for inbound email processing
                (trivially found via MX records).
              </p>
              <p>
                2) Spoof an email from any address you want to impersonate (eg.
                security@mailgun.com).
              </p>
              <p>
                If that address is handled via an inbound route to a webhook
                (eg. CRM system / other), then it will appear as from the
                spoofed sender without any DKIM/SPF flags. This makes phishing
                via Inbound Routes trivial.
              </p>
              <p>Requested fix:</p>
              <p>
                Include SPF (X-Mailgun-Spf), DKIM (X-Mailgun-Dkim-Check-Result),
                and Spam Assassin headers (eg. DMARC_QUAR / DMARC_REJECT /
                DMARC_NONE / DMARC_MISSING) headers for ALL inbound routes to a
                webhook. The application can then decide what to do.
              </p>
              <p>Mailgun Response:</p>
              <p>
                "Our security team has confirmed that our routes act as an open
                relay and that this is not considered a security vulnerability
                with Mailgun."
              </p>
              <p>
                Nowhere in the Mailgun documentation / sales pages are inbound
                routes described like this, and in fact, they pretend to have
                protection as headers are sometimes present!
              </p>
              <p>
                Note A: Using throwaway to not give information away for our own
                exposed systems.
              </p>
              <p>
                Note B: The spoofed email must not trigger above a certain spam
                assassin threshold (this is fairly trivial to do and openly
                testable by any attacker), otherwise it might get blocked by
                higher level Mailgun spam handling.
              </p>
              <p>
                [1] - https://www.mailgun.com/products/send/inbound-routing/
              </p>
              <p>
                [2] -
                https://www.mailgun.com/blog/deliverability/implement-dmarc/#chapter-5
              </p>
            </div>
          </section>
        </section>
        <section id="36678079">
          <h3>
            <a
              class="item"
              href="https://www.suse.com/news/SUSE-Preserves-Choice-in-Enterprise-Linux/"
              >SUSE is forking RHEL</a
            >
          </h3>
          <section>
            <h4>
              <span>2023-07-11 @ 08:41:22</span
              ><span class="points-container"
                >Points: <span class="points">223</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=36678079"
                  >Comments</a
                ><span class="descendants">: 110</span></span
              >
            </h4>
          </section>
        </section>
        <section id="36677578">
          <h3>
            <a
              class="item"
              href="https://noyb.eu/en/european-commission-gives-eu-us-data-transfers-third-round-cjeu"
              >New Trans-Atlantic Data Privacy Framework Largely a Copy of
              “Privacy Shield”</a
            >
          </h3>
          <section>
            <h4>
              <span>2023-07-11 @ 07:28:55</span
              ><span class="points-container"
                >Points: <span class="points">48</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=36677578"
                  >Comments</a
                ><span class="descendants">: 16</span></span
              >
            </h4>
          </section>
        </section>
        <section id="36677034">
          <h3>
            <a
              class="item"
              href="https://github.com/mshumer/gpt-prompt-engineer"
              >GPT-Prompt-Engineer</a
            >
          </h3>
          <section>
            <h4>
              <span>2023-07-11 @ 06:16:14</span
              ><span class="points-container"
                >Points: <span class="points">135</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=36677034"
                  >Comments</a
                ><span class="descendants">: 52</span></span
              >
            </h4>
          </section>
        </section>
        <section id="36676415">
          <h3>
            <a class="item" href="https://playlaser.xyz"
              >Show HN: Laser, a new game played on a chess board</a
            >
          </h3>
          <section>
            <h4>
              <span>2023-07-11 @ 04:27:41</span
              ><span class="points-container"
                >Points: <span class="points">115</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=36676415"
                  >Comments</a
                ><span class="descendants">: 31</span></span
              >
            </h4>
            <div class="text">
              <i>laser</i> piece, which can shoot diagonally through every piece
              on the board except for the <i>wall</i>, which blocks it. The
              detailed rules are on the website.
              <p>
                I made the website as a super minimal way to play online against
                friends. Nobody really knows about it so it might be hard to
                find a game, but maybe you will against someone on HN if people
                read this. It uses the lichess.org chessboard UI which is super
                pretty and allows you to draw on the board, make premoves, etc.
                The code is public if you are interested:
                github.com/melgrove/laser
              </p>
              <p>If you are playing, good luck, and don't get lasered!</p>
            </div>
          </section>
        </section>
        <section id="36676151">
          <h3>
            <a class="item" href="https://www.youtube.com/watch?v=bEXefdbQDjw"
              >Growing Rat Neurons to Play Video Games [video]</a
            >
          </h3>
          <section>
            <h4>
              <span>2023-07-11 @ 03:37:41</span
              ><span class="points-container"
                >Points: <span class="points">37</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=36676151"
                  >Comments</a
                ><span class="descendants">: 9</span></span
              >
            </h4>
          </section>
        </section>
        <section id="36676103">
          <h3>
            <a
              class="item"
              href="https://linuxiac.com/linux-hits-3-percent-market-share/"
              >Linux has achieved a 3% desktop market share</a
            >
          </h3>
          <section>
            <h4>
              <span>2023-07-11 @ 03:29:39</span
              ><span class="points-container"
                >Points: <span class="points">426</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=36676103"
                  >Comments</a
                ><span class="descendants">: 354</span></span
              >
            </h4>
          </section>
        </section>
        <section id="36675934">
          <h3>
            <a
              class="item"
              href="https://threadreaderapp.com/thread/1678545170508267522.html"
              >GPT-4 details leaked?</a
            >
          </h3>
          <section>
            <h4>
              <span>2023-07-11 @ 03:00:19</span
              ><span class="points-container"
                >Points: <span class="points">361</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=36675934"
                  >Comments</a
                ><span class="descendants">: 291</span></span
              >
            </h4>
          </section>
        </section>
        <section id="36675750">
          <h3>
            <a
              class="item"
              href="https://download.vusec.net/papers/floatzone_sec23.pdf"
              >FloatZone: Accelerating Memory Error Detection Using the Floating
              Point Unit [pdf]</a
            >
          </h3>
          <section>
            <h4>
              <span>2023-07-11 @ 02:28:47</span
              ><span class="points-container"
                >Points: <span class="points">43</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=36675750"
                  >Comments</a
                ><span class="descendants">: 7</span></span
              >
            </h4>
          </section>
        </section>
        <section id="36674920">
          <h3>
            <a class="item" href="https://gpslogdrive.com/"
              >GPS Log: Tracking wood movement down the McKenzie River</a
            >
          </h3>
          <section>
            <h4>
              <span>2023-07-11 @ 00:18:44</span
              ><span class="points-container"
                >Points: <span class="points">46</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=36674920"
                  >Comments</a
                ><span class="descendants">: 13</span></span
              >
            </h4>
          </section>
        </section>
        <section id="36674606">
          <h3>
            <a
              class="item"
              href="https://hacks.mozilla.org/2023/03/letting-users-block-injected-third-party-dlls-in-firefox/"
              >Letting users block injected third-party DLLs in Firefox</a
            >
          </h3>
          <section>
            <h4>
              <span>2023-07-10 @ 23:42:48</span
              ><span class="points-container"
                >Points: <span class="points">69</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=36674606"
                  >Comments</a
                ><span class="descendants">: 23</span></span
              >
            </h4>
          </section>
        </section>
        <section id="36674487">
          <h3>
            <a
              class="item"
              href="https://blurbusters.com/frame-generation-essentials-interpolation-extrapolation-and-reprojection/"
              >Frame generation essentials: Interpolation, extrapolation, and
              reprojection</a
            >
          </h3>
          <section>
            <h4>
              <span>2023-07-10 @ 23:30:27</span
              ><span class="points-container"
                >Points: <span class="points">83</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=36674487"
                  >Comments</a
                ><span class="descendants">: 9</span></span
              >
            </h4>
          </section>
        </section>
        <section id="36674224">
          <h3>
            <a class="item" href="https://www.getlocalcert.net/"
              >Easy HTTPS for your private networks</a
            >
          </h3>
          <section>
            <h4>
              <span>2023-07-10 @ 23:05:21</span
              ><span class="points-container"
                >Points: <span class="points">188</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=36674224"
                  >Comments</a
                ><span class="descendants">: 77</span></span
              >
            </h4>
          </section>
        </section>
        <section id="36674069">
          <h3>
            <a
              class="item"
              href="https://www.udiscovermusic.com/news/brian-eno-albums-dolby-atmos-first-time/"
              >Brian Eno albums available in Dolby Atmos and Spatial</a
            >
          </h3>
          <section>
            <h4>
              <span>2023-07-10 @ 22:49:32</span
              ><span class="points-container"
                >Points: <span class="points">108</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=36674069"
                  >Comments</a
                ><span class="descendants">: 123</span></span
              >
            </h4>
          </section>
        </section>
        <section id="36673793">
          <h3>
            <a
              class="item"
              href="https://letsencrypt.org/2023/07/10/cross-sign-expiration.html"
              >Shortening the Let's Encrypt chain of trust</a
            >
          </h3>
          <section>
            <h4>
              <span>2023-07-10 @ 22:19:22</span
              ><span class="points-container"
                >Points: <span class="points">420</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=36673793"
                  >Comments</a
                ><span class="descendants">: 196</span></span
              >
            </h4>
          </section>
        </section>
        <section id="36673224">
          <h3>
            <a class="item" href="https://github.com/immich-app/immich"
              >Self-hosted photo and video backups directly from your mobile
              phone</a
            >
          </h3>
          <section>
            <h4>
              <span>2023-07-10 @ 21:28:40</span
              ><span class="points-container"
                >Points: <span class="points">617</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=36673224"
                  >Comments</a
                ><span class="descendants">: 295</span></span
              >
            </h4>
          </section>
        </section>
        <section id="36672957">
          <h3>
            <a class="item" href="https://github.com/mkirchner/hamt"
              >Show HN: A hash array-mapped trie implementation in C</a
            >
          </h3>
          <section>
            <h4>
              <span>2023-07-10 @ 21:06:55</span
              ><span class="points-container"
                >Points: <span class="points">145</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=36672957"
                  >Comments</a
                ><span class="descendants">: 40</span></span
              >
            </h4>
            <div class="text">
              <p>
                Kind of aiming to be "the libavl for HAMTs". That is obviously a
                high and aspirational bar but a distinct possibility if it stirs
                up a little interest and/or contribution.
              </p>
              <p>
                Anyways, it's time for this to go out, collect feedback and
                maybe even some use outside of toy projects. Let me know how it
                goes.
              </p>
            </div>
          </section>
        </section>
        <section id="36668964">
          <h3>
            <a
              class="item"
              href="https://jvns.ca/blog/2023/07/10/lima--a-nice-way-to-run-linux-vms-on-mac/"
              >Lima: A nice way to run Linux VMs on Mac</a
            >
          </h3>
          <section>
            <h4>
              <span>2023-07-10 @ 16:44:09</span
              ><span class="points-container"
                >Points: <span class="points">454</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=36668964"
                  >Comments</a
                ><span class="descendants">: 138</span></span
              >
            </h4>
          </section>
        </section>
        <section id="36667103">
          <h3>
            <a
              class="item"
              href="http://hyperphysics.phy-astr.gsu.edu/hbase/index.html"
              >HyperPhysics (1998)</a
            >
          </h3>
          <section>
            <h4>
              <span>2023-07-10 @ 14:36:57</span
              ><span class="points-container"
                >Points: <span class="points">47</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=36667103"
                  >Comments</a
                ><span class="descendants">: 10</span></span
              >
            </h4>
          </section>
        </section>
        <section id="36666380">
          <h3>
            <a
              class="item"
              href="https://www.beterinbeleggen.nl/pdf/tsm/The-Perfect-Business-Richard-Russell.pdf"
              >The Perfect Business [pdf]</a
            >
          </h3>
          <section>
            <h4>
              <span>2023-07-10 @ 13:47:59</span
              ><span class="points-container"
                >Points: <span class="points">69</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=36666380"
                  >Comments</a
                ><span class="descendants">: 17</span></span
              >
            </h4>
          </section>
        </section>
        <section id="36665978">
          <h3>
            <a
              class="item"
              href="https://www.washingtonpost.com/technology/2023/07/10/rage-room-printers-recycle-environment-health/"
              >People are paying to break printers with sledgehammers in smash
              rooms</a
            >
          </h3>
          <section>
            <h4>
              <span>2023-07-10 @ 13:20:04</span
              ><span class="points-container"
                >Points: <span class="points">18</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=36665978"
                  >Comments</a
                ><span class="descendants">: 13</span></span
              >
            </h4>
          </section>
        </section>
        <section id="36664509">
          <h3>
            <a
              class="item"
              href="https://tomverbeure.github.io/2023/07/09/TM4313-GPSDO-Teardown.html"
              >Teardown of the TM4313 GPS Disciplined Oscillator</a
            >
          </h3>
          <section>
            <h4>
              <span>2023-07-10 @ 10:50:38</span
              ><span class="points-container"
                >Points: <span class="points">60</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=36664509"
                  >Comments</a
                ><span class="descendants">: 21</span></span
              >
            </h4>
          </section>
        </section>
        <section id="36664372">
          <h3>
            <a
              class="item"
              href="https://en.wikipedia.org/wiki/Hybrid_Insect_Micro-Electro-Mechanical_Systems"
              >Hybrid Insect Micro-Electro-Mechanical Systems (Hi-MEMS)</a
            >
          </h3>
          <section>
            <h4>
              <span>2023-07-10 @ 10:34:10</span
              ><span class="points-container"
                >Points: <span class="points">12</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=36664372"
                  >Comments</a
                ><span class="descendants">: 1</span></span
              >
            </h4>
          </section>
        </section>
        <section id="36662893">
          <h3>
            <a
              class="item"
              href="https://www.linode.com/blog/linode/docs-as-code-at-linode/"
              >Docs as Code at Linode (2020)</a
            >
          </h3>
          <section>
            <h4>
              <span>2023-07-10 @ 06:47:09</span
              ><span class="points-container"
                >Points: <span class="points">16</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=36662893"
                  >Comments</a
                ><span class="descendants">: 2</span></span
              >
            </h4>
          </section>
        </section>
      </section>
      <section id="archives">
        <h2>
          <a
            href="https://github.com/kherrick/hacker-news/blob/main/archives/index.md"
            >Archives</a
          >
        </h2>
        <section>
          <h3>
            <a
              href="https://github.com/kherrick/hacker-news/blob/main/archives/2023/index.md"
              >2023</a
            >
          </h3>
        </section>
        <section>
          <h3>
            <a
              href="https://github.com/kherrick/hacker-news/blob/main/archives/2022/index.md"
              >2022</a
            >
          </h3>
        </section>
      </section>
    </main>
    <script type="module">
      import { buildDescendants } from "./lib/build-html-descendants.js";
      import { buildNextItem } from "./lib/build-html-next-item.js";
      import { getNextDateTime } from "./lib/date-time.js";

      const updateSectionById = (id) =>
        fetch(`https://hacker-news.firebaseio.com/v0/item/${id}.json`).then(
          (result) =>
            result.json().then(({ descendants, id, score, text, type }) => {
              const currentItem = document.getElementById(id);

              if (score) {
                currentItem.querySelector(".points").textContent = score;
              }

              if (descendants && (type === "poll" || type === "story")) {
                const currentDescendants =
                  currentItem.querySelector(".descendants");

                if (currentDescendants) {
                  currentDescendants.textContent = `: ${descendants}`;
                } else {
                  const comments = buildDescendants(
                    document,
                    descendants,
                    `https://news.ycombinator.com/item?id=${id}`
                  );

                  currentItem.querySelector("h4").appendChild(comments);
                }
              }

              if (text) {
                const currentText = currentItem.querySelector(".text");

                if (currentText) {
                  currentText.innerHTML = text.replace(/\0/g, "");
                } else {
                  const content = document.createElement("div");
                  content.innerHTML = text.replace(/\0/g, "");
                  content.setAttribute("class", "text");

                  currentItem.appendChild(content);
                }
              }
            })
        );

      class UpdateQueue {
        constructor() {
          this._ids = [];
          this._isUpdating = false;
        }

        addItemById(id) {
          this._ids.push(id);
        }

        async flush() {
          const id = this._ids.shift();

          if (id) {
            this._isUpdating = true;

            await updateSectionById(id);
            await this.flush();
          } else {
            this._isUpdating = false;

            setTimeout(async () => {
              if (!this._isUpdating && this._ids && this._ids.length) {
                await this.flush();
              }
            }, 0);
          }
        }
      }

      // get latest data
      const latestSection = document.getElementById("latest");

      for (let item of latestSection.querySelectorAll("section[id]")) {
        updateSectionById(item.getAttribute("id"));
      }

      if ("IntersectionObserver" in window) {
        window.hackerNewsState = { index: [], nextTimeIndex: -1 };

        const addNewsItem = async (newsItem, queue) => {
          try {
            const { date, time, itemComments, itemTitle, itemLink } = newsItem;
            const section = await buildNextItem({
              document,
              dateTime: `${date}, ${time}`,
              itemComments,
              itemLink,
              itemTitle: new DOMParser().parseFromString(
                itemTitle.replace(/\\/g, ""),
                "text/html"
              ).documentElement.textContent,
              fetchItemDetails: false,
            });

            // display loading indicator for section
            section.querySelector(".points-container").innerHTML =
              'Points: <span class="points"><img style="height: 100%;" src="lib/images/loading.svg" /></span>';

            const id = section.getAttribute("id");
            if (!document.getElementById(id)) {
              document.getElementById("latest").appendChild(section);

              queue.addItemById(id);
            }
          } catch (error) {}
        };

        const buildArchiveIndex = async (lastDateTime) => {
          const nextDate = lastDateTime.slice(0, 10);
          const nextYear = nextDate.slice(0, 4);

          return (
            await (
              await fetch(
                `https://raw.githubusercontent.com/kherrick/hacker-news/main/archives/${nextYear}/${nextDate}/index.md`
              )
            ).text()
          )
            .split("\n")
            .filter((line) => line.match(new RegExp("^\\* \\[")))
            .map((line) => {
              const segment = line.replace("* ", "").split("](");
              const pubDate = segment[0].slice(1);

              const itemComments = segment[1].split(") - [")[0];
              const itemTitle = segment[1].split(") - [")[1];
              const itemLink = segment[2].slice(0, -1);
              const date = pubDate.slice(0, 10);
              const time = pubDate.slice(-8);

              return {
                date,
                itemComments,
                itemLink,
                itemTitle,
                time,
              };
            });
        };

        const handleIntersectingEntry = async (entry, queue) => {
          if (entry.isIntersecting) {
            const lastDateTime = document
              .getElementById("latest")
              .querySelector(
                "section:last-child > section > h4 > span"
              ).textContent;

            const nextDateTime = getNextDateTime(lastDateTime ?? "", -1);
            const archiveIndex = await buildArchiveIndex(nextDateTime);
            const nextTimeIndex = archiveIndex.findIndex(
              ({ time }) => time === nextDateTime.slice(-8)
            );

            const handleIndexUpdate = (index, existingIndexValues = []) => {
              index.forEach((i) => {
                existingIndexValues.push(i);
              });
              return existingIndexValues;
            };

            window.hackerNewsState = {
              index: handleIndexUpdate(
                archiveIndex,
                window.hackerNewsState.index
              ),
              nextTimeIndex,
            };

            let currentTimeIndex = nextTimeIndex + 1;
            const items = Object.values(window.hackerNewsState.index);
            for (let item of items) {
              if (currentTimeIndex < window.hackerNewsState.index.length) {
                addNewsItem(items[currentTimeIndex], queue);

                currentTimeIndex = currentTimeIndex + 1;
              }
            }

            queue.flush();
          }
        };

        const archives = document.getElementById("archives");
        const archivesObserver = new IntersectionObserver(
          (entries) => {
            const queue = new UpdateQueue();

            entries.forEach((entry) => handleIntersectingEntry(entry, queue));
          },
          {
            root: null,
            rootMargin: "0px",
            threshold: 0,
          }
        );

        archivesObserver.observe(archives);

        let latestSectionsExpanded = true;
        const handleLatestHeaderClick = () => {
          latestSectionsExpanded = !latestSectionsExpanded;

          if (latestSectionsExpanded) {
            archivesObserver.observe(archives);
          } else {
            archivesObserver.disconnect(archives);
          }

          for (let section of document.querySelectorAll("#latest > section")) {
            section.style.display = latestSectionsExpanded ? "block" : "none";
          }
        };

        const latestHeader = document.querySelector("#latest > h2");
        latestHeader.style.cursor = "pointer";
        latestHeader.addEventListener("click", handleLatestHeaderClick);
      }
    </script>
    <script type="module">
      import { Workbox } from "https://storage.googleapis.com/workbox-cdn/releases/6.4.1/workbox-window.prod.mjs";

      if ("serviceWorker" in navigator) {
        const base = document.querySelector("base");
        const serviceWorkerPath = `${
          base ? base.href.replace(/\/$/, "") : ""
        }/service-worker.js`;

        const wb = new Workbox(serviceWorkerPath);

        // setup event listeners
        wb.addEventListener("waiting", (event) => {
          wb.addEventListener("controlling", () => {
            window.location.reload();
          });

          wb.messageSkipWaiting();
        });

        wb.register();
      }
    </script>
  </body>
</html>
