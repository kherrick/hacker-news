<!DOCTYPE html>
<html lang="en" xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta charset="utf-8" />
    <meta
      content="width=device-width, initial-scale=1.0, viewport-fit=cover"
      name="viewport"
    />
    <meta name="description" content="Hacker News" />
    <meta name="theme-color" content="#fff" />
    <title>Hacker News</title>
    <link rel="manifest" href="manifest.json" />
    <link
      href="data:image/x-icon;base64,AAABAAEAAQECAAEAAQA4AAAAFgAAACgAAAABAAAAAgAAAAEAAQAAAAAAAAAAAAAAAAAAAAAAAAAAAAABAAEAAQECAAEAAQA4AAAAFgAAACgAAAABAAAAAgAAAAEAAQAAAAAAAAAAAAAAAAAAAAAAAAAA"
      rel="icon"
      type="image/x-icon"
    />
    <link
      href="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAgAAAAIAAQMAAADOtka5AAAAA1BMVEUAAACnej3aAAAANklEQVR42u3BAQEAAACCIP+vbkhAAQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAB8G4IAAAFjdVCkAAAAAElFTkSuQmCC"
      rel="apple-touch-icon"
    />
    <style>
      /*<!--*/
      body {
        color: rgb(25, 25, 25);
        font-family: Verdana, Geneva, sans-serif;
        margin: 0;
      }

      a {
        text-decoration: none;
      }

      a:link,
      a:focus,
      a:hover,
      a:active {
        color: rgb(75, 75, 125);
      }

      a:visited {
        color: rgb(25, 25, 25);
      }

      h1 > a,
      h1 > a:link,
      h1 > a:focus,
      h1 > a:hover,
      h1 > a:active,
      h1 > a:visited,
      h2 > a,
      h2 > a:link,
      h2 > a:focus,
      h2 > a:hover,
      h2 > a:active,
      h2 > a:visited {
        color: rgb(25, 25, 25);
      }

      h1 {
        background-color: rgb(255, 102, 0);
        margin: 0;
        padding: 1rem;
      }

      h2 {
        background-color: rgb(200, 200, 200);
        margin: 1rem 0;
        padding: 0.5rem 0.5rem 0.5rem 1rem;
      }

      #latest > section,
      #archives > section {
        margin: 0 1rem 1rem 1rem;
        padding-bottom: 1rem;
      }

      #latest > section:not(:last-child),
      #archives > section:not(:last-child) {
        border-bottom: 1px dotted rgb(200, 200, 200);
      }

      section > h3 {
        margin: 0 0 0.5rem 0;
      }

      section > h4 {
        font-weight: normal;
        margin: 0 0 0 1rem;
      }

      .descendants-container,
      .points-container {
        align-items: center;
        border-left: 1px solid #333;
        display: inline-flex;
        margin-left: 0.5rem;
        padding-left: 0.5rem;
        text-align: center;
      }

      .points {
        align-items: center;
        display: inline-flex;
        height: 1rem;
        margin-left: 1ch;
        min-width: 3ch;
      }

      .text {
        line-height: 1.5rem;
        margin: 1rem 1rem 0 1rem;
        overflow: auto;
      }

      .text > p:first-child {
        margin-top: 1rem;
      }

      .text > p:last-child {
        margin-bottom: 0;
      }
      /*-->*/
    </style>
  </head>

  <body>
    <main>
      <h1><a href="https://kherrick.github.io/hacker-news/">Hacker News</a></h1>
      <section id="latest">
        <h2>Latest</h2>
        <section id="36902772">
          <h3>
            <a
              class="item"
              href="https://www.thegwpf.org/content/uploads/2023/07/Montford-Heat-Pumps.pdf"
              >Heat Pumps: Mythology and Actuality</a
            >
          </h3>
          <section>
            <h4>
              <span>2023-07-28 @ 03:14:15</span
              ><span class="points-container"
                >Points: <span class="points">7</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=36902772"
                  >Comments</a
                ><span class="descendants">: 14</span></span
              >
            </h4>
          </section>
        </section>
        <section id="36902183">
          <h3>
            <a
              class="item"
              href="https://medicalxpress.com/news/2023-07-swine-flu-strain-humans.html"
              >'Swine flu' strain has passed from humans to swine ~400 times
              since 2009: study</a
            >
          </h3>
          <section>
            <h4>
              <span>2023-07-28 @ 01:28:50</span
              ><span class="points-container"
                >Points: <span class="points">13</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=36902183"
                  >Comments</a
                ><span class="descendants">: 13</span></span
              >
            </h4>
          </section>
        </section>
        <section id="36901885">
          <h3>
            <a
              class="item"
              href="https://web.cs.ucdavis.edu/~rogaway/papers/moral.html"
              >The moral character of cryptographic work (2015)</a
            >
          </h3>
          <section>
            <h4>
              <span>2023-07-28 @ 00:29:48</span
              ><span class="points-container"
                >Points: <span class="points">21</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=36901885"
                  >Comments</a
                ><span class="descendants">: 8</span></span
              >
            </h4>
          </section>
        </section>
        <section id="36901543">
          <h3>
            <a class="item" href="https://gvisor.dev/blog/2023/06/27/directfs/"
              >Faster filesystem access with Directfs</a
            >
          </h3>
          <section>
            <h4>
              <span>2023-07-27 @ 23:41:03</span
              ><span class="points-container"
                >Points: <span class="points">90</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=36901543"
                  >Comments</a
                ><span class="descendants">: 12</span></span
              >
            </h4>
          </section>
        </section>
        <section id="36901406">
          <h3>
            <a class="item" href="https://graphite.rs/"
              >Graphite: Open-source raster and vector 2D graphics editor</a
            >
          </h3>
          <section>
            <h4>
              <span>2023-07-27 @ 23:23:17</span
              ><span class="points-container"
                >Points: <span class="points">28</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=36901406"
                  >Comments</a
                ><span class="descendants">: 4</span></span
              >
            </h4>
          </section>
        </section>
        <section id="36900294">
          <h3>
            <a class="item" href="https://www.assemblyai.com/blog/lemur/"
              >LeMUR: LLMs for Audio and Speech</a
            >
          </h3>
          <section>
            <h4>
              <span>2023-07-27 @ 21:18:16</span
              ><span class="points-container"
                >Points: <span class="points">63</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=36900294"
                  >Comments</a
                ><span class="descendants">: 8</span></span
              >
            </h4>
          </section>
        </section>
        <section id="36900106">
          <h3>
            <a class="item" href="https://www.svix.com/careers/"
              >Svix (YC W21) is hiring a founding account executive (US
              remote)</a
            >
          </h3>
          <section>
            <h4>
              <span>2023-07-27 @ 21:00:35</span
              ><span class="points-container"
                >Points: <span class="points">1</span></span
              >
            </h4>
          </section>
        </section>
        <section id="36899608">
          <h3>
            <a
              class="item"
              href="https://www.eff.org/press/releases/electronic-frontier-foundation-present-annual-eff-awards-alexandra-asanovna-elbakyan"
              >Annual EFF Awards: Alexandra Elbakyan, Library Freedom Project,
              and Signal</a
            >
          </h3>
          <section>
            <h4>
              <span>2023-07-27 @ 20:22:13</span
              ><span class="points-container"
                >Points: <span class="points">206</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=36899608"
                  >Comments</a
                ><span class="descendants">: 13</span></span
              >
            </h4>
          </section>
        </section>
        <section id="36899461">
          <h3>
            <a class="item" href="https://www.youtube.com/watch?v=VDiOKqMKTO8"
              >Hydraulic Steering – Principles of Operation (1956) [video]</a
            >
          </h3>
          <section>
            <h4>
              <span>2023-07-27 @ 20:10:48</span
              ><span class="points-container"
                >Points: <span class="points">37</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=36899461"
                  >Comments</a
                ><span class="descendants">: 23</span></span
              >
            </h4>
          </section>
        </section>
        <section id="36899221">
          <h3>
            <a
              class="item"
              href="https://arstechnica.com/science/2023/07/the-namibian-fairy-circle-debate-rages-on-could-it-be-sand-termites-after-all/"
              >Namibian fairy circle debate rages on: Sand termites or Turing
              mechanism?</a
            >
          </h3>
          <section>
            <h4>
              <span>2023-07-27 @ 19:53:54</span
              ><span class="points-container"
                >Points: <span class="points">65</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=36899221"
                  >Comments</a
                ><span class="descendants">: 24</span></span
              >
            </h4>
          </section>
        </section>
        <section id="36899029">
          <h3>
            <a class="item" href="https://github.com/nebuloss/killer"
              >Kill dwm.exe on Windows for less input lag and better
              performance</a
            >
          </h3>
          <section>
            <h4>
              <span>2023-07-27 @ 19:39:24</span
              ><span class="points-container"
                >Points: <span class="points">56</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=36899029"
                  >Comments</a
                ><span class="descendants">: 21</span></span
              >
            </h4>
          </section>
        </section>
        <section id="36898833">
          <h3>
            <a
              class="item"
              href="https://032c.com/magazine/berlin-review-lan-party"
              >Berlin Review: LAN Party</a
            >
          </h3>
          <section>
            <h4>
              <span>2023-07-27 @ 19:26:31</span
              ><span class="points-container"
                >Points: <span class="points">63</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=36898833"
                  >Comments</a
                ><span class="descendants">: 22</span></span
              >
            </h4>
          </section>
        </section>
        <section id="36898749">
          <h3>
            <a class="item" href="https://fabiensanglard.net/ega/"
              >Commander Keen's adaptive tile refresh</a
            >
          </h3>
          <section>
            <h4>
              <span>2023-07-27 @ 19:18:42</span
              ><span class="points-container"
                >Points: <span class="points">228</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=36898749"
                  >Comments</a
                ><span class="descendants">: 74</span></span
              >
            </h4>
          </section>
        </section>
        <section id="36897958">
          <h3>
            <a
              class="item"
              href="https://www.caltech.edu/about/news/some-alloys-dont-change-size-when-heated-we-now-know-why"
              >Some alloys don't change size when heated – recent work on why</a
            >
          </h3>
          <section>
            <h4>
              <span>2023-07-27 @ 18:18:47</span
              ><span class="points-container"
                >Points: <span class="points">118</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=36897958"
                  >Comments</a
                ><span class="descendants">: 56</span></span
              >
            </h4>
          </section>
        </section>
        <section id="36896710">
          <h3>
            <a
              class="item"
              href="https://lucaspauker.com/articles/llms-unleashed-the-power-of-fine-tuning"
              >LLMs Unleashed: The Power of Fine-Tuning</a
            >
          </h3>
          <section>
            <h4>
              <span>2023-07-27 @ 17:08:45</span
              ><span class="points-container"
                >Points: <span class="points">113</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=36896710"
                  >Comments</a
                ><span class="descendants">: 63</span></span
              >
            </h4>
          </section>
        </section>
        <section id="36896034">
          <h3>
            <a class="item" href="https://bloomberg.github.io/blazingmq/"
              >BlazingMQ: High-performance open source message queuing system</a
            >
          </h3>
          <section>
            <h4>
              <span>2023-07-27 @ 16:27:34</span
              ><span class="points-container"
                >Points: <span class="points">514</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=36896034"
                  >Comments</a
                ><span class="descendants">: 184</span></span
              >
            </h4>
          </section>
        </section>
        <section id="36895220">
          <h3>
            <a class="item" href="https://news.ycombinator.com/item?id=36895220"
              >Launch HN: PeerDB (YC S23) – Fast, Native ETL/ELT for Postgres</a
            >
          </h3>
          <section>
            <h4>
              <span>2023-07-27 @ 15:39:08</span
              ><span class="points-container"
                >Points: <span class="points">172</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=36895220"
                  >Comments</a
                ><span class="descendants">: 68</span></span
              >
            </h4>
            <div class="text">
              <a href="https://www.peerdb.io/">https://www.peerdb.io/</a>), a
              Postgres-first data-movement platform that makes moving data in
              and out of Postgres fast and simple. PeerDB is free and open (<a
                href="https://github.com/PeerDB-io/peerdb"
                >https://github.com/PeerDB-io/peerdb</a
              >) and we provide a Docker stack for users to try us out. Our repo
              is at
              <a href="https://github.com/PeerDB-io/peerdb"
                >https://github.com/PeerDB-io/peerdb</a
              >
              and there’s a 5-minute quickstart here:
              <a href="https://docs.peerdb.io/quickstart"
                >https://docs.peerdb.io/quickstart</a
              >.
              <p>
                For the past 8 years, working at Microsoft on Postgres on Azure,
                and before that at Citus Data, I’ve worked closely with
                customers running Postgres at the heart of their data stack,
                storing anywhere from 10s of GB of data to 10s of TB.
              </p>
              <p>
                This was when I got exposed to the challenges customers faced
                when moving data in and out of Postgres. Usually they would try
                existing ETL tools, fail, and decide to build in-house
                solutions. Common issues with these tools included painfully
                slow syncs - syncing 100s of GB of data took days; flaky and
                unreliable - frequent crashes, loss of data precision on target
                etc., and; feature-limited - lack of configurability,
                unsupported data types and so on.
              </p>
              <p>
                I remember a specific scenario where a tool didn’t support
                something as simple as the Postgres’ COPY command to ingest
                data. This would have improved the throughput by orders of
                magnitude. We (customer and me) reached out to that company to
                request them to add this feature. They couldn’t prioritize this
                feature because it wasn’t very easy - their tech stack was
                designed to support 100s of connectors rather than supporting a
                native Postgres feature.
              </p>
              <p>
                After multiple such occurrences, I thought, why not build a tool
                specialized for Postgres, making the lives of many Postgres
                users easier. I reached out to my long-time buddy Kaushik, who
                was building operating systems at Google and had led data teams
                at Safegraph and Palantir. We spent a few weeks building an MVP
                that streamed data in real-time from Postgres to BigQuery. It
                was 10 times faster than existing tools and maintained data
                freshness of less than 30 seconds. We realized that there were
                many Postgres native and infrastructural optimizations we could
                do to provide a rich data-movement experience for Postgres
                users. This is when we decided to start PeerDB!
              </p>
              <p>
                We started with two main use cases: Real-time Change Data
                Capture from Postgres (demo:
                <a href="https://docs.peerdb.io/usecases/realtime-cdc#demo"
                  >https://docs.peerdb.io/usecases/realtime-cdc#demo</a
                >) and Real-time Streaming of query results from Postgres (demo:
                <a
                  href="https://docs.peerdb.io/usecases/realtime-streaming-of-query-results#demo"
                  >https://docs.peerdb.io/usecases/realtime-streaming-of-query-...</a
                >). The 2nd demo shows PeerDB streaming a table with 100M rows
                from Postgres to Snowflake.
              </p>
              <p>
                We implement multiple optimizations to provide a fast, reliable,
                feature-rich experience. For performance, we can parallelize the
                initial load of a large table, still ensuring consistency.
                Syncing 100s of GB goes from days to minutes. We do this by
                logically partitioning the table based on internal tuple
                identifiers (CTID) and parallelly streaming those partitions
                (inspired by this DuckDB blog -
                <a
                  href="https://duckdb.org/2022/09/30/postgres-scanner.html#parallelization"
                  >https://duckdb.org/2022/09/30/postgres-scanner.html#parallel...</a
                >)
              </p>
              <p>
                For CDC, we don’t use Debezium, rather handle replication more
                natively—reading the slot, replicating the changes, keeping
                state etc. We made this choice mainly for flexibility. Staying
                native helps us use existing and future Postgres enhancements
                more effectively. For example, if the order of rows across
                tables on the target is not important, we can parallelize
                reading of a single slot across multiple tables and improve
                performance. Our architecture is designed for real-time syncs,
                which enables data-freshness of a few 10s of seconds even at
                large throughputs (10k+ tps).
              </p>
              <p>
                We have fault tolerance mechanisms for reliability (<a
                  href="https://blog.peerdb.io/using-temporal-to-scale-data-synchronization-at-peerdb"
                  >https://blog.peerdb.io/using-temporal-to-scale-data-synchron...</a
                >) and support multiple features including log-based (CDC) /
                query based streaming, efficient syncing of tables with large
                (TOAST) columns, configurable batching and parallelism to
                prevent OOMs and crashes etc.
              </p>
              <p>
                For usability - we provide a Postgres compatible SQL layer for
                data-movement. This makes the life of data engineers much
                easier. They can develop pipelines using a framework they are
                familiar with, without needing to deal with custom UIs and REST
                APIs. They can use Postgres' 100s of integrations to build and
                manage ETL. We extend Postgres' SQL grammar with a few new
                intuitive SQL commands to enable real-time data streaming across
                stores. Because of this, we were able to add dbt integration via
                Dagster (in private preview) in a few hours! We expect
                data-engineers to unravel similar integrations with PeerDB
                easily, and plan to make this grammar richer as we evolve.
              </p>
              <p>
                PeerDB consists of the following components to handle data
                replication: (1) PeerDB Server uses the pgwire protocol to mimic
                a PostgreSQL server, responsible for query routing and
                generating gRPC requests to the Flow API. It relies on AST
                analysis to make informed decisions on routing. (2) Flow API: an
                API layer that deals with gRPC commands, orchestrating the data
                sync operations; (3) Flow Workers execute the data read-write
                operations from the source to the destination. Built to scale
                horizontally, they interact with Temporal for increased
                resilience. The types of data replication supported include CDC
                streaming replication and query-based batch replication. Workers
                do all of the heavy lifting, and have data store specific
                optimizations.
              </p>
              <p>
                Currently we support 6 target data stores (BigQuery, Snowflake,
                Postgres, S3, Kafka etc) for data movement from Postgres. This
                doc captures the current status of the connectors:
                <a
                  href="https://docs.peerdb.io/sql/commands/supported-connectors"
                  >https://docs.peerdb.io/sql/commands/supported-connectors</a
                >.
              </p>
              <p>
                As we spoke to more customers, we realized that getting data
                into PostgreSQL at scale is equally important and hard. For
                example one of our customers wants to periodically sync data in
                multiple SQL Server instances (running on the edge) to their
                centralized Postgres database. Requests for Oracle to Postgres
                migrations are also common. So now we’re also supporting source
                data stores with Postgres as the target (currently SQL Server
                and Postgres itself, with more to come).
              </p>
              <p>
                We are actively working with customers to onboard them to our
                self-hosted enterprise offering. Our fully hosted offering on
                the cloud is in private preview. We haven’t yet decided on the
                pricing. One common concern we’ve heard from customers is that
                existing tools are expensive and charge based on the amount of
                data transferred. To address this, we are considering a more
                transparent way of pricing—for example, pricing based on
                provisioned hardware (cpu, memory, disk). We’re open for
                feedback on this!
              </p>
              <p>
                Check out our github repo -
                <a href="https://github.com/PeerDB-io/peerdb"
                  >https://github.com/PeerDB-io/peerdb</a
                >
                and go ahead and give it a spin (5-minute quickstart
                <a href="https://docs.peerdb.io/quickstart"
                  >https://docs.peerdb.io/quickstart</a
                >).
              </p>
              <p>
                We want to provide the world’s best data-movement experience for
                Postgres. We would love to get your feedback on product
                experience, our thesis and anything else that comes to your
                mind. It would be super useful for us. Thank you!
              </p>
            </div>
          </section>
        </section>
        <section id="36894932">
          <h3>
            <a
              class="item"
              href="https://www.allthingsdistributed.com/2023/07/building-and-operating-a-pretty-big-storage-system.html"
              >Building and operating a pretty big storage system called S3</a
            >
          </h3>
          <section>
            <h4>
              <span>2023-07-27 @ 15:20:35</span
              ><span class="points-container"
                >Points: <span class="points">377</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=36894932"
                  >Comments</a
                ><span class="descendants">: 84</span></span
              >
            </h4>
          </section>
        </section>
        <section id="36892970">
          <h3>
            <a
              class="item"
              href="https://twistedsifter.com/2020/06/how-wavy-crinkle-crankle-walls-use-less-bricks-than-straight-walls/"
              >Wavy walls use fewer bricks than a straight wall (2020)</a
            >
          </h3>
          <section>
            <h4>
              <span>2023-07-27 @ 13:16:41</span
              ><span class="points-container"
                >Points: <span class="points">511</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=36892970"
                  >Comments</a
                ><span class="descendants">: 229</span></span
              >
            </h4>
          </section>
        </section>
        <section id="36889251">
          <h3>
            <a
              class="item"
              href="https://www.vox.com/culture/23516638/cheesecake-factory-restaurant-menu"
              >How the Cheesecake Factory defied the restaurant industry’s rules
              of success</a
            >
          </h3>
          <section>
            <h4>
              <span>2023-07-27 @ 05:23:05</span
              ><span class="points-container"
                >Points: <span class="points">60</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=36889251"
                  >Comments</a
                ><span class="descendants">: 49</span></span
              >
            </h4>
          </section>
        </section>
        <section id="36888954">
          <h3>
            <a
              class="item"
              href="https://mail.tarsnap.com/tarsnap-announce/msg00050.html"
              >Tarsnap outage postmortem</a
            >
          </h3>
          <section>
            <h4>
              <span>2023-07-27 @ 04:33:56</span
              ><span class="points-container"
                >Points: <span class="points">488</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=36888954"
                  >Comments</a
                ><span class="descendants">: 283</span></span
              >
            </h4>
          </section>
        </section>
        <section id="36883227">
          <h3>
            <a
              class="item"
              href="https://www.theatlantic.com/books/archive/2023/07/evolution-liars-of-nature-lixing-sun-review/674808/"
              >Can Nature Lie?</a
            >
          </h3>
          <section>
            <h4>
              <span>2023-07-26 @ 19:08:22</span
              ><span class="points-container"
                >Points: <span class="points">19</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=36883227"
                  >Comments</a
                ><span class="descendants">: 17</span></span
              >
            </h4>
          </section>
        </section>
        <section id="36875958">
          <h3>
            <a
              class="item"
              href="https://web.archive.org/web/20230215010739if_/http://blogs.evergreen.edu/cpat/files/2013/05/Computer-Power-and-Human-Reason.pdf"
              >Computer Power and Human Reason (1976) [pdf]</a
            >
          </h3>
          <section>
            <h4>
              <span>2023-07-26 @ 11:32:46</span
              ><span class="points-container"
                >Points: <span class="points">27</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=36875958"
                  >Comments</a
                ><span class="descendants">: 8</span></span
              >
            </h4>
          </section>
        </section>
        <section id="36875815">
          <h3>
            <a
              class="item"
              href="https://blog.appsignal.com/2023/07/26/an-introduction-to-metaprogramming-in-ruby.html"
              >An introduction to metaprogramming in Ruby</a
            >
          </h3>
          <section>
            <h4>
              <span>2023-07-26 @ 11:18:49</span
              ><span class="points-container"
                >Points: <span class="points">114</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=36875815"
                  >Comments</a
                ><span class="descendants">: 52</span></span
              >
            </h4>
          </section>
        </section>
        <section id="36875622">
          <h3>
            <a
              class="item"
              href="https://worldsensorium.com/your-legacy-on-earth-may-be-a-plant/"
              >Plants that are signs of former human settlements</a
            >
          </h3>
          <section>
            <h4>
              <span>2023-07-26 @ 10:59:03</span
              ><span class="points-container"
                >Points: <span class="points">150</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=36875622"
                  >Comments</a
                ><span class="descendants">: 53</span></span
              >
            </h4>
          </section>
        </section>
        <section id="36875524">
          <h3>
            <a
              class="item"
              href="https://www.newyorker.com/culture/the-weekend-essay/how-to-be-blind"
              >How to Be Blind</a
            >
          </h3>
          <section>
            <h4>
              <span>2023-07-26 @ 10:47:59</span
              ><span class="points-container"
                >Points: <span class="points">62</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=36875524"
                  >Comments</a
                ><span class="descendants">: 15</span></span
              >
            </h4>
          </section>
        </section>
        <section id="36874485">
          <h3>
            <a
              class="item"
              href="https://martinfowler.com/bliki/TeamTopologies.html"
              >TeamTopologies</a
            >
          </h3>
          <section>
            <h4>
              <span>2023-07-26 @ 08:05:34</span
              ><span class="points-container"
                >Points: <span class="points">16</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=36874485"
                  >Comments</a
                ><span class="descendants">: 1</span></span
              >
            </h4>
          </section>
        </section>
        <section id="36873573">
          <h3>
            <a class="item" href="https://openpipes.org/"
              >OpenPipes: Build your open-source virtual pipe organ system</a
            >
          </h3>
          <section>
            <h4>
              <span>2023-07-26 @ 05:48:51</span
              ><span class="points-container"
                >Points: <span class="points">38</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=36873573"
                  >Comments</a
                ><span class="descendants">: 17</span></span
              >
            </h4>
          </section>
        </section>
        <section id="36872955">
          <h3>
            <a
              class="item"
              href="https://www.bbc.com/future/article/20230725-making-the-blue-flash-how-i-reconstructed-a-fatal-atomic-accident"
              >Making 'The Blue Flash': How I reconstructed a fatal atomic
              accident</a
            >
          </h3>
          <section>
            <h4>
              <span>2023-07-26 @ 04:05:54</span
              ><span class="points-container"
                >Points: <span class="points">50</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=36872955"
                  >Comments</a
                ><span class="descendants">: 18</span></span
              >
            </h4>
          </section>
        </section>
        <section id="36871152">
          <h3>
            <a
              class="item"
              href="https://www.laphamsquarterly.org/roundtable/wake-and-smell-coffee"
              >Feuding twin sisters popularized the American advice column</a
            >
          </h3>
          <section>
            <h4>
              <span>2023-07-25 @ 23:28:52</span
              ><span class="points-container"
                >Points: <span class="points">56</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=36871152"
                  >Comments</a
                ><span class="descendants">: 13</span></span
              >
            </h4>
          </section>
        </section>
      </section>
      <section id="archives">
        <h2>
          <a
            href="https://github.com/kherrick/hacker-news/blob/main/archives/index.md"
            >Archives</a
          >
        </h2>
        <section>
          <h3>
            <a
              href="https://github.com/kherrick/hacker-news/blob/main/archives/2023/index.md"
              >2023</a
            >
          </h3>
        </section>
        <section>
          <h3>
            <a
              href="https://github.com/kherrick/hacker-news/blob/main/archives/2022/index.md"
              >2022</a
            >
          </h3>
        </section>
      </section>
    </main>
    <script type="module">
      import { buildDescendants } from "./lib/build-html-descendants.js";
      import { buildNextItem } from "./lib/build-html-next-item.js";
      import { getNextDateTime } from "./lib/date-time.js";

      const updateSectionById = (id) =>
        fetch(`https://hacker-news.firebaseio.com/v0/item/${id}.json`).then(
          (result) =>
            result.json().then(({ descendants, id, score, text, type }) => {
              const currentItem = document.getElementById(id);

              if (score) {
                currentItem.querySelector(".points").textContent = score;
              }

              if (descendants && (type === "poll" || type === "story")) {
                const currentDescendants =
                  currentItem.querySelector(".descendants");

                if (currentDescendants) {
                  currentDescendants.textContent = `: ${descendants}`;
                } else {
                  const comments = buildDescendants(
                    document,
                    descendants,
                    `https://news.ycombinator.com/item?id=${id}`
                  );

                  currentItem.querySelector("h4").appendChild(comments);
                }
              }

              if (text) {
                const currentText = currentItem.querySelector(".text");

                if (currentText) {
                  currentText.innerHTML = text.replace(/\0/g, "");
                } else {
                  const content = document.createElement("div");
                  content.innerHTML = text.replace(/\0/g, "");
                  content.setAttribute("class", "text");

                  currentItem.appendChild(content);
                }
              }
            })
        );

      class UpdateQueue {
        constructor() {
          this._ids = [];
          this._isUpdating = false;
        }

        addItemById(id) {
          this._ids.push(id);
        }

        async flush() {
          const id = this._ids.shift();

          if (id) {
            this._isUpdating = true;

            await updateSectionById(id);
            await this.flush();
          } else {
            this._isUpdating = false;

            setTimeout(async () => {
              if (!this._isUpdating && this._ids && this._ids.length) {
                await this.flush();
              }
            }, 0);
          }
        }
      }

      // get latest data
      const latestSection = document.getElementById("latest");

      for (let item of latestSection.querySelectorAll("section[id]")) {
        updateSectionById(item.getAttribute("id"));
      }

      if ("IntersectionObserver" in window) {
        window.hackerNewsState = { index: [], nextTimeIndex: -1 };

        const addNewsItem = async (newsItem, queue) => {
          try {
            const { date, time, itemComments, itemTitle, itemLink } = newsItem;
            const section = await buildNextItem({
              document,
              dateTime: `${date}, ${time}`,
              itemComments,
              itemLink,
              itemTitle: new DOMParser().parseFromString(
                itemTitle.replace(/\\/g, ""),
                "text/html"
              ).documentElement.textContent,
              fetchItemDetails: false,
            });

            // display loading indicator for section
            section.querySelector(".points-container").innerHTML =
              'Points: <span class="points"><img style="height: 100%;" src="lib/images/loading.svg" /></span>';

            const id = section.getAttribute("id");
            if (!document.getElementById(id)) {
              document.getElementById("latest").appendChild(section);

              queue.addItemById(id);
            }
          } catch (error) {}
        };

        const buildArchiveIndex = async (lastDateTime) => {
          const nextDate = lastDateTime.slice(0, 10);
          const nextYear = nextDate.slice(0, 4);

          return (
            await (
              await fetch(
                `https://raw.githubusercontent.com/kherrick/hacker-news/main/archives/${nextYear}/${nextDate}/index.md`
              )
            ).text()
          )
            .split("\n")
            .filter((line) => line.match(new RegExp("^\\* \\[")))
            .map((line) => {
              const segment = line.replace("* ", "").split("](");
              const pubDate = segment[0].slice(1);

              const itemComments = segment[1].split(") - [")[0];
              const itemTitle = segment[1].split(") - [")[1];
              const itemLink = segment[2].slice(0, -1);
              const date = pubDate.slice(0, 10);
              const time = pubDate.slice(-8);

              return {
                date,
                itemComments,
                itemLink,
                itemTitle,
                time,
              };
            });
        };

        const handleIntersectingEntry = async (entry, queue) => {
          if (entry.isIntersecting) {
            const lastDateTime = document
              .getElementById("latest")
              .querySelector(
                "section:last-child > section > h4 > span"
              ).textContent;

            const nextDateTime = getNextDateTime(lastDateTime ?? "", -1);
            const archiveIndex = await buildArchiveIndex(nextDateTime);
            const nextTimeIndex = archiveIndex.findIndex(
              ({ time }) => time === nextDateTime.slice(-8)
            );

            const handleIndexUpdate = (index, existingIndexValues = []) => {
              index.forEach((i) => {
                existingIndexValues.push(i);
              });
              return existingIndexValues;
            };

            window.hackerNewsState = {
              index: handleIndexUpdate(
                archiveIndex,
                window.hackerNewsState.index
              ),
              nextTimeIndex,
            };

            let currentTimeIndex = nextTimeIndex + 1;
            const items = Object.values(window.hackerNewsState.index);
            for (let item of items) {
              if (currentTimeIndex < window.hackerNewsState.index.length) {
                addNewsItem(items[currentTimeIndex], queue);

                currentTimeIndex = currentTimeIndex + 1;
              }
            }

            queue.flush();
          }
        };

        const archives = document.getElementById("archives");
        const archivesObserver = new IntersectionObserver(
          (entries) => {
            const queue = new UpdateQueue();

            entries.forEach((entry) => handleIntersectingEntry(entry, queue));
          },
          {
            root: null,
            rootMargin: "0px",
            threshold: 0,
          }
        );

        archivesObserver.observe(archives);

        let latestSectionsExpanded = true;
        const handleLatestHeaderClick = () => {
          latestSectionsExpanded = !latestSectionsExpanded;

          if (latestSectionsExpanded) {
            archivesObserver.observe(archives);
          } else {
            archivesObserver.disconnect(archives);
          }

          for (let section of document.querySelectorAll("#latest > section")) {
            section.style.display = latestSectionsExpanded ? "block" : "none";
          }
        };

        const latestHeader = document.querySelector("#latest > h2");
        latestHeader.style.cursor = "pointer";
        latestHeader.addEventListener("click", handleLatestHeaderClick);
      }
    </script>
    <script type="module">
      import { Workbox } from "https://storage.googleapis.com/workbox-cdn/releases/6.4.1/workbox-window.prod.mjs";

      if ("serviceWorker" in navigator) {
        const base = document.querySelector("base");
        const serviceWorkerPath = `${
          base ? base.href.replace(/\/$/, "") : ""
        }/service-worker.js`;

        const wb = new Workbox(serviceWorkerPath);

        // setup event listeners
        wb.addEventListener("waiting", (event) => {
          wb.addEventListener("controlling", () => {
            window.location.reload();
          });

          wb.messageSkipWaiting();
        });

        wb.register();
      }
    </script>
  </body>
</html>
