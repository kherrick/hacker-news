<!DOCTYPE html>
<html lang="en" xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta charset="utf-8" />
    <meta
      content="width=device-width, initial-scale=1.0, viewport-fit=cover"
      name="viewport"
    />
    <meta name="description" content="Hacker News" />
    <meta name="theme-color" content="#fff" />
    <title>Hacker News</title>
    <link rel="manifest" href="manifest.json" />
    <link
      href="data:image/x-icon;base64,AAABAAEAAQECAAEAAQA4AAAAFgAAACgAAAABAAAAAgAAAAEAAQAAAAAAAAAAAAAAAAAAAAAAAAAAAAABAAEAAQECAAEAAQA4AAAAFgAAACgAAAABAAAAAgAAAAEAAQAAAAAAAAAAAAAAAAAAAAAAAAAA"
      rel="icon"
      type="image/x-icon"
    />
    <link
      href="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAgAAAAIAAQMAAADOtka5AAAAA1BMVEUAAACnej3aAAAANklEQVR42u3BAQEAAACCIP+vbkhAAQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAB8G4IAAAFjdVCkAAAAAElFTkSuQmCC"
      rel="apple-touch-icon"
    />
    <style>
      /*<!--*/
      body {
        color: rgb(25, 25, 25);
        font-family: Verdana, Geneva, sans-serif;
        margin: 0;
      }

      a {
        text-decoration: none;
      }

      a:link,
      a:focus,
      a:hover,
      a:active {
        color: rgb(75, 75, 125);
      }

      a:visited {
        color: rgb(25, 25, 25);
      }

      h1 > a,
      h1 > a:link,
      h1 > a:focus,
      h1 > a:hover,
      h1 > a:active,
      h1 > a:visited,
      h2 > a,
      h2 > a:link,
      h2 > a:focus,
      h2 > a:hover,
      h2 > a:active,
      h2 > a:visited {
        color: rgb(25, 25, 25);
      }

      h1 {
        background-color: rgb(255, 102, 0);
        margin: 0;
        padding: 1rem;
      }

      h2 {
        background-color: rgb(200, 200, 200);
        margin: 1rem 0;
        padding: 0.5rem 0.5rem 0.5rem 1rem;
      }

      #latest > section,
      #archives > section {
        margin: 0 1rem 1rem 1rem;
        padding-bottom: 1rem;
      }

      #latest > section:not(:last-child),
      #archives > section:not(:last-child) {
        border-bottom: 1px dotted rgb(200, 200, 200);
      }

      section > h3 {
        margin: 0 0 0.5rem 0;
      }

      section > h4 {
        font-weight: normal;
        margin: 0 0 0 1rem;
      }

      .descendants-container,
      .points-container {
        align-items: center;
        border-left: 1px solid #333;
        display: inline-flex;
        margin-left: 0.5rem;
        padding-left: 0.5rem;
        text-align: center;
      }

      .points {
        align-items: center;
        display: inline-flex;
        height: 1rem;
        margin-left: 1ch;
        min-width: 3ch;
      }

      .text {
        line-height: 1.5rem;
        margin: 1rem 1rem 0 1rem;
        overflow: auto;
      }

      .text > p:first-child {
        margin-top: 1rem;
      }

      .text > p:last-child {
        margin-bottom: 0;
      }
      /*-->*/
    </style>
  </head>

  <body>
    <main>
      <h1><a href="https://kherrick.github.io/hacker-news/">Hacker News</a></h1>
      <section id="latest">
        <h2>Latest</h2>
        <section id="43533362">
          <h3>
            <a
              class="item"
              href="https://www.goto80.com/the-demoscene-as-a-unesco-heritage-in-sweden"
              >The demoscene as a UNESCO heritage in Sweden</a
            >
          </h3>
          <section>
            <h4>
              <span>2025-03-31 @ 10:39:57</span
              ><span class="points-container"
                >Points: <span class="points">46</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=43533362"
                  >Comments</a
                ><span class="descendants">: 3</span></span
              >
            </h4>
          </section>
        </section>
        <section id="43533306">
          <h3>
            <a
              class="item"
              href="https://www.smithsonianmag.com/smart-news/james-webb-space-telescope-reveals-that-most-galaxies-rotate-clockwise-180986224/"
              >James Webb Space Telescope Reveals That Most Galaxies Rotate
              Clockwise</a
            >
          </h3>
          <section>
            <h4>
              <span>2025-03-31 @ 10:31:39</span
              ><span class="points-container"
                >Points: <span class="points">66</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=43533306"
                  >Comments</a
                ><span class="descendants">: 45</span></span
              >
            </h4>
          </section>
        </section>
        <section id="43533173">
          <h3>
            <a
              class="item"
              href="https://www.theregister.com/2025/03/29/nvidia_moores_law/"
              >Nvidia GPU roadmap confirms it: Moore's Law is dead and buried</a
            >
          </h3>
          <section>
            <h4>
              <span>2025-03-31 @ 10:09:26</span
              ><span class="points-container"
                >Points: <span class="points">27</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=43533173"
                  >Comments</a
                ><span class="descendants">: 15</span></span
              >
            </h4>
          </section>
        </section>
        <section id="43533096">
          <h3><a class="item" href="https://tosdr.org/en">ToS;DR</a></h3>
          <section>
            <h4>
              <span>2025-03-31 @ 09:54:36</span
              ><span class="points-container"
                >Points: <span class="points">36</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=43533096"
                  >Comments</a
                ><span class="descendants">: 8</span></span
              >
            </h4>
          </section>
        </section>
        <section id="43532967">
          <h3>
            <a class="item" href="https://github.com/lharries/whatsapp-mcp"
              >Show HN: WhatsApp MCP Server</a
            >
          </h3>
          <section>
            <h4>
              <span>2025-03-31 @ 09:32:54</span
              ><span class="points-container"
                >Points: <span class="points">68</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=43532967"
                  >Comments</a
                ><span class="descendants">: 28</span></span
              >
            </h4>
            <div class="text">
              <a href="https://github.com/lharries/whatsapp-mcp"
                >https://github.com/lharries/whatsapp-mcp</a
              >
              <p>
                It connects to your personal WhatsApp account via the WhatsApp
                Web multi-device API (using whatsmeow from the Beeper team), and
                doesn't rely on third-party APIs. All messages are stored
                locally in SQLite. Nothing is sent to the cloud unless you
                explicitly allow your LLM to access the data via tools â€“ so you
                maintain full control and privacy.
              </p>
              <p>The MCP server can:</p>
              <p>- Search your messages, contacts, and groups</p>
              <p>- Send WhatsApp messages to individuals or groups</p>
              <p>Why build this?</p>
              <p>
                99% of your life is stored in WhatsApp, by connecting an LLM to
                WhatsApp you get all this context. And your AI agent can execute
                tasks on your behalf by sending messages.
              </p>
            </div>
          </section>
        </section>
        <section id="43532298">
          <h3>
            <a
              class="item"
              href="https://daniel.haxx.se/blog/2025/03/31/https-rr-in-curl/"
              >HTTPS RR in Curl</a
            >
          </h3>
          <section>
            <h4>
              <span>2025-03-31 @ 07:48:37</span
              ><span class="points-container"
                >Points: <span class="points">45</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=43532298"
                  >Comments</a
                ><span class="descendants">: 8</span></span
              >
            </h4>
          </section>
        </section>
        <section id="43532220">
          <h3>
            <a class="item" href="https://arxiv.org/abs/2503.21145"
              >How to Secure Existing C and C++ Software Without Memory Safety
              [pdf]</a
            >
          </h3>
          <section>
            <h4>
              <span>2025-03-31 @ 07:36:56</span
              ><span class="points-container"
                >Points: <span class="points">61</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=43532220"
                  >Comments</a
                ><span class="descendants">: 20</span></span
              >
            </h4>
          </section>
        </section>
        <section id="43532009">
          <h3>
            <a class="item" href="https://news.ycombinator.com/item?id=43532009"
              >Wondercraft (YC S22) Is Hiring</a
            >
          </h3>
          <section>
            <h4>
              <span>2025-03-31 @ 07:00:19</span
              ><span class="points-container"
                >Points: <span class="points">1</span></span
              >
            </h4>
            <div class="text">
              <p>
                Work with the founders &amp; product team to materialize the
                vision into concrete flows and screens that can be implemented
                Work alongside the growth team to build assets and flows to
                increase growth and retention About YOU
              </p>
              <p>We are looking for someone who:</p>
              <p>
                Is excited by the ability to contribute to a variety of areas in
                the company (e.g. product, marketing, etc) Understands and
                incorporates the psychology of end-users into designs Is
                multi-disciplinary, and has experiences across graphic, product,
                web, and UI/UX designs Is a great communicator and a logical
                thinker Isnâ€™t afraid to experiment, fail, and iterate Is ready
                to go at full speed with the team Is proficient in design
                software such as Figma and Photoshop Is ready to join the
                mission of a small team taking on a big industry Is interested
                in AI advancements Has startup experience (huge plus) Has built
                something like this for a startup like ours (huge plus) Whatâ€™s
                in it for you?
              </p>
              <p>
                At Wondercraft, everyone wins. We believe in creating
                positive-sum outcomes in all interactions we have, internally
                and externally. At Wondercraft, you have the chance to really
                make a difference by getting your hands dirty and building
                something rapidly. We believe in building magic at lightning
                speed. Weâ€™ve been proud to ship quality features every single
                week, and we intend to only increase this pace even further. At
                Wondercraft, you have the chance to grow. Working in a small
                team means you are working directly with the Founders.
                Regardless of your career aspirations, you would have so much to
                learn from Wondercraft. Wondercraft is one of the fastest
                growing AI companies, especially in the Text-to-Speech space and
                will soon be raising a Series A round. Joining now gives you the
                opportunity to get equity at a very meaningful value. Plus some
                on-the-job benefits:
              </p>
              <p>
                Salary range $40k - $100k depending on how much you have to
                bring to the table. We are keen to compensate for the value you
                create! Private health insurance so that we can take care of
                your physical health. Hybrid working. We would prefer to all
                work together in our office in central London because we believe
                face-to-face contact time is essential for us growing together a
                team. That said, we donâ€™t mind if you work from home one or two
                days a week.
              </p>
            </div>
          </section>
        </section>
        <section id="43531914">
          <h3>
            <a
              class="item"
              href="https://herbsutter.com/2025/03/30/crate-training-tiamat-un-calling-cthulhutaming-the-ub-monsters-in-c/"
              >Taming the UB Monsters in C++</a
            >
          </h3>
          <section>
            <h4>
              <span>2025-03-31 @ 06:45:23</span
              ><span class="points-container"
                >Points: <span class="points">62</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=43531914"
                  >Comments</a
                ><span class="descendants">: 37</span></span
              >
            </h4>
          </section>
        </section>
        <section id="43531415">
          <h3>
            <a class="item" href="https://www.marutan.net/rpcemu/index.php"
              >RPCEmu is an emulator of classic Acorn computer systems</a
            >
          </h3>
          <section>
            <h4>
              <span>2025-03-31 @ 05:28:03</span
              ><span class="points-container"
                >Points: <span class="points">38</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=43531415"
                  >Comments</a
                ><span class="descendants">: 3</span></span
              >
            </h4>
          </section>
        </section>
        <section id="43530889">
          <h3>
            <a class="item" href="https://github.com/oerg866/win98-quickinstall"
              >Win98-quickinstall: A framework and installer to quickly install
              Windows 98</a
            >
          </h3>
          <section>
            <h4>
              <span>2025-03-31 @ 04:10:45</span
              ><span class="points-container"
                >Points: <span class="points">130</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=43530889"
                  >Comments</a
                ><span class="descendants">: 55</span></span
              >
            </h4>
          </section>
        </section>
        <section id="43530863">
          <h3>
            <a
              class="item"
              href="https://www.laphamsquarterly.org/roundtable/laphams-quarterly-announces-new-stewardship"
              >Lapham's Quarterly Announces New Stewardship</a
            >
          </h3>
          <section>
            <h4>
              <span>2025-03-31 @ 04:07:41</span
              ><span class="points-container"
                >Points: <span class="points">21</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=43530863"
                  >Comments</a
                ><span class="descendants">: 5</span></span
              >
            </h4>
          </section>
        </section>
        <section id="43529709">
          <h3>
            <a
              class="item"
              href="https://www.cam.ac.uk/stories/merlin-manuscript-discovered-cambridge"
              >Fragments of a rare Merlin manuscript from c. 1300</a
            >
          </h3>
          <section>
            <h4>
              <span>2025-03-31 @ 01:27:09</span
              ><span class="points-container"
                >Points: <span class="points">92</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=43529709"
                  >Comments</a
                ><span class="descendants">: 22</span></span
              >
            </h4>
          </section>
        </section>
        <section id="43529257">
          <h3>
            <a
              class="item"
              href="https://www.vox.com/2020/1/8/21051869/indoor-air-pollution-student-achievement"
              >Installing air filters in classrooms has surprisingly large
              educational benefits (2020)</a
            >
          </h3>
          <section>
            <h4>
              <span>2025-03-31 @ 00:22:40</span
              ><span class="points-container"
                >Points: <span class="points">267</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=43529257"
                  >Comments</a
                ><span class="descendants">: 109</span></span
              >
            </h4>
          </section>
        </section>
        <section id="43529104">
          <h3><a class="item" href="https://oka.wiki/">Oka.wiki</a></h3>
          <section>
            <h4>
              <span>2025-03-30 @ 23:59:23</span
              ><span class="points-container"
                >Points: <span class="points">79</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=43529104"
                  >Comments</a
                ><span class="descendants">: 28</span></span
              >
            </h4>
          </section>
        </section>
        <section id="43527761">
          <h3>
            <a
              class="item"
              href="https://blog.gingerbeardman.com/2025/03/30/station-travel-through-the-four-seasons-1994/"
              >Station: Travel Through the Four Seasons (1994)</a
            >
          </h3>
          <section>
            <h4>
              <span>2025-03-30 @ 21:20:10</span
              ><span class="points-container"
                >Points: <span class="points">10</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=43527761"
                  >Comments</a
                ><span class="descendants">: 0</span></span
              >
            </h4>
          </section>
        </section>
        <section id="43527452">
          <h3>
            <a class="item" href="https://news.ycombinator.com/item?id=43527452"
              >Ask HN: What are you working on? (March 2025)</a
            >
          </h3>
          <section>
            <h4>
              <span>2025-03-30 @ 20:43:15</span
              ><span class="points-container"
                >Points: <span class="points">263</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=43527452"
                  >Comments</a
                ><span class="descendants">: 622</span></span
              >
            </h4>
            <div class="text">
              What are you working on? Any new ideas that you're thinking about?
            </div>
          </section>
        </section>
        <section id="43527044">
          <h3>
            <a
              class="item"
              href="https://www.praetorian.com/blog/codeqleaked-public-secrets-exposure-leads-to-supply-chain-attack-on-github-codeql/"
              >Public secrets exposure leads to supply chain attack on GitHub
              CodeQL</a
            >
          </h3>
          <section>
            <h4>
              <span>2025-03-30 @ 19:54:46</span
              ><span class="points-container"
                >Points: <span class="points">261</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=43527044"
                  >Comments</a
                ><span class="descendants">: 52</span></span
              >
            </h4>
          </section>
        </section>
        <section id="43526763">
          <h3>
            <a
              class="item"
              href="https://nostarch.com/introduction-system-programming-linux"
              >Introduction to System Programming in Linux (Early Access)</a
            >
          </h3>
          <section>
            <h4>
              <span>2025-03-30 @ 19:22:36</span
              ><span class="points-container"
                >Points: <span class="points">161</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=43526763"
                  >Comments</a
                ><span class="descendants">: 31</span></span
              >
            </h4>
          </section>
        </section>
        <section id="43524937">
          <h3>
            <a class="item" href="https://github.com/winblues/blue95"
              >Blue95: a desktop for your childhood home's computer room</a
            >
          </h3>
          <section>
            <h4>
              <span>2025-03-30 @ 15:30:22</span
              ><span class="points-container"
                >Points: <span class="points">509</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=43524937"
                  >Comments</a
                ><span class="descendants">: 261</span></span
              >
            </h4>
          </section>
        </section>
        <section id="43513967">
          <h3>
            <a class="item" href="https://blog.lohr.dev/imap-introduction"
              >How IMAP works under the hood</a
            >
          </h3>
          <section>
            <h4>
              <span>2025-03-29 @ 09:05:33</span
              ><span class="points-container"
                >Points: <span class="points">43</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=43513967"
                  >Comments</a
                ><span class="descendants">: 8</span></span
              >
            </h4>
          </section>
        </section>
        <section id="43513301">
          <h3>
            <a
              class="item"
              href="https://www.atlasobscura.com/articles/antarctica-ivan-the-terra-bus-retired"
              >One Last Ride for Antarctica's 'Ivan the Terra Bus'</a
            >
          </h3>
          <section>
            <h4>
              <span>2025-03-29 @ 06:35:04</span
              ><span class="points-container"
                >Points: <span class="points">40</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=43513301"
                  >Comments</a
                ><span class="descendants">: 4</span></span
              >
            </h4>
          </section>
        </section>
        <section id="43510656">
          <h3>
            <a
              class="item"
              href="https://drb.ie/articles/talkin-about-a-revolution/"
              >Talkinâ€™ about a Revolution</a
            >
          </h3>
          <section>
            <h4>
              <span>2025-03-28 @ 22:42:07</span
              ><span class="points-container"
                >Points: <span class="points">30</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=43510656"
                  >Comments</a
                ><span class="descendants">: 97</span></span
              >
            </h4>
          </section>
        </section>
        <section id="43510393">
          <h3>
            <a
              class="item"
              href="https://newslttrs.com/yes-in-the-1980s-we-downloaded-games-from-the-radio/"
              >Yes, in the 1980s we downloaded games from the radio</a
            >
          </h3>
          <section>
            <h4>
              <span>2025-03-28 @ 22:14:33</span
              ><span class="points-container"
                >Points: <span class="points">38</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=43510393"
                  >Comments</a
                ><span class="descendants">: 23</span></span
              >
            </h4>
          </section>
        </section>
        <section id="43504514">
          <h3>
            <a class="item" href="https://tf230.matteason.co.uk/"
              >Claim for a missing tooth</a
            >
          </h3>
          <section>
            <h4>
              <span>2025-03-28 @ 12:25:00</span
              ><span class="points-container"
                >Points: <span class="points">302</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=43504514"
                  >Comments</a
                ><span class="descendants">: 64</span></span
              >
            </h4>
          </section>
        </section>
        <section id="43503185">
          <h3>
            <a
              class="item"
              href="https://electrek.co/2025/03/27/v2x-growth-electric-school-buses/"
              >The surprising powerhouse behind rapid V2X growth: electric
              school buses</a
            >
          </h3>
          <section>
            <h4>
              <span>2025-03-28 @ 09:16:41</span
              ><span class="points-container"
                >Points: <span class="points">18</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=43503185"
                  >Comments</a
                ><span class="descendants">: 9</span></span
              >
            </h4>
          </section>
        </section>
        <section id="43502348">
          <h3>
            <a
              class="item"
              href="https://sergeyteplyakov.github.io/Blog/2025/03/27/Finalizers_are_tricker_than_you_might_think_p2.html"
              >Finalizers are tricker than you might think. Part 2</a
            >
          </h3>
          <section>
            <h4>
              <span>2025-03-28 @ 06:58:00</span
              ><span class="points-container"
                >Points: <span class="points">26</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=43502348"
                  >Comments</a
                ><span class="descendants">: 4</span></span
              >
            </h4>
          </section>
        </section>
        <section id="43502124">
          <h3>
            <a class="item" href="https://pubs.usgs.gov/publication/pp1707"
              >Orphan tsunami of 1700â€“Japanese clues to a parent earthquake in
              America (2015)</a
            >
          </h3>
          <section>
            <h4>
              <span>2025-03-28 @ 06:23:06</span
              ><span class="points-container"
                >Points: <span class="points">37</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=43502124"
                  >Comments</a
                ><span class="descendants">: 12</span></span
              >
            </h4>
          </section>
        </section>
        <section id="43498861">
          <h3>
            <a
              class="item"
              href="https://www.theguardian.com/books/2025/mar/19/george-orwell-me-richard-blair-life-with-extraordinary-father"
              >George Orwell and me: Richard Blair on life with his
              extraordinary father</a
            >
          </h3>
          <section>
            <h4>
              <span>2025-03-27 @ 22:21:20</span
              ><span class="points-container"
                >Points: <span class="points">58</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=43498861"
                  >Comments</a
                ><span class="descendants">: 12</span></span
              >
            </h4>
          </section>
        </section>
        <section id="43492415">
          <h3>
            <a class="item" href="https://www.noteux.com/"
              >Fastest and Minimalist Note Taking App</a
            >
          </h3>
          <section>
            <h4>
              <span>2025-03-27 @ 11:19:59</span
              ><span class="points-container"
                >Points: <span class="points">6</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=43492415"
                  >Comments</a
                ><span class="descendants">: 5</span></span
              >
            </h4>
          </section>
        </section>
      </section>
      <section id="archives">
        <h2>
          <a
            href="https://github.com/kherrick/hacker-news/blob/main/archives/index.md"
            >Archives</a
          >
        </h2>
        <section>
          <h3>
            <a
              href="https://github.com/kherrick/hacker-news/blob/main/archives/2025/index.md"
              >2025</a
            >
          </h3>
        </section>
        <section>
          <h3>
            <a
              href="https://github.com/kherrick/hacker-news/blob/main/archives/2024/index.md"
              >2024</a
            >
          </h3>
        </section>
        <section>
          <h3>
            <a
              href="https://github.com/kherrick/hacker-news/blob/main/archives/2023/index.md"
              >2023</a
            >
          </h3>
        </section>
        <section>
          <h3>
            <a
              href="https://github.com/kherrick/hacker-news/blob/main/archives/2022/index.md"
              >2022</a
            >
          </h3>
        </section>
      </section>
    </main>
    <script type="module">
      import { buildDescendants } from "./lib/build-html-descendants.js";
      import { buildNextItem } from "./lib/build-html-next-item.js";
      import { getNextDateTime } from "./lib/date-time.js";

      const updateSectionById = (id) =>
        fetch(`https://hacker-news.firebaseio.com/v0/item/${id}.json`).then(
          (result) =>
            result.json().then(({ descendants, id, score, text, type }) => {
              const currentItem = document.getElementById(id);

              if (score) {
                currentItem.querySelector(".points").textContent = score;
              }

              if (descendants && (type === "poll" || type === "story")) {
                const currentDescendants =
                  currentItem.querySelector(".descendants");

                if (currentDescendants) {
                  currentDescendants.textContent = `: ${descendants}`;
                } else {
                  const comments = buildDescendants(
                    document,
                    descendants,
                    `https://news.ycombinator.com/item?id=${id}`
                  );

                  currentItem.querySelector("h4").appendChild(comments);
                }
              }

              if (text) {
                const currentText = currentItem.querySelector(".text");

                if (currentText) {
                  currentText.innerHTML = text.replace(/\0/g, "");
                } else {
                  const content = document.createElement("div");
                  content.innerHTML = text.replace(/\0/g, "");
                  content.setAttribute("class", "text");

                  currentItem.appendChild(content);
                }
              }
            })
        );

      class UpdateQueue {
        constructor() {
          this._ids = [];
          this._isUpdating = false;
        }

        addItemById(id) {
          this._ids.push(id);
        }

        async flush() {
          const id = this._ids.shift();

          if (id) {
            this._isUpdating = true;

            await updateSectionById(id);
            await this.flush();
          } else {
            this._isUpdating = false;

            setTimeout(async () => {
              if (!this._isUpdating && this._ids && this._ids.length) {
                await this.flush();
              }
            }, 0);
          }
        }
      }

      // get latest data
      const latestSection = document.getElementById("latest");

      for (let item of latestSection.querySelectorAll("section[id]")) {
        updateSectionById(item.getAttribute("id"));
      }

      if ("IntersectionObserver" in window) {
        window.hackerNewsState = { index: [], nextTimeIndex: -1 };

        const addNewsItem = async (newsItem, queue) => {
          try {
            const { date, time, itemComments, itemTitle, itemLink } = newsItem;
            const section = await buildNextItem({
              document,
              dateTime: `${date}, ${time}`,
              itemComments,
              itemLink,
              itemTitle: new DOMParser().parseFromString(
                itemTitle.replace(/\\/g, ""),
                "text/html"
              ).documentElement.textContent,
              fetchItemDetails: false,
            });

            // display loading indicator for section
            section.querySelector(".points-container").innerHTML =
              'Points: <span class="points"><img style="height: 100%;" src="lib/images/loading.svg" /></span>';

            const id = section.getAttribute("id");
            if (!document.getElementById(id)) {
              document.getElementById("latest").appendChild(section);

              queue.addItemById(id);
            }
          } catch (error) {}
        };

        const buildArchiveIndex = async (lastDateTime) => {
          const nextDate = lastDateTime.slice(0, 10);
          const nextYear = nextDate.slice(0, 4);

          return (
            await (
              await fetch(
                `https://raw.githubusercontent.com/kherrick/hacker-news/main/archives/${nextYear}/${nextDate}/index.md`
              )
            ).text()
          )
            .split("\n")
            .filter((line) => line.match(new RegExp("^\\* \\[")))
            .map((line) => {
              const segment = line.replace("* ", "").split("](");
              const pubDate = segment[0].slice(1);

              const itemComments = segment[1].split(") - [")[0];
              const itemTitle = segment[1].split(") - [")[1];
              const itemLink = segment[2].slice(0, -1);
              const date = pubDate.slice(0, 10);
              const time = pubDate.slice(-8);

              return {
                date,
                itemComments,
                itemLink,
                itemTitle,
                time,
              };
            });
        };

        const handleIntersectingEntry = async (entry, queue) => {
          if (entry.isIntersecting) {
            const lastDateTime = document
              .getElementById("latest")
              .querySelector(
                "section:last-child > section > h4 > span"
              ).textContent;

            const nextDateTime = getNextDateTime(lastDateTime ?? "", -1);
            const archiveIndex = await buildArchiveIndex(nextDateTime);
            const nextTimeIndex = archiveIndex.findIndex(
              ({ time }) => time === nextDateTime.slice(-8)
            );

            const handleIndexUpdate = (index, existingIndexValues = []) => {
              index.forEach((i) => {
                existingIndexValues.push(i);
              });
              return existingIndexValues;
            };

            window.hackerNewsState = {
              index: handleIndexUpdate(
                archiveIndex,
                window.hackerNewsState.index
              ),
              nextTimeIndex,
            };

            let currentTimeIndex = nextTimeIndex + 1;
            const items = Object.values(window.hackerNewsState.index);
            for (let item of items) {
              if (currentTimeIndex < window.hackerNewsState.index.length) {
                addNewsItem(items[currentTimeIndex], queue);

                currentTimeIndex = currentTimeIndex + 1;
              }
            }

            queue.flush();
          }
        };

        const archives = document.getElementById("archives");
        const archivesObserver = new IntersectionObserver(
          (entries) => {
            const queue = new UpdateQueue();

            entries.forEach((entry) => handleIntersectingEntry(entry, queue));
          },
          {
            root: null,
            rootMargin: "0px",
            threshold: 0,
          }
        );

        archivesObserver.observe(archives);

        let latestSectionsExpanded = true;
        const handleLatestHeaderClick = () => {
          latestSectionsExpanded = !latestSectionsExpanded;

          if (latestSectionsExpanded) {
            archivesObserver.observe(archives);
          } else {
            archivesObserver.disconnect(archives);
          }

          for (let section of document.querySelectorAll("#latest > section")) {
            section.style.display = latestSectionsExpanded ? "block" : "none";
          }
        };

        const latestHeader = document.querySelector("#latest > h2");
        latestHeader.style.cursor = "pointer";
        latestHeader.addEventListener("click", handleLatestHeaderClick);
      }
    </script>
    <script type="module">
      import { Workbox } from "https://storage.googleapis.com/workbox-cdn/releases/6.4.1/workbox-window.prod.mjs";

      if ("serviceWorker" in navigator) {
        const base = document.querySelector("base");
        const serviceWorkerPath = `${
          base ? base.href.replace(/\/$/, "") : ""
        }/service-worker.js`;

        const wb = new Workbox(serviceWorkerPath);

        // setup event listeners
        wb.addEventListener("waiting", (event) => {
          wb.addEventListener("controlling", () => {
            window.location.reload();
          });

          wb.messageSkipWaiting();
        });

        wb.register();
      }
    </script>
  </body>
</html>
