<!DOCTYPE html>
<html lang="en" xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta charset="utf-8" />
    <meta
      content="width=device-width, initial-scale=1.0, viewport-fit=cover"
      name="viewport"
    />
    <meta name="description" content="Hacker News" />
    <meta name="theme-color" content="#fff" />
    <title>Hacker News</title>
    <link rel="manifest" href="manifest.json" />
    <link
      href="data:image/x-icon;base64,AAABAAEAAQECAAEAAQA4AAAAFgAAACgAAAABAAAAAgAAAAEAAQAAAAAAAAAAAAAAAAAAAAAAAAAAAAABAAEAAQECAAEAAQA4AAAAFgAAACgAAAABAAAAAgAAAAEAAQAAAAAAAAAAAAAAAAAAAAAAAAAA"
      rel="icon"
      type="image/x-icon"
    />
    <link
      href="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAgAAAAIAAQMAAADOtka5AAAAA1BMVEUAAACnej3aAAAANklEQVR42u3BAQEAAACCIP+vbkhAAQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAB8G4IAAAFjdVCkAAAAAElFTkSuQmCC"
      rel="apple-touch-icon"
    />
    <style>
      /*<!--*/
      body {
        color: rgb(25, 25, 25);
        font-family: Verdana, Geneva, sans-serif;
        margin: 0;
      }

      a {
        text-decoration: none;
      }

      a:link,
      a:focus,
      a:hover,
      a:active {
        color: rgb(75, 75, 125);
      }

      a:visited {
        color: rgb(25, 25, 25);
      }

      h1 > a,
      h1 > a:link,
      h1 > a:focus,
      h1 > a:hover,
      h1 > a:active,
      h1 > a:visited,
      h2 > a,
      h2 > a:link,
      h2 > a:focus,
      h2 > a:hover,
      h2 > a:active,
      h2 > a:visited {
        color: rgb(25, 25, 25);
      }

      h1 {
        background-color: rgb(255, 102, 0);
        margin: 0;
        padding: 1rem;
      }

      h2 {
        background-color: rgb(200, 200, 200);
        margin: 1rem 0;
        padding: 0.5rem 0.5rem 0.5rem 1rem;
      }

      #latest > section,
      #archives > section {
        margin: 0 1rem 1rem 1rem;
        padding-bottom: 1rem;
      }

      #latest > section:not(:last-child),
      #archives > section:not(:last-child) {
        border-bottom: 1px dotted rgb(200, 200, 200);
      }

      section > h3 {
        margin: 0 0 0.5rem 0;
      }

      section > h4 {
        font-weight: normal;
        margin: 0 0 0 1rem;
      }

      .descendants-container,
      .points-container {
        align-items: center;
        border-left: 1px solid #333;
        display: inline-flex;
        margin-left: 0.5rem;
        padding-left: 0.5rem;
        text-align: center;
      }

      .points {
        align-items: center;
        display: inline-flex;
        height: 1rem;
        margin-left: 1ch;
        min-width: 3ch;
      }

      .text {
        line-height: 1.5rem;
        margin: 1rem 1rem 0 1rem;
        overflow: auto;
      }

      .text > p:first-child {
        margin-top: 1rem;
      }

      .text > p:last-child {
        margin-bottom: 0;
      }
      /*-->*/
    </style>
  </head>

  <body>
    <main>
      <h1><a href="https://kherrick.github.io/hacker-news/">Hacker News</a></h1>
      <section id="latest">
        <h2>Latest</h2>
        <section id="37627782">
          <h3>
            <a
              class="item"
              href="https://notsoprofound.com/the-unforeseen-lsd-overdose-of-1972/"
              >The Unforeseen LSD Overdose of 1972</a
            >
          </h3>
          <section>
            <h4>
              <span>2023-09-23 @ 21:36:21</span
              ><span class="points-container"
                >Points: <span class="points">7</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=37627782"
                  >Comments</a
                ><span class="descendants">: 2</span></span
              >
            </h4>
          </section>
        </section>
        <section id="37627745">
          <h3>
            <a
              class="item"
              href="https://www.neowin.net/news/eu-fines-intel-400-million-for-blocking-amds-market-access-through-payments-to-pc-makers/"
              >EU fines Intel $400M for blocking AMD's market access</a
            >
          </h3>
          <section>
            <h4>
              <span>2023-09-23 @ 21:30:23</span
              ><span class="points-container"
                >Points: <span class="points">28</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=37627745"
                  >Comments</a
                ><span class="descendants">: 5</span></span
              >
            </h4>
          </section>
        </section>
        <section id="37627684">
          <h3>
            <a
              class="item"
              href="https://twitter.com/snowmaker/status/1705643839443403263"
              >Ways YC has changed in the last year</a
            >
          </h3>
          <section>
            <h4>
              <span>2023-09-23 @ 21:24:20</span
              ><span class="points-container"
                >Points: <span class="points">34</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=37627684"
                  >Comments</a
                ><span class="descendants">: 37</span></span
              >
            </h4>
          </section>
        </section>
        <section id="37627615">
          <h3>
            <a class="item" href="https://arxiv.org/abs/2210.01603"
              >Neural-Symbolic Recursive Machine for Systematic
              Generalization</a
            >
          </h3>
          <section>
            <h4>
              <span>2023-09-23 @ 21:14:13</span
              ><span class="points-container"
                >Points: <span class="points">9</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=37627615"
                  >Comments</a
                ><span class="descendants">: 0</span></span
              >
            </h4>
          </section>
        </section>
        <section id="37627514">
          <h3>
            <a
              class="item"
              href="https://jobs.ashbyhq.com/freshpaint/bfe56523-bff4-4ca3-936b-0ba15fb4e572?utm_source=hn"
              >Freshpaint (YC S19) is hiring engineers to enable privacy-first
              marketing</a
            >
          </h3>
          <section>
            <h4>
              <span>2023-09-23 @ 21:00:27</span
              ><span class="points-container"
                >Points: <span class="points">1</span></span
              >
            </h4>
          </section>
        </section>
        <section id="37627292">
          <h3>
            <a
              class="item"
              href="https://www.insideprecisionmedicine.com/topics/oncology/scientists-improve-anti-tumor-power-of-car-t-cells/"
              >Scientists improve anti-tumor power of CAR-T cells</a
            >
          </h3>
          <section>
            <h4>
              <span>2023-09-23 @ 20:37:41</span
              ><span class="points-container"
                >Points: <span class="points">40</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=37627292"
                  >Comments</a
                ><span class="descendants">: 3</span></span
              >
            </h4>
          </section>
        </section>
        <section id="37627129">
          <h3>
            <a class="item" href="https://arxiv.org/abs/2309.12269"
              >The Cambridge Law Corpus: A Corpus for Legal AI Research</a
            >
          </h3>
          <section>
            <h4>
              <span>2023-09-23 @ 20:22:53</span
              ><span class="points-container"
                >Points: <span class="points">44</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=37627129"
                  >Comments</a
                ><span class="descendants">: 6</span></span
              >
            </h4>
          </section>
        </section>
        <section id="37626731">
          <h3>
            <a class="item" href="https://bottlerocket.dev"
              >Bottlerocket – Minimal, immutable Linux OS with verified boot</a
            >
          </h3>
          <section>
            <h4>
              <span>2023-09-23 @ 19:44:56</span
              ><span class="points-container"
                >Points: <span class="points">126</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=37626731"
                  >Comments</a
                ><span class="descendants">: 28</span></span
              >
            </h4>
          </section>
        </section>
        <section id="37626551">
          <h3>
            <a
              class="item"
              href="https://computational-discovery-on-jupyter.github.io/Computational-Discovery-on-Jupyter/"
              >Computational Discovery on Jupyter</a
            >
          </h3>
          <section>
            <h4>
              <span>2023-09-23 @ 19:29:01</span
              ><span class="points-container"
                >Points: <span class="points">32</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=37626551"
                  >Comments</a
                ><span class="descendants">: 0</span></span
              >
            </h4>
          </section>
        </section>
        <section id="37626528">
          <h3>
            <a
              class="item"
              href="https://tldp.org/HOWTO/Aviation-HOWTO/index.html"
              >GNU/Linux Aviation HOWTO (2006)</a
            >
          </h3>
          <section>
            <h4>
              <span>2023-09-23 @ 19:27:18</span
              ><span class="points-container"
                >Points: <span class="points">60</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=37626528"
                  >Comments</a
                ><span class="descendants">: 13</span></span
              >
            </h4>
          </section>
        </section>
        <section id="37626025">
          <h3>
            <a
              class="item"
              href="https://melodicambient.substack.com/p/i-open-sourced-even-the-ocean-2016"
              >I open-sourced Even the Ocean</a
            >
          </h3>
          <section>
            <h4>
              <span>2023-09-23 @ 18:34:27</span
              ><span class="points-container"
                >Points: <span class="points">70</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=37626025"
                  >Comments</a
                ><span class="descendants">: 27</span></span
              >
            </h4>
          </section>
        </section>
        <section id="37625973">
          <h3>
            <a
              class="item"
              href="https://www.nytimes.com/2023/09/22/science/jellyfish-learning-neurons.html"
              >Box jellyfish demonstrate learning ability</a
            >
          </h3>
          <section>
            <h4>
              <span>2023-09-23 @ 18:28:58</span
              ><span class="points-container"
                >Points: <span class="points">42</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=37625973"
                  >Comments</a
                ><span class="descendants">: 19</span></span
              >
            </h4>
          </section>
        </section>
        <section id="37625291">
          <h3>
            <a
              class="item"
              href="https://blog.nationalarchives.gov.uk/20speople-investigating-the-strange-disappearance-of-mrs-agatha-christie/"
              >The strange disappearance of Mrs Agatha Christie (2022)</a
            >
          </h3>
          <section>
            <h4>
              <span>2023-09-23 @ 17:21:56</span
              ><span class="points-container"
                >Points: <span class="points">85</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=37625291"
                  >Comments</a
                ><span class="descendants">: 57</span></span
              >
            </h4>
          </section>
        </section>
        <section id="37625283">
          <h3>
            <a class="item" href="https://www.elim.app/eng/home"
              >Show HN: A “CRM” for personal relationships</a
            >
          </h3>
          <section>
            <h4>
              <span>2023-09-23 @ 17:21:17</span
              ><span class="points-container"
                >Points: <span class="points">49</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=37625283"
                  >Comments</a
                ><span class="descendants">: 34</span></span
              >
            </h4>
            <div class="text">
              <a
                href="https://play.google.com/store/apps/details?id=com.spreadvk.elim"
                >https://play.google.com/store/apps/details?id=com.spreadvk.e...</a
              >
              <p>
                iOS:
                <a
                  href="https://apps.apple.com/us/app/the-new-elim/id6463781107"
                  >https://apps.apple.com/us/app/the-new-elim/id6463781107</a
                >
              </p>
              <p>
                We know life can be busy. And we often struggle to make time for
                the people that matter most to us.
              </p>
              <p>
                According to a Harvard study from 2021, "36% of all Americans
                [...] feel “serious loneliness.”" [1]
              </p>
              <p>
                We created an app to help people focus on their most personal
                relationships and guide them through forming more meaningful
                connections with them, in the hopes to combat the "Loneliness
                Epidemic".
              </p>
              <p>
                We just launched the first iteration - call it an MVP if you
                like - something to validate our ideas and get the conversation
                started.
              </p>
              <p>
                We are looking for people to try out what we have built and
                share their thoughts. The functionality is very basic for now,
                but we are planning to expand based on our users' feedback.
              </p>
              <p>Here is what you can do today:</p>
              <p>* Tell us who the people are that matter most to you</p>
              <p>* Get daily reminders to reach out to them</p>
              <p>
                * Send them virtual postcards with over 50 handcrafted designs
              </p>
              <p>
                [1]
                <a
                  href="https://mcc.gse.harvard.edu/reports/loneliness-in-america"
                  >https://mcc.gse.harvard.edu/reports/loneliness-in-america</a
                >
              </p>
            </div>
          </section>
        </section>
        <section id="37624400">
          <h3>
            <a class="item" href="https://github.com/rdaum/moor"
              >Show HN: I rewrote the 1990's LambdaMOO server</a
            >
          </h3>
          <section>
            <h4>
              <span>2023-09-23 @ 15:56:48</span
              ><span class="points-container"
                >Points: <span class="points">115</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=37624400"
                  >Comments</a
                ><span class="descendants">: 35</span></span
              >
            </h4>
            <div class="text">
              <a href="https://en.wikipedia.org/wiki/LambdaMOO"
                >https://en.wikipedia.org/wiki/LambdaMOO</a
              >) and similar systems. Shared virtual social spaces, with a
              persistent object oriented authoring / scripting language. They
              can be classified as MUDs (depending on who you talk to) but the
              focus is social, creative / authoring, and shared programming not
              RPG gaming.
              <p>
                I've always wanted to see this kind of thing modernized and
                further developed. Over the last 25 years or so I've worked on
                similar but novel &amp; improved things, but never finished.
              </p>
              <p>
                So I decided to just re-implement LambdaMOO and use that as a
                base, instead and keep compatibility as a goal, but build it out
                on a more modern foundation that takes advantage of multiple
                core machines, newer network protocols, newer connectivity
                methods, uses MVCC transactions for the shared database etc.
              </p>
              <p>
                LambdaMOO is a somewhat extensive system in that it is composed
                of compiler, a virtual machine, an object database, user
                permissions system, network runtime. In some ways it's kind of
                like a shared, text-based Smalltalk image/runtime... So quite a
                bit to implement and get right before it all works together.
              </p>
              <p>
                The big challenge throughout has been slavishly maintaining
                backwards compatibility so existing "cores" (databases) work.
              </p>
              <p>
                It's not done, but it's darn close. Would like for people who
                are into this kind of thing to check it out, and maybe even
                help.
              </p>
              <p>
                Many of the technical aspects here are still provisional, but
                this is the start. Constructive assistance welcome.
              </p>
              <p>
                (Yes, it's a rewrite in Rust, but that's not really the point,
                even though that's a cliche that's fun.)
              </p>
            </div>
          </section>
        </section>
        <section id="37624201">
          <h3>
            <a
              class="item"
              href="https://www.economist.com/books-and-arts/2021/07/10/the-vital-art-of-talking-to-strangers"
              >The vital art of talking to strangers (2021)</a
            >
          </h3>
          <section>
            <h4>
              <span>2023-09-23 @ 15:34:59</span
              ><span class="points-container"
                >Points: <span class="points">136</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=37624201"
                  >Comments</a
                ><span class="descendants">: 93</span></span
              >
            </h4>
          </section>
        </section>
        <section id="37623955">
          <h3>
            <a
              class="item"
              href="https://www.404media.co/why-scalpers-can-get-olivia-rodrigo-tickets-and-fans-cannot/"
              >Why scalpers can get tickets</a
            >
          </h3>
          <section>
            <h4>
              <span>2023-09-23 @ 15:10:22</span
              ><span class="points-container"
                >Points: <span class="points">68</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=37623955"
                  >Comments</a
                ><span class="descendants">: 136</span></span
              >
            </h4>
          </section>
        </section>
        <section id="37623405">
          <h3>
            <a
              class="item"
              href="https://efe.com/en/science-and-technology/2023-09-22/india-fails-to-re-establish-communication-with-its-moon-probe/"
              >India fails to re-establish communication with its Moon probe</a
            >
          </h3>
          <section>
            <h4>
              <span>2023-09-23 @ 14:15:33</span
              ><span class="points-container"
                >Points: <span class="points">143</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=37623405"
                  >Comments</a
                ><span class="descendants">: 51</span></span
              >
            </h4>
          </section>
        </section>
        <section id="37623314">
          <h3>
            <a
              class="item"
              href="https://www.genengnews.com/topics/genome-editing/crispr-silkworms-make-spider-silk-that-defies-scientific-constraints/"
              >CRISPR silkworms make spider silk that defies constraints</a
            >
          </h3>
          <section>
            <h4>
              <span>2023-09-23 @ 14:03:29</span
              ><span class="points-container"
                >Points: <span class="points">65</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=37623314"
                  >Comments</a
                ><span class="descendants">: 9</span></span
              >
            </h4>
          </section>
        </section>
        <section id="37623230">
          <h3>
            <a class="item" href="https://www.youtube.com/watch?v=VOaZbaPzdsk"
              >Sesame Street Pinball Number Count [video]</a
            >
          </h3>
          <section>
            <h4>
              <span>2023-09-23 @ 13:54:38</span
              ><span class="points-container"
                >Points: <span class="points">58</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=37623230"
                  >Comments</a
                ><span class="descendants">: 53</span></span
              >
            </h4>
          </section>
        </section>
        <section id="37622997">
          <h3>
            <a class="item" href="https://codeberg.org/dnkl/foot"
              >Foot – A fast, lightweight and minimalistic Wayland terminal
              emulator</a
            >
          </h3>
          <section>
            <h4>
              <span>2023-09-23 @ 13:20:41</span
              ><span class="points-container"
                >Points: <span class="points">135</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=37622997"
                  >Comments</a
                ><span class="descendants">: 75</span></span
              >
            </h4>
          </section>
        </section>
        <section id="37622714">
          <h3>
            <a
              class="item"
              href="https://buttondown.email/hillelwayne/archive/in-defense-of/"
              >Collecting and curating material is good and we should do it
              more</a
            >
          </h3>
          <section>
            <h4>
              <span>2023-09-23 @ 12:34:59</span
              ><span class="points-container"
                >Points: <span class="points">101</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=37622714"
                  >Comments</a
                ><span class="descendants">: 22</span></span
              >
            </h4>
          </section>
        </section>
        <section id="37622702">
          <h3>
            <a
              class="item"
              href="https://news.tonydinh.com/p/my-solopreneur-story-zero-to-45kmo"
              >My solopreneur story</a
            >
          </h3>
          <section>
            <h4>
              <span>2023-09-23 @ 12:32:36</span
              ><span class="points-container"
                >Points: <span class="points">660</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=37622702"
                  >Comments</a
                ><span class="descendants">: 398</span></span
              >
            </h4>
          </section>
        </section>
        <section id="37622632">
          <h3>
            <a class="item" href="https://arxiv.org/abs/0911.2899"
              >Coding Guidelines for Prolog (2011)</a
            >
          </h3>
          <section>
            <h4>
              <span>2023-09-23 @ 12:20:42</span
              ><span class="points-container"
                >Points: <span class="points">101</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=37622632"
                  >Comments</a
                ><span class="descendants">: 12</span></span
              >
            </h4>
          </section>
        </section>
        <section id="37620367">
          <h3>
            <a
              class="item"
              href="https://www.nytimes.com/2023/09/22/nyregion/lou-reed-king-of-new-york.html"
              >The year Lou Reed gave up on music</a
            >
          </h3>
          <section>
            <h4>
              <span>2023-09-23 @ 03:27:56</span
              ><span class="points-container"
                >Points: <span class="points">41</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=37620367"
                  >Comments</a
                ><span class="descendants">: 70</span></span
              >
            </h4>
          </section>
        </section>
        <section id="37619912">
          <h3>
            <a
              class="item"
              href="https://phys.org/news/2023-09-deep-genetic-africa-reveals-unique.html"
              >Deep genetic structure of Africa reveals unique ancestry of the
              Angolan Namib</a
            >
          </h3>
          <section>
            <h4>
              <span>2023-09-23 @ 01:42:38</span
              ><span class="points-container"
                >Points: <span class="points">56</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=37619912"
                  >Comments</a
                ><span class="descendants">: 6</span></span
              >
            </h4>
          </section>
        </section>
        <section id="37613264">
          <h3>
            <a class="item" href="https://quasilyte.dev/blog/post/gen-map/"
              >Generations-based map vs. sparse map</a
            >
          </h3>
          <section>
            <h4>
              <span>2023-09-22 @ 15:24:18</span
              ><span class="points-container"
                >Points: <span class="points">10</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=37613264"
                  >Comments</a
                ><span class="descendants">: 1</span></span
              >
            </h4>
          </section>
        </section>
        <section id="37612913">
          <h3>
            <a
              class="item"
              href="https://www.neuralmechanisms.org/videolectures.html"
              >A beginner's guide to neural mechanisms</a
            >
          </h3>
          <section>
            <h4>
              <span>2023-09-22 @ 14:58:44</span
              ><span class="points-container"
                >Points: <span class="points">46</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=37612913"
                  >Comments</a
                ><span class="descendants">: 2</span></span
              >
            </h4>
          </section>
        </section>
        <section id="37612525">
          <h3>
            <a
              class="item"
              href="https://tobiasahlin.com/blog/responsive-fluid-css-type-scales/"
              >Responsive type scales with composable CSS utilities</a
            >
          </h3>
          <section>
            <h4>
              <span>2023-09-22 @ 14:28:20</span
              ><span class="points-container"
                >Points: <span class="points">20</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=37612525"
                  >Comments</a
                ><span class="descendants">: 1</span></span
              >
            </h4>
          </section>
        </section>
        <section id="37606296">
          <h3>
            <a
              class="item"
              href="https://phys.org/news/2023-09-jewel-forest-electric-blue-tarantula.html"
              >New tarantula species discovered in Thailand</a
            >
          </h3>
          <section>
            <h4>
              <span>2023-09-22 @ 00:22:05</span
              ><span class="points-container"
                >Points: <span class="points">164</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=37606296"
                  >Comments</a
                ><span class="descendants">: 50</span></span
              >
            </h4>
          </section>
        </section>
      </section>
      <section id="archives">
        <h2>
          <a
            href="https://github.com/kherrick/hacker-news/blob/main/archives/index.md"
            >Archives</a
          >
        </h2>
        <section>
          <h3>
            <a
              href="https://github.com/kherrick/hacker-news/blob/main/archives/2023/index.md"
              >2023</a
            >
          </h3>
        </section>
        <section>
          <h3>
            <a
              href="https://github.com/kherrick/hacker-news/blob/main/archives/2022/index.md"
              >2022</a
            >
          </h3>
        </section>
      </section>
    </main>
    <script type="module">
      import { buildDescendants } from "./lib/build-html-descendants.js";
      import { buildNextItem } from "./lib/build-html-next-item.js";
      import { getNextDateTime } from "./lib/date-time.js";

      const updateSectionById = (id) =>
        fetch(`https://hacker-news.firebaseio.com/v0/item/${id}.json`).then(
          (result) =>
            result.json().then(({ descendants, id, score, text, type }) => {
              const currentItem = document.getElementById(id);

              if (score) {
                currentItem.querySelector(".points").textContent = score;
              }

              if (descendants && (type === "poll" || type === "story")) {
                const currentDescendants =
                  currentItem.querySelector(".descendants");

                if (currentDescendants) {
                  currentDescendants.textContent = `: ${descendants}`;
                } else {
                  const comments = buildDescendants(
                    document,
                    descendants,
                    `https://news.ycombinator.com/item?id=${id}`
                  );

                  currentItem.querySelector("h4").appendChild(comments);
                }
              }

              if (text) {
                const currentText = currentItem.querySelector(".text");

                if (currentText) {
                  currentText.innerHTML = text.replace(/\0/g, "");
                } else {
                  const content = document.createElement("div");
                  content.innerHTML = text.replace(/\0/g, "");
                  content.setAttribute("class", "text");

                  currentItem.appendChild(content);
                }
              }
            })
        );

      class UpdateQueue {
        constructor() {
          this._ids = [];
          this._isUpdating = false;
        }

        addItemById(id) {
          this._ids.push(id);
        }

        async flush() {
          const id = this._ids.shift();

          if (id) {
            this._isUpdating = true;

            await updateSectionById(id);
            await this.flush();
          } else {
            this._isUpdating = false;

            setTimeout(async () => {
              if (!this._isUpdating && this._ids && this._ids.length) {
                await this.flush();
              }
            }, 0);
          }
        }
      }

      // get latest data
      const latestSection = document.getElementById("latest");

      for (let item of latestSection.querySelectorAll("section[id]")) {
        updateSectionById(item.getAttribute("id"));
      }

      if ("IntersectionObserver" in window) {
        window.hackerNewsState = { index: [], nextTimeIndex: -1 };

        const addNewsItem = async (newsItem, queue) => {
          try {
            const { date, time, itemComments, itemTitle, itemLink } = newsItem;
            const section = await buildNextItem({
              document,
              dateTime: `${date}, ${time}`,
              itemComments,
              itemLink,
              itemTitle: new DOMParser().parseFromString(
                itemTitle.replace(/\\/g, ""),
                "text/html"
              ).documentElement.textContent,
              fetchItemDetails: false,
            });

            // display loading indicator for section
            section.querySelector(".points-container").innerHTML =
              'Points: <span class="points"><img style="height: 100%;" src="lib/images/loading.svg" /></span>';

            const id = section.getAttribute("id");
            if (!document.getElementById(id)) {
              document.getElementById("latest").appendChild(section);

              queue.addItemById(id);
            }
          } catch (error) {}
        };

        const buildArchiveIndex = async (lastDateTime) => {
          const nextDate = lastDateTime.slice(0, 10);
          const nextYear = nextDate.slice(0, 4);

          return (
            await (
              await fetch(
                `https://raw.githubusercontent.com/kherrick/hacker-news/main/archives/${nextYear}/${nextDate}/index.md`
              )
            ).text()
          )
            .split("\n")
            .filter((line) => line.match(new RegExp("^\\* \\[")))
            .map((line) => {
              const segment = line.replace("* ", "").split("](");
              const pubDate = segment[0].slice(1);

              const itemComments = segment[1].split(") - [")[0];
              const itemTitle = segment[1].split(") - [")[1];
              const itemLink = segment[2].slice(0, -1);
              const date = pubDate.slice(0, 10);
              const time = pubDate.slice(-8);

              return {
                date,
                itemComments,
                itemLink,
                itemTitle,
                time,
              };
            });
        };

        const handleIntersectingEntry = async (entry, queue) => {
          if (entry.isIntersecting) {
            const lastDateTime = document
              .getElementById("latest")
              .querySelector(
                "section:last-child > section > h4 > span"
              ).textContent;

            const nextDateTime = getNextDateTime(lastDateTime ?? "", -1);
            const archiveIndex = await buildArchiveIndex(nextDateTime);
            const nextTimeIndex = archiveIndex.findIndex(
              ({ time }) => time === nextDateTime.slice(-8)
            );

            const handleIndexUpdate = (index, existingIndexValues = []) => {
              index.forEach((i) => {
                existingIndexValues.push(i);
              });
              return existingIndexValues;
            };

            window.hackerNewsState = {
              index: handleIndexUpdate(
                archiveIndex,
                window.hackerNewsState.index
              ),
              nextTimeIndex,
            };

            let currentTimeIndex = nextTimeIndex + 1;
            const items = Object.values(window.hackerNewsState.index);
            for (let item of items) {
              if (currentTimeIndex < window.hackerNewsState.index.length) {
                addNewsItem(items[currentTimeIndex], queue);

                currentTimeIndex = currentTimeIndex + 1;
              }
            }

            queue.flush();
          }
        };

        const archives = document.getElementById("archives");
        const archivesObserver = new IntersectionObserver(
          (entries) => {
            const queue = new UpdateQueue();

            entries.forEach((entry) => handleIntersectingEntry(entry, queue));
          },
          {
            root: null,
            rootMargin: "0px",
            threshold: 0,
          }
        );

        archivesObserver.observe(archives);

        let latestSectionsExpanded = true;
        const handleLatestHeaderClick = () => {
          latestSectionsExpanded = !latestSectionsExpanded;

          if (latestSectionsExpanded) {
            archivesObserver.observe(archives);
          } else {
            archivesObserver.disconnect(archives);
          }

          for (let section of document.querySelectorAll("#latest > section")) {
            section.style.display = latestSectionsExpanded ? "block" : "none";
          }
        };

        const latestHeader = document.querySelector("#latest > h2");
        latestHeader.style.cursor = "pointer";
        latestHeader.addEventListener("click", handleLatestHeaderClick);
      }
    </script>
    <script type="module">
      import { Workbox } from "https://storage.googleapis.com/workbox-cdn/releases/6.4.1/workbox-window.prod.mjs";

      if ("serviceWorker" in navigator) {
        const base = document.querySelector("base");
        const serviceWorkerPath = `${
          base ? base.href.replace(/\/$/, "") : ""
        }/service-worker.js`;

        const wb = new Workbox(serviceWorkerPath);

        // setup event listeners
        wb.addEventListener("waiting", (event) => {
          wb.addEventListener("controlling", () => {
            window.location.reload();
          });

          wb.messageSkipWaiting();
        });

        wb.register();
      }
    </script>
  </body>
</html>
