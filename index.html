<!DOCTYPE html>
<html lang="en" xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta charset="utf-8" />
    <meta
      content="width=device-width, initial-scale=1.0, viewport-fit=cover"
      name="viewport"
    />
    <meta name="description" content="Hacker News" />
    <meta name="theme-color" content="#fff" />
    <title>Hacker News</title>
    <link rel="manifest" href="manifest.json" />
    <link
      href="data:image/x-icon;base64,AAABAAEAAQECAAEAAQA4AAAAFgAAACgAAAABAAAAAgAAAAEAAQAAAAAAAAAAAAAAAAAAAAAAAAAAAAABAAEAAQECAAEAAQA4AAAAFgAAACgAAAABAAAAAgAAAAEAAQAAAAAAAAAAAAAAAAAAAAAAAAAA"
      rel="icon"
      type="image/x-icon"
    />
    <link
      href="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAgAAAAIAAQMAAADOtka5AAAAA1BMVEUAAACnej3aAAAANklEQVR42u3BAQEAAACCIP+vbkhAAQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAB8G4IAAAFjdVCkAAAAAElFTkSuQmCC"
      rel="apple-touch-icon"
    />
    <style>
      /*<!--*/
      body {
        color: rgb(25, 25, 25);
        font-family: Verdana, Geneva, sans-serif;
        margin: 0;
      }

      a {
        text-decoration: none;
      }

      a:link,
      a:focus,
      a:hover,
      a:active {
        color: rgb(75, 75, 125);
      }

      a:visited {
        color: rgb(25, 25, 25);
      }

      h1 > a,
      h1 > a:link,
      h1 > a:focus,
      h1 > a:hover,
      h1 > a:active,
      h1 > a:visited,
      h2 > a,
      h2 > a:link,
      h2 > a:focus,
      h2 > a:hover,
      h2 > a:active,
      h2 > a:visited {
        color: rgb(25, 25, 25);
      }

      h1 {
        background-color: rgb(255, 102, 0);
        margin: 0;
        padding: 1rem;
      }

      h2 {
        background-color: rgb(200, 200, 200);
        margin: 1rem 0;
        padding: 0.5rem 0.5rem 0.5rem 1rem;
      }

      #latest > section,
      #archives > section {
        margin: 0 1rem 1rem 1rem;
        padding-bottom: 1rem;
      }

      #latest > section:not(:last-child),
      #archives > section:not(:last-child) {
        border-bottom: 1px dotted rgb(200, 200, 200);
      }

      section > h3 {
        margin: 0 0 0.5rem 0;
      }

      section > h4 {
        font-weight: normal;
        margin: 0 0 0 1rem;
      }

      .descendants-container,
      .points-container {
        align-items: center;
        border-left: 1px solid #333;
        display: inline-flex;
        margin-left: 0.5rem;
        padding-left: 0.5rem;
        text-align: center;
      }

      .points {
        align-items: center;
        display: inline-flex;
        height: 1rem;
        margin-left: 1ch;
        min-width: 3ch;
      }

      .text {
        line-height: 1.5rem;
        margin: 1rem 1rem 0 1rem;
        overflow: auto;
      }

      .text > p:first-child {
        margin-top: 1rem;
      }

      .text > p:last-child {
        margin-bottom: 0;
      }
      /*-->*/
    </style>
  </head>

  <body>
    <main>
      <h1><a href="https://kherrick.github.io/hacker-news/">Hacker News</a></h1>
      <section id="latest">
        <h2>Latest</h2>
        <section id="43802727">
          <h3>
            <a
              class="item"
              href="https://www.happiness.hks.harvard.edu/february-2025-issue/the-friendship-recession-the-lost-art-of-connecting"
              >The Friendship Recession: The Lost Art of Connecting</a
            >
          </h3>
          <section>
            <h4>
              <span>2025-04-26 @ 11:41:21</span
              ><span class="points-container"
                >Points: <span class="points">74</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=43802727"
                  >Comments</a
                ><span class="descendants">: 20</span></span
              >
            </h4>
          </section>
        </section>
        <section id="43802675">
          <h3>
            <a class="item" href="https://www.morpheus-research.com/backblaze/"
              >Backblaze: Mounting Losses, Lawsuits, Sham Accounting, Insider
              Selling</a
            >
          </h3>
          <section>
            <h4>
              <span>2025-04-26 @ 11:30:20</span
              ><span class="points-container"
                >Points: <span class="points">42</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=43802675"
                  >Comments</a
                ><span class="descendants">: 4</span></span
              >
            </h4>
          </section>
        </section>
        <section id="43802574">
          <h3>
            <a
              class="item"
              href="https://arstechnica.com/gadgets/2025/04/google-ending-support-for-older-nest-thermostats-will-stop-selling-nests-in-europe/"
              >First and 2nd gen Nest Thermostats will lose support in Oct
              2025</a
            >
          </h3>
          <section>
            <h4>
              <span>2025-04-26 @ 11:07:01</span
              ><span class="points-container"
                >Points: <span class="points">21</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=43802574"
                  >Comments</a
                ><span class="descendants">: 2</span></span
              >
            </h4>
          </section>
        </section>
        <section id="43802497">
          <h3>
            <a
              class="item"
              href="https://pluralistic.net/2025/04/18/chatty-zucky/"
              >Mark Zuckerberg personally lost the Facebook antitrust case</a
            >
          </h3>
          <section>
            <h4>
              <span>2025-04-26 @ 10:53:03</span
              ><span class="points-container"
                >Points: <span class="points">152</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=43802497"
                  >Comments</a
                ><span class="descendants">: 35</span></span
              >
            </h4>
          </section>
        </section>
        <section id="43802463">
          <h3>
            <a class="item" href="https://www.commodoreos.net/CommodoreOS.aspx"
              >Commodore OS 3.0 Released</a
            >
          </h3>
          <section>
            <h4>
              <span>2025-04-26 @ 10:46:02</span
              ><span class="points-container"
                >Points: <span class="points">21</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=43802463"
                  >Comments</a
                ><span class="descendants">: 0</span></span
              >
            </h4>
          </section>
        </section>
        <section id="43802063">
          <h3>
            <a
              class="item"
              href="https://arstechnica.com/tech-policy/2025/04/mypillow-ceos-lawyers-used-ai-in-brief-citing-fictional-cases-judge-says/"
              >Mike Lindell's lawyers used AI to write brief–judge finds nearly
              30 mistakes</a
            >
          </h3>
          <section>
            <h4>
              <span>2025-04-26 @ 09:14:27</span
              ><span class="points-container"
                >Points: <span class="points">60</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=43802063"
                  >Comments</a
                ><span class="descendants">: 30</span></span
              >
            </h4>
          </section>
        </section>
        <section id="43801906">
          <h3>
            <a class="item" href="https://yarchive.net/blog/prostate/"
              >An end to all this prostate trouble?</a
            >
          </h3>
          <section>
            <h4>
              <span>2025-04-26 @ 08:39:29</span
              ><span class="points-container"
                >Points: <span class="points">120</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=43801906"
                  >Comments</a
                ><span class="descendants">: 53</span></span
              >
            </h4>
          </section>
        </section>
        <section id="43801500">
          <h3>
            <a
              class="item"
              href="https://www.ycombinator.com/companies/mobileboost/jobs/v6gPgiZ-founding-backend-platform-engineer-remote"
              >MobileBoost (YC S21) Is Hiring a Founding Back End/Platform
              Engineer (Remote)</a
            >
          </h3>
          <section>
            <h4>
              <span>2025-04-26 @ 07:00:38</span
              ><span class="points-container"
                >Points: <span class="points">1</span></span
              >
            </h4>
          </section>
        </section>
        <section id="43801461">
          <h3>
            <a
              class="item"
              href="https://mastodon.online/@mastodonmigration/114399534536933573"
              >Apparently Bluesky has one centralized service, the "relay"</a
            >
          </h3>
          <section>
            <h4>
              <span>2025-04-26 @ 06:50:37</span
              ><span class="points-container"
                >Points: <span class="points">71</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=43801461"
                  >Comments</a
                ><span class="descendants">: 41</span></span
              >
            </h4>
          </section>
        </section>
        <section id="43801179">
          <h3>
            <a class="item" href="https://www.cloudofoz.com/verlet-test/"
              >Cloth</a
            >
          </h3>
          <section>
            <h4>
              <span>2025-04-26 @ 05:31:52</span
              ><span class="points-container"
                >Points: <span class="points">256</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=43801179"
                  >Comments</a
                ><span class="descendants">: 27</span></span
              >
            </h4>
          </section>
        </section>
        <section id="43800988">
          <h3>
            <a
              class="item"
              href="https://mainichi.jp/english/articles/20250425/p2g/00m/0bu/047000c"
              >Amazon Japan ordered to pay 35M. yen for allowing listing of
              fakes</a
            >
          </h3>
          <section>
            <h4>
              <span>2025-04-26 @ 04:39:02</span
              ><span class="points-container"
                >Points: <span class="points">109</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=43800988"
                  >Comments</a
                ><span class="descendants">: 20</span></span
              >
            </h4>
          </section>
        </section>
        <section id="43800574">
          <h3>
            <a
              class="item"
              href="https://github.com/waszabi/empty-enter-expander"
              >Show HN: Empty Enter Expander – Type less in the terminal with
              this tool</a
            >
          </h3>
          <section>
            <h4>
              <span>2025-04-26 @ 03:09:47</span
              ><span class="points-container"
                >Points: <span class="points">38</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=43800574"
                  >Comments</a
                ><span class="descendants">: 16</span></span
              >
            </h4>
            <div class="text">
              <p>
                I needed something lightweight to always show me the available
                commands. Something to run with a few keystrokes. Something that
                stores commands in files and folder structures.
              </p>
              <p>
                The idea was born at the time of using Linux Debian with the dwm
                (dynamic window manager). The first version was implemented in
                bash and it could do three things: start an application, expand
                text from a template and do a predefined automation on the
                selected application.
              </p>
              <p>
                It was launched by a keyboard shortcut and opened the list of
                commands in a new terminal window. The commands were stored in
                nested folders and it was able to switch between the three modes
                (launcher, expander, automator). It also required only few
                keystrokes to do the desired action.
              </p>
              <p>
                For instance, I was in the terminal and hit Ctrl+P. It opened a
                new terminal and listed applications to launch. I hit the Space
                to switch to the expander mode. Then I hit the g to enter the
                Git folder and s for the status. The result was that it put the
                git status to the terminal I was in before. This expander could
                be used in any application. It could insert the email template
                into the browser.
              </p>
              <p>
                Then I migrated to macOS and really missed that tool. So I
                quickly wrote a zsh vesrion that consists only the expander mode
                and supports only the terminal. It is activated by hitting Enter
                on empty command and then it inserts the desired command right
                into the prompt. For example, when you hit Enter, g and s you
                will get the git status command to the prompt and you can then
                execute it with Enter. Of course, those commands and keys are
                defined by you. There are various and lenghty commands that I
                use on a daily basis like this and it saves a lot of typing.
              </p>
              <p>
                The tool is called Empty Enter Expander. It is implemented for
                the zsh as of now. Please check it out at
                <a href="https://github.com/waszabi/empty-enter-expander"
                  >https://github.com/waszabi/empty-enter-expander</a
                >
                and let me know what you like or dislike about it.
              </p>
            </div>
          </section>
        </section>
        <section id="43800222">
          <h3>
            <a class="item" href="https://github.com/wh0am1-dev/adventure"
              >Colossal Cave Adventure (1976)</a
            >
          </h3>
          <section>
            <h4>
              <span>2025-04-26 @ 01:52:32</span
              ><span class="points-container"
                >Points: <span class="points">40</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=43800222"
                  >Comments</a
                ><span class="descendants">: 17</span></span
              >
            </h4>
          </section>
        </section>
        <section id="43800151">
          <h3>
            <a class="item" href="https://mobygratis.com/"
              >Mobygratis – Free Moby music to empower your creative projects</a
            >
          </h3>
          <section>
            <h4>
              <span>2025-04-26 @ 01:38:54</span
              ><span class="points-container"
                >Points: <span class="points">47</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=43800151"
                  >Comments</a
                ><span class="descendants">: 12</span></span
              >
            </h4>
          </section>
        </section>
        <section id="43800002">
          <h3>
            <a class="item" href="https://lite.berkeley-humanoid.org/"
              >Berkeley Humanoid Lite – Open-source robot</a
            >
          </h3>
          <section>
            <h4>
              <span>2025-04-26 @ 01:03:40</span
              ><span class="points-container"
                >Points: <span class="points">168</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=43800002"
                  >Comments</a
                ><span class="descendants">: 16</span></span
              >
            </h4>
          </section>
        </section>
        <section id="43799820">
          <h3>
            <a
              class="item"
              href="https://samj.substack.com/p/that-joke-isnt-funny-any-more"
              >I wrote a book called "Crap Towns". It seemed funny at the
              time</a
            >
          </h3>
          <section>
            <h4>
              <span>2025-04-26 @ 00:30:41</span
              ><span class="points-container"
                >Points: <span class="points">283</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=43799820"
                  >Comments</a
                ><span class="descendants">: 202</span></span
              >
            </h4>
          </section>
        </section>
        <section id="43799396">
          <h3>
            <a class="item" href="https://tavianator.com/2025/configure.html"
              >Parallel ./configure</a
            >
          </h3>
          <section>
            <h4>
              <span>2025-04-25 @ 23:19:56</span
              ><span class="points-container"
                >Points: <span class="points">133</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=43799396"
                  >Comments</a
                ><span class="descendants">: 111</span></span
              >
            </h4>
          </section>
        </section>
        <section id="43799302">
          <h3>
            <a
              class="item"
              href="https://www.washingtonpost.com/technology/2025/04/25/wikipedia-nonprofit-ed-martin-letter/"
              >Wikipedia’s nonprofit status questioned by D.C. U.S. attorney</a
            >
          </h3>
          <section>
            <h4>
              <span>2025-04-25 @ 23:03:55</span
              ><span class="points-container"
                >Points: <span class="points">637</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=43799302"
                  >Comments</a
                ><span class="descendants">: 533</span></span
              >
            </h4>
          </section>
        </section>
        <section id="43798832">
          <h3>
            <a
              class="item"
              href="https://docs.tscircuit.com/tutorials/building-led-matrix"
              >I designed my LED matrix PCB with code</a
            >
          </h3>
          <section>
            <h4>
              <span>2025-04-25 @ 21:43:33</span
              ><span class="points-container"
                >Points: <span class="points">92</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=43798832"
                  >Comments</a
                ><span class="descendants">: 40</span></span
              >
            </h4>
          </section>
        </section>
        <section id="43798757">
          <h3>
            <a
              class="item"
              href="https://madebyoll.in/posts/world_emulation_via_dnn/"
              >World Emulation via Neural Network</a
            >
          </h3>
          <section>
            <h4>
              <span>2025-04-25 @ 21:33:57</span
              ><span class="points-container"
                >Points: <span class="points">194</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=43798757"
                  >Comments</a
                ><span class="descendants">: 35</span></span
              >
            </h4>
          </section>
        </section>
        <section id="43797256">
          <h3>
            <a class="item" href="https://github.com/ndrwnaguib/principia"
              >Show HN: Formalizing Principia Mathematica using Lean</a
            >
          </h3>
          <section>
            <h4>
              <span>2025-04-25 @ 18:49:30</span
              ><span class="points-container"
                >Points: <span class="points">149</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=43797256"
                  >Comments</a
                ><span class="descendants">: 29</span></span
              >
            </h4>
            <div class="text">
              <p>
                <a href="https://ndrwnaguib.com/principia/"
                  >https://ndrwnaguib.com/principia/</a
                >
              </p>
              <p>
                <a href="https://github.com/ndrwnaguib/principia"
                  >https://github.com/ndrwnaguib/principia</a
                >
              </p>
            </div>
          </section>
        </section>
        <section id="43797212">
          <h3>
            <a class="item" href="https://curry-lang.org/"
              >Curry: A functional logic programming language</a
            >
          </h3>
          <section>
            <h4>
              <span>2025-04-25 @ 18:46:22</span
              ><span class="points-container"
                >Points: <span class="points">147</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=43797212"
                  >Comments</a
                ><span class="descendants">: 32</span></span
              >
            </h4>
          </section>
        </section>
        <section id="43796935">
          <h3>
            <a class="item" href="https://arxiv.org/abs/2504.11651"
              >Lossless LLM compression for efficient GPU inference via
              dynamic-length float</a
            >
          </h3>
          <section>
            <h4>
              <span>2025-04-25 @ 18:20:53</span
              ><span class="points-container"
                >Points: <span class="points">360</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=43796935"
                  >Comments</a
                ><span class="descendants">: 108</span></span
              >
            </h4>
          </section>
        </section>
        <section id="43796003">
          <h3>
            <a class="item" href="https://github.com/magnitudedev/magnitude"
              >Show HN: Magnitude – open-source, AI-native test framework for
              web apps</a
            >
          </h3>
          <section>
            <h4>
              <span>2025-04-25 @ 17:00:35</span
              ><span class="points-container"
                >Points: <span class="points">160</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=43796003"
                  >Comments</a
                ><span class="descendants">: 39</span></span
              >
            </h4>
            <div class="text">
              <p>
                We know there's a lot of noise about different browser agents.
                If you've tried any of them, you know they're slow, expensive,
                and inconsistent. That's why we built an agent specifically for
                running test cases and optimized it just for that:
              </p>
              <p>
                - Pure vision instead of error prone "set-of-marks" system (the
                colorful boxes you see in browser-use for example)
              </p>
              <p>
                - Use tiny VLM (Moondream) instead of OpenAI/Anthropic computer
                use for dramatically faster and cheaper execution
              </p>
              <p>
                - Use two agents: one for planning and adapting test cases and
                one for executing them quickly and consistently.
              </p>
              <p>
                The idea is the planner builds up a general plan which the
                executor runs. We can save this plan and re-run it with only the
                executor for quick, cheap, and consistent runs. When something
                goes wrong, it can kick back out to the planner agent and
                re-adjust the test.
              </p>
              <p>
                It’s completely open source. Would love to have more people try
                it out and tell us how we can make it great.
              </p>
              <p>
                Repo:
                <a href="https://github.com/magnitudedev/magnitude"
                  >https://github.com/magnitudedev/magnitude</a
                >
              </p>
            </div>
          </section>
        </section>
        <section id="43795300">
          <h3>
            <a
              class="item"
              href="https://www.nature.com/articles/d41586-025-01266-x"
              >Reproducibility project fails to validate dozens of biomedical
              studies</a
            >
          </h3>
          <section>
            <h4>
              <span>2025-04-25 @ 16:14:08</span
              ><span class="points-container"
                >Points: <span class="points">208</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=43795300"
                  >Comments</a
                ><span class="descendants">: 97</span></span
              >
            </h4>
          </section>
        </section>
        <section id="43794284">
          <h3>
            <a
              class="item"
              href="https://www.theverge.com/electric-cars/655527/slate-electric-truck-price-paint-radio-bezos"
              >A $20k American-made electric pickup with no paint, no stereo, no
              screen</a
            >
          </h3>
          <section>
            <h4>
              <span>2025-04-25 @ 15:01:37</span
              ><span class="points-container"
                >Points: <span class="points">1229</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=43794284"
                  >Comments</a
                ><span class="descendants">: 1074</span></span
              >
            </h4>
          </section>
        </section>
        <section id="43793526">
          <h3>
            <a
              class="item"
              href="https://scalewithlee.substack.com/p/when-etchsts-breaks-your-substack"
              >Writing "/etc/hosts" breaks the Substack editor</a
            >
          </h3>
          <section>
            <h4>
              <span>2025-04-25 @ 13:48:30</span
              ><span class="points-container"
                >Points: <span class="points">573</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=43793526"
                  >Comments</a
                ><span class="descendants">: 310</span></span
              >
            </h4>
          </section>
        </section>
        <section id="43793288">
          <h3>
            <a class="item" href="https://mitxela.com/projects/euroknob"
              >Eurorack Knob Idea</a
            >
          </h3>
          <section>
            <h4>
              <span>2025-04-25 @ 13:19:02</span
              ><span class="points-container"
                >Points: <span class="points">289</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=43793288"
                  >Comments</a
                ><span class="descendants">: 106</span></span
              >
            </h4>
          </section>
        </section>
        <section id="43792248">
          <h3>
            <a class="item" href="https://gcc.gnu.org/gcc-15/">GCC 15.1</a>
          </h3>
          <section>
            <h4>
              <span>2025-04-25 @ 10:53:59</span
              ><span class="points-container"
                >Points: <span class="points">257</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=43792248"
                  >Comments</a
                ><span class="descendants">: 134</span></span
              >
            </h4>
          </section>
        </section>
        <section id="43791474">
          <h3>
            <a
              class="item"
              href="https://addyo.substack.com/p/avoiding-skill-atrophy-in-the-age"
              >Avoiding skill atrophy in the age of AI</a
            >
          </h3>
          <section>
            <h4>
              <span>2025-04-25 @ 08:30:54</span
              ><span class="points-container"
                >Points: <span class="points">238</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=43791474"
                  >Comments</a
                ><span class="descendants">: 255</span></span
              >
            </h4>
          </section>
        </section>
      </section>
      <section id="archives">
        <h2>
          <a
            href="https://github.com/kherrick/hacker-news/blob/main/archives/index.md"
            >Archives</a
          >
        </h2>
        <section>
          <h3>
            <a
              href="https://github.com/kherrick/hacker-news/blob/main/archives/2025/index.md"
              >2025</a
            >
          </h3>
        </section>
        <section>
          <h3>
            <a
              href="https://github.com/kherrick/hacker-news/blob/main/archives/2024/index.md"
              >2024</a
            >
          </h3>
        </section>
        <section>
          <h3>
            <a
              href="https://github.com/kherrick/hacker-news/blob/main/archives/2023/index.md"
              >2023</a
            >
          </h3>
        </section>
        <section>
          <h3>
            <a
              href="https://github.com/kherrick/hacker-news/blob/main/archives/2022/index.md"
              >2022</a
            >
          </h3>
        </section>
      </section>
    </main>
    <script type="module">
      import { buildDescendants } from "./lib/build-html-descendants.js";
      import { buildNextItem } from "./lib/build-html-next-item.js";
      import { getNextDateTime } from "./lib/date-time.js";

      const updateSectionById = (id) =>
        fetch(`https://hacker-news.firebaseio.com/v0/item/${id}.json`).then(
          (result) =>
            result.json().then(({ descendants, id, score, text, type }) => {
              const currentItem = document.getElementById(id);

              if (score) {
                currentItem.querySelector(".points").textContent = score;
              }

              if (descendants && (type === "poll" || type === "story")) {
                const currentDescendants =
                  currentItem.querySelector(".descendants");

                if (currentDescendants) {
                  currentDescendants.textContent = `: ${descendants}`;
                } else {
                  const comments = buildDescendants(
                    document,
                    descendants,
                    `https://news.ycombinator.com/item?id=${id}`
                  );

                  currentItem.querySelector("h4").appendChild(comments);
                }
              }

              if (text) {
                const currentText = currentItem.querySelector(".text");

                if (currentText) {
                  currentText.innerHTML = text.replace(/\0/g, "");
                } else {
                  const content = document.createElement("div");
                  content.innerHTML = text.replace(/\0/g, "");
                  content.setAttribute("class", "text");

                  currentItem.appendChild(content);
                }
              }
            })
        );

      class UpdateQueue {
        constructor() {
          this._ids = [];
          this._isUpdating = false;
        }

        addItemById(id) {
          this._ids.push(id);
        }

        async flush() {
          const id = this._ids.shift();

          if (id) {
            this._isUpdating = true;

            await updateSectionById(id);
            await this.flush();
          } else {
            this._isUpdating = false;

            setTimeout(async () => {
              if (!this._isUpdating && this._ids && this._ids.length) {
                await this.flush();
              }
            }, 0);
          }
        }
      }

      // get latest data
      const latestSection = document.getElementById("latest");

      for (let item of latestSection.querySelectorAll("section[id]")) {
        updateSectionById(item.getAttribute("id"));
      }

      if ("IntersectionObserver" in window) {
        window.hackerNewsState = { index: [], nextTimeIndex: -1 };

        const addNewsItem = async (newsItem, queue) => {
          try {
            const { date, time, itemComments, itemTitle, itemLink } = newsItem;
            const section = await buildNextItem({
              document,
              dateTime: `${date}, ${time}`,
              itemComments,
              itemLink,
              itemTitle: new DOMParser().parseFromString(
                itemTitle.replace(/\\/g, ""),
                "text/html"
              ).documentElement.textContent,
              fetchItemDetails: false,
            });

            // display loading indicator for section
            section.querySelector(".points-container").innerHTML =
              'Points: <span class="points"><img style="height: 100%;" src="lib/images/loading.svg" /></span>';

            const id = section.getAttribute("id");
            if (!document.getElementById(id)) {
              document.getElementById("latest").appendChild(section);

              queue.addItemById(id);
            }
          } catch (error) {}
        };

        const buildArchiveIndex = async (lastDateTime) => {
          const nextDate = lastDateTime.slice(0, 10);
          const nextYear = nextDate.slice(0, 4);

          return (
            await (
              await fetch(
                `https://raw.githubusercontent.com/kherrick/hacker-news/main/archives/${nextYear}/${nextDate}/index.md`
              )
            ).text()
          )
            .split("\n")
            .filter((line) => line.match(new RegExp("^\\* \\[")))
            .map((line) => {
              const segment = line.replace("* ", "").split("](");
              const pubDate = segment[0].slice(1);

              const itemComments = segment[1].split(") - [")[0];
              const itemTitle = segment[1].split(") - [")[1];
              const itemLink = segment[2].slice(0, -1);
              const date = pubDate.slice(0, 10);
              const time = pubDate.slice(-8);

              return {
                date,
                itemComments,
                itemLink,
                itemTitle,
                time,
              };
            });
        };

        const handleIntersectingEntry = async (entry, queue) => {
          if (entry.isIntersecting) {
            const lastDateTime = document
              .getElementById("latest")
              .querySelector(
                "section:last-child > section > h4 > span"
              ).textContent;

            const nextDateTime = getNextDateTime(lastDateTime ?? "", -1);
            const archiveIndex = await buildArchiveIndex(nextDateTime);
            const nextTimeIndex = archiveIndex.findIndex(
              ({ time }) => time === nextDateTime.slice(-8)
            );

            const handleIndexUpdate = (index, existingIndexValues = []) => {
              index.forEach((i) => {
                existingIndexValues.push(i);
              });
              return existingIndexValues;
            };

            window.hackerNewsState = {
              index: handleIndexUpdate(
                archiveIndex,
                window.hackerNewsState.index
              ),
              nextTimeIndex,
            };

            let currentTimeIndex = nextTimeIndex + 1;
            const items = Object.values(window.hackerNewsState.index);
            for (let item of items) {
              if (currentTimeIndex < window.hackerNewsState.index.length) {
                addNewsItem(items[currentTimeIndex], queue);

                currentTimeIndex = currentTimeIndex + 1;
              }
            }

            queue.flush();
          }
        };

        const archives = document.getElementById("archives");
        const archivesObserver = new IntersectionObserver(
          (entries) => {
            const queue = new UpdateQueue();

            entries.forEach((entry) => handleIntersectingEntry(entry, queue));
          },
          {
            root: null,
            rootMargin: "0px",
            threshold: 0,
          }
        );

        archivesObserver.observe(archives);

        let latestSectionsExpanded = true;
        const handleLatestHeaderClick = () => {
          latestSectionsExpanded = !latestSectionsExpanded;

          if (latestSectionsExpanded) {
            archivesObserver.observe(archives);
          } else {
            archivesObserver.disconnect(archives);
          }

          for (let section of document.querySelectorAll("#latest > section")) {
            section.style.display = latestSectionsExpanded ? "block" : "none";
          }
        };

        const latestHeader = document.querySelector("#latest > h2");
        latestHeader.style.cursor = "pointer";
        latestHeader.addEventListener("click", handleLatestHeaderClick);
      }
    </script>
    <script type="module">
      import { Workbox } from "https://storage.googleapis.com/workbox-cdn/releases/6.4.1/workbox-window.prod.mjs";

      if ("serviceWorker" in navigator) {
        const base = document.querySelector("base");
        const serviceWorkerPath = `${
          base ? base.href.replace(/\/$/, "") : ""
        }/service-worker.js`;

        const wb = new Workbox(serviceWorkerPath);

        // setup event listeners
        wb.addEventListener("waiting", (event) => {
          wb.addEventListener("controlling", () => {
            window.location.reload();
          });

          wb.messageSkipWaiting();
        });

        wb.register();
      }
    </script>
  </body>
</html>
