<!DOCTYPE html>
<html lang="en" xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta charset="utf-8" />
    <meta
      content="width=device-width, initial-scale=1.0, viewport-fit=cover"
      name="viewport"
    />
    <meta name="description" content="Hacker News" />
    <meta name="theme-color" content="#fff" />
    <title>Hacker News</title>
    <link rel="manifest" href="manifest.json" />
    <link
      href="data:image/x-icon;base64,AAABAAEAAQECAAEAAQA4AAAAFgAAACgAAAABAAAAAgAAAAEAAQAAAAAAAAAAAAAAAAAAAAAAAAAAAAABAAEAAQECAAEAAQA4AAAAFgAAACgAAAABAAAAAgAAAAEAAQAAAAAAAAAAAAAAAAAAAAAAAAAA"
      rel="icon"
      type="image/x-icon"
    />
    <link
      href="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAgAAAAIAAQMAAADOtka5AAAAA1BMVEUAAACnej3aAAAANklEQVR42u3BAQEAAACCIP+vbkhAAQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAB8G4IAAAFjdVCkAAAAAElFTkSuQmCC"
      rel="apple-touch-icon"
    />
    <style>
      /*<!--*/
      body {
        color: rgb(25, 25, 25);
        font-family: Verdana, Geneva, sans-serif;
        margin: 0;
      }

      a {
        text-decoration: none;
      }

      a:link,
      a:focus,
      a:hover,
      a:active {
        color: rgb(75, 75, 125);
      }

      a:visited {
        color: rgb(25, 25, 25);
      }

      h1 > a,
      h1 > a:link,
      h1 > a:focus,
      h1 > a:hover,
      h1 > a:active,
      h1 > a:visited,
      h2 > a,
      h2 > a:link,
      h2 > a:focus,
      h2 > a:hover,
      h2 > a:active,
      h2 > a:visited {
        color: rgb(25, 25, 25);
      }

      h1 {
        background-color: rgb(255, 102, 0);
        margin: 0;
        padding: 1rem;
      }

      h2 {
        background-color: rgb(200, 200, 200);
        margin: 1rem 0;
        padding: 0.5rem 0.5rem 0.5rem 1rem;
      }

      #latest > section,
      #archives > section {
        margin: 0 1rem 1rem 1rem;
        padding-bottom: 1rem;
      }

      #latest > section:not(:last-child),
      #archives > section:not(:last-child) {
        border-bottom: 1px dotted rgb(200, 200, 200);
      }

      section > h3 {
        margin: 0 0 0.5rem 0;
      }

      section > h4 {
        font-weight: normal;
        margin: 0 0 0 1rem;
      }

      .descendants-container,
      .points-container {
        align-items: center;
        border-left: 1px solid #333;
        display: inline-flex;
        margin-left: 0.5rem;
        padding-left: 0.5rem;
        text-align: center;
      }

      .points {
        align-items: center;
        display: inline-flex;
        height: 1rem;
        margin-left: 1ch;
        min-width: 3ch;
      }

      .text {
        line-height: 1.5rem;
        margin: 1rem 1rem 0 1rem;
        overflow: auto;
      }

      .text > p:first-child {
        margin-top: 1rem;
      }

      .text > p:last-child {
        margin-bottom: 0;
      }
      /*-->*/
    </style>
  </head>

  <body>
    <main>
      <h1><a href="https://kherrick.github.io/hacker-news/">Hacker News</a></h1>
      <section id="latest">
        <h2>Latest</h2>
        <section id="37484352">
          <h3>
            <a
              class="item"
              href="https://www.thesun.co.uk/news/23911027/mystery-blue-lights-morocco-earthquake/"
              >Mystery ‘blue lights’ flash in sky moments before Morocco
              earthquake</a
            >
          </h3>
          <section>
            <h4>
              <span>2023-09-12 @ 17:08:29</span
              ><span class="points-container"
                >Points: <span class="points">50</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=37484352"
                  >Comments</a
                ><span class="descendants">: 27</span></span
              >
            </h4>
          </section>
        </section>
        <section id="37484260">
          <h3>
            <a
              class="item"
              href="https://news.northwestern.edu/stories/2023/09/covid-patients-exhale-up-to-1000-copies-of-virus-per-minute-during-first-eight-days-of-symptoms/"
              >Covid patients breathe out large amounts of virus early on</a
            >
          </h3>
          <section>
            <h4>
              <span>2023-09-12 @ 17:01:20</span
              ><span class="points-container"
                >Points: <span class="points">36</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=37484260"
                  >Comments</a
                ><span class="descendants">: 17</span></span
              >
            </h4>
          </section>
        </section>
        <section id="37484259">
          <h3>
            <a
              class="item"
              href="https://jobs.lever.co/FinleyTechnologies/0a143938-ef2a-47f3-a4c0-861ac68fb1b0"
              >Finley (YC W21) Is Hiring for Customer Success Managers in
              Software (US Remote)</a
            >
          </h3>
          <section>
            <h4>
              <span>2023-09-12 @ 17:01:17</span
              ><span class="points-container"
                >Points: <span class="points">1</span></span
              >
            </h4>
          </section>
        </section>
        <section id="37484135">
          <h3>
            <a class="item" href="https://news.ycombinator.com/item?id=37484135"
              >Fine-tune your own Llama 2 to replace GPT-3.5/4</a
            >
          </h3>
          <section>
            <h4>
              <span>2023-09-12 @ 16:53:51</span
              ><span class="points-container"
                >Points: <span class="points">154</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=37484135"
                  >Comments</a
                ><span class="descendants">: 23</span></span
              >
            </h4>
            <div class="text">
              <a href="https://news.ycombinator.com/item?id=37090632"
                >https://news.ycombinator.com/item?id=37090632</a
              >). I've been playing around with fine-tuning models for a couple
              of years, and wanted to share some insights and practical code.
              I’ve condensed what I’ve learned into a small set of notebooks at
              <a
                href="https://github.com/OpenPipe/OpenPipe/tree/main/examples/classify-recipes"
                >https://github.com/OpenPipe/OpenPipe/tree/main/examples/clas...</a
              >, covering labeling data, fine-tuning, running efficient
              inference, and evaluating costs/performance. The 7B model we train
              here matches GPT-4’s labels 95% of the time on the test set, and
              for the 5% of cases where they disagree it’s often because the
              correct answer is genuinely ambiguous.
              <p>
                What is fine-tuning? You can think of it as a more-powerful form
                of prompting, where instead of writing your instructions in text
                you actually encode them in the weights of the model itself. You
                do this by training an existing model on example input/output
                pairs that demonstrate the task you want your fine-tuned model
                to learn. Fine-tuning can work with as few as 50 examples but I
                usually try to get 1000+ if possible.
              </p>
              <p>
                Prompting still has some big advantages over fine-tuning. It's
                way easier/faster to iterate on your instructions than label
                data and re-train a model. And operationally it's easier to
                deploy one big model and just adjust its behavior as necessary
                vs deploying many small fine-tuned models that will likely each
                get lower utilization.
              </p>
              <p>
                Fine-tuning has one huge advantage though: it is far more
                effective at guiding a model's behavior than prompting, so you
                can often get away with a <i>much</i> smaller model. That gets
                you faster responses and lower inference costs. A fine-tuned
                Llama 7B model is 50x cheaper than GPT-3.5 on a per-token basis,
                and for many use cases can produce results that are as good or
                better!
              </p>
              <p>
                For example, classifying the 2M recipes at
                <a href="https://huggingface.co/datasets/corbt/all-recipes"
                  >https://huggingface.co/datasets/corbt/all-recipes</a
                >
                with GPT-4 would cost $23k. Even with GPT-3.5 it would cost over
                $1k. The model we fine-tuned performs similarly to GPT-4 and
                costs just $19 to run over the entire dataset.
              </p>
              <p>
                Disclaimer: My brother David and I are working on an open-source
                product called OpenPipe (<a
                  href="https://github.com/openpipe/openpipe"
                  >https://github.com/openpipe/openpipe</a
                >) to help engineers adopt fine-tuning as simply as possible.
                But none of the information above depends on our startup. The
                current post is just about sharing information that we’ve
                learned about fine-tuning. I hope it’s useful!
              </p>
            </div>
          </section>
        </section>
        <section id="37483226">
          <h3>
            <a
              class="item"
              href="https://jamanetwork.com/journals/jama/article-abstract/2809443"
              >Blood Transfusion and Brain Amyloidosis</a
            >
          </h3>
          <section>
            <h4>
              <span>2023-09-12 @ 15:57:16</span
              ><span class="points-container"
                >Points: <span class="points">31</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=37483226"
                  >Comments</a
                ><span class="descendants">: 4</span></span
              >
            </h4>
          </section>
        </section>
        <section id="37483142">
          <h3>
            <a
              class="item"
              href="https://www.nationalobserver.com/2023/09/11/news/oxford-study-proves-heat-pumps-triumph-over-fossil-fuels-cold"
              >Oxford study proves heat pumps triumph over fossil fuels in the
              cold</a
            >
          </h3>
          <section>
            <h4>
              <span>2023-09-12 @ 15:53:25</span
              ><span class="points-container"
                >Points: <span class="points">55</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=37483142"
                  >Comments</a
                ><span class="descendants">: 36</span></span
              >
            </h4>
          </section>
        </section>
        <section id="37482896">
          <h3>
            <a class="item" href="https://www.howmuchrent.com/"
              >Show HN: Rental data supplied by tenants in Ireland, searchable
              by all</a
            >
          </h3>
          <section>
            <h4>
              <span>2023-09-12 @ 15:38:18</span
              ><span class="points-container"
                >Points: <span class="points">32</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=37482896"
                  >Comments</a
                ><span class="descendants">: 18</span></span
              >
            </h4>
            <div class="text">
              <a href="https://www.howmuchrent.com"
                >https://www.howmuchrent.com</a
              >
              last Friday to help bring this kind of transparency to Ireland,
              allowing people to submit their rents. Would love to get any HN
              feedback on the idea/website.
            </div>
          </section>
        </section>
        <section id="37482517">
          <h3>
            <a
              class="item"
              href="https://ethz.ch/en/news-and-events/eth-news/news/2023/09/from-zero-to-one-hundred-in-0-956-seconds.html"
              >New world record with an electric racing car: From 0 to 100 in
              0.956 seconds</a
            >
          </h3>
          <section>
            <h4>
              <span>2023-09-12 @ 15:14:05</span
              ><span class="points-container"
                >Points: <span class="points">157</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=37482517"
                  >Comments</a
                ><span class="descendants">: 144</span></span
              >
            </h4>
          </section>
        </section>
        <section id="37482220">
          <h3>
            <a
              class="item"
              href="https://til.simonwillison.net/django/building-a-blog-in-django"
              >Building a Blog in Django</a
            >
          </h3>
          <section>
            <h4>
              <span>2023-09-12 @ 14:53:36</span
              ><span class="points-container"
                >Points: <span class="points">69</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=37482220"
                  >Comments</a
                ><span class="descendants">: 43</span></span
              >
            </h4>
          </section>
        </section>
        <section id="37482058">
          <h3>
            <a class="item" href="https://arxiv.org/abs/1803.11384"
              >Super-Earths in Need for Extremly Big Rockets (2018)</a
            >
          </h3>
          <section>
            <h4>
              <span>2023-09-12 @ 14:42:26</span
              ><span class="points-container"
                >Points: <span class="points">20</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=37482058"
                  >Comments</a
                ><span class="descendants">: 19</span></span
              >
            </h4>
          </section>
        </section>
        <section id="37481872">
          <h3>
            <a
              class="item"
              href="https://godotengine.org/article/godot-developer-fund/"
              >The New Godot Development Fund</a
            >
          </h3>
          <section>
            <h4>
              <span>2023-09-12 @ 14:28:47</span
              ><span class="points-container"
                >Points: <span class="points">133</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=37481872"
                  >Comments</a
                ><span class="descendants">: 34</span></span
              >
            </h4>
          </section>
        </section>
        <section id="37481513">
          <h3>
            <a
              class="item"
              href="https://earthly.dev/blog/shutting-down-earthly-ci/"
              >We built the fastest CI and it failed</a
            >
          </h3>
          <section>
            <h4>
              <span>2023-09-12 @ 14:07:08</span
              ><span class="points-container"
                >Points: <span class="points">257</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=37481513"
                  >Comments</a
                ><span class="descendants">: 145</span></span
              >
            </h4>
          </section>
        </section>
        <section id="37481344">
          <h3>
            <a
              class="item"
              href="https://blog.unity.com/news/plan-pricing-and-packaging-updates"
              >Unity plan pricing and packaging updates</a
            >
          </h3>
          <section>
            <h4>
              <span>2023-09-12 @ 13:55:54</span
              ><span class="points-container"
                >Points: <span class="points">206</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=37481344"
                  >Comments</a
                ><span class="descendants">: 315</span></span
              >
            </h4>
          </section>
        </section>
        <section id="37481166">
          <h3>
            <a
              class="item"
              href="https://hermiene.net/essays-trans/relativity_of_wrong.html"
              >The Relativity of Wrong (1989)</a
            >
          </h3>
          <section>
            <h4>
              <span>2023-09-12 @ 13:45:31</span
              ><span class="points-container"
                >Points: <span class="points">110</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=37481166"
                  >Comments</a
                ><span class="descendants">: 81</span></span
              >
            </h4>
          </section>
        </section>
        <section id="37480561">
          <h3>
            <a
              class="item"
              href="https://thepalindrome.org/p/how-large-that-number-in-the-law"
              >How large that number in the Law of Large Numbers is?</a
            >
          </h3>
          <section>
            <h4>
              <span>2023-09-12 @ 13:06:33</span
              ><span class="points-container"
                >Points: <span class="points">74</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=37480561"
                  >Comments</a
                ><span class="descendants">: 21</span></span
              >
            </h4>
          </section>
        </section>
        <section id="37480512">
          <h3>
            <a
              class="item"
              href="https://www.sony-semicon.com/en/news/2023/2023090701.html"
              >Sony develops energy harvesting module from electromagnetic wave
              noise</a
            >
          </h3>
          <section>
            <h4>
              <span>2023-09-12 @ 13:02:47</span
              ><span class="points-container"
                >Points: <span class="points">131</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=37480512"
                  >Comments</a
                ><span class="descendants">: 50</span></span
              >
            </h4>
          </section>
        </section>
        <section id="37480359">
          <h3>
            <a class="item" href="https://arxiv.org/abs/2309.03561"
              >Trinary Decision Trees for missing value handling</a
            >
          </h3>
          <section>
            <h4>
              <span>2023-09-12 @ 12:49:46</span
              ><span class="points-container"
                >Points: <span class="points">32</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=37480359"
                  >Comments</a
                ><span class="descendants">: 15</span></span
              >
            </h4>
          </section>
        </section>
        <section id="37480331">
          <h3>
            <a
              class="item"
              href="http://blog.davidedmundson.co.uk/blog/qt6_wayland_robustness/"
              >QtWayland 6.6 Brings Robustness Through Compositor Handoffs</a
            >
          </h3>
          <section>
            <h4>
              <span>2023-09-12 @ 12:47:15</span
              ><span class="points-container"
                >Points: <span class="points">100</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=37480331"
                  >Comments</a
                ><span class="descendants">: 33</span></span
              >
            </h4>
          </section>
        </section>
        <section id="37480313">
          <h3>
            <a
              class="item"
              href="https://www.quantamagazine.org/physicists-create-elusive-particles-that-remember-their-pasts-20230509/"
              >Physicists create elusive particles that remember their pasts</a
            >
          </h3>
          <section>
            <h4>
              <span>2023-09-12 @ 12:46:01</span
              ><span class="points-container"
                >Points: <span class="points">77</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=37480313"
                  >Comments</a
                ><span class="descendants">: 25</span></span
              >
            </h4>
          </section>
        </section>
        <section id="37480155">
          <h3>
            <a
              class="item"
              href="https://resobscura.substack.com/p/simulating-history-with-chatgpt"
              >Simulating History with ChatGPT</a
            >
          </h3>
          <section>
            <h4>
              <span>2023-09-12 @ 12:34:40</span
              ><span class="points-container"
                >Points: <span class="points">82</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=37480155"
                  >Comments</a
                ><span class="descendants">: 56</span></span
              >
            </h4>
          </section>
        </section>
        <section id="37478403">
          <h3>
            <a
              class="item"
              href="https://chromereleases.googleblog.com/2023/09/stable-channel-update-for-desktop_11.html"
              >Chrome: Heap buffer overflow in WebP</a
            >
          </h3>
          <section>
            <h4>
              <span>2023-09-12 @ 08:58:42</span
              ><span class="points-container"
                >Points: <span class="points">272</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=37478403"
                  >Comments</a
                ><span class="descendants">: 218</span></span
              >
            </h4>
          </section>
        </section>
        <section id="37477512">
          <h3>
            <a class="item" href="https://github.com/TryQuiet/quiet"
              >Quiet – Encrypted P2P team chat with no servers, just Tor</a
            >
          </h3>
          <section>
            <h4>
              <span>2023-09-12 @ 06:29:08</span
              ><span class="points-container"
                >Points: <span class="points">377</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=37477512"
                  >Comments</a
                ><span class="descendants">: 189</span></span
              >
            </h4>
          </section>
        </section>
        <section id="37472340">
          <h3>
            <a class="item" href="https://retroachievements.org"
              >RetroAchievements: Adding Achievements to Retro Games</a
            >
          </h3>
          <section>
            <h4>
              <span>2023-09-11 @ 19:19:28</span
              ><span class="points-container"
                >Points: <span class="points">40</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=37472340"
                  >Comments</a
                ><span class="descendants">: 17</span></span
              >
            </h4>
          </section>
        </section>
        <section id="37465586">
          <h3>
            <a class="item" href="https://astrochart.github.io/"
              >Chart – Completely Hackable Amateur Radio Telescope</a
            >
          </h3>
          <section>
            <h4>
              <span>2023-09-11 @ 11:18:42</span
              ><span class="points-container"
                >Points: <span class="points">88</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=37465586"
                  >Comments</a
                ><span class="descendants">: 25</span></span
              >
            </h4>
          </section>
        </section>
        <section id="37464988">
          <h3>
            <a
              class="item"
              href="https://www.smashingmagazine.com/2023/08/oklch-color-spaces-gamuts-css/"
              >Falling for Oklch: A Love Story of Color Spaces, Gamuts, and
              CSS</a
            >
          </h3>
          <section>
            <h4>
              <span>2023-09-11 @ 09:55:18</span
              ><span class="points-container"
                >Points: <span class="points">19</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=37464988"
                  >Comments</a
                ><span class="descendants">: 2</span></span
              >
            </h4>
          </section>
        </section>
        <section id="37464950">
          <h3>
            <a
              class="item"
              href="https://sethmlarson.dev/security-developer-in-residence-weekly-report-9?date=2023-09-05"
              >Visualizing the CPython Release Process</a
            >
          </h3>
          <section>
            <h4>
              <span>2023-09-11 @ 09:50:36</span
              ><span class="points-container"
                >Points: <span class="points">21</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=37464950"
                  >Comments</a
                ><span class="descendants">: 0</span></span
              >
            </h4>
          </section>
        </section>
        <section id="37463534">
          <h3>
            <a
              class="item"
              href="https://nchfp.uga.edu/how/dry/csu_dry_fruits.pdf"
              >Drying Fruits (2003)</a
            >
          </h3>
          <section>
            <h4>
              <span>2023-09-11 @ 06:15:59</span
              ><span class="points-container"
                >Points: <span class="points">44</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=37463534"
                  >Comments</a
                ><span class="descendants">: 27</span></span
              >
            </h4>
          </section>
        </section>
        <section id="37462539">
          <h3>
            <a
              class="item"
              href="https://www.nytimes.com/2023/09/05/science/archaeology-burial-vampires-revenants.html"
              >Undying dread: A 400-year-old corpse, locked to its grave</a
            >
          </h3>
          <section>
            <h4>
              <span>2023-09-11 @ 03:28:23</span
              ><span class="points-container"
                >Points: <span class="points">20</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=37462539"
                  >Comments</a
                ><span class="descendants">: 26</span></span
              >
            </h4>
          </section>
        </section>
        <section id="37453678">
          <h3>
            <a
              class="item"
              href="http://www.pjhutchison.org/tutorial/amiga_c.html"
              >Amiga C Tutorial (2022)</a
            >
          </h3>
          <section>
            <h4>
              <span>2023-09-10 @ 07:34:28</span
              ><span class="points-container"
                >Points: <span class="points">109</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=37453678"
                  >Comments</a
                ><span class="descendants">: 30</span></span
              >
            </h4>
          </section>
        </section>
        <section id="37453266">
          <h3>
            <a
              class="item"
              href="https://founders.archives.gov/documents/Adams/04-03-02-0258"
              >John Adams to Abigail Adams (1780)</a
            >
          </h3>
          <section>
            <h4>
              <span>2023-09-10 @ 05:51:58</span
              ><span class="points-container"
                >Points: <span class="points">5</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=37453266"
                  >Comments</a
                ><span class="descendants">: 1</span></span
              >
            </h4>
          </section>
        </section>
      </section>
      <section id="archives">
        <h2>
          <a
            href="https://github.com/kherrick/hacker-news/blob/main/archives/index.md"
            >Archives</a
          >
        </h2>
        <section>
          <h3>
            <a
              href="https://github.com/kherrick/hacker-news/blob/main/archives/2023/index.md"
              >2023</a
            >
          </h3>
        </section>
        <section>
          <h3>
            <a
              href="https://github.com/kherrick/hacker-news/blob/main/archives/2022/index.md"
              >2022</a
            >
          </h3>
        </section>
      </section>
    </main>
    <script type="module">
      import { buildDescendants } from "./lib/build-html-descendants.js";
      import { buildNextItem } from "./lib/build-html-next-item.js";
      import { getNextDateTime } from "./lib/date-time.js";

      const updateSectionById = (id) =>
        fetch(`https://hacker-news.firebaseio.com/v0/item/${id}.json`).then(
          (result) =>
            result.json().then(({ descendants, id, score, text, type }) => {
              const currentItem = document.getElementById(id);

              if (score) {
                currentItem.querySelector(".points").textContent = score;
              }

              if (descendants && (type === "poll" || type === "story")) {
                const currentDescendants =
                  currentItem.querySelector(".descendants");

                if (currentDescendants) {
                  currentDescendants.textContent = `: ${descendants}`;
                } else {
                  const comments = buildDescendants(
                    document,
                    descendants,
                    `https://news.ycombinator.com/item?id=${id}`
                  );

                  currentItem.querySelector("h4").appendChild(comments);
                }
              }

              if (text) {
                const currentText = currentItem.querySelector(".text");

                if (currentText) {
                  currentText.innerHTML = text.replace(/\0/g, "");
                } else {
                  const content = document.createElement("div");
                  content.innerHTML = text.replace(/\0/g, "");
                  content.setAttribute("class", "text");

                  currentItem.appendChild(content);
                }
              }
            })
        );

      class UpdateQueue {
        constructor() {
          this._ids = [];
          this._isUpdating = false;
        }

        addItemById(id) {
          this._ids.push(id);
        }

        async flush() {
          const id = this._ids.shift();

          if (id) {
            this._isUpdating = true;

            await updateSectionById(id);
            await this.flush();
          } else {
            this._isUpdating = false;

            setTimeout(async () => {
              if (!this._isUpdating && this._ids && this._ids.length) {
                await this.flush();
              }
            }, 0);
          }
        }
      }

      // get latest data
      const latestSection = document.getElementById("latest");

      for (let item of latestSection.querySelectorAll("section[id]")) {
        updateSectionById(item.getAttribute("id"));
      }

      if ("IntersectionObserver" in window) {
        window.hackerNewsState = { index: [], nextTimeIndex: -1 };

        const addNewsItem = async (newsItem, queue) => {
          try {
            const { date, time, itemComments, itemTitle, itemLink } = newsItem;
            const section = await buildNextItem({
              document,
              dateTime: `${date}, ${time}`,
              itemComments,
              itemLink,
              itemTitle: new DOMParser().parseFromString(
                itemTitle.replace(/\\/g, ""),
                "text/html"
              ).documentElement.textContent,
              fetchItemDetails: false,
            });

            // display loading indicator for section
            section.querySelector(".points-container").innerHTML =
              'Points: <span class="points"><img style="height: 100%;" src="lib/images/loading.svg" /></span>';

            const id = section.getAttribute("id");
            if (!document.getElementById(id)) {
              document.getElementById("latest").appendChild(section);

              queue.addItemById(id);
            }
          } catch (error) {}
        };

        const buildArchiveIndex = async (lastDateTime) => {
          const nextDate = lastDateTime.slice(0, 10);
          const nextYear = nextDate.slice(0, 4);

          return (
            await (
              await fetch(
                `https://raw.githubusercontent.com/kherrick/hacker-news/main/archives/${nextYear}/${nextDate}/index.md`
              )
            ).text()
          )
            .split("\n")
            .filter((line) => line.match(new RegExp("^\\* \\[")))
            .map((line) => {
              const segment = line.replace("* ", "").split("](");
              const pubDate = segment[0].slice(1);

              const itemComments = segment[1].split(") - [")[0];
              const itemTitle = segment[1].split(") - [")[1];
              const itemLink = segment[2].slice(0, -1);
              const date = pubDate.slice(0, 10);
              const time = pubDate.slice(-8);

              return {
                date,
                itemComments,
                itemLink,
                itemTitle,
                time,
              };
            });
        };

        const handleIntersectingEntry = async (entry, queue) => {
          if (entry.isIntersecting) {
            const lastDateTime = document
              .getElementById("latest")
              .querySelector(
                "section:last-child > section > h4 > span"
              ).textContent;

            const nextDateTime = getNextDateTime(lastDateTime ?? "", -1);
            const archiveIndex = await buildArchiveIndex(nextDateTime);
            const nextTimeIndex = archiveIndex.findIndex(
              ({ time }) => time === nextDateTime.slice(-8)
            );

            const handleIndexUpdate = (index, existingIndexValues = []) => {
              index.forEach((i) => {
                existingIndexValues.push(i);
              });
              return existingIndexValues;
            };

            window.hackerNewsState = {
              index: handleIndexUpdate(
                archiveIndex,
                window.hackerNewsState.index
              ),
              nextTimeIndex,
            };

            let currentTimeIndex = nextTimeIndex + 1;
            const items = Object.values(window.hackerNewsState.index);
            for (let item of items) {
              if (currentTimeIndex < window.hackerNewsState.index.length) {
                addNewsItem(items[currentTimeIndex], queue);

                currentTimeIndex = currentTimeIndex + 1;
              }
            }

            queue.flush();
          }
        };

        const archives = document.getElementById("archives");
        const archivesObserver = new IntersectionObserver(
          (entries) => {
            const queue = new UpdateQueue();

            entries.forEach((entry) => handleIntersectingEntry(entry, queue));
          },
          {
            root: null,
            rootMargin: "0px",
            threshold: 0,
          }
        );

        archivesObserver.observe(archives);

        let latestSectionsExpanded = true;
        const handleLatestHeaderClick = () => {
          latestSectionsExpanded = !latestSectionsExpanded;

          if (latestSectionsExpanded) {
            archivesObserver.observe(archives);
          } else {
            archivesObserver.disconnect(archives);
          }

          for (let section of document.querySelectorAll("#latest > section")) {
            section.style.display = latestSectionsExpanded ? "block" : "none";
          }
        };

        const latestHeader = document.querySelector("#latest > h2");
        latestHeader.style.cursor = "pointer";
        latestHeader.addEventListener("click", handleLatestHeaderClick);
      }
    </script>
    <script type="module">
      import { Workbox } from "https://storage.googleapis.com/workbox-cdn/releases/6.4.1/workbox-window.prod.mjs";

      if ("serviceWorker" in navigator) {
        const base = document.querySelector("base");
        const serviceWorkerPath = `${
          base ? base.href.replace(/\/$/, "") : ""
        }/service-worker.js`;

        const wb = new Workbox(serviceWorkerPath);

        // setup event listeners
        wb.addEventListener("waiting", (event) => {
          wb.addEventListener("controlling", () => {
            window.location.reload();
          });

          wb.messageSkipWaiting();
        });

        wb.register();
      }
    </script>
  </body>
</html>
