<!DOCTYPE html>
<html lang="en" xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta charset="utf-8" />
    <meta
      content="width=device-width, initial-scale=1.0, viewport-fit=cover"
      name="viewport"
    />
    <meta name="description" content="Hacker News" />
    <meta name="theme-color" content="#fff" />
    <title>Hacker News</title>
    <link rel="manifest" href="manifest.json" />
    <link
      href="data:image/x-icon;base64,AAABAAEAAQECAAEAAQA4AAAAFgAAACgAAAABAAAAAgAAAAEAAQAAAAAAAAAAAAAAAAAAAAAAAAAAAAABAAEAAQECAAEAAQA4AAAAFgAAACgAAAABAAAAAgAAAAEAAQAAAAAAAAAAAAAAAAAAAAAAAAAA"
      rel="icon"
      type="image/x-icon"
    />
    <link
      href="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAgAAAAIAAQMAAADOtka5AAAAA1BMVEUAAACnej3aAAAANklEQVR42u3BAQEAAACCIP+vbkhAAQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAB8G4IAAAFjdVCkAAAAAElFTkSuQmCC"
      rel="apple-touch-icon"
    />
    <style>
      /*<!--*/
      body {
        color: rgb(25, 25, 25);
        font-family: Verdana, Geneva, sans-serif;
        margin: 0;
      }

      a {
        text-decoration: none;
      }

      a:link,
      a:focus,
      a:hover,
      a:active {
        color: rgb(75, 75, 125);
      }

      a:visited {
        color: rgb(25, 25, 25);
      }

      h1 > a,
      h1 > a:link,
      h1 > a:focus,
      h1 > a:hover,
      h1 > a:active,
      h1 > a:visited,
      h2 > a,
      h2 > a:link,
      h2 > a:focus,
      h2 > a:hover,
      h2 > a:active,
      h2 > a:visited {
        color: rgb(25, 25, 25);
      }

      h1 {
        background-color: rgb(255, 102, 0);
        margin: 0;
        padding: 1rem;
      }

      h2 {
        background-color: rgb(200, 200, 200);
        margin: 1rem 0;
        padding: 0.5rem 0.5rem 0.5rem 1rem;
      }

      #latest > section,
      #archives > section {
        margin: 0 1rem 1rem 1rem;
        padding-bottom: 1rem;
      }

      #latest > section:not(:last-child),
      #archives > section:not(:last-child) {
        border-bottom: 1px dotted rgb(200, 200, 200);
      }

      section > h3 {
        margin: 0 0 0.5rem 0;
      }

      section > h4 {
        font-weight: normal;
        margin: 0 0 0 1rem;
      }

      .descendants-container,
      .points-container {
        align-items: center;
        border-left: 1px solid #333;
        display: inline-flex;
        margin-left: 0.5rem;
        padding-left: 0.5rem;
        text-align: center;
      }

      .points {
        align-items: center;
        display: inline-flex;
        height: 1rem;
        margin-left: 1ch;
        min-width: 3ch;
      }

      .text {
        line-height: 1.5rem;
        margin: 1rem 1rem 0 1rem;
        overflow: auto;
      }

      .text > p:first-child {
        margin-top: 1rem;
      }

      .text > p:last-child {
        margin-bottom: 0;
      }
      /*-->*/
    </style>
  </head>

  <body>
    <main>
      <h1><a href="https://kherrick.github.io/hacker-news/">Hacker News</a></h1>
      <section id="latest">
        <h2>Latest</h2>
        <section id="44705240">
          <h3>
            <a
              class="item"
              href="https://www.reddit.com/r/degoogle/s/YxmPgFes8a"
              >EU age verification app to ban any Android system not licensed by
              Google</a
            >
          </h3>
          <section>
            <h4>
              <span>2025-07-27 @ 22:18:44</span
              ><span class="points-container"
                >Points: <span class="points">32</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=44705240"
                  >Comments</a
                ><span class="descendants">: 0</span></span
              >
            </h4>
          </section>
        </section>
        <section id="44704736">
          <h3>
            <a
              class="item"
              href="https://byteofdev.com/posts/making-postgres-slow/"
              >Making Postgres 42,000x slower because I am unemployed</a
            >
          </h3>
          <section>
            <h4>
              <span>2025-07-27 @ 21:12:59</span
              ><span class="points-container"
                >Points: <span class="points">61</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=44704736"
                  >Comments</a
                ><span class="descendants">: 8</span></span
              >
            </h4>
          </section>
        </section>
        <section id="44704482">
          <h3>
            <a class="item" href="http://www.intel4004.com/btstrp.htm"
              >The Bootstrap Load</a
            >
          </h3>
          <section>
            <h4>
              <span>2025-07-27 @ 20:37:26</span
              ><span class="points-container"
                >Points: <span class="points">16</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=44704482"
                  >Comments</a
                ><span class="descendants">: 1</span></span
              >
            </h4>
          </section>
        </section>
        <section id="44704422">
          <h3>
            <a class="item" href="https://sharktastica.co.uk/topics/patents"
              >IBM Keyboard Patents</a
            >
          </h3>
          <section>
            <h4>
              <span>2025-07-27 @ 20:30:27</span
              ><span class="points-container"
                >Points: <span class="points">24</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=44704422"
                  >Comments</a
                ><span class="descendants">: 1</span></span
              >
            </h4>
          </section>
        </section>
        <section id="44704391">
          <h3>
            <a
              class="item"
              href="https://billdembski.substack.com/p/the-evilization-of-googleand-what"
              >The Evilization of Google–and What to Do About It</a
            >
          </h3>
          <section>
            <h4>
              <span>2025-07-27 @ 20:25:20</span
              ><span class="points-container"
                >Points: <span class="points">38</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=44704391"
                  >Comments</a
                ><span class="descendants">: 22</span></span
              >
            </h4>
          </section>
        </section>
        <section id="44704377">
          <h3>
            <a
              class="item"
              href="https://nonint.com/2023/03/09/gpt-might-be-an-information-virus/"
              >GPT might be an information virus (2023)</a
            >
          </h3>
          <section>
            <h4>
              <span>2025-07-27 @ 20:23:21</span
              ><span class="points-container"
                >Points: <span class="points">44</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=44704377"
                  >Comments</a
                ><span class="descendants">: 19</span></span
              >
            </h4>
          </section>
        </section>
        <section id="44704319">
          <h3>
            <a
              class="item"
              href="https://www.science.org/doi/10.1126/sciadv.adv1585"
              >Electrified dry reforming of methane on Ni-La2O3–loaded activated
              carbon</a
            >
          </h3>
          <section>
            <h4>
              <span>2025-07-27 @ 20:15:50</span
              ><span class="points-container"
                >Points: <span class="points">6</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=44704319"
                  >Comments</a
                ><span class="descendants">: 0</span></span
              >
            </h4>
          </section>
        </section>
        <section id="44704305">
          <h3>
            <a
              class="item"
              href="https://surfingcomplexity.blog/2025/07/26/formal-specs-as-sets-of-behaviors/"
              >Formal specs as sets of behaviors</a
            >
          </h3>
          <section>
            <h4>
              <span>2025-07-27 @ 20:13:55</span
              ><span class="points-container"
                >Points: <span class="points">10</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=44704305"
                  >Comments</a
                ><span class="descendants">: 0</span></span
              >
            </h4>
          </section>
        </section>
        <section id="44704270">
          <h3>
            <a
              class="item"
              href="https://nexy.blog/2025/07/27/how-i-hacked-my-washing-machine/"
              >I hacked my washing machine</a
            >
          </h3>
          <section>
            <h4>
              <span>2025-07-27 @ 20:09:29</span
              ><span class="points-container"
                >Points: <span class="points">75</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=44704270"
                  >Comments</a
                ><span class="descendants">: 26</span></span
              >
            </h4>
          </section>
        </section>
        <section id="44703908">
          <h3>
            <a class="item" href="https://www.narcap.org"
              >National Aviation Reporting Center on Anomalous Phenomena</a
            >
          </h3>
          <section>
            <h4>
              <span>2025-07-27 @ 19:31:39</span
              ><span class="points-container"
                >Points: <span class="points">14</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=44703908"
                  >Comments</a
                ><span class="descendants">: 10</span></span
              >
            </h4>
          </section>
        </section>
        <section id="44703164">
          <h3>
            <a
              class="item"
              href="https://github.com/segmentationf4u1t/trae_telemetry_research"
              >Performance and Telemetry Analysis of Trae IDE, ByteDance's
              VSCode Fork</a
            >
          </h3>
          <section>
            <h4>
              <span>2025-07-27 @ 17:57:06</span
              ><span class="points-container"
                >Points: <span class="points">555</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=44703164"
                  >Comments</a
                ><span class="descendants">: 201</span></span
              >
            </h4>
            <div class="text">
              <p>Here are the key findings:</p>
              <p>
                1. Extreme Resource Consumption: Out of the box, Trae used 6.3x
                more RAM (~5.7 GB) and spawned 3.7x more processes (33 total)
                than a standard VSCode setup with the same project open. The
                team has since made improvements, but it's still significantly
                heavier.
              </p>
              <p>
                2. Telemetry Opt-Out Doesn't Work (It Makes It Worse): I found
                Trae was constantly sending data to ByteDance servers
                (byteoversea.com). I went into the settings and disabled all
                telemetry. To my surprise, this didn't stop the traffic. In
                fact, it increased the frequency of batch data collection. The
                telemetry "off" switch appears to be purely cosmetic.
              </p>
              <p>
                3. What's Being Sent: Even with telemetry "disabled," Trae sends
                detailed payloads including: Hardware specs (CPU, memory, etc.)
                Persistent user, device, and machine IDs OS version, app
                language, user name Granular usage data like time-on-ide, window
                focus state, and active file types.
              </p>
              <p>
                4. Community Censorship: When I tried to discuss these findings
                on their official Discord, my posts were deleted and my account
                was muted for 7 days. It seems words like "track" trigger an
                automated gag rule, which prevents any real discussion about
                privacy.
              </p>
              <p>
                I believe developers should be aware of this behavior. The
                combination of resource drain, non-functional privacy settings,
                and censorship of technical feedback is a major red flag. The
                full, detailed analysis with all the evidence (process lists,
                Fiddler captures, JSON payloads, and screenshots of the Discord
                moderation) is available at the link. Happy to answer any
                questions.
              </p>
            </div>
          </section>
        </section>
        <section id="44703079">
          <h3>
            <a
              class="item"
              href="https://techcrunch.com/2025/07/26/allianz-life-says-majority-of-customers-personal-data-stolen-in-cyberattack/"
              >Allianz Life says 'majority' of customers' personal data stolen
              in cyberattack</a
            >
          </h3>
          <section>
            <h4>
              <span>2025-07-27 @ 17:49:23</span
              ><span class="points-container"
                >Points: <span class="points">167</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=44703079"
                  >Comments</a
                ><span class="descendants">: 95</span></span
              >
            </h4>
          </section>
        </section>
        <section id="44702833">
          <h3>
            <a class="item" href="https://news.ycombinator.com/item?id=44702833"
              >Ask HN: What are you working on? (July 2025)</a
            >
          </h3>
          <section>
            <h4>
              <span>2025-07-27 @ 17:19:19</span
              ><span class="points-container"
                >Points: <span class="points">95</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=44702833"
                  >Comments</a
                ><span class="descendants">: 296</span></span
              >
            </h4>
            <div class="text">
              What are you working on? Do you have any new ideas you're thinking
              about?
            </div>
          </section>
        </section>
        <section id="44702782">
          <h3>
            <a
              class="item"
              href="https://www.nytimes.com/2025/07/27/arts/music/tom-lehrer-dead.html"
              >Tom Lehrer has died</a
            >
          </h3>
          <section>
            <h4>
              <span>2025-07-27 @ 17:13:25</span
              ><span class="points-container"
                >Points: <span class="points">378</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=44702782"
                  >Comments</a
                ><span class="descendants">: 68</span></span
              >
            </h4>
            <div class="text">
              <a href="https://archive.ph/gY3Xa">https://archive.ph/gY3Xa</a>
              <p>
                Also:
                <a
                  href="https://apnews.com/article/tom-lehrer-son-satirist-mathematician-dies-9caa7ee01faf4fbfb793d7ba984c179d"
                  >https://apnews.com/article/tom-lehrer-son-satirist-mathemati...</a
                >
              </p>
            </div>
          </section>
        </section>
        <section id="44701574">
          <h3>
            <a
              class="item"
              href="https://buttondown.com/whatever_jamie/archive/the-many-many-many-javascript-runtimes-of-the-last-decade/"
              >The many JavaScript runtimes of the last decade</a
            >
          </h3>
          <section>
            <h4>
              <span>2025-07-27 @ 14:28:49</span
              ><span class="points-container"
                >Points: <span class="points">127</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=44701574"
                  >Comments</a
                ><span class="descendants">: 56</span></span
              >
            </h4>
          </section>
        </section>
        <section id="44701555">
          <h3>
            <a class="item" href="https://www.dumbpipe.dev/">Dumb Pipe</a>
          </h3>
          <section>
            <h4>
              <span>2025-07-27 @ 14:25:47</span
              ><span class="points-container"
                >Points: <span class="points">496</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=44701555"
                  >Comments</a
                ><span class="descendants">: 110</span></span
              >
            </h4>
          </section>
        </section>
        <section id="44700815">
          <h3>
            <a class="item" href="https://github.com/jkoppel/jj-workshop"
              >The JJ VCS workshop: A zero-to-hero speedrun</a
            >
          </h3>
          <section>
            <h4>
              <span>2025-07-27 @ 12:23:31</span
              ><span class="points-container"
                >Points: <span class="points">57</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=44700815"
                  >Comments</a
                ><span class="descendants">: 0</span></span
              >
            </h4>
          </section>
        </section>
        <section id="44699452">
          <h3>
            <a class="item" href="https://arxiv.org/abs/2506.21734"
              >Hierarchical Reasoning Model</a
            >
          </h3>
          <section>
            <h4>
              <span>2025-07-27 @ 07:15:57</span
              ><span class="points-container"
                >Points: <span class="points">274</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=44699452"
                  >Comments</a
                ><span class="descendants">: 84</span></span
              >
            </h4>
          </section>
        </section>
        <section id="44699393">
          <h3>
            <a
              class="item"
              href="https://www.linaro.org/blog/linux-on-snapdragon-x-elite/"
              >Linux on Snapdragon X Elite: Linaro and Tuxedo Pave the Way for
              ARM64 Laptops</a
            >
          </h3>
          <section>
            <h4>
              <span>2025-07-27 @ 07:01:02</span
              ><span class="points-container"
                >Points: <span class="points">264</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=44699393"
                  >Comments</a
                ><span class="descendants">: 183</span></span
              >
            </h4>
          </section>
        </section>
        <section id="44699052">
          <h3>
            <a
              class="item"
              href="https://www.kcrw.com/news/shows/npr/npr-story/nx-s1-5481304"
              >4k NASA employees opt to leave agency through deferred
              resignation program</a
            >
          </h3>
          <section>
            <h4>
              <span>2025-07-27 @ 05:17:03</span
              ><span class="points-container"
                >Points: <span class="points">366</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=44699052"
                  >Comments</a
                ><span class="descendants">: 460</span></span
              >
            </h4>
          </section>
        </section>
        <section id="44698928">
          <h3>
            <a
              class="item"
              href="https://spectrum.ieee.org/nmc-battery-aspiring-materials"
              >Chemical process produces critical battery metals with no
              waste</a
            >
          </h3>
          <section>
            <h4>
              <span>2025-07-27 @ 04:35:33</span
              ><span class="points-container"
                >Points: <span class="points">220</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=44698928"
                  >Comments</a
                ><span class="descendants">: 23</span></span
              >
            </h4>
          </section>
        </section>
        <section id="44698899">
          <h3>
            <a
              class="item"
              href="https://www.robertmao.com/blog/en/the-future-is-not-self-hosted-but-self-sovereign"
              >The future is not self-hosted, but self-sovereign</a
            >
          </h3>
          <section>
            <h4>
              <span>2025-07-27 @ 04:26:08</span
              ><span class="points-container"
                >Points: <span class="points">188</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=44698899"
                  >Comments</a
                ><span class="descendants">: 163</span></span
              >
            </h4>
            <div class="text">
              <i>The future is not self-hosted</i> -
              <a href="https://news.ycombinator.com/item?id=44682175"
                >https://news.ycombinator.com/item?id=44682175</a
              >
              (424 comments)
            </div>
          </section>
        </section>
        <section id="44698754">
          <h3>
            <a
              class="item"
              href="https://quantum5.ca/2025/05/11/fast-cheap-bulk-storage-using-lvm-to-cache-hdds-on-ssds/"
              >Fast and cheap bulk storage: using LVM to cache HDDs on SSDs</a
            >
          </h3>
          <section>
            <h4>
              <span>2025-07-27 @ 03:38:27</span
              ><span class="points-container"
                >Points: <span class="points">201</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=44698754"
                  >Comments</a
                ><span class="descendants">: 62</span></span
              >
            </h4>
          </section>
        </section>
        <section id="44687145">
          <h3>
            <a
              class="item"
              href="https://www.politico.eu/article/uk-british-spies-private-intelligence-government-ministers/"
              >Britain's spies-for-hire are running wild</a
            >
          </h3>
          <section>
            <h4>
              <span>2025-07-25 @ 19:13:59</span
              ><span class="points-container"
                >Points: <span class="points">45</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=44687145"
                  >Comments</a
                ><span class="descendants">: 11</span></span
              >
            </h4>
          </section>
        </section>
        <section id="44681616">
          <h3>
            <a
              class="item"
              href="https://andinfinity.eu/post/2025-07-24-bits-0x02/"
              >Bits 0x02: switching to orion as a browser</a
            >
          </h3>
          <section>
            <h4>
              <span>2025-07-25 @ 10:24:44</span
              ><span class="points-container"
                >Points: <span class="points">8</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=44681616"
                  >Comments</a
                ><span class="descendants">: 0</span></span
              >
            </h4>
          </section>
        </section>
        <section id="44671528">
          <h3>
            <a
              class="item"
              href="https://thebsdetector.substack.com/p/government-funded-alchemy"
              >Government-Funded Alchemy</a
            >
          </h3>
          <section>
            <h4>
              <span>2025-07-24 @ 14:59:32</span
              ><span class="points-container"
                >Points: <span class="points">13</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=44671528"
                  >Comments</a
                ><span class="descendants">: 6</span></span
              >
            </h4>
          </section>
        </section>
        <section id="44669026">
          <h3>
            <a class="item" href="https://github.com/vivoblueos/kernel"
              >BlueOS Kernel – Written in Rust, compatible with POSIX</a
            >
          </h3>
          <section>
            <h4>
              <span>2025-07-24 @ 10:19:59</span
              ><span class="points-container"
                >Points: <span class="points">97</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=44669026"
                  >Comments</a
                ><span class="descendants">: 11</span></span
              >
            </h4>
          </section>
        </section>
        <section id="44665662">
          <h3>
            <a
              class="item"
              href="https://fs.blog/knowledge-project-podcast/outliers-katharine-graham/"
              >Katharine Graham: The Washington Post</a
            >
          </h3>
          <section>
            <h4>
              <span>2025-07-24 @ 00:47:24</span
              ><span class="points-container"
                >Points: <span class="points">63</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=44665662"
                  >Comments</a
                ><span class="descendants">: 21</span></span
              >
            </h4>
          </section>
        </section>
        <section id="44658722">
          <h3>
            <a
              class="item"
              href="https://www.cnx-software.com/2025/07/22/three-high-performance-risc-v-processors-to-watch-in-h2-2025-ultrarisc-ur-dp1000-zizhe-a210-and-spacemit-k3/"
              >High-performance RISC-V processors: UltraRISC UR-DP1000, Zhihe
              A210, SpacemIT K3</a
            >
          </h3>
          <section>
            <h4>
              <span>2025-07-23 @ 12:58:48</span
              ><span class="points-container"
                >Points: <span class="points">87</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=44658722"
                  >Comments</a
                ><span class="descendants">: 14</span></span
              >
            </h4>
          </section>
        </section>
        <section id="44658323">
          <h3>
            <a
              class="item"
              href="https://www.livescience.com/animals/land-mammals/return-of-wolves-to-yellowstone-has-led-to-a-surge-in-aspen-trees-unseen-for-80-years"
              >Return of wolves to Yellowstone has led to a surge in aspen
              trees</a
            >
          </h3>
          <section>
            <h4>
              <span>2025-07-23 @ 12:13:52</span
              ><span class="points-container"
                >Points: <span class="points">340</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=44658323"
                  >Comments</a
                ><span class="descendants">: 178</span></span
              >
            </h4>
            <div class="text">
              <a
                href="https://www.sciencedirect.com/science/article/pii/S0378112725004499?via%3Dihub"
                >https://www.sciencedirect.com/science/article/pii/S037811272...</a
              >
            </div>
          </section>
        </section>
      </section>
      <section id="archives">
        <h2>
          <a
            href="https://github.com/kherrick/hacker-news/blob/main/archives/index.md"
            >Archives</a
          >
        </h2>
        <section>
          <h3>
            <a
              href="https://github.com/kherrick/hacker-news/blob/main/archives/2025/index.md"
              >2025</a
            >
          </h3>
        </section>
        <section>
          <h3>
            <a
              href="https://github.com/kherrick/hacker-news/blob/main/archives/2024/index.md"
              >2024</a
            >
          </h3>
        </section>
        <section>
          <h3>
            <a
              href="https://github.com/kherrick/hacker-news/blob/main/archives/2023/index.md"
              >2023</a
            >
          </h3>
        </section>
        <section>
          <h3>
            <a
              href="https://github.com/kherrick/hacker-news/blob/main/archives/2022/index.md"
              >2022</a
            >
          </h3>
        </section>
      </section>
    </main>
    <script type="module">
      import { buildDescendants } from "./lib/build-html-descendants.js";
      import { buildNextItem } from "./lib/build-html-next-item.js";
      import { getNextDateTime } from "./lib/date-time.js";

      const updateSectionById = (id) =>
        fetch(`https://hacker-news.firebaseio.com/v0/item/${id}.json`).then(
          (result) =>
            result.json().then(({ descendants, id, score, text, type }) => {
              const currentItem = document.getElementById(id);

              if (score) {
                currentItem.querySelector(".points").textContent = score;
              }

              if (descendants && (type === "poll" || type === "story")) {
                const currentDescendants =
                  currentItem.querySelector(".descendants");

                if (currentDescendants) {
                  currentDescendants.textContent = `: ${descendants}`;
                } else {
                  const comments = buildDescendants(
                    document,
                    descendants,
                    `https://news.ycombinator.com/item?id=${id}`
                  );

                  currentItem.querySelector("h4").appendChild(comments);
                }
              }

              if (text) {
                const currentText = currentItem.querySelector(".text");

                if (currentText) {
                  currentText.innerHTML = text.replace(/\0/g, "");
                } else {
                  const content = document.createElement("div");
                  content.innerHTML = text.replace(/\0/g, "");
                  content.setAttribute("class", "text");

                  currentItem.appendChild(content);
                }
              }
            })
        );

      class UpdateQueue {
        constructor() {
          this._ids = [];
          this._isUpdating = false;
        }

        addItemById(id) {
          this._ids.push(id);
        }

        async flush() {
          const id = this._ids.shift();

          if (id) {
            this._isUpdating = true;

            await updateSectionById(id);
            await this.flush();
          } else {
            this._isUpdating = false;

            setTimeout(async () => {
              if (!this._isUpdating && this._ids && this._ids.length) {
                await this.flush();
              }
            }, 0);
          }
        }
      }

      // get latest data
      const latestSection = document.getElementById("latest");

      for (let item of latestSection.querySelectorAll("section[id]")) {
        updateSectionById(item.getAttribute("id"));
      }

      if ("IntersectionObserver" in window) {
        window.hackerNewsState = { index: [], nextTimeIndex: -1 };

        const addNewsItem = async (newsItem, queue) => {
          try {
            const { date, time, itemComments, itemTitle, itemLink } = newsItem;
            const section = await buildNextItem({
              document,
              dateTime: `${date}, ${time}`,
              itemComments,
              itemLink,
              itemTitle: new DOMParser().parseFromString(
                itemTitle.replace(/\\/g, ""),
                "text/html"
              ).documentElement.textContent,
              fetchItemDetails: false,
            });

            // display loading indicator for section
            section.querySelector(".points-container").innerHTML =
              'Points: <span class="points"><img style="height: 100%;" src="lib/images/loading.svg" /></span>';

            const id = section.getAttribute("id");
            if (!document.getElementById(id)) {
              document.getElementById("latest").appendChild(section);

              queue.addItemById(id);
            }
          } catch (error) {}
        };

        const buildArchiveIndex = async (lastDateTime) => {
          const nextDate = lastDateTime.slice(0, 10);
          const nextYear = nextDate.slice(0, 4);

          return (
            await (
              await fetch(
                `https://raw.githubusercontent.com/kherrick/hacker-news/main/archives/${nextYear}/${nextDate}/index.md`
              )
            ).text()
          )
            .split("\n")
            .filter((line) => line.match(new RegExp("^\\* \\[")))
            .map((line) => {
              const segment = line.replace("* ", "").split("](");
              const pubDate = segment[0].slice(1);

              const itemComments = segment[1].split(") - [")[0];
              const itemTitle = segment[1].split(") - [")[1];
              const itemLink = segment[2].slice(0, -1);
              const date = pubDate.slice(0, 10);
              const time = pubDate.slice(-8);

              return {
                date,
                itemComments,
                itemLink,
                itemTitle,
                time,
              };
            });
        };

        const handleIntersectingEntry = async (entry, queue) => {
          if (entry.isIntersecting) {
            const lastDateTime = document
              .getElementById("latest")
              .querySelector(
                "section:last-child > section > h4 > span"
              ).textContent;

            const nextDateTime = getNextDateTime(lastDateTime ?? "", -1);
            const archiveIndex = await buildArchiveIndex(nextDateTime);
            const nextTimeIndex = archiveIndex.findIndex(
              ({ time }) => time === nextDateTime.slice(-8)
            );

            const handleIndexUpdate = (index, existingIndexValues = []) => {
              index.forEach((i) => {
                existingIndexValues.push(i);
              });
              return existingIndexValues;
            };

            window.hackerNewsState = {
              index: handleIndexUpdate(
                archiveIndex,
                window.hackerNewsState.index
              ),
              nextTimeIndex,
            };

            let currentTimeIndex = nextTimeIndex + 1;
            const items = Object.values(window.hackerNewsState.index);
            for (let item of items) {
              if (currentTimeIndex < window.hackerNewsState.index.length) {
                addNewsItem(items[currentTimeIndex], queue);

                currentTimeIndex = currentTimeIndex + 1;
              }
            }

            queue.flush();
          }
        };

        const archives = document.getElementById("archives");
        const archivesObserver = new IntersectionObserver(
          (entries) => {
            const queue = new UpdateQueue();

            entries.forEach((entry) => handleIntersectingEntry(entry, queue));
          },
          {
            root: null,
            rootMargin: "0px",
            threshold: 0,
          }
        );

        archivesObserver.observe(archives);

        let latestSectionsExpanded = true;
        const handleLatestHeaderClick = () => {
          latestSectionsExpanded = !latestSectionsExpanded;

          if (latestSectionsExpanded) {
            archivesObserver.observe(archives);
          } else {
            archivesObserver.disconnect(archives);
          }

          for (let section of document.querySelectorAll("#latest > section")) {
            section.style.display = latestSectionsExpanded ? "block" : "none";
          }
        };

        const latestHeader = document.querySelector("#latest > h2");
        latestHeader.style.cursor = "pointer";
        latestHeader.addEventListener("click", handleLatestHeaderClick);
      }
    </script>
    <script type="module">
      import { Workbox } from "https://storage.googleapis.com/workbox-cdn/releases/6.4.1/workbox-window.prod.mjs";

      if ("serviceWorker" in navigator) {
        const base = document.querySelector("base");
        const serviceWorkerPath = `${
          base ? base.href.replace(/\/$/, "") : ""
        }/service-worker.js`;

        const wb = new Workbox(serviceWorkerPath);

        // setup event listeners
        wb.addEventListener("waiting", (event) => {
          wb.addEventListener("controlling", () => {
            window.location.reload();
          });

          wb.messageSkipWaiting();
        });

        wb.register();
      }
    </script>
  </body>
</html>
