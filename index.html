<!DOCTYPE html>
<html lang="en" xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta charset="utf-8" />
    <meta
      content="width=device-width, initial-scale=1.0, viewport-fit=cover"
      name="viewport"
    />
    <meta name="description" content="Hacker News" />
    <meta name="theme-color" content="#fff" />
    <title>Hacker News</title>
    <link rel="manifest" href="manifest.json" />
    <link
      href="data:image/x-icon;base64,AAABAAEAAQECAAEAAQA4AAAAFgAAACgAAAABAAAAAgAAAAEAAQAAAAAAAAAAAAAAAAAAAAAAAAAAAAABAAEAAQECAAEAAQA4AAAAFgAAACgAAAABAAAAAgAAAAEAAQAAAAAAAAAAAAAAAAAAAAAAAAAA"
      rel="icon"
      type="image/x-icon"
    />
    <link
      href="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAgAAAAIAAQMAAADOtka5AAAAA1BMVEUAAACnej3aAAAANklEQVR42u3BAQEAAACCIP+vbkhAAQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAB8G4IAAAFjdVCkAAAAAElFTkSuQmCC"
      rel="apple-touch-icon"
    />
    <style>
      /*<!--*/
      body {
        color: rgb(25, 25, 25);
        font-family: Verdana, Geneva, sans-serif;
        margin: 0;
      }

      a {
        text-decoration: none;
      }

      a:link,
      a:focus,
      a:hover,
      a:active {
        color: rgb(75, 75, 125);
      }

      a:visited {
        color: rgb(25, 25, 25);
      }

      h1 > a,
      h1 > a:link,
      h1 > a:focus,
      h1 > a:hover,
      h1 > a:active,
      h1 > a:visited,
      h2 > a,
      h2 > a:link,
      h2 > a:focus,
      h2 > a:hover,
      h2 > a:active,
      h2 > a:visited {
        color: rgb(25, 25, 25);
      }

      h1 {
        background-color: rgb(255, 102, 0);
        margin: 0;
        padding: 1rem;
      }

      h2 {
        background-color: rgb(200, 200, 200);
        margin: 1rem 0;
        padding: 0.5rem 0.5rem 0.5rem 1rem;
      }

      #latest > section,
      #archives > section {
        margin: 0 1rem 1rem 1rem;
        padding-bottom: 1rem;
      }

      #latest > section:not(:last-child),
      #archives > section:not(:last-child) {
        border-bottom: 1px dotted rgb(200, 200, 200);
      }

      section > h3 {
        margin: 0 0 0.5rem 0;
      }

      section > h4 {
        font-weight: normal;
        margin: 0 0 0 1rem;
      }

      .descendants-container,
      .points-container {
        align-items: center;
        border-left: 1px solid #333;
        display: inline-flex;
        margin-left: 0.5rem;
        padding-left: 0.5rem;
        text-align: center;
      }

      .points {
        align-items: center;
        display: inline-flex;
        height: 1rem;
        margin-left: 1ch;
        min-width: 3ch;
      }

      .text {
        line-height: 1.5rem;
        margin: 1rem 1rem 0 1rem;
        overflow: auto;
      }

      .text > p:first-child {
        margin-top: 1rem;
      }

      .text > p:last-child {
        margin-bottom: 0;
      }
      /*-->*/
    </style>
  </head>

  <body>
    <main>
      <h1><a href="https://kherrick.github.io/hacker-news/">Hacker News</a></h1>
      <section id="latest">
        <h2>Latest</h2>
        <section id="35570782">
          <h3>
            <a
              class="item"
              href="https://twitter.com/trbrtc/status/1646592080293122067"
              >Investigators find Pentagon leaker through Instagram photo</a
            >
          </h3>
          <section>
            <h4>
              <span>2023-04-14 @ 15:40:11</span
              ><span class="points-container"
                >Points: <span class="points">23</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=35570782"
                  >Comments</a
                ><span class="descendants">: 51</span></span
              >
            </h4>
          </section>
        </section>
        <section id="35570758">
          <h3>
            <a class="item" href="https://database.dev"
              >dbdev - The Database Package Manager for PostgreSQL Trusted
              Language Extensions</a
            >
          </h3>
          <section>
            <h4>
              <span>2023-04-14 @ 15:38:38</span
              ><span class="points-container"
                >Points: <span class="points">30</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=35570758"
                  >Comments</a
                ><span class="descendants">: 8</span></span
              >
            </h4>
          </section>
        </section>
        <section id="35570742">
          <h3>
            <a
              class="item"
              href="https://ai.googleblog.com/2023/04/beyond-automatic-differentiation.html"
              >Beyond Automatic Differentiation</a
            >
          </h3>
          <section>
            <h4>
              <span>2023-04-14 @ 15:37:31</span
              ><span class="points-container"
                >Points: <span class="points">75</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=35570742"
                  >Comments</a
                ><span class="descendants">: 9</span></span
              >
            </h4>
          </section>
        </section>
        <section id="35570520">
          <h3>
            <a
              class="item"
              href="https://www.theverge.com/2023/4/14/23683240/spotify-shuts-down-heardle-music-guessing-game"
              >Spotify abandons Heardle less than a year after buying it</a
            >
          </h3>
          <section>
            <h4>
              <span>2023-04-14 @ 15:20:10</span
              ><span class="points-container"
                >Points: <span class="points">67</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=35570520"
                  >Comments</a
                ><span class="descendants">: 51</span></span
              >
            </h4>
          </section>
        </section>
        <section id="35570151">
          <h3>
            <a
              class="item"
              href="https://www.phoronix.com/news/AMD-openSIL-Detailed"
              >AMD Details OpenSIL for Advancing Open-Source System Firmware</a
            >
          </h3>
          <section>
            <h4>
              <span>2023-04-14 @ 14:47:29</span
              ><span class="points-container"
                >Points: <span class="points">42</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=35570151"
                  >Comments</a
                ><span class="descendants">: 6</span></span
              >
            </h4>
          </section>
        </section>
        <section id="35570027">
          <h3>
            <a
              class="item"
              href="https://news.livebook.dev/data-wrangling-in-elixir-with-explorer-the-power-of-rust-the-elegance-of-r---launch-week-1---day-5-1xqwCI"
              >Data wrangling in Elixir with Explorer, the power of Rust, the
              elegance of R</a
            >
          </h3>
          <section>
            <h4>
              <span>2023-04-14 @ 14:37:39</span
              ><span class="points-container"
                >Points: <span class="points">94</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=35570027"
                  >Comments</a
                ><span class="descendants">: 25</span></span
              >
            </h4>
          </section>
        </section>
        <section id="35569377">
          <h3>
            <a
              class="item"
              href="https://hackaday.com/2023/04/13/automated-shusher-keeps-conference-loudmouths-in-line/"
              >Automated shusher keeps conference loudmouths in line</a
            >
          </h3>
          <section>
            <h4>
              <span>2023-04-14 @ 13:32:00</span
              ><span class="points-container"
                >Points: <span class="points">18</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=35569377"
                  >Comments</a
                ><span class="descendants">: 20</span></span
              >
            </h4>
          </section>
        </section>
        <section id="35568799">
          <h3>
            <a class="item" href="https://www.debate-devil.com/en"
              >Show HN: Debate Devil – AI debating practice app</a
            >
          </h3>
          <section>
            <h4>
              <span>2023-04-14 @ 12:31:51</span
              ><span class="points-container"
                >Points: <span class="points">56</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=35568799"
                  >Comments</a
                ><span class="descendants">: 68</span></span
              >
            </h4>
            <div class="text">
              <a href="https://debate-devil.com">https://debate-devil.com</a>),
              an AI chat platform designed to help users practice debates,
              challenge their ideas, and expand their thinking. I created this
              site to provide a more objective opinion and help users consider
              their hypotheses from multiple perspectives.
              <p>
                example discussin: ``` AI: The time has come to test your
                hypothesis and beliefs. I will argue against any topic. What do
                you want to debate? You: AI will take away most jobs from
                humans.
              </p>
              <p>
                AI: I understand your concern about AI taking away jobs from
                humans. However, it's important to note that AI is not designed
                to replace humans but to augment and enhance human capabilities.
                AI can handle repetitive and mundane tasks, freeing up humans to
                focus on more complex and creative tasks that require empathy,
                critical thinking, and problem-solving skills. Additionally, the
                increased efficiency and productivity brought by AI can lead to
                the creation of new job opportunities in areas such as AI
                development and maintenance.
              </p>
              <p>
                You: While it's true that AI aims to augment human capabilities
                and increase efficiency, we cannot ignore the potential negative
                impacts on employment. Job displacement is a valid concern,
                especially for those in industries heavily reliant on routine
                tasks. Reskilling and upskilling may be necessary but can be
                challenging and costly. Additionally, new job opportunities in
                AI-related fields may not be accessible to everyone, leading to
                further social and economic disparities.
              </p>
              <p>
                AI: I agree that job displacement is a valid concern. However,
                it's important to note that technology has always been changing
                the job market, and AI is just the latest technology to do so.
                While some jobs may become obsolete, new jobs will be created in
                other areas. For example, the rise of e-commerce has led to a
                decline in brick-and-mortar retail jobs but at the same time,
                created new job opportunities in online retail and logistics. As
                for the issue of reskilling and upskilling, there are various
                resources available such as online courses, training programs,
                and apprenticeships to help workers acquire new skills to adapt
                to changing job requirements. It's also important for
                governments and companies to invest in retraining programs to
                ensure that workers have access to these resources.
              </p>
              <p>```</p>
              <p>
                example judge ``` I think AI is superior in what you discussed;
                AI focuses on AI's ability to extend human capabilities and
                points out that new employment opportunities may be created due
                to the increased efficiency and productivity that AI brings. On
                the other hand, you are concerned about job losses due to AI,
                but AI points out that past technological innovations have also
                changed the employment landscape and that new job opportunities
                can be created. You also indicate that resources exist for
                retraining and upskilling to address job losses due to AI, and
                state that it is important for governments and businesses to
                invest in these programs.
              </p>
              <p>```</p>
              <p>
                I'm eager to hear what the HN community thinks! Please give it a
                try and let me know your thoughts, feedback, and suggestions for
                improvement. Thanks for checking it out!
              </p>
            </div>
          </section>
        </section>
        <section id="35568512">
          <h3>
            <a
              class="item"
              href="https://phys.org/news/2023-04-decade-long-prehistoric-timeline-africa-million.html"
              >Prehistoric timeline in Africa pushed back by more than 10M
              years</a
            >
          </h3>
          <section>
            <h4>
              <span>2023-04-14 @ 12:01:28</span
              ><span class="points-container"
                >Points: <span class="points">52</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=35568512"
                  >Comments</a
                ><span class="descendants">: 16</span></span
              >
            </h4>
          </section>
        </section>
        <section id="35568388">
          <h3>
            <a class="item" href="https://www.esa.int/ESA_Multimedia/ESA_Web_TV"
              >Juice launch to Jupiter – Live [video]</a
            >
          </h3>
          <section>
            <h4>
              <span>2023-04-14 @ 11:49:00</span
              ><span class="points-container"
                >Points: <span class="points">148</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=35568388"
                  >Comments</a
                ><span class="descendants">: 19</span></span
              >
            </h4>
          </section>
        </section>
        <section id="35567822">
          <h3>
            <a class="item" href="https://news.ycombinator.com/item?id=35567822"
              >Ask HN: Side project of more that $2k monthly revenue what's your
              project?</a
            >
          </h3>
          <section>
            <h4>
              <span>2023-04-14 @ 10:35:03</span
              ><span class="points-container"
                >Points: <span class="points">284</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=35567822"
                  >Comments</a
                ><span class="descendants">: 284</span></span
              >
            </h4>
            <div class="text">
              <p>
                I am interested in knowing what business you run is it a mobile
                app, website, Saas?
              </p>
              <p>And how long it took you to reach $2k monthly revenue?</p>
            </div>
          </section>
        </section>
        <section id="35567709">
          <h3>
            <a
              class="item"
              href="https://variety.com/2023/music/news/universal-music-streaming-services-block-ai-1235582612/"
              >Universal Music Asks Streaming Services to Block AI Access to Its
              Songs</a
            >
          </h3>
          <section>
            <h4>
              <span>2023-04-14 @ 10:20:10</span
              ><span class="points-container"
                >Points: <span class="points">87</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=35567709"
                  >Comments</a
                ><span class="descendants">: 149</span></span
              >
            </h4>
          </section>
        </section>
        <section id="35567026">
          <h3>
            <a
              class="item"
              href="https://www.elbruz.org/special-projects/islands-and-lakes/"
              >Largest island in a lake on an island in a lake on an island</a
            >
          </h3>
          <section>
            <h4>
              <span>2023-04-14 @ 08:38:28</span
              ><span class="points-container"
                >Points: <span class="points">423</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=35567026"
                  >Comments</a
                ><span class="descendants">: 174</span></span
              >
            </h4>
          </section>
        </section>
        <section id="35566791">
          <h3>
            <a
              class="item"
              href="https://en.liujiacai.net/2023/04/13/zig-build-system/"
              >Zig Build System</a
            >
          </h3>
          <section>
            <h4>
              <span>2023-04-14 @ 08:05:13</span
              ><span class="points-container"
                >Points: <span class="points">131</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=35566791"
                  >Comments</a
                ><span class="descendants">: 81</span></span
              >
            </h4>
          </section>
        </section>
        <section id="35566768">
          <h3>
            <a
              class="item"
              href="https://codecodeship.com/blog/2023-04-14-mike-perham"
              >Mike Perham, Creator of Sidekiq: From Employment to
              Independence</a
            >
          </h3>
          <section>
            <h4>
              <span>2023-04-14 @ 08:02:05</span
              ><span class="points-container"
                >Points: <span class="points">110</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=35566768"
                  >Comments</a
                ><span class="descendants">: 38</span></span
              >
            </h4>
          </section>
        </section>
        <section id="35566315">
          <h3>
            <a
              class="item"
              href="https://www.tweag.io/blog/2023-04-13-crem-state-machines/"
              >Crem: Compositional Representable Executable Machines</a
            >
          </h3>
          <section>
            <h4>
              <span>2023-04-14 @ 06:48:18</span
              ><span class="points-container"
                >Points: <span class="points">49</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=35566315"
                  >Comments</a
                ><span class="descendants">: 2</span></span
              >
            </h4>
          </section>
        </section>
        <section id="35566145">
          <h3>
            <a
              class="item"
              href="https://www.nannyml.com/blog/91-of-ml-perfomance-degrade-in-time"
              >Temporal quality degradation in AI models</a
            >
          </h3>
          <section>
            <h4>
              <span>2023-04-14 @ 06:22:16</span
              ><span class="points-container"
                >Points: <span class="points">289</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=35566145"
                  >Comments</a
                ><span class="descendants">: 255</span></span
              >
            </h4>
          </section>
        </section>
        <section id="35565681">
          <h3>
            <a
              class="item"
              href="https://github.com/facebookresearch/AnimatedDrawings"
              >An open source AI tool to animate children's drawings</a
            >
          </h3>
          <section>
            <h4>
              <span>2023-04-14 @ 04:59:29</span
              ><span class="points-container"
                >Points: <span class="points">135</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=35565681"
                  >Comments</a
                ><span class="descendants">: 5</span></span
              >
            </h4>
          </section>
        </section>
        <section id="35565553">
          <h3>
            <a class="item" href="https://spectrum.ieee.org/moon-water"
              >Vast new stores of water reported on the moon</a
            >
          </h3>
          <section>
            <h4>
              <span>2023-04-14 @ 04:33:17</span
              ><span class="points-container"
                >Points: <span class="points">152</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=35565553"
                  >Comments</a
                ><span class="descendants">: 150</span></span
              >
            </h4>
          </section>
        </section>
        <section id="35565212">
          <h3>
            <a
              class="item"
              href="https://huyenchip.com/2023/04/11/llm-engineering.html"
              >Building LLM Applications for Production</a
            >
          </h3>
          <section>
            <h4>
              <span>2023-04-14 @ 03:30:10</span
              ><span class="points-container"
                >Points: <span class="points">195</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=35565212"
                  >Comments</a
                ><span class="descendants">: 79</span></span
              >
            </h4>
          </section>
        </section>
        <section id="35564908">
          <h3>
            <a
              class="item"
              href="https://lareviewofbooks.org/article/a-tale-of-literary-and-financial-debauchery-on-joel-warners-the-curse-of-the-marquis-de-sade/"
              >Joel Warner’s “The Curse of the Marquis de Sade”</a
            >
          </h3>
          <section>
            <h4>
              <span>2023-04-14 @ 02:40:55</span
              ><span class="points-container"
                >Points: <span class="points">7</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=35564908"
                  >Comments</a
                ><span class="descendants">: 1</span></span
              >
            </h4>
          </section>
        </section>
        <section id="35564874">
          <h3>
            <a
              class="item"
              href="https://github.com/riscv-collab/riscv-gnu-toolchain"
              >GNU toolchain for RISC-V including GCC</a
            >
          </h3>
          <section>
            <h4>
              <span>2023-04-14 @ 02:36:27</span
              ><span class="points-container"
                >Points: <span class="points">148</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=35564874"
                  >Comments</a
                ><span class="descendants">: 19</span></span
              >
            </h4>
          </section>
        </section>
        <section id="35561203">
          <h3>
            <a class="item" href="https://fairanimateddrawings.com/site/home"
              >Animated Drawings</a
            >
          </h3>
          <section>
            <h4>
              <span>2023-04-13 @ 19:51:37</span
              ><span class="points-container"
                >Points: <span class="points">776</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=35561203"
                  >Comments</a
                ><span class="descendants">: 69</span></span
              >
            </h4>
          </section>
        </section>
        <section id="35557848">
          <h3>
            <a
              class="item"
              href="https://lwn.net/SubscriberLink/928581/841b747332791ac4/"
              >The Early Days of Linux</a
            >
          </h3>
          <section>
            <h4>
              <span>2023-04-13 @ 16:19:26</span
              ><span class="points-container"
                >Points: <span class="points">205</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=35557848"
                  >Comments</a
                ><span class="descendants">: 33</span></span
              >
            </h4>
          </section>
        </section>
        <section id="35553167">
          <h3>
            <a
              class="item"
              href="https://arstechnica.com/gadgets/2023/04/revive-your-vintage-ibm-selectric-typewriter-with-3d-printable-golf-balls/"
              >DIY IBM Selectric type balls give ’60s typewriters new life (and
              Comic Sans)</a
            >
          </h3>
          <section>
            <h4>
              <span>2023-04-13 @ 09:51:09</span
              ><span class="points-container"
                >Points: <span class="points">65</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=35553167"
                  >Comments</a
                ><span class="descendants">: 35</span></span
              >
            </h4>
          </section>
        </section>
        <section id="35551929">
          <h3>
            <a
              class="item"
              href="https://www.freecodecamp.org/news/what-is-nmap-and-how-to-use-it-a-tutorial-for-the-greatest-scanning-tool-of-all-time/"
              >What is NMAP and how to use it? (2020)</a
            >
          </h3>
          <section>
            <h4>
              <span>2023-04-13 @ 06:46:15</span
              ><span class="points-container"
                >Points: <span class="points">106</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=35551929"
                  >Comments</a
                ><span class="descendants">: 32</span></span
              >
            </h4>
          </section>
        </section>
        <section id="35551549">
          <h3>
            <a
              class="item"
              href="https://www.tabletmag.com/sections/arts-letters/articles/odd-knight-cinnamon-shops-bruno-schulz"
              >The Odd Knight of the Cinnamon Shops</a
            >
          </h3>
          <section>
            <h4>
              <span>2023-04-13 @ 05:52:42</span
              ><span class="points-container"
                >Points: <span class="points">18</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=35551549"
                  >Comments</a
                ><span class="descendants">: 1</span></span
              >
            </h4>
          </section>
        </section>
        <section id="35549692">
          <h3>
            <a class="item" href="https://intuitiveexplanations.com/tech/kalyn"
              >Kalyn: A self-hosting compiler for x86-64</a
            >
          </h3>
          <section>
            <h4>
              <span>2023-04-13 @ 01:34:55</span
              ><span class="points-container"
                >Points: <span class="points">67</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=35549692"
                  >Comments</a
                ><span class="descendants">: 1</span></span
              >
            </h4>
          </section>
        </section>
        <section id="35537248">
          <h3>
            <a
              class="item"
              href="https://www.quantamagazine.org/primitive-asgard-cells-show-life-on-the-brink-of-complexity-20230411/"
              >Primitive Asgard cells show life on the brink of complexity</a
            >
          </h3>
          <section>
            <h4>
              <span>2023-04-12 @ 09:56:45</span
              ><span class="points-container"
                >Points: <span class="points">103</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=35537248"
                  >Comments</a
                ><span class="descendants">: 41</span></span
              >
            </h4>
          </section>
        </section>
        <section id="35532473">
          <h3>
            <a
              class="item"
              href="https://nymag.com/intelligencer/article/richard-walter-criminal-profiler-fraud.html"
              >The Case of the Fake Sherlock</a
            >
          </h3>
          <section>
            <h4>
              <span>2023-04-11 @ 22:25:25</span
              ><span class="points-container"
                >Points: <span class="points">58</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=35532473"
                  >Comments</a
                ><span class="descendants">: 11</span></span
              >
            </h4>
          </section>
        </section>
      </section>
      <section id="archives">
        <h2>
          <a
            href="https://github.com/kherrick/hacker-news/blob/main/archives/index.md"
            >Archives</a
          >
        </h2>
        <section>
          <h3>
            <a
              href="https://github.com/kherrick/hacker-news/blob/main/archives/2023/index.md"
              >2023</a
            >
          </h3>
        </section>
        <section>
          <h3>
            <a
              href="https://github.com/kherrick/hacker-news/blob/main/archives/2022/index.md"
              >2022</a
            >
          </h3>
        </section>
      </section>
    </main>
    <script type="module">
      import { buildDescendants } from "./lib/build-html-descendants.js";
      import { buildNextItem } from "./lib/build-html-next-item.js";
      import { getNextDateTime } from "./lib/date-time.js";

      const updateSectionById = (id) =>
        fetch(`https://hacker-news.firebaseio.com/v0/item/${id}.json`).then(
          (result) =>
            result.json().then(({ descendants, id, score, text, type }) => {
              const currentItem = document.getElementById(id);

              if (score) {
                currentItem.querySelector(".points").textContent = score;
              }

              if (descendants && (type === "poll" || type === "story")) {
                const currentDescendants =
                  currentItem.querySelector(".descendants");

                if (currentDescendants) {
                  currentDescendants.textContent = `: ${descendants}`;
                } else {
                  const comments = buildDescendants(
                    document,
                    descendants,
                    `https://news.ycombinator.com/item?id=${id}`
                  );

                  currentItem.querySelector("h4").appendChild(comments);
                }
              }

              if (text) {
                const currentText = currentItem.querySelector(".text");

                if (currentText) {
                  currentText.innerHTML = text.replace(/\0/g, "");
                } else {
                  const content = document.createElement("div");
                  content.innerHTML = text.replace(/\0/g, "");
                  content.setAttribute("class", "text");

                  currentItem.appendChild(content);
                }
              }
            })
        );

      class UpdateQueue {
        constructor() {
          this._ids = [];
          this._isUpdating = false;
        }

        addItemById(id) {
          this._ids.push(id);
        }

        async flush() {
          const id = this._ids.shift();

          if (id) {
            this._isUpdating = true;

            await updateSectionById(id);
            await this.flush();
          } else {
            this._isUpdating = false;

            setTimeout(async () => {
              if (!this._isUpdating && this._ids && this._ids.length) {
                await this.flush();
              }
            }, 0);
          }
        }
      }

      // get latest data
      const latestSection = document.getElementById("latest");

      for (let item of latestSection.querySelectorAll("section[id]")) {
        updateSectionById(item.getAttribute("id"));
      }

      if ("IntersectionObserver" in window) {
        window.hackerNewsState = { index: [], nextTimeIndex: -1 };

        const addNewsItem = async (newsItem, queue) => {
          try {
            const { date, time, itemComments, itemTitle, itemLink } = newsItem;
            const section = await buildNextItem({
              document,
              dateTime: `${date}, ${time}`,
              itemComments,
              itemLink,
              itemTitle: new DOMParser().parseFromString(
                itemTitle.replace(/\\/g, ""),
                "text/html"
              ).documentElement.textContent,
              fetchItemDetails: false,
            });

            // display loading indicator for section
            section.querySelector(".points-container").innerHTML =
              'Points: <span class="points"><img style="height: 100%;" src="lib/images/loading.svg" /></span>';

            const id = section.getAttribute("id");
            if (!document.getElementById(id)) {
              document.getElementById("latest").appendChild(section);

              queue.addItemById(id);
            }
          } catch (error) {}
        };

        const buildArchiveIndex = async (lastDateTime) => {
          const nextDate = lastDateTime.slice(0, 10);
          const nextYear = nextDate.slice(0, 4);

          return (
            await (
              await fetch(
                `https://raw.githubusercontent.com/kherrick/hacker-news/main/archives/${nextYear}/${nextDate}/index.md`
              )
            ).text()
          )
            .split("\n")
            .filter((line) => line.match(new RegExp("^\\* \\[")))
            .map((line) => {
              const segment = line.replace("* ", "").split("](");
              const pubDate = segment[0].slice(1);

              const itemComments = segment[1].split(") - [")[0];
              const itemTitle = segment[1].split(") - [")[1];
              const itemLink = segment[2].slice(0, -1);
              const date = pubDate.slice(0, 10);
              const time = pubDate.slice(-8);

              return {
                date,
                itemComments,
                itemLink,
                itemTitle,
                time,
              };
            });
        };

        const handleIntersectingEntry = async (entry, queue) => {
          if (entry.isIntersecting) {
            const lastDateTime = document
              .getElementById("latest")
              .querySelector(
                "section:last-child > section > h4 > span"
              ).textContent;

            const nextDateTime = getNextDateTime(lastDateTime ?? "", -1);
            const archiveIndex = await buildArchiveIndex(nextDateTime);
            const nextTimeIndex = archiveIndex.findIndex(
              ({ time }) => time === nextDateTime.slice(-8)
            );

            const handleIndexUpdate = (index, existingIndexValues = []) => {
              index.forEach((i) => {
                existingIndexValues.push(i);
              });
              return existingIndexValues;
            };

            window.hackerNewsState = {
              index: handleIndexUpdate(
                archiveIndex,
                window.hackerNewsState.index
              ),
              nextTimeIndex,
            };

            let currentTimeIndex = nextTimeIndex + 1;
            const items = Object.values(window.hackerNewsState.index);
            for (let item of items) {
              if (currentTimeIndex < window.hackerNewsState.index.length) {
                addNewsItem(items[currentTimeIndex], queue);

                currentTimeIndex = currentTimeIndex + 1;
              }
            }

            queue.flush();
          }
        };

        const archives = document.getElementById("archives");
        const archivesObserver = new IntersectionObserver(
          (entries) => {
            const queue = new UpdateQueue();

            entries.forEach((entry) => handleIntersectingEntry(entry, queue));
          },
          {
            root: null,
            rootMargin: "0px",
            threshold: 0,
          }
        );

        archivesObserver.observe(archives);

        let latestSectionsExpanded = true;
        const handleLatestHeaderClick = () => {
          latestSectionsExpanded = !latestSectionsExpanded;

          if (latestSectionsExpanded) {
            archivesObserver.observe(archives);
          } else {
            archivesObserver.disconnect(archives);
          }

          for (let section of document.querySelectorAll("#latest > section")) {
            section.style.display = latestSectionsExpanded ? "block" : "none";
          }
        };

        const latestHeader = document.querySelector("#latest > h2");
        latestHeader.style.cursor = "pointer";
        latestHeader.addEventListener("click", handleLatestHeaderClick);
      }
    </script>
    <script type="module">
      import { Workbox } from "https://storage.googleapis.com/workbox-cdn/releases/6.4.1/workbox-window.prod.mjs";

      if ("serviceWorker" in navigator) {
        const base = document.querySelector("base");
        const serviceWorkerPath = `${
          base ? base.href.replace(/\/$/, "") : ""
        }/service-worker.js`;

        const wb = new Workbox(serviceWorkerPath);

        // setup event listeners
        wb.addEventListener("waiting", (event) => {
          wb.addEventListener("controlling", () => {
            window.location.reload();
          });

          wb.messageSkipWaiting();
        });

        wb.register();
      }
    </script>
  </body>
</html>
