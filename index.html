<!DOCTYPE html>
<html lang="en" xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta charset="utf-8" />
    <meta
      content="width=device-width, initial-scale=1.0, viewport-fit=cover"
      name="viewport"
    />
    <meta name="description" content="Hacker News" />
    <meta name="theme-color" content="#fff" />
    <title>Hacker News</title>
    <link rel="manifest" href="manifest.json" />
    <link
      href="data:image/x-icon;base64,AAABAAEAAQECAAEAAQA4AAAAFgAAACgAAAABAAAAAgAAAAEAAQAAAAAAAAAAAAAAAAAAAAAAAAAAAAABAAEAAQECAAEAAQA4AAAAFgAAACgAAAABAAAAAgAAAAEAAQAAAAAAAAAAAAAAAAAAAAAAAAAA"
      rel="icon"
      type="image/x-icon"
    />
    <link
      href="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAgAAAAIAAQMAAADOtka5AAAAA1BMVEUAAACnej3aAAAANklEQVR42u3BAQEAAACCIP+vbkhAAQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAB8G4IAAAFjdVCkAAAAAElFTkSuQmCC"
      rel="apple-touch-icon"
    />
    <style>
      /*<!--*/
      body {
        color: rgb(25, 25, 25);
        font-family: Verdana, Geneva, sans-serif;
        margin: 0;
      }

      a {
        text-decoration: none;
      }

      a:link,
      a:focus,
      a:hover,
      a:active {
        color: rgb(75, 75, 125);
      }

      a:visited {
        color: rgb(25, 25, 25);
      }

      h1 > a,
      h1 > a:link,
      h1 > a:focus,
      h1 > a:hover,
      h1 > a:active,
      h1 > a:visited,
      h2 > a,
      h2 > a:link,
      h2 > a:focus,
      h2 > a:hover,
      h2 > a:active,
      h2 > a:visited {
        color: rgb(25, 25, 25);
      }

      h1 {
        background-color: rgb(255, 102, 0);
        margin: 0;
        padding: 1rem;
      }

      h2 {
        background-color: rgb(200, 200, 200);
        margin: 1rem 0;
        padding: 0.5rem 0.5rem 0.5rem 1rem;
      }

      #latest > section,
      #archives > section {
        margin: 0 1rem 1rem 1rem;
        padding-bottom: 1rem;
      }

      #latest > section:not(:last-child),
      #archives > section:not(:last-child) {
        border-bottom: 1px dotted rgb(200, 200, 200);
      }

      section > h3 {
        margin: 0 0 0.5rem 0;
      }

      section > h4 {
        font-weight: normal;
        margin: 0 0 0 1rem;
      }

      .descendants-container,
      .points-container {
        align-items: center;
        border-left: 1px solid #333;
        display: inline-flex;
        margin-left: 0.5rem;
        padding-left: 0.5rem;
        text-align: center;
      }

      .points {
        align-items: center;
        display: inline-flex;
        height: 1rem;
        margin-left: 1ch;
        min-width: 3ch;
      }

      .text {
        line-height: 1.5rem;
        margin: 1rem 1rem 0 1rem;
        overflow: auto;
      }

      .text > p:first-child {
        margin-top: 1rem;
      }

      .text > p:last-child {
        margin-bottom: 0;
      }
      /*-->*/
    </style>
  </head>

  <body>
    <main>
      <h1><a href="https://kherrick.github.io/hacker-news/">Hacker News</a></h1>
      <section id="latest">
        <h2>Latest</h2>
        <section id="37159338">
          <h3>
            <a
              class="item"
              href="https://vadimkravcenko.com/shorts/managing-bad-engineers/"
              >Managing Difficult Software Engineers</a
            >
          </h3>
          <section>
            <h4>
              <span>2023-08-17 @ 09:44:26</span
              ><span class="points-container"
                >Points: <span class="points">65</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=37159338"
                  >Comments</a
                ><span class="descendants">: 57</span></span
              >
            </h4>
          </section>
        </section>
        <section id="37158827">
          <h3>
            <a class="item" href="https://anoopdixith.com/disasters/"
              >Software Engineering Lessons from RCAs of greatest disasters</a
            >
          </h3>
          <section>
            <h4>
              <span>2023-08-17 @ 08:38:30</span
              ><span class="points-container"
                >Points: <span class="points">38</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=37158827"
                  >Comments</a
                ><span class="descendants">: 21</span></span
              >
            </h4>
          </section>
        </section>
        <section id="37158745">
          <h3>
            <a
              class="item"
              href="https://hackaday.com/2020/02/20/we-ruined-status-leds-heres-why-that-needs-to-change/"
              >We Ruined Status LEDs; Here’s Why That Needs to Change</a
            >
          </h3>
          <section>
            <h4>
              <span>2023-08-17 @ 08:27:30</span
              ><span class="points-container"
                >Points: <span class="points">48</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=37158745"
                  >Comments</a
                ><span class="descendants">: 48</span></span
              >
            </h4>
          </section>
        </section>
        <section id="37158605">
          <h3>
            <a
              class="item"
              href="https://www.medrxiv.org/content/10.1101/2023.08.06.23293706v1"
              >Long Covid in a highly vaccinated population – Australia, 2022</a
            >
          </h3>
          <section>
            <h4>
              <span>2023-08-17 @ 08:08:33</span
              ><span class="points-container"
                >Points: <span class="points">30</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=37158605"
                  >Comments</a
                ><span class="descendants">: 13</span></span
              >
            </h4>
          </section>
        </section>
        <section id="37158317">
          <h3>
            <a
              class="item"
              href="https://www.fourbardesign.com/2020/10/diy-espresso.html"
              >DIY Espresso (2020)</a
            >
          </h3>
          <section>
            <h4>
              <span>2023-08-17 @ 07:21:40</span
              ><span class="points-container"
                >Points: <span class="points">97</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=37158317"
                  >Comments</a
                ><span class="descendants">: 33</span></span
              >
            </h4>
          </section>
        </section>
        <section id="37158068">
          <h3>
            <a
              class="item"
              href="https://medium.com/dartlang/dart-3-1-a-retrospective-on-functional-style-programming-in-dart-3-a1f4b3a7cdda"
              >Dart 3.1 and a retrospective on functional style programming in
              Dart</a
            >
          </h3>
          <section>
            <h4>
              <span>2023-08-17 @ 06:46:30</span
              ><span class="points-container"
                >Points: <span class="points">62</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=37158068"
                  >Comments</a
                ><span class="descendants">: 68</span></span
              >
            </h4>
          </section>
        </section>
        <section id="37157989">
          <h3>
            <a class="item" href="https://text.npr.org/1194202562"
              >New York Times considers legal action against OpenAI as copyright
              tensions swirl</a
            >
          </h3>
          <section>
            <h4>
              <span>2023-08-17 @ 06:33:18</span
              ><span class="points-container"
                >Points: <span class="points">106</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=37157989"
                  >Comments</a
                ><span class="descendants">: 110</span></span
              >
            </h4>
          </section>
        </section>
        <section id="37157552">
          <h3>
            <a
              class="item"
              href="https://wingolog.org/archives/2023/03/20/a-world-to-win-webassembly-for-the-rest-of-us"
              >A world to win: WebAssembly for the rest of us</a
            >
          </h3>
          <section>
            <h4>
              <span>2023-08-17 @ 05:19:31</span
              ><span class="points-container"
                >Points: <span class="points">75</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=37157552"
                  >Comments</a
                ><span class="descendants">: 56</span></span
              >
            </h4>
          </section>
        </section>
        <section id="37157323">
          <h3>
            <a class="item" href="https://github.com/mr-gpt/deepeval"
              >DeepEval – Unit Testing for LLMs</a
            >
          </h3>
          <section>
            <h4>
              <span>2023-08-17 @ 04:42:38</span
              ><span class="points-container"
                >Points: <span class="points">52</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=37157323"
                  >Comments</a
                ><span class="descendants">: 21</span></span
              >
            </h4>
          </section>
        </section>
        <section id="37156842">
          <h3>
            <a
              class="item"
              href="https://stefanabikaram.com/blog/mastermind-solver/"
              >Mastermind Solver</a
            >
          </h3>
          <section>
            <h4>
              <span>2023-08-17 @ 03:33:41</span
              ><span class="points-container"
                >Points: <span class="points">11</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=37156842"
                  >Comments</a
                ><span class="descendants">: 6</span></span
              >
            </h4>
          </section>
        </section>
        <section id="37156425">
          <h3>
            <a
              class="item"
              href="https://www.atlasobscura.com/articles/anti-vampire-graves-poland"
              >Poland’s ‘anti-vampire’ graves</a
            >
          </h3>
          <section>
            <h4>
              <span>2023-08-17 @ 02:24:57</span
              ><span class="points-container"
                >Points: <span class="points">66</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=37156425"
                  >Comments</a
                ><span class="descendants">: 32</span></span
              >
            </h4>
          </section>
        </section>
        <section id="37156373">
          <h3>
            <a class="item" href="https://arxiv.org/abs/2308.02712"
              >A search for technosignatures around nearby stars</a
            >
          </h3>
          <section>
            <h4>
              <span>2023-08-17 @ 02:18:15</span
              ><span class="points-container"
                >Points: <span class="points">88</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=37156373"
                  >Comments</a
                ><span class="descendants">: 130</span></span
              >
            </h4>
          </section>
        </section>
        <section id="37156372">
          <h3>
            <a class="item" href="https://news.ycombinator.com/item?id=37156372"
              >Ask HN: Any interesting books you have read lately?</a
            >
          </h3>
          <section>
            <h4>
              <span>2023-08-17 @ 02:18:00</span
              ><span class="points-container"
                >Points: <span class="points">194</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=37156372"
                  >Comments</a
                ><span class="descendants">: 242</span></span
              >
            </h4>
            <div class="text">
              <p>
                [1]:
                <a href="https://stallman.org/Bob-Chassell"
                  >https://stallman.org/Bob-Chassell</a
                >
              </p>
            </div>
          </section>
        </section>
        <section id="37156337">
          <h3>
            <a class="item" href="https://www.youtube.com/watch?v=lvvzolKHt2E"
              >Unit: A visual programming system [video]</a
            >
          </h3>
          <section>
            <h4>
              <span>2023-08-17 @ 02:13:25</span
              ><span class="points-container"
                >Points: <span class="points">68</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=37156337"
                  >Comments</a
                ><span class="descendants">: 14</span></span
              >
            </h4>
          </section>
        </section>
        <section id="37155752">
          <h3>
            <a
              class="item"
              href="https://thechipletter.substack.com/p/captain-zilog-crushed-the-story-of"
              >Captain Zilog Crushed: The Story of the Z8000</a
            >
          </h3>
          <section>
            <h4>
              <span>2023-08-17 @ 00:42:50</span
              ><span class="points-container"
                >Points: <span class="points">72</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=37155752"
                  >Comments</a
                ><span class="descendants">: 27</span></span
              >
            </h4>
          </section>
        </section>
        <section id="37155657">
          <h3>
            <a class="item" href="https://www.youtube.com/watch?v=nwfFBUVxpac"
              >A charged battery won't bounce but partially discharged one will
              (2015) [video]</a
            >
          </h3>
          <section>
            <h4>
              <span>2023-08-17 @ 00:25:46</span
              ><span class="points-container"
                >Points: <span class="points">67</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=37155657"
                  >Comments</a
                ><span class="descendants">: 52</span></span
              >
            </h4>
          </section>
        </section>
        <section id="37155574">
          <h3>
            <a
              class="item"
              href="https://nso.group/@haifisch/110901720830132689#."
              >QR codes appearing in Google street view?</a
            >
          </h3>
          <section>
            <h4>
              <span>2023-08-17 @ 00:12:48</span
              ><span class="points-container"
                >Points: <span class="points">187</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=37155574"
                  >Comments</a
                ><span class="descendants">: 57</span></span
              >
            </h4>
          </section>
        </section>
        <section id="37155241">
          <h3>
            <a
              class="item"
              href="https://terraformindustries.wordpress.com/2023/08/16/how-to-produce-green-hydrogen-for-1-kg/"
              >How to Produce Green Hydrogen for $1/Kg</a
            >
          </h3>
          <section>
            <h4>
              <span>2023-08-16 @ 23:28:17</span
              ><span class="points-container"
                >Points: <span class="points">125</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=37155241"
                  >Comments</a
                ><span class="descendants">: 199</span></span
              >
            </h4>
          </section>
        </section>
        <section id="37155080">
          <h3>
            <a
              class="item"
              href="https://huyenchip.com/2023/08/16/llm-research-open-challenges.html"
              >Open Challenges in LLM Research</a
            >
          </h3>
          <section>
            <h4>
              <span>2023-08-16 @ 23:08:11</span
              ><span class="points-container"
                >Points: <span class="points">126</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=37155080"
                  >Comments</a
                ><span class="descendants">: 52</span></span
              >
            </h4>
          </section>
        </section>
        <section id="37154939">
          <h3>
            <a
              class="item"
              href="https://community.intel.com/t5/Blogs/Tech-Innovation/Artificial-Intelligence-AI/Intel-QuickAssist-Technology-Zstandard-Plugin-an-External/post/1509818"
              >Intel QuickAssist Technology Zstandard Plugin for Zstandard</a
            >
          </h3>
          <section>
            <h4>
              <span>2023-08-16 @ 22:52:56</span
              ><span class="points-container"
                >Points: <span class="points">121</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=37154939"
                  >Comments</a
                ><span class="descendants">: 50</span></span
              >
            </h4>
          </section>
        </section>
        <section id="37154395">
          <h3>
            <a class="item" href="https://github.com/j2kun/mlir-tutorial"
              >MLIR For Beginners: A series of articles on the MLIR framework</a
            >
          </h3>
          <section>
            <h4>
              <span>2023-08-16 @ 21:53:20</span
              ><span class="points-container"
                >Points: <span class="points">105</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=37154395"
                  >Comments</a
                ><span class="descendants">: 38</span></span
              >
            </h4>
          </section>
        </section>
        <section id="37154138">
          <h3>
            <a class="item" href="https://github.com/ubicloud/ubicloud"
              >Ubicloud – open, free and portable cloud</a
            >
          </h3>
          <section>
            <h4>
              <span>2023-08-16 @ 21:31:10</span
              ><span class="points-container"
                >Points: <span class="points">181</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=37154138"
                  >Comments</a
                ><span class="descendants">: 90</span></span
              >
            </h4>
          </section>
        </section>
        <section id="37153862">
          <h3>
            <a
              class="item"
              href="https://gist.github.com/sharadhr/39b804236c1941e9c30d90af828ad41e"
              >$HOME, not so sweet $HOME</a
            >
          </h3>
          <section>
            <h4>
              <span>2023-08-16 @ 21:08:01</span
              ><span class="points-container"
                >Points: <span class="points">181</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=37153862"
                  >Comments</a
                ><span class="descendants">: 177</span></span
              >
            </h4>
          </section>
        </section>
        <section id="37150843">
          <h3>
            <a
              class="item"
              href="https://thecritic.co.uk/issues/august-september-2023/a-brilliant-biography-of-an-elusive-genius/"
              >Spinoza: Life and Legacy</a
            >
          </h3>
          <section>
            <h4>
              <span>2023-08-16 @ 17:48:43</span
              ><span class="points-container"
                >Points: <span class="points">79</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=37150843"
                  >Comments</a
                ><span class="descendants">: 20</span></span
              >
            </h4>
          </section>
        </section>
        <section id="37149349">
          <h3>
            <a
              class="item"
              href="https://www.nature.com/articles/d41586-023-02585-7"
              >LK-99 isn’t a superconductor</a
            >
          </h3>
          <section>
            <h4>
              <span>2023-08-16 @ 16:17:17</span
              ><span class="points-container"
                >Points: <span class="points">1779</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=37149349"
                  >Comments</a
                ><span class="descendants">: 609</span></span
              >
            </h4>
          </section>
        </section>
        <section id="37147140">
          <h3>
            <a class="item" href="https://github.com/marqo-ai/marqo"
              >Show HN: Marqo – Vectorless Vector Search</a
            >
          </h3>
          <section>
            <h4>
              <span>2023-08-16 @ 14:01:22</span
              ><span class="points-container"
                >Points: <span class="points">31</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=37147140"
                  >Comments</a
                ><span class="descendants">: 10</span></span
              >
            </h4>
            <div class="text">
              <p>mq = marqo.Client()</p>
              <p>mq.create_index("my-first-index")</p>
              <p>
                mq.index("my-first-index").add_documents([{"title": "The Travels
                of Marco Polo"}])
              </p>
              <p>results = mq.index("my-first-index").search(q="Marqo Polo")</p>
              <p>
                Why Marqo? Vector similarity alone is not enough for vector
                search. Vector search requires more than a vector database - it
                also requires machine learning (ML) deployment and management,
                preprocessing and transformations of inputs as well as the
                ability to modify search behavior without retraining a model.
                Marqo contains all these pieces, enabling developers to build
                vector search into their application with minimal effort.
              </p>
              <p>
                Why not X, Y, Z vector database? Vector databases are
                specialized components for vector similarity. They are “vectors
                in - vectors out”. They still require the production of vectors,
                management of the ML models, associated orchestration and
                processing of the inputs. Marqo makes this easy by being
                “documents in, documents out”. Preprocessing of text and images,
                embedding the content, storing meta-data and deployment of
                inference and storage is all taken care of by Marqo. We have
                been running Marqo for production workloads with both
                low-latency and large index requirements.
              </p>
              <p>Marqo features:</p>
              <p>
                - Low-latency (10’s ms - configuration dependent), large scale
                (10’s - 100’s M vectors). - Easily integrates with LLM’s and
                other generative AI - augmented generation using a knowledge
                base. - Pre-configured open source embedding models - SBERT,
                Huggingface, CLIP/OpenCLIP. - Pre-filtering and lexical search.
                - Multimodal model support - search text and/or images. - Custom
                models - load models fine tuned from your own data. - Ranking
                with document meta data - bias the similarity with properties
                like popularity. - Multi-term multi-modal queries - allows per
                query personalization and topic avoidance. - Multi-modal
                representations - search over documents that have both text and
                images. - GPU/CPU/ONNX/PyTorch inference support.
              </p>
              <p>See some examples here:</p>
              <p>
                Multimodal search: [1]
                <a
                  href="https://www.marqo.ai/blog/context-is-all-you-need-multimodal-vector-search-with-personalization"
                  >https://www.marqo.ai/blog/context-is-all-you-need-multimodal...</a
                >
              </p>
              <p>
                Refining image quality and identifying unwanted content: [2]
                <a
                  href="https://www.marqo.ai/blog/refining-image-quality-and-eliminating-nsfw-content-with-marqo"
                  >https://www.marqo.ai/blog/refining-image-quality-and-elimina...</a
                >
              </p>
              <p>
                Question answering over transcripts of speech: [3]
                <a href="https://www.marqo.ai/blog/speech-processing"
                  >https://www.marqo.ai/blog/speech-processing</a
                >
              </p>
              <p>
                Question and answering over technical documents and augmenting
                NPC's with a backstory: [4]
                <a
                  href="https://www.marqo.ai/blog/from-iron-manual-to-ironman-augmenting-gpt-with-marqo-for-fast-editable-memory-to-enable-context-aware-question-answering"
                  >https://www.marqo.ai/blog/from-iron-manual-to-ironman-augmen...</a
                >
              </p>
            </div>
          </section>
        </section>
        <section id="37145195">
          <h3>
            <a
              class="item"
              href="https://martypc.blogspot.com/2023/08/the-8088-prefetch-algorithm.html"
              >The 8088 Prefetch Algorithm</a
            >
          </h3>
          <section>
            <h4>
              <span>2023-08-16 @ 10:51:23</span
              ><span class="points-container"
                >Points: <span class="points">57</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=37145195"
                  >Comments</a
                ><span class="descendants">: 5</span></span
              >
            </h4>
          </section>
        </section>
        <section id="37144985">
          <h3>
            <a
              class="item"
              href="https://htmx.org/posts/2023-06-06-htmx-github-accelerator/"
              >Htmx is part of the GitHub Accelerator</a
            >
          </h3>
          <section>
            <h4>
              <span>2023-08-16 @ 10:19:32</span
              ><span class="points-container"
                >Points: <span class="points">990</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=37144985"
                  >Comments</a
                ><span class="descendants">: 447</span></span
              >
            </h4>
          </section>
        </section>
        <section id="37138083">
          <h3>
            <a
              class="item"
              href="https://www.sciencenews.org/article/viking-age-ancient-solar-flare-trade-archaeology"
              >An ancient solar flare illuminated the start of the Viking Age</a
            >
          </h3>
          <section>
            <h4>
              <span>2023-08-15 @ 19:18:12</span
              ><span class="points-container"
                >Points: <span class="points">49</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=37138083"
                  >Comments</a
                ><span class="descendants">: 10</span></span
              >
            </h4>
          </section>
        </section>
        <section id="37131232">
          <h3>
            <a
              class="item"
              href="https://blog.toasterthoughts.eu/posts/song-solver/"
              >Shazam for Singing</a
            >
          </h3>
          <section>
            <h4>
              <span>2023-08-15 @ 07:34:50</span
              ><span class="points-container"
                >Points: <span class="points">63</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=37131232"
                  >Comments</a
                ><span class="descendants">: 20</span></span
              >
            </h4>
          </section>
        </section>
      </section>
      <section id="archives">
        <h2>
          <a
            href="https://github.com/kherrick/hacker-news/blob/main/archives/index.md"
            >Archives</a
          >
        </h2>
        <section>
          <h3>
            <a
              href="https://github.com/kherrick/hacker-news/blob/main/archives/2023/index.md"
              >2023</a
            >
          </h3>
        </section>
        <section>
          <h3>
            <a
              href="https://github.com/kherrick/hacker-news/blob/main/archives/2022/index.md"
              >2022</a
            >
          </h3>
        </section>
      </section>
    </main>
    <script type="module">
      import { buildDescendants } from "./lib/build-html-descendants.js";
      import { buildNextItem } from "./lib/build-html-next-item.js";
      import { getNextDateTime } from "./lib/date-time.js";

      const updateSectionById = (id) =>
        fetch(`https://hacker-news.firebaseio.com/v0/item/${id}.json`).then(
          (result) =>
            result.json().then(({ descendants, id, score, text, type }) => {
              const currentItem = document.getElementById(id);

              if (score) {
                currentItem.querySelector(".points").textContent = score;
              }

              if (descendants && (type === "poll" || type === "story")) {
                const currentDescendants =
                  currentItem.querySelector(".descendants");

                if (currentDescendants) {
                  currentDescendants.textContent = `: ${descendants}`;
                } else {
                  const comments = buildDescendants(
                    document,
                    descendants,
                    `https://news.ycombinator.com/item?id=${id}`
                  );

                  currentItem.querySelector("h4").appendChild(comments);
                }
              }

              if (text) {
                const currentText = currentItem.querySelector(".text");

                if (currentText) {
                  currentText.innerHTML = text.replace(/\0/g, "");
                } else {
                  const content = document.createElement("div");
                  content.innerHTML = text.replace(/\0/g, "");
                  content.setAttribute("class", "text");

                  currentItem.appendChild(content);
                }
              }
            })
        );

      class UpdateQueue {
        constructor() {
          this._ids = [];
          this._isUpdating = false;
        }

        addItemById(id) {
          this._ids.push(id);
        }

        async flush() {
          const id = this._ids.shift();

          if (id) {
            this._isUpdating = true;

            await updateSectionById(id);
            await this.flush();
          } else {
            this._isUpdating = false;

            setTimeout(async () => {
              if (!this._isUpdating && this._ids && this._ids.length) {
                await this.flush();
              }
            }, 0);
          }
        }
      }

      // get latest data
      const latestSection = document.getElementById("latest");

      for (let item of latestSection.querySelectorAll("section[id]")) {
        updateSectionById(item.getAttribute("id"));
      }

      if ("IntersectionObserver" in window) {
        window.hackerNewsState = { index: [], nextTimeIndex: -1 };

        const addNewsItem = async (newsItem, queue) => {
          try {
            const { date, time, itemComments, itemTitle, itemLink } = newsItem;
            const section = await buildNextItem({
              document,
              dateTime: `${date}, ${time}`,
              itemComments,
              itemLink,
              itemTitle: new DOMParser().parseFromString(
                itemTitle.replace(/\\/g, ""),
                "text/html"
              ).documentElement.textContent,
              fetchItemDetails: false,
            });

            // display loading indicator for section
            section.querySelector(".points-container").innerHTML =
              'Points: <span class="points"><img style="height: 100%;" src="lib/images/loading.svg" /></span>';

            const id = section.getAttribute("id");
            if (!document.getElementById(id)) {
              document.getElementById("latest").appendChild(section);

              queue.addItemById(id);
            }
          } catch (error) {}
        };

        const buildArchiveIndex = async (lastDateTime) => {
          const nextDate = lastDateTime.slice(0, 10);
          const nextYear = nextDate.slice(0, 4);

          return (
            await (
              await fetch(
                `https://raw.githubusercontent.com/kherrick/hacker-news/main/archives/${nextYear}/${nextDate}/index.md`
              )
            ).text()
          )
            .split("\n")
            .filter((line) => line.match(new RegExp("^\\* \\[")))
            .map((line) => {
              const segment = line.replace("* ", "").split("](");
              const pubDate = segment[0].slice(1);

              const itemComments = segment[1].split(") - [")[0];
              const itemTitle = segment[1].split(") - [")[1];
              const itemLink = segment[2].slice(0, -1);
              const date = pubDate.slice(0, 10);
              const time = pubDate.slice(-8);

              return {
                date,
                itemComments,
                itemLink,
                itemTitle,
                time,
              };
            });
        };

        const handleIntersectingEntry = async (entry, queue) => {
          if (entry.isIntersecting) {
            const lastDateTime = document
              .getElementById("latest")
              .querySelector(
                "section:last-child > section > h4 > span"
              ).textContent;

            const nextDateTime = getNextDateTime(lastDateTime ?? "", -1);
            const archiveIndex = await buildArchiveIndex(nextDateTime);
            const nextTimeIndex = archiveIndex.findIndex(
              ({ time }) => time === nextDateTime.slice(-8)
            );

            const handleIndexUpdate = (index, existingIndexValues = []) => {
              index.forEach((i) => {
                existingIndexValues.push(i);
              });
              return existingIndexValues;
            };

            window.hackerNewsState = {
              index: handleIndexUpdate(
                archiveIndex,
                window.hackerNewsState.index
              ),
              nextTimeIndex,
            };

            let currentTimeIndex = nextTimeIndex + 1;
            const items = Object.values(window.hackerNewsState.index);
            for (let item of items) {
              if (currentTimeIndex < window.hackerNewsState.index.length) {
                addNewsItem(items[currentTimeIndex], queue);

                currentTimeIndex = currentTimeIndex + 1;
              }
            }

            queue.flush();
          }
        };

        const archives = document.getElementById("archives");
        const archivesObserver = new IntersectionObserver(
          (entries) => {
            const queue = new UpdateQueue();

            entries.forEach((entry) => handleIntersectingEntry(entry, queue));
          },
          {
            root: null,
            rootMargin: "0px",
            threshold: 0,
          }
        );

        archivesObserver.observe(archives);

        let latestSectionsExpanded = true;
        const handleLatestHeaderClick = () => {
          latestSectionsExpanded = !latestSectionsExpanded;

          if (latestSectionsExpanded) {
            archivesObserver.observe(archives);
          } else {
            archivesObserver.disconnect(archives);
          }

          for (let section of document.querySelectorAll("#latest > section")) {
            section.style.display = latestSectionsExpanded ? "block" : "none";
          }
        };

        const latestHeader = document.querySelector("#latest > h2");
        latestHeader.style.cursor = "pointer";
        latestHeader.addEventListener("click", handleLatestHeaderClick);
      }
    </script>
    <script type="module">
      import { Workbox } from "https://storage.googleapis.com/workbox-cdn/releases/6.4.1/workbox-window.prod.mjs";

      if ("serviceWorker" in navigator) {
        const base = document.querySelector("base");
        const serviceWorkerPath = `${
          base ? base.href.replace(/\/$/, "") : ""
        }/service-worker.js`;

        const wb = new Workbox(serviceWorkerPath);

        // setup event listeners
        wb.addEventListener("waiting", (event) => {
          wb.addEventListener("controlling", () => {
            window.location.reload();
          });

          wb.messageSkipWaiting();
        });

        wb.register();
      }
    </script>
  </body>
</html>
