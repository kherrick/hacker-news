<!DOCTYPE html>
<html lang="en" xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta charset="utf-8" />
    <meta
      content="width=device-width, initial-scale=1.0, viewport-fit=cover"
      name="viewport"
    />
    <meta name="description" content="Hacker News" />
    <meta name="theme-color" content="#fff" />
    <title>Hacker News</title>
    <link rel="manifest" href="manifest.json" />
    <link
      href="data:image/x-icon;base64,AAABAAEAAQECAAEAAQA4AAAAFgAAACgAAAABAAAAAgAAAAEAAQAAAAAAAAAAAAAAAAAAAAAAAAAAAAABAAEAAQECAAEAAQA4AAAAFgAAACgAAAABAAAAAgAAAAEAAQAAAAAAAAAAAAAAAAAAAAAAAAAA"
      rel="icon"
      type="image/x-icon"
    />
    <link
      href="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAgAAAAIAAQMAAADOtka5AAAAA1BMVEUAAACnej3aAAAANklEQVR42u3BAQEAAACCIP+vbkhAAQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAB8G4IAAAFjdVCkAAAAAElFTkSuQmCC"
      rel="apple-touch-icon"
    />
    <style>
      /*<!--*/
      body {
        color: rgb(25, 25, 25);
        font-family: Verdana, Geneva, sans-serif;
        margin: 0;
      }

      a {
        text-decoration: none;
      }

      a:link,
      a:focus,
      a:hover,
      a:active {
        color: rgb(75, 75, 125);
      }

      a:visited {
        color: rgb(25, 25, 25);
      }

      h1 > a,
      h1 > a:link,
      h1 > a:focus,
      h1 > a:hover,
      h1 > a:active,
      h1 > a:visited,
      h2 > a,
      h2 > a:link,
      h2 > a:focus,
      h2 > a:hover,
      h2 > a:active,
      h2 > a:visited {
        color: rgb(25, 25, 25);
      }

      h1 {
        background-color: rgb(255, 102, 0);
        margin: 0;
        padding: 1rem;
      }

      h2 {
        background-color: rgb(200, 200, 200);
        margin: 1rem 0;
        padding: 0.5rem 0.5rem 0.5rem 1rem;
      }

      #latest > section,
      #archives > section {
        margin: 0 1rem 1rem 1rem;
        padding-bottom: 1rem;
      }

      #latest > section:not(:last-child),
      #archives > section:not(:last-child) {
        border-bottom: 1px dotted rgb(200, 200, 200);
      }

      section > h3 {
        margin: 0 0 0.5rem 0;
      }

      section > h4 {
        font-weight: normal;
        margin: 0 0 0 1rem;
      }

      .descendants-container,
      .points-container {
        align-items: center;
        border-left: 1px solid #333;
        display: inline-flex;
        margin-left: 0.5rem;
        padding-left: 0.5rem;
        text-align: center;
      }

      .points {
        align-items: center;
        display: inline-flex;
        height: 1rem;
        margin-left: 1ch;
        min-width: 3ch;
      }

      .text {
        line-height: 1.5rem;
        margin: 1rem 1rem 0 1rem;
        overflow: auto;
      }

      .text > p:first-child {
        margin-top: 1rem;
      }

      .text > p:last-child {
        margin-bottom: 0;
      }
      /*-->*/
    </style>
  </head>

  <body>
    <main>
      <h1><a href="https://kherrick.github.io/hacker-news/">Hacker News</a></h1>
      <section id="latest">
        <h2>Latest</h2>
        <section id="43724267">
          <h3>
            <a
              class="item"
              href="https://prospect.org/power/2025-04-17-intuit-turbotax-wins-battle-against-taxpayers-irs-direct-file/"
              >Intuit, Owner of TurboTax, Wins Battle Against America's
              Taxpayers</a
            >
          </h3>
          <section>
            <h4>
              <span>2025-04-18 @ 02:13:23</span
              ><span class="points-container"
                >Points: <span class="points">164</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=43724267"
                  >Comments</a
                ><span class="descendants">: 88</span></span
              >
            </h4>
          </section>
        </section>
        <section id="43724087">
          <h3>
            <a
              class="item"
              href="https://www.bps.org.uk/research-digest/soldiers-combat-can-kill-without-moral-injury"
              >Soldiers in combat can kill without moral injury</a
            >
          </h3>
          <section>
            <h4>
              <span>2025-04-18 @ 01:37:50</span
              ><span class="points-container"
                >Points: <span class="points">10</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=43724087"
                  >Comments</a
                ><span class="descendants">: 4</span></span
              >
            </h4>
          </section>
        </section>
        <section id="43723884">
          <h3>
            <a
              class="item"
              href="https://www.potaroo.net/ispcol/2024-10/packet-sizes.html"
              >The Size of Packets</a
            >
          </h3>
          <section>
            <h4>
              <span>2025-04-18 @ 00:59:06</span
              ><span class="points-container"
                >Points: <span class="points">18</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=43723884"
                  >Comments</a
                ><span class="descendants">: 3</span></span
              >
            </h4>
          </section>
        </section>
        <section id="43723088">
          <h3>
            <a
              class="item"
              href="https://blog.luden.io/what-do-i-think-about-lua-after-shipping-a-project-with-60-000-lines-of-code-bf72a1328733"
              >What do I think about Lua after shipping a project with 60k lines
              of code?</a
            >
          </h3>
          <section>
            <h4>
              <span>2025-04-17 @ 22:55:55</span
              ><span class="points-container"
                >Points: <span class="points">59</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=43723088"
                  >Comments</a
                ><span class="descendants">: 23</span></span
              >
            </h4>
          </section>
        </section>
        <section id="43723086">
          <h3>
            <a
              class="item"
              href="https://site.roadwolf.ca/categories/ue/cntower/"
              >CN Tower, Behind the Scenes (2014)</a
            >
          </h3>
          <section>
            <h4>
              <span>2025-04-17 @ 22:55:36</span
              ><span class="points-container"
                >Points: <span class="points">48</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=43723086"
                  >Comments</a
                ><span class="descendants">: 9</span></span
              >
            </h4>
          </section>
        </section>
        <section id="43723020">
          <h3>
            <a
              class="item"
              href="https://www.cantgetmuchhigher.com/p/i-analyzed-chord-progressions-in"
              >I Analyzed Chord Progressions in 680k Songs</a
            >
          </h3>
          <section>
            <h4>
              <span>2025-04-17 @ 22:44:11</span
              ><span class="points-container"
                >Points: <span class="points">66</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=43723020"
                  >Comments</a
                ><span class="descendants">: 34</span></span
              >
            </h4>
          </section>
        </section>
        <section id="43722981">
          <h3>
            <a class="item" href="https://pgdba.org/post/2025/04/size_matter/"
              >Memory Size Matters to PostgreSQL</a
            >
          </h3>
          <section>
            <h4>
              <span>2025-04-17 @ 22:37:12</span
              ><span class="points-container"
                >Points: <span class="points">36</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=43722981"
                  >Comments</a
                ><span class="descendants">: 2</span></span
              >
            </h4>
          </section>
        </section>
        <section id="43722486">
          <h3>
            <a class="item" href="https://facts.usps.com/mailing-potatoes/"
              >Potatoes in the Mail</a
            >
          </h3>
          <section>
            <h4>
              <span>2025-04-17 @ 21:35:45</span
              ><span class="points-container"
                >Points: <span class="points">210</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=43722486"
                  >Comments</a
                ><span class="descendants">: 100</span></span
              >
            </h4>
          </section>
        </section>
        <section id="43722171">
          <h3>
            <a class="item" href="https://mux.com/jobs?j=em"
              >Mux (YC W16) is hiring engineering managers for video at scale</a
            >
          </h3>
          <section>
            <h4>
              <span>2025-04-17 @ 21:01:06</span
              ><span class="points-container"
                >Points: <span class="points">1</span></span
              >
            </h4>
          </section>
        </section>
        <section id="43721228">
          <h3>
            <a class="item" href="https://github.com/waj/shell-secrets"
              >Shell-secrets â€“ GPG-encrypted environment variables</a
            >
          </h3>
          <section>
            <h4>
              <span>2025-04-17 @ 19:39:42</span
              ><span class="points-container"
                >Points: <span class="points">55</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=43721228"
                  >Comments</a
                ><span class="descendants">: 21</span></span
              >
            </h4>
          </section>
        </section>
        <section id="43720845">
          <h3>
            <a
              class="item"
              href="https://developers.googleblog.com/en/start-building-with-gemini-25-flash/"
              >Gemini 2.5 Flash</a
            >
          </h3>
          <section>
            <h4>
              <span>2025-04-17 @ 19:03:39</span
              ><span class="points-container"
                >Points: <span class="points">609</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=43720845"
                  >Comments</a
                ><span class="descendants">: 324</span></span
              >
            </h4>
          </section>
        </section>
        <section id="43719926">
          <h3>
            <a
              class="item"
              href="https://salmagundi.skidmore.edu/articles/75-on-jane-jacobs"
              >On Jane Jacobs (2017)</a
            >
          </h3>
          <section>
            <h4>
              <span>2025-04-17 @ 17:35:33</span
              ><span class="points-container"
                >Points: <span class="points">61</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=43719926"
                  >Comments</a
                ><span class="descendants">: 39</span></span
              >
            </h4>
          </section>
        </section>
        <section id="43719830">
          <h3>
            <a
              class="item"
              href="https://misfra.me/2025/sqlite-transactions-and-virtual-tables/"
              >SQLite transactions and virtual tables</a
            >
          </h3>
          <section>
            <h4>
              <span>2025-04-17 @ 17:28:31</span
              ><span class="points-container"
                >Points: <span class="points">80</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=43719830"
                  >Comments</a
                ><span class="descendants">: 9</span></span
              >
            </h4>
          </section>
        </section>
        <section id="43719447">
          <h3>
            <a class="item" href="https://github.com/coder/agentapi"
              >Show HN: AgentAPI â€“ HTTP API for Claude Code, Goose, Aider, and
              Codex</a
            >
          </h3>
          <section>
            <h4>
              <span>2025-04-17 @ 16:54:58</span
              ><span class="points-container"
                >Points: <span class="points">107</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=43719447"
                  >Comments</a
                ><span class="descendants">: 11</span></span
              >
            </h4>
          </section>
        </section>
        <section id="43718988">
          <h3>
            <a class="item" href="https://www.poshenloh.com/e/"
              >A cute proof that makes e natural</a
            >
          </h3>
          <section>
            <h4>
              <span>2025-04-17 @ 16:19:43</span
              ><span class="points-container"
                >Points: <span class="points">66</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=43718988"
                  >Comments</a
                ><span class="descendants">: 20</span></span
              >
            </h4>
          </section>
        </section>
        <section id="43718809">
          <h3>
            <a
              class="item"
              href="https://quagmirerepair.com/milwaukee-m18-battery-reverse-engineering"
              >Milwaukee M18 Battery Reverse Engineering</a
            >
          </h3>
          <section>
            <h4>
              <span>2025-04-17 @ 16:07:21</span
              ><span class="points-container"
                >Points: <span class="points">142</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=43718809"
                  >Comments</a
                ><span class="descendants">: 57</span></span
              >
            </h4>
          </section>
        </section>
        <section id="43717705">
          <h3>
            <a
              class="item"
              href="https://www.nytimes.com/2025/04/17/technology/google-ad-tech-antitrust-ruling.html"
              >Google is illegally monopolizing online advertising tech, judge
              rules</a
            >
          </h3>
          <section>
            <h4>
              <span>2025-04-17 @ 14:47:46</span
              ><span class="points-container"
                >Points: <span class="points">686</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=43717705"
                  >Comments</a
                ><span class="descendants">: 364</span></span
              >
            </h4>
          </section>
        </section>
        <section id="43717606">
          <h3>
            <a
              class="item"
              href="https://sharpletters.net/2025/04/16/hdr-emoji/"
              >HDRâ€‘Infused Emoji</a
            >
          </h3>
          <section>
            <h4>
              <span>2025-04-17 @ 14:42:07</span
              ><span class="points-container"
                >Points: <span class="points">211</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=43717606"
                  >Comments</a
                ><span class="descendants">: 120</span></span
              >
            </h4>
          </section>
        </section>
        <section id="43717377">
          <h3>
            <a
              class="item"
              href="https://techxplore.com/news/2025-04-stainless-steel-technique-submicron-anti.html"
              >Stainless steel strengthened: Twisting creates submicron
              'anti-crash wall'</a
            >
          </h3>
          <section>
            <h4>
              <span>2025-04-17 @ 14:28:07</span
              ><span class="points-container"
                >Points: <span class="points">96</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=43717377"
                  >Comments</a
                ><span class="descendants">: 39</span></span
              >
            </h4>
          </section>
        </section>
        <section id="43716526">
          <h3>
            <a
              class="item"
              href="https://nvd.nist.gov/vuln/detail/CVE-2025-32433"
              >Unauthenticated Remote Code Execution in Erlang/OTP SSH</a
            >
          </h3>
          <section>
            <h4>
              <span>2025-04-17 @ 13:29:44</span
              ><span class="points-container"
                >Points: <span class="points">160</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=43716526"
                  >Comments</a
                ><span class="descendants">: 44</span></span
              >
            </h4>
          </section>
        </section>
        <section id="43716058">
          <h3>
            <a
              class="item"
              href="https://maknee.github.io/blog/2025/3FS-Performance-Journal-1/"
              >An intro to DeepSeek's distributed file system</a
            >
          </h3>
          <section>
            <h4>
              <span>2025-04-17 @ 12:50:37</span
              ><span class="points-container"
                >Points: <span class="points">482</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=43716058"
                  >Comments</a
                ><span class="descendants">: 74</span></span
              >
            </h4>
          </section>
        </section>
        <section id="43715884">
          <h3>
            <a
              class="item"
              href="https://www.bbc.com/news/articles/cjr75wypg0vo"
              >Discord's face scanning age checks 'start of a bigger shift'</a
            >
          </h3>
          <section>
            <h4>
              <span>2025-04-17 @ 12:34:38</span
              ><span class="points-container"
                >Points: <span class="points">155</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=43715884"
                  >Comments</a
                ><span class="descendants">: 204</span></span
              >
            </h4>
          </section>
        </section>
        <section id="43714476">
          <h3>
            <a
              class="item"
              href="https://www.goto10retro.com/p/the-atari-1200xl-fiasco"
              >The Atari 1200XL fiasco</a
            >
          </h3>
          <section>
            <h4>
              <span>2025-04-17 @ 09:01:07</span
              ><span class="points-container"
                >Points: <span class="points">75</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=43714476"
                  >Comments</a
                ><span class="descendants">: 66</span></span
              >
            </h4>
          </section>
        </section>
        <section id="43710761">
          <h3>
            <a class="item" href="https://jsomers.net/vivarium/"
              >Vivarium: The keeper of a lab's animals stumbles onto a secret
              [fiction]</a
            >
          </h3>
          <section>
            <h4>
              <span>2025-04-16 @ 21:46:10</span
              ><span class="points-container"
                >Points: <span class="points">57</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=43710761"
                  >Comments</a
                ><span class="descendants">: 13</span></span
              >
            </h4>
            <div class="text">
              <p>
                The contrast hit me most vividly during the pandemic when I was
                writing an article about the immune system. [1] One of the
                scientists I spoke to told me about putting hamsters on warming
                plates, picking them up gently â€” in general, caring for and
                about them â€” and then feeling grief at their deaths. But of
                course understanding the immune response during infection with
                covid was a worthy cause. I felt no judgement towards this
                scientist; they are in a difficult position.
              </p>
              <p>
                There was another more direct bit of inspiration, when I read
                this article [2], in 2023, about the toll that caring for
                laboratory animals could take on peopleâ€™s mental health:
              </p>
              <p>
                &gt;
                <i
                  >Besides the symptoms Sessions experienced, those who handle
                  lab animals may face insomnia, chronic physical ailments,
                  zombielike lack of empathy, and, in extreme cases, severe
                  depression, substance abuse, and thoughts of suicide. As many
                  as nine in 10 people in the profession will suffer from
                  compassion fatigue at some point during their careers,
                  according to recent research, more than twice the rate of
                  those who work in hospital intensive care units. Itâ€™s one of
                  the leading reasons animal care workers quit.</i
                >
              </p>
              <p>
                That left an impression on me, and also armed me with a
                character: the forgotten-about, somewhat miserable vivarium
                worker.
              </p>
              <p>
                The story obviously takes many liberties with fact â€” it is
                fiction â€” but I also tried to ground it in reality, and stuff
                that you might think I made up (the guillotine, the crazy VR
                sphere in the first paragraph), I did not.
              </p>
              <p>
                I hope you enjoy! If nothing else I expect youâ€™ll appreciate the
                illustrations, done by my friend Ben Smith [3].
              </p>
              <p>
                [1]:
                <a
                  href="https://www.newyorker.com/magazine/2020/11/09/how-the-coronavirus-hacks-the-immune-system"
                  >https://www.newyorker.com/magazine/2020/11/09/how-the-corona...</a
                >
              </p>
              <p>
                [2]:
                <a
                  href="https://www.science.org/content/article/suffering-silence-caring-research-animals-can-take-severe-mental-toll"
                  >https://www.science.org/content/article/suffering-silence-ca...</a
                >
              </p>
              <p>
                [3]:
                <a href="https://www.stephenbonesproductions.com/"
                  >https://www.stephenbonesproductions.com/</a
                >
              </p>
            </div>
          </section>
        </section>
        <section id="43704364">
          <h3>
            <a class="item" href="https://pwy.io/posts/marching-events/"
              >Marching Events: What does iCalendar have to do with ray
              marching?</a
            >
          </h3>
          <section>
            <h4>
              <span>2025-04-16 @ 12:10:33</span
              ><span class="points-container"
                >Points: <span class="points">83</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=43704364"
                  >Comments</a
                ><span class="descendants">: 37</span></span
              >
            </h4>
          </section>
        </section>
        <section id="43697420">
          <h3>
            <a
              class="item"
              href="https://honeypot.net/2022/08/21/trying-and-failing.html"
              >Trying (and failing) to hack the Wall of Sheep (2022)</a
            >
          </h3>
          <section>
            <h4>
              <span>2025-04-15 @ 19:33:51</span
              ><span class="points-container"
                >Points: <span class="points">9</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=43697420"
                  >Comments</a
                ><span class="descendants">: 4</span></span
              >
            </h4>
          </section>
        </section>
        <section id="43695093">
          <h3>
            <a
              class="item"
              href="https://www.nature.com/articles/s44271-025-00247-0"
              >Decreased CO2 during breathwork: emergence of altered states of
              consciousness</a
            >
          </h3>
          <section>
            <h4>
              <span>2025-04-15 @ 16:23:40</span
              ><span class="points-container"
                >Points: <span class="points">139</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=43695093"
                  >Comments</a
                ><span class="descendants">: 43</span></span
              >
            </h4>
          </section>
        </section>
        <section id="43691230">
          <h3>
            <a
              class="item"
              href="https://github.com/pydantic/pydantic-ai/tree/main/mcp-run-python"
              >MCP Run Python</a
            >
          </h3>
          <section>
            <h4>
              <span>2025-04-15 @ 11:09:30</span
              ><span class="points-container"
                >Points: <span class="points">117</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=43691230"
                  >Comments</a
                ><span class="descendants">: 46</span></span
              >
            </h4>
          </section>
        </section>
        <section id="43685072">
          <h3>
            <a
              class="item"
              href="https://nautil.us/what-my-stroke-taught-me-236544/"
              >What my stroke taught me (2017)</a
            >
          </h3>
          <section>
            <h4>
              <span>2025-04-14 @ 19:17:16</span
              ><span class="points-container"
                >Points: <span class="points">79</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=43685072"
                  >Comments</a
                ><span class="descendants">: 34</span></span
              >
            </h4>
          </section>
        </section>
        <section id="43682984">
          <h3>
            <a class="item" href="https://news.ycombinator.com/item?id=43682984"
              >Is it possible to write plain C iOS app in 2025?</a
            >
          </h3>
          <section>
            <h4>
              <span>2025-04-14 @ 16:21:29</span
              ><span class="points-container"
                >Points: <span class="points">28</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=43682984"
                  >Comments</a
                ><span class="descendants">: 9</span></span
              >
            </h4>
            <div class="text"><p>Hence my question: Is it possible?</p></div>
          </section>
        </section>
      </section>
      <section id="archives">
        <h2>
          <a
            href="https://github.com/kherrick/hacker-news/blob/main/archives/index.md"
            >Archives</a
          >
        </h2>
        <section>
          <h3>
            <a
              href="https://github.com/kherrick/hacker-news/blob/main/archives/2025/index.md"
              >2025</a
            >
          </h3>
        </section>
        <section>
          <h3>
            <a
              href="https://github.com/kherrick/hacker-news/blob/main/archives/2024/index.md"
              >2024</a
            >
          </h3>
        </section>
        <section>
          <h3>
            <a
              href="https://github.com/kherrick/hacker-news/blob/main/archives/2023/index.md"
              >2023</a
            >
          </h3>
        </section>
        <section>
          <h3>
            <a
              href="https://github.com/kherrick/hacker-news/blob/main/archives/2022/index.md"
              >2022</a
            >
          </h3>
        </section>
      </section>
    </main>
    <script type="module">
      import { buildDescendants } from "./lib/build-html-descendants.js";
      import { buildNextItem } from "./lib/build-html-next-item.js";
      import { getNextDateTime } from "./lib/date-time.js";

      const updateSectionById = (id) =>
        fetch(`https://hacker-news.firebaseio.com/v0/item/${id}.json`).then(
          (result) =>
            result.json().then(({ descendants, id, score, text, type }) => {
              const currentItem = document.getElementById(id);

              if (score) {
                currentItem.querySelector(".points").textContent = score;
              }

              if (descendants && (type === "poll" || type === "story")) {
                const currentDescendants =
                  currentItem.querySelector(".descendants");

                if (currentDescendants) {
                  currentDescendants.textContent = `: ${descendants}`;
                } else {
                  const comments = buildDescendants(
                    document,
                    descendants,
                    `https://news.ycombinator.com/item?id=${id}`
                  );

                  currentItem.querySelector("h4").appendChild(comments);
                }
              }

              if (text) {
                const currentText = currentItem.querySelector(".text");

                if (currentText) {
                  currentText.innerHTML = text.replace(/\0/g, "");
                } else {
                  const content = document.createElement("div");
                  content.innerHTML = text.replace(/\0/g, "");
                  content.setAttribute("class", "text");

                  currentItem.appendChild(content);
                }
              }
            })
        );

      class UpdateQueue {
        constructor() {
          this._ids = [];
          this._isUpdating = false;
        }

        addItemById(id) {
          this._ids.push(id);
        }

        async flush() {
          const id = this._ids.shift();

          if (id) {
            this._isUpdating = true;

            await updateSectionById(id);
            await this.flush();
          } else {
            this._isUpdating = false;

            setTimeout(async () => {
              if (!this._isUpdating && this._ids && this._ids.length) {
                await this.flush();
              }
            }, 0);
          }
        }
      }

      // get latest data
      const latestSection = document.getElementById("latest");

      for (let item of latestSection.querySelectorAll("section[id]")) {
        updateSectionById(item.getAttribute("id"));
      }

      if ("IntersectionObserver" in window) {
        window.hackerNewsState = { index: [], nextTimeIndex: -1 };

        const addNewsItem = async (newsItem, queue) => {
          try {
            const { date, time, itemComments, itemTitle, itemLink } = newsItem;
            const section = await buildNextItem({
              document,
              dateTime: `${date}, ${time}`,
              itemComments,
              itemLink,
              itemTitle: new DOMParser().parseFromString(
                itemTitle.replace(/\\/g, ""),
                "text/html"
              ).documentElement.textContent,
              fetchItemDetails: false,
            });

            // display loading indicator for section
            section.querySelector(".points-container").innerHTML =
              'Points: <span class="points"><img style="height: 100%;" src="lib/images/loading.svg" /></span>';

            const id = section.getAttribute("id");
            if (!document.getElementById(id)) {
              document.getElementById("latest").appendChild(section);

              queue.addItemById(id);
            }
          } catch (error) {}
        };

        const buildArchiveIndex = async (lastDateTime) => {
          const nextDate = lastDateTime.slice(0, 10);
          const nextYear = nextDate.slice(0, 4);

          return (
            await (
              await fetch(
                `https://raw.githubusercontent.com/kherrick/hacker-news/main/archives/${nextYear}/${nextDate}/index.md`
              )
            ).text()
          )
            .split("\n")
            .filter((line) => line.match(new RegExp("^\\* \\[")))
            .map((line) => {
              const segment = line.replace("* ", "").split("](");
              const pubDate = segment[0].slice(1);

              const itemComments = segment[1].split(") - [")[0];
              const itemTitle = segment[1].split(") - [")[1];
              const itemLink = segment[2].slice(0, -1);
              const date = pubDate.slice(0, 10);
              const time = pubDate.slice(-8);

              return {
                date,
                itemComments,
                itemLink,
                itemTitle,
                time,
              };
            });
        };

        const handleIntersectingEntry = async (entry, queue) => {
          if (entry.isIntersecting) {
            const lastDateTime = document
              .getElementById("latest")
              .querySelector(
                "section:last-child > section > h4 > span"
              ).textContent;

            const nextDateTime = getNextDateTime(lastDateTime ?? "", -1);
            const archiveIndex = await buildArchiveIndex(nextDateTime);
            const nextTimeIndex = archiveIndex.findIndex(
              ({ time }) => time === nextDateTime.slice(-8)
            );

            const handleIndexUpdate = (index, existingIndexValues = []) => {
              index.forEach((i) => {
                existingIndexValues.push(i);
              });
              return existingIndexValues;
            };

            window.hackerNewsState = {
              index: handleIndexUpdate(
                archiveIndex,
                window.hackerNewsState.index
              ),
              nextTimeIndex,
            };

            let currentTimeIndex = nextTimeIndex + 1;
            const items = Object.values(window.hackerNewsState.index);
            for (let item of items) {
              if (currentTimeIndex < window.hackerNewsState.index.length) {
                addNewsItem(items[currentTimeIndex], queue);

                currentTimeIndex = currentTimeIndex + 1;
              }
            }

            queue.flush();
          }
        };

        const archives = document.getElementById("archives");
        const archivesObserver = new IntersectionObserver(
          (entries) => {
            const queue = new UpdateQueue();

            entries.forEach((entry) => handleIntersectingEntry(entry, queue));
          },
          {
            root: null,
            rootMargin: "0px",
            threshold: 0,
          }
        );

        archivesObserver.observe(archives);

        let latestSectionsExpanded = true;
        const handleLatestHeaderClick = () => {
          latestSectionsExpanded = !latestSectionsExpanded;

          if (latestSectionsExpanded) {
            archivesObserver.observe(archives);
          } else {
            archivesObserver.disconnect(archives);
          }

          for (let section of document.querySelectorAll("#latest > section")) {
            section.style.display = latestSectionsExpanded ? "block" : "none";
          }
        };

        const latestHeader = document.querySelector("#latest > h2");
        latestHeader.style.cursor = "pointer";
        latestHeader.addEventListener("click", handleLatestHeaderClick);
      }
    </script>
    <script type="module">
      import { Workbox } from "https://storage.googleapis.com/workbox-cdn/releases/6.4.1/workbox-window.prod.mjs";

      if ("serviceWorker" in navigator) {
        const base = document.querySelector("base");
        const serviceWorkerPath = `${
          base ? base.href.replace(/\/$/, "") : ""
        }/service-worker.js`;

        const wb = new Workbox(serviceWorkerPath);

        // setup event listeners
        wb.addEventListener("waiting", (event) => {
          wb.addEventListener("controlling", () => {
            window.location.reload();
          });

          wb.messageSkipWaiting();
        });

        wb.register();
      }
    </script>
  </body>
</html>
