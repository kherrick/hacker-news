<!DOCTYPE html>
<html lang="en" xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta charset="utf-8" />
    <meta
      content="width=device-width, initial-scale=1.0, viewport-fit=cover"
      name="viewport"
    />
    <meta name="description" content="Hacker News" />
    <meta name="theme-color" content="#fff" />
    <title>Hacker News</title>
    <link rel="manifest" href="manifest.json" />
    <link
      href="data:image/x-icon;base64,AAABAAEAAQECAAEAAQA4AAAAFgAAACgAAAABAAAAAgAAAAEAAQAAAAAAAAAAAAAAAAAAAAAAAAAAAAABAAEAAQECAAEAAQA4AAAAFgAAACgAAAABAAAAAgAAAAEAAQAAAAAAAAAAAAAAAAAAAAAAAAAA"
      rel="icon"
      type="image/x-icon"
    />
    <link
      href="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAgAAAAIAAQMAAADOtka5AAAAA1BMVEUAAACnej3aAAAANklEQVR42u3BAQEAAACCIP+vbkhAAQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAB8G4IAAAFjdVCkAAAAAElFTkSuQmCC"
      rel="apple-touch-icon"
    />
    <style>
      /*<!--*/
      body {
        color: rgb(25, 25, 25);
        font-family: Verdana, Geneva, sans-serif;
        margin: 0;
      }

      a {
        text-decoration: none;
      }

      a:link,
      a:focus,
      a:hover,
      a:active {
        color: rgb(75, 75, 125);
      }

      a:visited {
        color: rgb(25, 25, 25);
      }

      h1 > a,
      h1 > a:link,
      h1 > a:focus,
      h1 > a:hover,
      h1 > a:active,
      h1 > a:visited,
      h2 > a,
      h2 > a:link,
      h2 > a:focus,
      h2 > a:hover,
      h2 > a:active,
      h2 > a:visited {
        color: rgb(25, 25, 25);
      }

      h1 {
        background-color: rgb(255, 102, 0);
        margin: 0;
        padding: 1rem;
      }

      h2 {
        background-color: rgb(200, 200, 200);
        margin: 1rem 0;
        padding: 0.5rem 0.5rem 0.5rem 1rem;
      }

      #latest > section,
      #archives > section {
        margin: 0 1rem 1rem 1rem;
        padding-bottom: 1rem;
      }

      #latest > section:not(:last-child),
      #archives > section:not(:last-child) {
        border-bottom: 1px dotted rgb(200, 200, 200);
      }

      section > h3 {
        margin: 0 0 0.5rem 0;
      }

      section > h4 {
        font-weight: normal;
        margin: 0 0 0 1rem;
      }

      .descendants-container,
      .points-container {
        align-items: center;
        border-left: 1px solid #333;
        display: inline-flex;
        margin-left: 0.5rem;
        padding-left: 0.5rem;
        text-align: center;
      }

      .points {
        align-items: center;
        display: inline-flex;
        height: 1rem;
        margin-left: 1ch;
        min-width: 3ch;
      }

      .text {
        line-height: 1.5rem;
        margin: 1rem 1rem 0 1rem;
        overflow: auto;
      }

      .text > p:first-child {
        margin-top: 1rem;
      }

      .text > p:last-child {
        margin-bottom: 0;
      }
      /*-->*/
    </style>
  </head>

  <body>
    <main>
      <h1><a href="https://kherrick.github.io/hacker-news/">Hacker News</a></h1>
      <section id="latest">
        <h2>Latest</h2>
        <section id="40626692">
          <h3>
            <a
              class="item"
              href="https://link.springer.com/article/10.1007/s10676-024-09775-5"
              >ChatGPT Is Bullshit</a
            >
          </h3>
          <section>
            <h4>
              <span>2024-06-09 @ 19:05:42</span
              ><span class="points-container"
                >Points: <span class="points">28</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=40626692"
                  >Comments</a
                ><span class="descendants">: 11</span></span
              >
            </h4>
          </section>
        </section>
        <section id="40626332">
          <h3>
            <a
              class="item"
              href="https://www.bitsofwonder.co/p/a-revolution-in-biology"
              >A Revolution in Biology</a
            >
          </h3>
          <section>
            <h4>
              <span>2024-06-09 @ 18:13:34</span
              ><span class="points-container"
                >Points: <span class="points">11</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=40626332"
                  >Comments</a
                ><span class="descendants">: 0</span></span
              >
            </h4>
          </section>
        </section>
        <section id="40626058">
          <h3>
            <a
              class="item"
              href="https://outerproduct.net/2021-02-13_att-asm.html"
              >Why no one should use the AT&amp;amp;T syntax ever, for any
              reason (2021)</a
            >
          </h3>
          <section>
            <h4>
              <span>2024-06-09 @ 17:36:13</span
              ><span class="points-container"
                >Points: <span class="points">67</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=40626058"
                  >Comments</a
                ><span class="descendants">: 53</span></span
              >
            </h4>
          </section>
        </section>
        <section id="40626014">
          <h3>
            <a
              class="item"
              href="https://old.reddit.com/r/comfyui/comments/1dbls5n/psa_if_youve_used_the_comfyui_llmvision_node_from/"
              >Keylogger discovered in image generator extension</a
            >
          </h3>
          <section>
            <h4>
              <span>2024-06-09 @ 17:29:00</span
              ><span class="points-container"
                >Points: <span class="points">159</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=40626014"
                  >Comments</a
                ><span class="descendants">: 40</span></span
              >
            </h4>
          </section>
        </section>
        <section id="40626011">
          <h3>
            <a
              class="item"
              href="https://seirdy.one/posts/2021/03/10/search-engines-with-own-indexes/"
              >A look at search engines with their own indexes</a
            >
          </h3>
          <section>
            <h4>
              <span>2024-06-09 @ 17:28:50</span
              ><span class="points-container"
                >Points: <span class="points">35</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=40626011"
                  >Comments</a
                ><span class="descendants">: 8</span></span
              >
            </h4>
          </section>
        </section>
        <section id="40625800">
          <h3>
            <a class="item" href="https://news.ycombinator.com/item?id=40625800"
              >Is KDB a sane choice for a datalake in 2024?</a
            >
          </h3>
          <section>
            <h4>
              <span>2024-06-09 @ 17:00:22</span
              ><span class="points-container"
                >Points: <span class="points">20</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=40625800"
                  >Comments</a
                ><span class="descendants">: 21</span></span
              >
            </h4>
            <div class="text">
              <p>
                It's also extremely expensive and written in a language with
                origins so obtuse that it's progenitor APL needed a custom
                keyboard laden with mathematical symbols.
              </p>
              <p>
                Within my firm, it's very hard to get an outside perspective,
                the KDB developers are true believers in KDB, but they they
                obviously don't want to be professionally replaced. So I'm
                asking the more forward leaning HN.
              </p>
              <p>
                One nail in my job, is KDB as a data-lake and I'm being driven
                nuts by it. I write code in Rust that prices options. There's a
                lot of complex code involved in this, I use a mix of numeric
                simulations to calculate greeks and somewhat lengthy analytical
                formulas.
              </p>
              <p>
                The data that I save to KDB is quite raw, I save the market data
                and derived volatility surfaces, which are themselves
                complex-ish models needing some carefully unit-tested code to
                convert in to implied vols.
              </p>
              <p>
                Right now my desk has no proper tooling for backtesting that
                uses our own data. And I'm constantly being asked to do
                something about it, and I don't know what to do!
              </p>
              <p>
                I'm 99% sure KDB is the wrong tool for the job, because of three
                things:
              </p>
              <p>
                - It's not horizontally scalable. A divide and conquer algo on
                N&lt;{small_number} cores is pointless.
              </p>
              <p>
                - I'm scared to do queries that return a lot of data. It's non
                trivial to get a day's worth of data. The query will just often
                freeze, it doesn't even buffer. Even if I'm just trying to fetch
                what should be a logical partition, the wire format is really
                inefficient and uncompressed. I feel like I need to engineering
                work for trivial things.
              </p>
              <p>
                - The main thing is that I need to do complex math to convert my
                raw data, order-books and vol-surfaces into useful data to
                backtest.
              </p>
              <p>
                I have no idea how do do any of this in KDB. My firm is
                primarily a spot desk, and while I respect my colleagues, their
                answer is:
              </p>
              <p>
                &gt; Other firms are really invested in KDB and use KDB for
                this, just figure it out.
              </p>
              <p>
                I'm going nuts because I'm under the assumption that these other
                firms are way larger and have teams of KDB-quants doing the
                actual research. While we have some quant traders who know a bit
                of KDB but they work in the spot side with far more simple math.
              </p>
              <p>
                I keep on advocating for some Parquet style data-store with
                Spark/Dask/Arrow/Polars running on top of it that can be
                horizontally scaled and most importantly, with Polars, I can
                write my backtests in Rust and leverage the libraries I've
                already written.
              </p>
              <p>
                I get shot down with "we use KDB here". I just don't know how I
                can deliver a maintainable solution to my traders with this
                current infrastructure. Bizarrely, and this is a financial firm,
                no one in a team of ~100 devs has ever touched Spark style tech
                other than me here.
              </p>
              <p>
                What should I do? Are my concerns overblown? Am I
                misunderstanding the power of KDB?
              </p>
            </div>
          </section>
        </section>
        <section id="40624924">
          <h3>
            <a
              class="item"
              href="https://www.writingruxandrabio.com/p/the-weird-nerd-comes-with-trade-offs"
              >The Weird Nerd comes with trade-offs</a
            >
          </h3>
          <section>
            <h4>
              <span>2024-06-09 @ 15:06:50</span
              ><span class="points-container"
                >Points: <span class="points">202</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=40624924"
                  >Comments</a
                ><span class="descendants">: 213</span></span
              >
            </h4>
          </section>
        </section>
        <section id="40624709">
          <h3>
            <a
              class="item"
              href="https://www.windytan.com/2024/06/ultrasonic-investigations-in-shopping.html"
              >Ultrasonic Investigations in Shopping Centres</a
            >
          </h3>
          <section>
            <h4>
              <span>2024-06-09 @ 14:35:43</span
              ><span class="points-container"
                >Points: <span class="points">108</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=40624709"
                  >Comments</a
                ><span class="descendants">: 43</span></span
              >
            </h4>
          </section>
        </section>
        <section id="40624645">
          <h3>
            <a class="item" href="https://gitlab.com/AOMediaCodec/SVT-AV1"
              >SVT-AV1 Encoder and Decoder</a
            >
          </h3>
          <section>
            <h4>
              <span>2024-06-09 @ 14:27:04</span
              ><span class="points-container"
                >Points: <span class="points">19</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=40624645"
                  >Comments</a
                ><span class="descendants">: 9</span></span
              >
            </h4>
          </section>
        </section>
        <section id="40623883">
          <h3>
            <a class="item" href="https://github.com/labmlai/inspectus"
              >Show HN: We've open-sourced our LLM attention visualization
              library</a
            >
          </h3>
          <section>
            <h4>
              <span>2024-06-09 @ 12:05:53</span
              ><span class="points-container"
                >Points: <span class="points">60</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=40623883"
                  >Comments</a
                ><span class="descendants">: 7</span></span
              >
            </h4>
            <div class="text">
              Inspectus allows you to create interactive visualizations of
              attention matrices with just a few lines of Python code. It’s
              designed to run smoothly in Jupyter notebooks through an
              easy-to-use Python API. Inspectus provides multiple views to help
              you understand language model behaviors. If you have any
              questions, feel free to ask!
            </div>
          </section>
        </section>
        <section id="40623877">
          <h3>
            <a class="item" href="https://www.worchle.com/mathic/"
              >Show HN: I made a web game that makes practicing basic arithmetic
              fun</a
            >
          </h3>
          <section>
            <h4>
              <span>2024-06-09 @ 12:04:29</span
              ><span class="points-container"
                >Points: <span class="points">66</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=40623877"
                  >Comments</a
                ><span class="descendants">: 37</span></span
              >
            </h4>
            <div class="text">
              <p>
                After launching a daily word search game, I randomly thought of
                this math game while driving. Finally got around to making it
                and I think it turned out pretty cool.
              </p>
              <p>
                It’s a math search game that’s meant to help you practice your
                quick addition, subtraction, multiplication, and division
                skills.
              </p>
              <p>
                I’m hoping it’ll help people (even those like me who aren’t big
                on math) learn and increase their speeds.
              </p>
              <p>
                (There are also some settings you can enable to make the game
                harder)
              </p>
              <p>
                If you try it out, please let me know if you found it fun, if
                you have anything you’d like me to add, or if you have any other
                feedback.
              </p>
              <p>
                And if you have any questions, I’d be happy to answer. Much
                appreciated.
              </p>
            </div>
          </section>
        </section>
        <section id="40623872">
          <h3>
            <a class="item" href="https://up.codes/careers?utm_source=HN"
              >UpCodes (YC S17) is hiring remote SWEs, PMs to help make
              buildings cheaper</a
            >
          </h3>
          <section>
            <h4>
              <span>2024-06-09 @ 12:03:26</span
              ><span class="points-container"
                >Points: <span class="points">1</span></span
              >
            </h4>
          </section>
        </section>
        <section id="40623711">
          <h3>
            <a class="item" href="https://www.youtube.com/watch?v=qJEWOTZnFeg"
              >Interview with Ton Roosendaal, the man behind Blender (2018)
              [video]</a
            >
          </h3>
          <section>
            <h4>
              <span>2024-06-09 @ 11:28:40</span
              ><span class="points-container"
                >Points: <span class="points">56</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=40623711"
                  >Comments</a
                ><span class="descendants">: 5</span></span
              >
            </h4>
          </section>
        </section>
        <section id="40623542">
          <h3>
            <a class="item" href="https://gitlab.com/camelot/kickc"
              >KickC is a C-compiler for 6502-based platforms creating readable
              assembler code</a
            >
          </h3>
          <section>
            <h4>
              <span>2024-06-09 @ 10:49:12</span
              ><span class="points-container"
                >Points: <span class="points">30</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=40623542"
                  >Comments</a
                ><span class="descendants">: 8</span></span
              >
            </h4>
          </section>
        </section>
        <section id="40622704">
          <h3>
            <a class="item" href="https://github.com/piku/piku"
              >Piku: Allows git push deployments to your own servers</a
            >
          </h3>
          <section>
            <h4>
              <span>2024-06-09 @ 07:40:25</span
              ><span class="points-container"
                >Points: <span class="points">448</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=40622704"
                  >Comments</a
                ><span class="descendants">: 115</span></span
              >
            </h4>
          </section>
        </section>
        <section id="40622189">
          <h3>
            <a class="item" href="https://betula.mycorrhiza.wiki/"
              >Betula – federated bookmarking software for the independent
              web</a
            >
          </h3>
          <section>
            <h4>
              <span>2024-06-09 @ 05:07:06</span
              ><span class="points-container"
                >Points: <span class="points">105</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=40622189"
                  >Comments</a
                ><span class="descendants">: 39</span></span
              >
            </h4>
          </section>
        </section>
        <section id="40621534">
          <h3>
            <a
              class="item"
              href="https://www.downtowndougbrown.com/2024/06/fixing-a-knockoff-altera-usb-blaster-that-never-worked/"
              >Fixing a knockoff Altera USB Blaster that never worked</a
            >
          </h3>
          <section>
            <h4>
              <span>2024-06-09 @ 02:13:49</span
              ><span class="points-container"
                >Points: <span class="points">131</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=40621534"
                  >Comments</a
                ><span class="descendants">: 21</span></span
              >
            </h4>
          </section>
        </section>
        <section id="40620955">
          <h3>
            <a class="item" href="https://arxiv.org/abs/2406.02528"
              >Scalable MatMul-Free Language Modeling</a
            >
          </h3>
          <section>
            <h4>
              <span>2024-06-09 @ 00:00:48</span
              ><span class="points-container"
                >Points: <span class="points">169</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=40620955"
                  >Comments</a
                ><span class="descendants">: 26</span></span
              >
            </h4>
          </section>
        </section>
        <section id="40620472">
          <h3>
            <a class="item" href="https://joshdata.me/iceberger.html"
              >Draw an iceberg and see how it will float</a
            >
          </h3>
          <section>
            <h4>
              <span>2024-06-08 @ 22:04:24</span
              ><span class="points-container"
                >Points: <span class="points">281</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=40620472"
                  >Comments</a
                ><span class="descendants">: 45</span></span
              >
            </h4>
          </section>
        </section>
        <section id="40620056">
          <h3>
            <a
              class="item"
              href="https://cosmosmagazine.com/science/biology/gene-therapy-restores-hearing-to-children-with-inherited-deafness/"
              >Gene therapy restores hearing to children with inherited
              deafness</a
            >
          </h3>
          <section>
            <h4>
              <span>2024-06-08 @ 20:40:16</span
              ><span class="points-container"
                >Points: <span class="points">469</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=40620056"
                  >Comments</a
                ><span class="descendants">: 191</span></span
              >
            </h4>
          </section>
        </section>
        <section id="40618766">
          <h3>
            <a
              class="item"
              href="https://omarshehata.substack.com/p/my-favorite-1980s-canadian-tv-show"
              >My favorite 1980's Canadian TV show: Bits and Bytes</a
            >
          </h3>
          <section>
            <h4>
              <span>2024-06-08 @ 16:43:46</span
              ><span class="points-container"
                >Points: <span class="points">202</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=40618766"
                  >Comments</a
                ><span class="descendants">: 66</span></span
              >
            </h4>
          </section>
        </section>
        <section id="40618459">
          <h3>
            <a class="item" href="https://fobes.dev/ps2/detecting-emu-vu-floats"
              >Detecting a PS2 Emulator: When 1*X does not equal X</a
            >
          </h3>
          <section>
            <h4>
              <span>2024-06-08 @ 16:05:45</span
              ><span class="points-container"
                >Points: <span class="points">297</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=40618459"
                  >Comments</a
                ><span class="descendants">: 76</span></span
              >
            </h4>
          </section>
        </section>
        <section id="40618079">
          <h3>
            <a
              class="item"
              href="https://blog.archive.org/2024/06/01/the-backrooms-of-the-internet-archive/"
              >The Backrooms of the Internet Archive</a
            >
          </h3>
          <section>
            <h4>
              <span>2024-06-08 @ 15:17:53</span
              ><span class="points-container"
                >Points: <span class="points">663</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=40618079"
                  >Comments</a
                ><span class="descendants">: 102</span></span
              >
            </h4>
          </section>
        </section>
        <section id="40616927">
          <h3>
            <a
              class="item"
              href="https://tontinecoffeehouse.com/2019/10/14/how-a-cable-changed-finance/"
              >How a Cable Changed Finance</a
            >
          </h3>
          <section>
            <h4>
              <span>2024-06-08 @ 11:41:42</span
              ><span class="points-container"
                >Points: <span class="points">27</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=40616927"
                  >Comments</a
                ><span class="descendants">: 6</span></span
              >
            </h4>
          </section>
        </section>
        <section id="40616509">
          <h3>
            <a class="item" href="https://github.com/GothicKit/dmusic"
              >Show HN: I wrote a partial re-implementation of DirectMusic</a
            >
          </h3>
          <section>
            <h4>
              <span>2024-06-08 @ 10:02:15</span
              ><span class="points-container"
                >Points: <span class="points">52</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=40616509"
                  >Comments</a
                ><span class="descendants">: 15</span></span
              >
            </h4>
            <div class="text">
              <p>
                Due to my involvement with projects[3] re-implementing an old
                game engine for the early 2000's games Gothic and Gothic II[4],
                I came to notice that existing solutions[5] were incorrect and
                hard to use. Thus, I was tasked with writing a new, correct
                re-implementation of the API.
              </p>
              <p>
                Today, my re-implementation is able to (mostly) play back
                so-called style-based segments[6] and is fully tested against
                both the Gothic and Gothic II soundtracks. I am actively working
                on getting the Lego Island 2 soundtrack working as well.
              </p>
              <p>
                There are many features of DirectMusic which the library does
                not currently support, simply because I have not been able to
                find or test soundtracks using them, so if you want to
                contribute, I'd love to know about software shipping with
                DirectMusic soundtracks!
              </p>
              <p>
                [1]:
                <a href="https://en.wikipedia.org/wiki/DirectMusic"
                  >https://en.wikipedia.org/wiki/DirectMusic</a
                >
              </p>
              <p>
                [2]:
                <a
                  href="https://www.vgmpf.com/Wiki/index.php?title=DirectMusic_Producer"
                  >https://www.vgmpf.com/Wiki/index.php?title=DirectMusic_Produ...</a
                >
              </p>
              <p>
                [3]: Specifically GothicVR (<a
                  href="https://github.com/GothicVRProject/GothicVR"
                  >https://github.com/GothicVRProject/GothicVR</a
                >) and OpenGothic (<a href="https://github.com/Try/OpenGothic"
                  >https://github.com/Try/OpenGothic</a
                >) through my ZenKit library (<a
                  href="https://github.com/GothicKit/ZenKit"
                  >https://github.com/GothicKit/ZenKit</a
                >)
              </p>
              <p>
                [4]:
                <a href="https://en.wikipedia.org/wiki/Gothic_II"
                  >https://en.wikipedia.org/wiki/Gothic_II</a
                >
              </p>
              <p>
                [5]: There is libdmusic (<a
                  href="https://github.com/libdmusic/libdmusic"
                  >https://github.com/libdmusic/libdmusic</a
                >) which is unmaintained and an embedded implementation in
                OpenGothic (<a href="https://github.com/Try/OpenGothic"
                  >https://github.com/Try/OpenGothic</a
                >)
              </p>
              <p>
                [6]:
                <a
                  href="https://documentation.help/DirectMusic/howmusicvariesduringplayback.htm"
                  >https://documentation.help/DirectMusic/howmusicvariesduringp...</a
                >
              </p>
            </div>
          </section>
        </section>
        <section id="40616505">
          <h3><a class="item" href="https://unboxer.tf/">Unboxer.tf</a></h3>
          <section>
            <h4>
              <span>2024-06-08 @ 10:02:02</span
              ><span class="points-container"
                >Points: <span class="points">5</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=40616505"
                  >Comments</a
                ><span class="descendants">: 1</span></span
              >
            </h4>
          </section>
        </section>
        <section id="40615666">
          <h3>
            <a
              class="item"
              href="http://msinilo.pl/blog2/post/compilers-are-too-smart/"
              >Compilers Are (Too) Smart</a
            >
          </h3>
          <section>
            <h4>
              <span>2024-06-08 @ 06:18:04</span
              ><span class="points-container"
                >Points: <span class="points">98</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=40615666"
                  >Comments</a
                ><span class="descendants">: 50</span></span
              >
            </h4>
          </section>
        </section>
        <section id="40604592">
          <h3>
            <a
              class="item"
              href="https://www.sciencealert.com/evidence-of-earths-first-rains-found-trapped-within-primordial-crystals"
              >Evidence of earth's first rains found trapped within primordial
              crystals</a
            >
          </h3>
          <section>
            <h4>
              <span>2024-06-07 @ 01:58:33</span
              ><span class="points-container"
                >Points: <span class="points">55</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=40604592"
                  >Comments</a
                ><span class="descendants">: 7</span></span
              >
            </h4>
          </section>
        </section>
        <section id="40602928">
          <h3>
            <a
              class="item"
              href="https://tex.stackexchange.com/questions/4201/is-there-a-bnf-grammar-of-the-tex-language"
              >Is there a BNF grammar of the TeX language? (2010)</a
            >
          </h3>
          <section>
            <h4>
              <span>2024-06-06 @ 22:08:40</span
              ><span class="points-container"
                >Points: <span class="points">49</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=40602928"
                  >Comments</a
                ><span class="descendants">: 31</span></span
              >
            </h4>
          </section>
        </section>
        <section id="40601098">
          <h3>
            <a class="item" href="https://queue.acm.org/detail.cfm?id=3664645"
              >Zero Tolerance for Bias</a
            >
          </h3>
          <section>
            <h4>
              <span>2024-06-06 @ 18:58:20</span
              ><span class="points-container"
                >Points: <span class="points">185</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=40601098"
                  >Comments</a
                ><span class="descendants">: 77</span></span
              >
            </h4>
          </section>
        </section>
      </section>
      <section id="archives">
        <h2>
          <a
            href="https://github.com/kherrick/hacker-news/blob/main/archives/index.md"
            >Archives</a
          >
        </h2>
        <section>
          <h3>
            <a
              href="https://github.com/kherrick/hacker-news/blob/main/archives/2024/index.md"
              >2024</a
            >
          </h3>
        </section>
        <section>
          <h3>
            <a
              href="https://github.com/kherrick/hacker-news/blob/main/archives/2023/index.md"
              >2023</a
            >
          </h3>
        </section>
        <section>
          <h3>
            <a
              href="https://github.com/kherrick/hacker-news/blob/main/archives/2022/index.md"
              >2022</a
            >
          </h3>
        </section>
      </section>
    </main>
    <script type="module">
      import { buildDescendants } from "./lib/build-html-descendants.js";
      import { buildNextItem } from "./lib/build-html-next-item.js";
      import { getNextDateTime } from "./lib/date-time.js";

      const updateSectionById = (id) =>
        fetch(`https://hacker-news.firebaseio.com/v0/item/${id}.json`).then(
          (result) =>
            result.json().then(({ descendants, id, score, text, type }) => {
              const currentItem = document.getElementById(id);

              if (score) {
                currentItem.querySelector(".points").textContent = score;
              }

              if (descendants && (type === "poll" || type === "story")) {
                const currentDescendants =
                  currentItem.querySelector(".descendants");

                if (currentDescendants) {
                  currentDescendants.textContent = `: ${descendants}`;
                } else {
                  const comments = buildDescendants(
                    document,
                    descendants,
                    `https://news.ycombinator.com/item?id=${id}`
                  );

                  currentItem.querySelector("h4").appendChild(comments);
                }
              }

              if (text) {
                const currentText = currentItem.querySelector(".text");

                if (currentText) {
                  currentText.innerHTML = text.replace(/\0/g, "");
                } else {
                  const content = document.createElement("div");
                  content.innerHTML = text.replace(/\0/g, "");
                  content.setAttribute("class", "text");

                  currentItem.appendChild(content);
                }
              }
            })
        );

      class UpdateQueue {
        constructor() {
          this._ids = [];
          this._isUpdating = false;
        }

        addItemById(id) {
          this._ids.push(id);
        }

        async flush() {
          const id = this._ids.shift();

          if (id) {
            this._isUpdating = true;

            await updateSectionById(id);
            await this.flush();
          } else {
            this._isUpdating = false;

            setTimeout(async () => {
              if (!this._isUpdating && this._ids && this._ids.length) {
                await this.flush();
              }
            }, 0);
          }
        }
      }

      // get latest data
      const latestSection = document.getElementById("latest");

      for (let item of latestSection.querySelectorAll("section[id]")) {
        updateSectionById(item.getAttribute("id"));
      }

      if ("IntersectionObserver" in window) {
        window.hackerNewsState = { index: [], nextTimeIndex: -1 };

        const addNewsItem = async (newsItem, queue) => {
          try {
            const { date, time, itemComments, itemTitle, itemLink } = newsItem;
            const section = await buildNextItem({
              document,
              dateTime: `${date}, ${time}`,
              itemComments,
              itemLink,
              itemTitle: new DOMParser().parseFromString(
                itemTitle.replace(/\\/g, ""),
                "text/html"
              ).documentElement.textContent,
              fetchItemDetails: false,
            });

            // display loading indicator for section
            section.querySelector(".points-container").innerHTML =
              'Points: <span class="points"><img style="height: 100%;" src="lib/images/loading.svg" /></span>';

            const id = section.getAttribute("id");
            if (!document.getElementById(id)) {
              document.getElementById("latest").appendChild(section);

              queue.addItemById(id);
            }
          } catch (error) {}
        };

        const buildArchiveIndex = async (lastDateTime) => {
          const nextDate = lastDateTime.slice(0, 10);
          const nextYear = nextDate.slice(0, 4);

          return (
            await (
              await fetch(
                `https://raw.githubusercontent.com/kherrick/hacker-news/main/archives/${nextYear}/${nextDate}/index.md`
              )
            ).text()
          )
            .split("\n")
            .filter((line) => line.match(new RegExp("^\\* \\[")))
            .map((line) => {
              const segment = line.replace("* ", "").split("](");
              const pubDate = segment[0].slice(1);

              const itemComments = segment[1].split(") - [")[0];
              const itemTitle = segment[1].split(") - [")[1];
              const itemLink = segment[2].slice(0, -1);
              const date = pubDate.slice(0, 10);
              const time = pubDate.slice(-8);

              return {
                date,
                itemComments,
                itemLink,
                itemTitle,
                time,
              };
            });
        };

        const handleIntersectingEntry = async (entry, queue) => {
          if (entry.isIntersecting) {
            const lastDateTime = document
              .getElementById("latest")
              .querySelector(
                "section:last-child > section > h4 > span"
              ).textContent;

            const nextDateTime = getNextDateTime(lastDateTime ?? "", -1);
            const archiveIndex = await buildArchiveIndex(nextDateTime);
            const nextTimeIndex = archiveIndex.findIndex(
              ({ time }) => time === nextDateTime.slice(-8)
            );

            const handleIndexUpdate = (index, existingIndexValues = []) => {
              index.forEach((i) => {
                existingIndexValues.push(i);
              });
              return existingIndexValues;
            };

            window.hackerNewsState = {
              index: handleIndexUpdate(
                archiveIndex,
                window.hackerNewsState.index
              ),
              nextTimeIndex,
            };

            let currentTimeIndex = nextTimeIndex + 1;
            const items = Object.values(window.hackerNewsState.index);
            for (let item of items) {
              if (currentTimeIndex < window.hackerNewsState.index.length) {
                addNewsItem(items[currentTimeIndex], queue);

                currentTimeIndex = currentTimeIndex + 1;
              }
            }

            queue.flush();
          }
        };

        const archives = document.getElementById("archives");
        const archivesObserver = new IntersectionObserver(
          (entries) => {
            const queue = new UpdateQueue();

            entries.forEach((entry) => handleIntersectingEntry(entry, queue));
          },
          {
            root: null,
            rootMargin: "0px",
            threshold: 0,
          }
        );

        archivesObserver.observe(archives);

        let latestSectionsExpanded = true;
        const handleLatestHeaderClick = () => {
          latestSectionsExpanded = !latestSectionsExpanded;

          if (latestSectionsExpanded) {
            archivesObserver.observe(archives);
          } else {
            archivesObserver.disconnect(archives);
          }

          for (let section of document.querySelectorAll("#latest > section")) {
            section.style.display = latestSectionsExpanded ? "block" : "none";
          }
        };

        const latestHeader = document.querySelector("#latest > h2");
        latestHeader.style.cursor = "pointer";
        latestHeader.addEventListener("click", handleLatestHeaderClick);
      }
    </script>
    <script type="module">
      import { Workbox } from "https://storage.googleapis.com/workbox-cdn/releases/6.4.1/workbox-window.prod.mjs";

      if ("serviceWorker" in navigator) {
        const base = document.querySelector("base");
        const serviceWorkerPath = `${
          base ? base.href.replace(/\/$/, "") : ""
        }/service-worker.js`;

        const wb = new Workbox(serviceWorkerPath);

        // setup event listeners
        wb.addEventListener("waiting", (event) => {
          wb.addEventListener("controlling", () => {
            window.location.reload();
          });

          wb.messageSkipWaiting();
        });

        wb.register();
      }
    </script>
  </body>
</html>
