<!DOCTYPE html>
<html lang="en" xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta charset="utf-8" />
    <meta
      content="width=device-width, initial-scale=1.0, viewport-fit=cover"
      name="viewport"
    />
    <meta name="description" content="Hacker News" />
    <meta name="theme-color" content="#fff" />
    <title>Hacker News</title>
    <link rel="manifest" href="manifest.json" />
    <link
      href="data:image/x-icon;base64,AAABAAEAAQECAAEAAQA4AAAAFgAAACgAAAABAAAAAgAAAAEAAQAAAAAAAAAAAAAAAAAAAAAAAAAAAAABAAEAAQECAAEAAQA4AAAAFgAAACgAAAABAAAAAgAAAAEAAQAAAAAAAAAAAAAAAAAAAAAAAAAA"
      rel="icon"
      type="image/x-icon"
    />
    <link
      href="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAgAAAAIAAQMAAADOtka5AAAAA1BMVEUAAACnej3aAAAANklEQVR42u3BAQEAAACCIP+vbkhAAQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAB8G4IAAAFjdVCkAAAAAElFTkSuQmCC"
      rel="apple-touch-icon"
    />
    <style>
      /*<!--*/
      body {
        color: rgb(25, 25, 25);
        font-family: Verdana, Geneva, sans-serif;
        margin: 0;
      }

      a {
        text-decoration: none;
      }

      a:link,
      a:focus,
      a:hover,
      a:active {
        color: rgb(75, 75, 125);
      }

      a:visited {
        color: rgb(25, 25, 25);
      }

      h1 > a,
      h1 > a:link,
      h1 > a:focus,
      h1 > a:hover,
      h1 > a:active,
      h1 > a:visited,
      h2 > a,
      h2 > a:link,
      h2 > a:focus,
      h2 > a:hover,
      h2 > a:active,
      h2 > a:visited {
        color: rgb(25, 25, 25);
      }

      h1 {
        background-color: rgb(255, 102, 0);
        margin: 0;
        padding: 1rem;
      }

      h2 {
        background-color: rgb(200, 200, 200);
        margin: 1rem 0;
        padding: 0.5rem 0.5rem 0.5rem 1rem;
      }

      #latest > section,
      #archives > section {
        margin: 0 1rem 1rem 1rem;
        padding-bottom: 1rem;
      }

      #latest > section:not(:last-child),
      #archives > section:not(:last-child) {
        border-bottom: 1px dotted rgb(200, 200, 200);
      }

      section > h3 {
        margin: 0 0 0.5rem 0;
      }

      section > h4 {
        font-weight: normal;
        margin: 0 0 0 1rem;
      }

      .descendants-container,
      .points-container {
        align-items: center;
        border-left: 1px solid #333;
        display: inline-flex;
        margin-left: 0.5rem;
        padding-left: 0.5rem;
        text-align: center;
      }

      .points {
        align-items: center;
        display: inline-flex;
        height: 1rem;
        margin-left: 1ch;
        min-width: 3ch;
      }

      .text {
        line-height: 1.5rem;
        margin: 1rem 1rem 0 1rem;
        overflow: auto;
      }

      .text > p:first-child {
        margin-top: 1rem;
      }

      .text > p:last-child {
        margin-bottom: 0;
      }
      /*-->*/
    </style>
  </head>

  <body>
    <main>
      <h1><a href="https://kherrick.github.io/hacker-news/">Hacker News</a></h1>
      <section id="latest">
        <h2>Latest</h2>
        <section id="39049999">
          <h3>
            <a
              class="item"
              href="https://www.atlasobscura.com/articles/ocean-floor-holes-purposes-eels"
              >Why Holes at the Bottom of the Ocean Disappear and Reappear</a
            >
          </h3>
          <section>
            <h4>
              <span>2024-01-19 @ 00:26:28</span
              ><span class="points-container"
                >Points: <span class="points">8</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=39049999"
                  >Comments</a
                ><span class="descendants">: 0</span></span
              >
            </h4>
          </section>
        </section>
        <section id="39049799">
          <h3>
            <a
              class="item"
              href="https://www.theguardian.com/technology/2024/jan/18/instagram-facebook-child-sexual-harassment"
              >Meta documents show 100k children sexually harassed daily on its
              platforms</a
            >
          </h3>
          <section>
            <h4>
              <span>2024-01-19 @ 00:02:29</span
              ><span class="points-container"
                >Points: <span class="points">86</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=39049799"
                  >Comments</a
                ><span class="descendants">: 40</span></span
              >
            </h4>
          </section>
        </section>
        <section id="39049703">
          <h3>
            <a
              class="item"
              href="https://www.nature.com/articles/d41586-024-00130-8"
              >AlphaFold Found Possible Psychedelics</a
            >
          </h3>
          <section>
            <h4>
              <span>2024-01-18 @ 23:53:32</span
              ><span class="points-container"
                >Points: <span class="points">90</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=39049703"
                  >Comments</a
                ><span class="descendants">: 22</span></span
              >
            </h4>
          </section>
        </section>
        <section id="39049691">
          <h3>
            <a
              class="item"
              href="https://upollo.ai/blog/10-second-teleportation"
              >Second Teleportation</a
            >
          </h3>
          <section>
            <h4>
              <span>2024-01-18 @ 23:53:05</span
              ><span class="points-container"
                >Points: <span class="points">31</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=39049691"
                  >Comments</a
                ><span class="descendants">: 23</span></span
              >
            </h4>
          </section>
        </section>
        <section id="39048948">
          <h3>
            <a
              class="item"
              href="https://twitter.com/wenquai/status/1748016021808595242"
              >My AI costs went from $100 to less than $1/day: Fine-tuning
              Mixtral with GPT4</a
            >
          </h3>
          <section>
            <h4>
              <span>2024-01-18 @ 22:43:50</span
              ><span class="points-container"
                >Points: <span class="points">192</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=39048948"
                  >Comments</a
                ><span class="descendants">: 94</span></span
              >
            </h4>
          </section>
        </section>
        <section id="39048317">
          <h3>
            <a
              class="item"
              href="https://gds.blog.gov.uk/2024/01/17/how-we-migrated-our-postgresql-database-with-11-seconds-downtime/"
              >We migrated our PostgreSQL database with 11 seconds downtime</a
            >
          </h3>
          <section>
            <h4>
              <span>2024-01-18 @ 21:51:05</span
              ><span class="points-container"
                >Points: <span class="points">207</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=39048317"
                  >Comments</a
                ><span class="descendants">: 90</span></span
              >
            </h4>
          </section>
        </section>
        <section id="39047825">
          <h3>
            <a
              class="item"
              href="https://gmays.com/how-im-relearning-math-as-an-adult/"
              >How I'm (re)learning math as an adult</a
            >
          </h3>
          <section>
            <h4>
              <span>2024-01-18 @ 21:12:54</span
              ><span class="points-container"
                >Points: <span class="points">70</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=39047825"
                  >Comments</a
                ><span class="descendants">: 39</span></span
              >
            </h4>
          </section>
        </section>
        <section id="39047541">
          <h3>
            <a
              class="item"
              href="https://www.thetransmitter.org/spectrum/noisy-brain-may-underlie-some-of-autisms-sensory-features/"
              >Noisy brain may underlie some of autism's sensory features</a
            >
          </h3>
          <section>
            <h4>
              <span>2024-01-18 @ 20:53:17</span
              ><span class="points-container"
                >Points: <span class="points">135</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=39047541"
                  >Comments</a
                ><span class="descendants">: 69</span></span
              >
            </h4>
          </section>
        </section>
        <section id="39047102">
          <h3>
            <a
              class="item"
              href="https://antigonejournal.com/2024/01/decipherment-linear-b/"
              >Cracking the code of Linear B</a
            >
          </h3>
          <section>
            <h4>
              <span>2024-01-18 @ 20:20:39</span
              ><span class="points-container"
                >Points: <span class="points">67</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=39047102"
                  >Comments</a
                ><span class="descendants">: 8</span></span
              >
            </h4>
          </section>
        </section>
        <section id="39045598">
          <h3>
            <a
              class="item"
              href="https://developer.chrome.com/blog/new-in-webgpu-121"
              >WebGPU is now available on Android</a
            >
          </h3>
          <section>
            <h4>
              <span>2024-01-18 @ 18:29:57</span
              ><span class="points-container"
                >Points: <span class="points">199</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=39045598"
                  >Comments</a
                ><span class="descendants">: 43</span></span
              >
            </h4>
          </section>
        </section>
        <section id="39045153">
          <h3>
            <a
              class="item"
              href="https://www.theverge.com/2024/1/18/24042354/mark-zuckerberg-meta-agi-reorg-interview"
              >Mark Zuckerberg’s new goal is creating artificial general
              intelligence</a
            >
          </h3>
          <section>
            <h4>
              <span>2024-01-18 @ 18:05:02</span
              ><span class="points-container"
                >Points: <span class="points">140</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=39045153"
                  >Comments</a
                ><span class="descendants">: 224</span></span
              >
            </h4>
          </section>
        </section>
        <section id="39044985">
          <h3>
            <a class="item" href="https://www.bbc.com/news/health-67793887"
              >New cancer drug kinder than chemotherapy</a
            >
          </h3>
          <section>
            <h4>
              <span>2024-01-18 @ 17:54:27</span
              ><span class="points-container"
                >Points: <span class="points">192</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=39044985"
                  >Comments</a
                ><span class="descendants">: 107</span></span
              >
            </h4>
          </section>
        </section>
        <section id="39044727">
          <h3>
            <a class="item" href="https://collection.museumoffailure.com/"
              >Virtual tour of Museum of Failure</a
            >
          </h3>
          <section>
            <h4>
              <span>2024-01-18 @ 17:35:11</span
              ><span class="points-container"
                >Points: <span class="points">28</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=39044727"
                  >Comments</a
                ><span class="descendants">: 10</span></span
              >
            </h4>
          </section>
        </section>
        <section id="39044586">
          <h3>
            <a
              class="item"
              href="https://www.construction-physics.com/p/what-happened-to-the-us-machine-tool"
              >What happened to the US machine tool industry?</a
            >
          </h3>
          <section>
            <h4>
              <span>2024-01-18 @ 17:25:43</span
              ><span class="points-container"
                >Points: <span class="points">161</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=39044586"
                  >Comments</a
                ><span class="descendants">: 154</span></span
              >
            </h4>
          </section>
        </section>
        <section id="39043956">
          <h3>
            <a
              class="item"
              href="https://www.thesisdriven.com/p/the-case-for-single-stair-multifamily"
              >The case for single-stair multifamily</a
            >
          </h3>
          <section>
            <h4>
              <span>2024-01-18 @ 16:41:17</span
              ><span class="points-container"
                >Points: <span class="points">217</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=39043956"
                  >Comments</a
                ><span class="descendants">: 358</span></span
              >
            </h4>
          </section>
        </section>
        <section id="39043911">
          <h3>
            <a
              class="item"
              href="https://academic.oup.com/pnasnexus/article/3/1/pgad431/7512761"
              >The value of information gathering in phage–bacteria warfare</a
            >
          </h3>
          <section>
            <h4>
              <span>2024-01-18 @ 16:38:20</span
              ><span class="points-container"
                >Points: <span class="points">42</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=39043911"
                  >Comments</a
                ><span class="descendants">: 7</span></span
              >
            </h4>
          </section>
        </section>
        <section id="39043871">
          <h3>
            <a
              class="item"
              href="https://waxy.org/2024/01/the-quiet-death-of-ellos-big-dreams/"
              >The quiet death of Ello's big dreams</a
            >
          </h3>
          <section>
            <h4>
              <span>2024-01-18 @ 16:35:59</span
              ><span class="points-container"
                >Points: <span class="points">322</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=39043871"
                  >Comments</a
                ><span class="descendants">: 162</span></span
              >
            </h4>
          </section>
        </section>
        <section id="39043810">
          <h3>
            <a
              class="item"
              href="https://jgeekstudies.org/archives/vol-42-december-2017/medjed-from-ancient-egypt-to-japanese-pop-culture/"
              >Medjed: From Ancient Egypt to Japanese Pop Culture (2017)</a
            >
          </h3>
          <section>
            <h4>
              <span>2024-01-18 @ 16:31:44</span
              ><span class="points-container"
                >Points: <span class="points">31</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=39043810"
                  >Comments</a
                ><span class="descendants">: 3</span></span
              >
            </h4>
          </section>
        </section>
        <section id="39043547">
          <h3>
            <a
              class="item"
              href="https://ergaster.org/posts/2024/01/18-escaping-surveillance-capitalism-at-scale/"
              >Escaping surveillance capitalism, at scale</a
            >
          </h3>
          <section>
            <h4>
              <span>2024-01-18 @ 16:14:28</span
              ><span class="points-container"
                >Points: <span class="points">223</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=39043547"
                  >Comments</a
                ><span class="descendants">: 191</span></span
              >
            </h4>
          </section>
        </section>
        <section id="39043306">
          <h3>
            <a
              class="item"
              href="https://spectrum.ieee.org/micro-wind-power-kitepower"
              >Flying kites deliver container-sized power generation</a
            >
          </h3>
          <section>
            <h4>
              <span>2024-01-18 @ 15:56:28</span
              ><span class="points-container"
                >Points: <span class="points">164</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=39043306"
                  >Comments</a
                ><span class="descendants">: 152</span></span
              >
            </h4>
          </section>
        </section>
        <section id="39043282">
          <h3>
            <a
              class="item"
              href="https://scholars-stage.org/history-is-written-by-the-losers/"
              >History Is Written by the Losers (2016)</a
            >
          </h3>
          <section>
            <h4>
              <span>2024-01-18 @ 15:54:35</span
              ><span class="points-container"
                >Points: <span class="points">69</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=39043282"
                  >Comments</a
                ><span class="descendants">: 33</span></span
              >
            </h4>
          </section>
        </section>
        <section id="39042093">
          <h3>
            <a class="item" href="https://news.ycombinator.com/item?id=39042093"
              >Launch HN: Talc AI (YC S23) – Test Sets for AI</a
            >
          </h3>
          <section>
            <h4>
              <span>2024-01-18 @ 14:32:55</span
              ><span class="points-container"
                >Points: <span class="points">87</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=39042093"
                  >Comments</a
                ><span class="descendants">: 38</span></span
              >
            </h4>
            <div class="text">
              <a href="https://talc.ai/demo">https://talc.ai/demo</a>
              <p>
                We’ve found that it's very difficult to know how well LLM
                applications (and especially RAG systems) are going to work in
                the wild. Many companies tackle this by having developers or
                contractors run tests manually. It’s a slow process that holds
                back development, and often results in unexpected behavior when
                the application ships.
              </p>
              <p>
                We’ve dealt with similar problems before; Max was a staff
                engineer working on systematic technical solutions for privacy
                problems at facebook, and Matt worked on ML ops on facebooks’
                election integrity team, helping run classifiers that handled
                trillions of data points. We learned that even the best
                predictive systems need to be deeply understood and trusted to
                be useful to product teams, and set out to build the same
                understanding in AI.
              </p>
              <p>
                To solve this, we take ideas from academia on how to benchmark
                the general capabilities of language models, and apply them to
                generating domain specific test cases that run against your
                actual prompts and code.
              </p>
              <p>
                Consider an analogy: If you’re a lawyer, we don’t need to be
                lawyers to open up a legal textbook and test your knowledge of
                the content. Similarly if you’re building a legal AI
                application, we don’t need to build your application to come up
                with an effective set of tests that can benchmark your
                performance.
              </p>
              <p>
                To make this more concrete - when you pick a topic in the demo,
                we grab the associated wikipedia page and extract a bunch of
                facts from it using a classic NLP technique called “named entity
                recognition”. For example if you picked FreeBASIC, we might
                extract the following line from it:
              </p>
              <p></p>
              <pre><code>    Source of truth: "IDEs specifically made for FreeBASIC include FBide and FbEdit,[5] while more graphical options include WinFBE Suite and VisualFBEditor." 

</code></pre>
              This line is our source of truth. We then use an LLM to work
              backwards from this fact into a question and answer:
              <p></p>
              <pre><code>    Question: "What programming language are the IDEs WinFBE Suite and FbEdit designed to support?"
    Reference Answer: "FreeBasic"

</code></pre>
              We can then evaluate accurately by comparing the reference answer
              and the original source of truth– this is how we generate “simple”
              questions in the demo.
              <p>
                In production we’re building this same functionality on our
                customers' knowledge base instead of wikipedia. We then employ a
                few different strategies to generate questions – these range
                from simple factual questions like “how much does the 2024 chevy
                tahoe cost”, to complex questions like “What would a mechanic
                have to do to fix the recall on my 2018 Golf?” These questions
                are based on facts extracted from your knowledge base and real
                customer examples.
              </p>
              <p>
                This testing and grading process is fast – it’s driven by a
                mixture of LLMs and traditional algorithms, and can turn around
                in minutes. Our business model is pretty simple - we charge for
                each test created. If you opt to use our grading product as well
                we charge for each example graded against the test.
              </p>
              <p>
                We’re excited to hear what the HN community thinks – please let
                us know in the comments if you have any feedback, questions or
                concerns!
              </p>
            </div>
          </section>
        </section>
        <section id="39041520">
          <h3>
            <a
              class="item"
              href="https://blog.polybdenum.com/2024/01/17/identifying-the-collect-vec-memory-leak-footgun.html"
              >Identifying Rust's collect:&amp;gt;() memory leak footgun</a
            >
          </h3>
          <section>
            <h4>
              <span>2024-01-18 @ 13:38:02</span
              ><span class="points-container"
                >Points: <span class="points">152</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=39041520"
                  >Comments</a
                ><span class="descendants">: 91</span></span
              >
            </h4>
          </section>
        </section>
        <section id="39032752">
          <h3>
            <a
              class="item"
              href="https://michael.stapelberg.ch/posts/2024-01-17-systemd-indefinite-service-restarts/"
              >Systemd: Enable Indefinite Service Restarts</a
            >
          </h3>
          <section>
            <h4>
              <span>2024-01-17 @ 20:08:34</span
              ><span class="points-container"
                >Points: <span class="points">92</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=39032752"
                  >Comments</a
                ><span class="descendants">: 47</span></span
              >
            </h4>
          </section>
        </section>
        <section id="39031369">
          <h3>
            <a
              class="item"
              href="https://blogsystem5.substack.com/p/from-0-to-1-mb-in-dos"
              >How DOS was able to use most of the 1 MB address space of the
              8086</a
            >
          </h3>
          <section>
            <h4>
              <span>2024-01-17 @ 18:17:56</span
              ><span class="points-container"
                >Points: <span class="points">71</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=39031369"
                  >Comments</a
                ><span class="descendants">: 29</span></span
              >
            </h4>
          </section>
        </section>
        <section id="39029279">
          <h3>
            <a
              class="item"
              href="https://ntietz.com/blog/rsa-deceptively-simple/"
              >RSA is deceptively simple and fun</a
            >
          </h3>
          <section>
            <h4>
              <span>2024-01-17 @ 15:46:02</span
              ><span class="points-container"
                >Points: <span class="points">91</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=39029279"
                  >Comments</a
                ><span class="descendants">: 43</span></span
              >
            </h4>
          </section>
        </section>
        <section id="39028122">
          <h3>
            <a
              class="item"
              href="https://www.troyhunt.com/inside-the-massive-naz-api-credential-stuffing-list/"
              >The Naz.API Credential Stuffing List</a
            >
          </h3>
          <section>
            <h4>
              <span>2024-01-17 @ 14:27:52</span
              ><span class="points-container"
                >Points: <span class="points">108</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=39028122"
                  >Comments</a
                ><span class="descendants">: 128</span></span
              >
            </h4>
          </section>
        </section>
        <section id="39025631">
          <h3>
            <a class="item" href="https://bleuje.com/randomanimations/"
              >Random Animations</a
            >
          </h3>
          <section>
            <h4>
              <span>2024-01-17 @ 09:51:43</span
              ><span class="points-container"
                >Points: <span class="points">103</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=39025631"
                  >Comments</a
                ><span class="descendants">: 20</span></span
              >
            </h4>
          </section>
        </section>
        <section id="39024102">
          <h3>
            <a
              class="item"
              href="https://gustedt.wordpress.com/2024/01/16/white-space-does-matter-in-c23/"
              >White space does matter in C23</a
            >
          </h3>
          <section>
            <h4>
              <span>2024-01-17 @ 06:45:15</span
              ><span class="points-container"
                >Points: <span class="points">86</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=39024102"
                  >Comments</a
                ><span class="descendants">: 34</span></span
              >
            </h4>
          </section>
        </section>
        <section id="39007384">
          <h3>
            <a
              class="item"
              href="https://www.hezmatt.org/~mpalmer/blog/2024/01/16/pwned-certificates-on-the-fediverse.html"
              >Pwned Certificates on the Fediverse</a
            >
          </h3>
          <section>
            <h4>
              <span>2024-01-15 @ 23:19:32</span
              ><span class="points-container"
                >Points: <span class="points">97</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=39007384"
                  >Comments</a
                ><span class="descendants">: 17</span></span
              >
            </h4>
          </section>
        </section>
      </section>
      <section id="archives">
        <h2>
          <a
            href="https://github.com/kherrick/hacker-news/blob/main/archives/index.md"
            >Archives</a
          >
        </h2>
        <section>
          <h3>
            <a
              href="https://github.com/kherrick/hacker-news/blob/main/archives/2024/index.md"
              >2024</a
            >
          </h3>
        </section>
        <section>
          <h3>
            <a
              href="https://github.com/kherrick/hacker-news/blob/main/archives/2023/index.md"
              >2023</a
            >
          </h3>
        </section>
        <section>
          <h3>
            <a
              href="https://github.com/kherrick/hacker-news/blob/main/archives/2022/index.md"
              >2022</a
            >
          </h3>
        </section>
      </section>
    </main>
    <script type="module">
      import { buildDescendants } from "./lib/build-html-descendants.js";
      import { buildNextItem } from "./lib/build-html-next-item.js";
      import { getNextDateTime } from "./lib/date-time.js";

      const updateSectionById = (id) =>
        fetch(`https://hacker-news.firebaseio.com/v0/item/${id}.json`).then(
          (result) =>
            result.json().then(({ descendants, id, score, text, type }) => {
              const currentItem = document.getElementById(id);

              if (score) {
                currentItem.querySelector(".points").textContent = score;
              }

              if (descendants && (type === "poll" || type === "story")) {
                const currentDescendants =
                  currentItem.querySelector(".descendants");

                if (currentDescendants) {
                  currentDescendants.textContent = `: ${descendants}`;
                } else {
                  const comments = buildDescendants(
                    document,
                    descendants,
                    `https://news.ycombinator.com/item?id=${id}`
                  );

                  currentItem.querySelector("h4").appendChild(comments);
                }
              }

              if (text) {
                const currentText = currentItem.querySelector(".text");

                if (currentText) {
                  currentText.innerHTML = text.replace(/\0/g, "");
                } else {
                  const content = document.createElement("div");
                  content.innerHTML = text.replace(/\0/g, "");
                  content.setAttribute("class", "text");

                  currentItem.appendChild(content);
                }
              }
            })
        );

      class UpdateQueue {
        constructor() {
          this._ids = [];
          this._isUpdating = false;
        }

        addItemById(id) {
          this._ids.push(id);
        }

        async flush() {
          const id = this._ids.shift();

          if (id) {
            this._isUpdating = true;

            await updateSectionById(id);
            await this.flush();
          } else {
            this._isUpdating = false;

            setTimeout(async () => {
              if (!this._isUpdating && this._ids && this._ids.length) {
                await this.flush();
              }
            }, 0);
          }
        }
      }

      // get latest data
      const latestSection = document.getElementById("latest");

      for (let item of latestSection.querySelectorAll("section[id]")) {
        updateSectionById(item.getAttribute("id"));
      }

      if ("IntersectionObserver" in window) {
        window.hackerNewsState = { index: [], nextTimeIndex: -1 };

        const addNewsItem = async (newsItem, queue) => {
          try {
            const { date, time, itemComments, itemTitle, itemLink } = newsItem;
            const section = await buildNextItem({
              document,
              dateTime: `${date}, ${time}`,
              itemComments,
              itemLink,
              itemTitle: new DOMParser().parseFromString(
                itemTitle.replace(/\\/g, ""),
                "text/html"
              ).documentElement.textContent,
              fetchItemDetails: false,
            });

            // display loading indicator for section
            section.querySelector(".points-container").innerHTML =
              'Points: <span class="points"><img style="height: 100%;" src="lib/images/loading.svg" /></span>';

            const id = section.getAttribute("id");
            if (!document.getElementById(id)) {
              document.getElementById("latest").appendChild(section);

              queue.addItemById(id);
            }
          } catch (error) {}
        };

        const buildArchiveIndex = async (lastDateTime) => {
          const nextDate = lastDateTime.slice(0, 10);
          const nextYear = nextDate.slice(0, 4);

          return (
            await (
              await fetch(
                `https://raw.githubusercontent.com/kherrick/hacker-news/main/archives/${nextYear}/${nextDate}/index.md`
              )
            ).text()
          )
            .split("\n")
            .filter((line) => line.match(new RegExp("^\\* \\[")))
            .map((line) => {
              const segment = line.replace("* ", "").split("](");
              const pubDate = segment[0].slice(1);

              const itemComments = segment[1].split(") - [")[0];
              const itemTitle = segment[1].split(") - [")[1];
              const itemLink = segment[2].slice(0, -1);
              const date = pubDate.slice(0, 10);
              const time = pubDate.slice(-8);

              return {
                date,
                itemComments,
                itemLink,
                itemTitle,
                time,
              };
            });
        };

        const handleIntersectingEntry = async (entry, queue) => {
          if (entry.isIntersecting) {
            const lastDateTime = document
              .getElementById("latest")
              .querySelector(
                "section:last-child > section > h4 > span"
              ).textContent;

            const nextDateTime = getNextDateTime(lastDateTime ?? "", -1);
            const archiveIndex = await buildArchiveIndex(nextDateTime);
            const nextTimeIndex = archiveIndex.findIndex(
              ({ time }) => time === nextDateTime.slice(-8)
            );

            const handleIndexUpdate = (index, existingIndexValues = []) => {
              index.forEach((i) => {
                existingIndexValues.push(i);
              });
              return existingIndexValues;
            };

            window.hackerNewsState = {
              index: handleIndexUpdate(
                archiveIndex,
                window.hackerNewsState.index
              ),
              nextTimeIndex,
            };

            let currentTimeIndex = nextTimeIndex + 1;
            const items = Object.values(window.hackerNewsState.index);
            for (let item of items) {
              if (currentTimeIndex < window.hackerNewsState.index.length) {
                addNewsItem(items[currentTimeIndex], queue);

                currentTimeIndex = currentTimeIndex + 1;
              }
            }

            queue.flush();
          }
        };

        const archives = document.getElementById("archives");
        const archivesObserver = new IntersectionObserver(
          (entries) => {
            const queue = new UpdateQueue();

            entries.forEach((entry) => handleIntersectingEntry(entry, queue));
          },
          {
            root: null,
            rootMargin: "0px",
            threshold: 0,
          }
        );

        archivesObserver.observe(archives);

        let latestSectionsExpanded = true;
        const handleLatestHeaderClick = () => {
          latestSectionsExpanded = !latestSectionsExpanded;

          if (latestSectionsExpanded) {
            archivesObserver.observe(archives);
          } else {
            archivesObserver.disconnect(archives);
          }

          for (let section of document.querySelectorAll("#latest > section")) {
            section.style.display = latestSectionsExpanded ? "block" : "none";
          }
        };

        const latestHeader = document.querySelector("#latest > h2");
        latestHeader.style.cursor = "pointer";
        latestHeader.addEventListener("click", handleLatestHeaderClick);
      }
    </script>
    <script type="module">
      import { Workbox } from "https://storage.googleapis.com/workbox-cdn/releases/6.4.1/workbox-window.prod.mjs";

      if ("serviceWorker" in navigator) {
        const base = document.querySelector("base");
        const serviceWorkerPath = `${
          base ? base.href.replace(/\/$/, "") : ""
        }/service-worker.js`;

        const wb = new Workbox(serviceWorkerPath);

        // setup event listeners
        wb.addEventListener("waiting", (event) => {
          wb.addEventListener("controlling", () => {
            window.location.reload();
          });

          wb.messageSkipWaiting();
        });

        wb.register();
      }
    </script>
  </body>
</html>
