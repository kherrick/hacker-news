<!DOCTYPE html>
<html lang="en" xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta charset="utf-8" />
    <meta
      content="width=device-width, initial-scale=1.0, viewport-fit=cover"
      name="viewport"
    />
    <meta name="description" content="Hacker News" />
    <meta name="theme-color" content="#fff" />
    <title>Hacker News</title>
    <link rel="manifest" href="manifest.json" />
    <link
      href="data:image/x-icon;base64,AAABAAEAAQECAAEAAQA4AAAAFgAAACgAAAABAAAAAgAAAAEAAQAAAAAAAAAAAAAAAAAAAAAAAAAAAAABAAEAAQECAAEAAQA4AAAAFgAAACgAAAABAAAAAgAAAAEAAQAAAAAAAAAAAAAAAAAAAAAAAAAA"
      rel="icon"
      type="image/x-icon"
    />
    <link
      href="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAgAAAAIAAQMAAADOtka5AAAAA1BMVEUAAACnej3aAAAANklEQVR42u3BAQEAAACCIP+vbkhAAQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAB8G4IAAAFjdVCkAAAAAElFTkSuQmCC"
      rel="apple-touch-icon"
    />
    <style>
      /*<!--*/
      body {
        color: rgb(25, 25, 25);
        font-family: Verdana, Geneva, sans-serif;
        margin: 0;
      }

      a {
        text-decoration: none;
      }

      a:link,
      a:focus,
      a:hover,
      a:active {
        color: rgb(75, 75, 125);
      }

      a:visited {
        color: rgb(25, 25, 25);
      }

      h1 > a,
      h1 > a:link,
      h1 > a:focus,
      h1 > a:hover,
      h1 > a:active,
      h1 > a:visited,
      h2 > a,
      h2 > a:link,
      h2 > a:focus,
      h2 > a:hover,
      h2 > a:active,
      h2 > a:visited {
        color: rgb(25, 25, 25);
      }

      h1 {
        background-color: rgb(255, 102, 0);
        margin: 0;
        padding: 1rem;
      }

      h2 {
        background-color: rgb(200, 200, 200);
        margin: 1rem 0;
        padding: 0.5rem 0.5rem 0.5rem 1rem;
      }

      #latest > section,
      #archives > section {
        margin: 0 1rem 1rem 1rem;
        padding-bottom: 1rem;
      }

      #latest > section:not(:last-child),
      #archives > section:not(:last-child) {
        border-bottom: 1px dotted rgb(200, 200, 200);
      }

      section > h3 {
        margin: 0 0 0.5rem 0;
      }

      section > h4 {
        font-weight: normal;
        margin: 0 0 0 1rem;
      }

      .descendants-container,
      .points-container {
        align-items: center;
        border-left: 1px solid #333;
        display: inline-flex;
        margin-left: 0.5rem;
        padding-left: 0.5rem;
        text-align: center;
      }

      .points {
        align-items: center;
        display: inline-flex;
        height: 1rem;
        margin-left: 1ch;
        min-width: 3ch;
      }

      .text {
        line-height: 1.5rem;
        margin: 1rem 1rem 0 1rem;
        overflow: auto;
      }

      .text > p:first-child {
        margin-top: 1rem;
      }

      .text > p:last-child {
        margin-bottom: 0;
      }
      /*-->*/
    </style>
  </head>

  <body>
    <main>
      <h1><a href="https://kherrick.github.io/hacker-news/">Hacker News</a></h1>
      <section id="latest">
        <h2>Latest</h2>
        <section id="39605453">
          <h3>
            <a
              class="item"
              href="https://www.cnn.com/2024/03/04/business/red-sea-cables-cut-internet/index.html"
              >Red Sea cables have been damaged, disrupting internet traffic</a
            >
          </h3>
          <section>
            <h4>
              <span>2024-03-05 @ 16:11:38</span
              ><span class="points-container"
                >Points: <span class="points">13</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=39605453"
                  >Comments</a
                ><span class="descendants">: 7</span></span
              >
            </h4>
          </section>
        </section>
        <section id="39605438">
          <h3>
            <a
              class="item"
              href="https://simonwillison.net/2024/Mar/5/prompt-injection-jailbreaking/"
              >Prompt injection and jailbreaking are not the same thing</a
            >
          </h3>
          <section>
            <h4>
              <span>2024-03-05 @ 16:10:20</span
              ><span class="points-container"
                >Points: <span class="points">6</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=39605438"
                  >Comments</a
                ><span class="descendants">: 0</span></span
              >
            </h4>
          </section>
        </section>
        <section id="39604961">
          <h3>
            <a class="item" href="https://news.ycombinator.com/item?id=39604961"
              >Launch HN: Greptile (YC W24) - RAG on codebases that actually
              works</a
            >
          </h3>
          <section>
            <h4>
              <span>2024-03-05 @ 15:48:56</span
              ><span class="points-container"
                >Points: <span class="points">18</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=39604961"
                  >Comments</a
                ><span class="descendants">: 8</span></span
              >
            </h4>
            <div class="text">
              <a href="https://youtu.be/qI24eKO1YX0"
                >https://youtu.be/qI24eKO1YX0</a
              >. You can try it on 100 popular repos here:
              <a href="https://app.greptile.com/repo"
                >https://app.greptile.com/repo</a
              >, and on your own repo (if you give permission - more on that
              below) here:
              <a href="https://app.greptile.com">https://app.greptile.com</a>.
              <p>
                We are far from the first people to try "RAG on your codebase".
                We focus on full codebase comprehension: using LLMs to
                accurately answer difficult questions with full context of
                large, complex, and even multi-repo codebases.
              </p>
              <p>
                Simple RAG alone is not sufficient for this task. Codebases
                aren’t like most PDFs, docs, or other similar data types. They
                are graphs—complex puzzles where each piece is interlinked. So
                Greptile does a few things past simple RAG:
              </p>
              <p>
                (1) Instead of directly embedding code, we parse the AST of the
                codebase, recursively generate docstrings for each node in the
                tree, and then embed the docstrings.
              </p>
              <p>
                (2) Alongside vector similarity search and keyword search, we do
                “agentic search” where an agent reviews the relevance of the
                search results, and scans the source code to follow references
                that might lead to something important. Then it returns the
                relevant sources.
              </p>
              <p>
                For example, here are a couple questions that this system is
                able to answer in our test repo that simple RAG couldn’t (in our
                experience):
              </p>
              <p>
                “<i>Where are the auth providers configured?</i>” (They are in
                an array inside of an options.ts file, where looking at the file
                it’s not obvious it’s an auth related file. However, because
                that array is imported into the auth/route.ts file, Greptile’s
                agent traces and find it)
              </p>
              <p>
                “<i>How would I add a postgres connector?</i>” (The best way to
                answer this is to see how the Redis connector is set up and
                mirror it. Simple RAG sometimes retrieves some of the code for
                the Redis connector, but Greptile’s agent follows the
                connections to retrieve all the code that the redis connector
                touches, and uses that to write instructions.)
              </p>
              <p>
                Developers (including at Stripe and Microsoft) are using
                Greptile for things like:
              </p>
              <p>
                Debugging—you can paste in an error message and it does a pretty
                good job of diagnosing the root cause and suggesting fixes.
              </p>
              <p>
                Grokking OSS repos—for example, if you're forking a repo,
                modifying it for your usecase, or just integrating it, Greptile
                lets you add multiple repos and dependencies in the same chat
                session so it has full context.
              </p>
              <p>
                Parsing legacy code at work—especially if original engineers
                have left the company.
              </p>
              <p>
                Since we're accessing your private code, we're very careful with
                security. We don't store any code on our servers after initial
                processing, and just pull snippets as needed from the GitHub
                API.
              </p>
              <p>
                Quick note: when you sign in with GH, it might ask for
                permission to "act on your behalf". This is a quirk of GitHub's
                wording—our permissions are read-only and the only thing we do
                "on your behalf" is read code, so we can index the repo.
              </p>
              <p>
                We came up with this idea while working at AWS—the codebase was
                super complicated, the docs were sparse and out of date, and our
                team was remote so it was slow to get answers to questions. We
                picked "greptile" because of "grep" and also we just wanted a
                somewhat silly name.
              </p>
              <p>
                Try it out! It's a work in progress, so any feedback is
                appreciated. Here are the links again: for popular open source
                repos see
                <a href="https://app.greptile.com/repo"
                  >https://app.greptile.com/repo</a
                >, and to get it working on your own repo, start at
                <a href="https://app.greptile.com">https://app.greptile.com</a>.
              </p>
              <p>
                If you have experience working with a complex codebase at work
                or for a project, I’d love to hear about it. It really helps us
                educate our product direction. Looking forward to comments!
              </p>
            </div>
          </section>
        </section>
        <section id="39604745">
          <h3>
            <a
              class="item"
              href="https://www.cgchannel.com/2024/02/open-source-project-zluda-lets-cuda-apps-run-on-amd-gpus/"
              >Open-source project ZLUDA lets CUDA apps run on AMD GPUs</a
            >
          </h3>
          <section>
            <h4>
              <span>2024-03-05 @ 15:36:27</span
              ><span class="points-container"
                >Points: <span class="points">87</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=39604745"
                  >Comments</a
                ><span class="descendants">: 18</span></span
              >
            </h4>
          </section>
        </section>
        <section id="39604590">
          <h3>
            <a class="item" href="https://metastatus.com/">Meta outage</a>
          </h3>
          <section>
            <h4>
              <span>2024-03-05 @ 15:27:43</span
              ><span class="points-container"
                >Points: <span class="points">355</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=39604590"
                  >Comments</a
                ><span class="descendants">: 260</span></span
              >
            </h4>
          </section>
        </section>
        <section id="39604320">
          <h3>
            <a
              class="item"
              href="https://www.theregister.com/2024/03/05/tesla_berlin_arson_attack/"
              >Tesla Berlin gigafactory goes dark after alleged eco-sabotage</a
            >
          </h3>
          <section>
            <h4>
              <span>2024-03-05 @ 15:06:00</span
              ><span class="points-container"
                >Points: <span class="points">12</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=39604320"
                  >Comments</a
                ><span class="descendants">: 3</span></span
              >
            </h4>
          </section>
        </section>
        <section id="39602472">
          <h3>
            <a class="item" href="https://shenlanguage.org/"
              >The Shen Programming Language</a
            >
          </h3>
          <section>
            <h4>
              <span>2024-03-05 @ 12:30:22</span
              ><span class="points-container"
                >Points: <span class="points">101</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=39602472"
                  >Comments</a
                ><span class="descendants">: 27</span></span
              >
            </h4>
          </section>
        </section>
        <section id="39602343">
          <h3>
            <a class="item" href="https://jasongriffey.net/librarybox/"
              >LibraryBox</a
            >
          </h3>
          <section>
            <h4>
              <span>2024-03-05 @ 12:12:48</span
              ><span class="points-container"
                >Points: <span class="points">57</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=39602343"
                  >Comments</a
                ><span class="descendants">: 23</span></span
              >
            </h4>
          </section>
        </section>
        <section id="39602023">
          <h3>
            <a class="item" href="https://blog.cloudflare.com/firewall-for-ai"
              >Cloudflare Announces Firewall for AI</a
            >
          </h3>
          <section>
            <h4>
              <span>2024-03-05 @ 11:26:39</span
              ><span class="points-container"
                >Points: <span class="points">183</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=39602023"
                  >Comments</a
                ><span class="descendants">: 91</span></span
              >
            </h4>
          </section>
        </section>
        <section id="39601710">
          <h3>
            <a class="item" href="https://arxiv.org/abs/2207.08815"
              >Why do tree-based models still outperform deep learning on
              tabular data? (2022)</a
            >
          </h3>
          <section>
            <h4>
              <span>2024-03-05 @ 10:44:01</span
              ><span class="points-container"
                >Points: <span class="points">97</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=39601710"
                  >Comments</a
                ><span class="descendants">: 41</span></span
              >
            </h4>
          </section>
        </section>
        <section id="39601538">
          <h3>
            <a
              class="item"
              href="https://metro.co.uk/2024/03/03/spend-8-500-a-year-live-a-train-20388001/"
              >I spend £8,500 a year to live on a train</a
            >
          </h3>
          <section>
            <h4>
              <span>2024-03-05 @ 10:22:09</span
              ><span class="points-container"
                >Points: <span class="points">254</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=39601538"
                  >Comments</a
                ><span class="descendants">: 317</span></span
              >
            </h4>
          </section>
        </section>
        <section id="39601201">
          <h3>
            <a class="item" href="http://libraryofjuggling.com/"
              >Library of Juggling</a
            >
          </h3>
          <section>
            <h4>
              <span>2024-03-05 @ 09:34:35</span
              ><span class="points-container"
                >Points: <span class="points">74</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=39601201"
                  >Comments</a
                ><span class="descendants">: 17</span></span
              >
            </h4>
          </section>
        </section>
        <section id="39600810">
          <h3>
            <a
              class="item"
              href="https://app.radicle.xyz/nodes/seed.radicle.garden/rad:z3gqcJUoA1n9HaHKufZs5FCSGazv5"
              >Radicle: Open-Source, Peer-to-Peer, GitHub Alternative</a
            >
          </h3>
          <section>
            <h4>
              <span>2024-03-05 @ 08:39:10</span
              ><span class="points-container"
                >Points: <span class="points">482</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=39600810"
                  >Comments</a
                ><span class="descendants">: 155</span></span
              >
            </h4>
          </section>
        </section>
        <section id="39600031">
          <h3>
            <a class="item" href="https://github.com/ortuman/nuke"
              >Nuke: A memory arena implementation for Go</a
            >
          </h3>
          <section>
            <h4>
              <span>2024-03-05 @ 06:22:03</span
              ><span class="points-container"
                >Points: <span class="points">56</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=39600031"
                  >Comments</a
                ><span class="descendants">: 13</span></span
              >
            </h4>
          </section>
        </section>
        <section id="39599958">
          <h3>
            <a
              class="item"
              href="https://stability.ai/news/stable-diffusion-3-research-paper"
              >Stable Diffusion 3: Research Paper</a
            >
          </h3>
          <section>
            <h4>
              <span>2024-03-05 @ 06:05:05</span
              ><span class="points-container"
                >Points: <span class="points">300</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=39599958"
                  >Comments</a
                ><span class="descendants">: 45</span></span
              >
            </h4>
          </section>
        </section>
        <section id="39598903">
          <h3>
            <a
              class="item"
              href="https://www.fundablestartups.com/blog/half-a-billion"
              >Sell for half a billion and get nothing (2021)</a
            >
          </h3>
          <section>
            <h4>
              <span>2024-03-05 @ 02:47:59</span
              ><span class="points-container"
                >Points: <span class="points">312</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=39598903"
                  >Comments</a
                ><span class="descendants">: 260</span></span
              >
            </h4>
          </section>
        </section>
        <section id="39598189">
          <h3>
            <a
              class="item"
              href="https://arstechnica.com/cars/2024/03/carmakers-must-bring-back-buttons-to-get-good-safety-scores-in-europe/"
              >European crash tester says carmakers must bring back physical
              controls</a
            >
          </h3>
          <section>
            <h4>
              <span>2024-03-05 @ 01:02:57</span
              ><span class="points-container"
                >Points: <span class="points">903</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=39598189"
                  >Comments</a
                ><span class="descendants">: 557</span></span
              >
            </h4>
          </section>
        </section>
        <section id="39598170">
          <h3>
            <a
              class="item"
              href="https://www.ycombinator.com/companies/codecrafters/jobs/M2ELjtC-influencer-partnerships-manager"
              >CodeCrafters (YC S22) is hiring an influencer manager (interns
              welcome)</a
            >
          </h3>
          <section>
            <h4>
              <span>2024-03-05 @ 01:00:08</span
              ><span class="points-container"
                >Points: <span class="points">1</span></span
              >
            </h4>
          </section>
        </section>
        <section id="39597525">
          <h3>
            <a
              class="item"
              href="https://www.esquire.com/entertainment/music/a46871755/james-kaplan-miles-davis-3-shades-of-blue-excerpt/"
              >Miles Davis and the recording of Kind of Blue</a
            >
          </h3>
          <section>
            <h4>
              <span>2024-03-04 @ 23:22:47</span
              ><span class="points-container"
                >Points: <span class="points">234</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=39597525"
                  >Comments</a
                ><span class="descendants">: 111</span></span
              >
            </h4>
          </section>
        </section>
        <section id="39597131">
          <h3>
            <a
              class="item"
              href="https://www.bytesizego.com/blog/keeping-alive-with-go"
              >How I keep myself alive using Golang</a
            >
          </h3>
          <section>
            <h4>
              <span>2024-03-04 @ 22:42:04</span
              ><span class="points-container"
                >Points: <span class="points">592</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=39597131"
                  >Comments</a
                ><span class="descendants">: 103</span></span
              >
            </h4>
          </section>
        </section>
        <section id="39597030">
          <h3>
            <a class="item" href="https://github.com/HeyPuter/puter"
              >Show HN: 3 years and 1M users later, I just open-sourced my
              "Internet OS"</a
            >
          </h3>
          <section>
            <h4>
              <span>2024-03-04 @ 22:31:15</span
              ><span class="points-container"
                >Points: <span class="points">1020</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=39597030"
                  >Comments</a
                ><span class="descendants">: 255</span></span
              >
            </h4>
          </section>
        </section>
        <section id="39592444">
          <h3>
            <a class="item" href="https://www.hillelwayne.com/post/graph-types/"
              >The hunt for the missing data type</a
            >
          </h3>
          <section>
            <h4>
              <span>2024-03-04 @ 16:42:14</span
              ><span class="points-container"
                >Points: <span class="points">613</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=39592444"
                  >Comments</a
                ><span class="descendants">: 221</span></span
              >
            </h4>
          </section>
        </section>
        <section id="39588895">
          <h3>
            <a class="item" href="https://en.wikipedia.org/wiki/Flexagon"
              >Flexagon</a
            >
          </h3>
          <section>
            <h4>
              <span>2024-03-04 @ 10:35:27</span
              ><span class="points-container"
                >Points: <span class="points">92</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=39588895"
                  >Comments</a
                ><span class="descendants">: 18</span></span
              >
            </h4>
          </section>
        </section>
        <section id="39588745">
          <h3>
            <a class="item" href="https://celso.io/posts/2024/03/03/c128-cpm/"
              >Running CP/M on the C128</a
            >
          </h3>
          <section>
            <h4>
              <span>2024-03-04 @ 10:08:32</span
              ><span class="points-container"
                >Points: <span class="points">74</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=39588745"
                  >Comments</a
                ><span class="descendants">: 20</span></span
              >
            </h4>
          </section>
        </section>
        <section id="39587535">
          <h3>
            <a
              class="item"
              href="https://quuxplusone.github.io/blog/2024/03/03/infinite-craft-theory/"
              >The algebraic structure of Infinite Craft</a
            >
          </h3>
          <section>
            <h4>
              <span>2024-03-04 @ 06:19:40</span
              ><span class="points-container"
                >Points: <span class="points">69</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=39587535"
                  >Comments</a
                ><span class="descendants">: 5</span></span
              >
            </h4>
          </section>
        </section>
        <section id="39581398">
          <h3>
            <a
              class="item"
              href="https://chloelist.substack.com/p/issue-12-mustard"
              >Mustard</a
            >
          </h3>
          <section>
            <h4>
              <span>2024-03-03 @ 15:25:51</span
              ><span class="points-container"
                >Points: <span class="points">91</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=39581398"
                  >Comments</a
                ><span class="descendants">: 50</span></span
              >
            </h4>
          </section>
        </section>
        <section id="39580647">
          <h3>
            <a class="item" href="https://arcinstitute.org/news/blog/evo"
              >Evo: DNA foundation modeling from molecular to genome scale</a
            >
          </h3>
          <section>
            <h4>
              <span>2024-03-03 @ 13:18:03</span
              ><span class="points-container"
                >Points: <span class="points">36</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=39580647"
                  >Comments</a
                ><span class="descendants">: 3</span></span
              >
            </h4>
          </section>
        </section>
        <section id="39579480">
          <h3>
            <a
              class="item"
              href="https://themarkup.org/automated-censorship/2024/03/01/how-automated-content-moderation-works-even-when-it-doesnt-work"
              >How Automated Content Moderation Works (Even When It Doesn't)</a
            >
          </h3>
          <section>
            <h4>
              <span>2024-03-03 @ 08:47:23</span
              ><span class="points-container"
                >Points: <span class="points">18</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=39579480"
                  >Comments</a
                ><span class="descendants">: 0</span></span
              >
            </h4>
          </section>
        </section>
        <section id="39579253">
          <h3>
            <a
              class="item"
              href="https://www.snohetta.com/projects/beijing-city-library"
              >The largest climatized reading space</a
            >
          </h3>
          <section>
            <h4>
              <span>2024-03-03 @ 07:51:50</span
              ><span class="points-container"
                >Points: <span class="points">44</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=39579253"
                  >Comments</a
                ><span class="descendants">: 50</span></span
              >
            </h4>
          </section>
        </section>
        <section id="39572164">
          <h3>
            <a
              class="item"
              href="https://dmytrobaida.github.io/recursion-viewer/"
              >Recursion Viewer</a
            >
          </h3>
          <section>
            <h4>
              <span>2024-03-02 @ 12:39:19</span
              ><span class="points-container"
                >Points: <span class="points">85</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=39572164"
                  >Comments</a
                ><span class="descendants">: 13</span></span
              >
            </h4>
          </section>
        </section>
      </section>
      <section id="archives">
        <h2>
          <a
            href="https://github.com/kherrick/hacker-news/blob/main/archives/index.md"
            >Archives</a
          >
        </h2>
        <section>
          <h3>
            <a
              href="https://github.com/kherrick/hacker-news/blob/main/archives/2024/index.md"
              >2024</a
            >
          </h3>
        </section>
        <section>
          <h3>
            <a
              href="https://github.com/kherrick/hacker-news/blob/main/archives/2023/index.md"
              >2023</a
            >
          </h3>
        </section>
        <section>
          <h3>
            <a
              href="https://github.com/kherrick/hacker-news/blob/main/archives/2022/index.md"
              >2022</a
            >
          </h3>
        </section>
      </section>
    </main>
    <script type="module">
      import { buildDescendants } from "./lib/build-html-descendants.js";
      import { buildNextItem } from "./lib/build-html-next-item.js";
      import { getNextDateTime } from "./lib/date-time.js";

      const updateSectionById = (id) =>
        fetch(`https://hacker-news.firebaseio.com/v0/item/${id}.json`).then(
          (result) =>
            result.json().then(({ descendants, id, score, text, type }) => {
              const currentItem = document.getElementById(id);

              if (score) {
                currentItem.querySelector(".points").textContent = score;
              }

              if (descendants && (type === "poll" || type === "story")) {
                const currentDescendants =
                  currentItem.querySelector(".descendants");

                if (currentDescendants) {
                  currentDescendants.textContent = `: ${descendants}`;
                } else {
                  const comments = buildDescendants(
                    document,
                    descendants,
                    `https://news.ycombinator.com/item?id=${id}`
                  );

                  currentItem.querySelector("h4").appendChild(comments);
                }
              }

              if (text) {
                const currentText = currentItem.querySelector(".text");

                if (currentText) {
                  currentText.innerHTML = text.replace(/\0/g, "");
                } else {
                  const content = document.createElement("div");
                  content.innerHTML = text.replace(/\0/g, "");
                  content.setAttribute("class", "text");

                  currentItem.appendChild(content);
                }
              }
            })
        );

      class UpdateQueue {
        constructor() {
          this._ids = [];
          this._isUpdating = false;
        }

        addItemById(id) {
          this._ids.push(id);
        }

        async flush() {
          const id = this._ids.shift();

          if (id) {
            this._isUpdating = true;

            await updateSectionById(id);
            await this.flush();
          } else {
            this._isUpdating = false;

            setTimeout(async () => {
              if (!this._isUpdating && this._ids && this._ids.length) {
                await this.flush();
              }
            }, 0);
          }
        }
      }

      // get latest data
      const latestSection = document.getElementById("latest");

      for (let item of latestSection.querySelectorAll("section[id]")) {
        updateSectionById(item.getAttribute("id"));
      }

      if ("IntersectionObserver" in window) {
        window.hackerNewsState = { index: [], nextTimeIndex: -1 };

        const addNewsItem = async (newsItem, queue) => {
          try {
            const { date, time, itemComments, itemTitle, itemLink } = newsItem;
            const section = await buildNextItem({
              document,
              dateTime: `${date}, ${time}`,
              itemComments,
              itemLink,
              itemTitle: new DOMParser().parseFromString(
                itemTitle.replace(/\\/g, ""),
                "text/html"
              ).documentElement.textContent,
              fetchItemDetails: false,
            });

            // display loading indicator for section
            section.querySelector(".points-container").innerHTML =
              'Points: <span class="points"><img style="height: 100%;" src="lib/images/loading.svg" /></span>';

            const id = section.getAttribute("id");
            if (!document.getElementById(id)) {
              document.getElementById("latest").appendChild(section);

              queue.addItemById(id);
            }
          } catch (error) {}
        };

        const buildArchiveIndex = async (lastDateTime) => {
          const nextDate = lastDateTime.slice(0, 10);
          const nextYear = nextDate.slice(0, 4);

          return (
            await (
              await fetch(
                `https://raw.githubusercontent.com/kherrick/hacker-news/main/archives/${nextYear}/${nextDate}/index.md`
              )
            ).text()
          )
            .split("\n")
            .filter((line) => line.match(new RegExp("^\\* \\[")))
            .map((line) => {
              const segment = line.replace("* ", "").split("](");
              const pubDate = segment[0].slice(1);

              const itemComments = segment[1].split(") - [")[0];
              const itemTitle = segment[1].split(") - [")[1];
              const itemLink = segment[2].slice(0, -1);
              const date = pubDate.slice(0, 10);
              const time = pubDate.slice(-8);

              return {
                date,
                itemComments,
                itemLink,
                itemTitle,
                time,
              };
            });
        };

        const handleIntersectingEntry = async (entry, queue) => {
          if (entry.isIntersecting) {
            const lastDateTime = document
              .getElementById("latest")
              .querySelector(
                "section:last-child > section > h4 > span"
              ).textContent;

            const nextDateTime = getNextDateTime(lastDateTime ?? "", -1);
            const archiveIndex = await buildArchiveIndex(nextDateTime);
            const nextTimeIndex = archiveIndex.findIndex(
              ({ time }) => time === nextDateTime.slice(-8)
            );

            const handleIndexUpdate = (index, existingIndexValues = []) => {
              index.forEach((i) => {
                existingIndexValues.push(i);
              });
              return existingIndexValues;
            };

            window.hackerNewsState = {
              index: handleIndexUpdate(
                archiveIndex,
                window.hackerNewsState.index
              ),
              nextTimeIndex,
            };

            let currentTimeIndex = nextTimeIndex + 1;
            const items = Object.values(window.hackerNewsState.index);
            for (let item of items) {
              if (currentTimeIndex < window.hackerNewsState.index.length) {
                addNewsItem(items[currentTimeIndex], queue);

                currentTimeIndex = currentTimeIndex + 1;
              }
            }

            queue.flush();
          }
        };

        const archives = document.getElementById("archives");
        const archivesObserver = new IntersectionObserver(
          (entries) => {
            const queue = new UpdateQueue();

            entries.forEach((entry) => handleIntersectingEntry(entry, queue));
          },
          {
            root: null,
            rootMargin: "0px",
            threshold: 0,
          }
        );

        archivesObserver.observe(archives);

        let latestSectionsExpanded = true;
        const handleLatestHeaderClick = () => {
          latestSectionsExpanded = !latestSectionsExpanded;

          if (latestSectionsExpanded) {
            archivesObserver.observe(archives);
          } else {
            archivesObserver.disconnect(archives);
          }

          for (let section of document.querySelectorAll("#latest > section")) {
            section.style.display = latestSectionsExpanded ? "block" : "none";
          }
        };

        const latestHeader = document.querySelector("#latest > h2");
        latestHeader.style.cursor = "pointer";
        latestHeader.addEventListener("click", handleLatestHeaderClick);
      }
    </script>
    <script type="module">
      import { Workbox } from "https://storage.googleapis.com/workbox-cdn/releases/6.4.1/workbox-window.prod.mjs";

      if ("serviceWorker" in navigator) {
        const base = document.querySelector("base");
        const serviceWorkerPath = `${
          base ? base.href.replace(/\/$/, "") : ""
        }/service-worker.js`;

        const wb = new Workbox(serviceWorkerPath);

        // setup event listeners
        wb.addEventListener("waiting", (event) => {
          wb.addEventListener("controlling", () => {
            window.location.reload();
          });

          wb.messageSkipWaiting();
        });

        wb.register();
      }
    </script>
  </body>
</html>
