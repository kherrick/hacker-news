<!DOCTYPE html>
<html lang="en" xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta charset="utf-8" />
    <meta
      content="width=device-width, initial-scale=1.0, viewport-fit=cover"
      name="viewport"
    />
    <meta name="description" content="Hacker News" />
    <meta name="theme-color" content="#fff" />
    <title>Hacker News</title>
    <link rel="manifest" href="manifest.json" />
    <link
      href="data:image/x-icon;base64,AAABAAEAAQECAAEAAQA4AAAAFgAAACgAAAABAAAAAgAAAAEAAQAAAAAAAAAAAAAAAAAAAAAAAAAAAAABAAEAAQECAAEAAQA4AAAAFgAAACgAAAABAAAAAgAAAAEAAQAAAAAAAAAAAAAAAAAAAAAAAAAA"
      rel="icon"
      type="image/x-icon"
    />
    <link
      href="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAgAAAAIAAQMAAADOtka5AAAAA1BMVEUAAACnej3aAAAANklEQVR42u3BAQEAAACCIP+vbkhAAQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAB8G4IAAAFjdVCkAAAAAElFTkSuQmCC"
      rel="apple-touch-icon"
    />
    <style>
      /*<!--*/
      body {
        color: rgb(25, 25, 25);
        font-family: Verdana, Geneva, sans-serif;
        margin: 0;
      }

      a {
        text-decoration: none;
      }

      a:link,
      a:focus,
      a:hover,
      a:active {
        color: rgb(75, 75, 125);
      }

      a:visited {
        color: rgb(25, 25, 25);
      }

      h1 > a,
      h1 > a:link,
      h1 > a:focus,
      h1 > a:hover,
      h1 > a:active,
      h1 > a:visited,
      h2 > a,
      h2 > a:link,
      h2 > a:focus,
      h2 > a:hover,
      h2 > a:active,
      h2 > a:visited {
        color: rgb(25, 25, 25);
      }

      h1 {
        background-color: rgb(255, 102, 0);
        margin: 0;
        padding: 1rem;
      }

      h2 {
        background-color: rgb(200, 200, 200);
        margin: 1rem 0;
        padding: 0.5rem 0.5rem 0.5rem 1rem;
      }

      #latest > section,
      #archives > section {
        margin: 0 1rem 1rem 1rem;
        padding-bottom: 1rem;
      }

      #latest > section:not(:last-child),
      #archives > section:not(:last-child) {
        border-bottom: 1px dotted rgb(200, 200, 200);
      }

      section > h3 {
        margin: 0 0 0.5rem 0;
      }

      section > h4 {
        font-weight: normal;
        margin: 0 0 0 1rem;
      }

      .descendants-container,
      .points-container {
        align-items: center;
        border-left: 1px solid #333;
        display: inline-flex;
        margin-left: 0.5rem;
        padding-left: 0.5rem;
        text-align: center;
      }

      .points {
        align-items: center;
        display: inline-flex;
        height: 1rem;
        margin-left: 1ch;
        min-width: 3ch;
      }

      .text {
        line-height: 1.5rem;
        margin: 1rem 1rem 0 1rem;
        overflow: auto;
      }

      .text > p:first-child {
        margin-top: 1rem;
      }

      .text > p:last-child {
        margin-bottom: 0;
      }
      /*-->*/
    </style>
  </head>

  <body>
    <main>
      <h1><a href="https://kherrick.github.io/hacker-news/">Hacker News</a></h1>
      <section id="latest">
        <h2>Latest</h2>
        <section id="41546242">
          <h3>
            <a
              class="item"
              href="https://www.gamingonlinux.com/2024/09/european-consumer-organization-goes-after-multiple-publishers-for-their-in-game-currency/"
              >European Consumer Organization goes after publishers for their
              in-game currency</a
            >
          </h3>
          <section>
            <h4>
              <span>2024-09-15 @ 08:58:23</span
              ><span class="points-container"
                >Points: <span class="points">22</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=41546242"
                  >Comments</a
                ><span class="descendants">: 1</span></span
              >
            </h4>
          </section>
        </section>
        <section id="41546032">
          <h3>
            <a
              class="item"
              href="https://coralogix.com/blog/mastering-null-semantics-translating-sql-expressions-to-opensearch-dsl/"
              >Mastering Null Semantics: Translating SQL Expressions to
              OpenSearch DSL</a
            >
          </h3>
          <section>
            <h4>
              <span>2024-09-15 @ 08:07:21</span
              ><span class="points-container"
                >Points: <span class="points">7</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=41546032"
                  >Comments</a
                ><span class="descendants">: 2</span></span
              >
            </h4>
          </section>
        </section>
        <section id="41545737">
          <h3>
            <a class="item" href="https://github.com/glzr-io/glazewm"
              >i3wm inspired wm for Windows</a
            >
          </h3>
          <section>
            <h4>
              <span>2024-09-15 @ 06:52:11</span
              ><span class="points-container"
                >Points: <span class="points">5</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=41545737"
                  >Comments</a
                ><span class="descendants">: 0</span></span
              >
            </h4>
          </section>
        </section>
        <section id="41545670">
          <h3>
            <a
              class="item"
              href="https://gizmodo.com/google-has-officially-killed-cache-links-1851220408"
              >Google Has Officially Killed Cache Links</a
            >
          </h3>
          <section>
            <h4>
              <span>2024-09-15 @ 06:36:48</span
              ><span class="points-container"
                >Points: <span class="points">75</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=41545670"
                  >Comments</a
                ><span class="descendants">: 28</span></span
              >
            </h4>
          </section>
        </section>
        <section id="41545633">
          <h3>
            <a class="item" href="https://news.ycombinator.com/item?id=41545633"
              >Ask HN: Must-Read Books for Startups?</a
            >
          </h3>
          <section>
            <h4>
              <span>2024-09-15 @ 06:25:40</span
              ><span class="points-container"
                >Points: <span class="points">41</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=41545633"
                  >Comments</a
                ><span class="descendants">: 19</span></span
              >
            </h4>
            <div class="text">
              <p>
                While this might seem obvious, it wasn’t to me. The first time I
                started something in my 20s, I was so enamored with the idea and
                its potential that I didn’t validate it!
              </p>
              <p>So, The Mom Test is obviously crucial reading.</p>
              <p>
                There are so many other books and resources out there. Which of
                them would you consider crucial? Which contain crucial lessons?
              </p>
            </div>
          </section>
        </section>
        <section id="41545564">
          <h3>
            <a
              class="item"
              href="https://praachi.work/blog/optimize-career-happiness"
              >Optimizing your career for happiness</a
            >
          </h3>
          <section>
            <h4>
              <span>2024-09-15 @ 06:08:51</span
              ><span class="points-container"
                >Points: <span class="points">33</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=41545564"
                  >Comments</a
                ><span class="descendants">: 15</span></span
              >
            </h4>
          </section>
        </section>
        <section id="41545335">
          <h3>
            <a class="item" href="https://www.bullshitremover.com/"
              >Show HN: Bullshit Remover</a
            >
          </h3>
          <section>
            <h4>
              <span>2024-09-15 @ 05:04:59</span
              ><span class="points-container"
                >Points: <span class="points">91</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=41545335"
                  >Comments</a
                ><span class="descendants">: 38</span></span
              >
            </h4>
          </section>
        </section>
        <section id="41545100">
          <h3>
            <a class="item" href="https://www.implicitcad.org/"
              >Powerful, Open-Source, Programmatic CAD</a
            >
          </h3>
          <section>
            <h4>
              <span>2024-09-15 @ 04:02:10</span
              ><span class="points-container"
                >Points: <span class="points">23</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=41545100"
                  >Comments</a
                ><span class="descendants">: 3</span></span
              >
            </h4>
          </section>
        </section>
        <section id="41544990">
          <h3>
            <a
              class="item"
              href="https://sigma-star.at/blog/2024/02/aarch64-32-bit-compat-pitfall/"
              >A Time Consuming Pitfall for 32-Bit Applications on AArch64</a
            >
          </h3>
          <section>
            <h4>
              <span>2024-09-15 @ 03:31:04</span
              ><span class="points-container"
                >Points: <span class="points">40</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=41544990"
                  >Comments</a
                ><span class="descendants">: 14</span></span
              >
            </h4>
          </section>
        </section>
        <section id="41544969">
          <h3>
            <a class="item" href="https://github.com/dleemiller/WordLlama"
              >Show HN: Wordllama – Things you can do with the token embeddings
              of an LLM</a
            >
          </h3>
          <section>
            <h4>
              <span>2024-09-15 @ 03:25:14</span
              ><span class="points-container"
                >Points: <span class="points">121</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=41544969"
                  >Comments</a
                ><span class="descendants">: 7</span></span
              >
            </h4>
            <div class="text">
              <i>semantically</i>. You don’t need to install pytorch to use it,
              or any deep learning runtimes.
              <p>
                How can this be accomplished? The model is simply token
                embeddings that are average pooled. To create this model, I
                extracted token embedding (nn.Embedding) vectors from LLMs,
                concatenated them along the embedding dimension, added a
                learnable weight parameter, and projected them to a smaller
                dimension. Using the sentence transformers framework and
                datasets, I trained the pooled embedding with multiple negatives
                ranking loss and matryoshka representation learning so they can
                be truncated. After training, the weights and projections are no
                longer needed, because there is no contextual calculations. I
                inference the entire token vocabulary and save the new token
                embeddings to be loaded to numpy.
              </p>
              <p>
                While the results are not impressive compared to transformer
                models, they perform well on MTEB benchmarks compared to word
                embedding models (which they are most similar to), while being
                much smaller in size (smallest model, 32k vocab, 64-dim is only
                4MB).
              </p>
              <p>
                On the utility side, I’ve been adding some tools that I think
                it’ll be useful for. In addition to general embedding, there’s
                algorithms for ranking, filtering, clustering, deduplicating and
                similarity. Some of them have a cython implementation, and I’m
                continuing to work on benchmarking them and improving them as I
                have time. In addition to “standard” models that use cosine
                similarity for some algorithms, there are binarized models that
                use hamming distance. This is a slightly faster, similarity
                algorithm, with significantly less memory per embedding (float32
                -&gt; 1 bit).
              </p>
              <p>
                Hope you enjoy it, and find it useful. PS I haven’t figured out
                Windows builds yet, but Linux and Mac are supported.
              </p>
            </div>
          </section>
        </section>
        <section id="41544386">
          <h3>
            <a class="item" href="https://cs.pomona.edu/classes/cs181g/"
              >CSCI 181G PO: Game Engine Programming</a
            >
          </h3>
          <section>
            <h4>
              <span>2024-09-15 @ 01:14:32</span
              ><span class="points-container"
                >Points: <span class="points">62</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=41544386"
                  >Comments</a
                ><span class="descendants">: 6</span></span
              >
            </h4>
          </section>
        </section>
        <section id="41544364">
          <h3>
            <a
              class="item"
              href="https://zachxbt.mirror.xyz/B0-UJtxN41cJhpPtKv0v2LZ8u-0PwZ4ecMPEdX4l8vE"
              >Lazarus Group laundered $200M from 25 crypto hacks to fiat</a
            >
          </h3>
          <section>
            <h4>
              <span>2024-09-15 @ 01:09:25</span
              ><span class="points-container"
                >Points: <span class="points">161</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=41544364"
                  >Comments</a
                ><span class="descendants">: 81</span></span
              >
            </h4>
          </section>
        </section>
        <section id="41543642">
          <h3>
            <a
              class="item"
              href="https://github.com/lets-all-be-stupid-forever/circuit-artist"
              >Show HN: I made a digital circuit drawing and simulation game</a
            >
          </h3>
          <section>
            <h4>
              <span>2024-09-14 @ 22:43:51</span
              ><span class="points-container"
                >Points: <span class="points">46</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=41543642"
                  >Comments</a
                ><span class="descendants">: 2</span></span
              >
            </h4>
            <div class="text">
              <p>
                The circuit is just an image. The primitives are (i) connected
                wires which have undefined, 0 or 1 state during simulation
                (displayed brighter or darker in function of the state) and (ii)
                NANDs, which are little pixel triangles. During simulation the
                user can interact with any wire by clicking on it, toggling its
                state, which is cool for messing around when learning. The
                simulation uses a unit-delay event driven algorithm.
              </p>
              <p>
                Then, on top of that there are little wire interfaces on the
                left side of the image that communicate with an external system.
                This external system is defined in lua and is simulated together
                with the main circuit (they alternate until convergence). By
                default there's a sandbox mode with a clock and a power-on-reset
                signal. The user can choose other "levels", where the API change
                and there are some problems to solve, from finding if a number
                is multiple of 3 to solving hanoi tower to finding if a number
                is prime. The idea is that if the user want to learn but not
                sure what to do they can try to solve these puzzles, or they can
                change the lua scripts to add their own stuff/interface for a
                custom project.
              </p>
              <p>
                I've also included a small wiki (circuitopedia) with some basic
                digital concepts to guide those who are new or are a bit rusty.
                It's not super detailed but I guess it can at the very least
                present the concepts so the user can dig further on more serious
                material if they want to.
              </p>
              <p>
                I developed the game in C with raylib, with scripting in
                lua/luajit. I've put the game on steam (for windows) and
                released the source code on github under GPLv3. There's also a
                web demo version on itch.io, even though it's a bit laggy:
                <a
                  href="https://lets-all-be-stupid-foreva.itch.io/circuit-artist-demo"
                  >https://lets-all-be-stupid-foreva.itch.io/circuit-artist-dem...</a
                >
                .
              </p>
              <p>Feedback is appreciated!</p>
            </div>
          </section>
        </section>
        <section id="41543386">
          <h3>
            <a class="item" href="https://openscad.org/"
              >OpenSCAD: The Programmer's Solid 3D CAD Modeller</a
            >
          </h3>
          <section>
            <h4>
              <span>2024-09-14 @ 22:02:14</span
              ><span class="points-container"
                >Points: <span class="points">298</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=41543386"
                  >Comments</a
                ><span class="descendants">: 98</span></span
              >
            </h4>
          </section>
        </section>
        <section id="41543109">
          <h3>
            <a class="item" href="https://github.com/brsloan/warewoolf"
              >Warewoolf: A minimalist novel-writing system/rich text editor</a
            >
          </h3>
          <section>
            <h4>
              <span>2024-09-14 @ 21:25:29</span
              ><span class="points-container"
                >Points: <span class="points">48</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=41543109"
                  >Comments</a
                ><span class="descendants">: 24</span></span
              >
            </h4>
          </section>
        </section>
        <section id="41541770">
          <h3>
            <a class="item" href="https://lwn.net/Articles/990281/"
              >Falsehoods programmers believe about TCP</a
            >
          </h3>
          <section>
            <h4>
              <span>2024-09-14 @ 18:26:00</span
              ><span class="points-container"
                >Points: <span class="points">231</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=41541770"
                  >Comments</a
                ><span class="descendants">: 172</span></span
              >
            </h4>
          </section>
        </section>
        <section id="41541459">
          <h3>
            <a class="item" href="https://bofh.bjash.com/"
              >The Bastard Operator from Hell (1999)</a
            >
          </h3>
          <section>
            <h4>
              <span>2024-09-14 @ 17:46:42</span
              ><span class="points-container"
                >Points: <span class="points">181</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=41541459"
                  >Comments</a
                ><span class="descendants">: 59</span></span
              >
            </h4>
          </section>
        </section>
        <section id="41540984">
          <h3>
            <a
              class="item"
              href="https://ianbetteridge.com/2024/09/14/founder-mode-hackers-and-being-bored-by-tech/"
              >Founder Mode, hackers, and being bored by tech</a
            >
          </h3>
          <section>
            <h4>
              <span>2024-09-14 @ 16:52:49</span
              ><span class="points-container"
                >Points: <span class="points">229</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=41540984"
                  >Comments</a
                ><span class="descendants">: 101</span></span
              >
            </h4>
          </section>
        </section>
        <section id="41540950">
          <h3>
            <a
              class="item"
              href="https://www.science.org/content/article/one-five-genetics-papers-contains-errors-thanks-microsoft-excel"
              >One in five genetics papers contains errors thanks to Microsoft
              Excel (2016)</a
            >
          </h3>
          <section>
            <h4>
              <span>2024-09-14 @ 16:49:10</span
              ><span class="points-container"
                >Points: <span class="points">252</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=41540950"
                  >Comments</a
                ><span class="descendants">: 139</span></span
              >
            </h4>
          </section>
        </section>
        <section id="41540902">
          <h3>
            <a
              class="item"
              href="https://mathstodon.xyz/@tao/113132502735585408"
              >Terence Tao on O1</a
            >
          </h3>
          <section>
            <h4>
              <span>2024-09-14 @ 16:41:04</span
              ><span class="points-container"
                >Points: <span class="points">561</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=41540902"
                  >Comments</a
                ><span class="descendants">: 341</span></span
              >
            </h4>
          </section>
        </section>
        <section id="41540777">
          <h3>
            <a
              class="item"
              href="https://blog.yoshuawuyts.com/nesting-allocators/"
              >Nesting Allocators (2023)</a
            >
          </h3>
          <section>
            <h4>
              <span>2024-09-14 @ 16:22:42</span
              ><span class="points-container"
                >Points: <span class="points">79</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=41540777"
                  >Comments</a
                ><span class="descendants">: 6</span></span
              >
            </h4>
          </section>
        </section>
        <section id="41540362">
          <h3>
            <a class="item" href="https://github.com/phil-opp/blog_os"
              >Writing an OS in Rust</a
            >
          </h3>
          <section>
            <h4>
              <span>2024-09-14 @ 15:19:50</span
              ><span class="points-container"
                >Points: <span class="points">321</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=41540362"
                  >Comments</a
                ><span class="descendants">: 39</span></span
              >
            </h4>
          </section>
        </section>
        <section id="41540221">
          <h3>
            <a
              class="item"
              href="https://10maurycy10.github.io/projects/speaker/"
              >Making a rickroll laser: A parametric speaker</a
            >
          </h3>
          <section>
            <h4>
              <span>2024-09-14 @ 14:59:10</span
              ><span class="points-container"
                >Points: <span class="points">165</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=41540221"
                  >Comments</a
                ><span class="descendants">: 45</span></span
              >
            </h4>
          </section>
        </section>
        <section id="41527167">
          <h3>
            <a class="item" href="https://pldb.io/blog/whereInnovation.html"
              >Where are programming languages created? A zoomable map</a
            >
          </h3>
          <section>
            <h4>
              <span>2024-09-13 @ 00:56:17</span
              ><span class="points-container"
                >Points: <span class="points">29</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=41527167"
                  >Comments</a
                ><span class="descendants">: 22</span></span
              >
            </h4>
          </section>
        </section>
        <section id="41522047">
          <h3>
            <a
              class="item"
              href="https://www.qt.io/blog/boot2qt-/-how-to-optimize-boot-time-in-user-space-on-a-raspberry-pi-4"
              >How to optimize boot time in user space on a Raspberry Pi 4 /
              Boot2Qt</a
            >
          </h3>
          <section>
            <h4>
              <span>2024-09-12 @ 15:31:06</span
              ><span class="points-container"
                >Points: <span class="points">10</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=41522047"
                  >Comments</a
                ><span class="descendants">: 6</span></span
              >
            </h4>
          </section>
        </section>
        <section id="41519112">
          <h3>
            <a class="item" href="https://www.barneyhill.com/pages/epitome/"
              >Show HN: Epitomē – A semantic search engine for ancient text</a
            >
          </h3>
          <section>
            <h4>
              <span>2024-09-12 @ 09:39:39</span
              ><span class="points-container"
                >Points: <span class="points">7</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=41519112"
                  >Comments</a
                ><span class="descendants">: 4</span></span
              >
            </h4>
          </section>
        </section>
        <section id="41518567">
          <h3>
            <a
              class="item"
              href="https://apnews.com/article/postal-service-next-generation-delivery-vehicle-a2ebbfc7afec0eea2e036eef93bee4d9"
              >USPS' long-awaited new mail truck makes its debut</a
            >
          </h3>
          <section>
            <h4>
              <span>2024-09-12 @ 08:01:09</span
              ><span class="points-container"
                >Points: <span class="points">142</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=41518567"
                  >Comments</a
                ><span class="descendants">: 110</span></span
              >
            </h4>
          </section>
        </section>
        <section id="41518094">
          <h3>
            <a
              class="item"
              href="https://notes.eatonphil.com/compiler-basics-lisp-to-assembly.html"
              >Writing a Lisp compiler (Lisp to assembly) from scratch in
              JavaScript (2018)</a
            >
          </h3>
          <section>
            <h4>
              <span>2024-09-12 @ 06:19:45</span
              ><span class="points-container"
                >Points: <span class="points">38</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=41518094"
                  >Comments</a
                ><span class="descendants">: 1</span></span
              >
            </h4>
          </section>
        </section>
        <section id="41517059">
          <h3>
            <a
              class="item"
              href="https://svpow.com/2024/09/07/were-not-going-to-run-out-of-new-anatomy-anytime-soon/"
              >We're not going to run out of new anatomy anytime soon</a
            >
          </h3>
          <section>
            <h4>
              <span>2024-09-12 @ 02:35:45</span
              ><span class="points-container"
                >Points: <span class="points">62</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=41517059"
                  >Comments</a
                ><span class="descendants">: 26</span></span
              >
            </h4>
          </section>
        </section>
        <section id="41507521">
          <h3>
            <a
              class="item"
              href="https://thenextwavefutures.wordpress.com/2024/09/10/designing-organisations-that-work-stafford-beer-viable-systems-model/"
              >Designing Organisations That Work</a
            >
          </h3>
          <section>
            <h4>
              <span>2024-09-11 @ 02:26:13</span
              ><span class="points-container"
                >Points: <span class="points">7</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=41507521"
                  >Comments</a
                ><span class="descendants">: 0</span></span
              >
            </h4>
          </section>
        </section>
      </section>
      <section id="archives">
        <h2>
          <a
            href="https://github.com/kherrick/hacker-news/blob/main/archives/index.md"
            >Archives</a
          >
        </h2>
        <section>
          <h3>
            <a
              href="https://github.com/kherrick/hacker-news/blob/main/archives/2024/index.md"
              >2024</a
            >
          </h3>
        </section>
        <section>
          <h3>
            <a
              href="https://github.com/kherrick/hacker-news/blob/main/archives/2023/index.md"
              >2023</a
            >
          </h3>
        </section>
        <section>
          <h3>
            <a
              href="https://github.com/kherrick/hacker-news/blob/main/archives/2022/index.md"
              >2022</a
            >
          </h3>
        </section>
      </section>
    </main>
    <script type="module">
      import { buildDescendants } from "./lib/build-html-descendants.js";
      import { buildNextItem } from "./lib/build-html-next-item.js";
      import { getNextDateTime } from "./lib/date-time.js";

      const updateSectionById = (id) =>
        fetch(`https://hacker-news.firebaseio.com/v0/item/${id}.json`).then(
          (result) =>
            result.json().then(({ descendants, id, score, text, type }) => {
              const currentItem = document.getElementById(id);

              if (score) {
                currentItem.querySelector(".points").textContent = score;
              }

              if (descendants && (type === "poll" || type === "story")) {
                const currentDescendants =
                  currentItem.querySelector(".descendants");

                if (currentDescendants) {
                  currentDescendants.textContent = `: ${descendants}`;
                } else {
                  const comments = buildDescendants(
                    document,
                    descendants,
                    `https://news.ycombinator.com/item?id=${id}`
                  );

                  currentItem.querySelector("h4").appendChild(comments);
                }
              }

              if (text) {
                const currentText = currentItem.querySelector(".text");

                if (currentText) {
                  currentText.innerHTML = text.replace(/\0/g, "");
                } else {
                  const content = document.createElement("div");
                  content.innerHTML = text.replace(/\0/g, "");
                  content.setAttribute("class", "text");

                  currentItem.appendChild(content);
                }
              }
            })
        );

      class UpdateQueue {
        constructor() {
          this._ids = [];
          this._isUpdating = false;
        }

        addItemById(id) {
          this._ids.push(id);
        }

        async flush() {
          const id = this._ids.shift();

          if (id) {
            this._isUpdating = true;

            await updateSectionById(id);
            await this.flush();
          } else {
            this._isUpdating = false;

            setTimeout(async () => {
              if (!this._isUpdating && this._ids && this._ids.length) {
                await this.flush();
              }
            }, 0);
          }
        }
      }

      // get latest data
      const latestSection = document.getElementById("latest");

      for (let item of latestSection.querySelectorAll("section[id]")) {
        updateSectionById(item.getAttribute("id"));
      }

      if ("IntersectionObserver" in window) {
        window.hackerNewsState = { index: [], nextTimeIndex: -1 };

        const addNewsItem = async (newsItem, queue) => {
          try {
            const { date, time, itemComments, itemTitle, itemLink } = newsItem;
            const section = await buildNextItem({
              document,
              dateTime: `${date}, ${time}`,
              itemComments,
              itemLink,
              itemTitle: new DOMParser().parseFromString(
                itemTitle.replace(/\\/g, ""),
                "text/html"
              ).documentElement.textContent,
              fetchItemDetails: false,
            });

            // display loading indicator for section
            section.querySelector(".points-container").innerHTML =
              'Points: <span class="points"><img style="height: 100%;" src="lib/images/loading.svg" /></span>';

            const id = section.getAttribute("id");
            if (!document.getElementById(id)) {
              document.getElementById("latest").appendChild(section);

              queue.addItemById(id);
            }
          } catch (error) {}
        };

        const buildArchiveIndex = async (lastDateTime) => {
          const nextDate = lastDateTime.slice(0, 10);
          const nextYear = nextDate.slice(0, 4);

          return (
            await (
              await fetch(
                `https://raw.githubusercontent.com/kherrick/hacker-news/main/archives/${nextYear}/${nextDate}/index.md`
              )
            ).text()
          )
            .split("\n")
            .filter((line) => line.match(new RegExp("^\\* \\[")))
            .map((line) => {
              const segment = line.replace("* ", "").split("](");
              const pubDate = segment[0].slice(1);

              const itemComments = segment[1].split(") - [")[0];
              const itemTitle = segment[1].split(") - [")[1];
              const itemLink = segment[2].slice(0, -1);
              const date = pubDate.slice(0, 10);
              const time = pubDate.slice(-8);

              return {
                date,
                itemComments,
                itemLink,
                itemTitle,
                time,
              };
            });
        };

        const handleIntersectingEntry = async (entry, queue) => {
          if (entry.isIntersecting) {
            const lastDateTime = document
              .getElementById("latest")
              .querySelector(
                "section:last-child > section > h4 > span"
              ).textContent;

            const nextDateTime = getNextDateTime(lastDateTime ?? "", -1);
            const archiveIndex = await buildArchiveIndex(nextDateTime);
            const nextTimeIndex = archiveIndex.findIndex(
              ({ time }) => time === nextDateTime.slice(-8)
            );

            const handleIndexUpdate = (index, existingIndexValues = []) => {
              index.forEach((i) => {
                existingIndexValues.push(i);
              });
              return existingIndexValues;
            };

            window.hackerNewsState = {
              index: handleIndexUpdate(
                archiveIndex,
                window.hackerNewsState.index
              ),
              nextTimeIndex,
            };

            let currentTimeIndex = nextTimeIndex + 1;
            const items = Object.values(window.hackerNewsState.index);
            for (let item of items) {
              if (currentTimeIndex < window.hackerNewsState.index.length) {
                addNewsItem(items[currentTimeIndex], queue);

                currentTimeIndex = currentTimeIndex + 1;
              }
            }

            queue.flush();
          }
        };

        const archives = document.getElementById("archives");
        const archivesObserver = new IntersectionObserver(
          (entries) => {
            const queue = new UpdateQueue();

            entries.forEach((entry) => handleIntersectingEntry(entry, queue));
          },
          {
            root: null,
            rootMargin: "0px",
            threshold: 0,
          }
        );

        archivesObserver.observe(archives);

        let latestSectionsExpanded = true;
        const handleLatestHeaderClick = () => {
          latestSectionsExpanded = !latestSectionsExpanded;

          if (latestSectionsExpanded) {
            archivesObserver.observe(archives);
          } else {
            archivesObserver.disconnect(archives);
          }

          for (let section of document.querySelectorAll("#latest > section")) {
            section.style.display = latestSectionsExpanded ? "block" : "none";
          }
        };

        const latestHeader = document.querySelector("#latest > h2");
        latestHeader.style.cursor = "pointer";
        latestHeader.addEventListener("click", handleLatestHeaderClick);
      }
    </script>
    <script type="module">
      import { Workbox } from "https://storage.googleapis.com/workbox-cdn/releases/6.4.1/workbox-window.prod.mjs";

      if ("serviceWorker" in navigator) {
        const base = document.querySelector("base");
        const serviceWorkerPath = `${
          base ? base.href.replace(/\/$/, "") : ""
        }/service-worker.js`;

        const wb = new Workbox(serviceWorkerPath);

        // setup event listeners
        wb.addEventListener("waiting", (event) => {
          wb.addEventListener("controlling", () => {
            window.location.reload();
          });

          wb.messageSkipWaiting();
        });

        wb.register();
      }
    </script>
  </body>
</html>
