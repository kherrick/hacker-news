<!DOCTYPE html>
<html lang="en" xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta charset="utf-8" />
    <meta
      content="width=device-width, initial-scale=1.0, viewport-fit=cover"
      name="viewport"
    />
    <meta name="description" content="Hacker News" />
    <meta name="theme-color" content="#fff" />
    <title>Hacker News</title>
    <link rel="manifest" href="manifest.json" />
    <link
      href="data:image/x-icon;base64,AAABAAEAAQECAAEAAQA4AAAAFgAAACgAAAABAAAAAgAAAAEAAQAAAAAAAAAAAAAAAAAAAAAAAAAAAAABAAEAAQECAAEAAQA4AAAAFgAAACgAAAABAAAAAgAAAAEAAQAAAAAAAAAAAAAAAAAAAAAAAAAA"
      rel="icon"
      type="image/x-icon"
    />
    <link
      href="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAgAAAAIAAQMAAADOtka5AAAAA1BMVEUAAACnej3aAAAANklEQVR42u3BAQEAAACCIP+vbkhAAQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAB8G4IAAAFjdVCkAAAAAElFTkSuQmCC"
      rel="apple-touch-icon"
    />
    <style>
      /*<!--*/
      body {
        color: rgb(25, 25, 25);
        font-family: Verdana, Geneva, sans-serif;
        margin: 0;
      }

      a {
        text-decoration: none;
      }

      a:link,
      a:focus,
      a:hover,
      a:active {
        color: rgb(75, 75, 125);
      }

      a:visited {
        color: rgb(25, 25, 25);
      }

      h1 > a,
      h1 > a:link,
      h1 > a:focus,
      h1 > a:hover,
      h1 > a:active,
      h1 > a:visited,
      h2 > a,
      h2 > a:link,
      h2 > a:focus,
      h2 > a:hover,
      h2 > a:active,
      h2 > a:visited {
        color: rgb(25, 25, 25);
      }

      h1 {
        background-color: rgb(255, 102, 0);
        margin: 0;
        padding: 1rem;
      }

      h2 {
        background-color: rgb(200, 200, 200);
        margin: 1rem 0;
        padding: 0.5rem 0.5rem 0.5rem 1rem;
      }

      #latest > section,
      #archives > section {
        margin: 0 1rem 1rem 1rem;
        padding-bottom: 1rem;
      }

      #latest > section:not(:last-child),
      #archives > section:not(:last-child) {
        border-bottom: 1px dotted rgb(200, 200, 200);
      }

      section > h3 {
        margin: 0 0 0.5rem 0;
      }

      section > h4 {
        font-weight: normal;
        margin: 0 0 0 1rem;
      }

      .descendants-container,
      .points-container {
        align-items: center;
        border-left: 1px solid #333;
        display: inline-flex;
        margin-left: 0.5rem;
        padding-left: 0.5rem;
        text-align: center;
      }

      .points {
        align-items: center;
        display: inline-flex;
        height: 1rem;
        margin-left: 1ch;
        min-width: 3ch;
      }

      .text {
        line-height: 1.5rem;
        margin: 1rem 1rem 0 1rem;
        overflow: auto;
      }

      .text > p:first-child {
        margin-top: 1rem;
      }

      .text > p:last-child {
        margin-bottom: 0;
      }
      /*-->*/
    </style>
  </head>

  <body>
    <main>
      <h1><a href="https://kherrick.github.io/hacker-news/">Hacker News</a></h1>
      <section id="latest">
        <h2>Latest</h2>
        <section id="42425348">
          <h3>
            <a
              class="item"
              href="https://twitter.com/TechEmails/status/1868368310024462791"
              >Palm's CEO emails Steve Jobs (2007)</a
            >
          </h3>
          <section>
            <h4>
              <span>2024-12-15 @ 19:21:36</span
              ><span class="points-container"
                >Points: <span class="points">113</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=42425348"
                  >Comments</a
                ><span class="descendants">: 55</span></span
              >
            </h4>
          </section>
        </section>
        <section id="42425339">
          <h3>
            <a class="item" href="https://news.ycombinator.com/item?id=42425339"
              >Ask HN: How do you find part time work?</a
            >
          </h3>
          <section>
            <h4>
              <span>2024-12-15 @ 19:20:19</span
              ><span class="points-container"
                >Points: <span class="points">85</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=42425339"
                  >Comments</a
                ><span class="descendants">: 30</span></span
              >
            </h4>
            <div class="text">
              <p>
                The thing, I haven't really put much work into finding this kind
                of work. I've had a few opportunities land in my lap pretty
                nicely. Now, I need to seek out more work like this. I have
                ideas, but I'm curious to see how others are finding part-time
                work. Ideally, I would get 10-15/hr a week retainers, but
                project-based work is ok too. The key is that I can keep getting
                the work with consistency.
              </p>
              <p>
                My corporate career was a cross between engineering and product
                management. I truly believe my best utility is the cross-over of
                the two. I'd be happy to do part-time leadership for small
                teams, take on independent projects, do things like build and
                maintain small apps/integrations, etc.
              </p>
              <p>So:</p>
              <p>1) How are you finding part-time work?</p>
              <p>
                2) How do you sell yourself if you're more of a generalist like
                me?
              </p>
            </div>
          </section>
        </section>
        <section id="42425139">
          <h3>
            <a
              class="item"
              href="https://leancrew.com/all-this/2024/12/the-antikythera-mechanism/"
              >The Antikythera mechanism – 254:19 ratio</a
            >
          </h3>
          <section>
            <h4>
              <span>2024-12-15 @ 18:46:48</span
              ><span class="points-container"
                >Points: <span class="points">34</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=42425139"
                  >Comments</a
                ><span class="descendants">: 10</span></span
              >
            </h4>
          </section>
        </section>
        <section id="42424879">
          <h3>
            <a
              class="item"
              href="https://rish-01.github.io/blog/posts/ml_estimation/"
              >Maximum Likelihood Estimation and Loss Functions</a
            >
          </h3>
          <section>
            <h4>
              <span>2024-12-15 @ 18:07:06</span
              ><span class="points-container"
                >Points: <span class="points">15</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=42424879"
                  >Comments</a
                ><span class="descendants">: 0</span></span
              >
            </h4>
          </section>
        </section>
        <section id="42424597">
          <h3>
            <a
              class="item"
              href="https://github.com/humodz/node-wasi-preopens-escape"
              >Proof of Concept showcasing WASM program access files outside
              node:wasi's dir</a
            >
          </h3>
          <section>
            <h4>
              <span>2024-12-15 @ 17:23:10</span
              ><span class="points-container"
                >Points: <span class="points">17</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=42424597"
                  >Comments</a
                ><span class="descendants">: 4</span></span
              >
            </h4>
          </section>
        </section>
        <section id="42424508">
          <h3>
            <a class="item" href="https://smarthome.steviep.xyz"
              >Show HN: SmartHome – An Adventure Game</a
            >
          </h3>
          <section>
            <h4>
              <span>2024-12-15 @ 17:05:30</span
              ><span class="points-container"
                >Points: <span class="points">116</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=42424508"
                  >Comments</a
                ><span class="descendants">: 23</span></span
              >
            </h4>
            <div class="text">
              <p>
                If you find it too hard and don't mind some mild spoilers, then
                check out the hints page:
                <a href="https://smarthome.steviep.xyz/help"
                  >https://smarthome.steviep.xyz/help</a
                >
              </p>
              <p>Enjoy!</p>
            </div>
          </section>
        </section>
        <section id="42424484">
          <h3>
            <a
              class="item"
              href="https://ycombinator.com/companies/trellis/jobs/7vGTphf-founding-engineer-backend-ai"
              >Trellis (YC W24) Is Hiring Eng to Automate PDFs Task at Scale</a
            >
          </h3>
          <section>
            <h4>
              <span>2024-12-15 @ 17:01:18</span
              ><span class="points-container"
                >Points: <span class="points">1</span></span
              >
            </h4>
          </section>
        </section>
        <section id="42424370">
          <h3>
            <a class="item" href="https://github.com/JanNeuendorf/SVC16"
              >SVC16: Simplest Virtual Computer</a
            >
          </h3>
          <section>
            <h4>
              <span>2024-12-15 @ 16:39:26</span
              ><span class="points-container"
                >Points: <span class="points">122</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=42424370"
                  >Comments</a
                ><span class="descendants">: 34</span></span
              >
            </h4>
          </section>
        </section>
        <section id="42423988">
          <h3>
            <a class="item" href="https://railgunlabs.com/unicorn/"
              >Show HN: I built an embeddable Unicode library with MISRA C
              conformance</a
            >
          </h3>
          <section>
            <h4>
              <span>2024-12-15 @ 15:41:27</span
              ><span class="points-container"
                >Points: <span class="points">56</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=42423988"
                  >Comments</a
                ><span class="descendants">: 30</span></span
              >
            </h4>
            <div class="text">
              <p>
                Unicorn is designed to be fully customizable: you can select
                which Unicode algorithms and character properties are included
                or excluded from compilation. You can also exclude Unicode
                character blocks wholesale for scripts your application does not
                support. It's perfect for resource constrained devices like
                microcontrollers and IoT devices.
              </p>
              <p>
                About me: I quit my Big Corp job a few years back to pursue my
                passion for software development and this is one of my first
                commercial releases.
              </p>
            </div>
          </section>
        </section>
        <section id="42423742">
          <h3>
            <a class="item" href="https://news.ycombinator.com/item?id=42423742"
              >Lost IBM OS/2 Warp 3 and 4 localizations: Looking for help
              finding and archiving</a
            >
          </h3>
          <section>
            <h4>
              <span>2024-12-15 @ 14:59:46</span
              ><span class="points-container"
                >Points: <span class="points">50</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=42423742"
                  >Comments</a
                ><span class="descendants">: 16</span></span
              >
            </h4>
            <div class="text">
              <p>
                Building on a 2022 post about finding a copy of the long lost
                Slovenian OS/2 Warp 4 -
                https://www.os2museum.com/wp/slovenian-os-2-warp-4/ - some
                fellow software archaeologists have concluded some other
                localization editions are still missing - copied from the post's
                comments:
              </p>
              <p>
                -- OBattler says: December 8, 2024 at 9:53 am It turns out
                Slovenian isn’t the only version missing of OS/2 Warp 4.0 –
                Portuguese (Portugal) and Portuguese (Brazil) are also missing,
                as are Dutch, French, Finnish, Norwegian, and Swedish, and a
                non-trial version of Hungarian.
              </p>
              <p>
                OBattler says: December 8, 2024 at 10:01 am I just found FixPack
                5 for OS/2 Warp 3.0 (or at least, references thereof) Arabic,
                French (Canada), Hebrew, Thai, Turkish, and, apparently, also
                Bulgarian and Lithuaian! So OS/2 Warp 4.0 must have also existed
                in these languages.
              </p>
              <p>Source: https://ecsoft2.org/system-fixpacks-and-patches --</p>
              <p>
                Anyone who can help find these CDs and help the os2museum.com
                preserve them (and optionally upload them to archive.org, too)
                is very welcome to join our cause.
              </p>
              <p>
                Also looking for any (ex)IBM employees thst worked on the OS/2
                localization projects and can help with this!
              </p>
              <p>Marko Štamcar Computer History Museum Slovenia</p>
            </div>
          </section>
        </section>
        <section id="42423409">
          <h3>
            <a
              class="item"
              href="https://www.futilitycloset.com/2024/12/15/tidy-2/"
              >A visual proof that a^2 – b^2 = (a + b)(a – b)</a
            >
          </h3>
          <section>
            <h4>
              <span>2024-12-15 @ 14:01:37</span
              ><span class="points-container"
                >Points: <span class="points">343</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=42423409"
                  >Comments</a
                ><span class="descendants">: 136</span></span
              >
            </h4>
          </section>
        </section>
        <section id="42422942">
          <h3>
            <a
              class="item"
              href="https://jpcamara.com/2024/12/14/my-rubyconf-talk.html"
              >In-Depth Ruby Concurrency: Navigating the Ruby Concurrency
              Landscape</a
            >
          </h3>
          <section>
            <h4>
              <span>2024-12-15 @ 11:46:21</span
              ><span class="points-container"
                >Points: <span class="points">129</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=42422942"
                  >Comments</a
                ><span class="descendants">: 17</span></span
              >
            </h4>
          </section>
        </section>
        <section id="42422077">
          <h3>
            <a class="item" href="https://elmwealth.com/crystal-ball/"
              >When a Crystal Ball Isn't Enough to Make You Rich</a
            >
          </h3>
          <section>
            <h4>
              <span>2024-12-15 @ 07:22:37</span
              ><span class="points-container"
                >Points: <span class="points">214</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=42422077"
                  >Comments</a
                ><span class="descendants">: 121</span></span
              >
            </h4>
          </section>
        </section>
        <section id="42421387">
          <h3>
            <a
              class="item"
              href="https://thebaffler.com/latest/kicking-an-open-door-robbins"
              >Stranger Than Fiction: Lives of the Twentieth-Century Novel</a
            >
          </h3>
          <section>
            <h4>
              <span>2024-12-15 @ 04:06:43</span
              ><span class="points-container"
                >Points: <span class="points">12</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=42421387"
                  >Comments</a
                ><span class="descendants">: 1</span></span
              >
            </h4>
          </section>
        </section>
        <section id="42421157">
          <h3>
            <a
              class="item"
              href="https://irrationalanalysis.substack.com/p/tenstorrent-and-the-state-of-ai-hardware"
              >Tenstorrent and the State of AI Hardware Startups</a
            >
          </h3>
          <section>
            <h4>
              <span>2024-12-15 @ 02:59:58</span
              ><span class="points-container"
                >Points: <span class="points">203</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=42421157"
                  >Comments</a
                ><span class="descendants">: 95</span></span
              >
            </h4>
          </section>
        </section>
        <section id="42420352">
          <h3>
            <a
              class="item"
              href="https://www.york.ac.uk/news-and-events/news/2024/research/school-smartphone-ban-better-sleep/"
              >School smartphone ban results in better sleep and improved mood:
              study</a
            >
          </h3>
          <section>
            <h4>
              <span>2024-12-14 @ 23:51:44</span
              ><span class="points-container"
                >Points: <span class="points">908</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=42420352"
                  >Comments</a
                ><span class="descendants">: 598</span></span
              >
            </h4>
          </section>
        </section>
        <section id="42419224">
          <h3>
            <a
              class="item"
              href="https://milescole.dev/data-engineering/2024/12/12/Should-You-Ditch-Spark-DuckDB-Polars.html"
              >Should you ditch Spark for DuckDB or Polars?</a
            >
          </h3>
          <section>
            <h4>
              <span>2024-12-14 @ 20:28:44</span
              ><span class="points-container"
                >Points: <span class="points">59</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=42419224"
                  >Comments</a
                ><span class="descendants">: 35</span></span
              >
            </h4>
          </section>
        </section>
        <section id="42418982">
          <h3>
            <a class="item" href="https://irata.online/"
              >IRATA.ONLINE: A Community for Retro-Computing Enthusiasts</a
            >
          </h3>
          <section>
            <h4>
              <span>2024-12-14 @ 19:42:50</span
              ><span class="points-container"
                >Points: <span class="points">208</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=42418982"
                  >Comments</a
                ><span class="descendants">: 51</span></span
              >
            </h4>
          </section>
        </section>
        <section id="42418114">
          <h3>
            <a
              class="item"
              href="https://www.deobald.ca/essays/2024-12-09-optimistic-computing/"
              >Optimistic Computing</a
            >
          </h3>
          <section>
            <h4>
              <span>2024-12-14 @ 16:52:13</span
              ><span class="points-container"
                >Points: <span class="points">13</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=42418114"
                  >Comments</a
                ><span class="descendants">: 0</span></span
              >
            </h4>
          </section>
        </section>
        <section id="42417857">
          <h3>
            <a class="item" href="https://andrewkchan.dev/posts/yalm.html"
              >Fast LLM Inference From Scratch (using CUDA)</a
            >
          </h3>
          <section>
            <h4>
              <span>2024-12-14 @ 16:02:48</span
              ><span class="points-container"
                >Points: <span class="points">83</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=42417857"
                  >Comments</a
                ><span class="descendants">: 4</span></span
              >
            </h4>
          </section>
        </section>
        <section id="42417478">
          <h3>
            <a
              class="item"
              href="https://softwaredoug.com/blog/2024/12/14/throwaway-prs-not-design-docs"
              >Preferring throwaway code over design docs</a
            >
          </h3>
          <section>
            <h4>
              <span>2024-12-14 @ 14:52:22</span
              ><span class="points-container"
                >Points: <span class="points">90</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=42417478"
                  >Comments</a
                ><span class="descendants">: 53</span></span
              >
            </h4>
          </section>
        </section>
        <section id="42415654">
          <h3>
            <a
              class="item"
              href="https://outlore.dev/blog/model-context-protocol/"
              >Reflections on building with Model Context Protocol</a
            >
          </h3>
          <section>
            <h4>
              <span>2024-12-14 @ 08:58:40</span
              ><span class="points-container"
                >Points: <span class="points">21</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=42415654"
                  >Comments</a
                ><span class="descendants">: 7</span></span
              >
            </h4>
          </section>
        </section>
        <section id="42415298">
          <h3>
            <a
              class="item"
              href="https://jakelazaroff.com/words/isomorphic-web-components/"
              >Isomorphic Web Components</a
            >
          </h3>
          <section>
            <h4>
              <span>2024-12-14 @ 07:19:21</span
              ><span class="points-container"
                >Points: <span class="points">45</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=42415298"
                  >Comments</a
                ><span class="descendants">: 24</span></span
              >
            </h4>
          </section>
        </section>
        <section id="42411655">
          <h3>
            <a
              class="item"
              href="https://worksinprogress.co/issue/animals-as-chemical-factories/"
              >Animals as Chemical Factories</a
            >
          </h3>
          <section>
            <h4>
              <span>2024-12-13 @ 19:43:03</span
              ><span class="points-container"
                >Points: <span class="points">30</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=42411655"
                  >Comments</a
                ><span class="descendants">: 36</span></span
              >
            </h4>
          </section>
        </section>
        <section id="42406063">
          <h3>
            <a
              class="item"
              href="https://boydrinksink.com/eyes-wide-shut-hidden-in-plain-sight"
              >Eyes Wide Shut: Hidden in Plain Sight</a
            >
          </h3>
          <section>
            <h4>
              <span>2024-12-13 @ 05:07:33</span
              ><span class="points-container"
                >Points: <span class="points">32</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=42406063"
                  >Comments</a
                ><span class="descendants">: 12</span></span
              >
            </h4>
          </section>
        </section>
        <section id="42405559">
          <h3>
            <a
              class="item"
              href="https://www.pcmag.com/articles/nyc-wants-you-to-stop-taking-traffic-cam-selfies-but-heres-how-to-do-it"
              >NYC wants you to stop taking traffic cam selfies, but here's how
              to do it anyway</a
            >
          </h3>
          <section>
            <h4>
              <span>2024-12-13 @ 02:49:01</span
              ><span class="points-container"
                >Points: <span class="points">377</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=42405559"
                  >Comments</a
                ><span class="descendants">: 152</span></span
              >
            </h4>
          </section>
        </section>
        <section id="42405364">
          <h3>
            <a
              class="item"
              href="https://www.scannedinavian.com/programmers-want-flow-when-programming-light-turns-red.html"
              >Programmers want flow. when programming, light turns RED</a
            >
          </h3>
          <section>
            <h4>
              <span>2024-12-13 @ 02:04:30</span
              ><span class="points-container"
                >Points: <span class="points">22</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=42405364"
                  >Comments</a
                ><span class="descendants">: 11</span></span
              >
            </h4>
          </section>
        </section>
        <section id="42400365">
          <h3>
            <a
              class="item"
              href="https://www.owlposting.com/p/why-recursion-pharmaceuticals-abandoned"
              >Why Recursion Pharmaceuticals abandoned cell painting for
              brightfield imaging</a
            >
          </h3>
          <section>
            <h4>
              <span>2024-12-12 @ 16:08:51</span
              ><span class="points-container"
                >Points: <span class="points">62</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=42400365"
                  >Comments</a
                ><span class="descendants">: 8</span></span
              >
            </h4>
          </section>
        </section>
        <section id="42397812">
          <h3>
            <a
              class="item"
              href="https://rustunit.com/blog/2024/12-10-rust-web-drag-drop-image/"
              >Drag and Drop Images into Bevy 0.15 on the web</a
            >
          </h3>
          <section>
            <h4>
              <span>2024-12-12 @ 09:55:41</span
              ><span class="points-container"
                >Points: <span class="points">6</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=42397812"
                  >Comments</a
                ><span class="descendants">: 0</span></span
              >
            </h4>
          </section>
        </section>
        <section id="42397478">
          <h3>
            <a
              class="item"
              href="https://cacm.acm.org/opinion/on-program-synthesis-and-large-language-models/"
              >Program Synthesis and Large Language Models</a
            >
          </h3>
          <section>
            <h4>
              <span>2024-12-12 @ 08:56:50</span
              ><span class="points-container"
                >Points: <span class="points">35</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=42397478"
                  >Comments</a
                ><span class="descendants">: 6</span></span
              >
            </h4>
          </section>
        </section>
      </section>
      <section id="archives">
        <h2>
          <a
            href="https://github.com/kherrick/hacker-news/blob/main/archives/index.md"
            >Archives</a
          >
        </h2>
        <section>
          <h3>
            <a
              href="https://github.com/kherrick/hacker-news/blob/main/archives/2024/index.md"
              >2024</a
            >
          </h3>
        </section>
        <section>
          <h3>
            <a
              href="https://github.com/kherrick/hacker-news/blob/main/archives/2023/index.md"
              >2023</a
            >
          </h3>
        </section>
        <section>
          <h3>
            <a
              href="https://github.com/kherrick/hacker-news/blob/main/archives/2022/index.md"
              >2022</a
            >
          </h3>
        </section>
      </section>
    </main>
    <script type="module">
      import { buildDescendants } from "./lib/build-html-descendants.js";
      import { buildNextItem } from "./lib/build-html-next-item.js";
      import { getNextDateTime } from "./lib/date-time.js";

      const updateSectionById = (id) =>
        fetch(`https://hacker-news.firebaseio.com/v0/item/${id}.json`).then(
          (result) =>
            result.json().then(({ descendants, id, score, text, type }) => {
              const currentItem = document.getElementById(id);

              if (score) {
                currentItem.querySelector(".points").textContent = score;
              }

              if (descendants && (type === "poll" || type === "story")) {
                const currentDescendants =
                  currentItem.querySelector(".descendants");

                if (currentDescendants) {
                  currentDescendants.textContent = `: ${descendants}`;
                } else {
                  const comments = buildDescendants(
                    document,
                    descendants,
                    `https://news.ycombinator.com/item?id=${id}`
                  );

                  currentItem.querySelector("h4").appendChild(comments);
                }
              }

              if (text) {
                const currentText = currentItem.querySelector(".text");

                if (currentText) {
                  currentText.innerHTML = text.replace(/\0/g, "");
                } else {
                  const content = document.createElement("div");
                  content.innerHTML = text.replace(/\0/g, "");
                  content.setAttribute("class", "text");

                  currentItem.appendChild(content);
                }
              }
            })
        );

      class UpdateQueue {
        constructor() {
          this._ids = [];
          this._isUpdating = false;
        }

        addItemById(id) {
          this._ids.push(id);
        }

        async flush() {
          const id = this._ids.shift();

          if (id) {
            this._isUpdating = true;

            await updateSectionById(id);
            await this.flush();
          } else {
            this._isUpdating = false;

            setTimeout(async () => {
              if (!this._isUpdating && this._ids && this._ids.length) {
                await this.flush();
              }
            }, 0);
          }
        }
      }

      // get latest data
      const latestSection = document.getElementById("latest");

      for (let item of latestSection.querySelectorAll("section[id]")) {
        updateSectionById(item.getAttribute("id"));
      }

      if ("IntersectionObserver" in window) {
        window.hackerNewsState = { index: [], nextTimeIndex: -1 };

        const addNewsItem = async (newsItem, queue) => {
          try {
            const { date, time, itemComments, itemTitle, itemLink } = newsItem;
            const section = await buildNextItem({
              document,
              dateTime: `${date}, ${time}`,
              itemComments,
              itemLink,
              itemTitle: new DOMParser().parseFromString(
                itemTitle.replace(/\\/g, ""),
                "text/html"
              ).documentElement.textContent,
              fetchItemDetails: false,
            });

            // display loading indicator for section
            section.querySelector(".points-container").innerHTML =
              'Points: <span class="points"><img style="height: 100%;" src="lib/images/loading.svg" /></span>';

            const id = section.getAttribute("id");
            if (!document.getElementById(id)) {
              document.getElementById("latest").appendChild(section);

              queue.addItemById(id);
            }
          } catch (error) {}
        };

        const buildArchiveIndex = async (lastDateTime) => {
          const nextDate = lastDateTime.slice(0, 10);
          const nextYear = nextDate.slice(0, 4);

          return (
            await (
              await fetch(
                `https://raw.githubusercontent.com/kherrick/hacker-news/main/archives/${nextYear}/${nextDate}/index.md`
              )
            ).text()
          )
            .split("\n")
            .filter((line) => line.match(new RegExp("^\\* \\[")))
            .map((line) => {
              const segment = line.replace("* ", "").split("](");
              const pubDate = segment[0].slice(1);

              const itemComments = segment[1].split(") - [")[0];
              const itemTitle = segment[1].split(") - [")[1];
              const itemLink = segment[2].slice(0, -1);
              const date = pubDate.slice(0, 10);
              const time = pubDate.slice(-8);

              return {
                date,
                itemComments,
                itemLink,
                itemTitle,
                time,
              };
            });
        };

        const handleIntersectingEntry = async (entry, queue) => {
          if (entry.isIntersecting) {
            const lastDateTime = document
              .getElementById("latest")
              .querySelector(
                "section:last-child > section > h4 > span"
              ).textContent;

            const nextDateTime = getNextDateTime(lastDateTime ?? "", -1);
            const archiveIndex = await buildArchiveIndex(nextDateTime);
            const nextTimeIndex = archiveIndex.findIndex(
              ({ time }) => time === nextDateTime.slice(-8)
            );

            const handleIndexUpdate = (index, existingIndexValues = []) => {
              index.forEach((i) => {
                existingIndexValues.push(i);
              });
              return existingIndexValues;
            };

            window.hackerNewsState = {
              index: handleIndexUpdate(
                archiveIndex,
                window.hackerNewsState.index
              ),
              nextTimeIndex,
            };

            let currentTimeIndex = nextTimeIndex + 1;
            const items = Object.values(window.hackerNewsState.index);
            for (let item of items) {
              if (currentTimeIndex < window.hackerNewsState.index.length) {
                addNewsItem(items[currentTimeIndex], queue);

                currentTimeIndex = currentTimeIndex + 1;
              }
            }

            queue.flush();
          }
        };

        const archives = document.getElementById("archives");
        const archivesObserver = new IntersectionObserver(
          (entries) => {
            const queue = new UpdateQueue();

            entries.forEach((entry) => handleIntersectingEntry(entry, queue));
          },
          {
            root: null,
            rootMargin: "0px",
            threshold: 0,
          }
        );

        archivesObserver.observe(archives);

        let latestSectionsExpanded = true;
        const handleLatestHeaderClick = () => {
          latestSectionsExpanded = !latestSectionsExpanded;

          if (latestSectionsExpanded) {
            archivesObserver.observe(archives);
          } else {
            archivesObserver.disconnect(archives);
          }

          for (let section of document.querySelectorAll("#latest > section")) {
            section.style.display = latestSectionsExpanded ? "block" : "none";
          }
        };

        const latestHeader = document.querySelector("#latest > h2");
        latestHeader.style.cursor = "pointer";
        latestHeader.addEventListener("click", handleLatestHeaderClick);
      }
    </script>
    <script type="module">
      import { Workbox } from "https://storage.googleapis.com/workbox-cdn/releases/6.4.1/workbox-window.prod.mjs";

      if ("serviceWorker" in navigator) {
        const base = document.querySelector("base");
        const serviceWorkerPath = `${
          base ? base.href.replace(/\/$/, "") : ""
        }/service-worker.js`;

        const wb = new Workbox(serviceWorkerPath);

        // setup event listeners
        wb.addEventListener("waiting", (event) => {
          wb.addEventListener("controlling", () => {
            window.location.reload();
          });

          wb.messageSkipWaiting();
        });

        wb.register();
      }
    </script>
  </body>
</html>
