<!DOCTYPE html>
<html lang="en" xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta charset="utf-8" />
    <meta
      content="width=device-width, initial-scale=1.0, viewport-fit=cover"
      name="viewport"
    />
    <meta name="description" content="Hacker News" />
    <meta name="theme-color" content="#fff" />
    <title>Hacker News</title>
    <link rel="manifest" href="manifest.json" />
    <link
      href="data:image/x-icon;base64,AAABAAEAAQECAAEAAQA4AAAAFgAAACgAAAABAAAAAgAAAAEAAQAAAAAAAAAAAAAAAAAAAAAAAAAAAAABAAEAAQECAAEAAQA4AAAAFgAAACgAAAABAAAAAgAAAAEAAQAAAAAAAAAAAAAAAAAAAAAAAAAA"
      rel="icon"
      type="image/x-icon"
    />
    <link
      href="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAgAAAAIAAQMAAADOtka5AAAAA1BMVEUAAACnej3aAAAANklEQVR42u3BAQEAAACCIP+vbkhAAQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAB8G4IAAAFjdVCkAAAAAElFTkSuQmCC"
      rel="apple-touch-icon"
    />
    <style>
      /*<!--*/
      body {
        color: rgb(25, 25, 25);
        font-family: Verdana, Geneva, sans-serif;
        margin: 0;
      }

      a {
        text-decoration: none;
      }

      a:link,
      a:focus,
      a:hover,
      a:active {
        color: rgb(75, 75, 125);
      }

      a:visited {
        color: rgb(25, 25, 25);
      }

      h1 > a,
      h1 > a:link,
      h1 > a:focus,
      h1 > a:hover,
      h1 > a:active,
      h1 > a:visited,
      h2 > a,
      h2 > a:link,
      h2 > a:focus,
      h2 > a:hover,
      h2 > a:active,
      h2 > a:visited {
        color: rgb(25, 25, 25);
      }

      h1 {
        background-color: rgb(255, 102, 0);
        margin: 0;
        padding: 1rem;
      }

      h2 {
        background-color: rgb(200, 200, 200);
        margin: 1rem 0;
        padding: 0.5rem 0.5rem 0.5rem 1rem;
      }

      #latest > section,
      #archives > section {
        margin: 0 1rem 1rem 1rem;
        padding-bottom: 1rem;
      }

      #latest > section:not(:last-child),
      #archives > section:not(:last-child) {
        border-bottom: 1px dotted rgb(200, 200, 200);
      }

      section > h3 {
        margin: 0 0 0.5rem 0;
      }

      section > h4 {
        font-weight: normal;
        margin: 0 0 0 1rem;
      }

      .descendants-container,
      .points-container {
        align-items: center;
        border-left: 1px solid #333;
        display: inline-flex;
        margin-left: 0.5rem;
        padding-left: 0.5rem;
        text-align: center;
      }

      .points {
        align-items: center;
        display: inline-flex;
        height: 1rem;
        margin-left: 1ch;
        min-width: 3ch;
      }

      .text {
        line-height: 1.5rem;
        margin: 1rem 1rem 0 1rem;
        overflow: auto;
      }

      .text > p:first-child {
        margin-top: 1rem;
      }

      .text > p:last-child {
        margin-bottom: 0;
      }
      /*-->*/
    </style>
  </head>

  <body>
    <main>
      <h1><a href="https://kherrick.github.io/hacker-news/">Hacker News</a></h1>
      <section id="latest">
        <h2>Latest</h2>
        <section id="37491369">
          <h3>
            <a
              class="item"
              href="https://github.com/google-research/google-research/tree/master/madlad_400"
              >Madlad-400: A Multilingual and Document-Level Large Audited
              Dataset</a
            >
          </h3>
          <section>
            <h4>
              <span>2023-09-13 @ 02:13:33</span
              ><span class="points-container"
                >Points: <span class="points">17</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=37491369"
                  >Comments</a
                ><span class="descendants">: 0</span></span
              >
            </h4>
          </section>
        </section>
        <section id="37490924">
          <h3>
            <a
              class="item"
              href="https://www.ignorance.ai/p/5-lessons-from-139-yc-ai-startups"
              >Lessons from YC AI Startups</a
            >
          </h3>
          <section>
            <h4>
              <span>2023-09-13 @ 01:12:46</span
              ><span class="points-container"
                >Points: <span class="points">26</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=37490924"
                  >Comments</a
                ><span class="descendants">: 8</span></span
              >
            </h4>
          </section>
        </section>
        <section id="37490623">
          <h3>
            <a class="item" href="https://makelinux.github.io/kernel/map/"
              >Interactive Map of Linux Kernel</a
            >
          </h3>
          <section>
            <h4>
              <span>2023-09-13 @ 00:31:56</span
              ><span class="points-container"
                >Points: <span class="points">35</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=37490623"
                  >Comments</a
                ><span class="descendants">: 3</span></span
              >
            </h4>
          </section>
        </section>
        <section id="37490300">
          <h3>
            <a
              class="item"
              href="https://www.lennysnewsletter.com/p/finding-product-market-fit"
              >How long it took different companies to find product-market
              fit</a
            >
          </h3>
          <section>
            <h4>
              <span>2023-09-12 @ 23:51:05</span
              ><span class="points-container"
                >Points: <span class="points">48</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=37490300"
                  >Comments</a
                ><span class="descendants">: 12</span></span
              >
            </h4>
          </section>
        </section>
        <section id="37490260">
          <h3>
            <a
              class="item"
              href="http://oldvcr.blogspot.com/2023/09/the-spawn-of-atarilab-and-universal.html"
              >The spawn of AtariLab and the Universal Laboratory Interface</a
            >
          </h3>
          <section>
            <h4>
              <span>2023-09-12 @ 23:46:47</span
              ><span class="points-container"
                >Points: <span class="points">13</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=37490260"
                  >Comments</a
                ><span class="descendants">: 0</span></span
              >
            </h4>
          </section>
        </section>
        <section id="37490256">
          <h3>
            <a
              class="item"
              href="https://commonedge.org/whats-to-become-of-the-mess-that-is-penn-station/"
              >Fixing Penn Station</a
            >
          </h3>
          <section>
            <h4>
              <span>2023-09-12 @ 23:46:22</span
              ><span class="points-container"
                >Points: <span class="points">71</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=37490256"
                  >Comments</a
                ><span class="descendants">: 52</span></span
              >
            </h4>
          </section>
        </section>
        <section id="37490241">
          <h3>
            <a
              class="item"
              href="https://www.bitsaboutmoney.com/archive/the-waste-stream-of-consumer-finance/"
              >Credit card debt collection</a
            >
          </h3>
          <section>
            <h4>
              <span>2023-09-12 @ 23:45:06</span
              ><span class="points-container"
                >Points: <span class="points">230</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=37490241"
                  >Comments</a
                ><span class="descendants">: 74</span></span
              >
            </h4>
          </section>
        </section>
        <section id="37488762">
          <h3>
            <a
              class="item"
              href="https://blog.janestreet.com/what-the-interns-have-wrought-2023/"
              >What the interns have wrought, 2023 edition</a
            >
          </h3>
          <section>
            <h4>
              <span>2023-09-12 @ 21:33:13</span
              ><span class="points-container"
                >Points: <span class="points">112</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=37488762"
                  >Comments</a
                ><span class="descendants">: 65</span></span
              >
            </h4>
          </section>
        </section>
        <section id="37488252">
          <h3>
            <a class="item" href="https://www.justpaid.io/careers"
              >JustPaid.io (YC W23) is hiring a senior full stack engineer</a
            >
          </h3>
          <section>
            <h4>
              <span>2023-09-12 @ 21:00:00</span
              ><span class="points-container"
                >Points: <span class="points">1</span></span
              >
            </h4>
          </section>
        </section>
        <section id="37488034">
          <h3>
            <a
              class="item"
              href="https://bricolage.io/some-notes-on-local-first-development/"
              >Some notes on local-first development</a
            >
          </h3>
          <section>
            <h4>
              <span>2023-09-12 @ 20:46:55</span
              ><span class="points-container"
                >Points: <span class="points">59</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=37488034"
                  >Comments</a
                ><span class="descendants">: 8</span></span
              >
            </h4>
          </section>
        </section>
        <section id="37487306">
          <h3>
            <a class="item" href="https://spectrum.ieee.org/cryogenics"
              >Electric cooling could shrink quantum computers</a
            >
          </h3>
          <section>
            <h4>
              <span>2023-09-12 @ 20:03:44</span
              ><span class="points-container"
                >Points: <span class="points">58</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=37487306"
                  >Comments</a
                ><span class="descendants">: 7</span></span
              >
            </h4>
          </section>
        </section>
        <section id="37486651">
          <h3>
            <a class="item" href="https://arxiv.org/abs/1806.06237"
              >PeerReview4All: Fair and accurate reviewer assignment in peer
              review</a
            >
          </h3>
          <section>
            <h4>
              <span>2023-09-12 @ 19:29:39</span
              ><span class="points-container"
                >Points: <span class="points">40</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=37486651"
                  >Comments</a
                ><span class="descendants">: 9</span></span
              >
            </h4>
          </section>
        </section>
        <section id="37485290">
          <h3>
            <a
              class="item"
              href="https://www.apple.com/newsroom/2023/09/apple-debuts-iphone-15-and-iphone-15-plus/"
              >iPhone 15 and iPhone 15 Plus</a
            >
          </h3>
          <section>
            <h4>
              <span>2023-09-12 @ 18:23:09</span
              ><span class="points-container"
                >Points: <span class="points">594</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=37485290"
                  >Comments</a
                ><span class="descendants">: 1448</span></span
              >
            </h4>
          </section>
        </section>
        <section id="37484135">
          <h3>
            <a class="item" href="https://news.ycombinator.com/item?id=37484135"
              >Fine-tune your own Llama 2 to replace GPT-3.5/4</a
            >
          </h3>
          <section>
            <h4>
              <span>2023-09-12 @ 16:53:51</span
              ><span class="points-container"
                >Points: <span class="points">636</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=37484135"
                  >Comments</a
                ><span class="descendants">: 141</span></span
              >
            </h4>
            <div class="text">
              <a href="https://news.ycombinator.com/item?id=37090632"
                >https://news.ycombinator.com/item?id=37090632</a
              >). I've been playing around with fine-tuning models for a couple
              of years, and wanted to share some insights and practical code.
              I’ve condensed what I’ve learned into a small set of notebooks at
              <a
                href="https://github.com/OpenPipe/OpenPipe/tree/main/examples/classify-recipes"
                >https://github.com/OpenPipe/OpenPipe/tree/main/examples/clas...</a
              >, covering labeling data, fine-tuning, running efficient
              inference, and evaluating costs/performance. The 7B model we train
              here matches GPT-4’s labels 95% of the time on the test set, and
              for the 5% of cases where they disagree it’s often because the
              correct answer is genuinely ambiguous.
              <p>
                What is fine-tuning? You can think of it as a more-powerful form
                of prompting, where instead of writing your instructions in text
                you actually encode them in the weights of the model itself. You
                do this by training an existing model on example input/output
                pairs that demonstrate the task you want your fine-tuned model
                to learn. Fine-tuning can work with as few as 50 examples but I
                usually try to get 1000+ if possible.
              </p>
              <p>
                Prompting still has some big advantages over fine-tuning. It's
                way easier/faster to iterate on your instructions than label
                data and re-train a model. And operationally it's easier to
                deploy one big model and just adjust its behavior as necessary
                vs deploying many small fine-tuned models that will likely each
                get lower utilization.
              </p>
              <p>
                Fine-tuning has one huge advantage though: it is far more
                effective at guiding a model's behavior than prompting, so you
                can often get away with a <i>much</i> smaller model. That gets
                you faster responses and lower inference costs. A fine-tuned
                Llama 7B model is 50x cheaper than GPT-3.5 on a per-token basis,
                and for many use cases can produce results that are as good or
                better!
              </p>
              <p>
                For example, classifying the 2M recipes at
                <a href="https://huggingface.co/datasets/corbt/all-recipes"
                  >https://huggingface.co/datasets/corbt/all-recipes</a
                >
                with GPT-4 would cost $23k. Even with GPT-3.5 it would cost over
                $1k. The model we fine-tuned performs similarly to GPT-4 and
                costs just $19 to run over the entire dataset.
              </p>
              <p>
                Disclaimer: My brother David and I are working on an open-source
                product called OpenPipe (<a
                  href="https://github.com/openpipe/openpipe"
                  >https://github.com/openpipe/openpipe</a
                >) to help engineers adopt fine-tuning as simply as possible.
                But none of the information above depends on our startup. The
                current post is just about sharing information that we’ve
                learned about fine-tuning. I hope it’s useful!
              </p>
            </div>
          </section>
        </section>
        <section id="37482517">
          <h3>
            <a
              class="item"
              href="https://ethz.ch/en/news-and-events/eth-news/news/2023/09/from-zero-to-one-hundred-in-0-956-seconds.html"
              >New world record with an electric racing car: From 0 to 100 in
              0.956 seconds</a
            >
          </h3>
          <section>
            <h4>
              <span>2023-09-12 @ 15:14:05</span
              ><span class="points-container"
                >Points: <span class="points">301</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=37482517"
                  >Comments</a
                ><span class="descendants">: 250</span></span
              >
            </h4>
          </section>
        </section>
        <section id="37482220">
          <h3>
            <a
              class="item"
              href="https://til.simonwillison.net/django/building-a-blog-in-django"
              >Notes from building a blog in Django</a
            >
          </h3>
          <section>
            <h4>
              <span>2023-09-12 @ 14:53:36</span
              ><span class="points-container"
                >Points: <span class="points">161</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=37482220"
                  >Comments</a
                ><span class="descendants">: 91</span></span
              >
            </h4>
          </section>
        </section>
        <section id="37481513">
          <h3>
            <a
              class="item"
              href="https://earthly.dev/blog/shutting-down-earthly-ci/"
              >We built the fastest CI and it failed</a
            >
          </h3>
          <section>
            <h4>
              <span>2023-09-12 @ 14:07:08</span
              ><span class="points-container"
                >Points: <span class="points">394</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=37481513"
                  >Comments</a
                ><span class="descendants">: 242</span></span
              >
            </h4>
          </section>
        </section>
        <section id="37480561">
          <h3>
            <a
              class="item"
              href="https://thepalindrome.org/p/how-large-that-number-in-the-law"
              >How large is that number in the Law of Large Numbers?</a
            >
          </h3>
          <section>
            <h4>
              <span>2023-09-12 @ 13:06:33</span
              ><span class="points-container"
                >Points: <span class="points">129</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=37480561"
                  >Comments</a
                ><span class="descendants">: 53</span></span
              >
            </h4>
          </section>
        </section>
        <section id="37480512">
          <h3>
            <a
              class="item"
              href="https://www.sony-semicon.com/en/news/2023/2023090701.html"
              >Sony develops energy harvesting module from electromagnetic wave
              noise</a
            >
          </h3>
          <section>
            <h4>
              <span>2023-09-12 @ 13:02:47</span
              ><span class="points-container"
                >Points: <span class="points">216</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=37480512"
                  >Comments</a
                ><span class="descendants">: 85</span></span
              >
            </h4>
          </section>
        </section>
        <section id="37480155">
          <h3>
            <a
              class="item"
              href="https://resobscura.substack.com/p/simulating-history-with-chatgpt"
              >Simulating History with ChatGPT</a
            >
          </h3>
          <section>
            <h4>
              <span>2023-09-12 @ 12:34:40</span
              ><span class="points-container"
                >Points: <span class="points">145</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=37480155"
                  >Comments</a
                ><span class="descendants">: 75</span></span
              >
            </h4>
          </section>
        </section>
        <section id="37479472">
          <h3>
            <a
              class="item"
              href="https://apnews.com/article/sweden-digital-education-backlash-reading-writing-1dd964c628f76361c43dbf3964f7dbf4"
              >Sweden brings more books and handwriting practice back to its
              tech-heavy schools</a
            >
          </h3>
          <section>
            <h4>
              <span>2023-09-12 @ 11:30:57</span
              ><span class="points-container"
                >Points: <span class="points">175</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=37479472"
                  >Comments</a
                ><span class="descendants">: 158</span></span
              >
            </h4>
          </section>
        </section>
        <section id="37477685">
          <h3>
            <a
              class="item"
              href="https://alexeymk.com/2023/09/11/statistical-significance-on-a-shoestring-budget.html"
              >Statistical significance on a shoestring budget</a
            >
          </h3>
          <section>
            <h4>
              <span>2023-09-12 @ 07:04:49</span
              ><span class="points-container"
                >Points: <span class="points">7</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=37477685"
                  >Comments</a
                ><span class="descendants">: 0</span></span
              >
            </h4>
          </section>
        </section>
        <section id="37474623">
          <h3>
            <a
              class="item"
              href="https://onlinelibrary.wiley.com/doi/10.1002/advs.202301673"
              >Recyclable Thin-Film Soft Electronics for Smart Packaging and
              E-Skins</a
            >
          </h3>
          <section>
            <h4>
              <span>2023-09-11 @ 22:35:51</span
              ><span class="points-container"
                >Points: <span class="points">4</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=37474623"
                  >Comments</a
                ><span class="descendants">: 0</span></span
              >
            </h4>
          </section>
        </section>
        <section id="37472340">
          <h3>
            <a class="item" href="https://retroachievements.org"
              >RetroAchievements: Adding achievements to retro games</a
            >
          </h3>
          <section>
            <h4>
              <span>2023-09-11 @ 19:19:28</span
              ><span class="points-container"
                >Points: <span class="points">89</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=37472340"
                  >Comments</a
                ><span class="descendants">: 45</span></span
              >
            </h4>
          </section>
        </section>
        <section id="37471077">
          <h3>
            <a
              class="item"
              href="https://geekingfrog.com/blog/post/protohackers-learnings"
              >Protohackers Learnings</a
            >
          </h3>
          <section>
            <h4>
              <span>2023-09-11 @ 18:03:10</span
              ><span class="points-container"
                >Points: <span class="points">29</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=37471077"
                  >Comments</a
                ><span class="descendants">: 2</span></span
              >
            </h4>
          </section>
        </section>
        <section id="37469954">
          <h3>
            <a
              class="item"
              href="https://medicalxpress.com/news/2023-09-scientists-decipher-fingertip-memory.html"
              >Scientists decipher the fingertip's 'memory'</a
            >
          </h3>
          <section>
            <h4>
              <span>2023-09-11 @ 16:47:21</span
              ><span class="points-container"
                >Points: <span class="points">8</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=37469954"
                  >Comments</a
                ><span class="descendants">: 0</span></span
              >
            </h4>
          </section>
        </section>
        <section id="37469590">
          <h3>
            <a
              class="item"
              href="https://www.seriouseats.com/sriracha-recipe-from-scratch"
              >Homemade Sriracha</a
            >
          </h3>
          <section>
            <h4>
              <span>2023-09-11 @ 16:23:47</span
              ><span class="points-container"
                >Points: <span class="points">180</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=37469590"
                  >Comments</a
                ><span class="descendants">: 98</span></span
              >
            </h4>
          </section>
        </section>
        <section id="37465586">
          <h3>
            <a class="item" href="https://astrochart.github.io/"
              >CHART: Completely Hackable Amateur Radio Telescope</a
            >
          </h3>
          <section>
            <h4>
              <span>2023-09-11 @ 11:18:42</span
              ><span class="points-container"
                >Points: <span class="points">163</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=37465586"
                  >Comments</a
                ><span class="descendants">: 42</span></span
              >
            </h4>
          </section>
        </section>
        <section id="37464950">
          <h3>
            <a
              class="item"
              href="https://sethmlarson.dev/security-developer-in-residence-weekly-report-9?date=2023-09-05"
              >Visualizing the CPython release process</a
            >
          </h3>
          <section>
            <h4>
              <span>2023-09-11 @ 09:50:36</span
              ><span class="points-container"
                >Points: <span class="points">71</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=37464950"
                  >Comments</a
                ><span class="descendants">: 1</span></span
              >
            </h4>
          </section>
        </section>
        <section id="37463059">
          <h3>
            <a
              class="item"
              href="https://reason.com/2023/09/10/the-pirate-preservationists/"
              >The Pirate Preservationists</a
            >
          </h3>
          <section>
            <h4>
              <span>2023-09-11 @ 04:59:54</span
              ><span class="points-container"
                >Points: <span class="points">29</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=37463059"
                  >Comments</a
                ><span class="descendants">: 2</span></span
              >
            </h4>
          </section>
        </section>
      </section>
      <section id="archives">
        <h2>
          <a
            href="https://github.com/kherrick/hacker-news/blob/main/archives/index.md"
            >Archives</a
          >
        </h2>
        <section>
          <h3>
            <a
              href="https://github.com/kherrick/hacker-news/blob/main/archives/2023/index.md"
              >2023</a
            >
          </h3>
        </section>
        <section>
          <h3>
            <a
              href="https://github.com/kherrick/hacker-news/blob/main/archives/2022/index.md"
              >2022</a
            >
          </h3>
        </section>
      </section>
    </main>
    <script type="module">
      import { buildDescendants } from "./lib/build-html-descendants.js";
      import { buildNextItem } from "./lib/build-html-next-item.js";
      import { getNextDateTime } from "./lib/date-time.js";

      const updateSectionById = (id) =>
        fetch(`https://hacker-news.firebaseio.com/v0/item/${id}.json`).then(
          (result) =>
            result.json().then(({ descendants, id, score, text, type }) => {
              const currentItem = document.getElementById(id);

              if (score) {
                currentItem.querySelector(".points").textContent = score;
              }

              if (descendants && (type === "poll" || type === "story")) {
                const currentDescendants =
                  currentItem.querySelector(".descendants");

                if (currentDescendants) {
                  currentDescendants.textContent = `: ${descendants}`;
                } else {
                  const comments = buildDescendants(
                    document,
                    descendants,
                    `https://news.ycombinator.com/item?id=${id}`
                  );

                  currentItem.querySelector("h4").appendChild(comments);
                }
              }

              if (text) {
                const currentText = currentItem.querySelector(".text");

                if (currentText) {
                  currentText.innerHTML = text.replace(/\0/g, "");
                } else {
                  const content = document.createElement("div");
                  content.innerHTML = text.replace(/\0/g, "");
                  content.setAttribute("class", "text");

                  currentItem.appendChild(content);
                }
              }
            })
        );

      class UpdateQueue {
        constructor() {
          this._ids = [];
          this._isUpdating = false;
        }

        addItemById(id) {
          this._ids.push(id);
        }

        async flush() {
          const id = this._ids.shift();

          if (id) {
            this._isUpdating = true;

            await updateSectionById(id);
            await this.flush();
          } else {
            this._isUpdating = false;

            setTimeout(async () => {
              if (!this._isUpdating && this._ids && this._ids.length) {
                await this.flush();
              }
            }, 0);
          }
        }
      }

      // get latest data
      const latestSection = document.getElementById("latest");

      for (let item of latestSection.querySelectorAll("section[id]")) {
        updateSectionById(item.getAttribute("id"));
      }

      if ("IntersectionObserver" in window) {
        window.hackerNewsState = { index: [], nextTimeIndex: -1 };

        const addNewsItem = async (newsItem, queue) => {
          try {
            const { date, time, itemComments, itemTitle, itemLink } = newsItem;
            const section = await buildNextItem({
              document,
              dateTime: `${date}, ${time}`,
              itemComments,
              itemLink,
              itemTitle: new DOMParser().parseFromString(
                itemTitle.replace(/\\/g, ""),
                "text/html"
              ).documentElement.textContent,
              fetchItemDetails: false,
            });

            // display loading indicator for section
            section.querySelector(".points-container").innerHTML =
              'Points: <span class="points"><img style="height: 100%;" src="lib/images/loading.svg" /></span>';

            const id = section.getAttribute("id");
            if (!document.getElementById(id)) {
              document.getElementById("latest").appendChild(section);

              queue.addItemById(id);
            }
          } catch (error) {}
        };

        const buildArchiveIndex = async (lastDateTime) => {
          const nextDate = lastDateTime.slice(0, 10);
          const nextYear = nextDate.slice(0, 4);

          return (
            await (
              await fetch(
                `https://raw.githubusercontent.com/kherrick/hacker-news/main/archives/${nextYear}/${nextDate}/index.md`
              )
            ).text()
          )
            .split("\n")
            .filter((line) => line.match(new RegExp("^\\* \\[")))
            .map((line) => {
              const segment = line.replace("* ", "").split("](");
              const pubDate = segment[0].slice(1);

              const itemComments = segment[1].split(") - [")[0];
              const itemTitle = segment[1].split(") - [")[1];
              const itemLink = segment[2].slice(0, -1);
              const date = pubDate.slice(0, 10);
              const time = pubDate.slice(-8);

              return {
                date,
                itemComments,
                itemLink,
                itemTitle,
                time,
              };
            });
        };

        const handleIntersectingEntry = async (entry, queue) => {
          if (entry.isIntersecting) {
            const lastDateTime = document
              .getElementById("latest")
              .querySelector(
                "section:last-child > section > h4 > span"
              ).textContent;

            const nextDateTime = getNextDateTime(lastDateTime ?? "", -1);
            const archiveIndex = await buildArchiveIndex(nextDateTime);
            const nextTimeIndex = archiveIndex.findIndex(
              ({ time }) => time === nextDateTime.slice(-8)
            );

            const handleIndexUpdate = (index, existingIndexValues = []) => {
              index.forEach((i) => {
                existingIndexValues.push(i);
              });
              return existingIndexValues;
            };

            window.hackerNewsState = {
              index: handleIndexUpdate(
                archiveIndex,
                window.hackerNewsState.index
              ),
              nextTimeIndex,
            };

            let currentTimeIndex = nextTimeIndex + 1;
            const items = Object.values(window.hackerNewsState.index);
            for (let item of items) {
              if (currentTimeIndex < window.hackerNewsState.index.length) {
                addNewsItem(items[currentTimeIndex], queue);

                currentTimeIndex = currentTimeIndex + 1;
              }
            }

            queue.flush();
          }
        };

        const archives = document.getElementById("archives");
        const archivesObserver = new IntersectionObserver(
          (entries) => {
            const queue = new UpdateQueue();

            entries.forEach((entry) => handleIntersectingEntry(entry, queue));
          },
          {
            root: null,
            rootMargin: "0px",
            threshold: 0,
          }
        );

        archivesObserver.observe(archives);

        let latestSectionsExpanded = true;
        const handleLatestHeaderClick = () => {
          latestSectionsExpanded = !latestSectionsExpanded;

          if (latestSectionsExpanded) {
            archivesObserver.observe(archives);
          } else {
            archivesObserver.disconnect(archives);
          }

          for (let section of document.querySelectorAll("#latest > section")) {
            section.style.display = latestSectionsExpanded ? "block" : "none";
          }
        };

        const latestHeader = document.querySelector("#latest > h2");
        latestHeader.style.cursor = "pointer";
        latestHeader.addEventListener("click", handleLatestHeaderClick);
      }
    </script>
    <script type="module">
      import { Workbox } from "https://storage.googleapis.com/workbox-cdn/releases/6.4.1/workbox-window.prod.mjs";

      if ("serviceWorker" in navigator) {
        const base = document.querySelector("base");
        const serviceWorkerPath = `${
          base ? base.href.replace(/\/$/, "") : ""
        }/service-worker.js`;

        const wb = new Workbox(serviceWorkerPath);

        // setup event listeners
        wb.addEventListener("waiting", (event) => {
          wb.addEventListener("controlling", () => {
            window.location.reload();
          });

          wb.messageSkipWaiting();
        });

        wb.register();
      }
    </script>
  </body>
</html>
