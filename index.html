<!DOCTYPE html>
<html lang="en" xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta charset="utf-8" />
    <meta
      content="width=device-width, initial-scale=1.0, viewport-fit=cover"
      name="viewport"
    />
    <meta name="description" content="Hacker News" />
    <meta name="theme-color" content="#fff" />
    <title>Hacker News</title>
    <link rel="manifest" href="manifest.json" />
    <link
      href="data:image/x-icon;base64,AAABAAEAAQECAAEAAQA4AAAAFgAAACgAAAABAAAAAgAAAAEAAQAAAAAAAAAAAAAAAAAAAAAAAAAAAAABAAEAAQECAAEAAQA4AAAAFgAAACgAAAABAAAAAgAAAAEAAQAAAAAAAAAAAAAAAAAAAAAAAAAA"
      rel="icon"
      type="image/x-icon"
    />
    <link
      href="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAgAAAAIAAQMAAADOtka5AAAAA1BMVEUAAACnej3aAAAANklEQVR42u3BAQEAAACCIP+vbkhAAQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAB8G4IAAAFjdVCkAAAAAElFTkSuQmCC"
      rel="apple-touch-icon"
    />
    <style>
      /*<!--*/
      body {
        color: rgb(25, 25, 25);
        font-family: Verdana, Geneva, sans-serif;
        margin: 0;
      }

      a {
        text-decoration: none;
      }

      a:link,
      a:focus,
      a:hover,
      a:active {
        color: rgb(75, 75, 125);
      }

      a:visited {
        color: rgb(25, 25, 25);
      }

      h1 > a,
      h1 > a:link,
      h1 > a:focus,
      h1 > a:hover,
      h1 > a:active,
      h1 > a:visited,
      h2 > a,
      h2 > a:link,
      h2 > a:focus,
      h2 > a:hover,
      h2 > a:active,
      h2 > a:visited {
        color: rgb(25, 25, 25);
      }

      h1 {
        background-color: rgb(255, 102, 0);
        margin: 0;
        padding: 1rem;
      }

      h2 {
        background-color: rgb(200, 200, 200);
        margin: 1rem 0;
        padding: 0.5rem 0.5rem 0.5rem 1rem;
      }

      #latest > section,
      #archives > section {
        margin: 0 1rem 1rem 1rem;
        padding-bottom: 1rem;
      }

      #latest > section:not(:last-child),
      #archives > section:not(:last-child) {
        border-bottom: 1px dotted rgb(200, 200, 200);
      }

      section > h3 {
        margin: 0 0 0.5rem 0;
      }

      section > h4 {
        font-weight: normal;
        margin: 0 0 0 1rem;
      }

      .descendants-container,
      .points-container {
        align-items: center;
        border-left: 1px solid #333;
        display: inline-flex;
        margin-left: 0.5rem;
        padding-left: 0.5rem;
        text-align: center;
      }

      .points {
        align-items: center;
        display: inline-flex;
        height: 1rem;
        margin-left: 1ch;
        min-width: 3ch;
      }

      .text {
        line-height: 1.5rem;
        margin: 1rem 1rem 0 1rem;
        overflow: auto;
      }

      .text > p:first-child {
        margin-top: 1rem;
      }

      .text > p:last-child {
        margin-bottom: 0;
      }
      /*-->*/
    </style>
  </head>

  <body>
    <main>
      <h1><a href="https://kherrick.github.io/hacker-news/">Hacker News</a></h1>
      <section id="latest">
        <h2>Latest</h2>
        <section id="35766965">
          <h3>
            <a
              class="item"
              href="https://www.nature.com/articles/s41565-023-01372-9"
              >CRISPR-Cas-amplified urinary biomarkers for cancer diagnostics</a
            >
          </h3>
          <section>
            <h4>
              <span>2023-04-30 @ 21:57:20</span
              ><span class="points-container"
                >Points: <span class="points">25</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=35766965"
                  >Comments</a
                ><span class="descendants">: 2</span></span
              >
            </h4>
          </section>
        </section>
        <section id="35766747">
          <h3>
            <a
              class="item"
              href="https://archive.org/details/advanced-amiga-architecture"
              >Advanced Amiga Architecture (1992)</a
            >
          </h3>
          <section>
            <h4>
              <span>2023-04-30 @ 21:23:07</span
              ><span class="points-container"
                >Points: <span class="points">37</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=35766747"
                  >Comments</a
                ><span class="descendants">: 12</span></span
              >
            </h4>
          </section>
        </section>
        <section id="35766570">
          <h3>
            <a class="item" href="https://www.minetest.net/"
              >Minetest: An open source voxel game engine</a
            >
          </h3>
          <section>
            <h4>
              <span>2023-04-30 @ 20:58:54</span
              ><span class="points-container"
                >Points: <span class="points">150</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=35766570"
                  >Comments</a
                ><span class="descendants">: 35</span></span
              >
            </h4>
          </section>
        </section>
        <section id="35765933">
          <h3>
            <a
              class="item"
              href="https://bagerbach.com/books/grokking-simplicity"
              >Grokking Simplicity: Taming complex software with functional
              thinking</a
            >
          </h3>
          <section>
            <h4>
              <span>2023-04-30 @ 19:41:05</span
              ><span class="points-container"
                >Points: <span class="points">43</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=35765933"
                  >Comments</a
                ><span class="descendants">: 3</span></span
              >
            </h4>
          </section>
        </section>
        <section id="35765783">
          <h3>
            <a
              class="item"
              href="https://paulkingsnorth.substack.com/p/the-universal"
              >Four questions concerning the internet</a
            >
          </h3>
          <section>
            <h4>
              <span>2023-04-30 @ 19:23:44</span
              ><span class="points-container"
                >Points: <span class="points">16</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=35765783"
                  >Comments</a
                ><span class="descendants">: 8</span></span
              >
            </h4>
          </section>
        </section>
        <section id="35765707">
          <h3>
            <a class="item" href="https://github.com/dylanaraps/pure-sh-bible"
              >Pure Sh Bible</a
            >
          </h3>
          <section>
            <h4>
              <span>2023-04-30 @ 19:16:41</span
              ><span class="points-container"
                >Points: <span class="points">185</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=35765707"
                  >Comments</a
                ><span class="descendants">: 58</span></span
              >
            </h4>
          </section>
        </section>
        <section id="35765690">
          <h3>
            <a class="item" href="https://www.emudeck.com/"
              >EmuDeck 2.1: Steam Deck emulation installer</a
            >
          </h3>
          <section>
            <h4>
              <span>2023-04-30 @ 19:14:51</span
              ><span class="points-container"
                >Points: <span class="points">36</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=35765690"
                  >Comments</a
                ><span class="descendants">: 7</span></span
              >
            </h4>
          </section>
        </section>
        <section id="35765560">
          <h3>
            <a
              class="item"
              href="https://transistor-man.com/lenovo_ebike_adapter.html"
              >DIY Adapter: Using an e-bike battery to run a laptop</a
            >
          </h3>
          <section>
            <h4>
              <span>2023-04-30 @ 19:02:17</span
              ><span class="points-container"
                >Points: <span class="points">15</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=35765560"
                  >Comments</a
                ><span class="descendants">: 4</span></span
              >
            </h4>
          </section>
        </section>
        <section id="35765374">
          <h3>
            <a
              class="item"
              href="https://newest.co/necrobrands-digital-end-stage-capitalism"
              >Necrobrands – Digital End-Stage Capitalism</a
            >
          </h3>
          <section>
            <h4>
              <span>2023-04-30 @ 18:42:17</span
              ><span class="points-container"
                >Points: <span class="points">4</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=35765374"
                  >Comments</a
                ><span class="descendants">: 3</span></span
              >
            </h4>
          </section>
        </section>
        <section id="35765177">
          <h3>
            <a
              class="item"
              href="https://thechipletter.substack.com/p/the-risc-wars-part-1-the-cambrian-c55"
              >The RISC Wars Part 1: The Cambrian Explosion</a
            >
          </h3>
          <section>
            <h4>
              <span>2023-04-30 @ 18:20:33</span
              ><span class="points-container"
                >Points: <span class="points">47</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=35765177"
                  >Comments</a
                ><span class="descendants">: 27</span></span
              >
            </h4>
          </section>
        </section>
        <section id="35765100">
          <h3>
            <a
              class="item"
              href="https://www.micahlerner.com/2023/04/16/perseus-a-fail-slow-detection-framework-for-cloud-storage-systems.html"
              >Perseus: A Fail-Slow Detection Framework for Cloud Storage
              Systems</a
            >
          </h3>
          <section>
            <h4>
              <span>2023-04-30 @ 18:12:48</span
              ><span class="points-container"
                >Points: <span class="points">4</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=35765100"
                  >Comments</a
                ><span class="descendants">: 0</span></span
              >
            </h4>
          </section>
        </section>
        <section id="35764635">
          <h3>
            <a class="item" href="https://pysaas.io"
              >Show HN: PySaaS – Python SaaS starter kit</a
            >
          </h3>
          <section>
            <h4>
              <span>2023-04-30 @ 17:22:42</span
              ><span class="points-container"
                >Points: <span class="points">64</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=35764635"
                  >Comments</a
                ><span class="descendants">: 29</span></span
              >
            </h4>
            <div class="text">
              <p>
                Recently, I’ve noticed there’s a decently high barrier to entry
                in developing competitive, full-stack SaaS applications.
              </p>
              <p>
                Beside the standard, boring features that take months to
                implement, you typically have to know several languages and
                frameworks, and be familiar with fancy frontend styling classes.
              </p>
              <p>
                I’m working hard right now to solve this problem by building
                PySaaS- The 100% pure Python SaaS starter kit.
              </p>
              <p>
                PySaaS is a boilerplate Python codebase that takes care of the
                fundamental components standard to all SaaS applications.
              </p>
              <p>
                The codebase uses the Pynecone web framework to compile your
                frontend into a NextJS app, so you never have to touch any HTML,
                CSS, or Javascript. Pynecone is easy to learn, yet fully
                flexible and powerful enough for advanced use cases. We
                implement out-of-the-box functionality for secure Firebase user
                authentication, Lemon Squeezy subscription management (MoR
                removes a major tax headache), Notion as a headless blog CMS,
                and more.
              </p>
              <p>
                Our mission is to help developers and founders save months of
                development time and focus on building unique features, which
                will in turn provide more opportunities to generate revenue and
                give value to customers.
              </p>
              <p>
                And easily do it in pure Python! Frontend. Backend. All in
                Python.
              </p>
              <p>
                To check out the live demo for free, click the link and then the
                “See Demo” button.
              </p>
              <p>Let me know what you think.</p>
            </div>
          </section>
        </section>
        <section id="35764584">
          <h3>
            <a
              class="item"
              href="https://www.thecurb.com.au/40-years-of-koyaanisqatsi/"
              >40 Years of Koyaanisqatsi</a
            >
          </h3>
          <section>
            <h4>
              <span>2023-04-30 @ 17:17:09</span
              ><span class="points-container"
                >Points: <span class="points">208</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=35764584"
                  >Comments</a
                ><span class="descendants">: 72</span></span
              >
            </h4>
          </section>
        </section>
        <section id="35764476">
          <h3>
            <a
              class="item"
              href="https://news.ubc.ca/2023/03/22/new-ubc-water-treatment-zaps-forever-chemicals-for-good/"
              >Engineers develop water filtration that removes “forever
              chemicals”</a
            >
          </h3>
          <section>
            <h4>
              <span>2023-04-30 @ 17:03:24</span
              ><span class="points-container"
                >Points: <span class="points">178</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=35764476"
                  >Comments</a
                ><span class="descendants">: 95</span></span
              >
            </h4>
          </section>
        </section>
        <section id="35764445">
          <h3>
            <a
              class="item"
              href="https://www.ycombinator.com/companies/patterns"
              >Patterns (YC S21) Is Hiring AI Engineers</a
            >
          </h3>
          <section>
            <h4>
              <span>2023-04-30 @ 17:00:37</span
              ><span class="points-container"
                >Points: <span class="points">1</span></span
              >
            </h4>
          </section>
        </section>
        <section id="35764355">
          <h3>
            <a class="item" href="https://github.com/georgia-tech-db/eva"
              >Show HN: EVA – AI-Relational Database System</a
            >
          </h3>
          <section>
            <h4>
              <span>2023-04-30 @ 16:52:01</span
              ><span class="points-container"
                >Points: <span class="points">143</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=35764355"
                  >Comments</a
                ><span class="descendants">: 19</span></span
              >
            </h4>
            <div class="text">
              <p>
                We are building EVA, an AI-Relational database system with
                first-class support for deep learning models. Our goal with EVA
                is to create a platform that supports AI-powered multi-modal
                database applications operating on structured (tables, feature
                vectors, etc.) and unstructured data (videos, podcasts, pdf,
                etc.) with deep learning models. EVA comes with a wide range of
                models for analyzing unstructured data, including models for
                object detection, OCR, text summarization, audio speech
                recognition, and more.
              </p>
              <p>
                The key feature of EVA is its AI-centric query optimizer. This
                optimizer is designed to speed up AI-powered applications using
                a collection of optimizations inspired by relational database
                systems. Two of the most important optimizations are:
              </p>
              <p>
                + Caching: EVA automatically reuses previous query results
                (e.g., inference results), eliminating redundant computation and
                saving you money on inference.
              </p>
              <p>
                + Predicate Reordering: EVA optimizes the order in which query
                predicates are evaluated (e.g., running faster, more selective
                deep learning models first), leading to faster queries.
              </p>
              <p>
                Besides saving money spent on inference, EVA also makes it
                easier to write SQL queries to set up multi-modal AI pipelines.
                With EVA, you can quickly integrate your AI models into the
                database system and seamlessly query structured and unstructured
                data.
              </p>
              <p>
                We are constantly working on improving EVA and would love to
                hear your feedback!
              </p>
            </div>
          </section>
        </section>
        <section id="35764176">
          <h3>
            <a
              class="item"
              href="http://0x80.pl/notesen/2023-04-30-lookup-in-strings.html"
              >Modern perfect hashing for strings</a
            >
          </h3>
          <section>
            <h4>
              <span>2023-04-30 @ 16:35:04</span
              ><span class="points-container"
                >Points: <span class="points">10</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=35764176"
                  >Comments</a
                ><span class="descendants">: 0</span></span
              >
            </h4>
          </section>
        </section>
        <section id="35763483">
          <h3>
            <a class="item" href="https://github.com/mlc-ai/mlc-llm"
              >MLC-LLM: GPT/Llama on consumer-class GPUs and phones</a
            >
          </h3>
          <section>
            <h4>
              <span>2023-04-30 @ 15:30:17</span
              ><span class="points-container"
                >Points: <span class="points">261</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=35763483"
                  >Comments</a
                ><span class="descendants">: 89</span></span
              >
            </h4>
          </section>
        </section>
        <section id="35763307">
          <h3>
            <a class="item" href="https://britneyspears.ac/lasers.htm"
              >Britney Spears' Guide to Semiconductor Physics (2000)</a
            >
          </h3>
          <section>
            <h4>
              <span>2023-04-30 @ 15:15:41</span
              ><span class="points-container"
                >Points: <span class="points">9</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=35763307"
                  >Comments</a
                ><span class="descendants">: 2</span></span
              >
            </h4>
          </section>
        </section>
        <section id="35763100">
          <h3>
            <a
              class="item"
              href="https://ishadeed.com/article/rebuild-featured-news-modern-css/"
              >Rebuilding a featured news section with modern CSS: Vox news</a
            >
          </h3>
          <section>
            <h4>
              <span>2023-04-30 @ 14:55:55</span
              ><span class="points-container"
                >Points: <span class="points">151</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=35763100"
                  >Comments</a
                ><span class="descendants">: 64</span></span
              >
            </h4>
          </section>
        </section>
        <section id="35762780">
          <h3>
            <a
              class="item"
              href="https://covertactionmagazine.com/2023/04/25/whistleblowers-are-the-conscience-of-society-yet-suffer-gravely-for-trying-to-hold-the-rich-and-powerful-accountable-for-their-sins/"
              >Whistleblowers are the conscience of society, yet suffer
              gravely</a
            >
          </h3>
          <section>
            <h4>
              <span>2023-04-30 @ 14:17:46</span
              ><span class="points-container"
                >Points: <span class="points">740</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=35762780"
                  >Comments</a
                ><span class="descendants">: 306</span></span
              >
            </h4>
          </section>
        </section>
        <section id="35762483">
          <h3>
            <a class="item" href="http://www.braeunig.us/space/orbmech.htm"
              >Orbital Mechanics</a
            >
          </h3>
          <section>
            <h4>
              <span>2023-04-30 @ 13:45:37</span
              ><span class="points-container"
                >Points: <span class="points">161</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=35762483"
                  >Comments</a
                ><span class="descendants">: 41</span></span
              >
            </h4>
          </section>
        </section>
        <section id="35762284">
          <h3>
            <a
              class="item"
              href="https://chess24.com/en/watch/live-tournaments/nepo-ding-world-chess-championship-2023/2/1/4"
              >FIDE world chess championship decided in rapid tiebreaks</a
            >
          </h3>
          <section>
            <h4>
              <span>2023-04-30 @ 13:20:09</span
              ><span class="points-container"
                >Points: <span class="points">220</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=35762284"
                  >Comments</a
                ><span class="descendants">: 143</span></span
              >
            </h4>
          </section>
        </section>
        <section id="35762175">
          <h3>
            <a class="item" href="https://github.com/Textualize/frogmouth"
              >Show HN: Frogmouth – A Markdown browser for the terminal</a
            >
          </h3>
          <section>
            <h4>
              <span>2023-04-30 @ 13:05:01</span
              ><span class="points-container"
                >Points: <span class="points">192</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=35762175"
                  >Comments</a
                ><span class="descendants">: 56</span></span
              >
            </h4>
            <div class="text">
              <p>
                Frogmouth is a TUI to display Markdown files. It does a passable
                job of displaying Markdown, with code blocks and tables. No
                image support as yet.
              </p>
              <p>
                It's very browser like, with navigation stack, history, and
                bookmarks. Works with both the mouse and keyboard.
              </p>
              <p>
                There are shortcuts for viewing README.md files and other
                Markdown on GitHub and GitLab.
              </p>
              <p>License is MIT.</p>
              <p>Let me know what you think...</p>
            </div>
          </section>
        </section>
        <section id="35761706">
          <h3>
            <a
              class="item"
              href="https://apnews.com/article/boeing-max-crashes-faa-ea8fac0ad2758b08c58d2d64756fbf37"
              >FAA overruled engineers, let Boeing Max keep flying</a
            >
          </h3>
          <section>
            <h4>
              <span>2023-04-30 @ 11:48:16</span
              ><span class="points-container"
                >Points: <span class="points">226</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=35761706"
                  >Comments</a
                ><span class="descendants">: 97</span></span
              >
            </h4>
          </section>
        </section>
        <section id="35761457">
          <h3>
            <a
              class="item"
              href="https://brickexperimentchannel.wordpress.com/2023/04/29/lego-googol-machine/"
              >Lego Googol Machine</a
            >
          </h3>
          <section>
            <h4>
              <span>2023-04-30 @ 11:06:41</span
              ><span class="points-container"
                >Points: <span class="points">72</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=35761457"
                  >Comments</a
                ><span class="descendants">: 17</span></span
              >
            </h4>
          </section>
        </section>
        <section id="35760087">
          <h3>
            <a
              class="item"
              href="https://internationalbanker.com/brokerage/why-are-lithium-prices-collapsing/"
              >Why are lithium prices collapsing?</a
            >
          </h3>
          <section>
            <h4>
              <span>2023-04-30 @ 06:16:12</span
              ><span class="points-container"
                >Points: <span class="points">182</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=35760087"
                  >Comments</a
                ><span class="descendants">: 421</span></span
              >
            </h4>
          </section>
        </section>
        <section id="35759804">
          <h3>
            <a
              class="item"
              href="https://www.loa.org/news-and-views/2145-notes-on-charles-portiss-notes-jay-jennings-pores-over-a-cache-of-papers-by-americas-least-known-great-writer"
              >Notes on Charles Portis’s notes: papers by America’s “least-known
              great writer”</a
            >
          </h3>
          <section>
            <h4>
              <span>2023-04-30 @ 04:59:19</span
              ><span class="points-container"
                >Points: <span class="points">11</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=35759804"
                  >Comments</a
                ><span class="descendants">: 0</span></span
              >
            </h4>
          </section>
        </section>
        <section id="35759687">
          <h3>
            <a
              class="item"
              href="https://www.wsj.com/articles/why-beethoven-review-can-a-genius-survive-a9e1e516"
              >‘Why beethoven’ review: Can a genius survive?</a
            >
          </h3>
          <section>
            <h4>
              <span>2023-04-30 @ 04:27:34</span
              ><span class="points-container"
                >Points: <span class="points">10</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=35759687"
                  >Comments</a
                ><span class="descendants">: 2</span></span
              >
            </h4>
          </section>
        </section>
        <section id="35748030">
          <h3>
            <a
              class="item"
              href="https://www.artforum.com/print/202304/claire-bishop-on-the-superabundance-of-research-based-art-90274"
              >Information Overload: on the superabundance of research-based
              art</a
            >
          </h3>
          <section>
            <h4>
              <span>2023-04-28 @ 22:40:25</span
              ><span class="points-container"
                >Points: <span class="points">38</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=35748030"
                  >Comments</a
                ><span class="descendants">: 1</span></span
              >
            </h4>
          </section>
        </section>
      </section>
      <section id="archives">
        <h2>
          <a
            href="https://github.com/kherrick/hacker-news/blob/main/archives/index.md"
            >Archives</a
          >
        </h2>
        <section>
          <h3>
            <a
              href="https://github.com/kherrick/hacker-news/blob/main/archives/2023/index.md"
              >2023</a
            >
          </h3>
        </section>
        <section>
          <h3>
            <a
              href="https://github.com/kherrick/hacker-news/blob/main/archives/2022/index.md"
              >2022</a
            >
          </h3>
        </section>
      </section>
    </main>
    <script type="module">
      import { buildDescendants } from "./lib/build-html-descendants.js";
      import { buildNextItem } from "./lib/build-html-next-item.js";
      import { getNextDateTime } from "./lib/date-time.js";

      const updateSectionById = (id) =>
        fetch(`https://hacker-news.firebaseio.com/v0/item/${id}.json`).then(
          (result) =>
            result.json().then(({ descendants, id, score, text, type }) => {
              const currentItem = document.getElementById(id);

              if (score) {
                currentItem.querySelector(".points").textContent = score;
              }

              if (descendants && (type === "poll" || type === "story")) {
                const currentDescendants =
                  currentItem.querySelector(".descendants");

                if (currentDescendants) {
                  currentDescendants.textContent = `: ${descendants}`;
                } else {
                  const comments = buildDescendants(
                    document,
                    descendants,
                    `https://news.ycombinator.com/item?id=${id}`
                  );

                  currentItem.querySelector("h4").appendChild(comments);
                }
              }

              if (text) {
                const currentText = currentItem.querySelector(".text");

                if (currentText) {
                  currentText.innerHTML = text.replace(/\0/g, "");
                } else {
                  const content = document.createElement("div");
                  content.innerHTML = text.replace(/\0/g, "");
                  content.setAttribute("class", "text");

                  currentItem.appendChild(content);
                }
              }
            })
        );

      class UpdateQueue {
        constructor() {
          this._ids = [];
          this._isUpdating = false;
        }

        addItemById(id) {
          this._ids.push(id);
        }

        async flush() {
          const id = this._ids.shift();

          if (id) {
            this._isUpdating = true;

            await updateSectionById(id);
            await this.flush();
          } else {
            this._isUpdating = false;

            setTimeout(async () => {
              if (!this._isUpdating && this._ids && this._ids.length) {
                await this.flush();
              }
            }, 0);
          }
        }
      }

      // get latest data
      const latestSection = document.getElementById("latest");

      for (let item of latestSection.querySelectorAll("section[id]")) {
        updateSectionById(item.getAttribute("id"));
      }

      if ("IntersectionObserver" in window) {
        window.hackerNewsState = { index: [], nextTimeIndex: -1 };

        const addNewsItem = async (newsItem, queue) => {
          try {
            const { date, time, itemComments, itemTitle, itemLink } = newsItem;
            const section = await buildNextItem({
              document,
              dateTime: `${date}, ${time}`,
              itemComments,
              itemLink,
              itemTitle: new DOMParser().parseFromString(
                itemTitle.replace(/\\/g, ""),
                "text/html"
              ).documentElement.textContent,
              fetchItemDetails: false,
            });

            // display loading indicator for section
            section.querySelector(".points-container").innerHTML =
              'Points: <span class="points"><img style="height: 100%;" src="lib/images/loading.svg" /></span>';

            const id = section.getAttribute("id");
            if (!document.getElementById(id)) {
              document.getElementById("latest").appendChild(section);

              queue.addItemById(id);
            }
          } catch (error) {}
        };

        const buildArchiveIndex = async (lastDateTime) => {
          const nextDate = lastDateTime.slice(0, 10);
          const nextYear = nextDate.slice(0, 4);

          return (
            await (
              await fetch(
                `https://raw.githubusercontent.com/kherrick/hacker-news/main/archives/${nextYear}/${nextDate}/index.md`
              )
            ).text()
          )
            .split("\n")
            .filter((line) => line.match(new RegExp("^\\* \\[")))
            .map((line) => {
              const segment = line.replace("* ", "").split("](");
              const pubDate = segment[0].slice(1);

              const itemComments = segment[1].split(") - [")[0];
              const itemTitle = segment[1].split(") - [")[1];
              const itemLink = segment[2].slice(0, -1);
              const date = pubDate.slice(0, 10);
              const time = pubDate.slice(-8);

              return {
                date,
                itemComments,
                itemLink,
                itemTitle,
                time,
              };
            });
        };

        const handleIntersectingEntry = async (entry, queue) => {
          if (entry.isIntersecting) {
            const lastDateTime = document
              .getElementById("latest")
              .querySelector(
                "section:last-child > section > h4 > span"
              ).textContent;

            const nextDateTime = getNextDateTime(lastDateTime ?? "", -1);
            const archiveIndex = await buildArchiveIndex(nextDateTime);
            const nextTimeIndex = archiveIndex.findIndex(
              ({ time }) => time === nextDateTime.slice(-8)
            );

            const handleIndexUpdate = (index, existingIndexValues = []) => {
              index.forEach((i) => {
                existingIndexValues.push(i);
              });
              return existingIndexValues;
            };

            window.hackerNewsState = {
              index: handleIndexUpdate(
                archiveIndex,
                window.hackerNewsState.index
              ),
              nextTimeIndex,
            };

            let currentTimeIndex = nextTimeIndex + 1;
            const items = Object.values(window.hackerNewsState.index);
            for (let item of items) {
              if (currentTimeIndex < window.hackerNewsState.index.length) {
                addNewsItem(items[currentTimeIndex], queue);

                currentTimeIndex = currentTimeIndex + 1;
              }
            }

            queue.flush();
          }
        };

        const archives = document.getElementById("archives");
        const archivesObserver = new IntersectionObserver(
          (entries) => {
            const queue = new UpdateQueue();

            entries.forEach((entry) => handleIntersectingEntry(entry, queue));
          },
          {
            root: null,
            rootMargin: "0px",
            threshold: 0,
          }
        );

        archivesObserver.observe(archives);

        let latestSectionsExpanded = true;
        const handleLatestHeaderClick = () => {
          latestSectionsExpanded = !latestSectionsExpanded;

          if (latestSectionsExpanded) {
            archivesObserver.observe(archives);
          } else {
            archivesObserver.disconnect(archives);
          }

          for (let section of document.querySelectorAll("#latest > section")) {
            section.style.display = latestSectionsExpanded ? "block" : "none";
          }
        };

        const latestHeader = document.querySelector("#latest > h2");
        latestHeader.style.cursor = "pointer";
        latestHeader.addEventListener("click", handleLatestHeaderClick);
      }
    </script>
    <script type="module">
      import { Workbox } from "https://storage.googleapis.com/workbox-cdn/releases/6.4.1/workbox-window.prod.mjs";

      if ("serviceWorker" in navigator) {
        const base = document.querySelector("base");
        const serviceWorkerPath = `${
          base ? base.href.replace(/\/$/, "") : ""
        }/service-worker.js`;

        const wb = new Workbox(serviceWorkerPath);

        // setup event listeners
        wb.addEventListener("waiting", (event) => {
          wb.addEventListener("controlling", () => {
            window.location.reload();
          });

          wb.messageSkipWaiting();
        });

        wb.register();
      }
    </script>
  </body>
</html>
