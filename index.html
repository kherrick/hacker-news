<!DOCTYPE html>
<html lang="en" xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta charset="utf-8" />
    <meta
      content="width=device-width, initial-scale=1.0, viewport-fit=cover"
      name="viewport"
    />
    <meta name="description" content="Hacker News" />
    <meta name="theme-color" content="#fff" />
    <title>Hacker News</title>
    <link rel="manifest" href="manifest.json" />
    <link
      href="data:image/x-icon;base64,AAABAAEAAQECAAEAAQA4AAAAFgAAACgAAAABAAAAAgAAAAEAAQAAAAAAAAAAAAAAAAAAAAAAAAAAAAABAAEAAQECAAEAAQA4AAAAFgAAACgAAAABAAAAAgAAAAEAAQAAAAAAAAAAAAAAAAAAAAAAAAAA"
      rel="icon"
      type="image/x-icon"
    />
    <link
      href="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAgAAAAIAAQMAAADOtka5AAAAA1BMVEUAAACnej3aAAAANklEQVR42u3BAQEAAACCIP+vbkhAAQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAB8G4IAAAFjdVCkAAAAAElFTkSuQmCC"
      rel="apple-touch-icon"
    />
    <style>
      /*<!--*/
      body {
        color: rgb(25, 25, 25);
        font-family: Verdana, Geneva, sans-serif;
        margin: 0;
      }

      a {
        text-decoration: none;
      }

      a:link,
      a:focus,
      a:hover,
      a:active {
        color: rgb(75, 75, 125);
      }

      a:visited {
        color: rgb(25, 25, 25);
      }

      h1 > a,
      h1 > a:link,
      h1 > a:focus,
      h1 > a:hover,
      h1 > a:active,
      h1 > a:visited,
      h2 > a,
      h2 > a:link,
      h2 > a:focus,
      h2 > a:hover,
      h2 > a:active,
      h2 > a:visited {
        color: rgb(25, 25, 25);
      }

      h1 {
        background-color: rgb(255, 102, 0);
        margin: 0;
        padding: 1rem;
      }

      h2 {
        background-color: rgb(200, 200, 200);
        margin: 1rem 0;
        padding: 0.5rem 0.5rem 0.5rem 1rem;
      }

      #latest > section,
      #archives > section {
        margin: 0 1rem 1rem 1rem;
        padding-bottom: 1rem;
      }

      #latest > section:not(:last-child),
      #archives > section:not(:last-child) {
        border-bottom: 1px dotted rgb(200, 200, 200);
      }

      section > h3 {
        margin: 0 0 0.5rem 0;
      }

      section > h4 {
        font-weight: normal;
        margin: 0 0 0 1rem;
      }

      .descendants-container,
      .points-container {
        align-items: center;
        border-left: 1px solid #333;
        display: inline-flex;
        margin-left: 0.5rem;
        padding-left: 0.5rem;
        text-align: center;
      }

      .points {
        align-items: center;
        display: inline-flex;
        height: 1rem;
        margin-left: 1ch;
        min-width: 3ch;
      }

      .text {
        line-height: 1.5rem;
        margin: 1rem 1rem 0 1rem;
        overflow: auto;
      }

      .text > p:first-child {
        margin-top: 1rem;
      }

      .text > p:last-child {
        margin-bottom: 0;
      }
      /*-->*/
    </style>
  </head>

  <body>
    <main>
      <h1><a href="https://kherrick.github.io/hacker-news/">Hacker News</a></h1>
      <section id="latest">
        <h2>Latest</h2>
        <section id="38334703">
          <h3>
            <a
              class="item"
              href="https://www.who.int/news-room/fact-sheets/detail/physical-activity"
              >WHO â€“ Physical Activity</a
            >
          </h3>
          <section>
            <h4>
              <span>2023-11-19 @ 17:06:12</span
              ><span class="points-container"
                >Points: <span class="points">13</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=38334703"
                  >Comments</a
                ><span class="descendants">: 2</span></span
              >
            </h4>
          </section>
        </section>
        <section id="38334647">
          <h3>
            <a class="item" href="https://news.ycombinator.com/item?id=38334647"
              >GoGoGrandparent (YC S16) is hiring a senior/staff back
              end/full-stack engineer</a
            >
          </h3>
          <section>
            <h4>
              <span>2023-11-19 @ 17:02:09</span
              ><span class="points-container"
                >Points: <span class="points">1</span></span
              >
            </h4>
            <div class="text">
              <p>
                The position: FULLY REMOTE | Full-time | US, UK, or able to work
                4+ hours overlap with mainland US (UK time working hours also
                OK) | $100k to $120k
              </p>
              <p>
                Build high-quality, robust engineering at the rarest of things -
                a Silicon Valley startup that is both wholesome AND profitable.
                We have 8-figure revenue, are YC-backed, and growing fast.
              </p>
              <p>
                Tech stack (<i>required): Back-end heavy (Node</i>, Typescript<i
                  >, MySQL</i
                >, REST*+GraphQL), front-end (Vue), deploy (AWS, Docker/K8s)
              </p>
              <p>
                Minimum 6 years experience (mostly Node). If full-stack, you
                must be strongest on the backend.
              </p>
              <p>2-stage interview process.</p>
              <p>
                If you want to help older adults and people with disabilities,
                send your LinkedIn/CV to william@gogograndparent.com (keep it
                brief) or apply at
                <a
                  href="https://www.ycombinator.com/companies/gogograndparent/jobs"
                  >https://www.ycombinator.com/companies/gogograndparent/jobs</a
                >
              </p>
            </div>
          </section>
        </section>
        <section id="38334130">
          <h3>
            <a
              class="item"
              href="https://www.nutraingredients.com/Article/2023/11/17/french-authorities-label-vitamin-d-as-endocrine-disruptor"
              >French authorities label Vitamin D as endocrine disruptor</a
            >
          </h3>
          <section>
            <h4>
              <span>2023-11-19 @ 16:25:23</span
              ><span class="points-container"
                >Points: <span class="points">61</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=38334130"
                  >Comments</a
                ><span class="descendants">: 49</span></span
              >
            </h4>
          </section>
        </section>
        <section id="38334126">
          <h3>
            <a
              class="item"
              href="https://www.washingtonpost.com/business/2023/11/19/companies-lobbyists-fight-junk-fees/"
              >From airlines to ticket sellers, companies fight U.S. to keep
              junk fees</a
            >
          </h3>
          <section>
            <h4>
              <span>2023-11-19 @ 16:25:06</span
              ><span class="points-container"
                >Points: <span class="points">40</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=38334126"
                  >Comments</a
                ><span class="descendants">: 18</span></span
              >
            </h4>
          </section>
        </section>
        <section id="38334102">
          <h3>
            <a
              class="item"
              href="https://shavingtheyak.com/2023/10/28/hashicorps-terraform-cloud-rum-pricing-sticker-shock/"
              >Terraform Cloud Pricing Changes Sticker Shock</a
            >
          </h3>
          <section>
            <h4>
              <span>2023-11-19 @ 16:23:27</span
              ><span class="points-container"
                >Points: <span class="points">84</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=38334102"
                  >Comments</a
                ><span class="descendants">: 41</span></span
              >
            </h4>
          </section>
        </section>
        <section id="38334084">
          <h3>
            <a
              class="item"
              href="https://shavingtheyak.com/2023/10/25/wfh-part1/"
              >I will always prefer to work from home</a
            >
          </h3>
          <section>
            <h4>
              <span>2023-11-19 @ 16:21:48</span
              ><span class="points-container"
                >Points: <span class="points">141</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=38334084"
                  >Comments</a
                ><span class="descendants">: 134</span></span
              >
            </h4>
          </section>
        </section>
        <section id="38333474">
          <h3>
            <a
              class="item"
              href="https://arstechnica.com/gaming/2023/11/the-sad-story-of-cities-skylines-2s-launch-and-how-the-game-hopes-to-get-better/"
              >Cities: Skylines 2's troubled launch, and why simulation games
              are freaking hard</a
            >
          </h3>
          <section>
            <h4>
              <span>2023-11-19 @ 15:24:46</span
              ><span class="points-container"
                >Points: <span class="points">30</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=38333474"
                  >Comments</a
                ><span class="descendants">: 24</span></span
              >
            </h4>
          </section>
        </section>
        <section id="38333271">
          <h3>
            <a
              class="item"
              href="https://journal.paoloamoroso.com/why-i-cancelled-my-replit-subscription"
              >I cancelled my Replit subscription</a
            >
          </h3>
          <section>
            <h4>
              <span>2023-11-19 @ 15:06:21</span
              ><span class="points-container"
                >Points: <span class="points">120</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=38333271"
                  >Comments</a
                ><span class="descendants">: 84</span></span
              >
            </h4>
          </section>
        </section>
        <section id="38333127">
          <h3>
            <a class="item" href="https://news.ycombinator.com/item?id=38333127"
              >Help HN: Google has blocked our entire domain for harmful
              programs</a
            >
          </h3>
          <section>
            <h4>
              <span>2023-11-19 @ 14:50:20</span
              ><span class="points-container"
                >Points: <span class="points">77</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=38333127"
                  >Comments</a
                ><span class="descendants">: 40</span></span
              >
            </h4>
            <div class="text">
              <p>
                start.page is the primary domain for hosting Buffer's link page
                product. Eg: https://buffer.start.page . About 24 hours ago, a
                spammer created a start page which <i>linked to</i> a .rar
                malware file hosted on Google drive. We did not host the file.
                Just carried a link to it.
              </p>
              <p>
                That page was detected during our routine content moderation
                this evening but it had also been reported to Google. We have
                removed the content at this time and submitted the start.page
                domain to Google's review process.
              </p>
              <p>
                In the meantime however, instead of blocking the individual
                subdomain that had linked to the malware, Google has blocked our
                entire domain start.page which means that all valid customers
                are also affected by this. Any customer start page visited on
                desktop/android now shows the scary red screen warning.
              </p>
              <p>
                Reaching out on HN right now to see if there's anyone at all on
                Google who can help expedite the review process so that our
                customers aren't further affected by this.
              </p>
              <p>
                Also, if anyone from Google sees this I can further help by
                sharing information to the linked google drive file. It's
                password protected so I'm guessing that that helps it bypass
                detection.
              </p>
              <p>
                Thanks. Fingers crossed for this since I've never done/had to do
                this before.
              </p>
            </div>
          </section>
        </section>
        <section id="38333116">
          <h3>
            <a
              class="item"
              href="https://blog.miguelgrinberg.com/post/it-s-time-for-a-change-datetime-utcnow-is-now-deprecated"
              >It's time for a change: datetime.utcnow() is now deprecated</a
            >
          </h3>
          <section>
            <h4>
              <span>2023-11-19 @ 14:49:32</span
              ><span class="points-container"
                >Points: <span class="points">120</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=38333116"
                  >Comments</a
                ><span class="descendants">: 144</span></span
              >
            </h4>
          </section>
        </section>
        <section id="38332635">
          <h3>
            <a class="item" href="https://rubjo.github.io/victor-mono/"
              >Victor Mono Typeface</a
            >
          </h3>
          <section>
            <h4>
              <span>2023-11-19 @ 13:53:52</span
              ><span class="points-container"
                >Points: <span class="points">120</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=38332635"
                  >Comments</a
                ><span class="descendants">: 79</span></span
              >
            </h4>
          </section>
        </section>
        <section id="38332364">
          <h3>
            <a
              class="item"
              href="https://solvingprocrastination.com/revenge-bedtime-procrastination/"
              >Revenge Bedtime Procrastination</a
            >
          </h3>
          <section>
            <h4>
              <span>2023-11-19 @ 13:16:03</span
              ><span class="points-container"
                >Points: <span class="points">83</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=38332364"
                  >Comments</a
                ><span class="descendants">: 23</span></span
              >
            </h4>
          </section>
        </section>
        <section id="38332137">
          <h3>
            <a
              class="item"
              href="https://github.blog/2023-10-30-the-architecture-of-todays-llm-applications/"
              >The architecture of today's LLM applications</a
            >
          </h3>
          <section>
            <h4>
              <span>2023-11-19 @ 12:41:37</span
              ><span class="points-container"
                >Points: <span class="points">95</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=38332137"
                  >Comments</a
                ><span class="descendants">: 2</span></span
              >
            </h4>
          </section>
        </section>
        <section id="38331751">
          <h3>
            <a
              class="item"
              href="https://techcrunch.com/2023/11/17/kyutai-is-an-french-ai-research-lab-with-a-330-million-budget-that-will-make-everything-open-source/"
              >Kyutai AI research lab with a $330M budget that will make
              everything open source</a
            >
          </h3>
          <section>
            <h4>
              <span>2023-11-19 @ 11:48:18</span
              ><span class="points-container"
                >Points: <span class="points">184</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=38331751"
                  >Comments</a
                ><span class="descendants">: 63</span></span
              >
            </h4>
          </section>
        </section>
        <section id="38331750">
          <h3>
            <a
              class="item"
              href="https://vsekar.me/blog/log_coffee/chapter_0.html"
              >Lindenmayer Systems</a
            >
          </h3>
          <section>
            <h4>
              <span>2023-11-19 @ 11:47:55</span
              ><span class="points-container"
                >Points: <span class="points">107</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=38331750"
                  >Comments</a
                ><span class="descendants">: 15</span></span
              >
            </h4>
          </section>
        </section>
        <section id="38331669">
          <h3>
            <a class="item" href="https://arxiv.org/abs/2311.09247"
              >Comparing Humans, GPT-4, and GPT-4V on Abstraction and Reasoning
              Tasks</a
            >
          </h3>
          <section>
            <h4>
              <span>2023-11-19 @ 11:36:34</span
              ><span class="points-container"
                >Points: <span class="points">143</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=38331669"
                  >Comments</a
                ><span class="descendants">: 95</span></span
              >
            </h4>
          </section>
        </section>
        <section id="38331501">
          <h3>
            <a class="item" href="https://news.ycombinator.com/item?id=38331501"
              >Ask HN: Any comprehensive courses on Auth?</a
            >
          </h3>
          <section>
            <h4>
              <span>2023-11-19 @ 11:06:21</span
              ><span class="points-container"
                >Points: <span class="points">169</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=38331501"
                  >Comments</a
                ><span class="descendants">: 58</span></span
              >
            </h4>
            <div class="text">
              I would like cover basic username/password auth, OAuth and Active
              Directory, security keys and everything in between. Would like to
              do this in a linear fashion, ie like a coursera course with
              practice problems.
            </div>
          </section>
        </section>
        <section id="38331368">
          <h3>
            <a
              class="item"
              href="https://www.ian-leslie.com/p/the-ruffian-special-edition-book"
              >Rational Ritual: Why everyone needs to know what everyone knows
              (2020)</a
            >
          </h3>
          <section>
            <h4>
              <span>2023-11-19 @ 10:46:25</span
              ><span class="points-container"
                >Points: <span class="points">54</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=38331368"
                  >Comments</a
                ><span class="descendants">: 13</span></span
              >
            </h4>
          </section>
        </section>
        <section id="38331349">
          <h3>
            <a class="item" href="https://zero-k.info/"
              >Zero-k: A libre sci-fi RTS game, with an economy based on metal
              and energy</a
            >
          </h3>
          <section>
            <h4>
              <span>2023-11-19 @ 10:43:09</span
              ><span class="points-container"
                >Points: <span class="points">184</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=38331349"
                  >Comments</a
                ><span class="descendants">: 72</span></span
              >
            </h4>
          </section>
        </section>
        <section id="38331200">
          <h3>
            <a class="item" href="https://fleuret.org/dlc/"
              >Deep Learning Course</a
            >
          </h3>
          <section>
            <h4>
              <span>2023-11-19 @ 10:19:21</span
              ><span class="points-container"
                >Points: <span class="points">300</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=38331200"
                  >Comments</a
                ><span class="descendants">: 23</span></span
              >
            </h4>
          </section>
        </section>
        <section id="38329969">
          <h3>
            <a
              class="item"
              href="https://forum.handbrake.fr/viewtopic.php?t=43311"
              >HandBrake 1.7.0 â€“ The open source video transcoder</a
            >
          </h3>
          <section>
            <h4>
              <span>2023-11-19 @ 07:03:26</span
              ><span class="points-container"
                >Points: <span class="points">310</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=38329969"
                  >Comments</a
                ><span class="descendants">: 66</span></span
              >
            </h4>
          </section>
        </section>
        <section id="38328355">
          <h3>
            <a
              class="item"
              href="https://www.theverge.com/2023/11/18/23966980/meta-disbanded-responsible-ai-team-artificial-intelligence"
              >Meta disbanded its Responsible AI team</a
            >
          </h3>
          <section>
            <h4>
              <span>2023-11-19 @ 03:18:17</span
              ><span class="points-container"
                >Points: <span class="points">349</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=38328355"
                  >Comments</a
                ><span class="descendants">: 308</span></span
              >
            </h4>
          </section>
        </section>
        <section id="38327017">
          <h3>
            <a class="item" href="https://news.ycombinator.com/item?id=38327017"
              >Show HN: YouTube banned adblockers so I built an extension to
              skip their ads</a
            >
          </h3>
          <section>
            <h4>
              <span>2023-11-19 @ 00:54:46</span
              ><span class="points-container"
                >Points: <span class="points">531</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=38327017"
                  >Comments</a
                ><span class="descendants">: 562</span></span
              >
            </h4>
            <div class="text">
              <p>
                Since Youtube no longer allows AdBlockers, I built my own
                extension to get around their video ads. If there is an ad it
                temporarily manipulates the video; Mutes the volume, sets speed
                to 10x, and skips it if there is a button.
              </p>
              <p>
                Chrome Webstore link:
                <a
                  href="https://chromewebstore.google.com/detail/ad-accelerator/gpboiedfklodfhngobidfjecdpmccehg?hl=en"
                  >https://chromewebstore.google.com/detail/ad-accelerator/gpbo...</a
                >
              </p>
              <p>
                Code:
                <a href="https://github.com/rkk3/ad-accelerator"
                  >https://github.com/rkk3/ad-accelerator</a
                >
              </p>
            </div>
          </section>
        </section>
        <section id="38324925">
          <h3>
            <a
              class="item"
              href="https://www.universetoday.com/164299/an-asteroid-will-occult-betelgeuse-on-december-12th/"
              >An asteroid will occult Betelgeuse on December 12th</a
            >
          </h3>
          <section>
            <h4>
              <span>2023-11-18 @ 21:51:37</span
              ><span class="points-container"
                >Points: <span class="points">226</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=38324925"
                  >Comments</a
                ><span class="descendants">: 64</span></span
              >
            </h4>
          </section>
        </section>
        <section id="38321413">
          <h3>
            <a class="item" href="https://frigate.video/"
              >Frigate: Open-source network video recorder with real-time AI
              object detection</a
            >
          </h3>
          <section>
            <h4>
              <span>2023-11-18 @ 16:44:44</span
              ><span class="points-container"
                >Points: <span class="points">546</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=38321413"
                  >Comments</a
                ><span class="descendants">: 123</span></span
              >
            </h4>
          </section>
        </section>
        <section id="38319283">
          <h3>
            <a
              class="item"
              href="https://idlewords.com/talks/deep_fried_data.htm"
              >Deep-Fried Data (2016)</a
            >
          </h3>
          <section>
            <h4>
              <span>2023-11-18 @ 13:24:46</span
              ><span class="points-container"
                >Points: <span class="points">29</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=38319283"
                  >Comments</a
                ><span class="descendants">: 2</span></span
              >
            </h4>
          </section>
        </section>
        <section id="38318434">
          <h3>
            <a
              class="item"
              href="https://www.bbc.com/travel/article/20231116-the-hidden-beauty-of-berlins-indoor-pools"
              >Berlin's indoor pools</a
            >
          </h3>
          <section>
            <h4>
              <span>2023-11-18 @ 11:50:30</span
              ><span class="points-container"
                >Points: <span class="points">241</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=38318434"
                  >Comments</a
                ><span class="descendants">: 196</span></span
              >
            </h4>
          </section>
        </section>
        <section id="38317509">
          <h3>
            <a class="item" href="https://www.volunteer.gov/s/"
              >Volunteer.gov: Discover volunteer opportunities around the
              country</a
            >
          </h3>
          <section>
            <h4>
              <span>2023-11-18 @ 09:50:52</span
              ><span class="points-container"
                >Points: <span class="points">27</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=38317509"
                  >Comments</a
                ><span class="descendants">: 7</span></span
              >
            </h4>
          </section>
        </section>
        <section id="38301721">
          <h3>
            <a
              class="item"
              href="https://www.allthingsdistributed.com/2023/11/standing-on-the-shoulders-of-giants-colm-on-constant-work.html"
              >Colm on Constant Work (2019)</a
            >
          </h3>
          <section>
            <h4>
              <span>2023-11-17 @ 10:35:03</span
              ><span class="points-container"
                >Points: <span class="points">40</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=38301721"
                  >Comments</a
                ><span class="descendants">: 2</span></span
              >
            </h4>
          </section>
        </section>
        <section id="38300189">
          <h3>
            <a class="item" href="https://animatearchive.neocities.org/?home"
              >AnimateArchive (old versions of Adobe Flash)</a
            >
          </h3>
          <section>
            <h4>
              <span>2023-11-17 @ 06:18:19</span
              ><span class="points-container"
                >Points: <span class="points">24</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=38300189"
                  >Comments</a
                ><span class="descendants">: 5</span></span
              >
            </h4>
          </section>
        </section>
      </section>
      <section id="archives">
        <h2>
          <a
            href="https://github.com/kherrick/hacker-news/blob/main/archives/index.md"
            >Archives</a
          >
        </h2>
        <section>
          <h3>
            <a
              href="https://github.com/kherrick/hacker-news/blob/main/archives/2023/index.md"
              >2023</a
            >
          </h3>
        </section>
        <section>
          <h3>
            <a
              href="https://github.com/kherrick/hacker-news/blob/main/archives/2022/index.md"
              >2022</a
            >
          </h3>
        </section>
      </section>
    </main>
    <script type="module">
      import { buildDescendants } from "./lib/build-html-descendants.js";
      import { buildNextItem } from "./lib/build-html-next-item.js";
      import { getNextDateTime } from "./lib/date-time.js";

      const updateSectionById = (id) =>
        fetch(`https://hacker-news.firebaseio.com/v0/item/${id}.json`).then(
          (result) =>
            result.json().then(({ descendants, id, score, text, type }) => {
              const currentItem = document.getElementById(id);

              if (score) {
                currentItem.querySelector(".points").textContent = score;
              }

              if (descendants && (type === "poll" || type === "story")) {
                const currentDescendants =
                  currentItem.querySelector(".descendants");

                if (currentDescendants) {
                  currentDescendants.textContent = `: ${descendants}`;
                } else {
                  const comments = buildDescendants(
                    document,
                    descendants,
                    `https://news.ycombinator.com/item?id=${id}`
                  );

                  currentItem.querySelector("h4").appendChild(comments);
                }
              }

              if (text) {
                const currentText = currentItem.querySelector(".text");

                if (currentText) {
                  currentText.innerHTML = text.replace(/\0/g, "");
                } else {
                  const content = document.createElement("div");
                  content.innerHTML = text.replace(/\0/g, "");
                  content.setAttribute("class", "text");

                  currentItem.appendChild(content);
                }
              }
            })
        );

      class UpdateQueue {
        constructor() {
          this._ids = [];
          this._isUpdating = false;
        }

        addItemById(id) {
          this._ids.push(id);
        }

        async flush() {
          const id = this._ids.shift();

          if (id) {
            this._isUpdating = true;

            await updateSectionById(id);
            await this.flush();
          } else {
            this._isUpdating = false;

            setTimeout(async () => {
              if (!this._isUpdating && this._ids && this._ids.length) {
                await this.flush();
              }
            }, 0);
          }
        }
      }

      // get latest data
      const latestSection = document.getElementById("latest");

      for (let item of latestSection.querySelectorAll("section[id]")) {
        updateSectionById(item.getAttribute("id"));
      }

      if ("IntersectionObserver" in window) {
        window.hackerNewsState = { index: [], nextTimeIndex: -1 };

        const addNewsItem = async (newsItem, queue) => {
          try {
            const { date, time, itemComments, itemTitle, itemLink } = newsItem;
            const section = await buildNextItem({
              document,
              dateTime: `${date}, ${time}`,
              itemComments,
              itemLink,
              itemTitle: new DOMParser().parseFromString(
                itemTitle.replace(/\\/g, ""),
                "text/html"
              ).documentElement.textContent,
              fetchItemDetails: false,
            });

            // display loading indicator for section
            section.querySelector(".points-container").innerHTML =
              'Points: <span class="points"><img style="height: 100%;" src="lib/images/loading.svg" /></span>';

            const id = section.getAttribute("id");
            if (!document.getElementById(id)) {
              document.getElementById("latest").appendChild(section);

              queue.addItemById(id);
            }
          } catch (error) {}
        };

        const buildArchiveIndex = async (lastDateTime) => {
          const nextDate = lastDateTime.slice(0, 10);
          const nextYear = nextDate.slice(0, 4);

          return (
            await (
              await fetch(
                `https://raw.githubusercontent.com/kherrick/hacker-news/main/archives/${nextYear}/${nextDate}/index.md`
              )
            ).text()
          )
            .split("\n")
            .filter((line) => line.match(new RegExp("^\\* \\[")))
            .map((line) => {
              const segment = line.replace("* ", "").split("](");
              const pubDate = segment[0].slice(1);

              const itemComments = segment[1].split(") - [")[0];
              const itemTitle = segment[1].split(") - [")[1];
              const itemLink = segment[2].slice(0, -1);
              const date = pubDate.slice(0, 10);
              const time = pubDate.slice(-8);

              return {
                date,
                itemComments,
                itemLink,
                itemTitle,
                time,
              };
            });
        };

        const handleIntersectingEntry = async (entry, queue) => {
          if (entry.isIntersecting) {
            const lastDateTime = document
              .getElementById("latest")
              .querySelector(
                "section:last-child > section > h4 > span"
              ).textContent;

            const nextDateTime = getNextDateTime(lastDateTime ?? "", -1);
            const archiveIndex = await buildArchiveIndex(nextDateTime);
            const nextTimeIndex = archiveIndex.findIndex(
              ({ time }) => time === nextDateTime.slice(-8)
            );

            const handleIndexUpdate = (index, existingIndexValues = []) => {
              index.forEach((i) => {
                existingIndexValues.push(i);
              });
              return existingIndexValues;
            };

            window.hackerNewsState = {
              index: handleIndexUpdate(
                archiveIndex,
                window.hackerNewsState.index
              ),
              nextTimeIndex,
            };

            let currentTimeIndex = nextTimeIndex + 1;
            const items = Object.values(window.hackerNewsState.index);
            for (let item of items) {
              if (currentTimeIndex < window.hackerNewsState.index.length) {
                addNewsItem(items[currentTimeIndex], queue);

                currentTimeIndex = currentTimeIndex + 1;
              }
            }

            queue.flush();
          }
        };

        const archives = document.getElementById("archives");
        const archivesObserver = new IntersectionObserver(
          (entries) => {
            const queue = new UpdateQueue();

            entries.forEach((entry) => handleIntersectingEntry(entry, queue));
          },
          {
            root: null,
            rootMargin: "0px",
            threshold: 0,
          }
        );

        archivesObserver.observe(archives);

        let latestSectionsExpanded = true;
        const handleLatestHeaderClick = () => {
          latestSectionsExpanded = !latestSectionsExpanded;

          if (latestSectionsExpanded) {
            archivesObserver.observe(archives);
          } else {
            archivesObserver.disconnect(archives);
          }

          for (let section of document.querySelectorAll("#latest > section")) {
            section.style.display = latestSectionsExpanded ? "block" : "none";
          }
        };

        const latestHeader = document.querySelector("#latest > h2");
        latestHeader.style.cursor = "pointer";
        latestHeader.addEventListener("click", handleLatestHeaderClick);
      }
    </script>
    <script type="module">
      import { Workbox } from "https://storage.googleapis.com/workbox-cdn/releases/6.4.1/workbox-window.prod.mjs";

      if ("serviceWorker" in navigator) {
        const base = document.querySelector("base");
        const serviceWorkerPath = `${
          base ? base.href.replace(/\/$/, "") : ""
        }/service-worker.js`;

        const wb = new Workbox(serviceWorkerPath);

        // setup event listeners
        wb.addEventListener("waiting", (event) => {
          wb.addEventListener("controlling", () => {
            window.location.reload();
          });

          wb.messageSkipWaiting();
        });

        wb.register();
      }
    </script>
  </body>
</html>
