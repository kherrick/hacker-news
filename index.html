<!DOCTYPE html>
<html lang="en" xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta charset="utf-8" />
    <meta
      content="width=device-width, initial-scale=1.0, viewport-fit=cover"
      name="viewport"
    />
    <meta name="description" content="Hacker News" />
    <meta name="theme-color" content="#fff" />
    <title>Hacker News</title>
    <link rel="manifest" href="manifest.json" />
    <link
      href="data:image/x-icon;base64,AAABAAEAAQECAAEAAQA4AAAAFgAAACgAAAABAAAAAgAAAAEAAQAAAAAAAAAAAAAAAAAAAAAAAAAAAAABAAEAAQECAAEAAQA4AAAAFgAAACgAAAABAAAAAgAAAAEAAQAAAAAAAAAAAAAAAAAAAAAAAAAA"
      rel="icon"
      type="image/x-icon"
    />
    <link
      href="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAgAAAAIAAQMAAADOtka5AAAAA1BMVEUAAACnej3aAAAANklEQVR42u3BAQEAAACCIP+vbkhAAQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAB8G4IAAAFjdVCkAAAAAElFTkSuQmCC"
      rel="apple-touch-icon"
    />
    <style>
      /*<!--*/
      body {
        color: rgb(25, 25, 25);
        font-family: Verdana, Geneva, sans-serif;
        margin: 0;
      }

      a {
        text-decoration: none;
      }

      a:link,
      a:focus,
      a:hover,
      a:active {
        color: rgb(75, 75, 125);
      }

      a:visited {
        color: rgb(25, 25, 25);
      }

      h1 > a,
      h1 > a:link,
      h1 > a:focus,
      h1 > a:hover,
      h1 > a:active,
      h1 > a:visited,
      h2 > a,
      h2 > a:link,
      h2 > a:focus,
      h2 > a:hover,
      h2 > a:active,
      h2 > a:visited {
        color: rgb(25, 25, 25);
      }

      h1 {
        background-color: rgb(255, 102, 0);
        margin: 0;
        padding: 1rem;
      }

      h2 {
        background-color: rgb(200, 200, 200);
        margin: 1rem 0;
        padding: 0.5rem 0.5rem 0.5rem 1rem;
      }

      #latest > section,
      #archives > section {
        margin: 0 1rem 1rem 1rem;
        padding-bottom: 1rem;
      }

      #latest > section:not(:last-child),
      #archives > section:not(:last-child) {
        border-bottom: 1px dotted rgb(200, 200, 200);
      }

      section > h3 {
        margin: 0 0 0.5rem 0;
      }

      section > h4 {
        font-weight: normal;
        margin: 0 0 0 1rem;
      }

      .descendants-container,
      .points-container {
        align-items: center;
        border-left: 1px solid #333;
        display: inline-flex;
        margin-left: 0.5rem;
        padding-left: 0.5rem;
        text-align: center;
      }

      .points {
        align-items: center;
        display: inline-flex;
        height: 1rem;
        margin-left: 1ch;
        min-width: 3ch;
      }

      .text {
        line-height: 1.5rem;
        margin: 1rem 1rem 0 1rem;
        overflow: auto;
      }

      .text > p:first-child {
        margin-top: 1rem;
      }

      .text > p:last-child {
        margin-bottom: 0;
      }
      /*-->*/
    </style>
  </head>

  <body>
    <main>
      <h1><a href="https://kherrick.github.io/hacker-news/">Hacker News</a></h1>
      <section id="latest">
        <h2>Latest</h2>
        <section id="43733636">
          <h3>
            <a
              class="item"
              href="https://github.com/matthewp/views-the-hard-way"
              >JavaScript Views, the Hard Way – A Pattern for Writing UI</a
            >
          </h3>
          <section>
            <h4>
              <span>2025-04-19 @ 02:10:52</span
              ><span class="points-container"
                >Points: <span class="points">40</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=43733636"
                  >Comments</a
                ><span class="descendants">: 14</span></span
              >
            </h4>
          </section>
        </section>
        <section id="43733553">
          <h3>
            <a
              class="item"
              href="https://github.com/HandsOnLLM/Hands-On-Large-Language-Models"
              >Hands-On Large Language Models</a
            >
          </h3>
          <section>
            <h4>
              <span>2025-04-19 @ 01:52:55</span
              ><span class="points-container"
                >Points: <span class="points">49</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=43733553"
                  >Comments</a
                ><span class="descendants">: 2</span></span
              >
            </h4>
          </section>
        </section>
        <section id="43733463">
          <h3>
            <a class="item" href="https://ieeexplore.ieee.org/document/1671509"
              >System Design of a Cellular APL Computer</a
            >
          </h3>
          <section>
            <h4>
              <span>2025-04-19 @ 01:33:56</span
              ><span class="points-container"
                >Points: <span class="points">15</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=43733463"
                  >Comments</a
                ><span class="descendants">: 2</span></span
              >
            </h4>
          </section>
        </section>
        <section id="43733097">
          <h3>
            <a
              class="item"
              href="https://www.reuters.com/business/retail-consumer/cozy-video-games-can-quell-stress-anxiety-2025-01-27/"
              >Cozy video games can quell stress and anxiety</a
            >
          </h3>
          <section>
            <h4>
              <span>2025-04-19 @ 00:21:13</span
              ><span class="points-container"
                >Points: <span class="points">270</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=43733097"
                  >Comments</a
                ><span class="descendants">: 149</span></span
              >
            </h4>
          </section>
        </section>
        <section id="43732805">
          <h3><a class="item" href="https://hypertext.tv/">Hypertext TV</a></h3>
          <section>
            <h4>
              <span>2025-04-18 @ 23:29:04</span
              ><span class="points-container"
                >Points: <span class="points">121</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=43732805"
                  >Comments</a
                ><span class="descendants">: 9</span></span
              >
            </h4>
          </section>
        </section>
        <section id="43731746">
          <h3>
            <a class="item" href="https://www.playhextraction.com/"
              >Hextraction, a free and open source board game</a
            >
          </h3>
          <section>
            <h4>
              <span>2025-04-18 @ 20:50:18</span
              ><span class="points-container"
                >Points: <span class="points">54</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=43731746"
                  >Comments</a
                ><span class="descendants">: 11</span></span
              >
            </h4>
          </section>
        </section>
        <section id="43731552">
          <h3>
            <a class="item" href="https://www.judyrecords.com/"
              >Full Text Search of US Court records</a
            >
          </h3>
          <section>
            <h4>
              <span>2025-04-18 @ 20:24:09</span
              ><span class="points-container"
                >Points: <span class="points">242</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=43731552"
                  >Comments</a
                ><span class="descendants">: 45</span></span
              >
            </h4>
          </section>
        </section>
        <section id="43731250">
          <h3>
            <a
              class="item"
              href="https://github.com/takaakit/uml-diagram-for-ddd-example-in-evans-book"
              >UML diagram for the DDD example in Evans' book</a
            >
          </h3>
          <section>
            <h4>
              <span>2025-04-18 @ 19:40:06</span
              ><span class="points-container"
                >Points: <span class="points">78</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=43731250"
                  >Comments</a
                ><span class="descendants">: 40</span></span
              >
            </h4>
            <div class="text">
              This project uses UML diagrams to illustrate the structure and
              behavior of the DDD example—a cargo shipping system—from Eric
              Evans' book (Domain-Driven Design: Tackling Complexity in the
              Heart of Software).
            </div>
          </section>
        </section>
        <section id="43731165">
          <h3>
            <a
              class="item"
              href="https://jonathan.protzenko.fr/2025/04/18/python.html"
              >15,000 lines of verified cryptography now in Python</a
            >
          </h3>
          <section>
            <h4>
              <span>2025-04-18 @ 19:28:44</span
              ><span class="points-container"
                >Points: <span class="points">304</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=43731165"
                  >Comments</a
                ><span class="descendants">: 78</span></span
              >
            </h4>
          </section>
        </section>
        <section id="43730885">
          <h3>
            <a
              class="item"
              href="https://lem12.uksw.edu.pl/wiki/Loglan%2782_project"
              >Loglan'82: programming language for object-oriented and
              distributed programming</a
            >
          </h3>
          <section>
            <h4>
              <span>2025-04-18 @ 18:55:24</span
              ><span class="points-container"
                >Points: <span class="points">37</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=43730885"
                  >Comments</a
                ><span class="descendants">: 5</span></span
              >
            </h4>
          </section>
        </section>
        <section id="43730870">
          <h3>
            <a class="item" href="https://github.com/wmcbrine/PDCurses"
              >PDCurses – for environments that don't fit the termcap/terminfo
              model</a
            >
          </h3>
          <section>
            <h4>
              <span>2025-04-18 @ 18:52:58</span
              ><span class="points-container"
                >Points: <span class="points">26</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=43730870"
                  >Comments</a
                ><span class="descendants">: 1</span></span
              >
            </h4>
          </section>
        </section>
        <section id="43730866">
          <h3>
            <a class="item" href="https://archivebox.github.io/good-karma-kit/"
              >The Good Karma Kit</a
            >
          </h3>
          <section>
            <h4>
              <span>2025-04-18 @ 18:52:40</span
              ><span class="points-container"
                >Points: <span class="points">41</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=43730866"
                  >Comments</a
                ><span class="descendants">: 13</span></span
              >
            </h4>
          </section>
        </section>
        <section id="43730701">
          <h3>
            <a
              class="item"
              href="https://www.noemamag.com/theres-life-inside-earths-crust/"
              >There's Life Inside Earth's Crust</a
            >
          </h3>
          <section>
            <h4>
              <span>2025-04-18 @ 18:35:05</span
              ><span class="points-container"
                >Points: <span class="points">84</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=43730701"
                  >Comments</a
                ><span class="descendants">: 28</span></span
              >
            </h4>
          </section>
        </section>
        <section id="43730545">
          <h3>
            <a
              class="item"
              href="https://www.404media.co/judge-rules-blanket-search-of-cell-tower-data-unconstitutional/"
              >Judge Rules Blanket Search of Cell Tower Data Unconstitutional</a
            >
          </h3>
          <section>
            <h4>
              <span>2025-04-18 @ 18:16:27</span
              ><span class="points-container"
                >Points: <span class="points">369</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=43730545"
                  >Comments</a
                ><span class="descendants">: 147</span></span
              >
            </h4>
          </section>
        </section>
        <section id="43730458">
          <h3>
            <a
              class="item"
              href="https://github.com/ncruces/go-sqlite3/tree/main/sqlite3/libc"
              >Show HN: (bits) of a Libc, Optimized for Wasm</a
            >
          </h3>
          <section>
            <h4>
              <span>2025-04-18 @ 18:06:25</span
              ><span class="points-container"
                >Points: <span class="points">63</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=43730458"
                  >Comments</a
                ><span class="descendants">: 11</span></span
              >
            </h4>
            <div class="text">
              <p>
                To compile SQLite, I use wasi-sdk, which uses wasi-libc, which
                is based on musl. It's been said that musl is slow(er than
                glibc), which is true, to a point.
              </p>
              <p>
                musl uses SWAR on a size_t to implement various functions in
                string.h. This is fine, except size_t is just 32-bit on Wasm.
              </p>
              <p>
                I found that implementing a few of those functions with Wasm
                SIMD128 can make them go around 4x faster.
              </p>
              <p>
                Other functions don't even use SWAR; redoing <i>those</i> can
                make them 16x faster.
              </p>
              <p>
                Smooth sort also has trouble pulling its own weight; a Shell
                sort seems both simpler and faster, while similarly avoiding
                recursion, allocations and the addressable stack.
              </p>
              <p>
                I found that using SIMD intrinsics (rather than SWAR) makes it
                easier to avoid UB, but the code would definitely benefit from
                more eyeballs.
              </p>
              <p>
                See this for some benchmarks on both x86-64 and Aarch64:
                <a
                  href="https://github.com/ncruces/go-sqlite3/actions/runs/14516931864"
                  >https://github.com/ncruces/go-sqlite3/actions/runs/145169318...</a
                >
              </p>
            </div>
          </section>
        </section>
        <section id="43729932">
          <h3>
            <a
              class="item"
              href="https://www.inkandswitch.com/ink/notes/phase-2-constraint-system/"
              >Ink and Switch Constraint System (2023)</a
            >
          </h3>
          <section>
            <h4>
              <span>2025-04-18 @ 17:09:53</span
              ><span class="points-container"
                >Points: <span class="points">80</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=43729932"
                  >Comments</a
                ><span class="descendants">: 11</span></span
              >
            </h4>
          </section>
        </section>
        <section id="43729850">
          <h3>
            <a
              class="item"
              href="https://www.ycombinator.com/companies/dot/jobs/XSmklFa-customer-success-sales-engineer-remote"
              >Dot (YC S21) is hiring a sales engineer to automate analytics
              (fully remote)</a
            >
          </h3>
          <section>
            <h4>
              <span>2025-04-18 @ 17:00:27</span
              ><span class="points-container"
                >Points: <span class="points">1</span></span
              >
            </h4>
          </section>
        </section>
        <section id="43729683">
          <h3>
            <a class="item" href="https://github.com/Kuberwastaken/backdooms"
              >Show HN: I made a Doom-like game fit inside a QR code</a
            >
          </h3>
          <section>
            <h4>
              <span>2025-04-18 @ 16:40:25</span
              ><span class="points-container"
                >Points: <span class="points">374</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=43729683"
                  >Comments</a
                ><span class="descendants">: 102</span></span
              >
            </h4>
          </section>
        </section>
        <section id="43729427">
          <h3>
            <a class="item" href="https://github.com/attunehq/attune"
              >Show HN: Attune - Build and publish APT repositories in
              seconds</a
            >
          </h3>
          <section>
            <h4>
              <span>2025-04-18 @ 16:14:18</span
              ><span class="points-container"
                >Points: <span class="points">79</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=43729427"
                  >Comments</a
                ><span class="descendants">: 27</span></span
              >
            </h4>
            <div class="text">
              <p>
                Previously, we worked at other startups building open source
                developer tools that ran on our customers’ CI and development
                machines. For many of them, being able to `apt-get install` our
                tools was a requirement.
              </p>
              <p>
                When we went to actually set up APT repositories, we were really
                surprised by the state of tooling around package publishing. The
                open source tools we found were old, slow, and difficult to
                figure out how to run in CI. The commercial tools we found were
                not much better. The cloud-hosted vendors required us to provide
                our signing keys to a cloud vendor (which was a non-starter),
                while the self-hosted vendors required us to operate our own
                specialized hosting servers.
              </p>
              <p>
                We just wanted something simple: sign locally, run quickly, be
                easy to use, and deploy to managed object storage.
              </p>
              <p>
                We couldn’t find it, so we built it. If you want to try it out,
                you can create a repository with three commands:
              </p>
              <p></p>
              <pre><code>    attune repo create --uri https://apt.releases.example.com
    attune repo pkg add --repo-id 123 package.deb
    attune repo sync --repo-id 123
</code></pre>
              You can get the tool at
              <a href="https://github.com/attunehq/attune"
                >https://github.com/attunehq/attune</a
              >. There are a lot of rough edges right now since it's so new -
              sorry in advance, we're working on sanding those down.
              <p>
                It’s fully open source under Apache 2. We’re also working with
                some early customers to build enterprise features like audit
                logging, RBAC, and HSM integrations, and we’re thinking about
                building a managed cloud hosting service as well.
              </p>
              <p>
                We’d love your feedback on whether this is useful for you, and
                what you’d like to see next. We’re well aware that publishing is
                a small piece of CI/CD, but we think a lot of the tooling in
                this area (publishing, artifact registries, package
                repositories) could really use some love.
              </p>
              <p>
                What do you think? Comment here, or email us at
                founders@attunehq.com.
              </p>
            </div>
          </section>
        </section>
        <section id="43728279">
          <h3>
            <a
              class="item"
              href="https://blog.trailofbits.com/2025/04/18/sneak-peek-a-new-asn.1-api-for-python/"
              >A New ASN.1 API for Python</a
            >
          </h3>
          <section>
            <h4>
              <span>2025-04-18 @ 14:11:40</span
              ><span class="points-container"
                >Points: <span class="points">149</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=43728279"
                  >Comments</a
                ><span class="descendants">: 68</span></span
              >
            </h4>
          </section>
        </section>
        <section id="43726051">
          <h3>
            <a class="item" href="https://defold.com"
              >Defold: cross-platform game engine</a
            >
          </h3>
          <section>
            <h4>
              <span>2025-04-18 @ 08:15:20</span
              ><span class="points-container"
                >Points: <span class="points">348</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=43726051"
                  >Comments</a
                ><span class="descendants">: 145</span></span
              >
            </h4>
          </section>
        </section>
        <section id="43710996">
          <h3>
            <a
              class="item"
              href="https://www.sfchronicle.com/projects/2025/hospitals-surgical-objects-patients/"
              >Sponges, drill bits and wires: Surgeons mistakenly left objects
              inside thousands</a
            >
          </h3>
          <section>
            <h4>
              <span>2025-04-16 @ 22:20:41</span
              ><span class="points-container"
                >Points: <span class="points">25</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=43710996"
                  >Comments</a
                ><span class="descendants">: 12</span></span
              >
            </h4>
          </section>
        </section>
        <section id="43708841">
          <h3>
            <a
              class="item"
              href="https://plentyofroom.beehiiv.com/p/antivenoms-with-ai-designed-proteins"
              >AI-Designed Antivenoms: New Proteins to Block Deadly Snake
              Toxins</a
            >
          </h3>
          <section>
            <h4>
              <span>2025-04-16 @ 18:36:29</span
              ><span class="points-container"
                >Points: <span class="points">12</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=43708841"
                  >Comments</a
                ><span class="descendants">: 1</span></span
              >
            </h4>
          </section>
        </section>
        <section id="43707372">
          <h3>
            <a
              class="item"
              href="https://edgebit.io/blog/automated-dependency-updates-with-ai/"
              >Principles for Building One-Shot AI Agents</a
            >
          </h3>
          <section>
            <h4>
              <span>2025-04-16 @ 16:30:53</span
              ><span class="points-container"
                >Points: <span class="points">72</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=43707372"
                  >Comments</a
                ><span class="descendants">: 17</span></span
              >
            </h4>
          </section>
        </section>
        <section id="43706247">
          <h3>
            <a
              class="item"
              href="https://www.sciencedaily.com/releases/2025/04/250415183433.htm"
              >Jupiter, it's mushballs all the way down</a
            >
          </h3>
          <section>
            <h4>
              <span>2025-04-16 @ 14:46:47</span
              ><span class="points-container"
                >Points: <span class="points">45</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=43706247"
                  >Comments</a
                ><span class="descendants">: 9</span></span
              >
            </h4>
          </section>
        </section>
        <section id="43698522">
          <h3>
            <a class="item" href="https://www.onemetre.net/Design/Design.htm"
              >How a yacht works: sailboat physics and design</a
            >
          </h3>
          <section>
            <h4>
              <span>2025-04-15 @ 21:19:33</span
              ><span class="points-container"
                >Points: <span class="points">188</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=43698522"
                  >Comments</a
                ><span class="descendants">: 62</span></span
              >
            </h4>
          </section>
        </section>
        <section id="43698327">
          <h3>
            <a
              class="item"
              href="https://culture.pl/en/article/cyberpunk-1958-the-early-days-of-the-polish-it-industry"
              >Cyberpunk 1958: The Early Days of the Polish IT Industry</a
            >
          </h3>
          <section>
            <h4>
              <span>2025-04-15 @ 21:01:02</span
              ><span class="points-container"
                >Points: <span class="points">120</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=43698327"
                  >Comments</a
                ><span class="descendants">: 10</span></span
              >
            </h4>
          </section>
        </section>
        <section id="43692878">
          <h3>
            <a
              class="item"
              href="https://www.whoi.edu/know-your-ocean/ocean-topics/climate-weather/ocean-based-climate-solutions/iron-fertilization/"
              >Ocean Iron Fertilization</a
            >
          </h3>
          <section>
            <h4>
              <span>2025-04-15 @ 14:05:42</span
              ><span class="points-container"
                >Points: <span class="points">35</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=43692878"
                  >Comments</a
                ><span class="descendants">: 19</span></span
              >
            </h4>
          </section>
        </section>
        <section id="43691020">
          <h3>
            <a
              class="item"
              href="https://pikuma.com/blog/origins-of-vim-text-editor"
              >Understanding the Origins and the Evolution of Vi and Vim</a
            >
          </h3>
          <section>
            <h4>
              <span>2025-04-15 @ 10:33:02</span
              ><span class="points-container"
                >Points: <span class="points">155</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=43691020"
                  >Comments</a
                ><span class="descendants">: 54</span></span
              >
            </h4>
          </section>
        </section>
        <section id="43687583">
          <h3>
            <a class="item" href="https://www.howequipmentworks.com/apollo_13/"
              >The most famous carbon dioxide absorber</a
            >
          </h3>
          <section>
            <h4>
              <span>2025-04-14 @ 23:56:34</span
              ><span class="points-container"
                >Points: <span class="points">135</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=43687583"
                  >Comments</a
                ><span class="descendants">: 47</span></span
              >
            </h4>
          </section>
        </section>
      </section>
      <section id="archives">
        <h2>
          <a
            href="https://github.com/kherrick/hacker-news/blob/main/archives/index.md"
            >Archives</a
          >
        </h2>
        <section>
          <h3>
            <a
              href="https://github.com/kherrick/hacker-news/blob/main/archives/2025/index.md"
              >2025</a
            >
          </h3>
        </section>
        <section>
          <h3>
            <a
              href="https://github.com/kherrick/hacker-news/blob/main/archives/2024/index.md"
              >2024</a
            >
          </h3>
        </section>
        <section>
          <h3>
            <a
              href="https://github.com/kherrick/hacker-news/blob/main/archives/2023/index.md"
              >2023</a
            >
          </h3>
        </section>
        <section>
          <h3>
            <a
              href="https://github.com/kherrick/hacker-news/blob/main/archives/2022/index.md"
              >2022</a
            >
          </h3>
        </section>
      </section>
    </main>
    <script type="module">
      import { buildDescendants } from "./lib/build-html-descendants.js";
      import { buildNextItem } from "./lib/build-html-next-item.js";
      import { getNextDateTime } from "./lib/date-time.js";

      const updateSectionById = (id) =>
        fetch(`https://hacker-news.firebaseio.com/v0/item/${id}.json`).then(
          (result) =>
            result.json().then(({ descendants, id, score, text, type }) => {
              const currentItem = document.getElementById(id);

              if (score) {
                currentItem.querySelector(".points").textContent = score;
              }

              if (descendants && (type === "poll" || type === "story")) {
                const currentDescendants =
                  currentItem.querySelector(".descendants");

                if (currentDescendants) {
                  currentDescendants.textContent = `: ${descendants}`;
                } else {
                  const comments = buildDescendants(
                    document,
                    descendants,
                    `https://news.ycombinator.com/item?id=${id}`
                  );

                  currentItem.querySelector("h4").appendChild(comments);
                }
              }

              if (text) {
                const currentText = currentItem.querySelector(".text");

                if (currentText) {
                  currentText.innerHTML = text.replace(/\0/g, "");
                } else {
                  const content = document.createElement("div");
                  content.innerHTML = text.replace(/\0/g, "");
                  content.setAttribute("class", "text");

                  currentItem.appendChild(content);
                }
              }
            })
        );

      class UpdateQueue {
        constructor() {
          this._ids = [];
          this._isUpdating = false;
        }

        addItemById(id) {
          this._ids.push(id);
        }

        async flush() {
          const id = this._ids.shift();

          if (id) {
            this._isUpdating = true;

            await updateSectionById(id);
            await this.flush();
          } else {
            this._isUpdating = false;

            setTimeout(async () => {
              if (!this._isUpdating && this._ids && this._ids.length) {
                await this.flush();
              }
            }, 0);
          }
        }
      }

      // get latest data
      const latestSection = document.getElementById("latest");

      for (let item of latestSection.querySelectorAll("section[id]")) {
        updateSectionById(item.getAttribute("id"));
      }

      if ("IntersectionObserver" in window) {
        window.hackerNewsState = { index: [], nextTimeIndex: -1 };

        const addNewsItem = async (newsItem, queue) => {
          try {
            const { date, time, itemComments, itemTitle, itemLink } = newsItem;
            const section = await buildNextItem({
              document,
              dateTime: `${date}, ${time}`,
              itemComments,
              itemLink,
              itemTitle: new DOMParser().parseFromString(
                itemTitle.replace(/\\/g, ""),
                "text/html"
              ).documentElement.textContent,
              fetchItemDetails: false,
            });

            // display loading indicator for section
            section.querySelector(".points-container").innerHTML =
              'Points: <span class="points"><img style="height: 100%;" src="lib/images/loading.svg" /></span>';

            const id = section.getAttribute("id");
            if (!document.getElementById(id)) {
              document.getElementById("latest").appendChild(section);

              queue.addItemById(id);
            }
          } catch (error) {}
        };

        const buildArchiveIndex = async (lastDateTime) => {
          const nextDate = lastDateTime.slice(0, 10);
          const nextYear = nextDate.slice(0, 4);

          return (
            await (
              await fetch(
                `https://raw.githubusercontent.com/kherrick/hacker-news/main/archives/${nextYear}/${nextDate}/index.md`
              )
            ).text()
          )
            .split("\n")
            .filter((line) => line.match(new RegExp("^\\* \\[")))
            .map((line) => {
              const segment = line.replace("* ", "").split("](");
              const pubDate = segment[0].slice(1);

              const itemComments = segment[1].split(") - [")[0];
              const itemTitle = segment[1].split(") - [")[1];
              const itemLink = segment[2].slice(0, -1);
              const date = pubDate.slice(0, 10);
              const time = pubDate.slice(-8);

              return {
                date,
                itemComments,
                itemLink,
                itemTitle,
                time,
              };
            });
        };

        const handleIntersectingEntry = async (entry, queue) => {
          if (entry.isIntersecting) {
            const lastDateTime = document
              .getElementById("latest")
              .querySelector(
                "section:last-child > section > h4 > span"
              ).textContent;

            const nextDateTime = getNextDateTime(lastDateTime ?? "", -1);
            const archiveIndex = await buildArchiveIndex(nextDateTime);
            const nextTimeIndex = archiveIndex.findIndex(
              ({ time }) => time === nextDateTime.slice(-8)
            );

            const handleIndexUpdate = (index, existingIndexValues = []) => {
              index.forEach((i) => {
                existingIndexValues.push(i);
              });
              return existingIndexValues;
            };

            window.hackerNewsState = {
              index: handleIndexUpdate(
                archiveIndex,
                window.hackerNewsState.index
              ),
              nextTimeIndex,
            };

            let currentTimeIndex = nextTimeIndex + 1;
            const items = Object.values(window.hackerNewsState.index);
            for (let item of items) {
              if (currentTimeIndex < window.hackerNewsState.index.length) {
                addNewsItem(items[currentTimeIndex], queue);

                currentTimeIndex = currentTimeIndex + 1;
              }
            }

            queue.flush();
          }
        };

        const archives = document.getElementById("archives");
        const archivesObserver = new IntersectionObserver(
          (entries) => {
            const queue = new UpdateQueue();

            entries.forEach((entry) => handleIntersectingEntry(entry, queue));
          },
          {
            root: null,
            rootMargin: "0px",
            threshold: 0,
          }
        );

        archivesObserver.observe(archives);

        let latestSectionsExpanded = true;
        const handleLatestHeaderClick = () => {
          latestSectionsExpanded = !latestSectionsExpanded;

          if (latestSectionsExpanded) {
            archivesObserver.observe(archives);
          } else {
            archivesObserver.disconnect(archives);
          }

          for (let section of document.querySelectorAll("#latest > section")) {
            section.style.display = latestSectionsExpanded ? "block" : "none";
          }
        };

        const latestHeader = document.querySelector("#latest > h2");
        latestHeader.style.cursor = "pointer";
        latestHeader.addEventListener("click", handleLatestHeaderClick);
      }
    </script>
    <script type="module">
      import { Workbox } from "https://storage.googleapis.com/workbox-cdn/releases/6.4.1/workbox-window.prod.mjs";

      if ("serviceWorker" in navigator) {
        const base = document.querySelector("base");
        const serviceWorkerPath = `${
          base ? base.href.replace(/\/$/, "") : ""
        }/service-worker.js`;

        const wb = new Workbox(serviceWorkerPath);

        // setup event listeners
        wb.addEventListener("waiting", (event) => {
          wb.addEventListener("controlling", () => {
            window.location.reload();
          });

          wb.messageSkipWaiting();
        });

        wb.register();
      }
    </script>
  </body>
</html>
