<!DOCTYPE html>
<html lang="en" xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta charset="utf-8" />
    <meta
      content="width=device-width, initial-scale=1.0, viewport-fit=cover"
      name="viewport"
    />
    <meta name="description" content="Hacker News" />
    <meta name="theme-color" content="#fff" />
    <title>Hacker News</title>
    <link rel="manifest" href="manifest.json" />
    <link
      href="data:image/x-icon;base64,AAABAAEAAQECAAEAAQA4AAAAFgAAACgAAAABAAAAAgAAAAEAAQAAAAAAAAAAAAAAAAAAAAAAAAAAAAABAAEAAQECAAEAAQA4AAAAFgAAACgAAAABAAAAAgAAAAEAAQAAAAAAAAAAAAAAAAAAAAAAAAAA"
      rel="icon"
      type="image/x-icon"
    />
    <link
      href="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAgAAAAIAAQMAAADOtka5AAAAA1BMVEUAAACnej3aAAAANklEQVR42u3BAQEAAACCIP+vbkhAAQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAB8G4IAAAFjdVCkAAAAAElFTkSuQmCC"
      rel="apple-touch-icon"
    />
    <style>
      /*<!--*/
      body {
        color: rgb(25, 25, 25);
        font-family: Verdana, Geneva, sans-serif;
        margin: 0;
      }

      a {
        text-decoration: none;
      }

      a:link,
      a:focus,
      a:hover,
      a:active {
        color: rgb(75, 75, 125);
      }

      a:visited {
        color: rgb(25, 25, 25);
      }

      h1 > a,
      h1 > a:link,
      h1 > a:focus,
      h1 > a:hover,
      h1 > a:active,
      h1 > a:visited,
      h2 > a,
      h2 > a:link,
      h2 > a:focus,
      h2 > a:hover,
      h2 > a:active,
      h2 > a:visited {
        color: rgb(25, 25, 25);
      }

      h1 {
        background-color: rgb(255, 102, 0);
        margin: 0;
        padding: 1rem;
      }

      h2 {
        background-color: rgb(200, 200, 200);
        margin: 1rem 0;
        padding: 0.5rem 0.5rem 0.5rem 1rem;
      }

      #latest > section,
      #archives > section {
        margin: 0 1rem 1rem 1rem;
        padding-bottom: 1rem;
      }

      #latest > section:not(:last-child),
      #archives > section:not(:last-child) {
        border-bottom: 1px dotted rgb(200, 200, 200);
      }

      section > h3 {
        margin: 0 0 0.5rem 0;
      }

      section > h4 {
        font-weight: normal;
        margin: 0 0 0 1rem;
      }

      .descendants-container,
      .points-container {
        align-items: center;
        border-left: 1px solid #333;
        display: inline-flex;
        margin-left: 0.5rem;
        padding-left: 0.5rem;
        text-align: center;
      }

      .points {
        align-items: center;
        display: inline-flex;
        height: 1rem;
        margin-left: 1ch;
        min-width: 3ch;
      }

      .text {
        line-height: 1.5rem;
        margin: 1rem 1rem 0 1rem;
        overflow: auto;
      }

      .text > p:first-child {
        margin-top: 1rem;
      }

      .text > p:last-child {
        margin-bottom: 0;
      }
      /*-->*/
    </style>
  </head>

  <body>
    <main>
      <h1><a href="https://kherrick.github.io/hacker-news/">Hacker News</a></h1>
      <section id="latest">
        <h2>Latest</h2>
        <section id="43614199">
          <h3>
            <a class="item" href="https://queue.acm.org/detail.cfm?id=3722542"
              >Fifty Years of Open Source Software Supply Chain Security</a
            >
          </h3>
          <section>
            <h4>
              <span>2025-04-07 @ 18:04:22</span
              ><span class="points-container"
                >Points: <span class="points">17</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=43614199"
                  >Comments</a
                ><span class="descendants">: 2</span></span
              >
            </h4>
          </section>
        </section>
        <section id="43614081">
          <h3>
            <a
              class="item"
              href="https://bluerenga.blog/2025/04/03/the-troll-hole-adventure-1980/"
              >The Troll Hole Adventure</a
            >
          </h3>
          <section>
            <h4>
              <span>2025-04-07 @ 17:52:53</span
              ><span class="points-container"
                >Points: <span class="points">4</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=43614081"
                  >Comments</a
                ><span class="descendants">: 1</span></span
              >
            </h4>
          </section>
        </section>
        <section id="43613994">
          <h3>
            <a
              class="item"
              href="https://personal.cis.strath.ac.uk/conor.mcbride/pub/hasochism.pdf"
              >Hasochism: The pleasure and pain of dependently typed Haskell
              programming [pdf] (2013)</a
            >
          </h3>
          <section>
            <h4>
              <span>2025-04-07 @ 17:42:02</span
              ><span class="points-container"
                >Points: <span class="points">11</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=43613994"
                  >Comments</a
                ><span class="descendants">: 1</span></span
              >
            </h4>
          </section>
        </section>
        <section id="43613896">
          <h3>
            <a class="item" href="https://github.com/hummingme/kahuna"
              >Show HN: Kahuna, the IndexedDB-Manager Webextension</a
            >
          </h3>
          <section>
            <h4>
              <span>2025-04-07 @ 17:31:42</span
              ><span class="points-container"
                >Points: <span class="points">11</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=43613896"
                  >Comments</a
                ><span class="descendants">: 2</span></span
              >
            </h4>
            <div class="text">
              <p>
                But anyone who has used the browser's own developer tools for
                working with IndexedDB databases will probably agree that there
                must be more convenient methods. And even though Kahuna can't do
                everything I want it to yet, it's certainly a good start.
              </p>
              <p>
                Since yesterday, the webextension is available in the Chrome Web
                Store [1] and as a Firefox Add-On [2].
              </p>
              <p>
                Feedback, comments, bug reports, and feature requests are all
                more than welcome!
              </p>
              <p>
                [1]
                <a
                  href="https://chromewebstore.google.com/detail/kahuna/ilafpdbgcaodnkdklgemggjamhpdjile"
                  >https://chromewebstore.google.com/detail/kahuna/ilafpdbgcaod...</a
                >
              </p>
              <p>
                [2]
                <a
                  href="https://addons.mozilla.org/en-US/firefox/addon/kahuna-the-indexeddb-manager"
                  >https://addons.mozilla.org/en-US/firefox/addon/kahuna-the-in...</a
                >
              </p>
            </div>
          </section>
        </section>
        <section id="43613194">
          <h3>
            <a class="item" href="https://browsermcp.io/"
              >Show HN: Browser MCP – Automate your browser using Cursor,
              Claude, VS Code</a
            >
          </h3>
          <section>
            <h4>
              <span>2025-04-07 @ 16:25:45</span
              ><span class="points-container"
                >Points: <span class="points">128</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=43613194"
                  >Comments</a
                ><span class="descendants">: 44</span></span
              >
            </h4>
          </section>
        </section>
        <section id="43613180">
          <h3>
            <a
              class="item"
              href="https://www.danblack.co/blog/variable-duty-cycle-square-wave"
              >Variable duty cycle square waves with the Web Audio API</a
            >
          </h3>
          <section>
            <h4>
              <span>2025-04-07 @ 16:23:52</span
              ><span class="points-container"
                >Points: <span class="points">26</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=43613180"
                  >Comments</a
                ><span class="descendants">: 9</span></span
              >
            </h4>
          </section>
        </section>
        <section id="43612994">
          <h3>
            <a
              class="item"
              href="https://scitechdaily.com/global-health-threat-deadly-antibiotic-resistant-superbug-spreading-in-malaysia/"
              >Global Health Threat: Antibiotic-Resistant "Superbug" Spreading
              in Malaysia</a
            >
          </h3>
          <section>
            <h4>
              <span>2025-04-07 @ 16:05:43</span
              ><span class="points-container"
                >Points: <span class="points">40</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=43612994"
                  >Comments</a
                ><span class="descendants">: 9</span></span
              >
            </h4>
          </section>
        </section>
        <section id="43612807">
          <h3>
            <a
              class="item"
              href="https://www.newyorker.com/magazine/2025/04/07/catullus-poems-book-review-stephen-mitchell-isobel-williams"
              >Why Catullus Continues to Seduce Us</a
            >
          </h3>
          <section>
            <h4>
              <span>2025-04-07 @ 15:49:05</span
              ><span class="points-container"
                >Points: <span class="points">40</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=43612807"
                  >Comments</a
                ><span class="descendants">: 20</span></span
              >
            </h4>
          </section>
        </section>
        <section id="43612211">
          <h3>
            <a class="item" href="https://dmodel.ai/nullability-gentle/"
              >LLMs understand nullability</a
            >
          </h3>
          <section>
            <h4>
              <span>2025-04-07 @ 14:52:52</span
              ><span class="points-container"
                >Points: <span class="points">118</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=43612211"
                  >Comments</a
                ><span class="descendants">: 79</span></span
              >
            </h4>
          </section>
        </section>
        <section id="43612102">
          <h3>
            <a
              class="item"
              href="https://www.botanica.software/post/decoding-the-90s"
              >Decoding the 90s: Cryptography in Early Software Development
              (2023)</a
            >
          </h3>
          <section>
            <h4>
              <span>2025-04-07 @ 14:43:17</span
              ><span class="points-container"
                >Points: <span class="points">73</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=43612102"
                  >Comments</a
                ><span class="descendants">: 23</span></span
              >
            </h4>
          </section>
        </section>
        <section id="43610760">
          <h3>
            <a
              class="item"
              href="https://scitechdaily.com/watch-antimatter-fall-scientists-capture-gravitys-pull-with-a-3840mp-camera/"
              >Watch Antimatter Fall: Scientists Capture Gravity's Pull with a
              3840MP Camera</a
            >
          </h3>
          <section>
            <h4>
              <span>2025-04-07 @ 12:58:09</span
              ><span class="points-container"
                >Points: <span class="points">29</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=43610760"
                  >Comments</a
                ><span class="descendants">: 14</span></span
              >
            </h4>
          </section>
        </section>
        <section id="43610187">
          <h3>
            <a
              class="item"
              href="https://www.nytimes.com/2018/01/12/magazine/inside-one-of-americas-last-pencil-factories.html"
              >Inside One of America's Last Pencil Factories (2018)</a
            >
          </h3>
          <section>
            <h4>
              <span>2025-04-07 @ 11:43:46</span
              ><span class="points-container"
                >Points: <span class="points">68</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=43610187"
                  >Comments</a
                ><span class="descendants">: 37</span></span
              >
            </h4>
          </section>
        </section>
        <section id="43609661">
          <h3>
            <a
              class="item"
              href="https://www.newyorker.com/magazine/2025/04/14/the-dire-wolf-is-back"
              >The Dire Wolf Is Back</a
            >
          </h3>
          <section>
            <h4>
              <span>2025-04-07 @ 10:09:17</span
              ><span class="points-container"
                >Points: <span class="points">110</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=43609661"
                  >Comments</a
                ><span class="descendants">: 119</span></span
              >
            </h4>
          </section>
        </section>
        <section id="43609242">
          <h3>
            <a
              class="item"
              href="https://mattgiustwilliamson.substack.com/p/your-startup-doesnt-need-to-be-a"
              >A startup doesn't need to be a unicorn</a
            >
          </h3>
          <section>
            <h4>
              <span>2025-04-07 @ 08:42:43</span
              ><span class="points-container"
                >Points: <span class="points">422</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=43609242"
                  >Comments</a
                ><span class="descendants">: 250</span></span
              >
            </h4>
          </section>
        </section>
        <section id="43607744">
          <h3>
            <a class="item" href="https://uncurl.dev/"
              >Show HN: Uncurl.dev – Convert curl commands to a shareable,
              executable UI</a
            >
          </h3>
          <section>
            <h4>
              <span>2025-04-07 @ 04:37:19</span
              ><span class="points-container"
                >Points: <span class="points">53</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=43607744"
                  >Comments</a
                ><span class="descendants">: 17</span></span
              >
            </h4>
            <div class="text">
              <p>
                I built uncurl.dev to scratch my own itch: I kept getting curl
                commands in API docs, bug reports, or Slack messages and wanted
                a quick way to visualize, run, and debug them without firing up
                Postman or writing code to dissect them. It was also sometimes
                painful to create a test page specifically for non-tech users to
                consume an API. I originally vibe-coded this over a weekend just
                to make it easier for myself to debug API requests shared as
                curl commands. It slowly grew into something I found
                surprisingly useful in my workflow, so I decided to clean it up
                and share it.
              </p>
              <p>
                uncurl.dev takes a curl command and: - Converts it into a visual
                representation - Lets you edit and inspect all parts of the
                request - Allows sharing via a unique link - (Optionally)
                executes it from the server, so business or non-technical users
                can see results
              </p>
              <p>
                Execution is currently behind login, with a cap (5/min) to avoid
                abuse and manage costs. Non-logged-in users can still build and
                share curl commands—they just can’t execute them. The server
                runs each request in a Docker sandbox with strict resource/time
                limits (cpu, memory, timeout, no network access outside the
                request).
              </p>
              <p>
                It’s not meant to replace full-featured tools like Postman or
                Hoppscotch. It’s more of a “CLI-to-UI bridge” for fast sharing
                and debugging, especially in dev workflows where curl is the
                starting point. Think of it like Pastebin or JSFiddle, but for
                curl commands.
              </p>
              <p>
                If you’ve ever copied a curl from an API doc and wanted a
                cleaner way to see it or send it to someone else, I’d love your
                feedback.
              </p>
              <p>
                Thanks! (You can try it without signup here:
                <a href="https://uncurl.dev">https://uncurl.dev</a>)
              </p>
            </div>
          </section>
        </section>
        <section id="43606027">
          <h3>
            <a class="item" href="https://gtoolkit.com//">Glamorous Toolkit</a>
          </h3>
          <section>
            <h4>
              <span>2025-04-06 @ 23:47:21</span
              ><span class="points-container"
                >Points: <span class="points">266</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=43606027"
                  >Comments</a
                ><span class="descendants">: 84</span></span
              >
            </h4>
          </section>
        </section>
        <section id="43605003">
          <h3>
            <a
              class="item"
              href="https://derflounder.wordpress.com/2025/04/06/rsync-replaced-with-openrsync-on-macos-sequoia/"
              >Rsync replaced with openrsync on macOS Sequoia</a
            >
          </h3>
          <section>
            <h4>
              <span>2025-04-06 @ 21:14:09</span
              ><span class="points-container"
                >Points: <span class="points">485</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=43605003"
                  >Comments</a
                ><span class="descendants">: 387</span></span
              >
            </h4>
          </section>
        </section>
        <section id="43603646">
          <h3>
            <a
              class="item"
              href="https://www.seangoedecke.com/where-the-money-comes-from/"
              >Knowing where your engineer salary comes from</a
            >
          </h3>
          <section>
            <h4>
              <span>2025-04-06 @ 18:25:36</span
              ><span class="points-container"
                >Points: <span class="points">226</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=43603646"
                  >Comments</a
                ><span class="descendants">: 120</span></span
              >
            </h4>
          </section>
        </section>
        <section id="43589214">
          <h3>
            <a
              class="item"
              href="https://news.umich.edu/charging-electric-vehicles-5x-faster-in-subfreezing-temps/"
              >Charging electric vehicles 5x faster in subfreezing temps</a
            >
          </h3>
          <section>
            <h4>
              <span>2025-04-05 @ 00:38:20</span
              ><span class="points-container"
                >Points: <span class="points">127</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=43589214"
                  >Comments</a
                ><span class="descendants">: 103</span></span
              >
            </h4>
          </section>
        </section>
        <section id="43586380">
          <h3>
            <a class="item" href="https://github.com/lechmazur/elimination_game"
              >Benchmarking LLM social skills with an elimination game</a
            >
          </h3>
          <section>
            <h4>
              <span>2025-04-04 @ 18:54:41</span
              ><span class="points-container"
                >Points: <span class="points">121</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=43586380"
                  >Comments</a
                ><span class="descendants">: 34</span></span
              >
            </h4>
          </section>
        </section>
        <section id="43585649">
          <h3>
            <a
              class="item"
              href="https://hellohartblog.wordpress.com/2015/05/25/the-mathematics-of-crochet/"
              >The Mathematics of Crochet</a
            >
          </h3>
          <section>
            <h4>
              <span>2025-04-04 @ 17:47:05</span
              ><span class="points-container"
                >Points: <span class="points">69</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=43585649"
                  >Comments</a
                ><span class="descendants">: 4</span></span
              >
            </h4>
          </section>
        </section>
        <section id="43584422">
          <h3>
            <a class="item" href="https://codeberg.org/luciofstars/altabasic"
              >I'm manually transcribing the AltairBASIC source, ten lines a day
              starting today</a
            >
          </h3>
          <section>
            <h4>
              <span>2025-04-04 @ 16:06:47</span
              ><span class="points-container"
                >Points: <span class="points">64</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=43584422"
                  >Comments</a
                ><span class="descendants">: 36</span></span
              >
            </h4>
          </section>
        </section>
        <section id="43584208">
          <h3>
            <a
              class="item"
              href="https://gizmodo.com/mass-grave-of-150-roman-soldiers-found-under-vienna-sports-field-2000584946"
              >Mass Grave of 150 Roman Soldiers Found Under Vienna Sports
              Field</a
            >
          </h3>
          <section>
            <h4>
              <span>2025-04-04 @ 15:54:30</span
              ><span class="points-container"
                >Points: <span class="points">60</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=43584208"
                  >Comments</a
                ><span class="descendants">: 20</span></span
              >
            </h4>
          </section>
        </section>
        <section id="43584015">
          <h3>
            <a
              class="item"
              href="https://www.nature.com/articles/d41586-025-01019-w"
              >DeepMind program finds diamonds in Minecraft without being
              taught</a
            >
          </h3>
          <section>
            <h4>
              <span>2025-04-04 @ 15:40:50</span
              ><span class="points-container"
                >Points: <span class="points">192</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=43584015"
                  >Comments</a
                ><span class="descendants">: 100</span></span
              >
            </h4>
          </section>
        </section>
        <section id="43581900">
          <h3>
            <a class="item" href="https://s2.dev/blog/dst"
              >Deterministic simulation testing for async Rust</a
            >
          </h3>
          <section>
            <h4>
              <span>2025-04-04 @ 13:17:11</span
              ><span class="points-container"
                >Points: <span class="points">64</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=43581900"
                  >Comments</a
                ><span class="descendants">: 5</span></span
              >
            </h4>
          </section>
        </section>
        <section id="43580815">
          <h3>
            <a
              class="item"
              href="https://www.theverge.com/tech/640119/camera-raw-spec-format-explained-adobe-dng-canon-nikon-sony-fujifilm"
              >We asked camera companies why their RAW formats are all different
              and confusing</a
            >
          </h3>
          <section>
            <h4>
              <span>2025-04-04 @ 11:41:32</span
              ><span class="points-container"
                >Points: <span class="points">286</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=43580815"
                  >Comments</a
                ><span class="descendants">: 150</span></span
              >
            </h4>
          </section>
        </section>
        <section id="43576602">
          <h3>
            <a
              class="item"
              href="https://www.wsj.com/style/egon-schiele-artist-history-eb2480e8"
              >The Untold Mystery Upending Egon Schiele's Legacy</a
            >
          </h3>
          <section>
            <h4>
              <span>2025-04-03 @ 23:14:42</span
              ><span class="points-container"
                >Points: <span class="points">20</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=43576602"
                  >Comments</a
                ><span class="descendants">: 8</span></span
              >
            </h4>
          </section>
        </section>
        <section id="43572511">
          <h3>
            <a
              class="item"
              href="https://gist.github.com/rxliuli/be31cbded41ef7eac6ae0da9070c8ef8"
              >Journey to Optimize Cloudflare D1 Database Queries</a
            >
          </h3>
          <section>
            <h4>
              <span>2025-04-03 @ 17:00:21</span
              ><span class="points-container"
                >Points: <span class="points">94</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=43572511"
                  >Comments</a
                ><span class="descendants">: 21</span></span
              >
            </h4>
          </section>
        </section>
        <section id="43571332">
          <h3>
            <a
              class="item"
              href="https://www.quadratichq.com/blog/cursed-excel-datetime-math"
              >Cursed Excel: "1/2"+1=45660</a
            >
          </h3>
          <section>
            <h4>
              <span>2025-04-03 @ 15:42:06</span
              ><span class="points-container"
                >Points: <span class="points">117</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=43571332"
                  >Comments</a
                ><span class="descendants">: 97</span></span
              >
            </h4>
          </section>
        </section>
        <section id="43565891">
          <h3>
            <a
              class="item"
              href="https://www.centauri-dreams.org/2025/04/01/a-multiwavelength-look-at-proxima-centauris-flares/"
              >A Multiwavelength Look at Proxima Centauri's Flares</a
            >
          </h3>
          <section>
            <h4>
              <span>2025-04-03 @ 07:07:48</span
              ><span class="points-container"
                >Points: <span class="points">42</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=43565891"
                  >Comments</a
                ><span class="descendants">: 4</span></span
              >
            </h4>
          </section>
        </section>
      </section>
      <section id="archives">
        <h2>
          <a
            href="https://github.com/kherrick/hacker-news/blob/main/archives/index.md"
            >Archives</a
          >
        </h2>
        <section>
          <h3>
            <a
              href="https://github.com/kherrick/hacker-news/blob/main/archives/2025/index.md"
              >2025</a
            >
          </h3>
        </section>
        <section>
          <h3>
            <a
              href="https://github.com/kherrick/hacker-news/blob/main/archives/2024/index.md"
              >2024</a
            >
          </h3>
        </section>
        <section>
          <h3>
            <a
              href="https://github.com/kherrick/hacker-news/blob/main/archives/2023/index.md"
              >2023</a
            >
          </h3>
        </section>
        <section>
          <h3>
            <a
              href="https://github.com/kherrick/hacker-news/blob/main/archives/2022/index.md"
              >2022</a
            >
          </h3>
        </section>
      </section>
    </main>
    <script type="module">
      import { buildDescendants } from "./lib/build-html-descendants.js";
      import { buildNextItem } from "./lib/build-html-next-item.js";
      import { getNextDateTime } from "./lib/date-time.js";

      const updateSectionById = (id) =>
        fetch(`https://hacker-news.firebaseio.com/v0/item/${id}.json`).then(
          (result) =>
            result.json().then(({ descendants, id, score, text, type }) => {
              const currentItem = document.getElementById(id);

              if (score) {
                currentItem.querySelector(".points").textContent = score;
              }

              if (descendants && (type === "poll" || type === "story")) {
                const currentDescendants =
                  currentItem.querySelector(".descendants");

                if (currentDescendants) {
                  currentDescendants.textContent = `: ${descendants}`;
                } else {
                  const comments = buildDescendants(
                    document,
                    descendants,
                    `https://news.ycombinator.com/item?id=${id}`
                  );

                  currentItem.querySelector("h4").appendChild(comments);
                }
              }

              if (text) {
                const currentText = currentItem.querySelector(".text");

                if (currentText) {
                  currentText.innerHTML = text.replace(/\0/g, "");
                } else {
                  const content = document.createElement("div");
                  content.innerHTML = text.replace(/\0/g, "");
                  content.setAttribute("class", "text");

                  currentItem.appendChild(content);
                }
              }
            })
        );

      class UpdateQueue {
        constructor() {
          this._ids = [];
          this._isUpdating = false;
        }

        addItemById(id) {
          this._ids.push(id);
        }

        async flush() {
          const id = this._ids.shift();

          if (id) {
            this._isUpdating = true;

            await updateSectionById(id);
            await this.flush();
          } else {
            this._isUpdating = false;

            setTimeout(async () => {
              if (!this._isUpdating && this._ids && this._ids.length) {
                await this.flush();
              }
            }, 0);
          }
        }
      }

      // get latest data
      const latestSection = document.getElementById("latest");

      for (let item of latestSection.querySelectorAll("section[id]")) {
        updateSectionById(item.getAttribute("id"));
      }

      if ("IntersectionObserver" in window) {
        window.hackerNewsState = { index: [], nextTimeIndex: -1 };

        const addNewsItem = async (newsItem, queue) => {
          try {
            const { date, time, itemComments, itemTitle, itemLink } = newsItem;
            const section = await buildNextItem({
              document,
              dateTime: `${date}, ${time}`,
              itemComments,
              itemLink,
              itemTitle: new DOMParser().parseFromString(
                itemTitle.replace(/\\/g, ""),
                "text/html"
              ).documentElement.textContent,
              fetchItemDetails: false,
            });

            // display loading indicator for section
            section.querySelector(".points-container").innerHTML =
              'Points: <span class="points"><img style="height: 100%;" src="lib/images/loading.svg" /></span>';

            const id = section.getAttribute("id");
            if (!document.getElementById(id)) {
              document.getElementById("latest").appendChild(section);

              queue.addItemById(id);
            }
          } catch (error) {}
        };

        const buildArchiveIndex = async (lastDateTime) => {
          const nextDate = lastDateTime.slice(0, 10);
          const nextYear = nextDate.slice(0, 4);

          return (
            await (
              await fetch(
                `https://raw.githubusercontent.com/kherrick/hacker-news/main/archives/${nextYear}/${nextDate}/index.md`
              )
            ).text()
          )
            .split("\n")
            .filter((line) => line.match(new RegExp("^\\* \\[")))
            .map((line) => {
              const segment = line.replace("* ", "").split("](");
              const pubDate = segment[0].slice(1);

              const itemComments = segment[1].split(") - [")[0];
              const itemTitle = segment[1].split(") - [")[1];
              const itemLink = segment[2].slice(0, -1);
              const date = pubDate.slice(0, 10);
              const time = pubDate.slice(-8);

              return {
                date,
                itemComments,
                itemLink,
                itemTitle,
                time,
              };
            });
        };

        const handleIntersectingEntry = async (entry, queue) => {
          if (entry.isIntersecting) {
            const lastDateTime = document
              .getElementById("latest")
              .querySelector(
                "section:last-child > section > h4 > span"
              ).textContent;

            const nextDateTime = getNextDateTime(lastDateTime ?? "", -1);
            const archiveIndex = await buildArchiveIndex(nextDateTime);
            const nextTimeIndex = archiveIndex.findIndex(
              ({ time }) => time === nextDateTime.slice(-8)
            );

            const handleIndexUpdate = (index, existingIndexValues = []) => {
              index.forEach((i) => {
                existingIndexValues.push(i);
              });
              return existingIndexValues;
            };

            window.hackerNewsState = {
              index: handleIndexUpdate(
                archiveIndex,
                window.hackerNewsState.index
              ),
              nextTimeIndex,
            };

            let currentTimeIndex = nextTimeIndex + 1;
            const items = Object.values(window.hackerNewsState.index);
            for (let item of items) {
              if (currentTimeIndex < window.hackerNewsState.index.length) {
                addNewsItem(items[currentTimeIndex], queue);

                currentTimeIndex = currentTimeIndex + 1;
              }
            }

            queue.flush();
          }
        };

        const archives = document.getElementById("archives");
        const archivesObserver = new IntersectionObserver(
          (entries) => {
            const queue = new UpdateQueue();

            entries.forEach((entry) => handleIntersectingEntry(entry, queue));
          },
          {
            root: null,
            rootMargin: "0px",
            threshold: 0,
          }
        );

        archivesObserver.observe(archives);

        let latestSectionsExpanded = true;
        const handleLatestHeaderClick = () => {
          latestSectionsExpanded = !latestSectionsExpanded;

          if (latestSectionsExpanded) {
            archivesObserver.observe(archives);
          } else {
            archivesObserver.disconnect(archives);
          }

          for (let section of document.querySelectorAll("#latest > section")) {
            section.style.display = latestSectionsExpanded ? "block" : "none";
          }
        };

        const latestHeader = document.querySelector("#latest > h2");
        latestHeader.style.cursor = "pointer";
        latestHeader.addEventListener("click", handleLatestHeaderClick);
      }
    </script>
    <script type="module">
      import { Workbox } from "https://storage.googleapis.com/workbox-cdn/releases/6.4.1/workbox-window.prod.mjs";

      if ("serviceWorker" in navigator) {
        const base = document.querySelector("base");
        const serviceWorkerPath = `${
          base ? base.href.replace(/\/$/, "") : ""
        }/service-worker.js`;

        const wb = new Workbox(serviceWorkerPath);

        // setup event listeners
        wb.addEventListener("waiting", (event) => {
          wb.addEventListener("controlling", () => {
            window.location.reload();
          });

          wb.messageSkipWaiting();
        });

        wb.register();
      }
    </script>
  </body>
</html>
