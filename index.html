<!DOCTYPE html>
<html lang="en" xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta charset="utf-8" />
    <meta
      content="width=device-width, initial-scale=1.0, viewport-fit=cover"
      name="viewport"
    />
    <meta name="description" content="Hacker News" />
    <meta name="theme-color" content="#fff" />
    <title>Hacker News</title>
    <link rel="manifest" href="manifest.json" />
    <link
      href="data:image/x-icon;base64,AAABAAEAAQECAAEAAQA4AAAAFgAAACgAAAABAAAAAgAAAAEAAQAAAAAAAAAAAAAAAAAAAAAAAAAAAAABAAEAAQECAAEAAQA4AAAAFgAAACgAAAABAAAAAgAAAAEAAQAAAAAAAAAAAAAAAAAAAAAAAAAA"
      rel="icon"
      type="image/x-icon"
    />
    <link
      href="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAgAAAAIAAQMAAADOtka5AAAAA1BMVEUAAACnej3aAAAANklEQVR42u3BAQEAAACCIP+vbkhAAQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAB8G4IAAAFjdVCkAAAAAElFTkSuQmCC"
      rel="apple-touch-icon"
    />
    <style>
      /*<!--*/
      body {
        color: rgb(25, 25, 25);
        font-family: Verdana, Geneva, sans-serif;
        margin: 0;
      }

      a {
        text-decoration: none;
      }

      a:link,
      a:focus,
      a:hover,
      a:active {
        color: rgb(75, 75, 125);
      }

      a:visited {
        color: rgb(25, 25, 25);
      }

      h1 > a,
      h1 > a:link,
      h1 > a:focus,
      h1 > a:hover,
      h1 > a:active,
      h1 > a:visited,
      h2 > a,
      h2 > a:link,
      h2 > a:focus,
      h2 > a:hover,
      h2 > a:active,
      h2 > a:visited {
        color: rgb(25, 25, 25);
      }

      h1 {
        background-color: rgb(255, 102, 0);
        margin: 0;
        padding: 1rem;
      }

      h2 {
        background-color: rgb(200, 200, 200);
        margin: 1rem 0;
        padding: 0.5rem 0.5rem 0.5rem 1rem;
      }

      #latest > section,
      #archives > section {
        margin: 0 1rem 1rem 1rem;
        padding-bottom: 1rem;
      }

      #latest > section:not(:last-child),
      #archives > section:not(:last-child) {
        border-bottom: 1px dotted rgb(200, 200, 200);
      }

      section > h3 {
        margin: 0 0 0.5rem 0;
      }

      section > h4 {
        font-weight: normal;
        margin: 0 0 0 1rem;
      }

      .descendants-container,
      .points-container {
        align-items: center;
        border-left: 1px solid #333;
        display: inline-flex;
        margin-left: 0.5rem;
        padding-left: 0.5rem;
        text-align: center;
      }

      .points {
        align-items: center;
        display: inline-flex;
        height: 1rem;
        margin-left: 1ch;
        min-width: 3ch;
      }

      .text {
        line-height: 1.5rem;
        margin: 1rem 1rem 0 1rem;
        overflow: auto;
      }

      .text > p:first-child {
        margin-top: 1rem;
      }

      .text > p:last-child {
        margin-bottom: 0;
      }
      /*-->*/
    </style>
  </head>

  <body>
    <main>
      <h1><a href="https://kherrick.github.io/hacker-news/">Hacker News</a></h1>
      <section id="latest">
        <h2>Latest</h2>
        <section id="45682671">
          <h3>
            <a
              class="item"
              href="https://apnews.com/article/trump-treasury-debt-ceiling-bessent-09575f13ca95c2f1beb38234b2cbe85b"
              >US hits $38T in debt. Fastest accumulation of $1T outside
              pandemic</a
            >
          </h3>
          <section>
            <h4>
              <span>2025-10-23 @ 15:03:05</span
              ><span class="points-container"
                >Points: <span class="points">109</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=45682671"
                  >Comments</a
                ><span class="descendants">: 147</span></span
              >
            </h4>
          </section>
        </section>
        <section id="45682169">
          <h3>
            <a
              class="item"
              href="https://www.bbc.com/news/articles/cqx30vnwd4do"
              >US axes website for reporting human rights abuses by US-armed
              foreign forces</a
            >
          </h3>
          <section>
            <h4>
              <span>2025-10-23 @ 14:25:22</span
              ><span class="points-container"
                >Points: <span class="points">531</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=45682169"
                  >Comments</a
                ><span class="descendants">: 250</span></span
              >
            </h4>
          </section>
        </section>
        <section id="45682067">
          <h3>
            <a
              class="item"
              href="https://www.theregister.com/2025/10/22/microsoft_office_online_server/"
              >Microsoft puts Office Online Server on the chopping block</a
            >
          </h3>
          <section>
            <h4>
              <span>2025-10-23 @ 14:15:22</span
              ><span class="points-container"
                >Points: <span class="points">30</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=45682067"
                  >Comments</a
                ><span class="descendants">: 17</span></span
              >
            </h4>
          </section>
        </section>
        <section id="45681850">
          <h3>
            <a
              class="item"
              href="https://utcc.utoronto.ca/~cks/space/blog/web/WeShouldBlockForSocialReasons?showcomments"
              >We need to start doing web blocking for non-technical reasons</a
            >
          </h3>
          <section>
            <h4>
              <span>2025-10-23 @ 13:54:36</span
              ><span class="points-container"
                >Points: <span class="points">31</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=45681850"
                  >Comments</a
                ><span class="descendants">: 11</span></span
              >
            </h4>
          </section>
        </section>
        <section id="45681200">
          <h3>
            <a
              class="item"
              href="https://bradley.chatha.dev/blog/dlang-propaganda/asn1-compiler-in-d/"
              >I spent a year of my life making an ASN.1 compiler in D</a
            >
          </h3>
          <section>
            <h4>
              <span>2025-10-23 @ 12:47:41</span
              ><span class="points-container"
                >Points: <span class="points">151</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=45681200"
                  >Comments</a
                ><span class="descendants">: 55</span></span
              >
            </h4>
          </section>
        </section>
        <section id="45680937">
          <h3>
            <a class="item" href="https://github.com/deta/surf"
              >Show HN: Deta Surf – An open source and local-first AI
              notebook</a
            >
          </h3>
          <section>
            <h4>
              <span>2025-10-23 @ 12:11:27</span
              ><span class="points-container"
                >Points: <span class="points">54</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=45680937"
                  >Comments</a
                ><span class="descendants">: 22</span></span
              >
            </h4>
            <div class="text">
              <p>
                We got frustrated with the fragmented experience of exploring
                &amp; creating across our file manager, the web and document
                apps. Lots of manual searching, opening windows &amp; tabs,
                scrolling, and ultimately copying &amp; pasting into a document
                editor.
              </p>
              <p>
                Surf is a desktop app meant for simultaneous research and
                thinking to minimize the grunt work. It’s made of two parts:
              </p>
              <p>
                1) A multi-media library where you can save and organize files
                and webpages into collections called Notebooks.
              </p>
              <p>
                2) A LLM-powered smart document which you can auto-generate
                using the context from any stored page, tab or entire notebook.
                This document contains deep links back to the source material —
                like a page of a PDF or timestamp in a YouTube video. Unlike
                Deep Research products (or NotebookLMs chat) the entire thing is
                editable. The user also stays in the loop.
              </p>
              <p>
                With a technology like AI, context / data is proving to be king.
                We think it should stay under the user’s control, with minimal
                lock in: where you can own &amp; export, and plug &amp; play
                with different models. That’s why Surf is:
              </p>
              <p>
                - Open Source on GitHub - Open (&amp; Local Data): the data
                saved in Surf is stored on your local machine in open and
                accessible formats and mostly works offline. - Open Model
                Choice: you can choose which models you use with Surf, and can
                add custom &amp; Local LLMs
              </p>
              <p>
                Early users include students &amp; researchers who are learning
                and doing thematic research using Surf.
              </p>
              <p>
                Github repo:
                <a href="https://github.com/deta/surf/"
                  >https://github.com/deta/surf/</a
                >
              </p>
              <p>
                Website: <a href="https://deta.surf/">https://deta.surf/</a>
              </p>
            </div>
          </section>
        </section>
        <section id="45680847">
          <h3>
            <a class="item" href="https://www.nango.dev/careers"
              >Nango (YC W23) is hiring Staff Back end Engs (remote)</a
            >
          </h3>
          <section>
            <h4>
              <span>2025-10-23 @ 12:00:11</span
              ><span class="points-container"
                >Points: <span class="points">1</span></span
              >
            </h4>
          </section>
        </section>
        <section id="45680695">
          <h3>
            <a
              class="item"
              href="https://www.quantamagazine.org/the-game-theory-of-how-algorithms-can-drive-up-prices-20251022/"
              >The Game Theory of How Algorithms Can Drive Up Prices</a
            >
          </h3>
          <section>
            <h4>
              <span>2025-10-23 @ 11:38:49</span
              ><span class="points-container"
                >Points: <span class="points">117</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=45680695"
                  >Comments</a
                ><span class="descendants">: 68</span></span
              >
            </h4>
          </section>
        </section>
        <section id="45680547">
          <h3>
            <a
              class="item"
              href="https://arstechnica.com/tech-policy/2025/10/starlink-blocks-2500-dishes-allegedly-used-by-myanmars-notorious-scam-centers/"
              >SpaceX disables 2,500 Starlink terminals allegedly used by Asian
              scam centers</a
            >
          </h3>
          <section>
            <h4>
              <span>2025-10-23 @ 11:15:44</span
              ><span class="points-container"
                >Points: <span class="points">174</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=45680547"
                  >Comments</a
                ><span class="descendants">: 156</span></span
              >
            </h4>
          </section>
        </section>
        <section id="45680237">
          <h3>
            <a
              class="item"
              href="https://pytorch.org/blog/introducing-pytorch-monarch/"
              >PyTorch Monarch</a
            >
          </h3>
          <section>
            <h4>
              <span>2025-10-23 @ 10:15:12</span
              ><span class="points-container"
                >Points: <span class="points">201</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=45680237"
                  >Comments</a
                ><span class="descendants">: 34</span></span
              >
            </h4>
          </section>
        </section>
        <section id="45679638">
          <h3>
            <a class="item" href="https://lemmings.info/c64-blood-money/"
              >C64 Blood Money</a
            >
          </h3>
          <section>
            <h4>
              <span>2025-10-23 @ 08:41:21</span
              ><span class="points-container"
                >Points: <span class="points">105</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=45679638"
                  >Comments</a
                ><span class="descendants">: 23</span></span
              >
            </h4>
          </section>
        </section>
        <section id="45678603">
          <h3>
            <a
              class="item"
              href="https://lcamtuf.substack.com/p/radios-how-do-they-work"
              >Radios, how do they work? (2024)</a
            >
          </h3>
          <section>
            <h4>
              <span>2025-10-23 @ 05:56:23</span
              ><span class="points-container"
                >Points: <span class="points">165</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=45678603"
                  >Comments</a
                ><span class="descendants">: 31</span></span
              >
            </h4>
          </section>
        </section>
        <section id="45678549">
          <h3>
            <a
              class="item"
              href="https://forums.steinberg.net/t/vst-3-8-0-sdk-released/1011988"
              >VST3 audio plugin format is now MIT</a
            >
          </h3>
          <section>
            <h4>
              <span>2025-10-23 @ 05:48:02</span
              ><span class="points-container"
                >Points: <span class="points">512</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=45678549"
                  >Comments</a
                ><span class="descendants">: 119</span></span
              >
            </h4>
          </section>
        </section>
        <section id="45678511">
          <h3>
            <a
              class="item"
              href="https://joshmoody.org/blog/programming-with-less-than-nothing/"
              >Programming with Less Than Nothing</a
            >
          </h3>
          <section>
            <h4>
              <span>2025-10-23 @ 05:42:31</span
              ><span class="points-container"
                >Points: <span class="points">300</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=45678511"
                  >Comments</a
                ><span class="descendants">: 103</span></span
              >
            </h4>
          </section>
        </section>
        <section id="45675015">
          <h3>
            <a
              class="item"
              href="https://immich.app/blog/google-flags-immich-as-dangerous"
              >Google flags Immich sites as dangerous</a
            >
          </h3>
          <section>
            <h4>
              <span>2025-10-22 @ 20:53:49</span
              ><span class="points-container"
                >Points: <span class="points">1237</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=45675015"
                  >Comments</a
                ><span class="descendants">: 516</span></span
              >
            </h4>
          </section>
        </section>
        <section id="45674568">
          <h3>
            <a class="item" href="https://mcyoung.xyz/2025/10/21/ssa-1/"
              >Why SSA Compilers?</a
            >
          </h3>
          <section>
            <h4>
              <span>2025-10-22 @ 20:13:31</span
              ><span class="points-container"
                >Points: <span class="points">199</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=45674568"
                  >Comments</a
                ><span class="descendants">: 84</span></span
              >
            </h4>
          </section>
        </section>
        <section id="45674166">
          <h3>
            <a class="item" href="https://github.com/character-ai/Ovi"
              >Ovi: Twin backbone cross-modal fusion for audio-video
              generation</a
            >
          </h3>
          <section>
            <h4>
              <span>2025-10-22 @ 19:42:36</span
              ><span class="points-container"
                >Points: <span class="points">300</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=45674166"
                  >Comments</a
                ><span class="descendants">: 110</span></span
              >
            </h4>
          </section>
        </section>
        <section id="45673130">
          <h3>
            <a class="item" href="https://ian.sh/fia"
              >Accessing Max Verstappen's passport and PII through FIA bugs</a
            >
          </h3>
          <section>
            <h4>
              <span>2025-10-22 @ 18:21:54</span
              ><span class="points-container"
                >Points: <span class="points">553</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=45673130"
                  >Comments</a
                ><span class="descendants">: 124</span></span
              >
            </h4>
          </section>
        </section>
        <section id="45672336">
          <h3>
            <a class="item" href="https://stalw.art/blog/jmap-collaboration/"
              >JMAP for Calendars, Contacts and Files Now in Stalwart</a
            >
          </h3>
          <section>
            <h4>
              <span>2025-10-22 @ 17:26:06</span
              ><span class="points-container"
                >Points: <span class="points">366</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=45672336"
                  >Comments</a
                ><span class="descendants">: 177</span></span
              >
            </h4>
          </section>
        </section>
        <section id="45670443">
          <h3>
            <a
              class="item"
              href="https://blog.google/technology/research/quantum-echoes-willow-verifiable-quantum-advantage/"
              >Willow quantum chip demonstrates verifiable quantum advantage on
              hardware</a
            >
          </h3>
          <section>
            <h4>
              <span>2025-10-22 @ 15:16:19</span
              ><span class="points-container"
                >Points: <span class="points">462</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=45670443"
                  >Comments</a
                ><span class="descendants">: 238</span></span
              >
            </h4>
          </section>
        </section>
        <section id="45670052">
          <h3>
            <a
              class="item"
              href="https://evanhahn.com/scripts-i-wrote-that-i-use-all-the-time/"
              >Scripts I wrote that I use all the time</a
            >
          </h3>
          <section>
            <h4>
              <span>2025-10-22 @ 14:53:54</span
              ><span class="points-container"
                >Points: <span class="points">1115</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=45670052"
                  >Comments</a
                ><span class="descendants">: 325</span></span
              >
            </h4>
          </section>
        </section>
        <section id="45666497">
          <h3>
            <a
              class="item"
              href="https://developer.mozilla.org/en-US/docs/Web/API/Element/setHTML"
              >Element: setHTML() method</a
            >
          </h3>
          <section>
            <h4>
              <span>2025-10-22 @ 09:03:40</span
              ><span class="points-container"
                >Points: <span class="points">242</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=45666497"
                  >Comments</a
                ><span class="descendants">: 132</span></span
              >
            </h4>
          </section>
        </section>
        <section id="45658928">
          <h3>
            <a
              class="item"
              href="https://twitter.com/karpathy/status/1980397031542989305"
              >Karpathy on DeepSeek-OCR paper: Are pixels better inputs to LLMs
              than text?</a
            >
          </h3>
          <section>
            <h4>
              <span>2025-10-21 @ 17:43:16</span
              ><span class="points-container"
                >Points: <span class="points">353</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=45658928"
                  >Comments</a
                ><span class="descendants">: 139</span></span
              >
            </h4>
            <div class="text">
              <a href="https://xcancel.com/karpathy/status/1980397031542989305"
                >https://xcancel.com/karpathy/status/1980397031542989305</a
              >
            </div>
          </section>
        </section>
        <section id="45626129">
          <h3>
            <a
              class="item"
              href="https://gbragafibra.github.io/2025/10/16/collatz_ant11.html"
              >Which Collatz numbers do Busy Beavers simulate (if any)?</a
            >
          </h3>
          <section>
            <h4>
              <span>2025-10-18 @ 09:54:56</span
              ><span class="points-container"
                >Points: <span class="points">25</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=45626129"
                  >Comments</a
                ><span class="descendants">: 1</span></span
              >
            </h4>
          </section>
        </section>
        <section id="45609478">
          <h3>
            <a class="item" href="https://abstractboardgames.com/"
              >Play abstract strategy board games online with friends or against
              bots</a
            >
          </h3>
          <section>
            <h4>
              <span>2025-10-16 @ 19:12:47</span
              ><span class="points-container"
                >Points: <span class="points">149</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=45609478"
                  >Comments</a
                ><span class="descendants">: 64</span></span
              >
            </h4>
          </section>
        </section>
        <section id="45606224">
          <h3>
            <a class="item" href="https://read.thecoder.cafe/p/crdt"
              >Conflict-Free Replicated Data Types (CRDTs): Convergence Without
              Coordination</a
            >
          </h3>
          <section>
            <h4>
              <span>2025-10-16 @ 15:00:06</span
              ><span class="points-container"
                >Points: <span class="points">29</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=45606224"
                  >Comments</a
                ><span class="descendants">: 11</span></span
              >
            </h4>
          </section>
        </section>
        <section id="45605823">
          <h3>
            <a
              class="item"
              href="https://developers.googleblog.com/en/say-hello-to-a-new-level-of-interactivity-in-gemini-cli/"
              >Run interactive commands in Gemini CLI</a
            >
          </h3>
          <section>
            <h4>
              <span>2025-10-16 @ 14:31:13</span
              ><span class="points-container"
                >Points: <span class="points">185</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=45605823"
                  >Comments</a
                ><span class="descendants">: 64</span></span
              >
            </h4>
          </section>
        </section>
        <section id="45601856">
          <h3>
            <a class="item" href="https://tonsky.me/blog/hashp/"
              >When You Get to Be Smart Writing a Macro</a
            >
          </h3>
          <section>
            <h4>
              <span>2025-10-16 @ 05:51:02</span
              ><span class="points-container"
                >Points: <span class="points">87</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=45601856"
                  >Comments</a
                ><span class="descendants">: 16</span></span
              >
            </h4>
          </section>
        </section>
        <section id="45595807">
          <h3>
            <a class="item" href="https://news.ycombinator.com/item?id=45595807"
              >Ask HN: Does anyone have scans of these missing PC Plus issues
              (1991–1993)?</a
            >
          </h3>
          <section>
            <h4>
              <span>2025-10-15 @ 17:25:17</span
              ><span class="points-container"
                >Points: <span class="points">91</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=45595807"
                  >Comments</a
                ><span class="descendants">: 23</span></span
              >
            </h4>
            <div class="text">
              <i>PC Plus</i> magazine please.
              <p>
                1991-Nov, 1992-Jan, 1992-Mar, 1992-Apr, 1992-Jun, 1992-Jul,
                1992-Oct, 1993-Jan.
              </p>
              <p>
                This was a popular PC magazine in the UK, and one of its
                highlights was Wilf’s Programmer Workshop, a regular column full
                of programming puzzles, challenges and reader submissions.
              </p>
              <p>
                At one point, he ran a contest around quines (programs that
                output their own source). I sent in a tongue‑in‑cheek entry, a
                batch file that used PKZIP to “compile” code into PKZIP.OBJ
                (instead of .ZIP) and then ZIP2EXE to “link” it into an EXE. The
                result was an executable that unzipped itself back into a source
                file. He was amused enough to mention it near the end of his
                column, though he noted it didn’t quite qualify for the contest
                since I hadn’t written PKZIP myself.
              </p>
              <p>
                I found scans of his section on archive.org, including the issue
                where he announces the contest, but I couldn't find my
                particular contribution. I've narrowed it down to the eight
                issues listed above that are in the right time-frame.
              </p>
              <p>
                If you have any of these issues (paper or PDF), could you please
                check Wilf’s section near the back and see if my submission is
                mentioned?
              </p>
              <p>Thanks!</p>
            </div>
          </section>
        </section>
        <section id="45579118">
          <h3>
            <a class="item" href="https://github.com/begoon/easy"
              >Compiler for "Easy" language from "Etudes for Programmers" book
              (1978)</a
            >
          </h3>
          <section>
            <h4>
              <span>2025-10-14 @ 12:14:24</span
              ><span class="points-container"
                >Points: <span class="points">10</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=45579118"
                  >Comments</a
                ><span class="descendants">: 3</span></span
              >
            </h4>
          </section>
        </section>
      </section>
      <section id="archives">
        <h2>
          <a
            href="https://github.com/kherrick/hacker-news/blob/main/archives/index.md"
            >Archives</a
          >
        </h2>
        <section>
          <h3>
            <a
              href="https://github.com/kherrick/hacker-news/blob/main/archives/2025/index.md"
              >2025</a
            >
          </h3>
        </section>
        <section>
          <h3>
            <a
              href="https://github.com/kherrick/hacker-news/blob/main/archives/2024/index.md"
              >2024</a
            >
          </h3>
        </section>
        <section>
          <h3>
            <a
              href="https://github.com/kherrick/hacker-news/blob/main/archives/2023/index.md"
              >2023</a
            >
          </h3>
        </section>
        <section>
          <h3>
            <a
              href="https://github.com/kherrick/hacker-news/blob/main/archives/2022/index.md"
              >2022</a
            >
          </h3>
        </section>
      </section>
    </main>
    <script type="module">
      import { buildDescendants } from "./lib/build-html-descendants.js";
      import { buildNextItem } from "./lib/build-html-next-item.js";
      import { getNextDateTime } from "./lib/date-time.js";

      const updateSectionById = (id) =>
        fetch(`https://hacker-news.firebaseio.com/v0/item/${id}.json`).then(
          (result) =>
            result.json().then(({ descendants, id, score, text, type }) => {
              const currentItem = document.getElementById(id);

              if (score) {
                currentItem.querySelector(".points").textContent = score;
              }

              if (descendants && (type === "poll" || type === "story")) {
                const currentDescendants =
                  currentItem.querySelector(".descendants");

                if (currentDescendants) {
                  currentDescendants.textContent = `: ${descendants}`;
                } else {
                  const comments = buildDescendants(
                    document,
                    descendants,
                    `https://news.ycombinator.com/item?id=${id}`
                  );

                  currentItem.querySelector("h4").appendChild(comments);
                }
              }

              if (text) {
                const currentText = currentItem.querySelector(".text");

                if (currentText) {
                  currentText.innerHTML = text.replace(/\0/g, "");
                } else {
                  const content = document.createElement("div");
                  content.innerHTML = text.replace(/\0/g, "");
                  content.setAttribute("class", "text");

                  currentItem.appendChild(content);
                }
              }
            })
        );

      class UpdateQueue {
        constructor() {
          this._ids = [];
          this._isUpdating = false;
        }

        addItemById(id) {
          this._ids.push(id);
        }

        async flush() {
          const id = this._ids.shift();

          if (id) {
            this._isUpdating = true;

            await updateSectionById(id);
            await this.flush();
          } else {
            this._isUpdating = false;

            setTimeout(async () => {
              if (!this._isUpdating && this._ids && this._ids.length) {
                await this.flush();
              }
            }, 0);
          }
        }
      }

      // get latest data
      const latestSection = document.getElementById("latest");

      for (let item of latestSection.querySelectorAll("section[id]")) {
        updateSectionById(item.getAttribute("id"));
      }

      if ("IntersectionObserver" in window) {
        window.hackerNewsState = { index: [], nextTimeIndex: -1 };

        const addNewsItem = async (newsItem, queue) => {
          try {
            const { date, time, itemComments, itemTitle, itemLink } = newsItem;
            const section = await buildNextItem({
              document,
              dateTime: `${date}, ${time}`,
              itemComments,
              itemLink,
              itemTitle: new DOMParser().parseFromString(
                itemTitle.replace(/\\/g, ""),
                "text/html"
              ).documentElement.textContent,
              fetchItemDetails: false,
            });

            // display loading indicator for section
            section.querySelector(".points-container").innerHTML =
              'Points: <span class="points"><img style="height: 100%;" src="lib/images/loading.svg" /></span>';

            const id = section.getAttribute("id");
            if (!document.getElementById(id)) {
              document.getElementById("latest").appendChild(section);

              queue.addItemById(id);
            }
          } catch (error) {}
        };

        const buildArchiveIndex = async (lastDateTime) => {
          const nextDate = lastDateTime.slice(0, 10);
          const nextYear = nextDate.slice(0, 4);

          return (
            await (
              await fetch(
                `https://raw.githubusercontent.com/kherrick/hacker-news/main/archives/${nextYear}/${nextDate}/index.md`
              )
            ).text()
          )
            .split("\n")
            .filter((line) => line.match(new RegExp("^\\* \\[")))
            .map((line) => {
              const segment = line.replace("* ", "").split("](");
              const pubDate = segment[0].slice(1);

              const itemComments = segment[1].split(") - [")[0];
              const itemTitle = segment[1].split(") - [")[1];
              const itemLink = segment[2].slice(0, -1);
              const date = pubDate.slice(0, 10);
              const time = pubDate.slice(-8);

              return {
                date,
                itemComments,
                itemLink,
                itemTitle,
                time,
              };
            });
        };

        const handleIntersectingEntry = async (entry, queue) => {
          if (entry.isIntersecting) {
            const lastDateTime = document
              .getElementById("latest")
              .querySelector(
                "section:last-child > section > h4 > span"
              ).textContent;

            const nextDateTime = getNextDateTime(lastDateTime ?? "", -1);
            const archiveIndex = await buildArchiveIndex(nextDateTime);
            const nextTimeIndex = archiveIndex.findIndex(
              ({ time }) => time === nextDateTime.slice(-8)
            );

            const handleIndexUpdate = (index, existingIndexValues = []) => {
              index.forEach((i) => {
                existingIndexValues.push(i);
              });
              return existingIndexValues;
            };

            window.hackerNewsState = {
              index: handleIndexUpdate(
                archiveIndex,
                window.hackerNewsState.index
              ),
              nextTimeIndex,
            };

            let currentTimeIndex = nextTimeIndex + 1;
            const items = Object.values(window.hackerNewsState.index);
            for (let item of items) {
              if (currentTimeIndex < window.hackerNewsState.index.length) {
                addNewsItem(items[currentTimeIndex], queue);

                currentTimeIndex = currentTimeIndex + 1;
              }
            }

            queue.flush();
          }
        };

        const archives = document.getElementById("archives");
        const archivesObserver = new IntersectionObserver(
          (entries) => {
            const queue = new UpdateQueue();

            entries.forEach((entry) => handleIntersectingEntry(entry, queue));
          },
          {
            root: null,
            rootMargin: "0px",
            threshold: 0,
          }
        );

        archivesObserver.observe(archives);

        let latestSectionsExpanded = true;
        const handleLatestHeaderClick = () => {
          latestSectionsExpanded = !latestSectionsExpanded;

          if (latestSectionsExpanded) {
            archivesObserver.observe(archives);
          } else {
            archivesObserver.disconnect(archives);
          }

          for (let section of document.querySelectorAll("#latest > section")) {
            section.style.display = latestSectionsExpanded ? "block" : "none";
          }
        };

        const latestHeader = document.querySelector("#latest > h2");
        latestHeader.style.cursor = "pointer";
        latestHeader.addEventListener("click", handleLatestHeaderClick);
      }
    </script>
    <script type="module">
      import { Workbox } from "https://storage.googleapis.com/workbox-cdn/releases/6.4.1/workbox-window.prod.mjs";

      if ("serviceWorker" in navigator) {
        const base = document.querySelector("base");
        const serviceWorkerPath = `${
          base ? base.href.replace(/\/$/, "") : ""
        }/service-worker.js`;

        const wb = new Workbox(serviceWorkerPath);

        // setup event listeners
        wb.addEventListener("waiting", (event) => {
          wb.addEventListener("controlling", () => {
            window.location.reload();
          });

          wb.messageSkipWaiting();
        });

        wb.register();
      }
    </script>
  </body>
</html>
