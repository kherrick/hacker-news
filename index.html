<!DOCTYPE html>
<html lang="en" xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta charset="utf-8" />
    <meta
      content="width=device-width, initial-scale=1.0, viewport-fit=cover"
      name="viewport"
    />
    <meta name="description" content="Hacker News" />
    <meta name="theme-color" content="#fff" />
    <title>Hacker News</title>
    <link rel="manifest" href="manifest.json" />
    <link
      href="data:image/x-icon;base64,AAABAAEAAQECAAEAAQA4AAAAFgAAACgAAAABAAAAAgAAAAEAAQAAAAAAAAAAAAAAAAAAAAAAAAAAAAABAAEAAQECAAEAAQA4AAAAFgAAACgAAAABAAAAAgAAAAEAAQAAAAAAAAAAAAAAAAAAAAAAAAAA"
      rel="icon"
      type="image/x-icon"
    />
    <link
      href="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAgAAAAIAAQMAAADOtka5AAAAA1BMVEUAAACnej3aAAAANklEQVR42u3BAQEAAACCIP+vbkhAAQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAB8G4IAAAFjdVCkAAAAAElFTkSuQmCC"
      rel="apple-touch-icon"
    />
    <style>
      /*<!--*/
      body {
        color: rgb(25, 25, 25);
        font-family: Verdana, Geneva, sans-serif;
        margin: 0;
      }

      a {
        text-decoration: none;
      }

      a:link,
      a:focus,
      a:hover,
      a:active {
        color: rgb(75, 75, 125);
      }

      a:visited {
        color: rgb(25, 25, 25);
      }

      h1 > a,
      h1 > a:link,
      h1 > a:focus,
      h1 > a:hover,
      h1 > a:active,
      h1 > a:visited,
      h2 > a,
      h2 > a:link,
      h2 > a:focus,
      h2 > a:hover,
      h2 > a:active,
      h2 > a:visited {
        color: rgb(25, 25, 25);
      }

      h1 {
        background-color: rgb(255, 102, 0);
        margin: 0;
        padding: 1rem;
      }

      h2 {
        background-color: rgb(200, 200, 200);
        margin: 1rem 0;
        padding: 0.5rem 0.5rem 0.5rem 1rem;
      }

      #latest > section,
      #archives > section {
        margin: 0 1rem 1rem 1rem;
        padding-bottom: 1rem;
      }

      #latest > section:not(:last-child),
      #archives > section:not(:last-child) {
        border-bottom: 1px dotted rgb(200, 200, 200);
      }

      section > h3 {
        margin: 0 0 0.5rem 0;
      }

      section > h4 {
        font-weight: normal;
        margin: 0 0 0 1rem;
      }

      .descendants-container,
      .points-container {
        align-items: center;
        border-left: 1px solid #333;
        display: inline-flex;
        margin-left: 0.5rem;
        padding-left: 0.5rem;
        text-align: center;
      }

      .points {
        align-items: center;
        display: inline-flex;
        height: 1rem;
        margin-left: 1ch;
        min-width: 3ch;
      }

      .text {
        line-height: 1.5rem;
        margin: 1rem 1rem 0 1rem;
        overflow: auto;
      }

      .text > p:first-child {
        margin-top: 1rem;
      }

      .text > p:last-child {
        margin-bottom: 0;
      }
      /*-->*/
    </style>
  </head>

  <body>
    <main>
      <h1><a href="https://kherrick.github.io/hacker-news/">Hacker News</a></h1>
      <section id="latest">
        <h2>Latest</h2>
        <section id="36582571">
          <h3>
            <a
              class="item"
              href="https://techcrunch.com/2021/11/17/instagram-will-shut-down-its-companion-app-threads-by-year-end/"
              >Instagram will shut down its companion app Threads by year end</a
            >
          </h3>
          <section>
            <h4>
              <span>2023-07-04 @ 05:32:17</span
              ><span class="points-container"
                >Points: <span class="points">12</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=36582571"
                  >Comments</a
                ><span class="descendants">: 3</span></span
              >
            </h4>
          </section>
        </section>
        <section id="36582468">
          <h3>
            <a class="item" href="https://degreeswhat.com"
              >Show HN: Degrees What?</a
            >
          </h3>
          <section>
            <h4>
              <span>2023-07-04 @ 05:11:38</span
              ><span class="points-container"
                >Points: <span class="points">12</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=36582468"
                  >Comments</a
                ><span class="descendants">: 1</span></span
              >
            </h4>
            <div class="text">
              <p>
                So I made this little conversion tool that uses degrees angle to
                convert between degrees Fahrenheit and degrees Celsius.
              </p>
              <p>
                Tip: you can add a number in a query to link directly to a
                temperature. e.g.
                <a href="https://degreeswhat.com/?100"
                  >https://degreeswhat.com/?100</a
                >
              </p>
            </div>
          </section>
        </section>
        <section id="36582430">
          <h3>
            <a
              class="item"
              href="https://help.openai.com/en/articles/8077698-how-do-i-use-chatgpt-browse-with-bing-to-search-the-web"
              >OpenAI temporarily disables the Browse with Bing beta feature</a
            >
          </h3>
          <section>
            <h4>
              <span>2023-07-04 @ 05:03:50</span
              ><span class="points-container"
                >Points: <span class="points">41</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=36582430"
                  >Comments</a
                ><span class="descendants">: 23</span></span
              >
            </h4>
          </section>
        </section>
        <section id="36582120">
          <h3>
            <a
              class="item"
              href="https://johanwind.github.io/2023/03/23/rwkv_details.html"
              >How the RWKV language model works</a
            >
          </h3>
          <section>
            <h4>
              <span>2023-07-04 @ 04:07:32</span
              ><span class="points-container"
                >Points: <span class="points">5</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=36582120"
                  >Comments</a
                ><span class="descendants">: 1</span></span
              >
            </h4>
          </section>
        </section>
        <section id="36582117">
          <h3>
            <a class="item" href="https://news.ycombinator.com/item?id=36582117"
              >Ask HN: How to do market research for product?</a
            >
          </h3>
          <section>
            <h4>
              <span>2023-07-04 @ 04:07:00</span
              ><span class="points-container"
                >Points: <span class="points">26</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=36582117"
                  >Comments</a
                ><span class="descendants">: 16</span></span
              >
            </h4>
            <div class="text">
              <p>
                Iâ€™m planning to build a product but how can i perform market
                research related to the product
              </p>
            </div>
          </section>
        </section>
        <section id="36580837">
          <h3>
            <a
              class="item"
              href="https://giansegato.com/essays/edutainment-is-not-learning"
              >Learning needs to be effortful to be effective</a
            >
          </h3>
          <section>
            <h4>
              <span>2023-07-04 @ 01:02:25</span
              ><span class="points-container"
                >Points: <span class="points">119</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=36580837"
                  >Comments</a
                ><span class="descendants">: 48</span></span
              >
            </h4>
          </section>
        </section>
        <section id="36580487">
          <h3>
            <a
              class="item"
              href="https://www.cmu.edu/news/stories/archives/2023/june/cmu-team-develops-autonomous-robot-to-stave-off-spotted-lanternflies"
              >Autonomous robot to stave off spotted lanternflies</a
            >
          </h3>
          <section>
            <h4>
              <span>2023-07-04 @ 00:04:14</span
              ><span class="points-container"
                >Points: <span class="points">5</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=36580487"
                  >Comments</a
                ><span class="descendants">: 3</span></span
              >
            </h4>
          </section>
        </section>
        <section id="36580417">
          <h3>
            <a
              class="item"
              href="https://labs.hakaioffsec.com/nginx-alias-traversal/"
              >Leaking Bitwarden's Vault with a Nginx vulnerability</a
            >
          </h3>
          <section>
            <h4>
              <span>2023-07-03 @ 23:56:14</span
              ><span class="points-container"
                >Points: <span class="points">267</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=36580417"
                  >Comments</a
                ><span class="descendants">: 88</span></span
              >
            </h4>
          </section>
        </section>
        <section id="36580192">
          <h3>
            <a
              class="item"
              href="https://apps.apple.com/us/app/threads-an-instagram-app/id6446901002"
              >Threads, an Instagram app</a
            >
          </h3>
          <section>
            <h4>
              <span>2023-07-03 @ 23:31:44</span
              ><span class="points-container"
                >Points: <span class="points">462</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=36580192"
                  >Comments</a
                ><span class="descendants">: 537</span></span
              >
            </h4>
          </section>
        </section>
        <section id="36580006">
          <h3>
            <a
              class="item"
              href="https://www.brendangregg.com/blog/2017-05-09/cpu-utilization-is-wrong.html"
              >CPU Utilization Is Wrong (2017)</a
            >
          </h3>
          <section>
            <h4>
              <span>2023-07-03 @ 23:11:35</span
              ><span class="points-container"
                >Points: <span class="points">35</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=36580006"
                  >Comments</a
                ><span class="descendants">: 13</span></span
              >
            </h4>
          </section>
        </section>
        <section id="36579877">
          <h3>
            <a
              class="item"
              href="https://www.ycombinator.com/companies/velt/jobs/iC33Kfh-founding-frontend-engineer-web-us-only"
              >Velt (YC W22) Is Hiring Founding Frontend Engineer in US</a
            >
          </h3>
          <section>
            <h4>
              <span>2023-07-03 @ 22:56:19</span
              ><span class="points-container"
                >Points: <span class="points">1</span></span
              >
            </h4>
          </section>
        </section>
        <section id="36579347">
          <h3>
            <a
              class="item"
              href="https://www.joseferben.com/posts/3-things-that-surprised-me-while-running-sqlite-in-production/"
              >Things that surprised me while running SQLite in production</a
            >
          </h3>
          <section>
            <h4>
              <span>2023-07-03 @ 21:57:17</span
              ><span class="points-container"
                >Points: <span class="points">68</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=36579347"
                  >Comments</a
                ><span class="descendants">: 22</span></span
              >
            </h4>
          </section>
        </section>
        <section id="36578489">
          <h3>
            <a
              class="item"
              href="https://www.independent.co.uk/tech/battery-solar-panels-norway-phosphate-b2368444.html"
              >Huge phosphate rock deposit discovered in Norway</a
            >
          </h3>
          <section>
            <h4>
              <span>2023-07-03 @ 20:40:22</span
              ><span class="points-container"
                >Points: <span class="points">128</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=36578489"
                  >Comments</a
                ><span class="descendants">: 72</span></span
              >
            </h4>
          </section>
        </section>
        <section id="36577536">
          <h3>
            <a
              class="item"
              href="https://michael.stapelberg.ch/posts/2023-07-03-dell-u3224kba-32-inch-6k-monitor/"
              >Can Dellâ€™s 6K monitor beat their 8K monitor?</a
            >
          </h3>
          <section>
            <h4>
              <span>2023-07-03 @ 19:12:59</span
              ><span class="points-container"
                >Points: <span class="points">165</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=36577536"
                  >Comments</a
                ><span class="descendants">: 299</span></span
              >
            </h4>
          </section>
        </section>
        <section id="36577290">
          <h3>
            <a class="item" href="https://github.com/TylerGlaiel/Crashlogs"
              >Show HN: Using C++23 to get proper crash logs in C++ programs</a
            >
          </h3>
          <section>
            <h4>
              <span>2023-07-03 @ 18:50:03</span
              ><span class="points-container"
                >Points: <span class="points">80</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=36577290"
                  >Comments</a
                ><span class="descendants">: 72</span></span
              >
            </h4>
          </section>
        </section>
        <section id="36576361">
          <h3>
            <a class="item" href="https://conduition.io/cryptography/schnorr/"
              >A Dive into the Math Behind Bitcoin Schnorr Signatures</a
            >
          </h3>
          <section>
            <h4>
              <span>2023-07-03 @ 17:42:03</span
              ><span class="points-container"
                >Points: <span class="points">126</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=36576361"
                  >Comments</a
                ><span class="descendants">: 8</span></span
              >
            </h4>
          </section>
        </section>
        <section id="36575787">
          <h3>
            <a class="item" href="https://www.vogons.org/viewtopic.php?t=94972"
              >MartyPC, cycle accurate IBM PC/XT emulator</a
            >
          </h3>
          <section>
            <h4>
              <span>2023-07-03 @ 17:01:41</span
              ><span class="points-container"
                >Points: <span class="points">125</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=36575787"
                  >Comments</a
                ><span class="descendants">: 13</span></span
              >
            </h4>
          </section>
        </section>
        <section id="36575784">
          <h3>
            <a class="item" href="https://justinjaffray.com/joins-13-ways/?a=b"
              >Joins 13 Ways</a
            >
          </h3>
          <section>
            <h4>
              <span>2023-07-03 @ 17:01:38</span
              ><span class="points-container"
                >Points: <span class="points">426</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=36575784"
                  >Comments</a
                ><span class="descendants">: 56</span></span
              >
            </h4>
          </section>
        </section>
        <section id="36575712">
          <h3>
            <a
              class="item"
              href="https://github.com/WebKit/WebKit/blob/ab10a90523e06df54bbb8a98e1aed913f79d0af9/Source/JavaScriptCore/runtime/JSArrayBufferView.cpp#L269"
              >SlowDownAndWasteMemory()</a
            >
          </h3>
          <section>
            <h4>
              <span>2023-07-03 @ 16:57:23</span
              ><span class="points-container"
                >Points: <span class="points">259</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=36575712"
                  >Comments</a
                ><span class="descendants">: 107</span></span
              >
            </h4>
          </section>
        </section>
        <section id="36575116">
          <h3>
            <a class="item" href="https://pudding.cool/games/where/"
              >Where in the USA is this?</a
            >
          </h3>
          <section>
            <h4>
              <span>2023-07-03 @ 16:18:43</span
              ><span class="points-container"
                >Points: <span class="points">387</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=36575116"
                  >Comments</a
                ><span class="descendants">: 202</span></span
              >
            </h4>
          </section>
        </section>
        <section id="36575003">
          <h3>
            <a
              class="item"
              href="https://www.washingtonpost.com/technology/2023/07/01/amazon-goodreads-elizabeth-gilbert/"
              >Goodreads was the future of book reviews, then Amazon bought
              it</a
            >
          </h3>
          <section>
            <h4>
              <span>2023-07-03 @ 16:11:03</span
              ><span class="points-container"
                >Points: <span class="points">514</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=36575003"
                  >Comments</a
                ><span class="descendants">: 387</span></span
              >
            </h4>
          </section>
        </section>
        <section id="36574844">
          <h3>
            <a class="item" href="https://curves.xargs.org"
              >The Animated Elliptic Curve</a
            >
          </h3>
          <section>
            <h4>
              <span>2023-07-03 @ 16:01:16</span
              ><span class="points-container"
                >Points: <span class="points">175</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=36574844"
                  >Comments</a
                ><span class="descendants">: 15</span></span
              >
            </h4>
          </section>
        </section>
        <section id="36574645">
          <h3>
            <a class="item" href="https://www.nan.fyi/svg-paths"
              >An interactive guide to SVG paths</a
            >
          </h3>
          <section>
            <h4>
              <span>2023-07-03 @ 15:50:21</span
              ><span class="points-container"
                >Points: <span class="points">262</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=36574645"
                  >Comments</a
                ><span class="descendants">: 30</span></span
              >
            </h4>
          </section>
        </section>
        <section id="36574090">
          <h3>
            <a class="item" href="https://www.kadoa.com/joblens"
              >Show HN: JobLens â€“ AI-powered job search for 'Who Is Hiring'</a
            >
          </h3>
          <section>
            <h4>
              <span>2023-07-03 @ 15:16:24</span
              ><span class="points-container"
                >Points: <span class="points">82</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=36574090"
                  >Comments</a
                ><span class="descendants">: 16</span></span
              >
            </h4>
            <div class="text">
              <a href="https://news.ycombinator.com/item?id=36163021"
                >https://news.ycombinator.com/item?id=36163021</a
              >), I built a tool that aggregates job postings and intelligently
              categorizes them based on user-specific preferences:
              <p>* Country and remote work preferences</p>
              <p>* Employer type (e.g., startup, corporation, government)</p>
              <p>* Industry</p>
              <p>* Technologies used</p>
              <p>* Role type (developer, architect, product owner, etc.)</p>
              <p>* Salary range (where available)</p>
              <p>
                One of the superpowers of LLMs is reformatting information from
                any format X to any other format Y. We leverage this to map all
                the unstructured job postings into the same unified structure.
                The new GPT functions feature and the extended context windows
                are really helpful for this. Instead of having to build a custom
                NER pipeline, it works very well with GPT out-of-the box.
              </p>
              <p>
                One challenge is keeping the filters consistent and merging of
                duplicates. Embeddings help with that.
              </p>
              <p>What's next:</p>
              <p>
                * Integrate additional sources. We can generate web scrapers and
                data processing steps on the fly that extract and transform data
                into the same structure.
              </p>
              <p>* Add location distance filters.</p>
              <p>
                * Expand beyond jobs to monitor personalized data like events or
                real estate. Imagine using AI to rate local events from multiple
                sources based on your preferences, considering factors like your
                interests and distance from home.
              </p>
              <p>* Smaller improvements based on your feedback :)</p>
            </div>
          </section>
        </section>
        <section id="36573881">
          <h3>
            <a
              class="item"
              href="https://github.com/automateyournetwork/automate_your_network"
              >Automate Your Network</a
            >
          </h3>
          <section>
            <h4>
              <span>2023-07-03 @ 15:01:25</span
              ><span class="points-container"
                >Points: <span class="points">136</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=36573881"
                  >Comments</a
                ><span class="descendants">: 30</span></span
              >
            </h4>
          </section>
        </section>
        <section id="36573871">
          <h3>
            <a class="item" href="https://news.ycombinator.com/item?id=36573871"
              >Ask HN: Who is hiring? (July 2023)</a
            >
          </h3>
          <section>
            <h4>
              <span>2023-07-03 @ 15:00:52</span
              ><span class="points-container"
                >Points: <span class="points">379</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=36573871"
                  >Comments</a
                ><span class="descendants">: 284</span></span
              >
            </h4>
            <div class="text">
              <i>not</i> an option, include ONSITE.
              <p>
                Please only post if you personally are part of the hiring
                companyâ€”no recruiting firms or job boards. One post per company.
                If it isn't a household name, explain what your company does.
              </p>
              <p>
                Commenters: please don't reply to job posts to complain about
                something. It's off topic here.
              </p>
              <p>
                Readers: please only email if you are personally interested in
                the job.
              </p>
              <p>
                Searchers: try
                <a href="https://hnhired.fly.dev">https://hnhired.fly.dev</a>,
                <a href="https://kennytilton.github.io/whoishiring/"
                  >https://kennytilton.github.io/whoishiring/</a
                >,
                <a href="https://hnjobs.emilburzo.com"
                  >https://hnjobs.emilburzo.com</a
                >,
                <a href="https://news.ycombinator.com/item?id=10313519"
                  >https://news.ycombinator.com/item?id=10313519</a
                >.
              </p>
              <p>Don't miss these other fine threads:</p>
              <p>
                <i>Who wants to be hired?</i>
                <a href="https://news.ycombinator.com/item?id=36573869"
                  >https://news.ycombinator.com/item?id=36573869</a
                >
              </p>
              <p>
                <i>Freelancer? Seeking freelancer?</i>
                <a href="https://news.ycombinator.com/item?id=36573870"
                  >https://news.ycombinator.com/item?id=36573870</a
                >
              </p>
            </div>
          </section>
        </section>
        <section id="36571110">
          <h3>
            <a
              class="item"
              href="https://www.dataorienteddesign.com/dodbook/dodmain.html"
              >Data-Oriented Design (2018)</a
            >
          </h3>
          <section>
            <h4>
              <span>2023-07-03 @ 10:41:09</span
              ><span class="points-container"
                >Points: <span class="points">307</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=36571110"
                  >Comments</a
                ><span class="descendants">: 102</span></span
              >
            </h4>
          </section>
        </section>
        <section id="36569336">
          <h3>
            <a
              class="item"
              href="https://www.theatlantic.com/health/archive/2014/11/the-dutch-village-where-everyone-has-dementia/382195/"
              >A Dutch Village Where Everyone Has Dementia (2014)</a
            >
          </h3>
          <section>
            <h4>
              <span>2023-07-03 @ 05:46:21</span
              ><span class="points-container"
                >Points: <span class="points">83</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=36569336"
                  >Comments</a
                ><span class="descendants">: 51</span></span
              >
            </h4>
          </section>
        </section>
        <section id="36567681">
          <h3>
            <a
              class="item"
              href="https://makepad.nl/makepad/examples/ironfish/src/index.html"
              >Makepad- Synthesizer Written in Rust</a
            >
          </h3>
          <section>
            <h4>
              <span>2023-07-03 @ 01:37:06</span
              ><span class="points-container"
                >Points: <span class="points">5</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=36567681"
                  >Comments</a
                ><span class="descendants">: 1</span></span
              >
            </h4>
          </section>
        </section>
        <section id="36566994">
          <h3>
            <a class="item" href="https://github.com/Ottercast/OtterCastAudioV2"
              >OtterCast: FOSS Audio streaming device running Linux using Sochip
              S3 SiP</a
            >
          </h3>
          <section>
            <h4>
              <span>2023-07-02 @ 23:42:04</span
              ><span class="points-container"
                >Points: <span class="points">20</span></span
              ><span class="descendants-container"
                ><a href="https://news.ycombinator.com/item?id=36566994"
                  >Comments</a
                ><span class="descendants">: 4</span></span
              >
            </h4>
          </section>
        </section>
      </section>
      <section id="archives">
        <h2>
          <a
            href="https://github.com/kherrick/hacker-news/blob/main/archives/index.md"
            >Archives</a
          >
        </h2>
        <section>
          <h3>
            <a
              href="https://github.com/kherrick/hacker-news/blob/main/archives/2023/index.md"
              >2023</a
            >
          </h3>
        </section>
        <section>
          <h3>
            <a
              href="https://github.com/kherrick/hacker-news/blob/main/archives/2022/index.md"
              >2022</a
            >
          </h3>
        </section>
      </section>
    </main>
    <script type="module">
      import { buildDescendants } from "./lib/build-html-descendants.js";
      import { buildNextItem } from "./lib/build-html-next-item.js";
      import { getNextDateTime } from "./lib/date-time.js";

      const updateSectionById = (id) =>
        fetch(`https://hacker-news.firebaseio.com/v0/item/${id}.json`).then(
          (result) =>
            result.json().then(({ descendants, id, score, text, type }) => {
              const currentItem = document.getElementById(id);

              if (score) {
                currentItem.querySelector(".points").textContent = score;
              }

              if (descendants && (type === "poll" || type === "story")) {
                const currentDescendants =
                  currentItem.querySelector(".descendants");

                if (currentDescendants) {
                  currentDescendants.textContent = `: ${descendants}`;
                } else {
                  const comments = buildDescendants(
                    document,
                    descendants,
                    `https://news.ycombinator.com/item?id=${id}`
                  );

                  currentItem.querySelector("h4").appendChild(comments);
                }
              }

              if (text) {
                const currentText = currentItem.querySelector(".text");

                if (currentText) {
                  currentText.innerHTML = text.replace(/\0/g, "");
                } else {
                  const content = document.createElement("div");
                  content.innerHTML = text.replace(/\0/g, "");
                  content.setAttribute("class", "text");

                  currentItem.appendChild(content);
                }
              }
            })
        );

      class UpdateQueue {
        constructor() {
          this._ids = [];
          this._isUpdating = false;
        }

        addItemById(id) {
          this._ids.push(id);
        }

        async flush() {
          const id = this._ids.shift();

          if (id) {
            this._isUpdating = true;

            await updateSectionById(id);
            await this.flush();
          } else {
            this._isUpdating = false;

            setTimeout(async () => {
              if (!this._isUpdating && this._ids && this._ids.length) {
                await this.flush();
              }
            }, 0);
          }
        }
      }

      // get latest data
      const latestSection = document.getElementById("latest");

      for (let item of latestSection.querySelectorAll("section[id]")) {
        updateSectionById(item.getAttribute("id"));
      }

      if ("IntersectionObserver" in window) {
        window.hackerNewsState = { index: [], nextTimeIndex: -1 };

        const addNewsItem = async (newsItem, queue) => {
          try {
            const { date, time, itemComments, itemTitle, itemLink } = newsItem;
            const section = await buildNextItem({
              document,
              dateTime: `${date}, ${time}`,
              itemComments,
              itemLink,
              itemTitle: new DOMParser().parseFromString(
                itemTitle.replace(/\\/g, ""),
                "text/html"
              ).documentElement.textContent,
              fetchItemDetails: false,
            });

            // display loading indicator for section
            section.querySelector(".points-container").innerHTML =
              'Points: <span class="points"><img style="height: 100%;" src="lib/images/loading.svg" /></span>';

            const id = section.getAttribute("id");
            if (!document.getElementById(id)) {
              document.getElementById("latest").appendChild(section);

              queue.addItemById(id);
            }
          } catch (error) {}
        };

        const buildArchiveIndex = async (lastDateTime) => {
          const nextDate = lastDateTime.slice(0, 10);
          const nextYear = nextDate.slice(0, 4);

          return (
            await (
              await fetch(
                `https://raw.githubusercontent.com/kherrick/hacker-news/main/archives/${nextYear}/${nextDate}/index.md`
              )
            ).text()
          )
            .split("\n")
            .filter((line) => line.match(new RegExp("^\\* \\[")))
            .map((line) => {
              const segment = line.replace("* ", "").split("](");
              const pubDate = segment[0].slice(1);

              const itemComments = segment[1].split(") - [")[0];
              const itemTitle = segment[1].split(") - [")[1];
              const itemLink = segment[2].slice(0, -1);
              const date = pubDate.slice(0, 10);
              const time = pubDate.slice(-8);

              return {
                date,
                itemComments,
                itemLink,
                itemTitle,
                time,
              };
            });
        };

        const handleIntersectingEntry = async (entry, queue) => {
          if (entry.isIntersecting) {
            const lastDateTime = document
              .getElementById("latest")
              .querySelector(
                "section:last-child > section > h4 > span"
              ).textContent;

            const nextDateTime = getNextDateTime(lastDateTime ?? "", -1);
            const archiveIndex = await buildArchiveIndex(nextDateTime);
            const nextTimeIndex = archiveIndex.findIndex(
              ({ time }) => time === nextDateTime.slice(-8)
            );

            const handleIndexUpdate = (index, existingIndexValues = []) => {
              index.forEach((i) => {
                existingIndexValues.push(i);
              });
              return existingIndexValues;
            };

            window.hackerNewsState = {
              index: handleIndexUpdate(
                archiveIndex,
                window.hackerNewsState.index
              ),
              nextTimeIndex,
            };

            let currentTimeIndex = nextTimeIndex + 1;
            const items = Object.values(window.hackerNewsState.index);
            for (let item of items) {
              if (currentTimeIndex < window.hackerNewsState.index.length) {
                addNewsItem(items[currentTimeIndex], queue);

                currentTimeIndex = currentTimeIndex + 1;
              }
            }

            queue.flush();
          }
        };

        const archives = document.getElementById("archives");
        const archivesObserver = new IntersectionObserver(
          (entries) => {
            const queue = new UpdateQueue();

            entries.forEach((entry) => handleIntersectingEntry(entry, queue));
          },
          {
            root: null,
            rootMargin: "0px",
            threshold: 0,
          }
        );

        archivesObserver.observe(archives);

        let latestSectionsExpanded = true;
        const handleLatestHeaderClick = () => {
          latestSectionsExpanded = !latestSectionsExpanded;

          if (latestSectionsExpanded) {
            archivesObserver.observe(archives);
          } else {
            archivesObserver.disconnect(archives);
          }

          for (let section of document.querySelectorAll("#latest > section")) {
            section.style.display = latestSectionsExpanded ? "block" : "none";
          }
        };

        const latestHeader = document.querySelector("#latest > h2");
        latestHeader.style.cursor = "pointer";
        latestHeader.addEventListener("click", handleLatestHeaderClick);
      }
    </script>
    <script type="module">
      import { Workbox } from "https://storage.googleapis.com/workbox-cdn/releases/6.4.1/workbox-window.prod.mjs";

      if ("serviceWorker" in navigator) {
        const base = document.querySelector("base");
        const serviceWorkerPath = `${
          base ? base.href.replace(/\/$/, "") : ""
        }/service-worker.js`;

        const wb = new Workbox(serviceWorkerPath);

        // setup event listeners
        wb.addEventListener("waiting", (event) => {
          wb.addEventListener("controlling", () => {
            window.location.reload();
          });

          wb.messageSkipWaiting();
        });

        wb.register();
      }
    </script>
  </body>
</html>
